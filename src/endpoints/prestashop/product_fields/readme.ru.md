
# Модуль `ProductFields` (`src/endpoints/prestashop/product_fields.py`)

## Назначение

Модуль `ProductFields` и одноименный класс `ProductFields` играют центральную роль в процессе переноса данных о товарах от поставщика в PrestaShop. Он служит **структурированным контейнером данных**, который:

1.  **Представляет товар:** Определяет все необходимые поля товара, соответствующие структуре данных PrestaShop (таблицы `ps_product`, `ps_product_lang` и связи `associations`).
2.  **Хранит собранные данные:** Принимает и хранит информацию, собранную классом `Graber` со страницы товара поставщика.
3.  **Обеспечивает значения по умолчанию:** Загружает стандартные значения для многих полей из файла `product_fields_default_values.json`, упрощая создание новых товаров.
4.  **Поддерживает мультиязычность:** Позволяет легко управлять значениями полей (таких как название, описание) для разных языков, поддерживаемых в PrestaShop.
5.  **Управляет связями (Associations):** Предоставляет методы для добавления связей товара с категориями, изображениями, характеристиками, комбинациями и т.д.
6.  **Форматирует данные для API:** Преобразует собранные и обработанные данные в словарь (`to_dict()`), полностью совместимый с форматом PrestaShop Web Service API для создания или обновления товаров.

По сути, `ProductFields` является **промежуточным представлением товара**, адаптированным под требования PrestaShop API, которое заполняется данными от поставщика и затем передается в модуль `PrestaProduct` для отправки в магазин.

## Ключевые возможности

*   **Полный набор полей:** Класс содержит свойства (property) для доступа ко всем полям товара, перечисленным в `fields_list.txt`, включая поля из таблиц `ps_product` и `ps_product_lang`.
*   **Инициализация по умолчанию:** При создании экземпляра класса автоматически загружаются значения по умолчанию из `product_fields_default_values.json` с помощью метода `_payload()`. Это гарантирует, что у всех необходимых полей будет какое-либо значение.
*   **Удобный доступ к полям:** Доступ к значениям полей осуществляется через стандартные свойства Python (геттеры и сеттеры), например, `product.price = 100.0` или `name = product.name`. Сеттеры часто включают нормализацию данных (например, `normalize_float`, `normalize_string`).
*   **Обработка мультиязычных полей:**
    *   Поля, зависящие от языка (например, `name`, `description`, `meta_title`), используют внутренний метод `_set_multilang_value`.
    *   Этот метод позволяет установить значение для конкретного языка (задается при инициализации `ProductFields(id_lang=...)` или передается в сеттер).
    *   Внутренне данные хранятся так, чтобы метод `to_dict()` мог их правильно отформатировать для API PrestaShop (в виде списка словарей `{'language': [{'id': id_языка, 'value': значение}]}`).
*   **Управление связями (Associations):**
    *   Связи товара (с категориями, изображениями, характеристиками, тегами, комбинациями и т.д.) хранятся во вложенной структуре `self.presta_fields.associations`.
    *   Предоставляются удобные методы для добавления связей, например:
        *   `additional_category_append(category_id)`
        *   `product_image_append(image_id)`
        *   `product_features_append(feature_id, feature_value_id)`
        *   `product_tag_append(tag_id)`
        *   и другие.
    *   Также есть методы для очистки связей (`..._clear()`).
*   **Преобразование в формат API (`to_dict()`):**
    *   Самый важный метод для взаимодействия с PrestaShop API.
    *   Он преобразует все данные экземпляра `ProductFields` в словарь Python.
    *   **Фильтрует пустые значения:** Ключи, значения которых `None` или пустая строка, как правило, исключаются из результирующего словаря (зависит от конкретной реализации для каждого поля).
    *   **Конвертирует все значения в строки:** PrestaShop API (особенно при работе с XML) ожидает строковые значения для всех полей.
    *   **Форматирует мультиязычные поля:** Преобразует внутреннее представление в требуемый API формат списка словарей.
    *   **Форматирует связи (associations):** Структурирует данные связей в соответствии с требованиями API.
    *   Результирующий словарь готов к передаче в методы `create` или `edit` класса `PrestaShop` (или `PrestaProduct`).

## Инициализация и значения по умолчанию

При создании объекта `ProductFields` происходит следующее:

1.  `__init__` принимает необязательный `id_lang` (по умолчанию `1` - Английский в примере), который будет использоваться для мультиязычных полей, если язык не указан явно.
2.  `__post_init__` вызывает `_payload()`.
3.  `_payload()`:
    *   Читает список всех возможных имен полей из файла `src/endpoints/prestashop/product_fields/fields_list.txt`.
    *   Создает внутренний объект `self.presta_fields` (типа `SimpleNamespace`) и инициализирует все поля из списка значением `None`.
    *   Читает файл `src/endpoints/prestashop/product_fields/product_fields_default_values.json`.
    *   Устанавливает значения по умолчанию для полей, указанных в JSON-файле, в объект `self.presta_fields`.

```python
# Пример создания объекта
# По умолчанию используется язык с ID 1
product_fields = ProductFields()

# Использовать язык с ID 2 (например, Иврит)
product_fields_he = ProductFields(id_lang=2)

# Доступ к полю со значением по умолчанию
print(product_fields.active) # Выведет значение из product_fields_default_values.json (вероятно, 1)
```

## Доступ к полям

Доступ к полям осуществляется через свойства.

```python
pf = ProductFields(id_lang=3) # Русский язык

# Установка значений
pf.id_supplier = 15
pf.reference = "ART-123"
pf.price = 99.90
pf.name = "Пример товара" # Установит имя для языка id_lang=3
pf.description = "<p>Это описание товара.</p>" # Установит описание для языка id_lang=3

# Можно установить значение для другого языка, передав его в сеттер
# (Хотя текущая реализация сеттеров не принимает id_lang,
# правильнее было бы модифицировать _set_multilang_value и сеттеры для этого)
# Пример гипотетического вызова (требует доработки сеттеров):
# pf.set_name("Example Product", id_lang=1)

# Получение значений
supplier_id = pf.id_supplier
product_name = pf.name # Вернет структуру для мультиязычного поля

print(f"Артикул: {pf.reference}")
print(f"Цена: {pf.price}")
```

## Управление связями

Связи добавляются через специальные методы.

```python
pf = ProductFields()

# Добавление категорий
pf.id_category_default = 5 # Обязательно установить главную категорию
pf.additional_category_append(5) # Добавляем главную в список связей
pf.additional_category_append(10)
pf.additional_category_append(12)

# Добавление характеристик (Feature)
# Предположим, ID характеристики "Цвет" = 2, ID значения "Красный" = 8
pf.product_features_append(feature_id=2, feature_value_id=8)
# Предположим, ID характеристики "Материал" = 3, ID значения "Хлопок" = 15
pf.product_features_append(feature_id=3, feature_value_id=15)

# Добавление тега
# Предположим, ID тега "Новинка" = 1
pf.product_tag_append(tag_id=1)

# Получение списка добавленных категорий (для проверки)
print(pf.additional_categories)
# Вывод: [{'id': '5'}, {'id': '10'}, {'id': '12'}]

# Получение списка характеристик
print(pf.product_product_features)
# Вывод: [{'id': '2', 'id_feature_value': '8'}, {'id': '3', 'id_feature_value': '15'}]
```

## Преобразование в словарь для API (`to_dict()`)

После того как все необходимые поля заполнены, объект преобразуется в словарь.

```python
pf = ProductFields(id_lang=1)
pf.id_supplier = 15
pf.reference = "SKU-001"
pf.name = "My Product"
pf.price = 120.50
pf.active = 1
pf.id_category_default = 2
pf.additional_category_append(2)
pf.additional_category_append(9)
# ... другие поля ...

# Получаем словарь для API
api_dict = pf.to_dict()

# Вывод части словаря для примера
print({
    "id_supplier": api_dict.get("id_supplier"),
    "reference": api_dict.get("reference"),
    "price": api_dict.get("price"),
    "active": api_dict.get("active"),
    "name": api_dict.get("name"),
    "associations": api_dict.get("associations")
})

# Возможный вывод (структура name и associations важна):
# {
#     'id_supplier': '15',
#     'reference': 'SKU-001',
#     'price': '120.500000', # Цена будет отформатирована как строка с 6 знаками после запятой
#     'active': '1',
#     'name': {'language': [{'attrs': {'id': 1}, 'value': 'My Product'}]}, # Формат мультиязычного поля
#     'associations': {
#         'categories': [{'id': '2'}, {'id': '9'}] # Связи с категориями
#         # ... другие связи, если были добавлены
#     }
# }
```

Этот словарь `api_dict` затем используется в классе `PrestaProduct` для вызова метода `create` PrestaShop API.
