# Модуль: src.suppliers.suppliers_list.aliexpress.affiliated_products_generator

## Обзор

Модуль `affiliated_products_generator.py` предназначен для получения данных о товарах с AliExpress, включая создание партнерских ссылок, сохранение изображений и видео, а также сохранение полученных данных в файлы. Модуль содержит класс `AliAffiliatedProducts`, который расширяет класс `AliApi` и предоставляет функциональность для обработки списка идентификаторов или URL товаров, получения партнерских ссылок, сохранения изображений и видео, а также генерации данных для рекламных кампаний.

## Подробнее

Модуль предназначен для автоматизации процесса сбора данных о товарах с AliExpress и подготовки их для использования в рекламных кампаниях. Он включает в себя функциональность для получения партнерских ссылок, сохранения изображений и видео, а также сохранения полученных данных в файлы.

## Классы

### `AliAffiliatedProducts(AliApi)`

**Описание**: Класс для сбора полных данных о товарах по URL или ID товаров. Предоставляет методы для получения партнерских ссылок, сохранения изображений и видео, а также подготовки данных о товарах для рекламных кампаний.

**Наследует**: `AliApi`

**Атрибуты**:
- `language` (str): Язык для рекламной кампании. По умолчанию `None`.
- `currency` (str): Валюта для рекламной кампании. По умолчанию `None`.

**Методы**:
- `__init__(language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs)`: Инициализирует экземпляр класса `AliAffiliatedProducts`.
- `process_affiliate_products(prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]`: Обрабатывает список ID или URL товаров, возвращая список товаров с партнерскими ссылками и сохраненными изображениями.

#### `__init__`

```python
def __init__(self, language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs):
    """
    Инициализирует класс AliAffiliatedProducts.

    Args:
        language (str | dict): Язык для кампании (по умолчанию 'EN').
        currency (str): Валюта для кампании (по умолчанию 'USD').

    """
```

**Назначение**:
Инициализирует класс `AliAffiliatedProducts`, принимая язык и валюту в качестве параметров. Вызывает конструктор родительского класса `AliApi` и устанавливает значения атрибутов `language` и `currency`.

**Параметры**:
- `language` (str | dict): Язык для рекламной кампании. По умолчанию 'EN'.
- `currency` (str): Валюта для рекламной кампании. По умолчанию 'USD'.
- `*args`: Произвольные позиционные аргументы, передаваемые в конструктор родительского класса.
- `**kwargs`: Произвольные именованные аргументы, передаваемые в конструктор родительского класса.

**Как работает функция**:
- Проверяет, переданы ли значения для языка и валюты. Если нет, то записывает критическую ошибку в лог.
- Вызывает конструктор родительского класса `AliApi` с переданными языком и валютой.
- Устанавливает значения атрибутов `language` и `currency` текущего экземпляра класса.

#### `process_affiliate_products`

```python
async def process_affiliate_products(self, prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]:
    """
    Обрабатывает список ID или URL товаров и возвращает список товаров с партнерскими ссылками и сохраненными изображениями.

    Args:
        prod_ids (list[str]): Список URL или ID товаров.
        category_root (Path | str): Корневой путь к категории для сохранения изображений и видео.

    Returns:
        list[SimpleNamespace]: Список обработанных товаров с партнерскими ссылками и сохраненными изображениями.

    Raises:
        Exception: Если имя категории не найдено в кампании.

    """
```

**Назначение**:
Обрабатывает список идентификаторов товаров или URL-адресов, чтобы получить партнерские ссылки, сохранить изображения и видео, и вернуть список объектов SimpleNamespace с данными о товарах.

**Параметры**:
- `prod_ids` (list[str]): Список URL-адресов или идентификаторов товаров.
- `category_root` (Path | str): Корневой путь к каталогу, в котором будут сохранены изображения и видео товаров.

**Возвращает**:
- `list[SimpleNamespace]`: Список обработанных товаров с партнерскими ссылками и сохраненными изображениями.

**Как работает функция**:

1.  **Инициализация**:
    *   Инициализирует пустые списки `_promotion_links` и `_prod_urls` для хранения партнерских ссылок и URL-адресов товаров соответственно.
    *   Нормализует список `prod_ids`, приводя все URL-адреса к виду `https://aliexpress.com/item/<product_id>.html` с использованием функции `ensure_https`.
    *   Устанавливает флаг `print_flag` для управления печатью в одну строку.

2.  **Получение партнерских ссылок**:
    *   Перебирает нормализованные URL-адреса товаров (`normilized_prod_urls`).
    *   Для каждого URL-адреса товара вызывает метод `get_affiliate_links` родительского класса (`AliApi`) для получения партнерских ссылок.
    *   Если партнерские ссылки найдены, добавляет их в список `_promotion_links` и соответствующие URL-адреса товаров в список `_prod_urls`.

3.  **Обработка отсутствующих партнерских ссылок**:
    *   Если список `_promotion_links` пуст (т.е. не найдено ни одной партнерской ссылки), записывает предупреждение в лог и возвращает `None`.

4.  **Получение деталей товаров**:
    *   Вызывает метод `retrieve_product_details` для получения детальной информации о товарах по списку URL-адресов `_prod_urls`.
    *   Если информация о товарах не получена, возвращает `None`.

5.  **Сохранение изображений и видео**:
    *   Инициализирует пустой список `affiliated_products_list` для хранения обработанных товаров.
    *   Перебирает список товаров `_affiliated_products` и соответствующие партнерские ссылки `_promotion_links`.
    *   Для каждого товара:
        *   Добавляет заголовок товара в список `product_titles`.
        *   Устанавливает атрибуты `language` и `promotion_link` для товара.
        *   Формирует путь для сохранения изображения товара.
        *   Сохраняет изображение товара, используя асинхронную функцию `save_image_from_url`.
        *   Устанавливает атрибут `local_image_path` для товара, содержащий путь к сохраненному изображению.
        *   Если у товара есть видео, формирует путь для сохранения видео и сохраняет его, используя асинхронную функцию `save_video_from_url`.
        *   Устанавливает атрибут `local_video_path` для товара, содержащий путь к сохраненному видео.
        *   Сохраняет информацию о товаре в формате JSON.
        *   Добавляет товар в список `affiliated_products_list`.

6.  **Сохранение заголовков товаров**:
    *   Формирует путь для сохранения заголовков товаров в текстовый файл.
    *   Сохраняет список заголовков товаров в текстовый файл, используя асинхронную функцию `save_text_file`.

7.  **Возврат результата**:
    *   Возвращает список обработанных товаров `affiliated_products_list`.

**Примеры**:

Пример вызова функции:

```python
    >>> prod_ids = ["https://aliexpress.com/item/1234567890.html", "https://aliexpress.com/item/0987654321.html"]
    >>> category_root = "/path/to/category"
    >>> products = await self.process_affiliate_products(prod_ids, category_root)
    >>> for product in products:
    ...     print(product.product_title)
    "Product 1 Title"
    "Product 2 Title"
```

**Внутренние функции**:
В данной функции не используются внутренние функции.