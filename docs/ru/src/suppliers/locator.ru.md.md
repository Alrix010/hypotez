# Документация для разработчика: Локаторы для парсинга HTML-страниц

## Обзор

Этот документ предназначен для разработчиков, работающих с проектом `hypotez`. Он описывает структуру и использование локаторов, применяемых для извлечения данных из HTML-страниц поставщиков. Локаторы определяют, как находить и извлекать нужные элементы (текст, атрибуты, изображения и т.д.) с веб-страниц, используя различные стратегии поиска элементов и атрибуты веб-элементов. Документ содержит примеры локаторов, объяснение их структуры и рекомендации по их использованию и организации в проекте.

## Подробней

Локаторы используются для определения мест расположения необходимых данных на HTML-странице.  Они организованы в виде JSON-словарей и содержат инструкции по поиску и извлечению данных, таких как имя продукта, цена, изображения и другие атрибуты. Эти локаторы соотносятся с полями класса `ProductFields`, который используется для представления данных о товаре. Кроме того, можно определять локаторы для выполнения дополнительных действий, таких как закрытие баннеров или ввод данных в поля формы.

## Структура локаторов

### Пример локатора

```json
"close_banner": {
    "attribute": null, 
    "by": "XPATH",
    "selector": "//button[@id = 'closeXButton']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "click()",
    "locator_description": "Закрываю pop-up окно. Если оно не появилось — не страшно (`mandatory`: `false`)."
  }
```

### Ключи локатора

-   **`attribute`**: Атрибут веб-элемента, который необходимо получить. Если значение установлено в `null` или `false`, возвращается весь веб-элемент (`WebElement`).
-   **`by`**: Стратегия поиска элемента (например, `ID`, `XPATH`, `CSS_SELECTOR`).
-   **`selector`**: Селектор для определения местоположения веб-элемента (например, XPath-выражение).
-   **`if_list`**: Определяет, как обрабатывать список найденных элементов (например, `first`, `all`, `last`, `even`, `odd` или конкретные индексы).
-   **`use_mouse`**: Указывает, следует ли использовать мышь для выполнения действий с элементом (`true` или `false`).
-   **`event`**: Действие, которое WebDriver должен выполнить с веб-элементом (например, `click()`, `screenshot()`, `send_message()`).
-   **`mandatory`**: Указывает, является ли локатор обязательным. Если `true` и элемент не найден, возникает ошибка.
-   **`locator_description`**: Описание назначения локатора.

## Связь с `ProductFields`

Имя словаря локатора соответствует имени поля класса `ProductFields`. Например, локатор `"name"` используется для получения имени продукта.

```python
f = ProductFields(
    name = d.execute_locator('name'),
    price = d.execute_locator('price'),
    ...
)
```

## Сложные локаторы

Локаторы могут быть представлены в виде списков, кортежей или словарей для более сложных сценариев извлечения данных.

### Пример локатора со списками

```json
"sample_locator": {
    "attribute": [
      null,
      "href"
    ],
    "by": [
      "XPATH",
      "XPATH"
    ],
    "selector": [
      "//a[contains(@href, '#tab-description')]",
      "//div[@id = 'tab-description']//p"
    ],
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": [
      "click()",
      null
    ],
    "if_list": "first",
    "use_mouse": [
      false,
      false
    ],
    "mandatory": [
      "true",
      "true"
    ],
    "locator_description": [
      "Нажимаю на вкладку для открытия поля description.",
      "Читаю данные из div."
    ]
  }
```

В этом примере сначала будет найден элемент `//a[contains(@href, '#tab-description')]`, затем выполнена команда `click()` и получен атрибут `href`.

### Пример локатора со словарем

```json
"sample_locator": {
  "attribute": {"href": "name"},
  ...
}
```

## Подробное описание ключей локатора

1.  **`attribute`**: Определяет атрибут, который будет использован для поиска элемента. Значение `null` означает, что атрибут не используется для поиска.

2.  **`by`**: Указывает метод поиска элемента на странице, например, `XPATH`.

3.  **`selector`**: XPath выражение, используемое для нахождения элемента, например `"//a[@id = 'mainpic']//img"`.

4.  **`if_list`**: Указывает правило обработки списка элементов. Значение `first` означает, что если элементов несколько, будет возвращен первый элемент.

5.  **`use_mouse`**: Булевое значение, указывающее, нужно ли использовать мышь для взаимодействия с элементом.

6.  **`timeout`**: Время ожидания (в секундах) для нахождения элемента. Значение `0` означает немедленный поиск без ожидания.

7.  **`timeout_for_event`**: Время ожидания события (в секундах). Значение `"presence_of_element_located"` означает, что WebDriver будет ожидать появления элемента перед выполнением события.

8.  **`event`**: Указывает, какое событие должно быть выполнено с найденным элементом, например, `click()` или `screenshot()`.

9.  **`mandatory`**: Указывает, является ли локатор обязательным. Если установлено значение `true`, то если элемент не будет найден, будет вызвана ошибка.

10. **`locator_description`**: Описание того, что делает локатор.

## Дополнительные сведения об эвентах

-   `screenshot()`: Возвращает веб-элемент в виде снимка экрана.
-   `send_message()`: Отправляет сообщение веб-элементу. Рекомендуется использовать переменную `%EXTERNAL_MESSAGE%`.

    ```json
    {
        "timeout": 0,
        "timeout_for_event": "presence_of_element_located",
        "event": "click();backspace(10);%EXTERNAL_MESSAGE%"
    }
    ```

    В этом примере:

    1.  `click()` - нажимает на веб-элемент.
    2.  `backspace(10)` - удаляет 10 символов.
    3.  `%EXTERNAL_MESSAGE%` - отправляет сообщение в поле ввода.

## Адаптация к разным версиям страниц

Разметка страницы может меняться в зависимости от версии (например, десктопная и мобильная). Рекомендуется создавать отдельные файлы локаторов для каждой версии (например, `product.json` и `product_mobile_site.json`).

### Пример переключения локаторов

```python
async def grab_page(self) -> ProductFields:
    ...
    d = driver  
    if 'ksp.co.il/mob' in d.current_url:  # <- бывает, что подключается к мобильной версии сайта
        self.locator = j_loads_ns(gs.path.src / 'suppliers' / 'ksp' / 'locators' / 'product_mobile_site.json')
    ...
```

## Расположение файлов локаторов

```text
src/
├── suppliers/
│   ├── suppliers_list/
│   │   ├── supplier_a/
│   │   │   ├── __init__.py
│   │   │   ├── handler.py  # <--- Модуль для supplier_a
│   │   │   └── locators/
│   │   │       └── category.json
│   │   ├── supplier_b/
│   │   │   ├── __init__.py
│   │   │   ├── handler.py  # <--- Модуль для supplier_b
│   │   │   └── locators/
│   │   │       └── category.json
│   │   └── ...
│   └── ...
└── ...
```