# Модуль: Исполнитель сценариев поставщиков

## Обзор

Модуль предназначен для исполнения различных сценариев, связанных с поставщиками, таких как сбор товаров по категориям, фильтрам, производителям и т.д. Он обеспечивает гибкую и автоматизированную обработку данных о товарах из различных источников и их интеграцию в систему.

## Подробнее

Этот модуль является ключевым компонентом системы для автоматизации процесса сбора и обработки данных о товарах от поставщиков. Он позволяет определять сценарии, описывающие последовательность действий для получения информации о товарах, и автоматически выполнять эти сценарии.

## Классы

В данном модуле отсутствуют классы. Рассматриваются только функции.

## Функции

### `dump_journal(s, journal: dict) -> None`

**Назначение**: Сохраняет данные журнала в файл JSON.

**Параметры**:
- `s` (object): Инстанс поставщика.
- `journal` (dict): Словарь, содержащий данные журнала.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Как работает функция**:
- Формирует путь к файлу журнала на основе пути поставщика и имени журнала.
- Сохраняет содержимое словаря `journal` в файл JSON по указанному пути, используя функцию `j_dumps`.

**Примеры**:

```python
# Пример вызова функции
dump_journal(supplier_instance, {'name': 'test_scenario', 'data': {'key': 'value'}})
```

### `run_scenario_files(s, scenario_files_list: List[Path] | Path) -> bool`

**Назначение**: Выполняет список файлов сценариев.

**Параметры**:
- `s` (object): Инстанс поставщика.
- `scenario_files_list` (List[Path] | Path): Список путей к файлам сценариев или одиночный путь к файлу.

**Возвращает**:
- `bool`: `True`, если все сценарии были выполнены успешно, `False` в противном случае.

**Вызывает исключения**:
- `TypeError`: Если `scenario_files_list` не является списком или объектом `Path`.

**Как работает функция**:
1. Проверяет тип аргумента `scenario_files_list`. Если это `Path`, преобразует его в список. Если это не список и не `Path`, вызывает исключение `TypeError`.
2. Итерируется по списку файлов сценариев.
3. Для каждого файла сценария вызывает функцию `run_scenario_file`.
4. Логгирует результаты выполнения каждого сценария, используя `logger`.
5. Сохраняет информацию о выполнении сценария в журнале (`_journal`).

**Примеры**:

```python
from pathlib import Path
# Пример вызова с одним файлом сценария
run_scenario_files(supplier_instance, Path('path/to/scenario.json'))

# Пример вызова со списком файлов сценариев
run_scenario_files(supplier_instance, [Path('path/to/scenario1.json'), Path('path/to/scenario2.json')])
```

### `run_scenario_file(s, scenario_file: Path) -> bool`

**Назначение**: Загружает и выполняет сценарии из файла.

**Параметры**:
- `s` (object): Инстанс поставщика.
- `scenario_file` (Path): Путь к файлу сценария.

**Возвращает**:
- `bool`: `True`, если сценарий был выполнен успешно, `False` в противном случае.

**Как работает функция**:
1. Загружает содержимое файла сценария, используя функцию `j_loads`.
2. Извлекает список сценариев из загруженного содержимого.
3. Итерируется по списку сценариев и выполняет каждый сценарий с помощью функции `run_scenario`.
4. Логгирует результаты выполнения каждого сценария, используя `logger`.
5. Обрабатывает исключения, возникающие при загрузке или обработке файла сценария.

**Примеры**:

```python
from pathlib import Path
# Пример вызова функции
run_scenario_file(supplier_instance, Path('path/to/scenario.json'))
```

### `run_scenarios(s, scenarios: Optional[List[dict] | dict] = None, _journal=None) -> List | dict | bool`

**Назначение**: Выполняет список сценариев (не файлов).

**Параметры**:
- `s` (object): Инстанс поставщика.
- `scenarios` (Optional[List[dict] | dict], optional): Список сценариев или одиночный сценарий в виде словаря. По умолчанию `None`.
- `_journal` (Optional, optional): Журнал для записи результатов. По умолчанию `None`.

**Возвращает**:
- `List | dict | bool`: Результат выполнения сценариев или `False` в случае ошибки.

**Как работает функция**:
1. Проверяет, переданы ли сценарии в аргументе `scenarios`. Если нет, использует `s.current_scenario`.
2. Преобразует сценарии в список, если передан одиночный сценарий.
3. Итерируется по списку сценариев и выполняет каждый сценарий с помощью функции `run_scenario`.
4. Сохраняет результаты выполнения сценариев в журнале (`_journal`).

**Примеры**:

```python
# Пример вызова с одним сценарием
run_scenarios(supplier_instance, {'scenario_name': 'test_scenario', 'steps': [...]})

# Пример вызова со списком сценариев
run_scenarios(supplier_instance, [
    {'scenario_name': 'test_scenario1', 'steps': [...]},
    {'scenario_name': 'test_scenario2', 'steps': [...]},
])
```

### `run_scenario(supplier, scenario: dict, scenario_name: str, _journal=None) -> List | dict | bool`

**Назначение**: Выполняет полученный сценарий.

**Параметры**:
- `supplier` (object): Инстанс поставщика.
- `scenario` (dict): Словарь, содержащий детали сценария.
- `scenario_name` (str): Имя сценария.
- `_journal` (Optional, optional): Журнал для записи результатов. По умолчанию `None`.

**Возвращает**:
- `List | dict | bool`: Результат выполнения сценария.

**Как работает функция**:
1. Получает инстанс драйвера из инстанса поставщика.
2. Открывает URL, указанный в сценарии, с помощью драйвера.
3. Получает список товаров в категории, используя метод `get_list_products_in_category` из `s.related_modules`.
4. Если список товаров пуст, логирует предупреждение и возвращает `False`.
5. Итерируется по списку URL товаров.
6. Для каждого URL:
   - Открывает URL товара с помощью драйвера.
   - Собирает поля страницы товара, используя метод `grab_product_page` из `s.related_modules`.
   - Запускает асинхронный сбор данных, используя метод `grab_page` из `s.related_modules`.
   - Извлекает словари `presta_fields_dict` и `assist_fields_dict` из полученного объекта `ProductFields`.
   - Создает объект `Product` и вставляет собранные данные.
   - Обрабатывает исключения, возникающие при создании и сохранении продукта.

**Примеры**:

```python
# Пример вызова функции
run_scenario(supplier_instance, {'url': 'http://example.com/category', 'steps': [...]}, 'test_scenario')
```

### `insert_grabbed_data_to_prestashop(f: ProductFields, coupon_code: Optional[str] = None, start_date: Optional[str] = None, end_date: Optional[str] = None) -> bool`

**Назначение**: Вставляет данные о товаре в PrestaShop.

**Параметры**:
- `f` (ProductFields): Инстанс `ProductFields`, содержащий информацию о товаре.
- `coupon_code` (Optional[str], optional): Код купона (если есть). По умолчанию `None`.
- `start_date` (Optional[str], optional): Дата начала акции (если есть). По умолчанию `None`.
- `end_date` (Optional[str], optional): Дата окончания акции (если есть). По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если вставка выполнена успешно, `False` в противном случае.

**Как работает функция**:
1. Создает инстанс класса `PrestaShop`.
2. Вызывает метод `post_product_data` для вставки данных о товаре в PrestaShop.
3. Обрабатывает исключения, возникающие при вставке данных.

**Примеры**:

```python
# Пример вызова функции
insert_grabbed_data_to_prestashop(
    product_fields_instance,
    coupon_code='SUMMER20',
    start_date='2024-06-01',
    end_date='2024-08-31'
)