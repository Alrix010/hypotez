# Модуль для работы с моделями OpenAI

## Обзор

Модуль `src.ai.openai.model.training` предоставляет класс `OpenAIModel` для взаимодействия с API OpenAI, управления моделями и их обучения. Он включает в себя функциональность для отправки сообщений, анализа тональности, динамической настройки и обучения моделей на основе предоставленных данных.

## Подробней

Модуль предназначен для упрощения работы с API OpenAI, предоставляя удобный интерфейс для выполнения различных задач, таких как отправка сообщений, обучение моделей и анализ тональности. Класс `OpenAIModel` инкапсулирует логику взаимодействия с API OpenAI и предоставляет методы для управления моделями и их обучения. Расположение модуля в проекте указывает на его роль в качестве компонента, отвечающего за взаимодействие с моделями OpenAI.

## Классы

### `OpenAIModel`

**Описание**: Класс для взаимодействия с API OpenAI и управления моделями.

**Атрибуты**:

- `model` (str): Имя используемой модели, по умолчанию "gpt-4o-mini".
- `client` (OpenAI): Клиент OpenAI для взаимодействия с API.
- `current_job_id` (str): ID текущей задачи обучения.
- `assistant_id` (str): ID ассистента OpenAI.
- `assistant` (объект OpenAI): Объект ассистента OpenAI.
- `thread` (объект OpenAI): Объект треда OpenAI.
- `system_instruction` (str): Системная инструкция для модели.
- `dialogue_log_path` (str | Path): Путь к файлу журнала диалогов.
- `dialogue` (List[Dict[str, str]]): Список диалогов.
- `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
- `models_list` (List[str]): Список доступных моделей.

**Методы**:

- `__init__(self, api_key: str, system_instruction: str = None, model_name: str = 'gpt-4o-mini', assistant_id: str = None)`: Инициализирует объект `OpenAIModel`.
- `list_models(self) -> List[str]`: Возвращает список доступных моделей из API OpenAI.
- `list_assistants(self) -> List[str]`: Возвращает список доступных ассистентов из JSON-файла.
- `set_assistant(self, assistant_id: str)`: Устанавливает ассистента, используя предоставленный ID.
- `_save_dialogue(self)`: Сохраняет весь диалог в JSON-файл.
- `determine_sentiment(self, message: str) -> str`: Определяет тональность сообщения (положительная, отрицательная или нейтральная).
- `ask(self, message: str, system_instruction: str = None, attempts: int = 3) -> str`: Отправляет сообщение модели и возвращает ответ с анализом тональности.
- `describe_image(self, image_path: str | Path, prompt: Optional[str] = None, system_instruction: Optional[str] = None) -> str`: Описывает изображение, используя модель OpenAI.
- `describe_image_by_requests(self, image_path: str | Path, prompt: str = None) -> str`: Отправляет изображение в API OpenAI и получает описание, используя requests.
- `dynamic_train(self)`: Динамически загружает предыдущий диалог и настраивает модель на его основе.
- `train(self, data: str = None, data_dir: Path | str = None, data_file: Path | str = None, positive: bool = True) -> str | None`: Обучает модель на указанных данных или директории.
- `save_job_id(self, job_id: str, description: str, filename: str = "job_ids.json")`: Сохраняет ID задачи обучения с описанием в файл.

**Принцип работы**:

Класс `OpenAIModel` предоставляет интерфейс для взаимодействия с API OpenAI. При инициализации класса создается клиент OpenAI и загружаются доступные модели и ассистенты. Класс содержит методы для отправки сообщений, анализа тональности, динамической настройки и обучения моделей на основе предоставленных данных. Класс также предоставляет методы для сохранения и загрузки диалогов и задач обучения.

## Методы класса

### `__init__`

```python
def __init__(self, api_key: str, system_instruction: str = None, model_name: str = 'gpt-4o-mini', assistant_id: str = None)
```

**Назначение**: Инициализирует объект `OpenAIModel` с использованием API-ключа, системных инструкций, имени модели и ID ассистента.

**Параметры**:

- `api_key` (str): Ключ API для аутентификации в OpenAI.
- `system_instruction` (str, optional): Системные инструкции для модели. По умолчанию `None`.
- `model_name` (str, optional): Имя модели для использования. По умолчанию `'gpt-4o-mini'`.
- `assistant_id` (str, optional): ID ассистента OpenAI. По умолчанию ID code_assistant из `gs.credentials.openai.assistant_id`.

**Как работает функция**:

Функция инициализирует клиент OpenAI с использованием предоставленного API-ключа или ключа из `gs.credentials.openai.api_key`. Она также устанавливает текущий ID задачи, ID ассистента и системные инструкции. Кроме того, функция загружает ассистента и создает тред для взаимодействия с API OpenAI.

### `list_models`

```python
@property
def list_models(self) -> List[str]:
```

**Назначение**: Динамически получает и возвращает доступные модели из API OpenAI.

**Возвращает**:

- `List[str]`: Список ID моделей, доступных через API OpenAI.

**Вызывает исключения**:

- `Exception`: В случае ошибки при загрузке моделей.

**Как работает функция**:

Функция пытается получить список доступных моделей из API OpenAI с помощью `self.client.models.list()`. Если запрос успешен, функция извлекает ID каждой модели из полученных данных и возвращает их в виде списка. В случае ошибки функция регистрирует ошибку с помощью `logger.error` и возвращает пустой список.

### `list_assistants`

```python
@property
def list_assistants(self) -> List[str]:
```

**Назначение**: Динамически загружает доступных ассистентов из JSON-файла.

**Возвращает**:

- `List[str]`: Список имен ассистентов.

**Вызывает исключения**:

- `Exception`: В случае ошибки при загрузке ассистентов.

**Как работает функция**:

Функция пытается загрузить список доступных ассистентов из JSON-файла, расположенного по пути `gs.path.src / 'llm' / 'openai' / 'model' / 'assistants' / 'assistants.json'`, с помощью функции `j_loads_ns`. Если загрузка успешна, функция извлекает имена ассистентов и возвращает их в виде списка. В случае ошибки функция регистрирует ошибку с помощью `logger.error` и возвращает пустой список.

### `set_assistant`

```python
def set_assistant(self, assistant_id: str):
```

**Назначение**: Устанавливает ассистента, используя предоставленный ID ассистента.

**Параметры**:

- `assistant_id` (str): ID ассистента для установки.

**Вызывает исключения**:

- `Exception`: В случае ошибки при установке ассистента.

**Как работает функция**:

Функция пытается установить ассистента с использованием предоставленного ID. Она обновляет атрибут `self.assistant_id` и загружает информацию об ассистенте с помощью `self.client.beta.assistants.retrieve(assistant_id)`. В случае успеха функция регистрирует информацию об установке ассистента с помощью `logger.info`. В случае ошибки функция регистрирует ошибку с помощью `logger.error`.

### `_save_dialogue`

```python
def _save_dialogue(self):
```

**Назначение**: Сохраняет весь диалог в JSON-файл.

**Как работает функция**:

Функция сохраняет весь диалог, хранящийся в атрибуте `self.dialogue`, в JSON-файл, расположенный по пути `self.dialogue_log_path`, с помощью функции `j_dumps`.

### `determine_sentiment`

```python
def determine_sentiment(self, message: str) -> str:
```

**Назначение**: Определяет тональность сообщения (положительная, отрицательная или нейтральная).

**Параметры**:

- `message` (str): Сообщение для анализа.

**Возвращает**:

- `str`: Тональность ('positive', 'negative' или 'neutral').

**Как работает функция**:

Функция анализирует сообщение на наличие позитивных, негативных и нейтральных слов. Если в сообщении обнаружены позитивные слова, функция возвращает "positive". Если обнаружены негативные слова, функция возвращает "negative". Если обнаружены нейтральные слова, функция возвращает "neutral". В противном случае функция возвращает "neutral".

### `ask`

```python
def ask(self, message: str, system_instruction: str = None, attempts: int = 3) -> str:
```

**Назначение**: Отправляет сообщение модели и возвращает ответ с анализом тональности.

**Параметры**:

- `message` (str): Сообщение для отправки модели.
- `system_instruction` (str, optional): Дополнительные системные инструкции. По умолчанию `None`.
- `attempts` (int, optional): Количество попыток повторной отправки сообщения в случае ошибки. По умолчанию `3`.

**Возвращает**:

- `str`: Ответ от модели.

**Вызывает исключения**:

- `Exception`: В случае ошибки при отправке сообщения.

**Как работает функция**:

Функция отправляет сообщение модели OpenAI и возвращает ответ. Сначала функция формирует список сообщений, включая системные инструкции (если они предоставлены) и сообщение пользователя. Затем функция отправляет запрос к API OpenAI с использованием `self.client.chat.completions.create`. После получения ответа функция извлекает текст ответа, анализирует его тональность с помощью `self.determine_sentiment`, добавляет сообщения и тональность в диалог и сохраняет диалог с помощью `self._save_dialogue`. В случае ошибки функция регистрирует ошибку с помощью `logger.debug` и повторяет попытку отправки сообщения (если количество попыток не исчерпано).

### `describe_image`

```python
def describe_image(self, image_path: str | Path, prompt: Optional[str] = None, system_instruction: Optional[str] = None) -> str:
```

**Назначение**: Описывает изображение, используя модель OpenAI.

**Параметры**:

- `image_path` (str | Path): Путь к файлу изображения.
- `prompt` (Optional[str], optional): Дополнительный текст запроса. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Дополнительные системные инструкции. По умолчанию `None`.

**Как работает функция**:

Функция описывает изображение, используя модель OpenAI. Сначала функция кодирует изображение в base64. Затем функция формирует список сообщений, включая системные инструкции (если они предоставлены) и сообщение пользователя с изображением. После этого функция отправляет запрос к API OpenAI с использованием `self.client.chat.completions.create`. После получения ответа функция извлекает текст ответа и пытается преобразовать его в объект `SimpleNamespace` с помощью `j_loads_ns`. В случае ошибки при преобразовании функция регистрирует ошибку с помощью `logger.error`. В случае ошибки при отправке запроса функция также регистрирует ошибку с помощью `logger.error`.

### `describe_image_by_requests`

```python
def describe_image_by_requests(self, image_path: str | Path, prompt: str = None) -> str:
```

**Назначение**: Отправляет изображение в API OpenAI и получает описание, используя requests.

**Параметры**:

- `image_path` (str | Path): Путь к файлу изображения.
- `prompt` (str, optional): Дополнительный текст запроса. По умолчанию `None`.

**Как работает функция**:

Функция отправляет изображение в API OpenAI и получает описание, используя библиотеку `requests`. Сначала функция кодирует изображение в base64. Затем функция формирует заголовок запроса и полезную нагрузку (payload) с информацией об изображении и запросе. После этого функция отправляет POST-запрос к API OpenAI с использованием `requests.post`. В случае успеха функция обрабатывает ответ и возвращает результат. В случае ошибки функция регистрирует ошибку с помощью `logger.error`.

### `dynamic_train`

```python
def dynamic_train(self):
```

**Назначение**: Динамически загружает предыдущий диалог и настраивает модель на его основе.

**Как работает функция**:

Функция динамически загружает предыдущий диалог из файла `gs.path.google_drive / 'AI' / 'conversation' / 'dailogue.json'` с использованием `j_loads`. Если диалог найден, он отправляется в API OpenAI для настройки модели. В случае успеха функция регистрирует информацию об успешной настройке с помощью `logger.info`. В случае отсутствия диалога функция регистрирует информацию об отсутствии диалога с помощью `logger.info`. В случае ошибки функция регистрирует ошибку с помощью `logger.error`.

### `train`

```python
def train(self, data: str = None, data_dir: Path | str = None, data_file: Path | str = None, positive: bool = True) -> str | None:
```

**Назначение**: Обучает модель на указанных данных или директории.

**Параметры**:

- `data` (str, optional): Путь к CSV-файлу или CSV-форматированная строка с данными.
- `data_dir` (Path | str, optional): Каталог, содержащий CSV-файлы для обучения.
- `data_file` (Path | str, optional): Путь к одному CSV-файлу с данными для обучения.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:

- `str | None`: ID задачи обучения или `None`, если произошла ошибка.

**Вызывает исключения**:

- `Exception`: В случае ошибки во время обучения.

**Как работает функция**:

Функция обучает модель на указанных данных или директории. Сначала функция определяет, какой источник данных использовать (строка `data`, файл `data_file` или директория `data_dir`). Затем функция загружает данные с использованием `j_loads`. После этого функция отправляет запрос к API OpenAI для обучения модели с использованием `self.client.Training.create`. В случае успеха функция сохраняет ID задачи обучения в атрибуте `self.current_job_id` и возвращает его. В случае ошибки функция регистрирует ошибку с помощью `logger.error` и возвращает `None`.

### `save_job_id`

```python
def save_job_id(self, job_id: str, description: str, filename: str = "job_ids.json"):
```

**Назначение**: Сохраняет ID задачи обучения с описанием в файл.

**Параметры**:

- `job_id` (str): ID задачи обучения для сохранения.
- `description` (str): Описание задачи.
- `filename` (str, optional): Имя файла для сохранения ID задачи. По умолчанию `"job_ids.json"`.

**Как работает функция**:

Функция сохраняет ID задачи обучения с описанием в файл. Сначала функция формирует словарь с данными о задаче. Затем функция определяет, существует ли файл с ID задач. Если файл не существует, функция создает его и сохраняет в нем данные о задаче. Если файл существует, функция загружает существующие данные, добавляет в них данные о задаче и сохраняет обновленные данные в файл.

## Параметры класса

- `model` (str): Имя используемой модели, по умолчанию "gpt-4o-mini".
- `client` (OpenAI): Клиент OpenAI для взаимодействия с API.
- `current_job_id` (str): ID текущей задачи обучения.
- `assistant_id` (str): ID ассистента OpenAI.
- `assistant` (объект OpenAI): Объект ассистента OpenAI.
- `thread` (объект OpenAI): Объект треда OpenAI.
- `system_instruction` (str): Системная инструкция для модели.
- `dialogue_log_path` (str | Path): Путь к файлу журнала диалогов.
- `dialogue` (List[Dict[str, str]]): Список диалогов.
- `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
- `models_list` (List[str]): Список доступных моделей.

## Примеры

```python
# Инициализация модели с системными инструкциями и ID ассистента (необязательно)
model = OpenAIModel(system_instruction="You are a helpful assistant.", assistant_id="asst_dr5AgQnhhhnef5OSMzQ9zdk9")

# Пример получения списка доступных моделей
print("Available Models:")
models = model.list_models
pprint(models)

# Пример получения списка доступных ассистентов
print("\nAvailable Assistants:")
assistants = model.list_assistants
pprint(assistants)

# Пример отправки вопроса модели
user_input = "Hello, how are you?"
print("\nUser Input:", user_input)
response = model.ask(user_input)
print("Model Response:", response)

# Пример динамического обучения с использованием предыдущего диалога
print("\nPerforming dynamic training...")
model.dynamic_train()

# Пример обучения модели с использованием предоставленных данных
print("\nTraining the model...")
training_result = model.train(data_file=gs.path.google_drive / 'AI' / 'training_data.csv')
print(f"Training job ID: {training_result}")

# Пример сохранения ID задачи обучения
if training_result:
    model.save_job_id(training_result, "Training model with new data", filename="job_ids.json")
    print(f"Saved training job ID: {training_result}")

# Пример описания изображения
image_path = gs.path.google_drive / 'images' / 'example_image.jpg'
print("\nDescribing Image:")
description = model.describe_image(image_path)
print(f"Image description: {description}")
```

## Функция `main`

```python
def main():
```

**Назначение**: Главная функция для инициализации `OpenAIModel` и демонстрации использования.

**Как работает функция**:

1.  **Инициализация модели**:
    *   Инициализируется `OpenAIModel` с системной инструкцией и ID ассистента (параметры можно изменить).
2.  **Вывод списка моделей и ассистентов**:
    *   Вызываются методы `list_models` и `list_assistants` для получения и вывода доступных моделей и ассистентов.
3.  **Запрос к модели**:
    *   Метод `ask()` используется для отправки сообщения модели и получения ответа.
4.  **Динамическое обучение**:
    *   Метод `dynamic_train()` выполняет динамическую настройку на основе прошлых диалогов.
5.  **Обучение модели**:
    *   Метод `train()` обучает модель с использованием данных из указанного файла (`training_data.csv`).
6.  **Сохранение ID задачи обучения**:
    *   После обучения, ID задачи сохраняется с описанием в JSON-файл.
7.  **Описания изображения**:
    *   После обучения, ID задачи сохраняется с описанием в JSON-файл.

## Примеры

```python
if __name__ == "__main__":
    main()