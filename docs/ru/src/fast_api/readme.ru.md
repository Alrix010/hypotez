# Документация для `fast_api_rpc.py` и `main.py`

## Обзор

Данная документация описывает взаимодействие между двумя основными компонентами: `fast_api_rpc.py` (серверная часть) и `main.py` (клиентская часть). Цель - предоставить разработчикам полное понимание архитектуры и принципов работы для эффективной разработки и обслуживания.

## Подробнее

Этот код реализует систему управления FastAPI-сервером через XML-RPC. Серверная часть (`fast_api_rpc.py`) предоставляет API для запуска, остановки и управления серверами, а клиентская часть (`main.py`) предоставляет интерфейс командной строки для взаимодействия с сервером.

## Основные компоненты

### `fast_api_rpc.py` (серверная часть)

#### Обзор

Содержит классы и методы для запуска FastAPI-сервера и обработки удаленных команд через XML-RPC.

#### Классы

##### `FastApiServer`

**Описание**: Класс для управления FastAPI-сервером.

**Принцип работы**: Создает и настраивает веб-сервер, добавляет новые маршруты.

##### `CommandHandler`

**Описание**: Класс для управления вызовами функций управления сервером.

**Атрибуты**:

-   `rpc_server` (SimpleXMLRPCServer): XML-RPC сервер для обработки удаленных вызовов.

**Методы**:

-   `__init__(self)`:
    *   **Назначение**: Инициализирует XML-RPC сервер и регистрирует методы для удаленного вызова.
    *   **Как работает**:
        -   Создает объект `SimpleXMLRPCServer`, который слушает запросы на порту `9000` (по умолчанию).
        -   Метод `register_instance(self)` делает все методы этого класса доступными для удаленного вызова.
        -   `threading.Thread(target=self.rpc_server.serve_forever, daemon=True).start()` запускает XML-RPC сервер в отдельном потоке, что позволяет ему работать параллельно с остальным кодом.

-   `start_server(self, port: int, host: str) -> None`:
    *   **Назначение**: Запускает FastAPI-сервер на указанном порту и хосте.

    *   **Параметры**:
        -   `port` (int): Порт для запуска сервера.
        -   `host` (str): Хост для запуска сервера.

    *   **Возвращает**:
        -   `None`: Ничего не возвращает.
        
    *   **Как работает функция**:
        -   Вызывает функцию `start_server` и запускает FastAPI сервер.
    *   **Примеры**:
        -   Вызов `start_server` с разными портами и хостами:

            ```python
            command_handler.start_server(port=8000, host="0.0.0.0")
            command_handler.start_server(port=8080, host="127.0.0.1")
            ```

-   `stop_server(self, port: int) -> None`:
    *   **Назначение**: Останавливает FastAPI-сервер на указанном порту.

    *   **Параметры**:
        -   `port` (int): Порт сервера для остановки.

    *   **Возвращает**:
        -   `None`: Ничего не возвращает.
    *   **Как работает функция**:
        -   Останавливает FastAPI-сервер на указанном порту.

-   `stop_all_servers(self) -> None`:
    *   **Назначение**: Останавливает все запущенные FastAPI-серверы.

    *   **Параметры**:
        -   `None`: Функция не принимает параметров.

    *   **Возвращает**:
        -   `None`: Ничего не возвращает.
    *   **Как работает функция**:
        -   Останавливает все запущенные FastAPI-серверы.

-   `status_servers(self) -> dict`:
    *   **Назначение**: Возвращает статус всех запущенных FastAPI-серверов.

    *   **Параметры**:
        -   `None`: Функция не принимает параметров.

    *   **Возвращает**:
        -   `dict`: Словарь со статусами серверов.
    *   **Как работает функция**:
        -   Возвращает статус всех запущенных FastAPI-серверов.

-   `add_new_route(self, port: int, path: str, return_value: str) -> None`:
    *   **Назначение**: Добавляет новый маршрут на указанный порт.

    *   **Параметры**:
        -   `port` (int): Порт сервера, на который добавляется маршрут.
        -   `path` (str): Путь маршрута.
        -   `return_value` (str): Значение, возвращаемое маршрутом.

    *   **Возвращает**:
        -   `None`: Ничего не возвращает.
    *   **Как работает функция**:
        -   Добавляет новый маршрут на указанный порт.

-   `shutdown(self) -> None`:
    *   **Назначение**: Завершает работу XML-RPC сервера.

    *   **Параметры**:
        -   `None`: Функция не принимает параметров.

    *   **Возвращает**:
        -   `None`: Ничего не возвращает.
    *   **Как работает функция**:
        -   Завершает работу XML-RPC сервера.

### `main.py` (клиентская часть)

#### Обзор

Предоставляет интерфейс командной строки для взаимодействия с RPC-сервером.

#### Классы

-   Отсутствуют

#### Функции

##### `main()`
    *   **Назначение**: Главная функция клиентской части, обеспечивающая взаимодействие с пользователем и RPC-сервером.
    *   **Как работает**:
        -   Создается `ServerProxy`, который подключается к XML-RPC серверу по адресу `http://localhost:9000`.
        -   Функция `main.py` начинает показывать меню и ожидать ввода пользователя.
    *   **Внутренние функции**: Отсутствуют

## Взаимодействие между компонентами

1.  **Запуск `fast_api_rpc.py`**:
    -   Создается экземпляр `CommandHandler`.
    -   В конструкторе `CommandHandler` создается XML-RPC сервер, который начинает слушать порт `9000`.
    -   Запускается FastAPI-сервер(ы).
2.  **Запуск `main.py`**:
    -   Создается `ServerProxy`, который подключается к XML-RPC серверу по адресу `http://localhost:9000`.
    -   `main.py` начинает показывать меню и ожидать ввода пользователя.
3.  **Ввод команды**:
    -   `main.py` анализирует введенную строку, выделяет команду и её аргументы.
    -   `main.py` вызывает соответствующий метод RPC-сервера через объект `rpc_client`.
4.  **Обработка запроса на сервере**:
    -   XML-RPC клиент `rpc_client` создает XML-сообщение, которое отправляет на сервер `fast_api_rpc.py`.
    -   XML-RPC сервер в `fast_api_rpc.py` получает этот запрос.
    -   Он понимает, что нужно вызвать метод у объекта `CommandHandler`.
    -   Вызывается метод `start_server`, который вызывает функцию `start_server` и запускает FastAPI сервер.
5.  **Возврат ответа**:
    -   XML-RPC сервер формирует ответ, содержащий результат вызова (в данном случае, это может быть `None`).
    -   Этот ответ отправляется обратно клиенту `main.py`.
    -   Клиент получает ответ.
6.  **Отображение результата**:
    -   `main.py` может отобразить результат в консоль (или проигнорировать его, если это None).
7.  **Повторение цикла**:
    -   `main.py` возвращается к началу цикла, отображая меню и ожидая ввода следующей команды.

## Ключевые моменты

-   **Разделение ответственности**: `fast_api_rpc.py` отвечает за управление сервером и предоставление интерфейса для управления, `main.py` отвечает за взаимодействие с пользователем и отправку команд.
-   **XML-RPC**: `xmlrpc` используется для организации связи между двумя процессами, что позволяет вызывать методы сервера из клиентской программы.
-   **Потоки**: XML-RPC сервер запущен в отдельном потоке, поэтому он может работать параллельно с остальным кодом.
-   **Удаленный вызов**: `ServerProxy` позволяет вызывать методы, как если бы они были частью локального кода, хотя на самом деле они выполняются на удаленном сервере.

## Преимущества данного подхода

-   **Управление сервером из другой программы**: Можно контролировать запущенный сервер через другой процесс или даже с другой машины.
-   **Разделение кода**: Логика управления сервером и пользовательский интерфейс разделены, что делает код более модульным и легким в обслуживании.
-   **Гибкость**: Можно добавить новые методы управления сервером, просто добавив их в `CommandHandler`, и они автоматически станут доступны через RPC.