# Модуль FastAPI сервера с XML-RPC интерфейсом для удалённого управления

## Обзор

Модуль предоставляет реализацию FastAPI сервера с интерфейсом XML-RPC для удалённого управления. Он позволяет запускать, останавливать и управлять серверами FastAPI через удалённые вызовы процедур (RPC).

## Подробнее

Этот модуль реализует FastAPI сервер с возможностью удалённого управления через XML-RPC. Он включает в себя классы и функции для запуска и остановки серверов, добавления новых маршрутов, а также управления сервером через командную строку или RPC.

## Содержание

- [Классы](#Классы)
  - [FastApiServer](#FastApiServer)
  - [CommandHandler](#CommandHandler)
- [Функции](#Функции)
  - [telegram_webhook](#telegram_webhook)
  - [test_function](#test_function)
  - [test_post](#test_post)
  - [start_server](#start_server)
  - [stop_server](#stop_server)
  - [stop_all_servers](#stop_all_servers)
  - [status_servers](#status_servers)
  - [get_routes](#get_routes)
  - [add_new_route](#add_new_route)
  - [parse_port_range](#parse_port_range)
  - [display_menu](#display_menu)
  - [main](#main)

## Классы

### `FastApiServer`

Описание: Класс `FastApiServer` реализует FastAPI сервер с поддержкой Singleton, что гарантирует существование только одного экземпляра сервера.

**Атрибуты**:

- `_instance`: Приватный атрибут класса для хранения единственного экземпляра класса (Singleton).
- `app` (FastAPI): Экземпляр FastAPI приложения.
- `host` (str): Хост, на котором запускается сервер. По умолчанию берётся из конфигурации.
- `port` (int): Порт, на котором запускается сервер. По умолчанию 8000.
- `router` (APIRouter): Роутер для добавления API маршрутов.
- `server_tasks` (dict): Словарь для хранения задач сервера.
- `servers` (dict): Словарь для хранения запущенных серверов.

**Методы**:

- `__new__(cls, *args, **kwargs)`: Обеспечивает создание только одного экземпляра класса (Singleton).
- `__init__(self, host: str = "127.0.0.1", title: str = "FastAPI RPC Server", **kwargs)`: Инициализирует экземпляр `FastApiServer`, добавляет маршруты `/hello` и `/post`, инициализирует FastAPI приложение.
- `add_route(self, path: str, func: Callable, methods: List[str] = ["GET"], **kwargs)`: Добавляет маршрут к FastAPI приложению.
- `_start_server(self, port: int)`: Запускает uvicorn сервер асинхронно.
- `start(self, port: int, as_thread: bool = True)`: Запускает FastAPI сервер на указанном порту.
- `stop(self, port: int)`: Останавливает FastAPI сервер на указанном порту.
- `stop_all(self)`: Останавливает все запущенные сервера.
- `get_servers_status(self)`: Возвращает статус всех серверов.
- `get_routes(self)`: Возвращает список всех роутов.
- `get_app(self)`: Возвращает FastAPI приложение.
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"], **kwargs)`: Добавляет новый маршрут к уже работающему приложению.

### `CommandHandler`

Описание: Класс `CommandHandler` обрабатывает команды для управления FastAPI сервером через XML-RPC.

**Атрибуты**:

- `rpc_port` (int): Порт для XML-RPC сервера.
- `rpc_server` (SimpleXMLRPCServer): Экземпляр XML-RPC сервера.

**Методы**:

- `__init__(self, rpc_port=9000)`: Инициализирует обработчик команд, запускает XML-RPC сервер в отдельном потоке.
- `start_server(self, port: int, host: str)`: Запускает FastAPI сервер.
- `stop_server(self, port: int)`: Останавливает FastAPI сервер.
- `stop_all_servers(self)`: Останавливает все запущенные FastAPI сервера.
- `status_servers(self)`: Показывает статус серверов.
- `get_routes(self)`: Показывает все роуты.
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"])`: Добавляет новый роут к серверу.
- `shutdown(self)`: Останавливает все сервера и завершает работу XML-RPC сервера.

## Функции

### `telegram_webhook`

```python
def telegram_webhook() -> str:
    """
    Функция возвращает строку "Hello, World!".
    
    Returns:
        str: Строка "Hello, World!".

    Примеры:
        >>> telegram_webhook()
        'Hello, World!'
    """
```

### `test_function`

```python
def test_function() -> str:
    """
    Функция возвращает строку "It is working!!!".

    Returns:
        str: Строка "It is working!!!".

    Примеры:
        >>> test_function()
        'It is working!!!'
    """
```

### `test_post`

```python
def test_post(data: Dict[str, str]) -> Dict[str, str]:
    """
    Функция возвращает словарь с результатом "post ok" и переданными данными.

    Args:
        data (Dict[str, str]): Словарь с данными.

    Returns:
        Dict[str, str]: Словарь с результатом и данными.

    Примеры:
        >>> test_post({"key": "value"})
        {'result': 'post ok', 'data': {'key': 'value'}}
    """
```

### `start_server`

```python
def start_server(port: int, host: str) -> None:
    """
    Запускает FastAPI сервер на указанном порту.

    Args:
        port (int): Порт для запуска сервера.
        host (str): Хост для запуска сервера.
    """
```
**Как работает функция**:
     - Функция проверяет, инициализирован ли уже экземпляр `FastApiServer`. Если нет, то создает его.
     - Функция вызывает метод `start` у экземпляра `FastApiServer` для запуска сервера на указанном порту и хосте.
     - В случае возникновения ошибки в процессе запуска сервера, она логируется с использованием `logger.error`.

```python
    #Примеры:
    start_server(8000, '127.0.0.1')
```

### `stop_server`

```python
def stop_server(port: int) -> None:
    """
    Останавливает FastAPI сервер на указанном порту.

    Args:
        port (int): Порт сервера для остановки.
    """
```
**Как работает функция**:
     - Функция проверяет, инициализирован ли экземпляр `FastApiServer`.
     - Если экземпляр существует, функция вызывает метод `stop` для остановки сервера на указанном порту.
     - Функция перехватывает возможные исключения и логирует их с использованием `logger.error`.
```python
    #Примеры:
    stop_server(8000)
```

### `stop_all_servers`

```python
def stop_all_servers() -> None:
    """
    Останавливает все запущенные FastAPI сервера.
    """
```
**Как работает функция**:
     - Функция проверяет, инициализирован ли экземпляр `FastApiServer`.
     - Если экземпляр существует, функция вызывает метод `stop_all` для остановки всех запущенных серверов.
     - Функция перехватывает возможные исключения и логирует их с использованием `logger.error`.
```python
    #Примеры:
    stop_all_servers()
```

### `status_servers`

```python
def status_servers() -> None:
    """
    Выводит статус всех серверов.
    """
```
**Как работает функция**:
    - Функция проверяет, инициализирован ли экземпляр `FastApiServer`.
    - Если экземпляр существует, функция вызывает метод `get_servers_status` для получения статуса всех серверов.
    - Далее, функция выводит информацию о статусе каждого сервера в консоль. Если сервера не запущены, выводится соответствующее сообщение.
```python
    #Примеры:
    status_servers()
```

### `get_routes`

```python
def get_routes() -> None:
    """
    Показывает все роуты.
    """
```

**Как работает функция**:
    - Функция проверяет, инициализирован ли экземпляр `FastApiServer`.
    - Если экземпляр существует, функция вызывает метод `get_routes` для получения списка всех маршрутов.
    - Функция выводит информацию о каждом маршруте в консоль, включая путь и методы. Если маршруты не определены, выводится соответствующее сообщение.
```python
    #Примеры:
    get_routes()
```

### `add_new_route`

```python
def add_new_route(path: str, module_name: str, func_name: str, methods: List[str] = ["GET"]) -> None:
    """
    Добавляет новый роут к серверу.

    Args:
        path (str): Путь для нового маршрута.
        module_name (str): Имя модуля, содержащего функцию обработчик.
        func_name (str): Имя функции обработчика.
        methods (List[str]): Список HTTP методов для маршрута. По умолчанию ["GET"].
    """
```
**Как работает функция**:
    - Функция проверяет, инициализирован ли экземпляр `FastApiServer`.
    - Если экземпляр существует, функция вызывает метод `add_new_route` для добавления нового маршрута с указанными параметрами.
    - В случае успеха, функция выводит сообщение об успешном добавлении маршрута. В случае ошибки, она логируется с использованием `logger.error`.
```python
    #Примеры:
    add_new_route("/new_route", "module", "function")
```

### `parse_port_range`

```python
def parse_port_range(range_str: str) -> List[int]:
    """
    Разбирает строку с диапазоном портов.

    Args:
        range_str (str): Строка с диапазоном портов (например, "8000-8005" или "8000").

    Returns:
        List[int]: Список портов.
    """
```
**Как работает функция**:
    - Функция принимает строку с диапазоном портов и пытается её разобрать.
    - Если строка содержит дефис (`-`), она разделяется на начало и конец диапазона. Функция преобразует начало и конец в целые числа и возвращает список всех портов в этом диапазоне.
    - Если строка не содержит дефис, функция пытается преобразовать её в целое число и возвращает список, содержащий только это число.
    - Если строка не соответствует ожидаемому формату или содержит недопустимые значения, функция выводит сообщение об ошибке и возвращает пустой список.
```python
    #Примеры:
    parse_port_range("8000-8005") #вернет [8000, 8001, 8002, 8003, 8004, 8005]
    parse_port_range("8000") #вернет [8000]
    parse_port_range("invalid") #вернет []
```

### `display_menu`

```python
def display_menu() -> None:
    """
    Выводит меню с доступными командами.
    """
```
**Как работает функция**:
    - Функция выводит в консоль список доступных команд для управления сервером. Каждая команда сопровождается кратким описанием её назначения.
```python
    #Примеры:
    display_menu()
```

### `main`

```python
def main() -> None:
    """
    Основная функция управления сервером.
    """
```
**Как работает функция**:
    - Функция инициализирует обработчик команд `CommandHandler`.
    - Запускает бесконечный цикл, в котором выводит меню доступных команд и ожидает ввода пользователя.
    - В зависимости от введенной команды, вызывает соответствующие методы обработчика команд для выполнения операций, таких как запуск, остановка и управление серверами.
    - Обрабатывает возможные ошибки и исключения, возникающие в процессе выполнения команд, и логирует их с использованием `logger.error`.
    - Позволяет пользователю выйти из программы с помощью команды `exit`.
```python
    #Примеры:
    main()