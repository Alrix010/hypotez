# Модуль для очистки и упрощения HTML-кода

## Обзор

Модуль `html_simplification` предназначен для минимизации HTML-кода, удаления нежелательных тегов и атрибутов, а также обработки специальных случаев, таких как скрипты, стили и комментарии. Он особенно полезен для очистки HTML-кода, полученного из внешних источников, перед его дальнейшей обработкой или отображением. Модуль использует библиотеку `BeautifulSoup` для парсинга HTML и класс `Config` для управления параметрами упрощения.

## Подробнее

Модуль предоставляет две основные функции:

- `strip_tags`: Полностью удаляет все HTML/XML теги из строки, оставляя только текст.
- `simplify_html`: Упрощает HTML-код, фокусируясь на содержимом тега `<body>` и используя параметры из объекта `Config`.

Класс `Config` позволяет настроить параметры упрощения HTML, такие как разрешенные теги и атрибуты, теги для разворачивания, удаление комментариев и скриптов, нормализация пробелов и удаление незначимых тегов.

## Классы

### `Config`

**Описание**: Конфигурация для функции `simplify_html`. Определяет, какие теги и атрибуты следует сохранить, какие теги следует развернуть, и какие элементы следует удалить.

**Атрибуты**:
- `allowed_tags` (Set[str]): Множество тегов в нижнем регистре, которые нужно оставить. По умолчанию: `{\'p\', \'b\', \'a\', \'br\', \'img\', \'h1\', \'hr\', \'div\', \'span\', \'table\', \'tbody\', \'tr\', \'td\', \'th\', \'ul\', \'ol\', \'li\', \'strong\', \'em\', \'i\', \'u\'}`.
- `allowed_attributes` (Dict[str, Set[str]]): Словарь, где ключи - имена тегов (в нижнем регистре), а значения - множества разрешенных атрибутов для этого тега. По умолчанию: `{\'a\': {\'href\', \'title\'}, \'img\': {\'src\', \'alt\', \'title\'}, \'*\': {\'style\'}}`.
- `unwrap_tags` (Set[str]): Множество тегов (в нижнем регистре), которые нужно "развернуть" (удалить тег, оставив содержимое) на финальном этапе, независимо от других правил. По умолчанию: `set()`.
- `VOID_TAGS` (Set[str]): Множество тегов, считающихся "пустыми" (void elements), используется при `keep_only_significant=True`. По умолчанию: `{\'area\', \'base\', \'br\', \'col\', \'embed\', \'hr\', \'img\', \'input\', \'link\', \'meta\', \'param\', \'source\', \'track\', \'wbr\'}`.
- `remove_comments` (bool): Удалять ли HTML-комментарии (`<!-- ... -->`). По умолчанию: `True`.
- `remove_scripts_styles` (bool): Удалять ли теги `<script>` и `<style>` вместе с их содержимым. По умолчанию: `True`.
- `normalize_whitespace` (bool): Заменять множественные пробелы на один и удалять пробелы в начале/конце. По умолчанию: `True`.
- `keep_only_significant` (bool): Удалять ли теги, не содержащие значимый контент. По умолчанию: `False`.
- `parser` (str): Парсер для BeautifulSoup (`'html.parser'`, `'lxml'`, `'html5lib'`). По умолчанию: `'html.parser'`.

**Принцип работы**:

Класс `Config` используется для хранения настроек, определяющих, как HTML-код будет упрощен функцией `simplify_html`. Он предоставляет гибкий способ настройки процесса очистки HTML, позволяя пользователю указывать, какие теги и атрибуты следует сохранить, какие теги следует удалить, и какие другие преобразования следует выполнить.

## Функции

### `strip_tags`

```python
def strip_tags(html_content: str | None, parser: Optional[str] = None) -> str:
    """
    Полностью удаляет все HTML/XML теги из строки, оставляя только текст.
    Также преобразует HTML-сущности (типа &) в соответствующие символы.
    Фокусируется на содержимом тега <body>, если он присутствует.

    Args:
        html_content (str | None): Строка с HTML-кодом или None.
        parser (Optional[str]): Парсер для BeautifulSoup ('html.parser', 'lxml', 'html5lib').
                                Если None, используется 'html.parser'.

    Returns:
        str: Текст без HTML-тегов. Возвращает пустую строку при ошибке, None или пустом вводе.

    Raises:
        Exception: BeautifulSoup может генерировать исключения при серьезных проблемах парсинга,
                   которые логируются.

    Example:
        >>> html_input = '<html><head><title>T</title></head><body><p>Hello <b>World</b>!</p><!-- comment --></body></html>'
        >>> strip_tags(html_input)
        'Hello World !'
        >>> strip_tags('Текст с <сущностями> & символами')
        'Текст с <сущностями> & символами'
        >>> strip_tags(None)
        ''
    """
```

**Назначение**: Функция `strip_tags` удаляет все HTML/XML теги из входной строки, оставляя только текст. Она также преобразует HTML-сущности (например, `&amp;`) в соответствующие символы.

**Параметры**:
- `html_content` (str | None): Строка, содержащая HTML-код, или `None`.
- `parser` (Optional[str]): Парсер для BeautifulSoup. Может быть `'html.parser'`, `'lxml'` или `'html5lib'`. Если не указан, используется `'html.parser'`.

**Возвращает**:
- `str`: Текст без HTML-тегов. Возвращает пустую строку, если входные данные некорректны, пусты или произошла ошибка при обработке.

**Вызывает исключения**:
- `Exception`: Возникает, если BeautifulSoup не может распарсить HTML-код.

**Как работает функция**:

1. Проверяет входные данные на корректность. Если `html_content` равен `None` или не является строкой, возвращает пустую строку.
2. Инициализирует объект `BeautifulSoup` с использованием указанного парсера или парсера по умолчанию (`'html.parser'`).
3. Ищет тег `<body>` в HTML-коде. Если тег `<body>` найден, функция обрабатывает только его содержимое. В противном случае обрабатывается весь документ.
4. Удаляет теги `<script>` и `<style>` и их содержимое из целевого узла.
5. Извлекает текст из целевого узла с помощью метода `get_text()`, разделяя элементы пробелами и удаляя начальные и конечные пробелы.
6. Преобразует HTML-сущности в соответствующие символы с помощью `html.unescape()`.
7. Заменяет множественные пробелы одним и удаляет пробелы в начале и конце строки с помощью регулярного выражения `re.sub(r'\s+', ' ', text).strip()`.
8. Возвращает очищенный текст.
9. В случае возникновения исключения при обработке HTML-кода, логирует ошибку и возвращает пустую строку.

**Примеры**:

```python
>>> html_input = '<html><head><title>T</title></head><body><p>Hello <b>World</b>!</p><!-- comment --></body></html>'
>>> strip_tags(html_input)
'Hello World !'
>>> strip_tags('Текст с <сущностями> & символами')
'Текст с <сущностями> & символами'
>>> strip_tags(None)
''
```

### `simplify_html`

```python
def simplify_html(
    html_content: str | None,
    config: Optional[Config] = None,
    parser: Optional[str] = None,
) -> str:
    """
    Упрощает HTML-код, фокусируясь на содержимом тега <body> и используя параметры
    из объекта Config (переданного или созданного по умолчанию).

    Удаляет все вне <body>, затем применяет правила упрощения (удаление тегов, атрибутов,
    комментариев, скриптов, стилей и т.д.) к содержимому <body> согласно настройкам
    в объекте `config`. Может также удалять теги-контейнеры внутри <body>,
    не содержащие значимого контента, если `config.keep_only_significant=True`.

    Args:
        html_content (str | None): Строка с HTML-кодом или None.
        config (Optional[Config]): Объект конфигурации. Если None, используется Config()
                                   с настройками по умолчанию.
        parser (Optional[str]): Парсер для BeautifulSoup ('html.parser', 'lxml', 'html5lib').
                                Если указан, переопределяет `config.parser`.

    Returns:
        str: Упрощенный HTML-код содержимого <body>. Возвращает пустую строку при ошибке,
             None/пустом вводе или если тег <body> не найден.

    Raises:
        Exception: BeautifulSoup может генерировать исключения при серьезных проблемах парсинга,
                   которые логируются.

    Example:
        >>> # Пример с удалением class/id по умолчанию
        >>> default_cfg = Config(allowed_tags={'div','span'})
        >>> sample_cls_id = '<body><div class="main" id="cont"><span style="color:red">Text</span></div></body>'
        >>> simplify_html(sample_cls_id, config=default_cfg)
        '<div><span style="color:red">Text</span></div>'

        >>> # Пример с явным разрешением class/id
        >>> allow_cls_id_cfg = Config(allowed_tags={'div','span'}, allowed_attributes={'*':{'class','id','style'}})
        >>> simplify_html(sample_cls_id, config=allow_cls_id_cfg)
        '<div class="main" id="cont"><span style="color:red">Text</span></div>'
    """
```

**Назначение**: Функция `simplify_html` упрощает HTML-код, фокусируясь на содержимом тега `<body>` и используя параметры из объекта `Config`.

**Параметры**:
- `html_content` (str | None): Строка, содержащая HTML-код, или `None`.
- `config` (Optional[Config]): Объект конфигурации, определяющий параметры упрощения. Если `None`, используется конфигурация по умолчанию.
- `parser` (Optional[str]): Парсер для BeautifulSoup. Может быть `'html.parser'`, `'lxml'` или `'html5lib'`. Если указан, переопределяет `config.parser`.

**Возвращает**:
- `str`: Упрощенный HTML-код содержимого `<body>`. Возвращает пустую строку, если входные данные некорректны, пусты, тег `<body>` не найден или произошла ошибка при обработке.

**Вызывает исключения**:
- `Exception`: Возникает, если BeautifulSoup не может распарсить HTML-код.

**Как работает функция**:

1.  Использует переданный `config` или создает новый объект `Config` с настройками по умолчанию.
2.  Выполняет проверку входных данных. Если `html_content` равен `None` или не является строкой, функция возвращает пустую строку.
3.  Определяет, какой парсер будет использоваться (`parser` или `config.parser`).
4.  Ищет тег `<body>` в HTML-коде. Если тег `<body>` найден, функция извлекает его содержимое. В противном случае, если есть контент, обрабатывается как фрагмент, иначе возвращается пустая строка.
5.  Создает новый объект `BeautifulSoup` из содержимого тега `<body>` или фрагмента.
6.  Если в конфигурации указано удалять комментарии, функция удаляет все HTML-комментарии.
7.  Если в конфигурации указано удалять скрипты и стили, функция удаляет все теги `<script>` и `<style>` и их содержимое.
8.  Если в конфигурации включено удаление незначимых контейнеров (`keep_only_significant=True`):
    *   Определяет, какие теги считаются значимыми (содержат текст или другие значимые элементы).
    *   Удаляет теги, которые не содержат значимого контента и не указаны в списке разрешенных тегов.
9.  Выполняет фильтрацию тегов и атрибутов:
    *   Разворачивает теги, указанные в `config.unwrap_tags`.
    *   Удаляет теги, не указанные в `config.allowed_tags`.
    *   Удаляет атрибуты тегов, не указанные в `config.allowed_attributes`.
10. Извлекает HTML-код из обработанного объекта `BeautifulSoup`.
11. Выполняет нормализацию пробелов, если это указано в конфигурации.
12. Возвращает упрощенный HTML-код.
13. В случае возникновения исключения при обработке HTML-кода, логирует ошибку и возвращает пустую строку.

**Примеры**:

```python
>>> # Пример с удалением class/id по умолчанию
>>> default_cfg = Config(allowed_tags={'div','span'})
>>> sample_cls_id = '<body><div class="main" id="cont"><span style="color:red">Text</span></div></body>'
>>> simplify_html(sample_cls_id, config=default_cfg)
'<div><span style="color:red">Text</span></div>'

>>> # Пример с явным разрешением class/id
>>> allow_cls_id_cfg = Config(allowed_tags={'div','span'}, allowed_attributes={'*':{'class','id','style'}})
>>> simplify_html(sample_cls_id, config=allow_cls_id_cfg)
'<div class="main" id="cont"><span style="color:red">Text</span></div>'
```