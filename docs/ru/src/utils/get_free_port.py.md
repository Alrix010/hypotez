# Модуль для поиска свободного порта

## Обзор

Модуль предоставляет функциональность для поиска свободного порта на указанном хосте. Он может искать порт в заданном диапазоне или найти первый доступный порт, если диапазон не указан.

## Подробней

Модуль `get_free_port` предназначен для использования в ситуациях, когда необходимо динамически выделить порт для сетевого сервиса или приложения. Он проверяет, занят ли порт, прежде чем вернуть его, чтобы избежать конфликтов. Модуль использует сокеты для проверки доступности порта и предоставляет возможность указать диапазон портов для поиска.

## Функции

### `get_free_port`

**Назначение**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

    Args:
        host (str): Адрес хоста для проверки доступных портов.
        port_range (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк.
               Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

    Returns:
        int: Доступный номер порта.

    Raises:
        ValueError: Если в указанном диапазоне не удается найти свободный порт или если диапазон портов недействителен.
    """
```

**Параметры**:

- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк. По умолчанию `None`.

**Возвращает**:

- `int`: Доступный номер порта.

**Вызывает исключения**:

- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Внутренние функции**:

#### `_is_port_in_use`

```python
        def _is_port_in_use(host: str, port: int) -> bool:
            """
            Проверяет, используется ли данный порт на указанном хосте.

            Args:
                host (str): Адрес хоста.
                port (int): Номер порта для проверки.

            Returns:
                bool: True, если порт используется, False в противном случае.
            """
```

**Назначение**: Проверяет, используется ли указанный порт на заданном хосте.

**Параметры**:

- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:

- `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:

Функция создает сокет и пытается привязать его к указанному хосту и порту. Если привязка удается, это означает, что порт свободен, и функция возвращает `False`. Если привязка вызывает исключение `OSError`, это означает, что порт занят, и функция возвращает `True`.

#### `_parse_port_range`

```python
        def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
            """
            Разбирает строку диапазона портов "min-max" в кортеж (min_port, max_port).

            Args:
                port_range_str (str): Строка диапазона портов.

            Returns:
                Tuple[int, int]: Кортеж, содержащий минимальный и максимальный номера портов.

            Raises:
                ValueError: Если формат строки диапазона портов недействителен.
            """
```

**Назначение**: Разбирает строку диапазона портов "min-max" в кортеж, содержащий минимальный и максимальный номера портов.

**Параметры**:

- `port_range_str` (str): Строка, представляющая диапазон портов в формате "min-max".

**Возвращает**:

- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:

- `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:

Функция разделяет входную строку `port_range_str` по символу `-`. Если результат разделения не содержит ровно два элемента, или если минимальный порт больше или равен максимальному, функция логирует ошибку и вызывает исключение `ValueError`. В противном случае функция преобразует оба элемента в целые числа и возвращает их в виде кортежа.

**Как работает функция `get_free_port`**:

1.  **Проверка наличия диапазона портов**: Функция проверяет, был ли предоставлен аргумент `port_range`.
2.  **Обработка строкового диапазона**: Если `port_range` является строкой, функция пытается разобрать ее с помощью `_parse_port_range`. Если разбор не удался, возникает исключение `ValueError`. Затем функция перебирает порты в указанном диапазоне и проверяет, свободен ли каждый порт с помощью `_is_port_in_use`. Если найден свободный порт, функция возвращает его. Если в диапазоне нет свободных портов, возникает исключение `ValueError`.
3.  **Обработка списка диапазонов**: Если `port_range` является списком, функция перебирает элементы списка. Каждый элемент должен быть строкой, представляющей диапазон портов. Функция пытается разобрать каждый элемент с помощью `_parse_port_range` и проверяет порты в диапазоне, как описано выше. Если в каком-либо из диапазонов найден свободный порт, функция возвращает его. Если ни в одном из диапазонов нет свободных портов, возникает исключение `ValueError`.
4.  **Обработка отсутствия диапазона**: Если `port_range` не предоставлен, функция начинает поиск с порта 1024 и увеличивает номер порта, пока не найдет свободный порт. Если номер порта превышает 65535, возникает исключение `ValueError`.

**Примеры**:

```python
    >>> get_free_port('localhost', '3000-3005')
    3001

    >>> get_free_port('localhost', ['3000-3005', '8000-8010'])
    3001

    >>> get_free_port('localhost')
    32768