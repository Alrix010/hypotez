# Модуль ToolBox_main
## Обзор

Модуль `ToolBox_main.py` представляет собой основной файл, управляющий Telegram-ботом `ToolBox`. 
Этот бот предоставляет пользователям функциональность для генерации текстов и изображений на основе различных тарифов и промокодов.
Модуль включает обработку команд, запросов обратного вызова, платежей и задач генерации контента. Он также управляет пользовательскими данными,
подписками и интеграцией с базой данных.

## Подробней

Этот модуль является сердцем Telegram-бота `ToolBox`, обеспечивая обработку всех входящих запросов и команд от пользователей.
Он инициализирует и конфигурирует бота, подключается к базе данных для хранения пользовательских данных,
обрабатывает платежи и предоставляет пользователям различные функции, такие как генерация текстов и изображений.
Модуль также управляет подписками пользователей, проверяет сроки действия тарифов и обрабатывает промокоды.
`ToolBox_main.py` тесно взаимодействует с другими модулями, такими как `ToolBox_requests.py` и `ToolBox_DataBase.py`,
чтобы обеспечить полную функциональность бота.

## Классы

В этом модуле нет явно определенных классов, но используются объекты классов `ToolBox` и `DataBase` из других модулей.

## Функции

### `process_pre_checkout_query`

```python
def process_pre_checkout_query(pre_checkout_query: types.PreCheckoutQuery) -> None:
    """
    Обрабатывает предварительный запрос на оплату от пользователя.

    Args:
        pre_checkout_query (types.PreCheckoutQuery): Объект запроса на предварительную оплату.

    Returns:
        None

    Как работает функция:
    - Функция принимает запрос на предварительную оплату.
    - Отвечает на запрос, подтверждая готовность к обработке оплаты.
    """
```

### `successful_payment`

```python
def successful_payment(message: types.Message) -> None:
    """
    Обрабатывает успешный платеж от пользователя, обновляя его подписку и токены.

    Args:
        message (types.Message): Объект сообщения об успешной оплате.

    Returns:
        None

    Как работает функция:
    - Функция принимает сообщение об успешной оплате.
    - Определяет тип оплаченного тарифа ("basic" или "pro").
    - Обновляет данные пользователя в базе данных, устанавливая соответствующие флаги подписки и начисляя токены.
    - Отправляет пользователю подтверждение об активации подписки.
    - Вызывает функцию перезапуска бота для обновления интерфейса пользователя.
    """
```

### `StartProcessing`

```python
def StartProcessing(message: types.Message) -> None:
    """
    Обрабатывает команду /start, инициализируя или обновляя данные пользователя в базе данных.

    Args:
        message (types.Message): Объект сообщения с командой /start.

    Returns:
        None

    Как работает функция:
    - Функция принимает сообщение с командой /start.
    - Проверяет, существуют ли данные пользователя в базе данных.
    - Если данные отсутствуют, создает новую запись с использованием шаблона `DATA_PATTERN`.
    - Если данные существуют, обновляет запись, сохраняя текущие значения подписки, токенов и других параметров.
    - Вызывает функцию для отправки начального запроса пользователю.
    """
```

### `personal_account`

```python
def personal_account(message: types.Message) -> None:
    """
    Обрабатывает команду /profile, отображая информацию о текущей подписке пользователя.

    Args:
        message (types.Message): Объект сообщения с командой /profile.

    Returns:
        None

    Как работает функция:
    - Функция принимает сообщение с командой /profile.
    - Извлекает данные пользователя из базы данных.
    - Формирует текстовое сообщение с информацией о текущей подписке пользователя (BASIC, PRO или отсутствие подписки).
    - Отправляет сообщение пользователю.
    """
```

### `show_stat`

```python
def show_stat(message: types.Message) -> None:
    """
    Обрабатывает команду /stat, отображая статистику использования бота (доступно только для администраторов).

    Args:
        message (types.Message): Объект сообщения с командой /stat.

    Returns:
        None

    Как работает функция:
    - Функция принимает сообщение с командой /stat.
    - Проверяет, является ли пользователь администратором (user_id в списке разрешенных).
    - Если пользователь является администратором, формирует текстовое сообщение со статистикой (общее количество пользователей и количество пользователей с промокодом).
    - Отправляет сообщение администратору.
    """
```

### `generate_promo_code`

```python
def generate_promo_code(length: int) -> str:
    """
    Генерирует случайный промокод заданной длины.

    Args:
        length (int): Длина промокода.

    Returns:
        str: Сгенерированный промокод.

    Как работает функция:
    - Функция принимает длину промокода.
    - Генерирует случайный промокод, состоящий из букв и цифр.
    - Возвращает сгенерированный промокод.
    """
```

### `CallsProcessing`

```python
def CallsProcessing(call: types.CallbackQuery) -> None:
    """
    Обрабатывает запросы обратного вызова от кнопок, отправленных ботом.

    Args:
        call (types.CallbackQuery): Объект запроса обратного вызова.

    Returns:
        None

    Как работает функция:
    - Функция принимает запрос обратного вызова.
    - Извлекает данные пользователя из базы данных.
    - Определяет, какая кнопка была нажата, и выполняет соответствующие действия.
    - Обрабатывает нажатия кнопок главного меню (текст, изображения, тариф, бесплатный режим).
    - Обрабатывает выбор размера изображения.
    - Обрабатывает выбор тарифа (BASIC, PRO, промокод).
    - Обрабатывает выбор текстовых категорий.
    - Обрабатывает кнопки выхода из различных меню.
    - Обновляет данные пользователя в базе данных.
    """
```

### `TokensCancelletionPattern`

```python
def TokensCancelletionPattern(user_id: str, func: callable, message: types.Message, i: Optional[int] = None) -> None:
    """
    Управляет использованием токенов или бесплатных запросов для генерации контента.

    Args:
        user_id (str): Идентификатор пользователя.
        func (callable): Функция для генерации контента.
        message (types.Message): Объект сообщения пользователя.
        i (Optional[int], optional): Индекс для текстовых команд. По умолчанию `None`.

    Returns:
        None

    Как работает функция:
    - Функция принимает идентификатор пользователя, функцию для генерации контента и сообщение пользователя.
    - Проверяет, есть ли у пользователя доступные токены или бесплатные запросы.
    - Если токены или запросы есть, вызывает функцию для генерации контента и списывает токены или запросы.
    - Если токены или запросы закончились, отправляет пользователю сообщение о необходимости приобрести тариф.
    """
```

### `TasksProcessing`

```python
def TasksProcessing(message: types.Message) -> None:
    """
    Обрабатывает сообщения пользователя, запуская задачи генерации текста или изображений.

    Args:
        message (types.Message): Объект сообщения пользователя.

    Returns:
        None

    Как работает функция:
    - Функция принимает сообщение пользователя.
    - Извлекает данные пользователя из базы данных.
    - Если пользователь запросил генерацию изображения, запускает процесс генерации изображения.
    - Если пользователь находится в бесплатном режиме, запускает процесс генерации текста в бесплатном режиме.
    - Если пользователь выбрал текстовую категорию, запускает процесс генерации текста в выбранной категории.
    - Обновляет данные пользователя в базе данных.
    """
```

### `end_check_tariff_time`

```python
async def end_check_tariff_time() -> None:
    """
    Асинхронно проверяет срок действия подписки пользователей и сбрасывает их тариф при необходимости.

    Returns:
        None

    Как работает функция:
    - Функция запускается в бесконечном цикле.
    - Для каждого пользователя в базе данных проверяет, истек ли срок действия его подписки.
    - Если срок действия подписки истек, сбрасывает тариф пользователя до бесплатного.
    - Засыпает на 10 секунд.
    """
```

## Параметры класса

- `N` (int): Количество типов текста.
- `DATA_PATTERN` (lambda): Лямбда-функция для инициализации пользовательских данных.
- `photo_array` (list): Пустой массив для хранения фотографий (используется в коде, но не описан в предоставленной документации).
- `tb` (ToolBox): Объект класса `ToolBox` для работы с запросами к боту.
- `bot` (telebot.TeleBot): Объект класса `TeleBot` для управления Telegram-ботом.
- `base` (DataBase): Объект класса `DataBase` для работы с базой данных пользователей.
- `db` (dict): Словарь, содержащий данные всех пользователей.

## Примеры

### Обработка команды /start

```python
@bot.message_handler(commands=['start'])
def StartProcessing(message):
    global db
    user_id = str(message.chat.id)
    db[user_id] = DATA_PATTERN() if not db.get(user_id, False) else DATA_PATTERN(basic=db[user_id]['basic'], pro=db[user_id]['pro'], incoming_tokens=db[user_id]['incoming_tokens'],
                                                                                outgoing_tokens=db[user_id]['outgoing_tokens'], free_requests=db[user_id]['free_requests'], datetime_sub=db[user_id]['datetime_sub'],
                                                                                promocode=db[user_id]['promocode'], ref=db[user_id]['ref']
                                                                                )
    base.insert_or_update_data(user_id, db[user_id])
    tb.start_request(message)
```

### Обработка успешного платежа

```python
@bot.message_handler(content_types=['successful_payment'])
def successful_payment(message):
    global db
    user_id = str(message.chat.id)
    if message.successful_payment.invoice_payload == 'basic_invoice_payload':
        db[user_id]['basic'] = True
    elif message.successful_payment.invoice_payload == 'pro_invoice_payload':
        db[user_id]['pro'] = True
        db[user_id]['basic'] = True

    db[user_id]['incoming_tokens'] = 1.7*10**5
    db[user_id]['outgoing_tokens'] = 5*10**5

    db[user_id]['datetime_sub'] = datetime.now().replace(microsecond=0)+relativedelta(months=1)
    base.insert_or_update_data(user_id, db[user_id])
    bot.send_message(user_id, "Спасибо за оплату! Ваша подписка активирована.")
    tb.restart(message)