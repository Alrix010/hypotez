# Документация модуля ToolBox_requests.py

## Обзор

Модуль `ToolBox_requests.py` содержит класс `ToolBox`, который предназначен для обработки запросов от Telegram-бота. Класс включает в себя функциональность для работы с текстом, изображениями, тарифами, а также для взаимодействия с нейронными сетями.

## Подробней

Модуль является частью проекта `hypotez` и предназначен для обработки логики взаимодействия с пользователем через Telegram-бота. Он содержит методы для обработки различных типов запросов, таких как генерация текста, обработка изображений, отображение тарифных планов и взаимодействие со сторонними сервисами, такими как нейронные сети.

## Классы

### `ToolBox`

**Описание**: Класс `ToolBox` является основным классом для обработки запросов от Telegram-бота. Он наследует функциональность от классов `keyboards` и `neural_networks`.

**Наследует**:
- `keyboards`: Предоставляет методы для создания различных типов клавиатур для Telegram-бота.
- `neural_networks`: Предоставляет методы для взаимодействия с нейронными сетями.

**Атрибуты**:
- `name` (list): Список названий кнопок главного меню.
- `data` (list): Список данных, связанных с кнопками главного меню.
- `prompts_text` (dict): Словарь, содержащий текстовые подсказки и сообщения для бота, загруженные из файла `prompts.json`.
- `bot` (telebot.TeleBot): Экземпляр Telegram-бота.
- `keyboard_blank` (лямбда-функция): Лямбда-функция для создания встроенных клавиатур.
- `reply_keyboard` (лямбда-функция): Лямбда-функция для создания клавиатур разметки.
- `__delay` (лямбда-функция): Лямбда-функция для отправки сообщения о задержке.
- `start_request` (лямбда-функция): Лямбда-функция для отправки стартового сообщения.
- `restart` (лямбда-функция): Лямбда-функция для отправки сообщения о перезапуске.
- `restart_markup` (лямбда-функция): Лямбда-функция для редактирования сообщения о перезапуске.
- `OneTextArea` (лямбда-функция): Лямбда-функция для отправки текстового запроса.
- `SomeTextsArea` (лямбда-функция): Лямбда-функция для отправки запроса на несколько текстов.
- `ImageSize` (лямбда-функция): Лямбда-функция для выбора размера изображения.
- `ImageArea` (лямбда-функция): Лямбда-функция для отправки запроса на изображение.
- `ImageChange` (лямбда-функция): Лямбда-функция для отправки сообщения о изменении изображения.
- `BeforeUpscale` (лямбда-функция): Лямбда-функция для отправки сообщения перед улучшением качества изображения.
- `FreeArea` (лямбда-функция): Лямбда-функция для отправки запроса в свободном режиме.
- `TariffArea` (лямбда-функция): Лямбда-функция для отображения информации о тарифах.
- `TariffExit` (лямбда-функция): Лямбда-функция для выхода из раздела тарифов.
- `TarrifEnd` (лямбда-функция): Лямбда-функция для отправки сообщения об окончании тарифа.
- `FreeTariffEnd` (лямбда-функция): Лямбда-функция для отправки сообщения об окончании бесплатного тарифа.
- `SomeTexts` (лямбда-функция): Лямбда-функция для выбора одного или нескольких текстов.

**Принцип работы**:
Класс `ToolBox` инициализирует Telegram-бота, загружает текстовые подсказки и сообщения из файла `prompts.json`, а также определяет набор лямбда-функций для обработки различных типов запросов от пользователя. Класс использует функциональность, предоставляемую классами `keyboards` и `neural_networks`, для создания клавиатур и взаимодействия с нейронными сетями.

## Методы класса

### `__init__`

```python
def __init__(self):
```

**Назначение**: Инициализация класса `ToolBox`.

**Параметры**:
- Нет

**Возвращает**:
- Нет

**Как работает функция**:
- Инициализирует атрибуты класса, такие как названия и данные для кнопок главного меню.
- Загружает текстовые подсказки и сообщения из файла `prompts.json`.
- Инициализирует Telegram-бота с использованием токена из переменной окружения `TOKEN`.
- Определяет лямбда-функции для создания различных типов клавиатур и обработки запросов.

**Примеры**:
```python
toolbox = ToolBox()
```

### `__gpt_4o_mini`

```python
def __gpt_4o_mini(self, prompt: list[dict], message) -> tuple[dict[str, str], int, int]:
```

**Назначение**: Обработка запроса с использованием GPT-4o mini.

**Параметры**:
- `prompt` (list[dict]): Список словарей, содержащих запрос для GPT-4o mini.
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `tuple[dict[str, str], int, int]`: Кортеж, содержащий ответ от GPT-4o mini, количество входящих и исходящих токенов.

**Как работает функция**:
- Отправляет сообщение о задержке пользователю.
- Вызывает метод `_free_gpt_4o_mini` класса `neural_networks` для получения ответа от GPT-4o mini.
- Редактирует сообщение о задержке, заменяя его ответом от GPT-4o mini.
- Возвращает ответ, количество входящих и исходящих токенов.

**Примеры**:
```python
prompt = [{"role": "user", "content": "Напиши короткий рассказ"}]
message = ...  # Объект сообщения от Telegram
response, incoming_tokens, outgoing_tokens = self.__gpt_4o_mini(prompt, message)
```

### `__FLUX_schnell`

```python
def __FLUX_schnell(self, prompt: str, size: list[int], message, seed: int, num_inference_steps: int)-> None:
```

**Назначение**: Обработка запроса на генерацию изображения с использованием FLUX schnell.

**Параметры**:
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.
- `message`: Объект сообщения от Telegram.
- `seed` (int): Зерно для генерации случайных чисел.
- `num_inference_steps` (int): Количество шагов для генерации изображения.

**Возвращает**:
- `None`

**Как работает функция**:
- Отправляет сообщение о задержке пользователю.
- Вызывает метод `_FLUX_schnell` класса `neural_networks` для генерации изображения.
- Отправляет сгенерированное изображение пользователю.
- Удаляет сообщение о задержке.

**Примеры**:
```python
prompt = "Собака в космосе"
size = [1024, 1024]
message = ...  # Объект сообщения от Telegram
seed = 12345
self.__FLUX_schnell(prompt, size, message, seed, num_inference_steps=4)
```

### `Text_types`

```python
def Text_types(self, message):
```

**Назначение**: Отображение типов текстов для выбора.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- Изменяет текст сообщения с вариантами выбора типов текстов.

**Как работает функция**:
- Определяет названия и данные для кнопок с типами текстов.
- Редактирует сообщение, отображая кнопки с типами текстов.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
self.Text_types(message)
```

### `Basic_tariff`

```python
def Basic_tariff(self, message):
```

**Назначение**: Отображение информации о базовом тарифе.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- Отправляет счет на оплату базового тарифа.

**Как работает функция**:
- Создает клавиатуру с кнопками "Подключить тариф BASIC" и "К тарифам".
- Создает счет на оплату базового тарифа.
- Отправляет счет пользователю.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
self.Basic_tariff(message)
```

### `Pro_tariff`

```python
def Pro_tariff(self, message):
```

**Назначение**: Отображение информации о профессиональном тарифе.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- Отправляет счет на оплату профессионального тарифа.

**Как работает функция**:
- Создает клавиатуру с кнопками "Подключить тариф PRO" и "К тарифам".
- Создает счет на оплату профессионального тарифа.
- Отправляет счет пользователю.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
self.Pro_tariff(message)
```

### `TextCommands`

```python
def TextCommands(self, message, ind: int):
```

**Назначение**: Обработка текстовых команд.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `ind` (int): Индекс команды.

**Возвращает**:
- `tuple[int, int, 1]`: Кортеж, содержащий количество входящих и исходящих токенов, а также константу 1.

**Как работает функция**:
- Извлекает информацию из сообщения пользователя.
- Формирует запрос для GPT-4o mini.
- Вызывает метод `__gpt_4o_mini` для получения ответа от GPT-4o mini.
- Перезапускает бота.
- Возвращает количество входящих и исходящих токенов.

**Внутренние функции**:

#### `Text_next_step`

```python
def Text_next_step(message):
```

**Назначение**: Обработка следующего шага текстовой команды.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
- Добавляет информацию из сообщения пользователя в список `info`.
- Формирует запрос для GPT-4o mini.
- Вызывает метод `__gpt_4o_mini` для получения ответа от GPT-4o mini.
- Перезапускает бота.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
ind = 0
incoming_tokens, outgoing_tokens, _ = self.TextCommands(message, ind)
```

### `SomeTextsCommand`

```python
def SomeTextsCommand(self, message, ind: int, tokens: dict[str, int]):
```

**Назначение**: Обработка команд для нескольких текстов.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `ind` (int): Индекс команды.
- `tokens` (dict[str, int]): Словарь, содержащий информацию о доступных токенах.

**Возвращает**:
- `tuple[int, int, n]`: Кортеж, содержащий количество входящих и исходящих токенов, а также количество обработанных текстов.

**Как работает функция**:
- Запрашивает у пользователя количество текстов для обработки.
- Запрашивает текст источника для каждого текста.
- Запрашивает параметры для каждого текста.
- Формирует запрос для GPT-4o mini для каждого текста.
- Вызывает метод `__gpt_4o_mini` для получения ответа от GPT-4o mini для каждого текста.
- Перезапускает бота.
- Возвращает количество входящих и исходящих токенов.

**Внутренние функции**:

#### `Text_next_step`

```python
def Text_next_step(message):
```

**Назначение**: Обработка следующего шага для текста.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
- Сохраняет текст сообщения.

#### `Params_addition`

```python
def Params_addition(message):
```

**Назначение**: Добавление параметров.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
- Разделяет параметры из сообщения.

#### `process_prompt`

```python
def process_prompt(i):
```

**Назначение**: Обработка подсказок.

**Параметры**:
- `i`: Индекс.

**Возвращает**:
- `in_tokens, out_tokens`

**Как работает функция**:
- Формирует подсказку.
- Проверяет токены.
- Возвращает входящие и исходящие токены.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
ind = 0
tokens = {"incoming_tokens": 1000, "outgoing_tokens": 1000, "free_requests": 10}
incoming_tokens, outgoing_tokens, n = self.SomeTextsCommand(message, ind, tokens)
```

### `ImageCommand`

```python
def ImageCommand(self, message, prompt: str, size: list[int]):
```

**Назначение**: Обработка команды для генерации изображения.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.

**Возвращает**:
- `seed`: Зерно для генерации случайных чисел.

**Как работает функция**:
- Генерирует случайное зерно.
- Вызывает метод `__FLUX_schnell` для генерации изображения.
- Вызывает метод `ImageChange` для отображения сообщения о изменении изображения.
- Возвращает зерно.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
prompt = "Собака в космосе"
size = [1024, 1024]
seed = self.ImageCommand(message, prompt, size)
```

### `Image_Regen_And_Upscale`

```python
def Image_Regen_And_Upscale(self, message, prompt: str, size: list[int], seed, num_inference_steps=4):
```

**Назначение**: Обработка команды для регенерации и улучшения качества изображения.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.
- `seed` (int): Зерно для генерации случайных чисел.
- `num_inference_steps` (int): Количество шагов для генерации изображения.

**Возвращает**:
- Результат вызова `self.__FLUX_schnell`

**Как работает функция**:
- Вызывает метод `__FLUX_schnell` для регенерации и улучшения качества изображения.
- Возвращает результат вызова `self.__FLUX_schnell`

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
prompt = "Собака в космосе"
size = [1024, 1024]
seed = 12345
self.Image_Regen_And_Upscale(message, prompt, size, seed)
```

### `FreeCommand`

```python
def FreeCommand(self, message, prompts: list[str]):
```

**Назначение**: Обработка команды в свободном режиме.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompts` (list[str]): Список запросов.

**Возвращает**:
- `tuple[incoming_tokens, outgoing_tokens, prompts]`

**Как работает функция**:
- Добавляет запрос пользователя в список запросов.
- Вызывает метод `__gpt_4o_mini` для получения ответа от GPT-4o mini.
- Добавляет ответ от GPT-4o mini в список запросов.
- Возвращает входящие и исходящие токены, а также список запросов.

**Примеры**:
```python
message = ...  # Объект сообщения от Telegram
prompts = []
incoming_tokens, outgoing_tokens, prompts = self.FreeCommand(message, prompts)
```

## Параметры класса

- `name` (list): Список названий кнопок главного меню.
- `data` (list): Список данных, связанных с кнопками главного меню.
- `prompts_text` (dict): Словарь, содержащий текстовые подсказки и сообщения для бота.
- `bot` (telebot.TeleBot): Экземпляр Telegram-бота.
- `keyboard_blank` (лямбда-функция): Лямбда-функция для создания встроенных клавиатур.
- `reply_keyboard` (лямбда-функция): Лямбда-функция для создания клавиатур разметки.
- `__delay` (лямбда-функция): Лямбда-функция для отправки сообщения о задержке.
- `start_request` (лямбда-функция): Лямбда-функция для отправки стартового сообщения.
- `restart` (лямбда-функция): Лямбда-функция для отправки сообщения о перезапуске.
- `restart_markup` (лямбда-функция): Лямбда-функция для редактирования сообщения о перезапуске.
- `OneTextArea` (лямбда-функция): Лямбда-функция для отправки текстового запроса.
- `SomeTextsArea` (лямбда-функция): Лямбда-функция для отправки запроса на несколько текстов.
- `ImageSize` (лямбда-функция): Лямбда-функция для выбора размера изображения.
- `ImageArea` (лямбда-функция): Лямбда-функция для отправки запроса на изображение.
- `ImageChange` (лямбда-функция): Лямбда-функция для отправки сообщения о изменении изображения.
- `BeforeUpscale` (лямбда-функция): Лямбда-функция для отправки сообщения перед улучшением качества изображения.
- `FreeArea` (лямбда-функция): Лямбда-функция для отправки запроса в свободном режиме.
- `TariffArea` (лямбда-функция): Лямбда-функция для отображения информации о тарифах.
- `TariffExit` (лямбда-функция): Лямбда-функция для выхода из раздела тарифов.
- `TarrifEnd` (лямбда-функция): Лямбда-функция для отправки сообщения об окончании тарифа.
- `FreeTariffEnd` (лямбда-функция): Лямбда-функция для отправки сообщения об окончании бесплатного тарифа.
- `SomeTexts` (лямбда-функция): Лямбда-функция для выбора одного или нескольких текстов.

## Примеры

Примеры использования класса и его методов можно найти в описании каждого метода.