# Модуль для миграции базы данных: добавление колонки `pay_id`

## Обзор

Модуль содержит скрипт миграции Alembic, который добавляет колонку `payment_id` в таблицу `purchases`, если она еще не существует, а также удаляет ее, если это необходимо при откате миграции.

## Подробнее

Этот скрипт предназначен для управления изменениями схемы базы данных в проекте `hypotez`. Он использует Alembic для определения операций обновления (`upgrade`) и отката (`downgrade`) схемы. В частности, данный скрипт добавляет колонку `payment_id` в таблицу `purchases` и создает уникальный индекс для этой колонки. Если колонка уже существует, скрипт пропускает операцию добавления. При откате миграции скрипт удаляет уникальный индекс и саму колонку, если они существуют.

## Переменные модуля

- `revision` (str): Идентификатор текущей ревизии миграции.
- `down_revision` (Union[str, None]): Идентификатор предыдущей ревизии миграции.
- `branch_labels` (Union[str, Sequence[str], None]): Метки ветвей, используемые Alembic.
- `depends_on` (Union[str, Sequence[str], None]): Зависимости от других миграций.

## Функции

### `upgrade`

**Назначение**: Обновляет схему базы данных, добавляя колонку `payment_id` в таблицу `purchases`, если она еще не существует.

**Параметры**:
- Нет

**Возвращает**:
- `None`

**Как работает функция**:

1.  Получает соединение с базой данных, используя `op.get_bind()`.
2.  Проверяет, существует ли колонка `payment_id` в таблице `purchases` с помощью запроса `PRAGMA table_info('purchases')`.
3.  Если колонка не существует, добавляет её с помощью `op.add_column('purchases', sa.Column('payment_id', sa.String(), nullable=False))` и создает уникальный индекс `op.create_unique_constraint('uq_purchases_payment_id', 'purchases', ['payment_id'])`.
4.  Если колонка уже существует, выводит сообщение в консоль: `"Колонка \'payment_id\' уже существует, пропускаем добавление"`.

**Примеры**:

```python
# Пример вызова функции upgrade (обычно вызывается Alembic)
upgrade()
```

### `downgrade`

**Назначение**: Откатывает изменения, внесенные функцией `upgrade`, удаляя колонку `payment_id` из таблицы `purchases`, если она существует.

**Параметры**:
- Нет

**Возвращает**:
- `None`

**Как работает функция**:

1.  Получает соединение с базой данных, используя `op.get_bind()`.
2.  Проверяет, существует ли колонка `payment_id` в таблице `purchases` с помощью запроса `sa.text("PRAGMA table_info(\'purchases\')")`.
3.  Если колонка существует, удаляет уникальный индекс `op.drop_constraint('uq_purchases_payment_id', 'purchases', type_='unique')` и саму колонку `op.drop_column('purchases', 'payment_id')`.
4.  Если колонка не существует, выводит сообщение в консоль: `"Колонка \'payment_id\' не существует, пропускаем удаление"`.

**Примеры**:

```python
# Пример вызова функции downgrade (обычно вызывается Alembic)
downgrade()