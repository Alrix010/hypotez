# Модуль для работы с middleware базой данных для Telegram бота
=================================================================

Модуль содержит классы middleware для управления сессиями базы данных в Telegram боте.
Он включает в себя базовый класс `BaseDatabaseMiddleware` и два подкласса: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`, которые определяют стратегии работы с сессиями базы данных.

## Обзор

Этот модуль предоставляет middleware для управления сессиями базы данных в Telegram боте. Он обеспечивает создание, использование и закрытие сессий, а также обработку исключений и коммиты транзакций.

## Подробней

Модуль предназначен для упрощения работы с базой данных в обработчиках Telegram бота. Он автоматически создает сессию базы данных перед вызовом обработчика, передает её в обработчик через словарь `data`, и закрывает сессию после завершения работы обработчика. Также он обеспечивает автоматический откат транзакции в случае возникновения исключения.

## Классы

### `BaseDatabaseMiddleware`

**Описание**: Базовый класс middleware для работы с базой данных.

**Методы**:
- `__call__`: Асинхронный метод, вызываемый при обработке события.
- `set_session`: Метод для установки сессии в словарь данных.
- `after_handler`: Метод для выполнения действий после вызова хендлера.

**Принцип работы**:

Класс `BaseDatabaseMiddleware` является базовым классом для всех middleware, работающих с базой данных. Он определяет структуру работы с сессиями базы данных, включая создание сессии, передачу её в обработчик, обработку исключений и закрытие сессии.

- `__call__`: Этот метод является точкой входа для middleware. Он создает асинхронную сессию базы данных с использованием `async_session_maker`. Затем он вызывает метод `set_session` для установки сессии в словарь данных `data`, который передается в обработчик. После этого он вызывает обработчик `handler` и, в случае успеха, вызывает метод `after_handler` для выполнения дополнительных действий (например, коммита транзакции). В случае возникновения исключения, он выполняет откат транзакции. В блоке `finally` сессия закрывается.
- `set_session`: Этот метод предназначен для установки сессии в словарь данных. Он должен быть реализован в подклассах.
- `after_handler`: Этот метод предназначен для выполнения действий после вызова обработчика. Он может быть переопределен в подклассах для выполнения дополнительных действий (например, коммита транзакции).

### `DatabaseMiddlewareWithoutCommit`

**Описание**: Middleware для работы с базой данных без автоматического коммита транзакции.

**Методы**:
- `set_session`: Метод для установки сессии в словарь данных.

**Принцип работы**:

Класс `DatabaseMiddlewareWithoutCommit` является подклассом `BaseDatabaseMiddleware` и реализует стратегию работы с базой данных без автоматического коммита транзакции. Сессия базы данных сохраняется в словаре `data` под ключом `'session_without_commit'`.

- `set_session`: Этот метод устанавливает сессию в словарь данных под ключом `'session_without_commit'`.

### `DatabaseMiddlewareWithCommit`

**Описание**: Middleware для работы с базой данных с автоматическим коммитом транзакции.

**Методы**:
- `set_session`: Метод для установки сессии в словарь данных.
- `after_handler`: Метод для выполнения действий после вызова хендлера.

**Принцип работы**:

Класс `DatabaseMiddlewareWithCommit` является подклассом `BaseDatabaseMiddleware` и реализует стратегию работы с базой данных с автоматическим коммитом транзакции. Сессия базы данных сохраняется в словаре `data` под ключом `'session_with_commit'`, и после вызова обработчика выполняется коммит транзакции.

- `set_session`: Этот метод устанавливает сессию в словарь данных под ключом `'session_with_commit'`.
- `after_handler`: Этот метод выполняет коммит транзакции после вызова обработчика.

## Методы класса

### `BaseDatabaseMiddleware`

#### `__call__`

```python
async def __call__(
    self,
    handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
    event: Message | CallbackQuery,
    data: Dict[str, Any]
) -> Any:
    """
    Асинхронный метод, вызываемый при обработке события.

    Args:
        handler (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Обработчик события.
        event (Message | CallbackQuery): Событие (сообщение или callback-запрос).
        data (Dict[str, Any]): Словарь данных.

    Returns:
        Any: Результат работы обработчика.
    """
    ...
```

**Назначение**: Обеспечивает создание сессии базы данных, передачу её в обработчик, обработку исключений и закрытие сессии.

**Параметры**:
- `handler` (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Обработчик события.
- `event` (Message | CallbackQuery): Событие (сообщение или callback-запрос).
- `data` (Dict[str, Any]): Словарь данных.

**Возвращает**:
- `Any`: Результат работы обработчика.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при обработке события.

**Как работает функция**:

1. Создает асинхронную сессию базы данных с использованием `async_session_maker`.
2. Вызывает метод `set_session` для установки сессии в словарь данных `data`.
3. Вызывает обработчик `handler`.
4. В случае успеха, вызывает метод `after_handler` для выполнения дополнительных действий (например, коммита транзакции).
5. В случае возникновения исключения, выполняет откат транзакции.
6. В блоке `finally` сессия закрывается.

#### `set_session`

```python
def set_session(self, data: Dict[str, Any], session) -> None:
    """Метод для установки сессии в словарь данных."""
    ...
```

**Назначение**: Устанавливает сессию базы данных в словарь данных.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `NotImplementedError`: Если метод не реализован в подклассе.

**Как работает функция**:

Этот метод предназначен для установки сессии в словарь данных. Он должен быть реализован в подклассах.

#### `after_handler`

```python
async def after_handler(self, session) -> None:
    """Метод для выполнения действий после вызова хендлера (например, коммит)."""
    ...
```

**Назначение**: Выполняет действия после вызова обработчика.

**Параметры**:
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Как работает функция**:

Этот метод предназначен для выполнения действий после вызова обработчика. Он может быть переопределен в подклассах для выполнения дополнительных действий (например, коммита транзакции). По умолчанию ничего не делает.

### `DatabaseMiddlewareWithoutCommit`

#### `set_session`

```python
def set_session(self, data: Dict[str, Any], session) -> None:
    """Метод для установки сессии в словарь данных."""
    ...
```

**Назначение**: Устанавливает сессию базы данных в словарь данных под ключом `'session_without_commit'`.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Как работает функция**:

Этот метод устанавливает сессию в словарь данных под ключом `'session_without_commit'`.

### `DatabaseMiddlewareWithCommit`

#### `set_session`

```python
def set_session(self, data: Dict[str, Any], session) -> None:
    """Метод для установки сессии в словарь данных."""
    ...
```

**Назначение**: Устанавливает сессию базы данных в словарь данных под ключом `'session_with_commit'`.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Как работает функция**:

Этот метод устанавливает сессию в словарь данных под ключом `'session_with_commit'`.

#### `after_handler`

```python
async def after_handler(self, session) -> None:
    """Метод для выполнения действий после вызова хендлера (например, коммит)."""
    ...
```

**Назначение**: Выполняет коммит транзакции после вызова обработчика.

**Параметры**:
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Как работает функция**:

Этот метод выполняет коммит транзакции после вызова обработчика.

## Примеры

### Использование `DatabaseMiddlewareWithoutCommit`

```python
from aiogram import Dispatcher

# Создание экземпляра Dispatcher
dp = Dispatcher()

# Регистрация middleware
dp.message.middleware(DatabaseMiddlewareWithoutCommit())
```

### Использование `DatabaseMiddlewareWithCommit`

```python
from aiogram import Dispatcher

# Создание экземпляра Dispatcher
dp = Dispatcher()

# Регистрация middleware
dp.message.middleware(DatabaseMiddlewareWithCommit())
```