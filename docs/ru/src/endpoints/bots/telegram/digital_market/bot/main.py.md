# Модуль `main.py` для Telegram-бота Digital Market
## Обзор

Модуль является точкой входа для Telegram-бота Digital Market. Он отвечает за настройку и запуск веб-приложения, обработку входящих запросов через вебхуки, регистрацию промежуточного программного обеспечения (middleware) и маршрутизаторов (routers), а также за установку команд бота по умолчанию.

## Подробней

Этот модуль координирует работу различных компонентов бота, таких как обработка платежей через Robokassa, взаимодействие с базой данных и обработка команд пользователей. Он также обеспечивает запуск и остановку бота с отправкой уведомлений администраторам.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
    ...
```

**Назначение**: Устанавливает список команд, доступных пользователям бота по умолчанию (например, команда `/start`).

**Как работает функция**:
- Определяет список команд бота, используя класс `BotCommand` из библиотеки `aiogram`.
- Использует метод `set_my_commands` объекта `bot` для установки этих команд.
- Команды устанавливаются для всех пользователей (`BotCommandScopeDefault`).

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
    ...
```

**Назначение**: Выполняет действия при запуске приложения, такие как установка команд по умолчанию, установка вебхука и отправка уведомлений администраторам.

**Параметры**:
- `app`: Объект приложения `aiohttp`.

**Как работает функция**:
1. Вызывает функцию `set_default_commands` для установки команд бота по умолчанию.
2. Устанавливает вебхук для бота, используя URL, полученный из настроек (`settings.get_webhook_url`).
3. Отправляет уведомления администраторам о запуске бота. Если отправка сообщения не удалась, фиксирует ошибку в лог.
4. Логирует информацию об успешном запуске бота.

**Примеры**:
```python
# Пример использования (внутри aiohttp app)
async def some_function(app):
    await on_startup(app)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
    ...
```

**Назначение**: Выполняет действия при остановке приложения, такие как отправка уведомлений администраторам, удаление вебхука и закрытие сессии бота.

**Параметры**:
- `app`: Объект приложения `aiohttp`.

**Как работает функция**:
1. Отправляет уведомления администраторам об остановке бота. Если отправка сообщения не удалась, фиксирует ошибку в лог.
2. Удаляет вебхук бота, чтобы бот перестал получать обновления. Параметр `drop_pending_updates=True` отбрасывает все ожидающие обновления.
3. Закрывает сессию бота, чтобы освободить ресурсы.
4. Логирует информацию об остановке бота.

**Примеры**:
```python
# Пример использования (внутри aiohttp app)
async def some_function(app):
    await on_shutdown(app)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует промежуточное программное обеспечение (middleware) для обработки входящих обновлений.

**Как работает функция**:
- Регистрирует `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` для диспетчера `dp`. Эти middleware, вероятно, управляют сессиями базы данных, обеспечивая их открытие и закрытие без и с фиксацией изменений соответственно.

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует маршрутизаторы (routers) для обработки различных типов входящих запросов.

**Как работает функция**:
- Подключает маршрутизаторы `catalog_router`, `user_router` и `admin_router` к диспетчеру `dp`. Каждый из этих маршрутизаторов, вероятно, обрабатывает определенные типы команд или запросов, связанные с каталогом товаров, пользователями и административными функциями.

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
    ...
```

**Назначение**: Создает и настраивает веб-приложение `aiohttp`, включая регистрацию обработчиков маршрутов, настройку приложения с диспетчером и ботом, а также регистрацию функций запуска и остановки.

**Как работает функция**:
1. Создает экземпляр веб-приложения `aiohttp`.
2. Регистрирует обработчики маршрутов для различных конечных точек:
   - `f"/{settings.BOT_TOKEN}"`: Обработчик вебхука (`handle_webhook`).
   - `"/robokassa/result/"`: Обработчик результата Robokassa (`robokassa_result`).
   - `"/robokassa/fail/"`: Обработчик неудачи Robokassa (`robokassa_fail`).
   - `"/"`: Обработчик главной страницы (`home_page`).
3. Настраивает приложение с диспетчером и ботом, используя функцию `setup_application` из библиотеки `aiogram`.
4. Регистрирует функции `on_startup` и `on_shutdown` для выполнения при запуске и остановке приложения соответственно.

**Примеры**:
```python
# Пример использования
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
    ...
```

**Назначение**: Главная функция, которая запускает приложение.

**Как работает функция**:
1. Регистрирует промежуточное программное обеспечение и маршрутизаторы, вызывая функции `register_middlewares` и `register_routers` соответственно.
2. Создает приложение, вызывая функцию `create_app`.
3. Запускает веб-приложение, используя функцию `web.run_app`, с указанием хоста и порта из настроек (`settings.SITE_HOST` и `settings.SITE_PORT`).

**Примеры**:
```python
# Пример использования
if __name__ == "__main__":
    main()
```