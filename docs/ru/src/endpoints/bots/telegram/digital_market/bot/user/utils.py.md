# Модуль с утилитами для обработки успешных платежей в Telegram боте

## Обзор

Модуль содержит функцию `successful_payment_logic`, которая обрабатывает логику после успешной оплаты товара пользователем через Telegram бота. Включает в себя добавление информации о покупке в базу данных, отправку уведомлений администраторам и пользователю, а также обработку возврата звезд за покупку, если оплата была произведена звездами.

## Подробней

Этот модуль является важной частью логики обработки платежей в Telegram боте. Он отвечает за фиксацию факта покупки, информирование заинтересованных сторон (администраторов и пользователя) и выполнение необходимых действий в зависимости от типа оплаты. Функция `successful_payment_logic` принимает данные о платеже, товаре и пользователе, выполняя ряд операций для обеспечения корректной обработки покупки.

## Функции

### `successful_payment_logic`

**Назначение**: Обрабатывает логику после успешной оплаты товара пользователем.

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """ Обрабатывает успешную оплату товара пользователем, добавляет информацию о покупке в БД,
    отправляет уведомления администраторам и пользователю, обрабатывает возврат звезд при оплате звездами.

    Args:
        session (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
        payment_data (dict): Словарь с данными о платеже, полученными от платежной системы.
        currency (str): Валюта платежа.
        user_tg_id (int): Telegram ID пользователя, совершившего покупку.
        bot (Bot): Экземпляр Telegram бота.

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка при отправке уведомления администраторам.

    Пример:
        payment_data = {
            "product_id": 123,
            "price": 10.00,
            "payment_type": "card",
            "payment_id": "payment_123",
            "user_id": 456
        }
        await successful_payment_logic(session, payment_data, "USD", 456, bot)
    """
    ...
```

**Параметры**:

- `session` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
- `payment_data` (dict): Словарь с данными о платеже, содержащий:
    - `"product_id"` (int): ID товара.
    - `"price"` (float): Цена товара.
    - `"payment_type"` (str): Тип платежа.
    - `"payment_id"` (str): ID платежа.
    - `"user_id"` (int): ID пользователя.
- `currency` (str): Валюта платежа.
- `user_tg_id` (int): Telegram ID пользователя, совершившего покупку.
- `bot` (Bot): Экземпляр Telegram бота.

**Возвращает**:

- `None`

**Вызывает исключения**:

- `Exception`: Если происходит ошибка при отправке уведомления администраторам.

**Как работает функция**:

1.  Извлекает данные о продукте, цене, типе платежа, ID платежа и ID пользователя из `payment_data`.
2.  Добавляет информацию о покупке в базу данных через `PurchaseDao.add`.
3.  Находит информацию о товаре по его ID с помощью `ProductDao.find_one_or_none_by_id`.
4.  Отправляет уведомления администраторам о совершенной покупке, используя `bot.send_message`. Логирует ошибки, если отправка уведомления не удалась.
5.  Формирует текст сообщения для пользователя с информацией о покупке, включая название товара, описание, цену и скрытый контент.
6.  Отправляет пользователю файл товара (если он есть) или сообщение с информацией о товаре, используя `bot.send_document` или `bot.send_message` соответственно.
7.  Если тип платежа - "stars", выполняет возврат звезд пользователю, используя `bot.refund_star_payment`.

**Примеры**:

```python
payment_data = {
    "product_id": 123,
    "price": 10.00,
    "payment_type": "card",
    "payment_id": "payment_123",
    "user_id": 456
}
await successful_payment_logic(session, payment_data, "USD", 456, bot)
```

В этом примере функция `successful_payment_logic` вызывается с фиктивными данными о платеже, валюте, ID пользователя и экземпляром бота. Функция добавит информацию о покупке в базу данных, отправит уведомления администраторам и пользователю, и вернет звезды, если тип платежа был "stars".