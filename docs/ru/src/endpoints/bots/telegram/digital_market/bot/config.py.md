# Модуль конфигурации Telegram-бота для цифрового рынка
## Обзор

Этот модуль содержит настройки для Telegram-бота, используемого для цифрового рынка. Он определяет параметры, такие как токен бота, идентификаторы администраторов, токен провайдера, настройки логирования, URL базы данных, URL сайта, учетные данные MRH (Merchant Registration Host) и флаг тестового режима. Модуль также инициализирует бота и диспетчер, а также настраивает логирование.

## Подробней
Этот модуль отвечает за загрузку и хранение конфигурационных параметров, необходимых для работы Telegram-бота. Он использует библиотеку `pydantic-settings` для управления настройками, загружаемыми из переменных среды.  Расположение файла в проекте указывает на его роль в качестве централизованного места для хранения и управления конфигурацией бота, что позволяет легко адаптировать его к различным средам (например, разработка, тестирование, продакшн) без изменения кода.

## Классы

### `Settings`

**Описание**: Класс для хранения настроек бота.

**Наследует**: `BaseSettings` из `pydantic_settings`.

**Атрибуты**:

-   `BOT_TOKEN` (str): Токен Telegram-бота.
-   `ADMIN_IDS` (List[int]): Список идентификаторов администраторов бота.
-   `PROVIDER_TOKEN` (str): Токен провайдера платежей.
-   `FORMAT_LOG` (str): Формат логирования (по умолчанию: "{time:YYYY-MM-DD at HH:mm:ss} | {level} | {message}").
-   `LOG_ROTATION` (str): Размер ротации логов (по умолчанию: "10 MB").
-   `DB_URL` (str): URL базы данных (по умолчанию: 'sqlite+aiosqlite:///data/db.sqlite3').
-   `SITE_URL` (str): URL сайта.
-   `SITE_HOST` (str): Хост сайта.
-   `SITE_PORT` (int): Порт сайта.
-   `MRH_LOGIN` (str): Логин для MRH.
-   `MRH_PASS_1` (str): Пароль 1 для MRH.
-   `MRH_PASS_2` (str): Пароль 2 для MRH.
-   `IN_TEST` (int): Флаг тестового режима.

**Параметры**:
-   `env_file`: Путь к файлу `.env`, содержащему переменные среды.

**Принцип работы**:
Класс `Settings` использует `pydantic-settings` для автоматической загрузки параметров из переменных среды, определенных в файле `.env`. Это позволяет гибко настраивать бота без необходимости изменения кода. Класс также предоставляет методы для динамического формирования URL вебхуков.

### Методы класса

#### `get_webhook_url`

```python
def get_webhook_url(self) -> str:
    """Динамически формирует путь для вебхука на основе токена и URL сайта."""
    ...
```

**Назначение**: Формирует URL для вебхука на основе токена бота и URL сайта.

**Параметры**:

-   `self` (Settings): Экземпляр класса `Settings`.

**Возвращает**:

-   `str`: URL вебхука.

**Как работает функция**:
Функция формирует URL вебхука, объединяя `SITE_URL` и `BOT_TOKEN` из настроек.

**Примеры**:

```python
settings = Settings(BOT_TOKEN="test_bot", SITE_URL="https://example.com")
webhook_url = settings.get_webhook_url
print(webhook_url) # Вывод: https://example.com/test_bot
```

#### `get_provider_hook_url`

```python
def get_provider_hook_url(self) -> str:
    """Динамически формирует путь для вебхука на основе токена и URL сайта."""
    ...
```

**Назначение**: Формирует URL для вебхука провайдера платежей на основе URL сайта и фиксированного пути `/robokassa`.

**Параметры**:

-   `self` (Settings): Экземпляр класса `Settings`.

**Возвращает**:

-   `str`: URL вебхука провайдера платежей.

**Как работает функция**:

Функция формирует URL вебхука провайдера платежей, объединяя `SITE_URL` из настроек с фиксированным путем `/robokassa`.

**Примеры**:

```python
settings = Settings(SITE_URL="https://example.com")
provider_webhook_url = settings.get_provider_hook_url
print(provider_webhook_url) # Вывод: https://example.com/robokassa
```

## Параметры класса

-   `BOT_TOKEN` (str): Токен, используемый для аутентификации бота в сети Telegram. Этот токен выдается BotFather при создании нового бота.
-   `ADMIN_IDS` (List[int]): Список целочисленных идентификаторов пользователей Telegram, которые имеют права администратора для данного бота. Администраторы могут выполнять специальные команды или иметь доступ к конфиденциальной информации.
-   `PROVIDER_TOKEN` (str): Токен, используемый для интеграции с платежным провайдером (например, Robokassa). Этот токен позволяет боту принимать платежи от пользователей.
-   `FORMAT_LOG` (str): Строка формата, определяющая структуру записей в лог-файле. Включает информацию о времени, уровне логирования и сообщении.
-   `LOG_ROTATION` (str): Указывает максимальный размер лог-файла перед его ротацией (созданием нового файла).
-   `DB_URL` (str): URL-адрес базы данных, используемой для хранения данных бота (например, пользователей, продуктов, заказов). Поддерживаются различные типы баз данных, такие как SQLite, PostgreSQL и MySQL.
-   `SITE_URL` (str): Базовый URL-адрес сайта, с которым взаимодействует бот. Используется для формирования ссылок и вебхуков.
-   `SITE_HOST` (str): Хост сайта, который используется для определения домена сайта.
-   `SITE_PORT` (int): Порт, на котором работает сайт.
-   `MRH_LOGIN` (str): Имя пользователя для доступа к Merchant Registration Host (MRH).
-   `MRH_PASS_1` (str): Первый пароль для доступа к MRH.
-   `MRH_PASS_2` (str): Второй пароль для доступа к MRH.
-   `IN_TEST` (int): Флаг, указывающий, находится ли бот в тестовом режиме (1) или в production-режиме (0).

## Инициализация бота и диспетчера

```python
# Получаем параметры для загрузки переменных среды
settings = Settings()

# Инициализируем бота и диспетчер
bot = Bot(token=settings.BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())
admins = settings.ADMIN_IDS

log_file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "log.txt")
logger.add(log_file_path, format=settings.FORMAT_LOG, level="INFO", rotation=settings.LOG_ROTATION)
database_url = settings.DB_URL
```

**Описание**:
Этот раздел кода инициализирует основные компоненты Telegram-бота:

*   Создается экземпляр класса `Settings` для загрузки параметров конфигурации.
*   Инициализируется объект `Bot` с использованием токена бота и режима разметки HTML.
*   Создается экземпляр `Dispatcher` для обработки входящих обновлений от Telegram. В качестве хранилища состояний используется `MemoryStorage`.
*   Получается список идентификаторов администраторов из настроек.
*   Настраивается логирование в файл с использованием параметров, определенных в классе `Settings`.
*   Получается URL базы данных из настроек.

**Переменные**:

*   `settings` (Settings): Экземпляр класса `Settings`, содержащий параметры конфигурации.
*   `bot` (Bot): Экземпляр класса `Bot` из библиотеки `aiogram`, представляющий Telegram-бота.
*   `dp` (Dispatcher): Экземпляр класса `Dispatcher` из библиотеки `aiogram`, используемый для регистрации обработчиков событий.
*   `admins` (List[int]): Список идентификаторов администраторов бота.
*   `log_file_path` (str): Путь к файлу логов.
*   `database_url` (str): URL базы данных.