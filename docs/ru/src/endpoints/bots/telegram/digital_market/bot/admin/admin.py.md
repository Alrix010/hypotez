# Модуль для администрирования Digital Market Telegram Bot
## Обзор

Модуль `admin.py` предназначен для реализации административных функций в Telegram-боте для цифрового магазина.
Он включает в себя обработку команд администратора, таких как просмотр статистики, управление продуктами (добавление, удаление) и категориями.
Модуль использует библиотеку `aiogram` для обработки взаимодействий с пользователем через Telegram и `SQLAlchemy` для работы с базой данных.

## Подробнее

Модуль предоставляет администраторам интерфейс для управления ботом цифрового магазина, включая просмотр статистики пользователей, управление продуктами (добавление, удаление) и категориями. Он использует конечные автоматы (FSM) для управления состоянием при добавлении новых продуктов, обеспечивая структурированный и управляемый процесс.

## Классы

### `AddProduct`

**Описание**: Класс состояний (FSM) для процесса добавления нового продукта.

**Наследует**: `StatesGroup` из `aiogram.fsm.state`.

**Атрибуты**:
- `name` (State): Состояние для ввода имени продукта.
- `description` (State): Состояние для ввода описания продукта.
- `price` (State): Состояние для ввода цены продукта.
- `file_id` (State): Состояние для загрузки файла продукта.
- `category_id` (State): Состояние для выбора категории продукта.
- `hidden_content` (State): Состояние для ввода скрытого контента продукта.
- `confirm_add` (State): Состояние для подтверждения добавления продукта.

**Принцип работы**:
Класс `AddProduct` определяет состояния, необходимые для последовательного добавления нового продукта через Telegram-бота. Каждое состояние представляет собой шаг в процессе добавления продукта, например, ввод имени, описания, цены и т.д. Использование `StatesGroup` позволяет aiogram эффективно управлять этими состояниями и переключаться между ними в зависимости от действий пользователя.

## Функции

### `start_admin`

```python
async def start_admin(call: CallbackQuery) -> None:
    """
    Обрабатывает нажатие на кнопку "admin_panel" и предоставляет доступ к админ-панели.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка при открытии админ-панели.

    Как работает функция:
    - Отвечает на обратный вызов, подтверждая доступ в админ-панель.
    - Пытается отредактировать сообщение, предоставляя пользователю выбор действий в админ-панели.
    - Если редактирование сообщения не удаётся, пытается удалить сообщение и отправить новое с теми же действиями.
    - В случае возникновения ошибки отправляет сообщение об ошибке с предложением попробовать ещё раз.
    """
```

### `admin_statistic`

```python
async def admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает запрос на получение статистики и отображает её в сообщении.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

    Returns:
        None

    Как работает функция:
    - Отвечает на обратный вызов, уведомляя о запросе статистики.
    - Получает статистику пользователей и общую статистику по заказам из базы данных.
    - Формирует текстовое сообщение со статистикой и отображает его в отредактированном сообщении.
    """
```

### `admin_process_cancel`

```python
async def admin_process_cancel(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает отмену сценария добавления товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Очищает состояние FSM, завершая сценарий добавления товара.
    - Удаляет сообщение с кнопками действий и отправляет новое сообщение об отмене добавления товара.
    """
```

### `admin_process_start_dell`

```python
async def admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Запускает процесс удаления товаров, отображая список всех товаров с возможностью удаления.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

    Returns:
        None

    Как работает функция:
    - Получает список всех товаров из базы данных.
    - Формирует текстовые сообщения с описанием каждого товара и кнопками для удаления.
    - Отправляет сообщения с товарами и кнопками удаления.
    """
```

### `admin_process_start_dell` (Обработчик удаления товара)

```python
async def admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession) -> None:
    """
    Удаляет выбранный товар из базы данных.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных с коммитом.

    Returns:
        None

    Как работает функция:
    - Извлекает ID товара из данных обратного вызова.
    - Удаляет товар из базы данных.
    - Отправляет уведомление об успешном удалении товара.
    - Удаляет сообщение с информацией о товаре.
    """
```

### `admin_process_products`

```python
async def admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает запрос на управление товарами, отображая количество товаров и предлагая выбор действий.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

    Returns:
        None

    Как работает функция:
    - Получает количество всех товаров из базы данных.
    - Формирует текстовое сообщение с количеством товаров и кнопками для выбора действий (добавить, удалить и т.д.).
    - Отправляет сообщение с предложением выбора действий.
    """
```

### `admin_process_add_product`

```python
async def admin_process_add_product(call: CallbackQuery, state: FSMContext) -> None:
    """
    Запускает сценарий добавления нового товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Отвечает на обратный вызов, уведомляя о запуске сценария добавления товара.
    - Удаляет сообщение с кнопками действий и отправляет новое сообщение с запросом имени товара.
    - Устанавливает состояние FSM на `AddProduct.name`.
    """
```

### `admin_process_name`

```python
async def admin_process_name(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает ввод имени товара.

    Args:
        message (Message): Объект Message, содержащий текст сообщения от пользователя.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Обновляет состояние FSM, сохраняя введённое имя товара.
    - Удаляет предыдущее сообщение пользователя.
    - Отправляет новое сообщение с запросом короткого описания товара.
    - Устанавливает состояние FSM на `AddProduct.description`.
    """
```

### `admin_process_description`

```python
async def admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает ввод описания товара.

    Args:
        message (Message): Объект Message, содержащий текст сообщения от пользователя.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

    Returns:
        None

    Как работает функция:
    - Обновляет состояние FSM, сохраняя введённое описание товара.
    - Удаляет предыдущее сообщение пользователя.
    - Получает список категорий товаров из базы данных.
    - Отправляет сообщение с запросом выбора категории товара.
    - Устанавливает состояние FSM на `AddProduct.category_id`.
    """
```

### `admin_process_category`

```python
async def admin_process_category(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает выбор категории товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Извлекает ID категории из данных обратного вызова.
    - Обновляет состояние FSM, сохраняя выбранный ID категории.
    - Отвечает на обратный вызов, подтверждая выбор категории товара.
    - Отправляет сообщение с запросом цены товара.
    - Устанавливает состояние FSM на `AddProduct.price`.
    """
```

### `admin_process_price`

```python
async def admin_process_price(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает ввод цены товара.

    Args:
        message (Message): Объект Message, содержащий текст сообщения от пользователя.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Пытается преобразовать введённый текст в число.
    - Если преобразование удаётся, обновляет состояние FSM, сохраняя введённую цену товара.
    - Если преобразование не удаётся, отправляет сообщение об ошибке и просит ввести числовое значение.
    - После успешного ввода цены предлагает отправить файл (документ) или выбрать опцию "БЕЗ ФАЙЛА".
    - Устанавливает состояние FSM на `AddProduct.file_id`.
    """
```

### `admin_process_without_file` (Обработчик отсутствия файла)

```python
async def admin_process_without_file(call: CallbackQuery, state: FSMContext) -> None:
    """
    Обрабатывает случай, когда файл товара не выбран.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Обновляет состояние FSM, устанавливая `file_id` в `None`.
    - Отправляет сообщение с запросом контента, который будет отображаться после покупки товара.
    - Устанавливает состояние FSM на `AddProduct.hidden_content`.
    """
```

### `admin_process_without_file` (Обработчик получения файла)

```python
async def admin_process_without_file(message: Message, state: FSMContext) -> None:
    """
    Обрабатывает получение файла товара.

    Args:
        message (Message): Объект Message, содержащий документ (файл) от пользователя.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.

    Returns:
        None

    Как работает функция:
    - Обновляет состояние FSM, сохраняя `file_id` полученного файла.
    - Отправляет сообщение с запросом контента, который будет отображаться после покупки товара.
    - Устанавливает состояние FSM на `AddProduct.hidden_content`.
    """
```

### `admin_process_hidden_content`

```python
async def admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession) -> None:
    """
    Обрабатывает ввод скрытого контента товара.

    Args:
        message (Message): Объект Message, содержащий текст сообщения от пользователя.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

    Returns:
        None

    Как работает функция:
    - Обновляет состояние FSM, сохраняя введённый скрытый контент товара.
    - Получает данные о товаре из состояния FSM.
    - Получает информацию о категории товара из базы данных.
    - Формирует текстовое сообщение с предварительным просмотром информации о товаре.
    - Отправляет сообщение с предварительным просмотром и кнопками подтверждения.
    - Устанавливает состояние FSM на `AddProduct.confirm_add`.
    """
```

### `admin_process_confirm_add`

```python
async def admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession) -> None:
    """
    Обрабатывает подтверждение добавления товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, представляющий обратный вызов от нажатия кнопки.
        state (FSMContext): Объект FSMContext, содержащий состояние конечного автомата.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных с коммитом.

    Returns:
        None

    Как работает функция:
    - Отвечает на обратный вызов, уведомляя о начале сохранения файла.
    - Получает данные о товаре из состояния FSM.
    - Удаляет сообщение с предварительным просмотром информации о товаре.
    - Добавляет товар в базу данных.
    - Отправляет сообщение об успешном добавлении товара.
    """