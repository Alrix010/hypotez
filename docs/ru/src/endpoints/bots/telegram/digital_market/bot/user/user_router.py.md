# Модуль маршрутизации пользовательских запросов Telegram-бота для цифрового магазина

## Обзор

Модуль `user_router.py` содержит обработчики различных пользовательских запросов в Telegram-боте цифрового магазина. Он обрабатывает команды `/start`, переходы по страницам "Главная", "О магазине", "Мой профиль" и "Мои покупки". Модуль использует библиотеку `aiogram` для работы с Telegram API, `SQLAlchemy` для взаимодействия с базой данных и собственные модули `UserDAO` для доступа к данным пользователей и `main_user_kb`, `purchases_kb` для формирования клавиатур.

## Подробнее

Модуль определяет маршрутизатор (`user_router`) для обработки входящих сообщений и callback-запросов от пользователей. Он обеспечивает взаимодействие с базой данных для получения информации о пользователях и их покупках, а также формирует ответы с использованием клавиатур для навигации по боту.

## Классы

В данном модуле не определены классы.

## Функции

### `cmd_start`

```python
async def cmd_start(message: Message, session_with_commit: AsyncSession):
    """Обрабатывает команду /start, регистрирует новых пользователей и приветствует существующих.

    Args:
        message (Message): Объект сообщения от пользователя.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных с поддержкой коммитов.

    Returns:
        Awaitable[Message]: Отправляет приветственное сообщение с клавиатурой основного меню.

    Raises:
        -

    Example:
        Пользователь отправляет команду /start боту. Бот проверяет, зарегистрирован ли пользователь.
        Если пользователь зарегистрирован, бот приветствует его и предлагает выбрать действие.
        Если пользователь не зарегистрирован, бот регистрирует его и предлагает выбрать действие.
    """
```

**Назначение**: Обработка команды `/start`, регистрирует новых пользователей и приветствует существующих.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных с поддержкой коммитов.

**Возвращает**:
- `Awaitable[Message]`: Отправляет приветственное сообщение с клавиатурой основного меню.

**Как работает функция**:
1. Извлекает `user_id` из объекта `message`.
2. Пытается найти пользователя в базе данных по `telegram_id`.
3. Если пользователь найден, отправляет приветственное сообщение с клавиатурой основного меню.
4. Если пользователь не найден, создает новую запись в базе данных с информацией о пользователе и отправляет приветственное сообщение с клавиатурой основного меню.

**Примеры**:
```python
# Пример вызова функции (неявный, вызывается aiogram при получении команды /start)
# await cmd_start(message, session_with_commit)
```

### `page_home`

```python
async def page_home(call: CallbackQuery):
    """Обрабатывает callback-запрос "home", возвращает пользователя на главную страницу.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.

    Returns:
        Awaitable[Message]: Отправляет приветственное сообщение с клавиатурой основного меню.

    Raises:
        -

    Example:
        Пользователь нажимает на кнопку "Главная" в боте. Бот возвращает пользователя на главную страницу.
    """
```

**Назначение**: Обрабатывает callback-запрос "home", возвращает пользователя на главную страницу.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.

**Возвращает**:
- `Awaitable[Message]`: Отправляет приветственное сообщение с клавиатурой основного меню.

**Как работает функция**:
1. Отвечает на callback-запрос сообщением "Главная страница".
2. Отправляет приветственное сообщение с клавиатурой основного меню.

**Примеры**:
```python
# Пример вызова функции (неявный, вызывается aiogram при получении callback-запроса с data="home")
# await page_home(call)
```

### `page_about`

```python
async def page_about(call: CallbackQuery):
    """Обрабатывает callback-запрос "about", отображает информацию о магазине.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.

    Returns:
        Awaitable[Message]: Отправляет сообщение с информацией о магазине.

    Raises:
        -

    Example:
        Пользователь нажимает на кнопку "О магазине" в боте. Бот отображает информацию о магазине.
    """
```

**Назначение**: Обрабатывает callback-запрос "about", отображает информацию о магазине.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.

**Возвращает**:
- `Awaitable[Message]`: Отправляет сообщение с информацией о магазине.

**Как работает функция**:
1. Отвечает на callback-запрос сообщением "О магазине".
2. Отправляет сообщение с информацией о магазине, включая описание, информацию об авторе и данные для тестовой оплаты.

**Примеры**:
```python
# Пример вызова функции (неявный, вызывается aiogram при получении callback-запроса с data="about")
# await page_about(call)
```

### `page_about`

```python
async def page_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """Обрабатывает callback-запрос "my_profile", отображает информацию о профиле пользователя и статистику покупок.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без поддержки коммитов.

    Returns:
        Awaitable[Message]: Отправляет сообщение с информацией о профиле пользователя и статистикой покупок.

    Raises:
        -

    Example:
        Пользователь нажимает на кнопку "Мой профиль" в боте. Бот отображает информацию о профиле пользователя и статистику покупок.
    """
```

**Назначение**: Обрабатывает callback-запрос "my_profile", отображает информацию о профиле пользователя и статистику покупок.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без поддержки коммитов.

**Возвращает**:
- `Awaitable[Message]`: Отправляет сообщение с информацией о профиле пользователя и статистикой покупок.

**Как работает функция**:
1. Отвечает на callback-запрос сообщением "Профиль".
2. Получает статистику покупок пользователя из базы данных.
3. Формирует сообщение в зависимости от наличия покупок.
4. Отправляет сообщение с информацией о профиле пользователя и статистикой покупок.

**Примеры**:
```python
# Пример вызова функции (неявный, вызывается aiogram при получении callback-запроса с data="my_profile")
# await page_about(call, session_without_commit)
```

### `page_user_purchases`

```python
async def page_user_purchases(call: CallbackQuery, session_without_commit: AsyncSession):
    """Обрабатывает callback-запрос "purchases", отображает список покупок пользователя.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без поддержки коммитов.

    Returns:
        Awaitable[Message]: Отправляет сообщения со списком покупок пользователя или сообщение об отсутствии покупок.

    Raises:
        Exception: Обрабатывает исключение при попытке удалить сообщение (например, если сообщение уже удалено).

    Example:
        Пользователь нажимает на кнопку "Мои покупки" в боте. Бот отображает список покупок пользователя.
    """
```

**Назначение**: Обрабатывает callback-запрос "purchases", отображает список покупок пользователя.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без поддержки коммитов.

**Возвращает**:
- `Awaitable[Message]`: Отправляет сообщения со списком покупок пользователя или сообщение об отсутствии покупок.

**Как работает функция**:
1. Отвечает на callback-запрос сообщением "Мои покупки".
2. Пытается удалить предыдущее сообщение пользователя.
3. Получает список покупок пользователя из базы данных.
4. Если список покупок пуст, отправляет сообщение об отсутствии покупок.
5. Если список покупок не пуст, для каждой покупки формирует и отправляет информацию о товаре.
6. Отправляет благодарственное сообщение.

**Примеры**:
```python
# Пример вызова функции (неявный, вызывается aiogram при получении callback-запроса с data="purchases")
# await page_user_purchases(call, session_without_commit)
```