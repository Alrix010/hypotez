# Модуль для обработки пользовательских действий в Telegram боте цифрового магазина
=================================================================

Модуль `user_router.py` отвечает за обработку действий пользователей в Telegram боте, включая команды `/start`, навигацию по страницам (главная, о магазине, профиль) и просмотр истории покупок. Он использует библиотеку `aiogram` для работы с Telegram API и `SQLAlchemy` для взаимодействия с базой данных.

## Обзор

Модуль содержит обработчики для различных пользовательских действий, таких как регистрация, просмотр профиля и истории покупок. Он использует клавиатуры (`kbs`) для навигации и предоставляет информацию о магазине и профиле пользователя.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `cmd_start`

```python
async def cmd_start(message: Message, session_with_commit: AsyncSession):
    """
    Обрабатывает команду `/start`, регистрирует нового пользователя или приветствует существующего.

    Args:
        message (Message): Объект сообщения от Telegram.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.

    Returns:
        None

    Raises:
        Нет

    Пример:
        Пользователь отправляет команду /start боту.
    """
```

**Назначение**:
Функция обрабатывает команду `/start`, которую отправляет пользователь боту. Она проверяет, зарегистрирован ли пользователь в базе данных. Если пользователь уже зарегистрирован, его приветствуют и предлагают выбрать действие. Если пользователь новый, его регистрируют и также предлагают выбрать действие.

**Как работает функция**:

1.  Извлекает `user_id` из объекта `message`.
2.  Ищет пользователя в базе данных по `telegram_id`.
3.  Если пользователь найден, отправляет приветственное сообщение с клавиатурой `main_user_kb`.
4.  Если пользователь не найден, создает нового пользователя с данными из объекта `message` и добавляет его в базу данных.
5.  Отправляет сообщение с благодарностью за регистрацию и клавиатурой `main_user_kb`.

**Примеры**:

```python
# Пример вызова (неявный, вызывается aiogram при получении команды /start)
await cmd_start(message=message, session_with_commit=session)
```

### `page_home`

```python
async def page_home(call: CallbackQuery):
    """
    Обрабатывает нажатие на кнопку "Домой", возвращает пользователя на главную страницу.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.

    Returns:
        None

    Raises:
        Нет

    Пример:
        Пользователь нажимает кнопку "Домой" в боте.
    """
```

**Назначение**:
Функция обрабатывает нажатие пользователем кнопки "Домой". Она возвращает пользователя на главную страницу, предлагая выбрать действие.

**Как работает функция**:

1.  Отвечает на обратный вызов (`call.answer`) сообщением "Главная страница".
2.  Отправляет приветственное сообщение с клавиатурой `main_user_kb`.

**Примеры**:

```python
# Пример вызова (неявный, вызывается aiogram при получении callback_query с data == "home")
await page_home(call=callback_query)
```

### `page_about`

```python
async def page_about(call: CallbackQuery):
    """
    Обрабатывает нажатие на кнопку "О магазине", предоставляет информацию о магазине.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.

    Returns:
        None

    Raises:
        Нет

    Пример:
        Пользователь нажимает кнопку "О магазине" в боте.
    """
```

**Назначение**:
Функция обрабатывает нажатие пользователем кнопки "О магазине". Она предоставляет информацию о магазине, включая описание, авторство и данные для тестовой оплаты.

**Как работает функция**:

1.  Отвечает на обратный вызов (`call.answer`) сообщением "О магазине".
2.  Отправляет текстовое сообщение с информацией о магазине и данными для тестовой оплаты.

**Примеры**:

```python
# Пример вызова (неявный, вызывается aiogram при получении callback_query с data == "about")
await page_about(call=callback_query)
```

### `page_about`

```python
async def page_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает нажатие на кнопку "Мой профиль", предоставляет информацию о профиле пользователя.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных (без коммита).

    Returns:
        None

    Raises:
        Нет

    Пример:
        Пользователь нажимает кнопку "Мой профиль" в боте.
    """
```

**Назначение**:
Функция обрабатывает нажатие пользователем кнопки "Мой профиль". Она предоставляет информацию о профиле пользователя, включая статистику покупок.

**Как работает функция**:

1.  Отвечает на обратный вызов (`call.answer`) сообщением "Профиль".
2.  Получает статистику покупок пользователя из базы данных.
3.  Формирует сообщение в зависимости от наличия покупок.
4.  Если покупок нет, отправляет сообщение об отсутствии покупок.
5.  Если покупки есть, отправляет сообщение с информацией о количестве и общей сумме покупок, а также предлагает просмотреть детали покупок.

**Примеры**:

```python
# Пример вызова (неявный, вызывается aiogram при получении callback_query с data == "my_profile")
await page_about(call=callback_query, session_without_commit=session)
```

### `page_user_purchases`

```python
async def page_user_purchases(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает нажатие на кнопку "Мои покупки", предоставляет список покупок пользователя.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных (без коммита).

    Returns:
        None

    Raises:
        Exception: Если не удается удалить предыдущее сообщение (игнорируется).

    Пример:
        Пользователь нажимает кнопку "Мои покупки" в боте.
    """
```

**Назначение**:
Функция обрабатывает нажатие пользователем кнопки "Мои покупки". Она предоставляет список покупок пользователя, отображая информацию о каждом товаре.

**Как работает функция**:

1.  Отвечает на обратный вызов (`call.answer`) сообщением "Мои покупки".
2.  Пытается удалить предыдущее сообщение.
3.  Получает список покупок пользователя из базы данных.
4.  Если покупок нет, отправляет сообщение об отсутствии покупок.
5.  Если покупки есть, для каждой покупки отправляет информацию о товаре, включая название, описание, цену и скрытое содержимое. Если товар включает файл, отправляет файл с текстом. Если товар не включает файл, отправляет только текст.
6.  Отправляет сообщение с благодарностью за доверие.

**Примеры**:

```python
# Пример вызова (неявный, вызывается aiogram при получении callback_query с data == "purchases")
await page_user_purchases(call=callback_query, session_without_commit=session)
```