# Модуль для взаимодействия с Mega.co.nz
=================================================

Модуль содержит класс :class:`Mega`, который используется для взаимодействия с сервисом Mega.co.nz, включая аутентификацию, скачивание и загрузку файлов.

Пример использования
----------------------

```python
mega = Mega()
mega.login_user('email', 'password')
files = mega.get_files()
file_name = mega.download_from_url('url')
```

## Обзор

Этот модуль предоставляет класс `Mega` для взаимодействия с сервисом Mega.co.nz. Он включает в себя методы для аутентификации пользователя, получения списка файлов, скачивания файлов и загрузки файлов. Модуль использует криптографические функции для защиты данных, передаваемых между клиентом и сервером Mega.

## Подробнее

Модуль `mega.py` предоставляет интерфейс для работы с облачным хранилищем Mega.co.nz. Он включает в себя функциональность для входа в систему, получения списка файлов, скачивания и загрузки файлов. Для обеспечения безопасности данных используются различные криптографические методы, такие как AES и RSA.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с API Mega.co.nz. Предоставляет методы для аутентификации, скачивания и загрузки файлов.

**Атрибуты**:
- `seqno` (int): Номер последовательности для API-запросов.
- `sid` (str): Идентификатор сессии пользователя.
- `master_key` (list): Главный ключ пользователя, используемый для шифрования и дешифрования данных.
- `rsa_priv_key` (list): Приватный RSA-ключ пользователя, используемый для дешифрования идентификатора сессии.
- `root_id` (str): Идентификатор корневой папки ("Cloud Drive").
- `inbox_id` (str): Идентификатор папки "Inbox".
- `trashbin_id` (str): Идентификатор корзины.

**Методы**:
- `__init__()`: Инициализирует экземпляр класса `Mega`.
- `from_credentials(email, password)`: Создает экземпляр класса `Mega` и выполняет вход пользователя по email и паролю.
- `from_ephemeral()`: Создает экземпляр класса `Mega` и выполняет анонимный вход.
- `api_req(data)`: Отправляет API-запрос к Mega.co.nz.
- `login_user(email, password)`: Выполняет вход пользователя по email и паролю.
- `login_ephemeral()`: Выполняет анонимный вход.
- `_login_common(res, password)`: Общая логика для входа в систему, используемая как для обычного, так и для анонимного входа.
- `get_files()`: Получает список файлов и папок пользователя.
- `download_from_url(url)`: Загружает файл по публичной ссылке.
- `download_file(file_id, file_key, public=False, store_path=None)`: Загружает файл по его ID и ключу.
- `get_public_url(file_id, file_key)`:  Формирует публичную ссылку на файл.
- `uploadfile(filename, dst=None)`: Загружает файл на Mega.co.nz.

**Принцип работы**:

Класс `Mega` предоставляет интерфейс для взаимодействия с API Mega.co.nz. Он использует методы для аутентификации пользователя, получения списка файлов, скачивания и загрузки файлов. Класс использует криптографические функции для защиты данных, передаваемых между клиентом и сервером Mega.

### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Назначение**: Инициализация объекта `Mega` с начальными значениями.

**Как работает функция**:

- Устанавливает случайный номер последовательности `seqno` в диапазоне от 0 до 0xFFFFFFFF.
- Инициализирует идентификатор сессии `sid` значением `None`.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email, password):
    """
    Создает экземпляр класса Mega и выполняет вход пользователя по email и паролю.

    Args:
        cls (Mega): Класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный с использованием предоставленных учетных данных.

    """
```

**Назначение**: Создание экземпляра класса `Mega` с использованием email и пароля пользователя.

**Параметры**:
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, аутентифицированный с использованием предоставленных учетных данных.

**Как работает функция**:

- Создает экземпляр класса `Mega`.
- Вызывает метод `login_user` для аутентификации пользователя.
- Возвращает созданный экземпляр класса `Mega`.

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls):
    """
    Создает экземпляр класса Mega и выполняет анонимный вход.

    Args:
        cls (Mega): Класс Mega.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный анонимно.

    """
```

**Назначение**: Создание экземпляра класса `Mega` для анонимного (эфемерального) входа.

**Параметры**:
- `cls` (Mega): Класс Mega.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, аутентифицированный анонимно.

**Как работает функция**:

- Создает экземпляр класса `Mega`.
- Вызывает метод `login_ephemeral` для выполнения анонимного входа.
- Возвращает созданный экземпляр класса `Mega`.

### `api_req`

```python
def api_req(self, data):
    """
    Отправляет API-запрос к Mega.co.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Данные запроса.

    Returns:
        dict: Ответ от API в формате JSON.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    """
```

**Назначение**: Отправка API-запроса к серверу Mega.

**Параметры**:
- `data` (dict): Словарь с данными для отправки в запросе.

**Возвращает**:
- `dict`: Ответ от API в формате JSON.

**Вызывает исключения**:
- `MegaRequestException`: Если API возвращает код ошибки.

**Как работает функция**:

- Формирует параметры запроса, включая номер последовательности `id` и идентификатор сессии `sid` (если он есть).
- Преобразует данные запроса в формат JSON.
- Отправляет POST-запрос к API Mega.
- Преобразует ответ в формат JSON.
- Если ответ содержит код ошибки, вызывает исключение `MegaRequestException`.
- Возвращает полученные данные.

**Примеры**:

```python
mega = Mega()
data = {'a': 'us', 'user': 'test@example.com', 'uh': 'some_hash'}
response = mega.api_req(data)
print(response)
```

### `login_user`

```python
def login_user(self, email, password):
    """
    Выполняет вход пользователя по email и паролю.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    """
```

**Назначение**: Аутентификация пользователя на сервере Mega с использованием email и пароля.

**Параметры**:
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Как работает функция**:

- Подготавливает ключ AES из пароля, используя функцию `prepare_key`.
- Вычисляет хеш `uh` от email и подготовленного ключа AES.
- Отправляет API-запрос с email и хешем для аутентификации.
- Вызывает метод `_login_common` для обработки ответа сервера и завершения процесса входа.

### `login_ephemeral`

```python
def login_ephemeral(self):
    """
    Выполняет анонимный вход.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Назначение**: Выполнение анонимного (эфемерального) входа на сервер Mega.

**Как работает функция**:

- Генерирует случайные ключи: `random_master_key`, `random_password_key`, `random_session_self_challenge`.
- Отправляет API-запрос с зашифрованным `random_master_key` и `random_session_self_challenge`.
- Получает `user_handle` из ответа.
- Отправляет API-запрос с полученным `user_handle` для завершения анонимного входа.
- Вызывает метод `_login_common` для обработки ответа сервера и завершения процесса входа.

### `_login_common`

```python
def _login_common(self, res, password):
    """
    Общая логика для входа в систему, используемая как для обычного, так и для анонимного входа.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от API.
        password (list): Ключ AES, полученный из пароля пользователя.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если email или пароль неверны.

    """
```

**Назначение**: Общая логика для завершения процесса входа в систему, используемая как для обычного, так и для анонимного входа.

**Параметры**:
- `res` (dict): Ответ от API.
- `password` (list): Ключ AES, полученный из пароля пользователя.

**Вызывает исключения**:
- `MegaIncorrectPasswordExcetion`: Если email или пароль неверны.

**Как работает функция**:

- Проверяет, не вернул ли сервер код ошибки (-2 или -9), что означает неверный email или пароль.
- Расшифровывает мастер-ключ пользователя, используя предоставленный пароль.
- Если в ответе сервера есть идентификатор сессии (`tsid`), пытается его использовать для аутентификации.
- Если в ответе сервера есть зашифрованный приватный RSA-ключ (`privk`), расшифровывает его и использует для получения идентификатора сессии (`sid`).

### `get_files`

```python
def get_files(self):
    """
    Получает список файлов и папок пользователя.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Данные о файлах и папках пользователя.

    """
```

**Назначение**: Получение списка файлов и папок пользователя из облачного хранилища Mega.

**Как работает функция**:

- Отправляет API-запрос для получения списка файлов.
- Перебирает каждый файл в полученных данных.
- Если файл является файлом или папкой, расшифровывает его ключ и атрибуты.
- Сохраняет идентификаторы корневой папки, папки "Входящие" и корзины.
- Возвращает полученные данные о файлах и папках.

### `download_from_url`

```python
def download_from_url(self, url):
    """
    Загружает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): URL файла.

    Returns:
        str: Имя скачанного файла.

    """
```

**Назначение**: Загрузка файла из Mega по публичной ссылке.

**Параметры**:
- `url` (str): Публичная ссылка на файл.

**Возвращает**:
- `str`: Имя скачанного файла.

**Как работает функция**:

- Извлекает ID файла и ключ из URL.
- Вызывает метод `download_file` для загрузки файла с использованием полученных ID и ключа.
- Возвращает имя скачанного файла.

### `download_file`

```python
def download_file(self, file_id, file_key, public=False, store_path=None):
    """
    Загружает файл по его ID и ключу.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): ID файла.
        file_key (list): Ключ файла.
        public (bool): Файл является публичным или нет.
        store_path (str): Путь для сохранения файла.

    Returns:
        str: Имя скачанного файла.

    """
```

**Назначение**: Загрузка файла из Mega с использованием его ID и ключа.

**Параметры**:
- `file_id` (str): ID файла.
- `file_key` (list): Ключ файла.
- `public` (bool): Указывает, является ли файл общедоступным (по умолчанию `False`).
- `store_path` (str, optional): Путь к папке, в которой следует сохранить файл. Если не указан, файл сохраняется в текущей директории.

**Возвращает**:
- `str`: Имя скачанного файла.

**Как работает функция**:

- Отправляет API-запрос для получения информации о файле, используя ID файла.
- Расшифровывает ключ файла.
- Получает URL для скачивания файла.
- Расшифровывает атрибуты файла, чтобы получить имя файла.
- Открывает файл для записи.
- Скачивает файл по частям, расшифровывает каждую часть и записывает ее в файл.
- Проверяет целостность файла с помощью MAC-адреса.
- Закрывает файл и возвращает его имя.

### `get_public_url`

```python
def get_public_url(self, file_id, file_key):
    """
    Формирует публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): ID файла.
        file_key (list): Ключ файла.

    Returns:
        str: Публичный URL файла.

    """
```

**Назначение**:  Формирование публичной ссылки для доступа к файлу на Mega.

**Параметры**:
- `file_id` (str): ID файла.
- `file_key` (list): Ключ файла.

**Возвращает**:
- `str`: Публичная ссылка на файл.

**Как работает функция**:

- Отправляет API-запрос для получения публичного идентификатора файла.
- Преобразует ключ файла в base64.
- Формирует публичную ссылку на файл, используя полученный идентификатор и ключ.
- Возвращает публичную ссылку.

### `uploadfile`

```python
def uploadfile(self, filename, dst=None):
    """
    Загружает файл на Mega.co.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Имя файла для загрузки.
        dst (str): ID папки назначения.

    Returns:
        dict: Данные о загруженном файле.

    """
```

**Назначение**: Загрузка файла на сервер Mega.

**Параметры**:
- `filename` (str): Имя файла для загрузки.
- `dst` (str, optional): ID папки назначения. Если не указан, файл загружается в корневую папку.

**Как работает функция**:

- Определяет ID папки назначения. Если `dst` не указан, пытается получить ID корневой папки.
- Открывает файл для чтения.
- Получает размер файла.
- Отправляет API-запрос для получения URL для загрузки файла.
- Генерирует случайный ключ для шифрования файла.
- Шифрует файл по частям и отправляет каждую часть на URL для загрузки.
- Вычисляет MAC-адрес файла для проверки целостности.
- Шифрует атрибуты файла, включая имя файла.
- Отправляет API-запрос для завершения загрузки файла, включая зашифрованные атрибуты и ключ.
- Возвращает данные о загруженном файле.