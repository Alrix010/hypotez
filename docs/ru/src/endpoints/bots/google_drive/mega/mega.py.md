# Модуль для работы с Mega.co.nz
## Обзор

Модуль `mega.py` предоставляет класс `Mega` для взаимодействия с сервисом Mega.co.nz. Он позволяет выполнять такие операции, как аутентификация пользователя, скачивание и загрузка файлов.

## Подробнее

Этот модуль содержит класс `Mega`, который инкапсулирует логику взаимодействия с API Mega.co.nz. Он включает методы для аутентификации пользователя (как с использованием учетных данных, так и через эфемерную сессию), скачивания файлов по URL, загрузки файлов и получения публичных URL.
Модуль использует библиотеки `requests`, `urlobject` и `Crypto` для выполнения HTTP-запросов, работы с URL и шифрования.

## Классы

### `Mega`

Описание класса для взаимодействия с сервисом Mega.co.nz.

**Атрибуты**:

- `seqno` (int):  Последовательный номер запроса, используемый для отслеживания запросов к API. Инициализируется случайным целым числом в диапазоне от 0 до 0xFFFFFFFF.
- `sid` (str): Идентификатор сессии пользователя после успешной аутентификации.
- `master_key` (list[int]): Мастер-ключ пользователя, полученный после аутентификации и используемый для шифрования и расшифрования данных.
- `rsa_priv_key` (list[int]): Приватный RSA-ключ пользователя, используемый для расшифровки идентификатора сессии.
- `root_id` (str): Идентификатор корневой папки ("Cloud Drive") пользователя.
- `inbox_id` (str): Идентификатор папки "Inbox" пользователя.
- `trashbin_id` (str): Идентификатор корзины пользователя.

**Методы**:

- `__init__()`: Инициализирует экземпляр класса `Mega`.
- `from_credentials(email, password)`: Создает экземпляр класса `Mega`, используя email и пароль пользователя.
- `from_ephemeral()`: Создает экземпляр класса `Mega` с использованием эфемерной сессии.
- `api_req(data)`: Отправляет API-запрос к Mega.co.nz.
- `login_user(email, password)`: Аутентифицирует пользователя по email и паролю.
- `login_ephemeral()`: Аутентифицирует пользователя через эфемерную сессию.
- `get_files()`: Получает список файлов и папок пользователя.
- `download_from_url(url)`: Скачивает файл по публичной ссылке.
- `download_file(file_id, file_key, public=False, store_path=None)`: Скачивает файл по его идентификатору и ключу.
- `get_public_url(file_id, file_key)`: Получает публичную ссылку на файл.
- `uploadfile(filename, dst=None)`: Загружает файл на Mega.co.nz.

#### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса `Mega`.

    Инициализирует атрибуты `seqno` случайным числом и `sid` значением `None`.
    """
```

#### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> 'Mega':
    """
    Создает экземпляр класса `Mega`, используя email и пароль пользователя.

    Args:
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса `Mega`, аутентифицированный с использованием предоставленных учетных данных.
    """
```

#### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> 'Mega':
    """
    Создает экземпляр класса `Mega` с использованием эфемерной сессии.

    Returns:
        Mega: Экземпляр класса `Mega`, аутентифицированный через эфемерную сессию.
    """
```

#### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Отправляет API-запрос к Mega.co.nz.

    Args:
        data (dict): Словарь с данными запроса.

    Returns:
        dict: Ответ API в формате JSON.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    
    - Функция формирует параметры запроса, включающие идентификатор запроса (`id`) и, если доступен, идентификатор сессии (`sid`).
    - Данные запроса преобразуются в JSON-формат и отправляются POST-запросом к API Mega.co.nz.
    - В случае получения ответа с кодом ошибки, функция возбуждает исключение `MegaRequestException`.

    """
```

#### `login_user`

```python
def login_user(self, email: str, password: str) -> None:
    """
    Аутентифицирует пользователя по email и паролю.

    Args:
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.
        MegaIncorrectPasswordExcetion: Если указан неверный email или пароль.

     
     - Функция подготавливает ключ шифрования пароля с помощью функции `prepare_key`.
     - Вычисляет хеш email и пароля с помощью функции `stringhash`.
     - Отправляет API-запрос для аутентификации пользователя.
     - Вызывает метод `_login_common` для обработки общего процесса входа в систему.
    """
```

#### `login_ephemeral`

```python
def login_ephemeral(self) -> None:
    """
    Аутентифицирует пользователя через эфемерную сессию.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    
    - Функция генерирует случайные ключи и вызовы сеанса.
    - Отправляет API-запрос для создания эфемерной сессии.
    - Вызывает метод `_login_common` для обработки общего процесса входа в систему.
    """
```

#### `_login_common`

```python
def _login_common(self, res: dict, password: list[int]) -> None:
    """
    Общий метод для обработки процесса входа в систему.

    Args:
        res (dict): Ответ API.
        password (list[int]): Ключ шифрования пароля.

    Raises:
        MegaIncorrectPasswordExcetion: Если указан неверный email или пароль.

    
    - Функция проверяет наличие ошибок в ответе API.
    - Расшифровывает мастер-ключ пользователя.
    - Если в ответе содержится идентификатор сессии (`tsid` или `csid`), пытается его получить и установить.
    """
```

#### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов и папок пользователя.

    Returns:
        dict: Список файлов и папок пользователя.

    
    - Функция отправляет API-запрос для получения списка файлов и папок.
    - Для каждого файла и папки расшифровывает ключ и атрибуты.
    - Устанавливает идентификаторы корневой папки, папки "Inbox" и корзины.
    """
```

#### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке.

    Args:
        url (str): Публичная ссылка на файл.

    Returns:
        str: Имя скачанного файла.

    
    - Функция извлекает идентификатор файла и ключ из URL.
    - Вызывает метод `download_file` для скачивания файла.
    """
```

#### `download_file`

```python
def download_file(self, file_id: str, file_key: str, public: bool = False, store_path: str | None = None) -> str:
    """
    Скачивает файл по его идентификатору и ключу.

    Args:
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.
        public (bool):  Указывает, является ли файл публичным. По умолчанию `False`.
        store_path (Optional[str], optional): Путь для сохранения файла. По умолчанию `None`.

    Returns:
        str: Имя скачанного файла.

    Raises:
        ValueError: Если MAC не совпадает.

    
    - Функция отправляет API-запрос для получения информации о файле.
    - Расшифровывает ключ файла.
    - Скачивает файл по URL.
    - Расшифровывает содержимое файла.
    - Проверяет целостность файла с помощью MAC.
    """
```

#### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list[int]) -> str:
    """
    Получает публичную ссылку на файл.

    Args:
        file_id (str): Идентификатор файла.
        file_key (list[int]): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.

    
    - Функция отправляет API-запрос для получения публичного идентификатора файла.
    - Формирует публичную ссылку на файл.
    """
```

#### `uploadfile`

```python
def uploadfile(self, filename: str, dst: str | None = None) -> dict:
    """
    Загружает файл на Mega.co.nz.

    Args:
        filename (str): Имя файла для загрузки.
        dst (Optional[str], optional): Идентификатор папки назначения. По умолчанию `None`.

    Returns:
        dict: Ответ API.

    
    - Функция открывает файл для чтения.
    - Отправляет API-запрос для получения URL загрузки.
    - Шифрует файл.
    - Загружает файл по URL.
    - Отправляет API-запрос для завершения загрузки.
    """