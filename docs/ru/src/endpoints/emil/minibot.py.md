# Модуль `minibot.py`

## Обзор

Модуль представляет собой простой Telegram-бот, предназначенный для обслуживания запросов, связанных с сайтом emil-design.com. Он включает в себя обработку текстовых сообщений, URL-адресов, голосовых сообщений и документов, а также предоставляет команды для взаимодействия с ботом. Бот использует Google Gemini для генерации ответов на текстовые запросы.

## Подробнее

Этот модуль является частью проекта `hypotez` и расположен в директории `src/endpoints/emil`. Он использует библиотеку `telebot` для взаимодействия с Telegram API и `python-dotenv` для загрузки переменных окружения из файла `.env`.  Основная задача бота - обрабатывать входящие сообщения от пользователей, выполнять необходимые действия в зависимости от типа сообщения (текст, URL, голосовое сообщение, документ) и возвращать результаты пользователю. Бот также поддерживает несколько команд, таких как `/start`, `/help`, `/info`, `/time` и `/photo`.

## Классы

### `BotHandler`

**Описание**: Класс `BotHandler` отвечает за обработку команд, полученных от Telegram-бота. Он включает в себя методы для обработки текстовых сообщений, URL-адресов, команды "--next" и её аналогов, а также для отправки различных типов ответов пользователю.

**Атрибуты**:
- `base_dir` (Path): Базовая директория для хранения ресурсов, таких как схема user_flowchart.
- `scenario` (Scenario): Экземпляр класса `Scenario` для выполнения сценариев.
- `model` (GoogleGenerativeAi): Экземпляр класса `GoogleGenerativeAi` для взаимодействия с моделью Google Gemini.
- `questions_list` (List[str]): Список вопросов для обработки команды "--next".

**Методы**:

- `__init__`
- `handle_message`
- `_send_user_flowchart`
- `_handle_url`
- `_handle_next_command`
- `help_command`
- `send_pdf`
- `handle_voice`
- `_transcribe_voice`
- `handle_document`

#### `__init__`

```python
def __init__(self):
    """Инициализация обработчика событий телеграм-бота."""
    ...
```

**Назначение**: Инициализация экземпляра класса `BotHandler`.

**Параметры**:
- Нет

**Возвращает**:
- Нет

**Как работает функция**:
- Инициализирует экземпляр класса `Scenario`.
- Создает экземпляр класса `GoogleGenerativeAi` с использованием API-ключа Gemini, полученного из переменной окружения `GEMINI_API`.
- Инициализирует список вопросов `questions_list`, который будет использоваться для обработки команды `--next`.

#### `handle_message`

```python
def handle_message(self, bot: telebot, message: 'message'):
    """Обработка текстовых сообщений."""
    ...
```

**Назначение**: Обрабатывает текстовые сообщения, полученные от пользователя.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки ответов пользователю.
- `message` (message): Объект сообщения, содержащий текст сообщения и другую информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Извлекает текст сообщения из объекта `message`.
- Если текст равен "?", отправляет пользователю схему `user_flowchart`.
- Если текст является URL-адресом, обрабатывает его с помощью метода `_handle_url`.
- Если текст является одной из команд ("--next", "-next", "__next", "-n", "-q"), обрабатывает её с помощью метода `_handle_next_command`.
- В противном случае пытается получить ответ от модели Google Gemini и отправить его пользователю.
- В случае ошибки логирует ошибку и отправляет пользователю сообщение об ошибке.

#### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """Отправка схемы user_flowchart."""
    ...
```

**Назначение**: Отправляет пользователю схему `user_flowchart` в виде фотографии.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки фотографии пользователю.
- `chat_id` (int): Идентификатор чата пользователя.

**Возвращает**:
- Нет

**Как работает функция**:
- Формирует путь к файлу `user_flowchart.png` в директории `assets`.
- Открывает файл и отправляет его пользователю в виде фотографии.
- В случае, если файл не найден, логирует ошибку и отправляет пользователю сообщение об ошибке.

#### `_handle_url`

```python
def _handle_url(self, bot, message: 'message'):
    """Обработка URL, присланного пользователем."""
    ...
```

**Назначение**: Обрабатывает URL-адрес, присланный пользователем.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки ответов пользователю.
- `message` (message): Объект сообщения, содержащий URL-адрес и другую информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Извлекает URL-адрес из объекта `message`.
- Проверяет, начинается ли URL-адрес с "https://one-tab.com" или "https://www.one-tab.com". Если нет, отправляет пользователю сообщение об ошибке и завершает работу.
- Извлекает цену, название `mexiron` и список URL-адресов комплектующих с помощью функции `fetch_target_urls_onetab`.
- Отправляет пользователю сообщение с информацией о полученном `mexiron` и его цене.
- Если список URL-адресов пуст, отправляет пользователю сообщение об ошибке.
- Запускает асинхронный сценарий `run_scenario` с использованием полученных данных.
- В случае ошибки логирует её и отправляет пользователю сообщение об ошибке.

#### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """Обработка команды '--next' и её аналогов."""
    ...
```

**Назначение**: Обрабатывает команду "--next" и её аналоги, отправляя пользователю случайный вопрос из списка и ответ от модели.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки ответов пользователю.
- `message` (message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Выбирает случайный вопрос из списка `questions_list`.
- Получает ответ от модели с помощью метода `ask`.
- Отправляет пользователю выбранный вопрос и полученный ответ.
- В случае ошибки логирует её и отправляет пользователю сообщение об ошибке.

#### `help_command`

```python
def help_command(self, bot, message):
    """Обработка команды /help."""
    ...
```

**Назначение**: Обрабатывает команду `/help`, отправляя пользователю список доступных команд.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки сообщений пользователю.
- `message` (message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Отправляет пользователю сообщение со списком доступных команд и их описанием.

#### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """Обработка команды /sendpdf для отправки PDF."""
    ...
```

**Назначение**: Обрабатывает команду `/sendpdf`, отправляя пользователю PDF-файл.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки документов пользователю.
- `message` (message): Объект сообщения, содержащий информацию о пользователе.
- `pdf_file` (str): Путь к PDF-файлу, который необходимо отправить.

**Возвращает**:
- Нет

**Как работает функция**:
- Открывает PDF-файл в режиме чтения байтов.
- Отправляет файл пользователю с помощью метода `send_document`.
- В случае ошибки логирует её и отправляет пользователю сообщение об ошибке.

#### `handle_voice`

```python
def handle_voice(self, bot, message):
    """Обработка голосовых сообщений."""
    ...
```

**Назначение**: Обрабатывает голосовые сообщения, полученные от пользователя.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки ответов пользователю.
- `message` (message): Объект сообщения, содержащий голосовое сообщение и другую информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Получает информацию о файле голосового сообщения.
- Скачивает файл голосового сообщения.
- Сохраняет файл во временную директорию.
- Транскрибирует голосовое сообщение с помощью метода `_transcribe_voice`.
- Отправляет пользователю распознанный текст.
- В случае ошибки логирует её и отправляет пользователю сообщение об ошибке.

#### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """Транскрибирование голосового сообщения (заглушка)."""
    ...
```

**Назначение**: Транскрибирует голосовое сообщение (заглушка, функция не реализована).

**Параметры**:
- `file_path` (str): Путь к файлу голосового сообщения.

**Возвращает**:
- `str`: Сообщение о том, что распознавание голоса ещё не реализовано.

**Как работает функция**:
- Возвращает строку "Распознавание голоса ещё не реализовано.".

#### `handle_document`

```python
def handle_document(self, bot, message):
    """Обработка полученных документов."""
    ...
```

**Назначение**: Обрабатывает документы, полученные от пользователя.

**Параметры**:
- `bot` (telebot): Экземпляр класса `telebot.TeleBot`, используемый для отправки ответов пользователю.
- `message` (message): Объект сообщения, содержащий документ и другую информацию о пользователе.

**Возвращает**:
- `bool`: `True` в случае успешной обработки документа, `False` в случае ошибки.

**Как работает функция**:
- Получает информацию о файле документа.
- Скачивает файл документа.
- Сохраняет файл во временную директорию.
- Отправляет пользователю сообщение об успешном сохранении файла.
- В случае ошибки логирует её и отправляет пользователю сообщение об ошибке, возвращает `False`.

### `Config`

**Описание**: Класс `Config` предназначен для хранения конфигурационных параметров бота.

**Атрибуты**:
- `BOT_TOKEN` (str): Токен бота, полученный из переменной окружения `TELEGRAM_BOT_TOKEN` или из `gs.credentials.telegram.hypo69_emil_design_bot`, если `USE_ENV` равен `False`.
- `CHANNEL_ID` (str): Идентификатор канала для отправки сообщений.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте, отображаемая по команде `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, отображаемое при вводе неизвестной команды.
- `START_MESSAGE` (str): Сообщение, отображаемое при запуске бота.
- `HELP_MESSAGE` (str): Сообщение, отображаемое при вызове команды `/help`.

## Методы

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """Обработка команды /start."""
    ...
```

**Назначение**: Обрабатывает команду `/start`, отправляя пользователю приветственное сообщение.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию об использовании команды `/start`.
- Отправляет пользователю сообщение, содержащее `config.START_MESSAGE`.

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """Обработка команды /help."""
    ...
```

**Назначение**: Обрабатывает команду `/help`, вызывая метод `help_command` класса `BotHandler` для отправки списка доступных команд.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию об использовании команды `/help`.
- Вызывает метод `handler.help_command` для отправки списка доступных команд пользователю.

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """Обработка команды /info."""
    ...
```

**Назначение**: Обрабатывает команду `/info`, отправляя пользователю информацию о боте.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию об использовании команды `/info`.
- Отправляет пользователю сообщение, содержащее `config.COMMAND_INFO`.

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """Обработка команды /time."""
    ...
```

**Назначение**: Обрабатывает команду `/time`, отправляя пользователю текущее время.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию об использовании команды `/time`.
- Получает текущее время.
- Форматирует время в строку.
- Отправляет пользователю сообщение с текущим временем.

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """Обработка команды /photo."""
    ...
```

**Назначение**: Обрабатывает команду `/photo`, отправляя пользователю случайную фотографию из директории.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию об использовании команды `/photo`.
- Получает список файлов в директории с фотографиями.
- Если список не пуст, выбирает случайную фотографию.
- Открывает файл фотографии и отправляет его пользователю.
- Если директория пуста или не найдена, отправляет пользователю сообщение об ошибке.

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """Обработка голосовых сообщений."""
    ...
```

**Назначение**: Обрабатывает голосовые сообщения, вызывая метод `handle_voice` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий голосовое сообщение и информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию о получении голосового сообщения.
- Вызывает метод `handler.handle_voice` для обработки голосового сообщения.

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """Обработка полученных документов."""
    ...
```

**Назначение**: Обрабатывает документы, вызывая метод `handle_document` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий документ и информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию о получении документа.
- Вызывает метод `handler.handle_document` для обработки документа.

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """Обработка текстовых сообщений."""
    ...
```

**Назначение**: Обрабатывает текстовые сообщения, не начинающиеся с символа `/`, вызывая метод `handle_message` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий текст и информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию о полученном текстовом сообщении.
- Вызывает метод `handler.handle_message` для обработки текстового сообщения.

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """Обработка неизвестных команд."""
    ...
```

**Назначение**: Обрабатывает неизвестные команды, отправляя пользователю сообщение об этом.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения, содержащий текст команды и информацию о пользователе.

**Возвращает**:
- Нет

**Как работает функция**:
- Логирует информацию о получении неизвестной команды.
- Отправляет пользователю сообщение, содержащее `config.UNKNOWN_COMMAND_MESSAGE`.

## Переменные

- `ENDPOINT` (str): Константа, определяющая endpoint, равная `'emil'`.
- `USE_ENV` (bool): Определяет, откуда брать ключи. Если `False` - то из базы данных с паролями, иначе из `.env`.
- `config` (Config): Экземпляр класса `Config`, содержащий конфигурационные параметры бота.
- `handler` (BotHandler): Экземпляр класса `BotHandler`, отвечающий за обработку команд бота.
- `bot` (telebot.TeleBot): Экземпляр класса `telebot.TeleBot`, представляющий Telegram-бота.