# Модуль `minibot.py`

## Обзор

Модуль представляет собой простой Telegram-бот, предназначенный для обработки запросов, связанных с сайтом emil-design.com. Он использует библиотеку `telebot` для взаимодействия с Telegram API и предоставляет функциональность для обработки текстовых сообщений, URL-адресов, команд и голосовых сообщений. Бот также интегрирован с моделью Google Gemini для генерации ответов на текстовые запросы.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для работы в качестве Telegram-бота, обслуживающего запросы для emil-design.com. Он включает в себя обработку различных типов сообщений, взаимодействие с Google Gemini для генерации ответов и управление сценариями для обработки URL-адресов.

## Классы

### `BotHandler`

**Описание**: Класс `BotHandler` предназначен для обработки команд и сообщений, получаемых от Telegram-бота. Он включает в себя методы для обработки текста, URL-адресов, голосовых сообщений и документов, а также для отправки различных ответов и сообщений пользователю.

**Атрибуты**:
- `base_dir` (Path): Базовый каталог для хранения ресурсов, таких как схема user_flowchart.
- `scenario` (Scenario): Экземпляр класса `Scenario` для выполнения сценариев обработки URL.
- `model` (GoogleGenerativeAi): Экземпляр класса `GoogleGenerativeAi` для взаимодействия с моделью Google Gemini.
- `questions_list` (List[str]): Список вопросов для случайного выбора при обработке команды "--next".

**Методы**:

#### `__init__`

```python
def __init__(self):
    """
    Инициализация обработчика событий телеграм-бота.
    """
```
**Назначение**: Инициализирует экземпляр класса `BotHandler`, создавая экземпляры `Scenario` и `GoogleGenerativeAi`, а также инициализируя список вопросов.

#### `handle_message`

```python
def handle_message(self, bot: telebot, message: 'message'):
    """
    Обработка текстовых сообщений.

    Args:
        bot (telebot): Экземпляр телеграм-бота.
        message (message): Объект сообщения от пользователя.
    """
```
**Назначение**: Обрабатывает текстовые сообщения, поступающие от пользователя. Если сообщение содержит "?", отправляет схему user_flowchart. Если сообщение является URL, обрабатывает его. Если сообщение содержит команды "--next", "-next", "__next", "-n" или "-q", обрабатывает их. В противном случае, отправляет сообщение в модель Gemini и отправляет ответ пользователю.

**Как работает функция**:
1. Извлекает текст из объекта сообщения.
2. Проверяет, если текст равен "?", и вызывает метод `_send_user_flowchart` для отправки схемы user_flowchart.
3. Проверяет, если текст является URL, используя функцию `is_url`, и вызывает метод `_handle_url` для обработки URL.
4. Проверяет, если текст является одной из команд "--next", "-next", "__next", "-n" или "-q", и вызывает метод `_handle_next_command` для обработки команды.
5. Если ни одно из вышеперечисленных условий не выполнено, отправляет текст в модель Gemini для получения ответа.
6. Отправляет полученный ответ пользователю.
7. В случае возникновения ошибки во время взаимодействия с моделью, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
bot_handler.handle_message(bot, message)
```

#### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """
    Отправка схемы user_flowchart.

    Args:
        bot: Экземпляр телеграм-бота.
        chat_id: ID чата, куда нужно отправить фото.
    """
```

**Назначение**: Отправляет схему `user_flowchart.png` пользователю в Telegram-чат.

**Как работает функция**:
1. Формирует путь к файлу `user_flowchart.png` в директории `assets`.
2. Открывает файл изображения в режиме чтения байтов.
3. Отправляет фотографию пользователю, используя метод `send_photo` объекта `bot`.
4. В случае, если файл не найден, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
chat_id = message.chat.id
bot_handler._send_user_flowchart(bot, chat_id)
```

#### `_handle_url`

```python
def _handle_url(self, bot, message: 'message'):
    """
    Обработка URL, присланного пользователем.

    Args:
        bot: Экземпляр телеграм-бота.
        message (message): Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает URL, который прислал пользователь. Проверяет, что URL начинается с `https://one-tab.com` или `https://www.one-tab.com`, извлекает данные о товаре и запускает сценарий.

**Как работает функция**:
1. Извлекает URL из текста сообщения.
2. Проверяет, начинается ли URL с `https://one-tab.com` или `https://www.one-tab.com`. Если нет, отправляет пользователю сообщение об ошибке и завершает выполнение.
3. Извлекает цену, название товара и список URL из OneTab, используя функцию `fetch_target_urls_onetab`.
4. Отправляет пользователю сообщение с информацией о товаре (название и цена).
5. Запускает асинхронный сценарий `run_scenario`, передавая ему бота, ID чата, список URL, цену и название товара.
6. В случае возникновения ошибки на любом этапе, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
bot_handler._handle_url(bot, message)
```

#### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """
    Обработка команды '--next' и её аналогов.

    Args:
        bot: Экземпляр телеграм-бота.
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду '--next' и её аналоги. Выбирает случайный вопрос из списка, отправляет его пользователю, запрашивает ответ у модели Gemini и отправляет ответ пользователю.

**Как работает функция**:
1. Выбирает случайный вопрос из списка `self.questions_list`.
2. Отправляет выбранный вопрос пользователю.
3. Запрашивает ответ у модели Gemini, используя метод `self.model.ask(question)`.
4. Отправляет полученный ответ пользователю.
5. В случае возникновения ошибки, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
bot_handler._handle_next_command(bot, message)
```

#### `help_command`

```python
def help_command(self, bot, message):
    """
    Обработка команды /help.

    Args:
        bot: Экземпляр телеграм-бота.
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/help`, отправляя пользователю список доступных команд.

**Как работает функция**:
1. Отправляет пользователю сообщение со списком доступных команд и их описанием.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
bot_handler.help_command(bot, message)
```

#### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """
    Обработка команды /sendpdf для отправки PDF.

    Args:
        bot: Экземпляр телеграм-бота.
        message: Объект сообщения от пользователя.
        pdf_file: Путь к PDF-файлу.
    """
```

**Назначение**: Обрабатывает команду `/sendpdf`, отправляя пользователю PDF-файл.

**Как работает функция**:
1. Открывает PDF-файл в режиме чтения байтов.
2. Отправляет PDF-файл пользователю, используя метод `send_document` объекта `bot`.
3. В случае возникновения ошибки, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
pdf_file = 'example.pdf'
bot_handler.send_pdf(bot, message, pdf_file)
```

#### `handle_voice`

```python
def handle_voice(self, bot, message):
    """
    Обработка голосовых сообщений.

    Args:
        bot: Экземпляр телеграм-бота.
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает голосовые сообщения, полученные от пользователя.

**Как работает функция**:
1. Получает информацию о файле голосового сообщения, используя `bot.get_file`.
2. Скачивает файл голосового сообщения, используя `bot.download_file`.
3. Сохраняет скачанный файл во временную директорию.
4. Вызывает метод `_transcribe_voice` для транскрибирования голосового сообщения (в текущей версии возвращает заглушку).
5. Отправляет распознанный текст пользователю.
6. В случае возникновения ошибки, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
bot_handler.handle_voice(bot, message)
```

#### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """
    Транскрибирование голосового сообщения (заглушка).

    Args:
        file_path: Путь к файлу голосового сообщения.

    Returns:
        str: Заглушка с сообщением о нереализованной функциональности.
    """
```

**Назначение**: Транскрибирует голосовое сообщение в текст. В текущей реализации является заглушкой и возвращает сообщение о том, что распознавание голоса ещё не реализовано.

**Как работает функция**:
1. Возвращает строку "Распознавание голоса ещё не реализовано.".

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
file_path = 'voice.ogg'
transcribed_text = bot_handler._transcribe_voice(file_path)
print(transcribed_text)  # Вывод: Распознавание голоса ещё не реализовано.
```

#### `handle_document`

```python
def handle_document(self, bot, message):
    """
    Обработка полученных документов.

    Args:
        bot: Экземпляр телеграм-бота.
        message: Объект сообщения от пользователя.

    Returns:
        bool: True в случае успешной обработки, False в случае ошибки.
    """
```

**Назначение**: Обрабатывает документы, полученные от пользователя.

**Как работает функция**:
1. Получает информацию о файле документа, используя `bot.get_file`.
2. Скачивает файл документа, используя `bot.download_file`.
3. Сохраняет скачанный файл во временную директорию.
4. Отправляет пользователю сообщение об успешном сохранении файла.
5. В случае возникновения ошибки, логирует ошибку и отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
bot_handler = BotHandler()
success = bot_handler.handle_document(bot, message)
if success:
    print("Файл успешно обработан.")
else:
    print("Ошибка при обработке файла.")
```

### `Config`

**Описание**: Класс `Config` предназначен для хранения конфигурационных параметров бота. Он использует переменные окружения или значения из базы данных (в зависимости от значения `USE_ENV`) для определения параметров, таких как токен бота, ID канала и пути к директориям.

**Атрибуты**:
- `BOT_TOKEN` (str): Токен Telegram-бота, полученный из переменной окружения `TELEGRAM_BOT_TOKEN` или из базы данных.
- `CHANNEL_ID` (str): ID канала Telegram.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте, отображаемая по команде `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, отображаемое при получении неизвестной команды.
- `START_MESSAGE` (str): Сообщение, отображаемое при старте бота.
- `HELP_MESSAGE` (str): Справочное сообщение, отображаемое по команде `/help`.

## Функции

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """
    Обработка команды /start.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/start`, отправляя пользователю приветственное сообщение.

**Как работает функция**:
1. Логирует информацию об использовании команды `/start` пользователем.
2. Отправляет пользователю сообщение, содержащее текст из `config.START_MESSAGE`.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении команды /start)
command_start(message)
```

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """
    Обработка команды /help.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/help`, вызывая метод `help_command` класса `BotHandler` для отправки пользователю списка доступных команд.

**Как работает функция**:
1. Логирует информацию об использовании команды `/help` пользователем.
2. Вызывает метод `handler.help_command(bot, message)` для отправки списка команд.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении команды /help)
command_help(message)
```

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """
    Обработка команды /info.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/info`, отправляя пользователю информацию о боте.

**Как работает функция**:
1. Логирует информацию об использовании команды `/info` пользователем.
2. Отправляет пользователю сообщение, содержащее текст из `config.COMMAND_INFO`.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении команды /info)
command_info(message)
```

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """
    Обработка команды /time.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/time`, отправляя пользователю текущее время.

**Как работает функция**:
1. Логирует информацию об использовании команды `/time` пользователем.
2. Получает текущее время.
3. Форматирует текущее время в строку.
4. Отправляет пользователю сообщение с текущим временем.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении команды /time)
command_time(message)
```

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """
    Обработка команды /photo.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает команду `/photo`, отправляя пользователю случайное фото из директории.

**Как работает функция**:
1. Логирует информацию об использовании команды `/photo` пользователем.
2. Получает список файлов в директории с фотографиями.
3. Если список не пуст, выбирает случайный файл.
4. Открывает файл и отправляет фотографию пользователю.
5. В случае, если директория не найдена или в ней нет файлов, отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении команды /photo)
command_photo(message)
```

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """
    Обработка голосовых сообщений.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает голосовые сообщения, полученные от пользователя, передавая их обработчику `handler`.

**Как работает функция**:
1. Логирует информацию о получении голосового сообщения от пользователя.
2. Вызывает метод `handle_voice` объекта `handler` для обработки голосового сообщения.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении голосового сообщения)
handle_voice_message(message)
```

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """
    Обработка полученных документов.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает документы, полученные от пользователя, передавая их обработчику `handler`.

**Как работает функция**:
1. Логирует информацию о получении документа от пользователя.
2. Вызывает метод `handle_document` объекта `handler` для обработки документа.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении документа)
handle_document_message(message)
```

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """
    Обработка текстовых сообщений (не команды).

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает текстовые сообщения, которые не начинаются с символа `/` (т.е. не являются командами), передавая их обработчику `handler`.

**Как работает функция**:
1. Логирует информацию о получении текстового сообщения от пользователя.
2. Вызывает метод `handle_message` объекта `handler` для обработки текстового сообщения.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении текстового сообщения)
handle_text_message(message)
```

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """
    Обработка неизвестных команд.

    Args:
        message: Объект сообщения от пользователя.
    """
```

**Назначение**: Обрабатывает неизвестные команды, отправляя пользователю сообщение об этом.

**Как работает функция**:
1. Логирует информацию о получении неизвестной команды от пользователя.
2. Отправляет пользователю сообщение, содержащее текст из `config.UNKNOWN_COMMAND_MESSAGE`.

**Примеры**:
```python
# Пример вызова функции (вызывается автоматически при получении неизвестной команды)
handle_unknown_command(message)