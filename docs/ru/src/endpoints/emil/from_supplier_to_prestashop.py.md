# Модуль исполнения сценария `emil-design.com`

## Обзор

Модуль предназначен для извлечения, обработки и сохранения данных о товарах от поставщиков с последующей интеграцией этих данных в Prestashop. Он включает в себя функциональность для парсинга данных, их обработки с использованием AI, а также сохранения для дальнейшей публикации в Prestashop.

## Подробней

Этот модуль является частью процесса интеграции данных о товарах с платформы `emil-design.com` в Prestashop. Он автоматизирует получение информации о товарах, при необходимости использует AI для обработки и подготовки данных, и обеспечивает их сохранение и публикацию. Модуль использует веб-драйвер для взаимодействия с веб-страницами поставщиков, а также API Prestashop для обновления информации о товарах.

## Классы

### `SupplierToPrestashopProvider`

**Описание**: Класс предназначен для извлечения, преобразования и сохранения данных о товарах от поставщиков, как из внешних сайтов, так и из JSON-файлов.

**Атрибуты**:
- `base_dir` (Path): Базовый путь к директории с информацией о поставщиках.
- `driver` (Driver): Экземпляр Selenium WebDriver для управления браузером.
- `export_path` (Path): Путь для экспорта обработанных данных о товарах.
- `mexiron_name` (str): Название товара.
- `price` (float): Цена товара.
- `timestamp` (str): Временная метка для идентификации данных.
- `products_list` (list): Список обработанных данных о товарах.
- `model` (GoogleGenerativeAi): Экземпляр AI-модели Google Gemini для обработки текста.
- `config` (SimpleNamespace): Конфигурация, загруженная из JSON-файла.
- `local_images_path` (Path): Путь для локального сохранения изображений товаров.
- `lang` (str): Язык, используемый в процессе обработки данных.
- `gemini_api` (str): Ключ API для доступа к Gemini.
- `presta_api` (str): Ключ API для доступа к Prestashop.
- `presta_url` (str): URL Prestashop.

**Методы**:

- `__init__`: Инициализирует экземпляр класса `SupplierToPrestashopProvider`, загружает конфигурацию, инициализирует драйвер и AI модель.
- `initialise_ai_model`: Инициализирует AI модель Gemini с системными инструкциями.
- `process_graber`: Выполняет парсинг товаров, обрабатывает их через AI и сохраняет данные.
- `process_scenarios`: Обрабатывает сценарии для заданных поставщиков.
- `save_product_data`: Сохраняет данные об отдельном товаре в файл.
- `process_llm`: Обрабатывает список товаров через AI модель для получения дополнительных данных.
- `save_in_prestashop`: Сохраняет товары в Prestashop.
- `post_facebook`: Исполняет сценарий рекламного модуля Facebook.
- `create_report`: Создает отчет о товаре в формате HTML и PDF.

### `Config`

**Описание**: Класс конфигурации.

**Атрибуты**:
- `ENDPOINT` (str): Имя endpoint - `emil`.

## Функции

### `__init__`

```python
def __init__(self, 
                 lang:str, 
                 gemini_api: str,
                 presta_api: str,
                 presta_url: str,
                 driver: Optional [Driver] = None,
                 ):
```

**Назначение**: Инициализирует класс `SupplierToPrestashopProvider`.

**Параметры**:
- `lang` (str): Язык, который будет использоваться при обработке данных.
- `gemini_api` (str): API ключ для доступа к модели Gemini.
- `presta_api` (str): API ключ для доступа к Prestashop.
- `presta_url` (str): URL адрес Prestashop.
- `driver` (Optional[Driver], optional): Экземпляр веб-драйвера. Если не указан, создается новый экземпляр Firefox. По умолчанию `None`.

**Как работает функция**:

1.  Сохраняет переданные API ключи и URL в атрибуты экземпляра класса.
2.  Загружает конфигурацию из JSON-файла, используя `j_loads_ns`.
3.  Инициализирует временную метку `timestamp`.
4.  Создает или использует переданный экземпляр веб-драйвера.
5.  Инициализирует AI модель Gemini, вызывая метод `initialise_ai_model`.

### `initialise_ai_model`

```python
def initialise_ai_model(self):
```

**Назначение**: Инициализирует AI модель Gemini с системными инструкциями.

**Параметры**:
- `self`: Экземпляр класса `SupplierToPrestashopProvider`.

**Возвращает**:
- `GoogleGenerativeAi`: Инициализированную AI модель Gemini.

**Как работает функция**:

1.  Формирует путь к файлу с системными инструкциями для модели Gemini на основе языка `self.lang`.
2.  Читает содержимое файла с инструкциями.
3.  Создает экземпляр класса `GoogleGenerativeAi` с использованием ключа API и прочитанных инструкций.
4.  Устанавливает конфигурацию генерации ответов модели.

### `process_graber`

```python
async def process_graber(
        self, 
        urls: list[str],\
        price: Optional[str] = '', \
        mexiron_name: Optional[str] = '', \
        scenarios: dict | list[dict,dict] = None,\
        
    ) -> bool:
```

**Назначение**: Извлекает, обрабатывает и сохраняет данные о товарах с использованием граббера.

**Параметры**:
- `urls` (list[str]): Список URL страниц товаров.
- `price` (Optional[str], optional): Цена товара. По умолчанию пустая строка.
- `mexiron_name` (Optional[str], optional): Название товара. По умолчанию пустая строка.
- `scenarios` (dict | list[dict, dict]], optional): Сценарии для граббера. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Определяет необходимые поля товара.
2.  Итерируется по списку URL.
3.  Получает граббер для каждого URL, используя `get_graber_by_supplier_url`.
4.  Вызывает метод `process_graber` для получения данных о товаре.
5.  Конвертирует полученные поля товара, используя `convert_product_fields`.
6.  Сохраняет данные о товаре, используя `save_product_data`.
7.  Добавляет данные товара в список `products_list`.

### `process_scenarios`

```python
async def process_scenarios(self, suppliers_prefixes:Optional[str] = '') -> bool:
```

**Назначение**: Обрабатывает сценарии для заданных поставщиков.

**Параметры**:
- `suppliers_prefixes` (Optional[str], optional): Префиксы поставщиков. По умолчанию пустая строка.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Преобразует входные префиксы поставщиков в список.

### `save_product_data`

```python
async def save_product_data(self, product_data: dict):
```

**Назначение**: Сохраняет данные об отдельном товаре в файл.

**Параметры**:
- `product_data` (dict): Данные о товаре.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Формирует путь к файлу для сохранения данных о товаре.
2.  Сохраняет данные о товаре в файл, используя `j_dumps`.

### `process_llm`

```python
async def process_llm(self, products_list: List[str], lang:str,  attempts: int = 3) -> tuple | bool:
```

**Назначение**: Обрабатывает список товаров с использованием AI модели.

**Параметры**:
- `products_list` (List[str]): Список данных о товарах.
- `lang` (str): Язык, используемый при обработке данных.
- `attempts` (int, optional): Количество попыток запроса к модели в случае неудачи. По умолчанию 3.

**Возвращает**:
- `tuple | bool`: Обработанный ответ в форматах `ru` и `he`, или `False` в случае неудачи.

**Как работает функция**:

1.  Проверяет количество оставшихся попыток. Если их нет, возвращает `False`.
2.  Формирует запрос к модели на основе системных инструкций и данных о товарах.
3.  Отправляет запрос к модели, используя `self.model.ask`.
4.  Парсит полученный ответ, используя `j_loads`.
5.  В случае неудачи повторяет запрос, если остались попытки.

### `save_in_prestashop`

```python
async def save_in_prestashop(self, products_list:ProductFields | list[ProductFields]) -> bool:
```

**Назначение**: Сохраняет товары в Prestashop.

**Параметры**:
- `products_list` (ProductFields | list[ProductFields]): Список товаров для сохранения.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Преобразует входные данные в список, если это не список.
2.  Создает экземпляр класса `PrestaProduct` для взаимодействия с API Prestashop.
3.  Итерируется по списку товаров и вызывает метод `add_new_product` для добавления каждого товара в Prestashop.

### `post_facebook`

```python
async def post_facebook(self, mexiron:SimpleNamespace) -> bool:
```

**Назначение**: Публикует информацию о товаре в Facebook.

**Параметры**:
- `mexiron` (SimpleNamespace): Объект с данными о товаре.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Переходит на страницу Facebook.
2.  Формирует заголовок сообщения с информацией о товаре.
3.  Публикует сообщение и медиафайлы, используя функции `post_message_title`, `upload_post_media` и `message_publish`.

### `create_report`

```python
async def create_report(self, data: dict, lang:str, html_file: Path, pdf_file: Path) -> bool:
```

**Назначение**: Создает отчет о товаре в формате HTML и PDF.

**Параметры**:
- `data` (dict): Данные для отчета.
- `lang` (str): Язык отчета.
- `html_file` (Path): Путь для сохранения HTML файла.
- `pdf_file` (Path): Путь для сохранения PDF файла.

**Возвращает**:
- `bool`: `True`, если успешно, `False` в противном случае.

**Как работает функция**:

1.  Создает экземпляр класса `ReportGenerator`.
2.  Вызывает метод `create_report` для генерации отчета.
3.  Отправляет PDF файл боту, если он был успешно создан.

### `upload_redacted_images_from_emil`

```python
async def upload_redacted_images_from_emil():
```

**Назначение**: Загружает отредактированные изображения товаров из JSON файла и сохраняет их в Prestashop.

**Как работает функция**:

1.  Устанавливает язык `lang` в значение `'he'`.
2.  Загружает данные о товарах из JSON файла, используя `j_loads_ns`.
3.  Создает экземпляр класса `SupplierToPrestashopProvider`.
4.  Сохраняет товары в Prestashop, используя метод `save_in_prestashop`.

### `main`

```python
async def main():
```

**Назначение**: Главная функция, запускающая процесс загрузки отредактированных изображений товаров.

**Как работает функция**:

1.  Вызывает функцию `upload_redacted_images_from_emil` для загрузки и сохранения данных о товарах.

## Запуск модуля

Для запуска модуля необходимо выполнить скрипт `from_supplier_to_prestashop.py`. Скрипт использует асинхронный запуск, поэтому необходимо использовать `asyncio.run(main())`.