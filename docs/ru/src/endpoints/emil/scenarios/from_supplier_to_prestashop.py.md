# Модуль исполнения сценария создания мехирона для Сергея Казаринова

## Обзор

Модуль предоставляет функциональность для извлечения, разбора и обработки данных о продуктах от различных поставщиков. Он обрабатывает подготовку данных, AI-обработку и интеграцию с Prestashop для размещения продуктов.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для автоматизации процесса получения данных о товарах от поставщиков, их обработки с использованием AI и последующей публикации в интернет-магазине Prestashop. Он включает в себя классы и функции для взаимодействия с веб-страницами поставщиков, AI-моделями (например, Google Gemini) и API Prestashop.

## Классы

### `SupplierToPrestashopProvider`

**Описание**: Класс `SupplierToPrestashopProvider` обрабатывает извлечение, разбор и сохранение данных о продуктах поставщиков. Данные могут быть получены как с сторонних сайтов, так и из файла JSON.

**Атрибуты**:
- `driver` (Driver): Экземпляр Selenium WebDriver для управления браузером.
- `export_path` (Path): Путь для экспорта данных.
- `mexiron_name` (str): Название мехирона.
- `price` (float): Цена продукта.
- `timestamp` (str): Временная метка.
- `products_list` (list): Список обработанных данных о продуктах.
- `model` (GoogleGenerativeAI): Экземпляр модели Google Gemini для обработки текста.
- `config` (SimpleNamespace): Объект с конфигурационными параметрами.
- `local_images_path` (Path): Путь к локальному хранилищу изображений.
- `lang` (str): Язык.
- `gemini_api` (str): API ключ для доступа к Gemini.
- `presta_api` (str): API ключ для доступа к Prestashop.
- `presta_url` (str): URL адрес Prestashop.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `SupplierToPrestashopProvider`.
- `initialise_ai_model`: Инициализирует модель Gemini.
- `run_scenario`: Выполняет сценарий: разбирает продукты, обрабатывает их через AI и сохраняет данные.
- `save_product_data`: Сохраняет отдельные данные о продукте в файл.
- `process_llm`: Обрабатывает список продуктов через AI модель.
- `read_data_from_json`: Загружает JSON файлы и фотографии, полученные через телеграм.
- `save_in_prestashop`: Сохраняет товары в Prestashop.
- `post_facebook`: Исполняет сценарий рекламного модуля `facebook`.
- `create_report`: Отправляет задание на создание мехирона в формате `html` и `pdf`.

### `__init__`
```python
    def __init__(self, 
                 lang:str, 
                 gemini_api: str,
                 presta_api: str,
                 presta_url: str,
                 driver: Optional [Driver] = None,
                 ):
        """
        Initializes SupplierToPrestashopProvider class with required components.\
        """
```
**Назначение**:
Инициализирует класс `SupplierToPrestashopProvider` с необходимыми компонентами, такими как API ключи, URL, язык и драйвер веб-браузера.

**Параметры**:
- `lang` (str): Язык.
- `gemini_api` (str): API ключ для доступа к Gemini.
- `presta_api` (str): API ключ для доступа к Prestashop.
- `presta_url` (str): URL адрес Prestashop.
- `driver` (Optional[Driver]): Экземпляр Selenium WebDriver. Если не указан, создается новый экземпляр Firefox.

**Как работает функция**:
1. Сохраняет переданные API ключи, URL и язык в атрибуты экземпляра класса.
2. Загружает конфигурацию из JSON файла. В случае ошибки логирует её.
3. Инициализирует временную метку.
4. Инициализирует драйвер веб-браузера (если не был передан, создает новый экземпляр Firefox).
5. Инициализирует AI модель (Gemini).

### `initialise_ai_model`
```python
    def initialise_ai_model(self):\
        """Инициализация модели Gemini"""
```
**Назначение**:
Инициализирует модель Google Gemini для обработки текста.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `GoogleGenerativeAI`: Экземпляр модели Google Gemini.
- `None`: В случае ошибки.

**Как работает функция**:
1. Формирует путь к файлу с системными инструкциями для Gemini на основе языка (`self.lang`).
2. Читает содержимое файла с инструкциями.
3. Создает экземпляр класса `GoogleGenerativeAI` с API ключом, системными инструкциями и конфигурацией генерации.
4. В случае ошибки логирует её и возвращает `None`.

### `run_scenario`
```python
    async def run_scenario(
        self, 
        urls: list[str],\
        price: Optional[str] = '', \
        mexiron_name: Optional[str] = '', \
    ) -> bool:\
        """\
        Executes the scenario: parses products, processes them via AI, and stores data.\
        """
```
**Назначение**:
Выполняет основной сценарий: получает данные о продуктах с веб-страниц поставщиков, обрабатывает их с использованием AI и сохраняет полученные данные.

**Параметры**:
- `urls` (list[str]): Список URL-адресов страниц продуктов.
- `price` (Optional[str]): Цена продукта. По умолчанию ''.
- `mexiron_name` (Optional[str]): Название мехирона. По умолчанию ''.

**Возвращает**:
- `bool`: `True`, если сценарий выполнен успешно, `False` в противном случае.

**Как работает функция**:
1. Определяет необходимые поля товара (`required_fields`).
2. Итерируется по списку URL-адресов.
3. Для каждого URL определяет граббер (`get_graber_by_supplier_url`). Если граббер не найден, переходит к следующему URL.
4. С помощью граббера получает данные о продукте (`graber.grab_page`).
5. Преобразует полученные данные (`self.convert_product_fields`).
6. Сохраняет данные о продукте (`self.save_product_data`).
7. Добавляет данные продукта в список `products_list`.

### `save_product_data`
```python
    async def save_product_data(self, product_data: dict):\
        """\
        Saves individual product data to a file.\
        """
```
**Назначение**:
Сохраняет данные об отдельном продукте в файл JSON.

**Параметры**:
- `product_data` (dict): Словарь с данными о продукте.

**Возвращает**:
- `bool`: `True`, если данные успешно сохранены, в противном случае ничего не возвращает.

**Как работает функция**:
1. Формирует путь к файлу для сохранения данных (`self.export_path / 'products' / f"{product_data['product_id']}.json"`).
2. Сохраняет данные в файл с помощью `j_dumps`.
3. В случае ошибки логирует её.

### `process_llm`
```python
    async def process_llm(self, products_list: List[str], lang:str,  attempts: int = 3) -> tuple | bool:\
        """\
        Processes the product list through the AI model.\
        """
```
**Назначение**:
Обрабатывает список продуктов с использованием AI модели (Google Gemini).

**Параметры**:
- `products_list` (List[str]): Список данных о продуктах в виде строки.
- `lang` (str): Язык.
- `attempts` (int): Количество попыток повторной обработки в случае неудачи. По умолчанию 3.

**Возвращает**:
- `dict`: Обработанный ответ от AI модели в формате словаря.
- `bool`: `False`, если не удалось получить валидный ответ после нескольких попыток.

**Как работает функция**:
1. Проверяет количество оставшихся попыток. Если попыток не осталось, возвращает пустой словарь.
2. Формирует команду для AI модели на основе системных инструкций и списка продуктов.
3. Отправляет запрос в AI модель (`self.model.ask`).
4. В случае отсутствия ответа логирует ошибку и, если есть еще попытки, рекурсивно вызывает себя.
5. Преобразует полученный ответ в словарь с помощью `j_loads`.
6. В случае ошибки парсинга ответа логирует её и, если есть еще попытки, рекурсивно вызывает себя.

### `read_data_from_json`
```python
    async def read_data_from_json(self):\
        """Загружаю JSON файлы и фотки, которые я сделал через телеграм"""
```
**Назначение**:
Загружает JSON файлы и фотографии, полученные через телеграм.

**Параметры**:
- Отсутствуют.

**Как работает функция**:
1. Загружает данные из JSON файла, расположенного по пути `self.local_images_path`, с помощью `j_loads_ns`.
2. Выводит загруженные данные в консоль.

### `save_in_prestashop`
```python
    async def save_in_prestashop(self, products_list:ProductFields | list[ProductFields]) -> bool:\
        """Функция, которая сохраняет товары в Prestashop emil-design.com """
```
**Назначение**:
Сохраняет товары в Prestashop.

**Параметры**:
- `products_list` (ProductFields | list[ProductFields]): Список объектов `ProductFields` или один объект `ProductFields`.

**Как работает функция**:
1. Преобразует входной параметр `products_list` в список, если это не список.
2. Создает экземпляр класса `PrestaProduct` с API ключом и URL-адресом Prestashop.
3. Итерируется по списку продуктов и для каждого продукта вызывает метод `add_new_product` класса `PrestaProduct`.

### `post_facebook`
```python
    async def post_facebook(self, mexiron:SimpleNamespace) -> bool:\
        """Функция исполняет сценарий рекламного модуля `facvebook`."""
```
**Назначение**:
Исполняет сценарий рекламного модуля `facebook`.

**Параметры**:
- `mexiron` (SimpleNamespace): Объект с данными для публикации в Facebook.

**Возвращает**:
- `bool`: `True`, если сценарий выполнен успешно, `False` в противном случае.

**Как работает функция**:
1. Открывает страницу Facebook (`https://www.facebook.com/profile.php?id=61566067514123`) с помощью драйвера.
2. Формирует заголовок поста на основе данных из объекта `mexiron`.
3. Вызывает функции `post_message_title`, `upload_post_media` и `message_publish` для публикации сообщения, загрузки медиафайлов и публикации поста.
4. В случае ошибки при выполнении любой из функций логирует предупреждение.

### `create_report`
```python
    async def create_report(self, data: dict, lang:str, html_file: Path, pdf_file: Path) -> bool:\
        """Функция отправляет задание на создание мехирона в формате `html` и `pdf`.\
        Если мехорон в pdf создался (`generator.create_report()` вернул True) - \
        отправить его боту\
        """
```
**Назначение**:
Создает отчет в формате `html` и `pdf` и отправляет его боту.

**Параметры**:
- `data` (dict): Данные для отчета.
- `lang` (str): Язык отчета.
- `html_file` (Path): Путь к файлу `html`.
- `pdf_file` (Path): Путь к файлу `pdf`.

**Возвращает**:
- `bool`: `True`, если отчет успешно создан и отправлен, `False` в противном случае.

**Как работает функция**:
1. Создает экземпляр класса `ReportGenerator`.
2. Вызывает метод `create_report` для создания отчета в форматах `html` и `pdf`.
3. Если отчет успешно создан, проверяет существование PDF файла и отправляет его боту с помощью `self.update.message.reply_document`.
4. В случае ошибки логирует её.

## Функции

### `main`
```python
async def main(suppier_to_presta):\
    """На данный момент функция читает JSON со списком фотографий , которые были получены от Эмиля"""
```
**Назначение**:
Основная асинхронная функция, которая считывает данные о продуктах из JSON и сохраняет их в Prestashop.

**Параметры**:
- `suppier_to_presta`: Не используется в теле функции.

**Как работает функция**:
1. Определяет язык (`lang`).
2. Загружает данные о продуктах из JSON файла.
3. Создает экземпляр класса `SupplierToPrestashopProvider`.
4. Преобразует загруженные данные в список.
5. Сохраняет продукты в Prestashop с помощью метода `save_in_prestashop` экземпляра класса `SupplierToPrestashopProvider`.

## Параметры класса

- `driver` (Driver): Экземпляр Selenium WebDriver для управления браузером.
- `export_path` (Path): Путь для экспорта данных.
- `mexiron_name` (str): Название мехирона.
- `price` (float): Цена продукта.
- `timestamp` (str): Временная метка.
- `products_list` (list): Список обработанных данных о продуктах.
- `model` (GoogleGenerativeAI): Экземпляр модели Google Gemini для обработки текста.
- `config` (SimpleNamespace): Объект с конфигурационными параметрами.
- `local_images_path` (Path): Путь к локальному хранилищу изображений.
- `lang` (str): Язык.
- `gemini_api` (str): API ключ для доступа к Gemini.
- `presta_api` (str): API ключ для доступа к Prestashop.
- `presta_url` (str): URL адрес Prestashop.

**Примеры**:

Примеры вызова функций и создания объектов класса можно найти в документации к каждой функции и классу.
```