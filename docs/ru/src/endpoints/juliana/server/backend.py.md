# Модуль для обработки запросов к backend API
=================================================

Модуль содержит класс `Backend_Api`, который обрабатывает запросы к backend API, включая управление прокси и генерацию ответов на основе заданных параметров.

## Обзор

Этот модуль предоставляет API для обработки запросов, связанных с генерацией ответов на основе входных данных, таких как сообщения, параметры модели и настройки jailbreak. Он также включает функциональность для управления прокси-серверами и определения языка ответа.

## Подробнее

Модуль предназначен для интеграции с веб-приложением и предоставляет endpoints для обработки POST-запросов. Он использует flask для маршрутизации и обработки запросов. Основная задача модуля - генерация ответов на основе заданных параметров, таких как модель, сообщения и настройки безопасности. Модуль также включает функциональность для использования автоматических прокси для обхода ограничений доступа.

## Классы

### `Backend_Api`

**Описание**: Класс, отвечающий за обработку запросов к backend API.

**Принцип работы**: Класс инициализируется с объектом приложения flask и конфигурацией. Он определяет маршруты для обработки POST-запросов и запускает обновление прокси-серверов в отдельном потоке, если это необходимо.

**Атрибуты**:
- `app`: Объект приложения Flask.
- `use_auto_proxy` (bool): Флаг, указывающий на необходимость использования автоматических прокси.
- `routes` (dict): Словарь, содержащий маршруты и связанные с ними функции и методы.

**Методы**:
- `__init__(self, app, config: dict) -> None`: Конструктор класса, инициализирует атрибуты и запускает обновление прокси.
- `_conversation(self)`: Обрабатывает POST-запросы к endpoint `/backend-api/v2/conversation`.

## Функции

### `build_messages(jailbreak)`

**Назначение**: Функция строит сообщение для запроса на основе предоставленных данных.

**Параметры**:
- `jailbreak` (str): Строка, определяющая, какой тип "jailbreak" использовать.

**Возвращает**:
- `conversation` (List[dict]): Список сообщений, готовых к отправке в модель.

**Как работает функция**:
1. **Извлечение данных**: Извлекает данные из запроса, включая историю разговоров (`_conversation`), флаг доступа к интернету (`internet_access`) и основное сообщение (`prompt`).
2. **Формирование системного сообщения**: Создает системное сообщение, которое включает текущую дату и указание модели отвечать на языке запроса.
3. **Инициализация разговора**: Инициализирует разговор системным сообщением.
4. **Добавление истории разговора**: Добавляет существующую историю разговора к общему списку сообщений.
5. **Добавление результатов поиска**: Если разрешен доступ к интернету, добавляет результаты поиска на основе запроса.
6. **Добавление инструкций "jailbreak"**: Если указан "jailbreak", добавляет соответствующие инструкции.
7. **Добавление основного сообщения**: Добавляет основное сообщение пользователя.
8. **Уменьшение размера разговора**: Обрезает разговор до последних 13 сообщений, чтобы избежать ошибок, связанных с количеством токенов.

```
     Извлечение данных из запроса (история разговоров, флаг доступа к интернету, основное сообщение)
     ↓
     Формирование системного сообщения (текущая дата, указание языка ответа)
     ↓
     Инициализация разговора (системное сообщение)
     ↓
     Добавление истории разговора
     ↓
     Добавление результатов поиска (если разрешен доступ к интернету)
     ↓
     Добавление инструкций "jailbreak" (если указан)
     ↓
     Добавление основного сообщения пользователя
     ↓
     Обрезание разговора до последних 13 сообщений (если необходимо)
```

**Примеры**:
```python
# Пример вызова функции с различными параметрами
build_messages(jailbreak="Default")
build_messages(jailbreak="SomeCustomJailbreak")
```

### `fetch_search_results(query)`

**Назначение**: Функция выполняет поиск в интернете и возвращает результаты в формате, подходящем для добавления в разговор.

**Параметры**:
- `query` (str): Поисковой запрос.

**Возвращает**:
- `results` (List[dict]): Список результатов поиска в формате, подходящем для добавления в разговор.

**Как работает функция**:
1. **Выполнение поискового запроса**: Отправляет запрос к API DuckDuckGo для выполнения поиска.
2. **Обработка результатов**: Обрабатывает результаты поиска, формируя сниппеты с информацией о каждом результате, включая URL.
3. **Формирование сообщения для разговора**: Создает сообщение в формате, подходящем для добавления в разговор, содержащее все сниппеты.

```
     Выполнение поискового запроса к API DuckDuckGo
     ↓
     Обработка результатов (формирование сниппетов с информацией и URL)
     ↓
     Формирование сообщения для разговора (содержащего все сниппеты)
```

**Примеры**:
```python
# Пример вызова функции с поисковым запросом
fetch_search_results(query="Что такое машинное обучение?")
```

### `generate_stream(response, jailbreak)`

**Назначение**: Функция генерирует поток сообщений на основе ответа модели, учитывая настройки "jailbreak".

**Параметры**:
- `response`: Объект ответа от модели.
- `jailbreak` (str): Строка, определяющая, какой тип "jailbreak" использовать.

**Возвращает**:
- `Generator[str, None, None]`: Генератор потока сообщений.

**Как работает функция**:
1. **Проверка "jailbreak"**: Проверяет, используется ли "jailbreak".
2. **Обработка "jailbreak"**: Если используется "jailbreak", итерируется по сообщениям в ответе, проверяя, было ли успешно применено "jailbreak".
3. **Генерация потока сообщений**: Генерирует поток сообщений на основе ответа модели, учитывая успешность применения "jailbreak".

```
     Проверка, используется ли "jailbreak"
     ↓
     Если используется "jailbreak":
         Итерация по сообщениям в ответе
         ↓
         Проверка, было ли успешно применено "jailbreak"
         ↓
         Генерация потока сообщений на основе ответа и успешности "jailbreak"
     Иначе:
         Генерация потока сообщений из ответа
```

**Примеры**:
```python
# Пример вызова функции с различными параметрами
generate_stream(response, jailbreak="Default")
generate_stream(response, jailbreak="SomeCustomJailbreak")
```

### `response_jailbroken_success(response: str) -> bool`

**Назначение**: Функция определяет, было ли успешно применено "jailbreak" на основе ответа модели.

**Параметры**:
- `response` (str): Ответ от модели.

**Возвращает**:
- `bool`: `True`, если "jailbreak" был успешно применен, иначе `False`.

**Как работает функция**:
1. **Поиск маркера успеха**: Ищет в ответе модели маркер, указывающий на успешное применение "jailbreak" (например, "ACT:").

```
     Поиск маркера успеха в ответе модели
```

**Примеры**:
```python
# Пример вызова функции с различными ответами
response_jailbroken_success(response="ACT: Some action")  # Вернет True
response_jailbroken_success(response="GPT: Some response")  # Вернет False
```

### `response_jailbroken_failed(response)`

**Назначение**: Функция определяет, не удалось ли применить "jailbreak" на основе ответа модели.

**Параметры**:
- `response` (str): Ответ от модели.

**Возвращает**:
- `bool`: `True`, если "jailbreak" не удалось применить, иначе `False`.

**Как работает функция**:
1. **Проверка длины ответа**: Проверяет длину ответа. Если длина меньше 4 символов, возвращает `False`.
2. **Проверка начала ответа**: Проверяет, начинается ли ответ с маркеров "GPT:" или "ACT:". Если не начинается, возвращает `True`.

```
     Проверка длины ответа
     ↓
     Проверка начала ответа с маркеров "GPT:" или "ACT:"
```

**Примеры**:
```python
# Пример вызова функции с различными ответами
response_jailbroken_failed(response="ACT: Some action")  # Вернет False
response_jailbroken_failed(response="GPT: Some response")  # Вернет False
response_jailbroken_failed(response="Some response")  # Вернет True
```

### `set_response_language(prompt)`

**Назначение**: Функция определяет язык запроса и возвращает строку для указания модели, на каком языке отвечать.

**Параметры**:
- `prompt` (dict): Словарь, содержащий текст запроса.

**Возвращает**:
- `str`: Строка с указанием языка для ответа модели.

**Как работает функция**:
1. **Определение языка**: Использует Google Translate API для определения языка запроса.
2. **Формирование строки указания языка**: Формирует строку, указывающую модели, на каком языке отвечать.

```
     Определение языка запроса с помощью Google Translate API
     ↓
     Формирование строки указания языка для ответа модели
```

**Примеры**:
```python
# Пример вызова функции с различными запросами
set_response_language(prompt={"content": "Привет мир!"})  # Вернет "You will respond in the language: ru. "
```

### `isJailbreak(jailbreak)`

**Назначение**: Функция определяет, какой тип "jailbreak" использовать на основе предоставленного параметра.

**Параметры**:
- `jailbreak` (str): Строка, определяющая, какой тип "jailbreak" использовать.

**Возвращает**:
- `List[dict] | None`: Список инструкций для "jailbreak", если он указан и существует, иначе `None`.

**Как работает функция**:
1. **Проверка значения "jailbreak"**: Проверяет, не равно ли значение "jailbreak" "Default".
2. **Получение инструкций "jailbreak"**: Если значение "jailbreak" указано и существует в словаре `special_instructions`, возвращает соответствующие инструкции.

```
     Проверка значения "jailbreak" (не равно ли "Default")
     ↓
     Получение инструкций "jailbreak" из словаря special_instructions (если существует)
```

**Примеры**:
```python
# Пример вызова функции с различными значениями "jailbreak"
isJailbreak(jailbreak="Default")  # Вернет None
isJailbreak(jailbreak="SomeCustomJailbreak")  # Вернет список инструкций, если "SomeCustomJailbreak" есть в special_instructions