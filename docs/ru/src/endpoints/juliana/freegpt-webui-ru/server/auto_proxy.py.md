# Модуль для автоматического обновления прокси-серверов

## Обзор

Модуль `auto_proxy.py` предназначен для автоматического получения, тестирования и обновления списка рабочих прокси-серверов. Он использует внешние API для получения списка прокси, проверяет их работоспособность и поддерживает актуальный список рабочих прокси для использования в других частях проекта.

## Подробней

Модуль решает задачу обеспечения доступа к внешним ресурсам через прокси-серверы, что может быть необходимо для обхода ограничений доступа, балансировки нагрузки или обеспечения анонимности. Он периодически обновляет список рабочих прокси, чтобы обеспечить стабильную работу системы.  Используется для бесперебойной работы `freegpt-webui-ru`.

## Функции

### `fetch_proxies`

**Назначение**: Получение списка прокси-серверов с сайта `proxyscrape.com`.

```python
def fetch_proxies():
    """Получает список прокси-серверов с proxyscrape.com.

    Returns:
        list: Список прокси-серверов в формате "IP:Port".
    """
    ...
```

**Возвращает**:
- `list`: Список прокси-серверов в формате "IP:Port".

**Как работает функция**:
- Функция отправляет GET-запрос на URL `https://www.proxy-list.download/api/v1/get?type=http`.
- Если запрос успешен (код ответа 200), функция возвращает список прокси-серверов, разделенных символами `\r\n`.
- Если запрос не успешен, функция выводит сообщение об ошибке и возвращает пустой список.

**Примеры**:
```python
proxies = fetch_proxies()
if proxies:
    print(f"Получено {len(proxies)} прокси-серверов.")
else:
    print("Не удалось получить список прокси-серверов.")
```

### `test_proxy`

**Назначение**: Проверка работоспособности заданного прокси-сервера с использованием тестового запроса.

```python
def test_proxy(proxy, prompt, timeout):
    """Проверяет заданный прокси-сервер с использованием указанного запроса и времени ожидания.

    Args:
        proxy (str): Прокси-сервер в формате "IP:Port".
        prompt (str): Тестовый запрос для проверки прокси.
        timeout (int): Максимальное время ожидания в секундах для теста.
    """
    ...
```

**Параметры**:
- `proxy` (str): Прокси-сервер в формате "IP:Port".
- `prompt` (str): Тестовый запрос для проверки прокси.
- `timeout` (int): Максимальное время ожидания в секундах для теста.

**Как работает функция**:

- Измеряет время от начала запроса до получения ответа.
- Если время ответа меньше заданного таймаута, прокси считается рабочим.
- В случае успешной проверки, добавляет прокси в глобальный список рабочих прокси (`working_proxies`) через вызов функции `add_working_proxy`.
- Если во время проверки происходит ошибка, функция её игнорирует.

**Примеры**:
```python
test_proxy("127.0.0.1:8080", "What is the capital of France?", 5)
```

### `add_working_proxy`

**Назначение**: Добавление рабочего прокси-сервера в глобальный список `working_proxies`.

```python
def add_working_proxy(proxy):
    """Добавляет рабочий прокси-сервер в глобальный список working_proxies.

    Args:
        proxy (str): Прокси-сервер в формате "IP:Port".
    """
    ...
```

**Параметры**:
- `proxy` (str): Прокси-сервер в формате "IP:Port".

**Как работает функция**:
- Добавляет прокси-сервер в глобальный список `working_proxies`.

**Примеры**:
```python
add_working_proxy("127.0.0.1:8080")
```

### `remove_proxy`

**Назначение**: Удаление прокси-сервера из глобального списка `working_proxies`.

```python
def remove_proxy(proxy):
    """Удаляет прокси-сервер из глобального списка working_proxies.

    Args:
        proxy (str): Прокси-сервер в формате "IP:Port".
    """
    ...
```

**Параметры**:
- `proxy` (str): Прокси-сервер в формате "IP:Port".

**Как работает функция**:
- Удаляет прокси-сервер из глобального списка `working_proxies`, если он там присутствует.

**Примеры**:
```python
remove_proxy("127.0.0.1:8080")
```

### `get_working_proxies`

**Назначение**: Получение и тестирование прокси-серверов, добавление рабочих прокси в глобальный список `working_proxies`.

```python
def get_working_proxies(prompt, timeout=5):
    """Получает и тестирует прокси-серверы, добавляя рабочие прокси в глобальный список working_proxies.

    Args:
        prompt (str): Тестовый запрос для проверки прокси.
        timeout (int, optional): Максимальное время ожидания в секундах для тестирования. По умолчанию 5.
    """
    ...
```

**Параметры**:
- `prompt` (str): Тестовый запрос для проверки прокси.
- `timeout` (int, optional): Максимальное время ожидания в секундах для тестирования. По умолчанию 5.

**Как работает функция**:
- Получает список прокси-серверов с помощью функции `fetch_proxies`.
- Для каждого прокси-сервера создает отдельный поток, в котором выполняется функция `test_proxy`.
- Ожидает завершения всех потоков с заданным таймаутом.

**Примеры**:
```python
get_working_proxies("What is the capital of France?", 5)
```

### `update_working_proxies`

**Назначение**: Непрерывное обновление глобального списка `working_proxies` рабочими прокси-серверами.

```python
def update_working_proxies():
    """Непрерывно обновляет глобальный список working_proxies рабочими прокси-серверами."""
    ...
```

**Как работает функция**:
- В бесконечном цикле:
    - Очищает глобальный список `working_proxies`.
    - Получает и тестирует прокси-серверы с помощью функции `get_working_proxies`.
    - Выводит сообщение "proxies updated".
    - Приостанавливает выполнение на 30 минут (1800 секунд).

**Примеры**:
```python
# Запуск в отдельном потоке для непрерывного обновления прокси
import threading
thread = threading.Thread(target=update_working_proxies)
thread.start()
```

### `get_random_proxy`

**Назначение**: Получение случайного рабочего прокси-сервера из глобального списка `working_proxies`.

```python
def get_random_proxy():
    """Получает случайный рабочий прокси-сервер из глобального списка working_proxies.

    Returns:
        str: Случайный рабочий прокси-сервер в формате "IP:Port".
    """
    ...
```

**Возвращает**:
- `str`: Случайный рабочий прокси-сервер в формате "IP:Port".

**Как работает функция**:
- Возвращает случайный элемент из глобального списка `working_proxies`.

**Примеры**:
```python
proxy = get_random_proxy()
if proxy:
    print(f"Случайный прокси: {proxy}")
else:
    print("Список рабочих прокси пуст.")