# Модуль backend.py

## Обзор

Модуль `backend.py` предоставляет API для взаимодействия с языковой моделью, такой как ChatGPT, с возможностью использования различных прокси и jailbreak инструкций. Он содержит класс `Backend_Api`, который обрабатывает запросы на генерацию ответов от модели, а также функции для построения сообщений, получения результатов поиска в интернете и управления потоковой передачей ответов.

## Подробнее

Модуль предназначен для интеграции с веб-интерфейсом и обеспечивает функциональность общения с языковой моделью через API. Он поддерживает использование автоматических прокси для обхода ограничений доступа и позволяет применять различные jailbreak инструкции для изменения поведения модели. Модуль также включает функции для получения результатов поиска в интернете и добавления их в контекст разговора.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` предоставляет API для взаимодействия с языковой моделью.

**Атрибуты**:
- `app`: Экземпляр Flask-приложения.
- `use_auto_proxy` (bool): Флаг, определяющий необходимость использования автоматических прокси.
- `routes` (dict): Словарь, содержащий маршруты API и соответствующие функции-обработчики.

**Методы**:
- `__init__(self, app, config: dict) -> None`: Инициализирует экземпляр класса `Backend_Api`.
- `_conversation(self)`: Обрабатывает запрос на генерацию ответа от языковой модели.

### `Backend_Api.__init__`

```python
def __init__(self, app, config: dict) -> None:
    """Инициализирует экземпляр класса Backend_Api.

    Args:
        app: Экземпляр Flask-приложения.
        config (dict): Словарь с настройками, включая флаг использования автоматических прокси.
    """
```

### `Backend_Api._conversation`

```python
def _conversation(self):
    """Обрабатывает запрос на генерацию ответа от языковой модели.

    Извлекает параметры запроса, строит контекст сообщения, генерирует ответ с использованием языковой модели и возвращает его в виде потока.
    В случае возникновения ошибки возвращает сообщение об ошибке.

    Returns:
        flask.Response: Потоковый ответ с данными от языковой модели или словарь с информацией об ошибке и кодом 400.

    Raises:
        Exception: Если во время обработки запроса возникает необработанная ошибка.
    """
```

## Функции

### `build_messages`

```python
def build_messages(jailbreak):
    """Создает список сообщений для отправки в языковую модель.

    Формирует контекст разговора, включая системное сообщение, историю разговора, результаты поиска в интернете и jailbreak инструкции.

    Args:
        jailbreak: Ключ jailbreak-инструкции.

    Returns:
        list: Список сообщений, готовых для отправки в языковую модель.
    """
```

### `fetch_search_results`

```python
def fetch_search_results(query):
    """Выполняет поиск в интернете и возвращает результаты в виде списка сообщений.

    Использует DuckDuckGo API для поиска информации в интернете на основе заданного запроса.

    Args:
        query: Поисковой запрос.

    Returns:
        list: Список сообщений с результатами поиска. Каждый результат содержит сниппет и ссылку на источник.
    """
```

### `generate_stream`

```python
def generate_stream(response, jailbreak):
    """Генерирует поток данных из ответа языковой модели.

    Обрабатывает ответ языковой модели и возвращает его в виде потока данных, учитывая jailbreak инструкции.

    Args:
        response: Ответ языковой модели.
        jailbreak: Ключ jailbreak-инструкции.

    Yields:
        str: Часть ответа языковой модели.
    """
```

### `response_jailbroken_success`

```python
def response_jailbroken_success(response: str) -> bool:
    """Проверяет, содержит ли ответ языковой модели признаки успешного применения jailbreak-инструкции.

    Args:
        response (str): Ответ языковой модели.

    Returns:
        bool: True, если ответ содержит признаки успешного применения jailbreak-инструкции, иначе False.
    """
```

### `response_jailbroken_failed`

```python
def response_jailbroken_failed(response):
    """Проверяет, содержит ли ответ языковой модели признаки неуспешного применения jailbreak-инструкции.

    Args:
        response: Ответ языковой модели.

    Returns:
        bool: True, если ответ содержит признаки неуспешного применения jailbreak-инструкции, иначе False.
    """
```

### `set_response_language`

```python
def set_response_language(prompt):
    """Определяет язык запроса и возвращает инструкцию для языковой модели.

    Использует Google Translate API для определения языка запроса и формирует инструкцию для языковой модели, указывающую, на каком языке следует отвечать.

    Args:
        prompt: Текст запроса.

    Returns:
        str: Инструкция для языковой модели, указывающая язык ответа.
    """
```

### `isJailbreak`

```python
def isJailbreak(jailbreak):
    """Извлекает jailbreak-инструкции из словаря.

    Args:
        jailbreak: Ключ jailbreak-инструкции.

    Returns:
        str | None: Jailbreak-инструкции, если найдены, иначе None.
    """