# Модуль `GetGpt.py`

## Обзор

Модуль предоставляет реализацию для взаимодействия с провайдером GetGpt, используя API `chat.getgpt.world`. Он включает функции для шифрования данных, создания запросов на завершение текста и обработки потоковых ответов.

## Подробней

Этот модуль предназначен для интеграции с `chat.getgpt.world` для генерации текста на основе модели `gpt-3.5-turbo`. Он использует шифрование AES для защиты передаваемых данных. Модуль поддерживает потоковую передачу ответов, что позволяет получать результаты по частям в реальном времени.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос на завершение текста к API `chat.getgpt.world`.

    Args:
        model (str): Название модели для использования.
        messages (list): Список сообщений для отправки в запросе.
        stream (bool): Флаг, указывающий, использовать ли потоковую передачу ответов.
        **kwargs: Дополнительные аргументы, такие как `frequency_penalty`, `max_tokens`, `presence_penalty`, `temperature` и `top_p`.

    Yields:
        str: Части сгенерированного текста из потокового ответа.

    Raises:
        requests.exceptions.RequestException: Если возникает ошибка при отправке запроса.
        json.JSONDecodeError: Если не удается декодировать JSON из ответа.

    Внутренние функции:
        encrypt(e: str) -> str: Шифрует данные с использованием AES.
        pad_data(data: bytes) -> bytes: Дополняет данные до размера блока AES.

    """
```

**Назначение**: Функция `_create_completion` отвечает за создание и отправку запроса к API `chat.getgpt.world` для генерации текста на основе предоставленных параметров. Она шифрует данные запроса, отправляет их и обрабатывает потоковый ответ, возвращая сгенерированный текст частями.

**Параметры**:
- `model` (str): Название модели, которую нужно использовать для генерации текста. В данном случае всегда используется `'gpt-3.5-turbo'`.
- `messages` (list): Список сообщений, которые формируют контекст для генерации текста. Каждое сообщение обычно содержит роль (например, `'user'` или `'assistant'`) и содержимое.
- `stream` (bool): Флаг, указывающий, следует ли использовать потоковый режим для получения ответа. Если `True`, ответ будет возвращаться частями по мере генерации.
- `**kwargs`: Дополнительные параметры, которые можно передать в запросе. К ним относятся:
    - `frequency_penalty` (float): Штраф за частоту использования определенных токенов.
    - `max_tokens` (int): Максимальное количество токенов в сгенерированном тексте.
    - `presence_penalty` (float): Штраф за наличие определенных токенов.
    - `temperature` (float): Контролирует случайность генерации текста.
    - `top_p` (float): Контролирует разнообразие генерируемого текста.

**Возвращает**:
- `Yields str`: Функция является генератором и возвращает части сгенерированного текста из потокового ответа. Каждая часть представляет собой строку.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Вызывается, если возникает ошибка при отправке HTTP-запроса к API `chat.getgpt.world`.
- `json.JSONDecodeError`: Вызывается, если не удается декодировать JSON из ответа API.

**Внутренние функции**:

#### `encrypt`

```python
def encrypt(e):
    """
    Шифрует данные с использованием AES.

    Args:
        e (str): Данные для шифрования.

    Returns:
        str: Зашифрованные данные в шестнадцатеричном представлении.
    """
```

**Назначение**: Функция `encrypt` шифрует предоставленные данные с использованием алгоритма AES (Advanced Encryption Standard) в режиме CBC (Cipher Block Chaining). Она генерирует случайные векторы инициализации (IV) и использует их для шифрования данных.

**Параметры**:
- `e` (str): Строка, содержащая данные, которые необходимо зашифровать.

**Возвращает**:
- `str`: Зашифрованные данные в виде шестнадцатеричной строки, к которой добавлены IV и ключ шифрования.

**Как работает функция**:
1. Генерирует случайную последовательность байтов `t` длиной 8 байт и кодирует её в UTF-8. Эта последовательность будет использоваться в качестве ключа шифрования.
2. Генерирует случайную последовательность байтов `n` длиной 8 байт и кодирует её в UTF-8. Эта последовательность будет использоваться в качестве вектора инициализации (IV) для режима CBC.
3. Кодирует входную строку `e` в байты, используя кодировку UTF-8.
4. Создает новый объект шифра AES в режиме CBC, используя ключ `t` и IV `n`.
5. Дополняет данные `r` до размера блока AES с помощью функции `pad_data`.
6. Шифрует дополненные данные с помощью созданного шифра.
7. Преобразует зашифрованные данные в шестнадцатеричную строку и объединяет её с ключом `t` и IV `n`.
8. Возвращает полученную строку.

#### `pad_data`

```python
def pad_data(data: bytes) -> bytes:
    """
    Дополняет данные до размера блока AES.

    Args:
        data (bytes): Данные для дополнения.

    Returns:
        bytes: Дополненные данные.
    """
```

**Назначение**: Функция `pad_data` дополняет входные данные до размера блока, необходимого для алгоритма AES. Это необходимо, потому что AES работает с блоками фиксированного размера.

**Параметры**:
- `data` (bytes): Байтовая строка, которую необходимо дополнить.

**Возвращает**:
- `bytes`: Дополненная байтовая строка.

**Как работает функция**:
1. Определяет размер блока AES (обычно 16 байт).
2. Вычисляет, сколько байтов необходимо добавить, чтобы длина данных стала кратна размеру блока.
3. Создает байтовую строку, состоящую из байтов, каждый из которых равен количеству добавленных байтов.
4. Добавляет эту строку в конец входных данных.
5. Возвращает дополненные данные.

**Как работает функция `_create_completion`**:

1. **Определяет заголовки запроса**:
   - Устанавливает заголовки `Content-Type`, `Referer` и `user-agent` для HTTP-запроса.
2. **Формирует данные запроса**:
   - Преобразует параметры запроса (сообщения, параметры генерации и т. д.) в JSON-строку.
3. **Шифрует данные**:
   - Вызывает функцию `encrypt` для шифрования JSON-строки с использованием AES.
4. **Отправляет запрос**:
   - Отправляет POST-запрос к API `chat.getgpt.world/api/chat/stream` с зашифрованными данными в теле запроса и установленными заголовками.
5. **Обрабатывает потоковый ответ**:
   - Итерируется по строкам потокового ответа.
   - Для каждой строки проверяет, содержит ли она `'content'`.
   - Если строка содержит `'content'`, декодирует JSON из строки и извлекает сгенерированный текст.
   - Возвращает часть сгенерированного текста с помощью `yield`.

**Примеры**:

```python
# Пример вызова функции _create_completion
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Напиши короткий рассказ о космосе."}]
stream = True
kwargs = {"max_tokens": 100}

for chunk in _create_completion(model, messages, stream, **kwargs):
    print(chunk, end="")
```

## Переменные

### `url`

```python
url = 'https://chat.getgpt.world/'
```

- **Назначение**: URL-адрес API `chat.getgpt.world`.

### `model`

```python
model = ['gpt-3.5-turbo']
```

- **Назначение**: Список поддерживаемых моделей. В данном случае поддерживается только `gpt-3.5-turbo`.

### `supports_stream`

```python
supports_stream = True
```

- **Назначение**: Флаг, указывающий, поддерживает ли провайдер потоковую передачу ответов.

### `needs_auth`

```python
needs_auth = False
```

- **Назначение**: Флаг, указывающий, требуется ли аутентификация для использования провайдера.

### `params`

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    '(%s)' % ', '.join(\
        [f'{name}: {get_type_hints(_create_completion)[name].__name__}' for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])
```

- **Назначение**: Строка, содержащая информацию о поддерживаемых параметрах функции `_create_completion`.

```