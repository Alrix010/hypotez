# Модуль HuggingFaceMedia

## Обзор

Модуль `HuggingFaceMedia` предоставляет асинхронные инструменты для генерации изображений и видео с использованием моделей Hugging Face. Он поддерживает различные API-ключи и провайдеры, такие как Replicate, Together и hf-inference. Модуль позволяет генерировать медиа контент на основе текстовых запросов, а также управлять параметрами генерации, такими как соотношение сторон, разрешение и количество шагов.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими функциональности генерации мультимедийного контента. Он использует асинхронные запросы для взаимодействия с API Hugging Face и предоставляет гибкий интерфейс для настройки параметров генерации. Модуль поддерживает различные задачи, такие как преобразование текста в изображение и преобразование текста в видео, что делает его универсальным инструментом для работы с мультимедийными данными.

## Классы

### `HuggingFaceMedia`

**Описание**: Класс `HuggingFaceMedia` является асинхронным провайдером для генерации изображений и видео с использованием моделей Hugging Face.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера ("HuggingFace (Image/Video Generation)").
- `parent` (str): Родительский провайдер ("HuggingFace").
- `url` (str): URL Hugging Face ("https://huggingface.co").
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (True).
- `tasks` (list[str]): Список поддерживаемых задач (["text-to-image", "text-to-video"]).
- `provider_mapping` (dict[str, dict]): Словарь соответствия моделей провайдерам.
- `task_mapping` (dict[str, str]): Словарь соответствия моделей задачам.
- `models` (list[str]): Список доступных моделей.
- `image_models` (list[str]): Список моделей для генерации изображений.
- `video_models` (list[str]): Список моделей для генерации видео.

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `get_mapping()`: Возвращает словарь соответствия моделей провайдерам.
- `create_async_generator()`: Создает асинхронный генератор для выполнения задачи генерации.

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs) -> list[str]:
        """
        Возвращает список доступных моделей для генерации изображений и видео из Hugging Face.

        Args:
            **kwargs: Дополнительные аргументы (не используются).

        Returns:
            list[str]: Список доступных моделей.

        Raises:
            Exception: В случае ошибки при получении списка моделей.
        """
```

### `get_mapping`

```python
    @classmethod
    async def get_mapping(cls, model: str, api_key: str = None):
        """
        Асинхронно получает соответствие моделей провайдерам из Hugging Face.

        Args:
            model (str): Имя модели.
            api_key (str, optional): API-ключ для Hugging Face. По умолчанию `None`.

        Returns:
            dict: Словарь соответствия моделей провайдерам.

        Raises:
            HTTPError: В случае ошибки при получении соответствия.
        """
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        api_key: str = None,
        extra_data: dict = {},
        prompt: str = None,
        proxy: str = None,
        timeout: int = 0,
        # Video & Image Generation
        n: int = 1,
        aspect_ratio: str = None,
        # Only for Image Generation
        height: int = None,
        width: int = None,
        # Video Generation
        resolution: str = "480p",
        **kwargs
    ):
        """
        Создает асинхронный генератор для выполнения задачи генерации изображений или видео.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений для формирования запроса.
            api_key (str, optional): API-ключ для Hugging Face. По умолчанию `None`.
            extra_data (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
            prompt (str, optional): Текстовый запрос. По умолчанию `None`.
            proxy (str, optional): Прокси-сервер. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса. По умолчанию `0`.
            n (int, optional): Количество генерируемых медиафайлов. По умолчанию `1`.
            aspect_ratio (str, optional): Соотношение сторон. По умолчанию `None`.
            height (int, optional): Высота изображения. По умолчанию `None`.
            width (int, optional): Ширина изображения. По умолчанию `None`.
            resolution (str, optional): Разрешение видео. По умолчанию `"480p"`.
            **kwargs: Дополнительные аргументы.

        Yields:
            ProviderInfo: Информация о провайдере.
            ImageResponse | VideoResponse | Reasoning: Ответ с медиафайлом или информацией о процессе.

        Raises:
            ModelNotSupportedError: Если модель не поддерживается.
            HTTPError: В случае ошибки при выполнении запроса.
        """
```

## Функции

### `get_models`

**Назначение**: Функция `get_models` получает список доступных моделей для генерации изображений и видео из Hugging Face.

**Параметры**:
- `cls`: Ссылка на класс `HuggingFaceMedia`.
- `**kwargs`: Дополнительные аргументы, которые могут быть переданы функции. В данном случае не используются.

**Возвращает**:
- `list[str]`: Список доступных моделей для генерации изображений и видео.

**Как работает функция**:

1. **Проверяет наличие моделей**:
   - Функция проверяет, был ли уже получен список моделей ранее. Если `cls.models` пуст, то выполняется запрос к API Hugging Face для получения списка.
2. **Получает список моделей из API**:
   - Отправляет GET-запрос к API Hugging Face для получения списка моделей, поддерживающих вывод и имеющих статус "live" для задач `text-to-image` и `text-to-video`.
3. **Обрабатывает ответ API**:
   - Если запрос успешен, обрабатывает JSON-ответ, чтобы извлечь идентификаторы моделей и соответствующие данные провайдеров.
   - Строит словари `providers` и `task_mapping` для хранения информации о провайдерах и задачах для каждой модели.
4. **Формирует список моделей**:
   - Создает список `new_models`, содержащий идентификаторы моделей и имена провайдеров.
   - Добавляет модели для генерации видео в начало списка `prepend_models`, чтобы они были в приоритете.
5. **Обновляет атрибуты класса**:
   - Обновляет атрибуты класса `cls.models`, `cls.image_models` и `cls.video_models` на основе полученных данных.
6. **Обрабатывает ошибки**:
   - Если запрос к API завершается с ошибкой, устанавливает `cls.models` в пустой список.
7. **Возвращает список моделей**:
   - Возвращает список доступных моделей.

**ASCII flowchart**:

```
    A [Проверка cls.models]
    |
    B [Запрос к API Hugging Face]
    |
    C [Обработка ответа API]
    |
    D [Формирование списков моделей]
    |
    E [Обновление атрибутов класса]
    |
    F [Возврат списка моделей]
```

**Примеры**:

```python
# Пример вызова функции get_models
models = HuggingFaceMedia.get_models()
print(models)
# Вывод: ['model1', 'model2:provider1', 'model3', ...]
```

### `get_mapping`

**Назначение**: Функция `get_mapping` асинхронно получает соответствие моделей провайдерам из Hugging Face.

**Параметры**:
- `cls`: Ссылка на класс `HuggingFaceMedia`.
- `model` (str): Имя модели, для которой нужно получить соответствие.
- `api_key` (str, optional): API-ключ для Hugging Face. По умолчанию `None`.

**Возвращает**:
- `dict`: Словарь соответствия моделей провайдерам, где ключи - идентификаторы провайдеров, а значения - соответствующие данные.

**Как работает функция**:

1. **Проверяет наличие соответствия в кэше**:
   - Функция сначала проверяет, есть ли уже соответствие для данной модели в словаре `cls.provider_mapping`. Если есть, возвращает его из кэша.
2. **Формирует заголовки запроса**:
   - Создает словарь `headers` с необходимыми заголовками, включая `Content-Type` и, при наличии `api_key`, заголовок `Authorization`.
3. **Выполняет асинхронный GET-запрос к API Hugging Face**:
   - Использует `StreamSession` для выполнения асинхронного GET-запроса к API Hugging Face, чтобы получить информацию о модели и ее провайдерах.
4. **Обрабатывает ответ API**:
   - Проверяет статус ответа и вызывает `raise_for_status`, чтобы вызвать исключение в случае ошибки.
   - Извлекает данные о модели из JSON-ответа.
5. **Формирует словарь соответствия**:
   - Создает словарь `cls.provider_mapping[model]`, содержащий только те провайдеры, у которых статус "live".
6. **Возвращает словарь соответствия**:
   - Возвращает словарь соответствия моделей провайдерам.

**ASCII flowchart**:

```
    A [Проверка соответствия в кэше]
    |
    B [Формирование заголовков запроса]
    |
    C [Асинхронный GET-запрос к API Hugging Face]
    |
    D [Обработка ответа API]
    |
    E [Формирование словаря соответствия]
    |
    F [Возврат словаря соответствия]
```

**Примеры**:

```python
# Пример вызова функции get_mapping
import asyncio

async def main():
    mapping = await HuggingFaceMedia.get_mapping(model="stabilityai/stable-diffusion-2")
    print(mapping)

asyncio.run(main())
# Вывод: {'replicate': {'status': 'live', 'task': 'text-to-image', ...}, ...}
```

### `create_async_generator`

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для выполнения задачи генерации изображений или видео.

**Параметры**:
- `cls`: Ссылка на класс `HuggingFaceMedia`.
- `model` (str): Имя модели для генерации. Может включать имя провайдера через `:`.
- `messages` (Messages): Список сообщений для формирования запроса.
- `api_key` (str, optional): API-ключ для Hugging Face. По умолчанию `None`.
- `extra_data` (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
- `prompt` (str, optional): Текстовый запрос. По умолчанию `None`.
- `proxy` (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `0`.
- `n` (int, optional): Количество генерируемых медиафайлов. По умолчанию `1`.
- `aspect_ratio` (str, optional): Соотношение сторон для генерируемых изображений/видео. По умолчанию `None`.
- `height` (int, optional): Высота генерируемого изображения. По умолчанию `None`.
- `width` (int, optional): Ширина генерируемого изображения. По умолчанию `None`.
- `resolution` (str, optional): Разрешение генерируемого видео. По умолчанию `"480p"`.
- `**kwargs`: Дополнительные аргументы, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncGenerator[ProviderInfo | ImageResponse | VideoResponse | Reasoning, None]`: Асинхронный генератор, который выдает информацию о провайдере, медиа-ответы (изображения или видео) и информацию о процессе генерации.

**Как работает функция**:

1. **Выбор провайдера и модели**:
   - Определяет выбранного провайдера и модель. Если провайдер указан в имени модели (через `:`), то они разделяются. Если модель не указана, выбирается первая модель из списка доступных моделей.
2. **Форматирование запроса**:
   - Форматирует текстовый запрос с использованием функции `format_image_prompt`.
3. **Получение соответствия модели и провайдера**:
   - Получает соответствие модели и провайдера с использованием функции `cls.get_mapping`.
4. **Определение заголовков запроса**:
   - Определяет заголовки запроса, включая `Accept-Encoding` и `Content-Type`. Если `api_key` предоставлен, добавляет заголовок `Authorization`.
5. **Асинхронная генерация медиафайлов**:
   - Определяет асинхронную функцию `generate`, которая выполняет генерацию медиафайлов для каждого провайдера.
   - Внутри функции `generate`:
     - Выбирает провайдера, если он указан.
     - Формирует информацию о провайдере (`provider_info`).
     - Определяет базовый URL для API провайдера.
     - Определяет задачу (генерация изображения или видео).
     - Формирует URL для запроса к API провайдера.
     - Формирует данные для запроса, включая текстовый запрос и дополнительные параметры.
     - Выполняет асинхронный POST-запрос к API провайдера.
     - Обрабатывает ответ от API провайдера:
       - В случае ошибок (400, 401, 402) продолжает выполнение цикла, чтобы попробовать другого провайдера.
       - В случае ошибки 404 вызывает исключение `ModelNotSupportedError`.
       - При успешном ответе обрабатывает результат и возвращает `ImageResponse` или `VideoResponse`.
6. **Запуск нескольких задач генерации**:
   - Запускает несколько асинхронных задач генерации (`n` задач) и управляет их выполнением.
7. **Ожидание завершения задач**:
   - Ожидает завершения всех задач генерации и выдает информацию о процессе генерации и результатах.

**ASCII flowchart**:

```
    A [Выбор провайдера и модели]
    |
    B [Форматирование запроса]
    |
    C [Получение соответствия модели и провайдера]
    |
    D [Определение заголовков запроса]
    |
    E [Асинхронная генерация медиафайлов (generate)]
    |   
    F [Запуск задач генерации]
    |
    G [Ожидание завершения задач]
    |
    H [Выдача результатов]
```

**Примеры**:

```python
# Пример асинхронного вызова функции create_async_generator
import asyncio
from src.providers.types import Messages

async def main():
    messages = Messages(prompt="A cat in space")
    generator = HuggingFaceMedia.create_async_generator(
        model="stabilityai/stable-diffusion-2",
        messages=messages,
        n=1
    )
    async for item in generator:
        print(item)

asyncio.run(main())
# Вывод: (ProviderInfo(...), ImageResponse(...))
```