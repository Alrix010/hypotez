# Модуль HuggingFaceAPI

## Обзор

Модуль `HuggingFaceAPI` предназначен для взаимодействия с API Hugging Face для генерации текста. Он наследует функциональность от класса `OpenaiTemplate` и предоставляет методы для получения моделей, создания асинхронных генераторов и обработки сообщений.

## Подробнее

Этот модуль является частью проекта `hypotez` и обеспечивает интеграцию с платформой Hugging Face для выполнения задач, связанных с генерацией текста. Он использует API Hugging Face для доступа к различным моделям и выполнения запросов.

## Классы

### `HuggingFaceAPI`

**Описание**: Класс для взаимодействия с API Hugging Face для генерации текста.
**Наследует**: `OpenaiTemplate`

**Атрибуты**:
- `label` (str): Метка провайдера "HuggingFace (Text Generation)".
- `parent` (str): Родительский провайдер "HuggingFace".
- `url` (str): URL API Hugging Face.
- `api_base` (str): Базовый URL API Hugging Face.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `True`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (в данном случае `True`).
- `default_model` (str): Модель по умолчанию (`default_llama_model`).
- `default_vision_model` (str): Модель для работы с изображениями по умолчанию (`default_vision_model`).
- `vision_models` (list[str]): Список моделей для работы с изображениями.
- `model_aliases` (dict[str, str]): Словарь с псевдонимами моделей.
- `fallback_models` (list[str]): Список запасных моделей.
- `provider_mapping` (dict[str, dict]): Словарь с соответствиями моделей и провайдеров.

**Принцип работы**:

Класс `HuggingFaceAPI` предназначен для взаимодействия с API Hugging Face для генерации текста. Он наследует функциональность от класса `OpenaiTemplate` и предоставляет методы для получения моделей, создания асинхронных генераторов и обработки сообщений.

```python
   provider_mapping: dict[str, dict] = {
        "google/gemma-3-27b-it": {
            "hf-inference/models/google/gemma-3-27b-it": {
                "task": "conversational",
                "providerId": "google/gemma-3-27b-it"}}}
```

Это внутренний словарь, который содержит соответствия между различными моделями Hugging Face и их конфигурациями. Ключи словаря представляют собой идентификаторы моделей (например, `"google/gemma-3-27b-it"`), а значения - это словари с информацией о задаче (`"task"`) и идентификаторе провайдера (`"providerId"`).

## Методы класса

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str, **kwargs) -> str:
        """ Функция возвращает имя модели.
        Args:
            model (str): Имя модели.
            **kwargs: Дополнительные параметры.

        Returns:
            str: Имя модели.

        Raises:
            ModelNotSupportedError: Если модель не поддерживается.
        """
```

**Назначение**: Возвращает имя модели, используя родительский метод `get_model`, или возвращает имя модели, если она не поддерживается.

**Параметры**:
- `model` (str): Имя модели.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `str`: Имя модели.

**Вызывает исключения**:
- `ModelNotSupportedError`: Если модель не поддерживается.

**Как работает функция**:
Функция пытается получить модель, используя метод `get_model` родительского класса `OpenaiTemplate`. Если возникает исключение `ModelNotSupportedError`, функция возвращает исходное имя модели.

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs) -> list[str]:
        """ Функция возвращает список доступных моделей.

        Args:
            **kwargs: Дополнительные параметры.

        Returns:
            list[str]: Список доступных моделей.
        """
```

**Назначение**: Возвращает список доступных моделей, получая их из API Hugging Face или используя запасные модели.

**Параметры**:
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `list[str]`: Список доступных моделей.

**Как работает функция**:
Функция сначала проверяет, был ли уже получен список моделей. Если нет, она делает запрос к API Hugging Face для получения списка моделей, у которых статус "live" и задача "conversational". Если запрос успешен, функция формирует список моделей из полученных данных и добавляет модели из `cls.provider_mapping`. Если запрос не успешен, функция использует `cls.fallback_models` в качестве списка моделей.

### `get_mapping`

```python
    @classmethod
    async def get_mapping(cls, model: str, api_key: str = None):
        """ Функция возвращает соответствие модели и провайдера.

        Args:
            model (str): Имя модели.
            api_key (str, optional): API ключ. По умолчанию `None`.

        Returns:
            dict: Соответствие модели и провайдера.
        """
```

**Назначение**: Возвращает соответствие модели и провайдера, получая его из `cls.provider_mapping` или запрашивая из API Hugging Face.

**Параметры**:
- `model` (str): Имя модели.
- `api_key` (str, optional): API ключ. По умолчанию `None`.

**Возвращает**:
- `dict`: Соответствие модели и провайдера.

**Как работает функция**:
Функция сначала проверяет, есть ли соответствие для данной модели в `cls.provider_mapping`. Если есть, функция возвращает это соответствие. Если нет, функция делает асинхронный запрос к API Hugging Face для получения соответствия модели и провайдера. Полученные данные сохраняются в `cls.provider_mapping` и возвращаются.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        api_base: str = None,
        api_key: str = None,
        max_tokens: int = 2048,
        max_inputs_lenght: int = 10000,
        media: MediaListType = None,
        **kwargs
    ):
        """ Функция создает асинхронный генератор для получения чанков текста от API Hugging Face.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений.
            api_base (str, optional): Базовый URL API. По умолчанию `None`.
            api_key (str, optional): API ключ. По умолчанию `None`.
            max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 2048.
            max_inputs_lenght (int, optional): Максимальная длина входных данных. По умолчанию 10000.
            media (MediaListType, optional): Список медиафайлов. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Yields:
            ProviderInfo | str: Информация о провайдере или чанк текста.

        Raises:
            ModelNotSupportedError: Если модель не поддерживается.
            PaymentRequiredError: Если требуется оплата.
        """
```

**Назначение**: Создает асинхронный генератор для получения чанков текста от API Hugging Face.

**Параметры**:
- `model` (str): Имя модели.
- `messages` (Messages): Список сообщений.
- `api_base` (str, optional): Базовый URL API. По умолчанию `None`.
- `api_key` (str, optional): API ключ. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию 2048.
- `max_inputs_lenght` (int, optional): Максимальная длина входных данных. По умолчанию 10000.
- `media` (MediaListType, optional): Список медиафайлов. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `ProviderInfo | str`: Информация о провайдере или чанк текста.

**Вызывает исключения**:
- `ModelNotSupportedError`: Если модель не поддерживается.
- `PaymentRequiredError`: Если требуется оплата.

**Как работает функция**:
Функция сначала получает модель и соответствие провайдера для данной модели. Если соответствие не найдено, выбрасывается исключение `ModelNotSupportedError`. Затем функция перебирает провайдеров и пытается создать асинхронный генератор, используя метод `create_async_generator` родительского класса `OpenaiTemplate`. Если возникает исключение `PaymentRequiredError`, функция продолжает перебор провайдеров. Если все провайдеры возвращают `PaymentRequiredError`, выбрасывается последнее исключение.

## Функции

### `calculate_lenght`

```python
def calculate_lenght(messages: Messages) -> int:
    """ Функция вычисляет длину сообщений.

    Args:
        messages (Messages): Список сообщений.

    Returns:
        int: Длина сообщений.
    """
```

**Назначение**: Вычисляет длину списка сообщений.

**Параметры**:
- `messages` (Messages): Список сообщений.

**Возвращает**:
- `int`: Длина сообщений.

**Как работает функция**:
Функция вычисляет длину списка сообщений, суммируя длину содержимого каждого сообщения и добавляя 16 к каждому сообщению.