# Модуль Cloudflare

## Обзор

Модуль `Cloudflare` предоставляет асинхронный интерфейс для взаимодействия с AI Cloudflare. Он позволяет генерировать текст на основе предоставленных сообщений, используя различные модели, поддерживаемые Cloudflare. Модуль поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробнее

Модуль предназначен для использования в асинхронных приложениях. Он использует `aiohttp` для выполнения HTTP-запросов и предоставляет класс `Cloudflare`, который наследуется от `AsyncGeneratorProvider`, `ProviderModelMixin` и `AuthFileMixin`. Это обеспечивает возможность использования прокси, управления моделями и аутентификации через файлы.
В модуле реализована поддержка потоковой передачи ответов от Cloudflare AI, что позволяет получать результаты генерации текста в режиме реального времени.
В случае ошибок при запросах к API Cloudflare, модуль обрабатывает исключения и регистрирует их в лог.

## Классы

### `Cloudflare`

**Описание**: Класс для взаимодействия с AI Cloudflare. Поддерживает асинхронную генерацию текста, потоковую передачу данных и управление моделями.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для управления моделями.
- `AuthFileMixin`: Добавляет возможность аутентификации через файлы.

**Атрибуты**:
- `label` (str): Метка провайдера "Cloudflare AI".
- `url` (str): URL главной страницы Cloudflare AI "https://playground.ai.cloudflare.com".
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование headless-браузера (True).
- `api_endpoint` (str): URL API для запросов на генерацию текста "https://playground.ai.cloudflare.com/api/inference".
- `models_url` (str): URL для получения списка доступных моделей "https://playground.ai.cloudflare.com/api/models".
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (True).
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (True).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (True).
- `default_model` (str): Модель по умолчанию "@cf/meta/llama-3.3-70b-instruct-fp8-fast".
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `_args` (dict): Аргументы для HTTP-запросов.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `create_async_generator()`: Создает асинхронный генератор для генерации текста.

## Методы класса

### `get_models`

```python
    @classmethod
    def get_models(cls) -> str:
        """ Получает список доступных моделей от Cloudflare AI.

        Функция выполняет HTTP-запрос к API Cloudflare для получения списка доступных моделей.
        Если список моделей уже был получен ранее, функция возвращает кэшированный список.

        Returns:
            str: Список доступных моделей.

        
        - Проверяется, если список моделей (`cls.models`) уже заполнен. Если да, то он возвращается.
        - Проверяется, если аргументы (`cls._args`) для HTTP-запросов еще не определены.
          Если аргументы не определены, происходит следующее:
            - Проверяется наличие `nodriver`. Если он доступен, асинхронно извлекаются аргументы из URL (`cls.url`).
            - Если `nodriver` недоступен, проверяется наличие `curl_cffi`. Если он недоступен, возвращается текущий список моделей.
            - Если `curl_cffi` доступен, устанавливаются стандартные заголовки и куки.
        - С использованием сессии (`Session`) выполняется GET-запрос к URL списка моделей (`cls.models_url`).
        - Куки объединяются для дальнейших запросов.
        - Проверяется статус ответа, и в случае ошибки возвращается текущий список моделей.
        - Извлекается JSON-данные из ответа и заполняется список моделей (`cls.models`) на основе поля "name" в полученных данных.
        - Возвращается список моделей.
        """
```

**Примеры**:

```python
models = Cloudflare.get_models()
print(models)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(\
        cls,\
        model: str,\
        messages: Messages,\
        proxy: str = None,\
        max_tokens: int = 2048,\
        cookies: Cookies = None,\
        timeout: int = 300,\
        **kwargs\
    ) -> AsyncResult:
        """ Создает асинхронный генератор для генерации текста с использованием AI Cloudflare.

        Функция создает и возвращает асинхронный генератор, который отправляет запросы к API Cloudflare
        для генерации текста на основе предоставленных сообщений.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 2048.
            cookies (Cookies, optional): Куки для отправки в API. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию 300.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий сгенерированный текст.

        Raises:
            ResponseStatusError: Если возникает ошибка HTTP при запросе к API.
            ModelNotFoundError: Если указанная модель не найдена.

        
        - Определяется местоположение файла кэша для хранения аргументов HTTP-запросов.
        - Проверяется, если аргументы HTTP-запросов (`cls._args`) еще не определены.
          Если аргументы не определены, происходит следующее:
            - Проверяется, если файл кэша существует. Если да, аргументы загружаются из файла.
            - Если файл кэша не существует, проверяется наличие `nodriver`.
              Если `nodriver` доступен, асинхронно извлекаются аргументы из URL (`cls.url`) с использованием прокси, куки и времени ожидания.
            - Если `nodriver` недоступен, устанавливаются стандартные заголовки и куки.
        - Извлекается модель с использованием псевдонимов, если это необходимо.
        - Формируется словарь данных (`data`) для отправки в API, включая сообщения, модель, максимальное количество токенов и флаг потоковой передачи.
          Сообщения преобразуются в формат, требуемый API Cloudflare.
        - С использованием асинхронной сессии (`StreamSession`) выполняется POST-запрос к API Cloudflare (`cls.api_endpoint`) с JSON-данными.
        - Куки объединяются для дальнейших запросов.
        - Проверяется статус ответа, и в случае ошибки аргументы HTTP-запросов сбрасываются, файл кэша удаляется, и вызывается исключение `ResponseStatusError`.
        - Итерируется по строкам в ответе:
          - Если строка начинается с `b'0:'`, она интерпретируется как JSON-данные и извлекается полезная нагрузка.
          - Если строка начинается с `b'e:'`, она интерпретируется как JSON-данные, содержащие информацию об использовании и причине завершения, и извлекаются соответствующие значения.
        - После завершения итерации аргументы HTTP-запросов сохраняются в файле кэша.
        """
```

**Примеры**:

```python
async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for message in Cloudflare.create_async_generator(model="@cf/meta/llama-3.3-70b-instruct-fp8-fast", messages=messages):
        print(message)

asyncio.run(main())
```

## Параметры класса

- `label` (str): Метка провайдера "Cloudflare AI".
- `url` (str): URL главной страницы Cloudflare AI "https://playground.ai.cloudflare.com".
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование headless-браузера (True).
- `api_endpoint` (str): URL API для запросов на генерацию текста "https://playground.ai.cloudflare.com/api/inference".
- `models_url` (str): URL для получения списка доступных моделей "https://playground.ai.cloudflare.com/api/models".
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (True).
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (True).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (True).
- `default_model` (str): Модель по умолчанию "@cf/meta/llama-3.3-70b-instruct-fp8-fast".
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `_args` (dict): Аргументы для HTTP-запросов.