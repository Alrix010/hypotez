# Модуль для работы с Hailuo AI
=================================================

Модуль предназначен для асинхронного взаимодействия с сервисом Hailuo AI.
Он включает в себя функциональность для аутентификации, создания бесед и получения ответов от AI-модели.

## Обзор

Данный модуль обеспечивает интеграцию с сервисом Hailuo AI, предоставляя асинхронные инструменты для аутентификации, создания диалогов и обмена сообщениями с AI-моделью. Он поддерживает потоковую передачу данных и использует `aiohttp` для асинхронных HTTP-запросов. Модуль также включает механизмы для обработки ошибок и логирования.

## Подробней

Этот модуль позволяет взаимодействовать с Hailuo AI, используя асинхронные запросы. Он поддерживает аутентификацию через `AsyncAuthedProvider` и предоставляет методы для создания и ведения бесед. Основной функциональностью является отправка сообщений и получение потоковых ответов от AI-модели. Модуль также умеет обрабатывать ошибки и логировать их с использованием модуля `src.logger`.

## Классы

### `Conversation`

**Описание**: Класс представляет собой структуру для хранения информации о текущем диалоге с Hailuo AI.

**Атрибуты**:
- `token` (str): Токен аутентификации.
- `chatID` (str): Идентификатор чата.
- `characterID` (str, optional): Идентификатор персонажа. По умолчанию равен 1.

### `HailuoAI`

**Описание**: Класс реализует асинхронного провайдера для взаимодействия с Hailuo AI.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает асинхронную аутентификацию.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера ("Hailuo AI").
- `url` (str): URL сервиса ("https://www.hailuo.ai").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование без драйвера (True).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи (True).
- `default_model` (str): Модель по умолчанию ("MiniMax").

**Методы**:
- `on_auth_async`: Асинхронный метод для аутентификации.
- `create_authed`: Асинхронный метод для создания аутентифицированного запроса.

## Функции

### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
    """
    Асинхронно выполняет процесс аутентификации для доступа к Hailuo AI.

    Args:
        proxy (str, optional): URL прокси-сервера для использования при подключении. По умолчанию `None`.
        **kwargs: Дополнительные аргументы, которые могут потребоваться для процесса аутентификации.

    Returns:
        AsyncIterator: Асинхронный итератор, возвращающий результаты аутентификации, такие как URL для логина и токены.

    Raises:
        Exception: Если возникает ошибка при получении данных для аутентификации.

    """
    ...
```

**Назначение**:
Выполняет процесс аутентификации для доступа к Hailuo AI.

**Параметры**:
- `proxy` (str, optional): URL прокси-сервера для использования при подключении. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, которые могут потребоваться для процесса аутентификации.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий результаты аутентификации, такие как URL для логина и токены.

**Как работает функция**:

1. **Получение URL для логина**:
   - Пытается получить URL для логина из переменной окружения `G4F_LOGIN_URL`.
   - Если URL найден, он возвращается как `RequestLogin`.
2. **Аутентификация через браузер**:
   - Получает аргументы из браузера, используя `get_args_from_nodriver`.
   - Вызывает функцию `get_browser_callback` для получения результатов аутентификации.
3. **Возврат результатов**:
   - Возвращает результаты аутентификации в виде `AuthResult`, содержащего необходимые данные для дальнейших запросов.

```
A: Получение URL для логина
|
B: Аутентификация через браузер
|
C: Возврат результатов
```

**Примеры**:

```python
async for result in HailuoAI.on_auth_async():
    print(result)
```

### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    return_conversation: bool = False,
    conversation: Conversation = None,
    **kwargs
) -> AsyncResult:
    """
    Создает аутентифицированный запрос к Hailuo AI для получения ответа на заданные сообщения.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в Hailuo AI.
        auth_result (AuthResult): Результат аутентификации, содержащий необходимые токены и параметры.
        return_conversation (bool, optional): Флаг, указывающий, нужно ли возвращать объект Conversation. По умолчанию `False`.
        conversation (Conversation, optional): Объект Conversation, содержащий информацию о текущем диалоге. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий части ответа от Hailuo AI.

    Raises:
        Exception: Если возникает ошибка при отправке запроса или обработке ответа от Hailuo AI.

    """
    ...
```

**Назначение**:
Создает аутентифицированный запрос к Hailuo AI для получения ответа на заданные сообщения.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в Hailuo AI.
- `auth_result` (AuthResult): Результат аутентификации, содержащий необходимые токены и параметры.
- `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект `Conversation`. По умолчанию `False`.
- `conversation` (Conversation, optional): Объект `Conversation`, содержащий информацию о текущем диалоге. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий части ответа от Hailuo AI.

**Как работает функция**:

1. **Подготовка данных**:
   - Извлекает необходимые параметры из `auth_result`.
   - Формирует данные формы для отправки запроса, включая `characterID`, `msgContent`, `chatID`, и `searchMode`.
2. **Отправка запроса**:
   - Создает асинхронную сессию `ClientSession` с полученными параметрами.
   - Отправляет `POST`-запрос к Hailuo AI с данными формы и заголовками, содержащими токен и `yy`.
3. **Обработка ответа**:
   - Читает ответ построчно, обрабатывая события `event`.
   - Если `event` равен `close_chunk`, завершает чтение.
   - Если `event` равен `send_result`, извлекает заголовок чата и информацию о чате.
   - Если `event` равен `message_result`, извлекает контент сообщения и возвращает его части.

```
A: Подготовка данных
|
B: Отправка запроса
|
C: Обработка ответа
```

**Примеры**:

```python
auth_result = await HailuoAI.on_auth_async().__anext__()
async for response in HailuoAI.create_authed(
    model="MiniMax",
    messages=[{"role": "user", "content": "Hello"}],
    auth_result=auth_result,
    return_conversation=True
):
    print(response)