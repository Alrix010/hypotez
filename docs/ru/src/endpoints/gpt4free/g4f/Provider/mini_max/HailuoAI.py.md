# Модуль `HailuoAI.py`

## Обзор

Модуль `HailuoAI.py` предназначен для взаимодействия с сервисом Hailuo AI, предоставляющим доступ к моделям MiniMax. Он обеспечивает асинхронную аутентификацию и обмен сообщениями с использованием веб-сокетов. Модуль поддерживает потоковую передачу данных и предназначен для использования в проекте `hypotez`.

## Подробней

Модуль включает в себя классы для аутентификации, управления разговорами и обмена сообщениями с сервером Hailuo AI. Он использует асинхронные запросы для обеспечения неблокирующей работы. Для аутентификации используется получение данных из браузера, что позволяет обходить стандартные методы защиты.

## Классы

### `Conversation`

**Описание**: Класс предназначен для хранения информации о текущем разговоре с Hailuo AI.

**Атрибуты**:
- `token` (str): Токен аутентификации.
- `chatID` (str): Идентификатор чата.
- `characterID` (str, optional): Идентификатор персонажа. По умолчанию равен 1.

### `HailuoAI`

**Описание**: Класс реализует асинхронное взаимодействие с Hailuo AI, включая аутентификацию и обмен сообщениями.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает асинхронную аутентификацию.
- `ProviderModelMixin`: Предоставляет функциональность для выбора и управления моделями.

**Атрибуты**:
- `label` (str): Метка провайдера ("Hailuo AI").
- `url` (str): URL сервиса ("https://www.hailuo.ai").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование без драйвера (True).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (True).
- `default_model` (str): Модель по умолчанию ("MiniMax").

## Методы класса `HailuoAI`

### `on_auth_async`

```python
    @classmethod
    async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
        """Асинхронно выполняет процесс аутентификации.

        Args:
            proxy (str, optional): Прокси-сервер для использования при аутентификации. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncIterator: Асинхронный итератор, возвращающий результаты аутентификации.

        Raises:
            Exception: Если возникает ошибка во время аутентификации.
        """
```

**Назначение**: Метод выполняет асинхронную аутентификацию, получая необходимые данные через взаимодействие с браузером.

**Параметры**:
- `proxy` (str, optional): Прокси-сервер для использования при аутентификации. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий результаты аутентификации, включая URL для логина и параметры, полученные из браузера.

**Как работает функция**:
1. Проверяет наличие URL для логина в переменной окружения `G4F_LOGIN_URL`. Если URL присутствует, возвращает его.
2. Запускает процесс получения данных из браузера с использованием `get_browser_callback`.
3. Возвращает результат аутентификации, содержащий параметры, полученные из браузера.

**Примеры**:
```python
async for result in HailuoAI.on_auth_async():
    print(result)
```

### `create_authed`

```python
    @classmethod
    async def create_authed(
        cls,
        model: str,
        messages: Messages,
        auth_result: AuthResult,
        return_conversation: bool = False,
        conversation: Conversation = None,
        **kwargs
    ) -> AsyncResult:
        """Создает аутентифицированный запрос к Hailuo AI.

        Args:
            model (str): Используемая модель.
            messages (Messages): Список сообщений для отправки.
            auth_result (AuthResult): Результат аутентификации.
            return_conversation (bool, optional): Флаг, указывающий, нужно ли возвращать объект разговора. По умолчанию `False`.
            conversation (Conversation, optional): Объект разговора. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный результат, содержащий ответ от Hailuo AI.

        Raises:
            Exception: Если возникает ошибка при создании запроса или обработке ответа.
        """
```

**Назначение**: Метод создает аутентифицированный запрос к Hailuo AI, отправляет сообщения и обрабатывает ответ.

**Параметры**:
- `model` (str): Используемая модель.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат аутентификации.
- `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект разговора. По умолчанию `False`.
- `conversation` (Conversation, optional): Объект разговора. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный результат, содержащий ответ от Hailuo AI, включая заголовки, контент и информацию о разговоре.

**Как работает функция**:
1. Извлекает параметры аутентификации из `auth_result`.
2. Формирует данные для отправки, включая идентификатор персонажа, контент сообщения и идентификатор чата.
3. Создает заголовок запроса, включающий токен аутентификации и параметры для защиты от подделки.
4. Отправляет запрос к Hailuo AI с использованием `aiohttp.ClientSession`.
5. Обрабатывает потоковый ответ от сервера, извлекая события и данные.
6. Возвращает контент сообщения, заголовок чата и объект разговора (если `return_conversation` установлен в `True`).

**Примеры**:
```python
auth_result = await HailuoAI.on_auth_async()
async for response in HailuoAI.create_authed(model="MiniMax", messages=[{"role": "user", "content": "Hello"}], auth_result=auth_result, return_conversation=True):
    print(response)
```

## Внутренние функции

В классе `HailuoAI` метод `create_authed` содержит логику для обработки потоковых данных и извлечения необходимой информации из ответа сервера.

## Параметры класса

- `label` (str): Метка провайдера ("Hailuo AI").
- `url` (str): URL сервиса ("https://www.hailuo.ai").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование без драйвера (True).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (True).
- `default_model` (str): Модель по умолчанию ("MiniMax").