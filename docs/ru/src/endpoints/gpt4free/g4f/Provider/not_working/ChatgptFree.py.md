# Модуль для взаимодействия с ChatgptFree.ai
=================================================

Модуль содержит класс :class:`ChatgptFree`, который используется для асинхронного взаимодействия с сервисом ChatgptFree.ai для генерации текста на основе предоставленных сообщений.

Пример использования
----------------------

```python
# Пример использования данного класса будет представлен позже, когда будет разработан пример
```

## Обзор

Модуль `ChatgptFree` предоставляет асинхронный интерфейс для взаимодействия с сервисом `chatgptfree.ai`. Он позволяет отправлять запросы на генерацию текста на основе предоставленных сообщений и получать результаты в виде асинхронного генератора. Модуль также включает поддержку прокси и куки для более гибкой настройки запросов.

## Подробней

Модуль предназначен для интеграции с другими частями проекта, где требуется генерация текста с использованием модели, предоставляемой `chatgptfree.ai`. Он обеспечивает асинхронное взаимодействие, что позволяет избежать блокировки основного потока выполнения.

## Классы

### `ChatgptFree`

**Описание**: Класс `ChatgptFree` является асинхронным провайдером генерации текста. Он реализует методы для отправки запросов к сервису `chatgptfree.ai` и получения результатов в виде асинхронного генератора.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров генерации.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями, поддерживаемыми провайдером.

**Атрибуты**:
- `url` (str): URL сервиса `chatgptfree.ai`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `_post_id` (Optional[str]): ID поста, необходимый для запросов.
- `_nonce` (Optional[str]): Nonce, необходимый для запросов.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь алиасов моделей.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения текста от `chatgptfree.ai`.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        cookies: dict = None,
        **kwargs
    ) -> AsyncGenerator[str, None]:
        """
        Создает асинхронный генератор для получения текста от chatgptfree.ai.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Максимальное время ожидания ответа. По умолчанию `120`.
            cookies (dict, optional): Cookie для отправки с запросом. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncGenerator[str, None]: Асинхронный генератор, выдающий текст от chatgptfree.ai.

        Raises:
            RuntimeError: Если не удается получить `post_id` или `nonce` со страницы `chatgptfree.ai`.
            Exception: Если возникает ошибка при отправке запроса или обработке ответа.
        """
```

**Назначение**: Метод `create_async_generator` создает асинхронный генератор, который отправляет запросы к `chatgptfree.ai` и возвращает сгенерированный текст.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа. По умолчанию `120`.
- `cookies` (dict, optional): Cookie для отправки с запросом. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, выдающий текст от `chatgptfree.ai`.

**Вызывает исключения**:
- `RuntimeError`: Если не удается получить `post_id` или `nonce` со страницы `chatgptfree.ai`.
- `Exception`: Если возникает ошибка при отправке запроса или обработке ответа.

**Как работает функция**:

1. **Инициализация**:
   - Устанавливает заголовки HTTP-запроса, включая `authority`, `accept`, `user-agent` и другие необходимые параметры.
   - Инициализирует асинхронную сессию с использованием `StreamSession` для управления HTTP-соединениями.
   - Если `_nonce` отсутствует, выполняет GET-запрос к главной странице `chatgptfree.ai` для извлечения `post_id` и `nonce`.

2. **Извлечение `post_id` и `nonce`**:
   - Использует регулярные выражения для поиска `data-post-id` и `data-nonce` в HTML-коде главной страницы.
   - Если `post_id` или `nonce` не найдены, вызывает исключение `RuntimeError`.

3. **Формирование данных запроса**:
   - Форматирует список сообщений `messages` в строку `prompt` с использованием функции `format_prompt`.
   - Создает словарь `data`, содержащий параметры для отправки POST-запроса, включая `_wpnonce`, `post_id`, `url`, `action`, `message` и `bot_id`.

4. **Отправка POST-запроса и обработка ответа**:
   - Отправляет асинхронный POST-запрос к `chatgptfree.ai/wp-admin/admin-ajax.php` с данными `data` и `cookies`.
   - Обрабатывает ответ построчно, декодируя каждую строку из UTF-8.
   - Если строка начинается с `data: `, извлекает JSON-данные из строки и пытается их десериализовать.

5. **Генерация текста**:
   - Извлекает содержимое (`content`) из JSON-данных и передает его в генератор.
   - Если встречается маркер `[DONE]`, завершает генерацию.
   - Если строка не начинается с `data: `, добавляет ее в буфер.

6. **Обработка финального буфера**:
   - После завершения обработки строк пытается десериализовать содержимое буфера как JSON.
   - Если десериализация успешна и JSON содержит ключ `data`, передает значение `data` в генератор.

```
    Начало
    │
    ├───> Проверка наличия cls._nonce
    │    │
    │    └───> cls._nonce существует?
    │         │
    │         ├───> Да: Пропуск этапа получения _nonce и _post_id
    │         │
    │         └───> Нет: GET запрос к cls.url для получения _nonce и _post_id
    │              │
    │              └───> Извлечение _post_id и _nonce из HTML
    │
    │
    └───> Форматирование prompt из messages
    │
    └───> Подготовка данных для POST запроса
    │
    └───> POST запрос к cls.url/wp-admin/admin-ajax.php
    │
    └───> Обработка ответа: итерация по строкам
    │    │
    │    └───> Строка начинается с "data:"?
    │         │
    │         ├───> Да: Извлечение и обработка JSON, yield content
    │         │
    │         └───> Нет: Добавление строки в buffer
    │
    │
    └───> Обработка buffer (если не пустой)
    │
    └───> Конец
```

**Примеры**:

```python
# Пример использования будет представлен позже, когда будет разработан пример
```