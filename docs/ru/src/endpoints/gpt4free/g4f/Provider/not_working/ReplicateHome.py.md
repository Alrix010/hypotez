# Модуль ReplicateHome
## Обзор

Модуль предоставляет класс `ReplicateHome` для взаимодействия с API Replicate.com, позволяя генерировать текст и изображения с использованием различных моделей, включая `google-deepmind/gemma-2b-it` и `stability-ai/stable-diffusion-3`. Модуль поддерживает потоковую передачу результатов (streaming) и асинхронные запросы.

## Подробней

Этот модуль предназначен для интеграции с платформой Replicate.com, предоставляя удобный интерфейс для использования моделей машинного обучения, размещенных на этой платформе. Он включает поддержку как текстовых, так и графических моделей.  Он позволяет отправлять запросы к API Replicate для генерации контента на основе выбранной модели и полученных входных данных, а также обрабатывать полученные результаты.

## Классы

### `ReplicateHome`

**Описание**: Класс для работы с API Replicate.com. Позволяет генерировать текст и изображения с использованием различных моделей.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную потоковую генерацию.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сайта Replicate.com.
- `api_endpoint` (str): URL API для создания предсказаний.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.
- `default_model` (str): Модель, используемая по умолчанию (`google-deepmind/gemma-2b-it`).
- `default_image_model` (str): Модель для генерации изображений по умолчанию (`stability-ai/stable-diffusion-3`).
- `image_models` (List[str]): Список поддерживаемых моделей для генерации изображений.
- `text_models` (List[str]): Список поддерживаемых моделей для генерации текста.
- `models` (List[str]): Объединенный список всех поддерживаемых моделей (текст + изображения).
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей для удобства использования.
- `model_versions` (Dict[str, str]): Словарь версий моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения результатов от API Replicate.
- `get_model`: Возвращает полное имя модели на основе псевдонима (если есть).

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения результатов от API Replicate.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для формирования запроса.
            prompt (str, optional): Текст запроса. Если не указан, формируется автоматически. По умолчанию `None`.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий результаты от API Replicate.

        Raises:
            Exception: Если предсказание не удалось или истекло время ожидания.
        """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Replicate и получения результатов генерации текста или изображений.

**Параметры**:
- `cls`: Ссылка на класс `ReplicateHome`.
- `model` (str): Имя модели, которую необходимо использовать для генерации.
- `messages` (Messages): Список сообщений, используемых для формирования запроса.
- `prompt` (str, optional): Текст запроса. Если не указан, формируется автоматически из `messages`. По умолчанию `None`.
- `proxy` (str, optional): Адрес прокси-сервера для выполнения запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API Replicate.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий результаты от API Replicate. В случае генерации изображений возвращает объект `ImageResponse`.

**Вызывает исключения**:
- `Exception`: Если предсказание не удалось или истекло время ожидания.
- `ValueError`: Если получен неожиданный формат ответа от сервера.

**Как работает функция**:

1. **Определение модели**:
   - Функция пытается получить полное имя модели, используя метод `cls.get_model(model)`. Если `model` является псевдонимом, он будет заменен на полное имя.

2. **Подготовка заголовков**:
   - Функция определяет необходимые заголовки для HTTP-запроса, включая `accept`, `accept-language`, `content-type`, `origin`, `referer` и `user-agent`.

3. **Создание сессии**:
   - Создается асинхронная сессия `ClientSession` с заданными заголовками и прокси (если указан).

4. **Формирование запроса**:
   - Если `prompt` не указан, он формируется на основе `messages`. Для моделей изображений используется последний элемент `messages`, для текстовых моделей используется `format_prompt(messages)`.
   - Формируются данные запроса `data`, включающие `model`, `version` (из `cls.model_versions`) и `input` с текстом запроса `prompt`.

5. **Отправка запроса и получение ID**:
   - Отправляется POST-запрос к `cls.api_endpoint` с данными `data`.
   - Полученный ответ преобразуется в JSON, и из него извлекается `prediction_id`.

6. **Опрос API**:
   - В цикле (максимум 30 попыток с задержкой в 5 секунд) отправляются GET-запросы к `poll_url` для получения статуса предсказания.
   - Если `result['status'] == 'succeeded'`:
     - Для моделей изображений извлекается URL изображения из `result['output']`, создается объект `ImageResponse`, который выдается через `yield`.
     - Для текстовых моделей каждый элемент из `result['output']` выдается через `yield`.
   - Если `result['status'] == 'failed'`, вызывается исключение `Exception` с информацией об ошибке.

7. **Обработка ошибок и таймаутов**:
   - Если после всех попыток статус не `succeeded`, вызывается исключение `Exception` о таймауте.

8. **Обработка неожиданных форматов ответа**:
   - При получении `ContentTypeError` во время запроса к `poll_url`, функция пытается обработать ответ как текст, а затем преобразовать его в JSON. Если это не удается, вызывается исключение `ValueError`.

```
Блок-схема работы функции:

Начало
  ↓
Определение модели (model)
  ↓
Подготовка заголовков (headers)
  ↓
Создание асинхронной сессии (session)
  ↓
Формирование запроса (data)
  ↓
Отправка POST-запроса (api_endpoint) и получение prediction_id
  ↓
Начало цикла опроса API (poll_url)
  ↓
Отправка GET-запроса (poll_url)
  ↓
Проверка статуса (result['status'])
  ├── 'succeeded' → Извлечение и выдача результата (изображение или текст)
  ├── 'failed' → Вызов исключения Exception
  └── Другое → Ожидание (asyncio.sleep(delay)) и повтор цикла
  ↓
Конец цикла
  ↓
Проверка статуса после цикла
  └── Не 'succeeded' → Вызов исключения Exception о таймауте
  ↓
Конец
```

**Примеры**:

```python
# Пример использования для текстовой модели
async for chunk in ReplicateHome.create_async_generator(model='gemma-2b', messages=[{'role': 'user', 'content': 'Напиши короткий стих.'}]):
    print(chunk, end='')

# Пример использования для модели генерации изображений
async for image_response in ReplicateHome.create_async_generator(model='stability-ai/stable-diffusion-3', messages=[{'role': 'user', 'content': 'кот играет на пианино'}], width=512, height=512):
    print(image_response.image_url)