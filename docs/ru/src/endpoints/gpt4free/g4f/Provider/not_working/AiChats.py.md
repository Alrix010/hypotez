# Модуль `AiChats`

## Обзор

Модуль `AiChats` предоставляет асинхронный интерфейс для взаимодействия с сервисом ai-chats.org. Он поддерживает как генерацию текста (чат), так и генерацию изображений (dalle). Модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет функциональность для форматирования запросов и обработки ответов.

## Подробнее

Этот модуль является реализацией асинхронного провайдера для сервиса ai-chats.org, который позволяет генерировать ответы на текстовые запросы и создавать изображения, используя модели `gpt-4` и `dalle` соответственно. Он интегрируется в проект `hypotez` для предоставления доступа к этим моделям через единый интерфейс.

## Классы

### `AiChats`

**Описание**: Класс `AiChats` является асинхронным провайдером, который взаимодействует с API сервиса ai-chats.org. Он предоставляет методы для создания асинхронных генераторов и выполнения запросов к API.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую структуру для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса ai-chats.org.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4`).
- `models` (list): Список поддерживаемых моделей (`gpt-4`, `dalle`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.
- `create_async`: Создает асинхронный запрос и возвращает результат.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API ai-chats.org.

    Args:
        model (str): Название модели для использования (`gpt-4` или `dalle`).
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текстовые или графические ответы от API.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса к API.

    """
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API ai-chats.org и возвращает ответы в виде текста или изображений. Она поддерживает выбор модели (`gpt-4` для текста, `dalle` для изображений), передачу истории сообщений и использование прокси-сервера.

**Как работает функция**:

1. **Подготовка заголовков**: Создаются HTTP-заголовки, необходимые для запроса к API, включая `content-type`, `origin`, `referer` и `user-agent`.
2. **Создание сессии**: Используется `aiohttp.ClientSession` для управления HTTP-соединением.
3. **Формирование данных**:
   - Если `model` равно `dalle`, извлекается последний элемент `content` из списка `messages` как prompt.
   - Иначе используется функция `format_prompt` для форматирования списка сообщений в строку prompt.
   - Создается словарь `data`, содержащий тип запроса (`image` или `chat`) и историю сообщений.
4. **Отправка запроса**:
   - Отправляется POST-запрос к `cls.api_endpoint` с данными в формате JSON.
5. **Обработка ответа**:
   - Для модели `dalle`:
     - Извлекается URL изображения из JSON-ответа.
     - Загружается изображение по URL.
     - Кодируется изображение в формат base64 и возвращается в виде `ImageResponse`.
   - Для модели `gpt-4`:
     - Читается полный текст ответа.
     - Извлекаются сообщения из каждой строки, начинающейся с `data:`.
     - Возвращается сообщение.
6. **Обработка ошибок**:
   - Если возникает исключение, возвращается сообщение об ошибке.

**Внутренние функции**:
В данной функции нет внутренних функций.

**ASCII flowchart**:

```
A[Подготовка заголовков и данных]
|
B[Создание сессии aiohttp.ClientSession]
|
C[Отправка POST-запроса к API]
|
D[Обработка ответа в зависимости от модели]
|   |
|   E[Обработка ответа dalle: извлечение URL, загрузка и кодирование изображения]
|   |
|   F[Обработка ответа gpt-4: извлечение текстовых сообщений]
|
G[Обработка ошибок и возврат сообщения об ошибке]
```

**Примеры**:

```python
# Пример использования для генерации текста
model = 'gpt-4'
messages = [{'role': 'user', 'content': 'Hello, how are you?'}]
async for response in AiChats.create_async_generator(model, messages):
    print(response)

# Пример использования для генерации изображения
model = 'dalle'
messages = [{'role': 'user', 'content': 'A cat sitting on a mat.'}]
async for response in AiChats.create_async_generator(model, messages):
    print(response)
```

### `create_async`

```python
@classmethod
async def create_async(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> str:
    """Создает асинхронный запрос к API ai-chats.org и возвращает результат.

    Args:
        model (str): Название модели для использования (`gpt-4` или `dalle`).
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        str: Текстовый или графический ответ от API.

    """
```

**Назначение**:
Функция `create_async` создает асинхронный запрос к API ai-chats.org и возвращает результат в виде строки. Она использует `create_async_generator` для получения ответа и возвращает первое значение из генератора.

**Как работает функция**:

1. **Вызов `create_async_generator`**: Функция вызывает `create_async_generator` с переданными аргументами.
2. **Обработка ответа**:
   - Перебирает ответы, возвращаемые генератором.
   - Если ответ является экземпляром `ImageResponse`, возвращает URL первого изображения.
   - Иначе возвращает сам ответ.

**Внутренние функции**:
В данной функции нет внутренних функций.

**ASCII flowchart**:

```
A[Вызов create_async_generator]
|
B[Получение ответа от генератора]
|
C[Проверка типа ответа]
|   |
|   D[Если ImageResponse: возврат URL изображения]
|   |
|   E[Иначе: возврат ответа]
```

**Примеры**:

```python
# Пример использования для генерации текста
model = 'gpt-4'
messages = [{'role': 'user', 'content': 'Hello, how are you?'}]
response = await AiChats.create_async(model, messages)
print(response)

# Пример использования для генерации изображения
model = 'dalle'
messages = [{'role': 'user', 'content': 'A cat sitting on a mat.'}]
response = await AiChats.create_async(model, messages)
print(response)