# Модуль `MyShell`

## Обзор

Модуль `MyShell` предоставляет класс `MyShell`, который является провайдером для взаимодействия с сервисом MyShell AI. Он поддерживает модели `gpt-3.5-turbo` и стриминг ответов. Этот модуль позволяет отправлять запросы к MyShell AI и получать ответы в режиме реального времени.

## Подробнее

Модуль использует WebDriver для обхода защиты Cloudflare и отправки запросов к API MyShell AI. Он форматирует запросы и обрабатывает ответы, возвращая их в виде потока данных.

## Классы

### `MyShell`

**Описание**: Класс `MyShell` является провайдером для взаимодействия с сервисом MyShell AI.

**Наследует**: `AbstractProvider`

**Аттрибуты**:
- `url` (str): URL для взаимодействия с MyShell AI.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер стриминг ответов.

**Методы**:
- `create_completion()`: Отправляет запрос к MyShell AI и возвращает ответ.

## Функции

### `create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        timeout: int = 120,
        webdriver = None,
        **kwargs
    ) -> CreateResult:
        """
        Отправляет запрос к MyShell AI и возвращает ответ.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Указывает, следует ли возвращать ответ в режиме реального времени.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
            webdriver:  Драйвер WebDriver для управления браузером.
            **kwargs: Дополнительные параметры.

        Returns:
            CreateResult: Результат создания завершения.

        """
```

**Назначение**: Отправляет запрос к MyShell AI и возвращает ответ в режиме реального времени, если это поддерживается.

**Параметры**:
- `cls`: Ссылка на класс `MyShell`.
- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool): Указывает, следует ли возвращать ответ в режиме реального времени.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
- `webdriver`:  Драйвер WebDriver для управления браузером.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `CreateResult`: Результат создания завершения.

**Как работает функция**:

1.  **Инициализация сессии WebDriver**: Используется контекстный менеджер `WebDriverSession` для управления сессией WebDriver, что позволяет автоматизировать взаимодействие с браузером. Внутри этого блока выполняется обход защиты Cloudflare.
2.  **Обход Cloudflare**: Функция `bypass_cloudflare` используется для обхода защиты Cloudflare, чтобы получить доступ к целевому сайту `cls.url`.
3.  **Подготовка данных для запроса**: Формируется словарь `data`, содержащий `botId`, `conversation_scenario`, `message` (сформатированное сообщение от пользователя) и `messageType`. Этот словарь будет отправлен в теле POST-запроса.
4.  **Выполнение JavaScript для отправки запроса**:
    *   Подготавливается JavaScript-код, который выполняет POST-запрос к `https://api.myshell.ai/v1/bot/chat/send_message` с использованием `fetch`.
    *   В заголовках запроса указываются `accept`, `content-type`, `myshell-service-name` и `visitor-id` (полученный из `localStorage`).
    *   Тело запроса (`body`) формируется как JSON-строка из словаря `data`.
    *   Результат ответа передается через `window._reader`, который читает поток данных.
5.  **Цикл чтения потока данных**:
    *   В цикле `while True` выполняется JavaScript-код для чтения данных из потока, полученного от сервера.
    *   JavaScript-код читает чанки данных из `window._reader`.
    *   Каждый чанк разделяется на строки по символу `\n`.
    *   Строки, начинающиеся с `data: `, парсятся как JSON, и извлекается содержимое ключа `content`, которое конкатенируется в переменную `content`.
    *   Если `chunk` не пустой, функция генерирует (`yield`) этот чанк. Если `chunk` пустой, цикл завершается.
    *   В случае, если `chunk` возвращает `None`, происходит небольшая задержка (`time.sleep(0.1)`), чтобы избежать активного ожидания.

**ASCII flowchart**:

```
    +-----------------------+
    |  Инициализация сессии |
    |      WebDriver        |
    +-----------------------+
         |
         V
    +-----------------------+
    |   Обход Cloudflare    |
    +-----------------------+
         |
         V
    +-----------------------+
    | Подготовка данных     |
    | для POST-запроса      |
    +-----------------------+
         |
         V
    +-----------------------+
    |  Выполнение скрипта   |
    |   отправки запроса    |
    +-----------------------+
         |
         V
    +-----------------------+
    |    Чтение потока      |
    |       данных          |
    +-----------------------+
         |
         V
    +-----------------------+
    |  Обработка и выдача   |
    |       чанков          |
    +-----------------------+
```

**Примеры**:
```python
# Пример использования create_completion
# messages = [{"role": "user", "content": "Hello, how are you?"}]
# result = MyShell.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True)
# for chunk in result:
#     print(chunk, end="")