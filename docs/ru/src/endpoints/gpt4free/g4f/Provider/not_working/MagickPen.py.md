# Модуль `MagickPen`

## Обзор

Модуль `MagickPen` предоставляет асинхронный интерфейс для взаимодействия с API MagickPen. Он позволяет генерировать текст на основе предоставленных сообщений, используя асинхронные генераторы. Модуль поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробней

Этот модуль предназначен для интеграции с сервисом MagickPen, который предоставляет API для генерации текста. Он включает в себя методы для получения учетных данных API, формирования запросов и обработки ответов.
Модуль использует асинхронные запросы для неблокирующей работы и поддерживает потоковую передачу данных, что позволяет эффективно обрабатывать большие объемы текста.

## Классы

### `MagickPen`

**Описание**: Класс `MagickPen` реализует асинхронного провайдера для взаимодействия с API MagickPen.

**Наследует**:
- `AsyncGeneratorProvider`: Предоставляет базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса MagickPen (`"https://magickpen.com"`).
- `api_endpoint` (str): URL API endpoint (`"https://api.magickpen.com/ask"`).
- `working` (bool): Указывает, работает ли провайдер (по умолчанию `False`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (по умолчанию `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (по умолчанию `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (по умолчанию `True`).
- `default_model` (str): Модель, используемая по умолчанию (`"gpt-4o-mini"`).
- `models` (List[str]): Список поддерживаемых моделей (`['gpt-4o-mini']`).

### `fetch_api_credentials`

```python
    @classmethod
    async def fetch_api_credentials(cls) -> tuple:
        """Получает учетные данные API, необходимые для аутентификации запросов к MagickPen.

        Args:
            cls: Ссылка на класс MagickPen.

        Returns:
            tuple: Кортеж, содержащий X_API_SECRET, signature, timestamp, nonce и secret.

        Raises:
            Exception: Если не удается извлечь все необходимые данные из JavaScript файла.
        """
```

**Назначение**: Извлекает необходимые учетные данные API из JavaScript файла на сайте MagickPen.

**Как работает функция**:

1. **Определение URL JavaScript файла**:
   - URL JavaScript файла, содержащего необходимые учетные данные, задан как `https://magickpen.com/_nuxt/bf709a9ce19f14e18116.js`.

2. **Асинхронный запрос к JavaScript файлу**:
   - Используется `aiohttp.ClientSession` для выполнения асинхронного GET запроса к указанному URL.

3. **Извлечение данных из текста ответа**:
   - Используются регулярные выражения (`re.search`) для поиска и извлечения значений `X-API-Secret` и `secret` из текста ответа.

4. **Генерация дополнительных параметров**:
   - Вычисляются значения `timestamp`, `nonce` и `signature`, необходимые для формирования корректных запросов к API MagickPen.

5. **Проверка наличия всех необходимых данных**:
   - Проверяется, что все необходимые параметры (`X_API_SECRET`, `timestamp`, `nonce`, `secret`) успешно извлечены.

6. **Возврат учетных данных**:
   - В случае успеха возвращается кортеж, содержащий все извлеченные и сгенерированные учетные данные.

7. **Обработка ошибок**:
   - Если какой-либо из необходимых параметров не удается извлечь, выбрасывается исключение `Exception` с информативным сообщением об ошибке.

```
    A: Получение текста JavaScript файла
    |
    B: Поиск и извлечение X_API_SECRET
    |
    C: Поиск и извлечение secret
    |
    D: Генерация timestamp, nonce, signature
    |
    E: Проверка наличия всех данных
    |
    F: Возврат учетных данных
```

**Примеры**:

```python
# Пример вызова функции
X_API_SECRET, signature, timestamp, nonce, secret = await MagickPen.fetch_api_credentials()
print(f"X_API_SECRET: {X_API_SECRET}")
print(f"signature: {signature}")
print(f"timestamp: {timestamp}")
print(f"nonce: {nonce}")
print(f"secret: {secret}")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API MagickPen.

        Args:
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси для использования. По умолчанию None.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий части ответа от API.
        """
```

**Назначение**: Создает асинхронный генератор для получения ответов от API MagickPen.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа от API.

**Как работает функция**:

1. **Получение модели**:
   - Вызывается метод `cls.get_model(model)` для получения информации о модели.

2. **Получение учетных данных**:
   - Вызывается метод `cls.fetch_api_credentials()` для получения учетных данных API.

3. **Формирование заголовков**:
   - Создаются заголовки запроса, включающие учетные данные и другую необходимую информацию.

4. **Формирование тела запроса**:
   - Формируется тело запроса в формате JSON, включающее промпт и другие параметры.

5. **Отправка запроса и получение ответа**:
   - Используется `aiohttp.ClientSession` для отправки POST запроса к API endpoint.
   - Ответ обрабатывается потоково, и каждый чанк данных передается в генератор.

6. **Обработка ошибок**:
   - В случае ошибки при отправке запроса или обработке ответа, выбрасывается исключение.

```
    A: Получение модели
    |
    B: Получение учетных данных
    |
    C: Формирование заголовков
    |
    D: Формирование тела запроса
    |
    E: Отправка запроса и получение ответа
    |
    F: Обработка ответа и передача данных в генератор
```

**Примеры**:

```python
# Пример вызова функции
async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in MagickPen.create_async_generator(model="gpt-4o-mini", messages=messages):
        print(chunk, end="")

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())