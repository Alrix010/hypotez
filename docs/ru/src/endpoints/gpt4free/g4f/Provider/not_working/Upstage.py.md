# Модуль для работы с провайдером Upstage
=================================================

Модуль содержит класс `Upstage`, который используется для взаимодействия с API Upstage для генерации текста.

## Обзор

Модуль `Upstage.py` предоставляет асинхронный интерфейс для взаимодействия с API Upstage, который позволяет генерировать текст на основе предоставленных сообщений. Он поддерживает выбор модели и проксирование запросов.

## Подробней

Этот модуль предназначен для интеграции с платформой Upstage. Он включает в себя выбор модели, форматирование запроса и асинхронную обработку потоковых ответов. Модуль использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов.

## Классы

### `Upstage`

**Описание**: Класс для взаимодействия с API Upstage.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию результатов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Аттрибуты**:
- `url` (str): URL главной страницы Upstage.
- `api_endpoint` (str): URL API Upstage для запросов.
- `working` (bool): Указывает, работает ли провайдер в данный момент (в данном случае `False`).
- `default_model` (str): Модель, используемая по умолчанию (`solar-pro`).
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе псевдонима или имени, либо модель по умолчанию.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API Upstage.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """
        Возвращает имя модели на основе псевдонима или имени, либо модель по умолчанию.

        Args:
            model (str): Имя модели или псевдоним.

        Returns:
            str: Имя модели.
        """
        ...
```

**Назначение**: Определяет и возвращает корректное имя модели, используемое для запросов к API Upstage.

**Параметры**:
- `model` (str): Имя модели, которое необходимо проверить и, возможно, заменить на корректное.

**Возвращает**:
- `str`: Если `model` есть в списке поддерживаемых моделей (`cls.models`), возвращает `model`. Если `model` есть в `cls.model_aliases`, возвращает соответствующее значение из `cls.model_aliases`. В противном случае возвращает `cls.default_model`.

**Как работает функция**:
1. Проверяет, является ли переданное имя модели (`model`) одним из допустимых значений в списке `cls.models`.
2. Если `model` найдена в списке допустимых моделей, функция возвращает это имя модели.
3. Если `model` не найдена в списке допустимых моделей, функция проверяет, есть ли `model` в словаре псевдонимов `cls.model_aliases`.
4. Если `model` найдена в словаре псевдонимов, функция возвращает соответствующее значение (настоящее имя модели) из этого словаря.
5. Если `model` не найдена ни в списке допустимых моделей, ни в словаре псевдонимов, функция возвращает значение `cls.default_model` как имя модели по умолчанию.

```
    Проверка наличия модели в списке поддерживаемых моделей
    │
    ├─── Да: Возврат имени модели
    │
    └─── Нет: Проверка наличия модели в словаре псевдонимов
         │
         ├─── Да: Возврат соответствующего значения из словаря псевдонимов
         │
         └─── Нет: Возврат имени модели по умолчанию
```

**Примеры**:

```python
# Пример 1: Модель есть в списке поддерживаемых
model_name = Upstage.get_model('solar-pro')
print(model_name)  # Вывод: solar-pro

# Пример 2: Модель есть в словаре псевдонимов
Upstage.model_aliases = {"solar-mini": "upstage/solar-1-mini-chat"}
model_name = Upstage.get_model('solar-mini')
print(model_name)
# Вывод: upstage/solar-1-mini-chat

# Пример 3: Модель не найдена, возвращается модель по умолчанию
Upstage.default_model = "solar-pro"
model_name = Upstage.get_model('unknown-model')
print(model_name)  # Вывод: solar-pro
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от API Upstage.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от API.
        """
        ...
```

**Назначение**: Создает и возвращает асинхронный генератор, который отправляет запросы к API Upstage и выдает сгенерированный контент по мере его поступления.

**Параметры**:
- `model` (str): Имя модели, которую следует использовать для генерации.
- `messages` (Messages): Список сообщений, которые будут отправлены в API для получения ответа.
- `proxy` (str, optional): URL прокси-сервера для использования при отправке запросов. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает текстовый контент, полученный от API Upstage.

**Как работает функция**:

1. Сначала функция получает имя модели, вызывая метод `cls.get_model(model)`, чтобы убедиться, что используется корректное имя модели или псевдоним.
2. Определяются заголовки HTTP-запроса, включая User-Agent, Content-Type и другие необходимые параметры.
3. Создается асинхронная сессия с использованием `aiohttp.ClientSession` с заданными заголовками.
4. Формируется словарь `data`, который содержит параметры запроса, включая флаг `stream` (установлен в `True` для потоковой передачи), сообщения и имя модели.
5. Отправляется POST-запрос к API Upstage по адресу `cls.api_endpoint` с использованием асинхронной сессии, передавая `data` в формате JSON и `proxy`, если он указан.
6. Обрабатывается ответ от API:
   - Проверяется статус ответа с помощью `response.raise_for_status()`, чтобы убедиться, что запрос выполнен успешно.
   - Читаются строки из ответа (`response.content`) в асинхронном режиме.
   - Каждая строка декодируется из UTF-8 и удаляются лишние пробелы.
   - Если строка начинается с "data: " и не равна "data: [DONE]", то извлекается JSON из этой строки и извлекается содержимое (`content`) из поля `choices[0].delta.content`.
   - Если `content` не пустое, оно добавляется к `response_text` и выдается через `yield`.
   - Если строка равна "data: [DONE]", цикл завершается.

```
    Получение имени модели
    │
    Формирование заголовков запроса
    │
    Создание асинхронной сессии
    │
    Формирование данных запроса
    │
    Отправка POST-запроса к API Upstage
    │
    Обработка потокового ответа
    │
    Извлечение и выдача контента
    │
    Завершение цикла при получении "data: [DONE]"
```

**Примеры**:

```python
# Пример использования асинхронного генератора
async def main():
    messages = [{"role": "user", "content": "Tell me a joke."}]
    async for content in Upstage.create_async_generator(model='solar-pro', messages=messages):
        print(content, end="")

import asyncio
asyncio.run(main())