# Модуль `AmigoChat.py`

## Обзор

Модуль предоставляет класс `AmigoChat`, который является асинхронным генератором для взаимодействия с API AmigoChat.io. Он поддерживает как текстовые запросы, так и генерацию изображений. Модуль интегрируется с различными моделями, предоставляемыми AmigoChat, и обеспечивает возможность стриминга ответов.

## Подробнее

Модуль предназначен для использования в проектах, требующих интеграции с AmigoChat.io для генерации текста или изображений. Он содержит список поддерживаемых моделей и алиасы для упрощения их использования. Класс `AmigoChat` реализует методы для создания асинхронных генераторов, которые отправляют запросы к API AmigoChat и возвращают результаты.

## Классы

### `AmigoChat`

**Описание**: Класс `AmigoChat` предоставляет функциональность для взаимодействия с API AmigoChat.io. Он поддерживает как текстовые запросы, так и генерацию изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Добавляет поддержку выбора и управления моделями.

**Атрибуты**:
- `url` (str): Базовый URL для AmigoChat.io.
- `chat_api_endpoint` (str): URL для API текстовых запросов.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`'gpt-4o-mini'`).
- `chat_models` (list[str]): Список поддерживаемых моделей чата.
- `image_models` (list[str]): Список поддерживаемых моделей генерации изображений.
- `models` (list[str]): Объединенный список моделей чата и изображений.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей для упрощения их использования.

**Принцип работы**:
Класс использует `StreamSession` для выполнения асинхронных HTTP-запросов к API AmigoChat. Он поддерживает выбор модели, передачу сообщений и параметров запроса. В зависимости от типа запроса (текст или изображение) формируется соответствующий запрос к API. Ответы обрабатываются и возвращаются в виде асинхронного генератора.

**Методы**:
- `get_personaId(model: str) -> str`: Возвращает идентификатор личности (persona ID) для указанной модели.
- `generate_chat_id() -> str`: Генерирует уникальный идентификатор чата в формате UUID.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для выполнения запроса к API AmigoChat.

## Методы класса

### `get_personaId`

```python
@classmethod
def get_personaId(cls, model: str) -> str:
    """Функция возвращает идентификатор личности (persona ID) для указанной модели.

    Args:
        model (str): Название модели, для которой необходимо получить persona ID.

    Returns:
        str: Идентификатор личности (persona ID) для указанной модели.

    Raises:
        ValueError: Если указанная модель не найдена в списках моделей чата или изображений.

    Как работает функция:
    - Функция принимает название модели в качестве аргумента.
    - Проверяет, присутствует ли модель в списке моделей чата (`cls.chat_models`).
    - Если модель найдена в списке моделей чата, функция возвращает соответствующий `persona_id` из словаря `MODELS['chat']`.
    - Если модель не найдена в списке моделей чата, функция проверяет, присутствует ли модель в списке моделей изображений (`cls.image_models`).
    - Если модель найдена в списке моделей изображений, функция возвращает соответствующий `persona_id` из словаря `MODELS['image']`.
    - Если модель не найдена ни в одном из списков, функция вызывает исключение `ValueError` с сообщением об ошибке.

    Примеры:
    >>> AmigoChat.get_personaId('gpt-4o-mini')
    'amigo'

    >>> AmigoChat.get_personaId('flux-pro/v1.1')
    'flux-1-1-pro'
    """
    ...
```

### `generate_chat_id`

```python
@staticmethod
def generate_chat_id() -> str:
    """Функция генерирует уникальный идентификатор чата в формате UUID (8-4-4-4-12 шестнадцатеричных цифр).

    Returns:
        str: Уникальный идентификатор чата в формате UUID.

    Как работает функция:
    - Функция вызывает `uuid.uuid4()` для генерации случайного UUID.
    - Преобразует UUID в строку с помощью `str()`.
    - Возвращает полученную строку.

    Примеры:
    >>> AmigoChat.generate_chat_id()
    'a1b2c3d4-e5f6-7890-1234-567890abcdef'
    """
    ...
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    stream: bool = False,
    timeout: int = 300,
    frequency_penalty: float = 0,
    max_tokens: int = 4000,
    presence_penalty: float = 0,
    temperature: float = 0.5,
    top_p: float = 0.95,
    **kwargs
) -> AsyncResult:
    """Функция создает асинхронный генератор для взаимодействия с API AmigoChat.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        stream (bool, optional): Флаг, указывающий на необходимость потоковой передачи данных. По умолчанию `False`.
        timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию `300`.
        frequency_penalty (float, optional): Штраф за частоту использования токенов. По умолчанию `0`.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию `4000`.
        presence_penalty (float, optional): Штраф за присутствие токенов. По умолчанию `0`.
        temperature (float, optional): Температура для управления случайностью генерации. По умолчанию `0.5`.
        top_p (float, optional): Параметр `top_p` для управления разнообразием генерации. По умолчанию `0.95`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий результаты от API.

    Raises:
        ResponseStatusError: Если получен HTTP-ответ с ошибкой.
        Exception: Если возникает другая ошибка при взаимодействии с API.

    Как работает функция:
    - Функция принимает параметры для настройки запроса к API AmigoChat.
    - Извлекает название модели, список сообщений и другие параметры из аргументов.
    - Генерирует уникальный идентификатор устройства (`device_uuid`).
    - Устанавливает заголовки HTTP-запроса, включая `x-device-uuid`.
    - Использует `StreamSession` для выполнения асинхронных HTTP-запросов.
    - Если модель находится в списке моделей чата (`cls.chat_models`):
        - Формирует JSON-данные для запроса к API текстовых запросов (`cls.chat_api_endpoint`).
        - Отправляет POST-запрос к API.
        - Обрабатывает потоковые ответы, извлекая контент из каждого чанка.
        - Возвращает контент через `yield`.
    - Если модель находится в списке моделей изображений (`cls.image_models`):
        - Формирует JSON-данные для запроса к API генерации изображений (`cls.image_api_endpoint`).
        - Отправляет POST-запрос к API.
        - Обрабатывает ответ, извлекая URL изображений.
        - Возвращает URL изображений через `yield`.
    - В случае ошибки (например, `ResponseStatusError`) функция повторяет запрос до `max_retries` раз.
    - Если все попытки исчерпаны, функция вызывает исключение.

    Внутренние функции:
    - Нет

    Примеры:
    ```python
    messages = [{"role": "user", "content": "Напиши стихотворение о весне."}]
    async for chunk in AmigoChat.create_async_generator(model='gpt-4o-mini', messages=messages):
        print(chunk, end="")
    ```

    ```python
    messages = [{"role": "user", "content": "Создай изображение кота в шляпе."}]
    async for image in AmigoChat.create_async_generator(model='dall-e-3', messages=messages):
        print(image)  # Выведет объект ImageResponse с URL изображения
    ```
    """
    ...
```

## Переменные класса

- `url` (str): Базовый URL для AmigoChat.io.
- `chat_api_endpoint` (str): URL для API текстовых запросов.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`'gpt-4o-mini'`).
- `chat_models` (list[str]): Список поддерживаемых моделей чата.
- `image_models` (list[str]): Список поддерживаемых моделей генерации изображений.
- `models` (list[str]): Объединенный список моделей чата и изображений.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей для упрощения их использования.