# Модуль `AmigoChat.py`

## Обзор

Модуль предоставляет класс `AmigoChat`, который является асинхронным генератором для взаимодействия с API AmigoChat. Он поддерживает как текстовые запросы, так и генерацию изображений. Модуль определяет модели, доступные для чата и генерации изображений, и использует их для отправки запросов к API AmigoChat.

## Подробней

Модуль `AmigoChat.py` предназначен для интеграции с платформой AmigoChat, предоставляя функциональность для обмена сообщениями и генерации изображений. Он использует асинхронные запросы для обеспечения неблокирующего взаимодействия с API. Класс `AmigoChat` наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`, что позволяет ему использовать общие механизмы для обработки запросов и управления моделями.

## Классы

### `AmigoChat(AsyncGeneratorProvider, ProviderModelMixin)`

**Описание**: Класс для взаимодействия с API AmigoChat для генерации текста и изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Предоставляет базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): Базовый URL для AmigoChat.
- `chat_api_endpoint` (str): URL для API чата.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу.
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini`).
- `chat_models` (list): Список моделей, доступных для чата.
- `image_models` (list): Список моделей, доступных для генерации изображений.
- `models` (list): Объединенный список моделей для чата и генерации изображений.
- `model_aliases` (dict): Словарь псевдонимов моделей.

**Методы**:
- `get_personaId(model: str) -> str`
- `generate_chat_id() -> str`
- `create_async_generator(model: str, messages: Messages, proxy: str = None, stream: bool = False, timeout: int = 300, frequency_penalty: float = 0, max_tokens: int = 4000, presence_penalty: float = 0, temperature: float = 0.5, top_p: float = 0.95, **kwargs) -> AsyncResult`

## Функции

### `get_personaId(model: str) -> str`

**Назначение**: Получает идентификатор персонажа (personaId) для указанной модели.

**Параметры**:
- `model` (str): Название модели.

**Возвращает**:
- `str`: Идентификатор персонажа для указанной модели.

**Вызывает исключения**:
- `ValueError`: Если модель не найдена в списках `chat_models` и `image_models`.

**Как работает функция**:

1. **Проверка модели в списке моделей для чата**:
   - Функция проверяет, находится ли переданная модель в списке `chat_models`.
   - Если модель найдена в списке моделей для чата, она извлекает `persona_id` из словаря `MODELS['chat'][model]` и возвращает его.

2. **Проверка модели в списке моделей для генерации изображений**:
   - Если модель не найдена в списке моделей для чата, функция проверяет, находится ли модель в списке `image_models`.
   - Если модель найдена в списке моделей для генерации изображений, она извлекает `persona_id` из словаря `MODELS['image'][model]` и возвращает его.

3. **Обработка неизвестной модели**:
   - Если модель не найдена ни в одном из списков, функция вызывает исключение `ValueError` с сообщением о том, что модель неизвестна.

**Примеры**:

```python
persona_id = AmigoChat.get_personaId('gpt-4o-mini')
print(persona_id)  # Вывод: amigo

persona_id = AmigoChat.get_personaId('flux-pro')
print(persona_id)  # Вывод: flux-pro
```

### `generate_chat_id() -> str`

**Назначение**: Генерирует уникальный идентификатор чата в формате `8-4-4-4-12` шестнадцатеричных цифр.

**Возвращает**:
- `str`: Уникальный идентификатор чата.

**Как работает функция**:

1. **Генерация UUID**:
   - Функция использует модуль `uuid` для генерации UUID (Universally Unique Identifier).

2. **Преобразование UUID в строку**:
   -  UUID преобразуется в строковое представление.

3. **Возврат идентификатора чата**:
   - Функция возвращает строковое представление UUID, которое служит уникальным идентификатором чата.

```
  Генерация UUID
      │
      │
  Преобразование в строку
      │
      │
  Возврат идентификатора
```

**Примеры**:

```python
chat_id = AmigoChat.generate_chat_id()
print(chat_id)  # Вывод: Пример: 123e4567-e89b-12d3-a456-426614174000
```

### `create_async_generator(model: str, messages: Messages, proxy: str = None, stream: bool = False, timeout: int = 300, frequency_penalty: float = 0, max_tokens: int = 4000, presence_penalty: float = 0, temperature: float = 0.5, top_p: float = 0.95, **kwargs) -> AsyncResult`

**Назначение**: Создает асинхронный генератор для взаимодействия с API AmigoChat.

**Параметры**:
- `model` (str): Название модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `stream` (bool, optional): Флаг, указывающий, использовать ли потоковую передачу. По умолчанию `False`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `300`.
- `frequency_penalty` (float, optional): Штраф за частоту. По умолчанию `0`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `4000`.
- `presence_penalty` (float, optional): Штраф за присутствие. По умолчанию `0`.
- `temperature` (float, optional): Температура. По умолчанию `0.5`.
- `top_p` (float, optional): Top-p. По умолчанию `0.95`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения ответов от API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при выполнении запроса после нескольких повторных попыток.

**Как работает функция**:

1. **Инициализация параметров**:
   - Функция извлекает название модели, идентификатор устройства (`device_uuid`), максимальное количество повторных попыток (`max_retries`) и счетчик попыток (`retry_count`).
   -  Если модель не найдена, вызывается исключение `ValueError` с сообщением об ошибке.

2. **Цикл повторных попыток**:
   -  Функция входит в цикл, который повторяется до тех пор, пока не будет достигнуто максимальное количество попыток (`retry_count < max_retries`).

3. **Формирование заголовков запроса**:
   - Функция создает словарь `headers` с необходимыми HTTP-заголовками для запроса.

4. **Создание асинхронной сессии**:
   - Функция использует `StreamSession` для создания асинхронной сессии с указанными заголовками и прокси-сервером (если он предоставлен).

5. **Обработка моделей изображений и чата**:
   -  Если модель находится в списке `image_models`, выполняется запрос к API генерации изображений.
   -  В противном случае выполняется запрос к API чата.

6. **Запрос к API чата**:
   - Формируется полезная нагрузка (`data`) для запроса к API чата.
   -  Выполняется POST-запрос к `cls.chat_api_endpoint` с использованием асинхронной сессии.
   -  Ответ от API обрабатывается построчно, декодируется из UTF-8, и извлекается содержимое (`content`) из каждого чанка.
   -  Содержимое передается через `yield`, что позволяет использовать функцию как генератор.

7. **Запрос к API генерации изображений**:
   -  Формируется полезная нагрузка (`data`) для запроса к API генерации изображений.
   -  Выполняется POST-запрос к `cls.image_api_endpoint` с использованием асинхронной сессии.
   -  Извлекаются URL-адреса изображений из ответа и передаются через `yield` как объект `ImageResponse`.

8. **Обработка ошибок**:
   -  Если в процессе выполнения запроса возникают исключения `ResponseStatusError` или другие исключения, счетчик `retry_count` увеличивается.
   -  Если достигнуто максимальное количество попыток, исключение поднимается повторно.
   -  В противном случае генерируется новый `device_uuid` для следующей попытки.

**ASCII Flowchart**:

```
  Начало
      │
      │
  Определение device_uuid и retry_count
      │
      │
  Вход в цикл повторных попыток
      │
      │
  Формирование заголовков запроса
      │
      │
  Создание асинхронной сессии
      │
      ├── Да ── Модель в image_models? ──
      │   │
      │   │
      │   Нет
      │   │
      │   Формирование данных для API чата
      │   │
      │   Отправка POST-запроса к API чата
      │   │
      │   Обработка ответа от API чата
      │   │
      │   Извлечение содержимого из чанков
      │   │
      │   Выдача содержимого через yield
      │   │
      │   Конец обработки API чата
      │
      │   Формирование данных для API изображений
      │   │
      │   Отправка POST-запроса к API изображений
      │   │
      │   Обработка ответа от API изображений
      │   │
      │   Извлечение URL-адресов изображений
      │   │
      │   Выдача URL-адресов через yield
      │   │
      │   Конец обработки API изображений
      │
      │
  Обработка исключений
      │
      └── Да ── Достигнуто max_retries? ──
          │
          │
          Нет
          │
          │
          Генерация нового device_uuid
          │
          │
  Конец цикла
```

**Примеры**:

```python
model = "gpt-4o-mini"
messages = [{"role": "user", "content": "Hello, how are you?"}]

async for chunk in AmigoChat.create_async_generator(model=model, messages=messages):
    print(chunk, end="")
```
```python
model = "flux-pro"
messages = [{"role": "user", "content": "Generate a futuristic car"}]

async for image_response in AmigoChat.create_async_generator(model=model, messages=messages):
    if image_response:
        print(image_response.image_urls)