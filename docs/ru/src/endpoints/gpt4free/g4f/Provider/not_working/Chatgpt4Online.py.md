# Модуль `Chatgpt4Online.py`

## Обзор

Модуль предназначен для взаимодействия с онлайн-сервисом ChatGPT4 для генерации текста на основе предоставленных сообщений. Он использует асинхронные запросы для обмена данными с сервером и возвращает результаты в виде асинхронного генератора.

## Подробней

Модуль `Chatgpt4Online.py` предоставляет функциональность для отправки запросов к API `chatgpt4online.org` и получения ответов в реальном времени. Он обрабатывает ответы, извлекая полезные данные из JSON, передаваемые в виде chunks.
Модуль использует библиотеку `aiohttp` для асинхронных HTTP-запросов, что позволяет не блокировать выполнение других задач во время ожидания ответа от сервера. Поддерживается потоковая передача данных, что позволяет получать и обрабатывать ответы частями, уменьшая задержку и повышая отзывчивость.

## Классы

### `Chatgpt4Online`

**Описание**: Класс `Chatgpt4Online` является асинхронным провайдером генерации текста, взаимодействующим с API `chatgpt4online.org`.

**Принцип работы**:
Класс использует асинхронные HTTP-запросы для обмена данными с сервером `chatgpt4online.org`. Он отправляет сообщения пользователя и получает ответы в режиме реального времени, обрабатывая JSON-данные, передаваемые в виде фрагментов (chunks).

**Аттрибуты**:
- `url` (str): URL сервиса `https://chatgpt4online.org`.
- `api_endpoint` (str): Endpoint API для отправки сообщений `/wp-json/mwai-ui/v1/chats/submit`.
- `working` (bool): Статус работоспособности провайдера (в данном случае `False`).
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4`).
- `models` (list[str]): Список поддерживаемых моделей (`[default_model]`).

**Методы**:
- `get_nonce(headers: dict) -> str`: Получает nonce (одноразовый токен) для аутентификации запросов.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `get_nonce`

```python
async def get_nonce(headers: dict) -> str:
    """Получает nonce (одноразовый токен) для аутентификации запросов.

    Args:
        headers (dict): Словарь HTTP-заголовков для запроса.

    Returns:
        str: Значение nonce, полученное из ответа сервера.

    Raises:
        ClientError: Ошибка при выполнении запроса к серверу.
    """
```

**Назначение**: Функция `get_nonce` выполняет запрос к API `https://chatgpt4online.org/wp-json/mwai/v1/start_session` для получения одноразового токена (nonce), необходимого для аутентификации последующих запросов.

**Параметры**:
- `headers` (dict): Словарь HTTP-заголовков, которые будут отправлены вместе с запросом.

**Возвращает**:
- `str`: Значение nonce, полученное из JSON-ответа сервера.

**Вызывает исключения**:
- `ClientError`: Возникает при ошибке выполнения HTTP-запроса.

**Как работает функция**:
1. **Создание сессии**: Инициализируется асинхронная клиентская сессия с использованием библиотеки `aiohttp`.
2. **Выполнение POST-запроса**: Отправляется POST-запрос по адресу `https://chatgpt4online.org/wp-json/mwai/v1/start_session` с переданными заголовками.
3. **Извлечение nonce**: Из JSON-ответа извлекается значение nonce, которое возвращается как строка.

```
    Начало
    │
    │ Создание асинхронной сессии
    │
    │ Выполнение POST-запроса к API для получения nonce
    │
    │ Извлечение nonce из JSON-ответа
    │
    Конец
```

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def example():
    headers = {
        "accept": "application/json",
        "content-type": "application/json",
    }
    nonce = await Chatgpt4Online.get_nonce(headers)
    print(f"Nonce: {nonce}")

asyncio.run(example())
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API.

    Args:
        model (str): Модель, используемая для генерации текста.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию None.
        **kwargs: Дополнительные аргументы.

    Yields:
        str: Части ответа, полученные от API.

    Raises:
        aiohttp.ClientError: При возникновении ошибок HTTP-запроса.
        json.JSONDecodeError: Если не удается декодировать JSON из ответа.
    """
```

**Назначение**: Метод `create_async_generator` создает асинхронный генератор, который отправляет сообщения пользователя в API `chatgpt4online.org` и возвращает ответы в режиме реального времени.

**Параметры**:
- `model` (str): Модель, используемая для генерации текста.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий части ответа, полученные от API.

**Вызывает исключения**:
- `aiohttp.ClientError`: Возникает при ошибках HTTP-запроса.
- `json.JSONDecodeError`: Возникает, если не удается декодировать JSON из ответа.

**Как работает функция**:
1. **Формирование заголовков**: Создается словарь HTTP-заголовков, необходимых для запроса.
2. **Получение nonce**: Получается nonce с использованием метода `get_nonce`.
3. **Создание сессии**: Инициализируется асинхронная клиентская сессия с использованием библиотеки `aiohttp`.
4. **Форматирование запроса**: Форматируется запрос на основе переданных сообщений.
5. **Отправка POST-запроса**: Отправляется POST-запрос по адресу API с данными и заголовками.
6. **Обработка ответа**: Ответ обрабатывается по частям (chunks), извлекаются JSON-данные, и возвращается сгенерированный текст.

```
    Начало
    │
    │ Формирование заголовков
    │
    │ Получение nonce
    │
    │ Создание асинхронной сессии
    │
    │ Форматирование запроса
    │
    │ Отправка POST-запроса к API
    │
    │ Обработка ответа по частям (chunks) и извлечение JSON-данных
    │
    Конец
```

**Примеры**:

```python
import asyncio
from typing import List, Dict

async def example():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Hello, ChatGPT!"}
    ]
    async for response in Chatgpt4Online.create_async_generator(model="gpt-4", messages=messages):
        print(response)

asyncio.run(example())