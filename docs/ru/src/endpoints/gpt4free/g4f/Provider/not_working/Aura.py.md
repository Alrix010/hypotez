# Модуль `Aura`

## Обзор

Модуль `Aura` предоставляет асинхронный генератор для взаимодействия с моделью OpenChat 3.6 через API `openchat.team`. Он позволяет отправлять сообщения и получать ответы в асинхронном режиме.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для использования в задачах, требующих асинхронного взаимодействия с API OpenChat. Он особенно полезен в случаях, когда необходимо обрабатывать большие объемы текстовых данных или когда требуется высокая производительность.

## Классы

### `Aura`

**Описание**: Класс `Aura` предоставляет функциональность асинхронного генератора для взаимодействия с API `openchat.team`.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует от базового класса `AsyncGeneratorProvider`, который обеспечивает основу для асинхронных генераторов.

**Атрибуты**:
- `url` (str): URL-адрес API `openchat.team`.
- `working` (bool): Указывает, работает ли провайдер в данный момент.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    temperature: float = 0.5,
    max_tokens: int = 8192,
    webdriver = None,
    **kwargs
) -> AsyncResult:
    """ Функция создает асинхронный генератор для взаимодействия с API openchat.team.

    Args:
        cls (Aura): Ссылка на класс `Aura`.
        model (str): Идентификатор модели, используемой для генерации ответа.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Адрес прокси-сервера для использования при подключении. По умолчанию `None`.
        temperature (float, optional): Температура для управления случайностью генерации. По умолчанию 0.5.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 8192.
        webdriver (Any, optional): Webdriver, используемый для получения аргументов из браузера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий чанки данных из ответа API.

    Raises:
        Exception: Если возникает ошибка при подключении к API или обработке ответа.
    """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API `openchat.team`.

**Параметры**:
- `cls` (Aura): Ссылка на класс `Aura`.
- `model` (str): Идентификатор модели, используемой для генерации ответа.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Адрес прокси-сервера для использования при подключении. По умолчанию `None`.
- `temperature` (float, optional): Температура для управления случайностью генерации. По умолчанию 0.5.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию 8192.
- `webdriver` (Any, optional): Webdriver, используемый для получения аргументов из браузера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий чанки данных из ответа API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при подключении к API или обработке ответа.

**Как работает функция**:

1. **Получение аргументов из браузера**: Функция `get_args_from_browser` вызывается для получения аргументов, необходимых для создания сессии `aiohttp.ClientSession`. Эти аргументы могут включать заголовки и другие параметры, необходимые для успешного подключения к API.
2. **Создание сессии `aiohttp.ClientSession`**: Асинхронная сессия создается с использованием полученных аргументов. Эта сессия используется для выполнения HTTP-запросов к API.
3. **Обработка сообщений**: Список сообщений `messages` обрабатывается для разделения системных сообщений и сообщений пользователя. Системные сообщения добавляются в отдельный список `system_message`, а остальные сообщения сохраняются в списке `new_messages`.
4. **Формирование данных для запроса**: Данные для POST-запроса формируются в виде словаря, включающего идентификатор модели, список сообщений, ключ API, системные сообщения и параметры температуры и максимального количества токенов.
5. **Отправка POST-запроса**: POST-запрос отправляется на URL-адрес API с использованием асинхронной сессии. В запросе передаются сформированные данные в формате JSON и адрес прокси-сервера (если он указан).
6. **Обработка ответа**: Функция итерируется по чанкам данных из ответа API и декодирует каждый чанк в строку, игнорируя ошибки декодирования. Затем каждый декодированный чанк выдается через асинхронный генератор.

```
Получение аргументов из браузера через `get_args_from_browser`
↓
Создание асинхронной сессии `aiohttp.ClientSession`
↓
Разделение системных сообщений и сообщений пользователя
↓
Формирование данных для POST-запроса
↓
Отправка POST-запроса к API `openchat.team`
↓
Итерация по чанкам данных из ответа и их декодирование
↓
Выдача декодированных чанков через асинхронный генератор
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict, AsyncGenerator, Any

# from .Aura import Aura  # Предполагается, что Aura находится в том же каталоге

async def main():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Hello, how are you?"}
    ]
    
    async def consume_generator(generator: AsyncGenerator[str, None]) -> None:
        async for chunk in generator:
            print(chunk, end="")
        print()

    generator: AsyncGenerator[str, None] = await Aura.create_async_generator(
        model="openchat_3.6",
        messages=messages
    )
    await consume_generator(generator)

if __name__ == "__main__":
    asyncio.run(main())