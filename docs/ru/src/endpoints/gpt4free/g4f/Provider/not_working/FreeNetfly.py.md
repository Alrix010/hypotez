# Модуль `FreeNetfly`

## Обзор

Модуль `FreeNetfly` предоставляет асинхронный интерфейс для взаимодействия с API FreeNetfly, который позволяет генерировать текст на основе моделей `gpt-3.5-turbo` и `gpt-4`. Модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет функциональность для обработки потоковых ответов от API.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими доступа к моделям генерации текста через API FreeNetfly. Он реализует асинхронный генератор для обработки потоковых ответов, что позволяет эффективно использовать ресурсы и предоставляет пользователю возможность получать результаты по частям.

## Классы

### `FreeNetfly`

**Описание**: Класс `FreeNetfly` является асинхронным провайдером, который позволяет взаимодействовать с API FreeNetfly для генерации текста.

**Принцип работы**:
Класс наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`, что обеспечивает поддержку асинхронной генерации и предоставляет информацию о поддерживаемых моделях. Основной функциональностью класса является метод `create_async_generator`, который отправляет запрос к API FreeNetfly и возвращает асинхронный генератор для обработки потоковых ответов.

**Атрибуты**:
- `url` (str): URL API FreeNetfly.
- `api_endpoint` (str): Endpoint API для запросов на генерацию текста.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-3.5-turbo`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-3.5-turbo`, `gpt-4`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API FreeNetfly.
- `_process_response`: Обрабатывает ответ от API FreeNetfly и извлекает контент из потока данных.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API FreeNetfly.

    Args:
        model (str): Имя модели для генерации текста.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текст от API.

    Raises:
        ClientError: Если произошла ошибка на стороне клиента при выполнении запроса.
        asyncio.TimeoutError: Если время ожидания запроса истекло.

    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API FreeNetfly и возвращает ответы в виде потока текста.

**Параметры**:
- `model` (str): Имя модели, используемой для генерации текста.
- `messages` (Messages): Список сообщений, отправляемых в API для генерации текста.
- `proxy` (str, optional): URL прокси-сервера для использования при отправке запросов. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает текст, полученный от API FreeNetfly.

**Вызывает исключения**:
- `ClientError`: Возникает, если произошла ошибка на стороне клиента при выполнении запроса.
- `asyncio.TimeoutError`: Возникает, если время ожидания запроса истекло.

**Как работает функция**:

1.  **Инициализация**: Функция получает параметры `model`, `messages`, `proxy` и `kwargs`.
2.  **Формирование заголовков**: Создаются заголовки HTTP-запроса, включающие информацию о типе контента, User-Agent и Referer.
3.  **Формирование данных запроса**: Создается словарь `data`, содержащий сообщения, модель, параметры температуры, штрафы за присутствие и частоту, а также значение `top_p`.
4.  **Повторные попытки**: Функция выполняет до 5 попыток отправки запроса с экспоненциальной задержкой между попытками.
5.  **Отправка запроса**: Используется `aiohttp.ClientSession` для отправки POST-запроса к API FreeNetfly с заданными заголовками, данными и прокси (если указан).
6.  **Обработка ответа**: Если запрос успешен, функция вызывает `_process_response` для обработки потокового ответа и возвращает генератор.
7.  **Обработка ошибок**: Если произошла ошибка `ClientError` или `asyncio.TimeoutError`, функция повторяет попытку после задержки. Если все попытки неудачны, исключение поднимается.

**Внутренние функции**: Нет.

**ASCII flowchart**:

```
Начало
│
├──► Формирование заголовков и данных запроса
│
├──► Цикл повторных попыток (max 5)
│   │
│   ├──► Отправка POST-запроса к API FreeNetfly
│   │
│   ├──► Обработка ответа через _process_response
│   │   │
│   │   └──► Успех: Возврат генератора
│   │   │
│   │   └──► Ошибка (ClientError, asyncio.TimeoutError):
│   │       │
│   │       └──► Задержка и повтор
│   │
│   └──► Все попытки неудачны: Поднятие исключения
│
└──► Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, how are you?"}]
    proxy = None

    generator = await FreeNetfly.create_async_generator(model=model, messages=messages, proxy=proxy)

    async for chunk in generator:
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

### `_process_response`

```python
@classmethod
async def _process_response(cls, response) -> AsyncGenerator[str, None]:
    """
    Обрабатывает ответ от API FreeNetfly и извлекает контент из потока данных.

    Args:
        response: Объект ответа от aiohttp.

    Returns:
        AsyncGenerator[str, None]: Асинхронный генератор, возвращающий контент из ответа.

    """
```

**Назначение**: Функция `_process_response` обрабатывает HTTP-ответ от API FreeNetfly и извлекает текстовый контент из потока данных, декодируя его и обрабатывая JSON-структуры.

**Параметры**:
- `response`: Объект ответа от `aiohttp.ClientResponse`.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, который выдает текстовый контент, извлеченный из ответа.

**Вызывает исключения**:
- `json.JSONDecodeError`: Возникает, если не удается декодировать JSON из строки.
- `KeyError`: Возникает, если в JSON-структуре отсутствует ожидаемый ключ.

**Как работает функция**:

1.  **Инициализация**: Функция получает объект ответа `response`.
2.  **Чтение потока**: Функция асинхронно читает строки из содержимого ответа.
3.  **Буферизация**: Строки добавляются в буфер `buffer`.
4.  **Обработка завершенных строк**: Если буфер заканчивается на `'\\n\\n'`, функция обрабатывает строки в буфере.
5.  **Разделение на подстроки**: Буфер разделяется на подстроки по символу `'\\n'`.
6.  **Извлечение данных**: Для каждой подстроки, начинающейся с `'data: '`, функция пытается извлечь JSON и извлечь контент из ключа `'choices'`.
7.  **Генерация контента**: Если контент извлечен успешно, функция выдает его через генератор.
8.  **Обработка ошибок JSON**: Если возникают ошибки при декодировании JSON или отсутствует ключ `'content'`, функция логирует ошибку и продолжает обработку.
9.  **Обработка остатка буфера**: После завершения чтения потока, функция обрабатывает оставшиеся данные в буфере.

**Внутренние функции**: Нет.

**ASCII flowchart**:

```
Начало
│
├──► Инициализация буфера
│
├──► Асинхронное чтение строк из response.content
│   │
│   ├──► Добавление строки в буфер
│   │
│   ├──► Буфер заканчивается на '\\n\\n'?
│   │   │
│   │   ├──► Да: Разделение буфера на подстроки по '\\n'
│   │   │   │
│   │   │   ├──► Подстрока начинается с 'data: '?
│   │   │   │   │
│   │   │   │   ├──► Да: Попытка извлечения JSON и контента
│   │   │   │   │   │
│   │   │   │   │   ├──► Успех: Выдача контента через генератор
│   │   │   │   │   │
│   │   │   │   │   └──► Ошибка JSON/KeyError: Логирование и продолжение
│   │   │   │   │
│   │   │   │   └──► Нет: Продолжение
│   │   │   │
│   │   │   └──► Очистка буфера
│   │   │
│   │   └──► Нет: Продолжение чтения
│   │
│   └──► Конец чтения потока
│       │
│       └──► Обработка остатка буфера (аналогично обработке завершенных строк)
│
└──► Конец
```

**Примеры**:

```python
# Пример использования _process_response
import asyncio
from aiohttp import ClientSession

async def main():
    url = "https://free.netfly.top/api/openai/v1/chat/completions"  # Замените на актуальный URL, если необходимо
    headers = {
        "accept": "application/json, text/event-stream",
        "content-type": "application/json",
    }
    data = {
        "messages": [{"role": "user", "content": "Hello"}],
        "stream": True,
        "model": "gpt-3.5-turbo",
        "temperature": 0.5,
        "presence_penalty": 0,
        "frequency_penalty": 0,
        "top_p": 1
    }

    async with ClientSession(headers=headers) as session:
        async with session.post(url, json=data) as response:
            async for chunk in FreeNetfly._process_response(response):
                print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())