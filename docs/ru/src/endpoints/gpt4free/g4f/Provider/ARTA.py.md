# Модуль для работы с ARTA API
## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с API ARTA для генерации изображений.
Он включает в себя функции для аутентификации, обновления токена и запроса на создание изображений.

## Подробней

Модуль `ARTA` является асинхронным провайдером для генерации изображений с использованием API `ai-arta.com`. Он реализует функциональность для получения токена аутентификации, его обновления и создания запросов на генерацию изображений на основе текстового описания. Модуль поддерживает различные модели генерации изображений и предоставляет возможность настройки параметров генерации, таких как количество изображений, guidance scale, количество шагов inference и соотношение сторон.

## Классы

### `ARTA`

**Описание**: Класс `ARTA` реализует асинхронного провайдера для генерации изображений с использованием API ARTA.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): Базовый URL для API ARTA.
- `auth_url` (str): URL для аутентификации.
- `token_refresh_url` (str): URL для обновления токена.
- `image_generation_url` (str): URL для генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель для генерации изображений по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список доступных моделей для генерации изображений.
- `models` (list): Список моделей.

**Методы**:
- `get_auth_file()`: Возвращает путь к файлу аутентификации.
- `create_token(path: Path, proxy: str | None = None)`: Создает токен аутентификации.
- `refresh_token(refresh_token: str, proxy: str = None)`: Обновляет токен аутентификации.
- `read_and_refresh_token(proxy: str | None = None)`: Читает и обновляет токен аутентификации.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, prompt: str = None, negative_prompt: str = "blurry, deformed hands, ugly", n: int = 1, guidance_scale: int = 7, num_inference_steps: int = 30, aspect_ratio: str = "1:1", seed: int = None, **kwargs)`: Создает асинхронный генератор для генерации изображений.

## Функции

### `get_auth_file`

```python
    @classmethod
    def get_auth_file(cls):
        """
        Возвращает путь к файлу, в котором хранится информация об аутентификации.

        Returns:
            Path: Объект Path, представляющий путь к файлу аутентификации.
        """
        ...
```

**Назначение**:
Функция `get_auth_file` определяет местоположение файла, в котором будет храниться информация об аутентификации для класса `ARTA`. Она создает директорию для хранения cookies, если она еще не существует, и возвращает путь к файлу аутентификации.

**Как работает функция**:

1.  **Определяет директорию для хранения cookies**: Использует функцию `get_cookies_dir()` для получения пути к директории, где хранятся файлы cookies.
2.  **Создает директорию, если она не существует**: Проверяет, существует ли директория, и создает ее, если она отсутствует. Параметр `exist_ok=True` предотвращает возникновение ошибки, если директория уже существует.
3.  **Формирует имя файла аутентификации**: Создает имя файла, используя имя класса (`cls.__name__`) и добавляя префикс `auth_`.
4.  **Возвращает путь к файлу**: Объединяет путь к директории и имя файла в объект `Path` и возвращает его.

```
    Получение директории для cookies
    │
    Создание директории (если не существует)
    │
    Формирование имени файла аутентификации
    │
    Возврат пути к файлу
```

### `create_token`

```python
    @classmethod
    async def create_token(cls, path: Path, proxy: str | None = None):
        """
        Создает токен аутентификации, необходимый для доступа к API ARTA.

        Args:
            path (Path): Путь для сохранения данных аутентификации.
            proxy (str | None, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            dict: Данные аутентификации, включающие токен.

        Raises:
            ResponseError: Если не удается получить токен аутентификации.
        """
        ...
```

**Назначение**:
Функция `create_token` выполняет запрос к API ARTA для получения токена аутентификации и сохраняет полученные данные в указанный файл.

**Как работает функция**:

1.  **Инициализация асинхронной сессии**: Создает асинхронную сессию `ClientSession` для выполнения HTTP-запросов.
2.  **Формирование полезной нагрузки (payload) для запроса аутентификации**: Определяет тип клиента как `CLIENT_TYPE_ANDROID`.
3.  **Выполнение POST-запроса для аутентификации**: Отправляет POST-запрос к `cls.auth_url` с полезной нагрузкой и прокси-сервером (если указан).
4.  **Обработка ответа**: Извлекает данные из JSON-ответа, включая токен аутентификации (`idToken`).
5.  **Проверка наличия токена**: Если токен не получен, вызывает исключение `ResponseError`.
6.  **Сохранение данных аутентификации в файл**: Записывает все данные аутентификации в файл, указанный в параметре `path`.
7.  **Возврат данных аутентификации**: Возвращает словарь с данными аутентификации.

```
    Создание асинхронной сессии
    │
    Формирование payload для запроса аутентификации
    │
    Выполнение POST-запроса для аутентификации
    │
    Обработка ответа (извлечение токена)
    │
    Проверка наличия токена
    │
    Сохранение данных аутентификации в файл
    │
    Возврат данных аутентификации
```

### `refresh_token`

```python
    @classmethod
    async def refresh_token(cls, refresh_token: str, proxy: str = None) -> tuple[str, str]:
        """
        Обновляет токен аутентификации, используя refresh token.

        Args:
            refresh_token (str): Refresh token для обновления.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            tuple[str, str]: Новый токен аутентификации и новый refresh token.
        """
        ...
```

**Назначение**:
Функция `refresh_token` использует `refresh_token` для получения нового токена аутентификации.

**Как работает функция**:

1.  **Инициализация асинхронной сессии**: Создает асинхронную сессию `ClientSession` для выполнения HTTP-запросов.
2.  **Формирование полезной нагрузки (payload) для запроса обновления токена**: Включает `grant_type` и `refresh_token`.
3.  **Выполнение POST-запроса для обновления токена**: Отправляет POST-запрос к `cls.token_refresh_url` с полезной нагрузкой и прокси-сервером (если указан).
4.  **Обработка ответа**: Извлекает новый токен аутентификации (`id_token`) и новый `refresh_token` из JSON-ответа.
5.  **Возврат нового токена и refresh token**: Возвращает кортеж с новым токеном и refresh token.

```
    Создание асинхронной сессии
    │
    Формирование payload для запроса обновления токена
    │
    Выполнение POST-запроса для обновления токена
    │
    Обработка ответа (извлечение нового токена и refresh token)
    │
    Возврат нового токена и refresh token
```

### `read_and_refresh_token`

```python
    @classmethod
    async def read_and_refresh_token(cls, proxy: str | None = None) -> str:
        """
        Читает данные аутентификации из файла и, если необходимо, обновляет токен.

        Args:
            proxy (str | None, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            dict: Данные аутентификации.
        """
        ...
```

**Назначение**:
Функция `read_and_refresh_token` считывает данные аутентификации из файла, проверяет срок действия токена и, при необходимости, обновляет его.

**Как работает функция**:

1.  **Получение пути к файлу аутентификации**: Использует функцию `cls.get_auth_file()` для получения пути к файлу, в котором хранятся данные аутентификации.
2.  **Проверка существования файла**: Проверяет, существует ли файл аутентификации.
3.  **Чтение данных из файла (если существует)**: Если файл существует, считывает данные аутентификации из файла.
4.  **Определение времени последнего изменения файла**: Получает время последнего изменения файла и вычисляет разницу между текущим временем и временем изменения файла.
5.  **Проверка срока действия токена**: Сравнивает разницу во времени с временем жизни токена (`expiresIn`).
6.  **Обновление токена (если необходимо)**: Если токен устарел (или скоро устареет), вызывает функцию `cls.refresh_token()` для обновления токена и сохраняет обновленные данные в файл.
7.  **Создание токена (если файл не существует)**: Если файл не существует, вызывает функцию `cls.create_token()` для создания нового токена и сохраняет данные в файл.
8.  **Возврат данных аутентификации**: Возвращает словарь с данными аутентификации.

```
    Получение пути к файлу аутентификации
    │
    Проверка существования файла
    │
    Чтение данных из файла (если существует)
    │
    Определение времени последнего изменения файла
    │
    Проверка срока действия токена
    │
    Обновление токена (если необходимо)
    │
    Создание токена (если файл не существует)
    │
    Возврат данных аутентификации
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        prompt: str = None,
        negative_prompt: str = "blurry, deformed hands, ugly",
        n: int = 1,
        guidance_scale: int = 7,
        num_inference_steps: int = 30,
        aspect_ratio: str = "1:1",
        seed: int = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для генерации изображений на основе текстового описания.

        Args:
            model (str): Модель для генерации изображений.
            messages (Messages): Список сообщений для формирования запроса.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            prompt (str, optional): Текстовое описание для генерации изображения. По умолчанию `None`.
            negative_prompt (str, optional): Негативное текстовое описание. По умолчанию "blurry, deformed hands, ugly".
            n (int, optional): Количество изображений для генерации. По умолчанию 1.
            guidance_scale (int, optional): Guidance scale. По умолчанию 7.
            num_inference_steps (int, optional): Количество шагов inference. По умолчанию 30.
            aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
            seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Yields:
            Reasoning: Информация о процессе генерации.
            ImageResponse: Сгенерированные изображения.
        """
        ...
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор для генерации изображений на основе текстового описания, используя API ARTA.

**Как работает функция**:

1.  **Получение модели**: Использует функцию `cls.get_model(model)` для получения модели генерации изображений.
2.  **Форматирование запроса**: Использует функцию `format_image_prompt(messages, prompt)` для форматирования текстового запроса на основе списка сообщений и описания.
3.  **Генерация случайного зерна (seed)**: Если `seed` не предоставлен, генерирует случайное целое число в диапазоне от 9999 до 99999999.
4.  **Получение токена аутентификации**: Использует функцию `cls.read_and_refresh_token(proxy)` для получения актуального токена аутентификации.
5.  **Инициализация асинхронной сессии**: Создает асинхронную сессию `ClientSession` для выполнения HTTP-запросов.
6.  **Формирование полезной нагрузки (payload) для запроса генерации изображения**: Включает параметры запроса, такие как `prompt`, `negative_prompt`, `style`, `images_num`, `cfg_scale`, `steps`, `aspect_ratio` и `seed`.
7.  **Выполнение POST-запроса для генерации изображения**: Отправляет POST-запрос к `cls.image_generation_url` с полезной нагрузкой и заголовком `Authorization` с токеном.
8.  **Обработка ответа**: Извлекает `record_id` из JSON-ответа.
9.  **Проверка наличия `record_id`**: Если `record_id` не получен, вызывает исключение `ResponseError`.
10. **Проверка статуса генерации изображения**: Выполняет цикл опроса API для проверки статуса генерации изображения, используя `status_check_url`.
11. **Обработка статуса**:
    *   Если статус `DONE`, извлекает URL-адреса сгенерированных изображений и возвращает их с использованием `yield`.
    *   Если статус `IN_QUEUE` или `IN_PROGRESS`, возвращает информацию о процессе генерации и ожидает 2 секунды перед повторной проверкой.
    *   Если статус отличается от ожидаемых, вызывает исключение `ResponseError`.

```
    Получение модели
    │
    Форматирование запроса
    │
    Генерация случайного зерна (seed)
    │
    Получение токена аутентификации
    │
    Инициализация асинхронной сессии
    │
    Формирование payload для запроса генерации изображения
    │
    Выполнение POST-запроса для генерации изображения
    │
    Обработка ответа (извлечение record_id)
    │
    Проверка наличия record_id
    │
    Цикл проверки статуса генерации изображения
    │
    Обработка статуса (DONE, IN_QUEUE, IN_PROGRESS, ERROR)
    │
    Возврат сгенерированных изображений или информации о процессе