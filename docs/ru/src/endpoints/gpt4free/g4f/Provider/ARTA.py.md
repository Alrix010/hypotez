# Модуль ARTA

## Обзор

Модуль `ARTA` предоставляет асинхронный интерфейс для взаимодействия с сервисом генерации изображений AI-ARTA. Он включает в себя функции для аутентификации, запроса генерации изображений и проверки статуса генерации.

## Подробнее

Модуль предназначен для интеграции с AI-ARTA для генерации изображений на основе текстовых запросов. Он поддерживает различные модели и стили изображений, предоставляемые сервисом AI-ARTA.

## Классы

### `ARTA`

**Описание**: Класс `ARTA` является провайдером для генерации изображений через сервис AI-ARTA. Он наследует функциональность асинхронного генератора и примеси для работы с моделями.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса AI-ARTA.
- `auth_url` (str): URL для аутентификации.
- `token_refresh_url` (str): URL для обновления токена.
- `image_generation_url` (str): URL для генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации изображения.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список доступных моделей изображений.
- `models` (list): Список доступных моделей (совпадает с `image_models`).

**Принцип работы**:
Класс `ARTA` предоставляет методы для аутентификации, запроса генерации изображений и проверки статуса генерации. Он использует асинхронные запросы для взаимодействия с сервисом AI-ARTA.

**Методы**:
- `get_auth_file()`: Возвращает путь к файлу, в котором хранится информация об аутентификации.
- `create_token()`: Создает токен аутентификации.
- `refresh_token()`: Обновляет токен аутентификации.
- `read_and_refresh_token()`: Читает и обновляет токен аутентификации при необходимости.
- `create_async_generator()`: Создает асинхронный генератор для генерации изображений.

## Методы класса

### `get_auth_file`

```python
    @classmethod
    def get_auth_file(cls):
        """ Функция извлекает путь к файлу аутентификации

        Args:
            cls : Ссылка на класс `ARTA`

        Returns:
            path (Path): Возвращает путь к файлу аутентификации. Файл создается в директории для хранения cookies, имя файла формируется на основе имени класса.
        """
```

### `create_token`

```python
    @classmethod
    async def create_token(cls, path: Path, proxy: str | None = None):
        """ Функция создает токен аутентификации для доступа к AI-ARTA.

        Args:
            cls : Ссылка на класс `ARTA`
            path (Path): Путь для сохранения данных аутентификации.
            proxy (str | None, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.

        Returns:
            auth_data (dict): Возвращает словарь с данными аутентификации, включая токен.

        Raises:
            ResponseError: Если не удается получить токен аутентификации.
        """
```

### `refresh_token`

```python
    @classmethod
    async def refresh_token(cls, refresh_token: str, proxy: str = None) -> tuple[str, str]:
        """ Функция обновляет токен аутентификации, используя refresh token.

        Args:
            cls : Ссылка на класс `ARTA`
            refresh_token (str): Refresh token для обновления.
            proxy (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.

        Returns:
            tuple[str, str]: Возвращает кортеж, содержащий новый токен и новый refresh token.
        """
```

### `read_and_refresh_token`

```python
    @classmethod
    async def read_and_refresh_token(cls, proxy: str | None = None) -> str:
        """ Функция считывает токен аутентификации из файла и обновляет его, если срок действия истек или подходит к концу.

        Args:
            cls : Ссылка на класс `ARTA`
            proxy (str | None, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.

        Returns:
            auth_data (dict): Возвращает словарь с данными аутентификации.

        
        1. Функция проверяет наличие файла с данными аутентификации.
        2. Если файл существует, функция считывает данные из файла.
        3. Функция проверяет, истек ли срок действия токена.
        4. Если срок действия токена истек или подходит к концу, функция обновляет токен, используя refresh token.
        5. Функция сохраняет обновленные данные в файл.
        6. Функция возвращает данные аутентификации.
        7. Если файл не существует, функция создает новый токен аутентификации.
        """
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        prompt: str = None,
        negative_prompt: str = "blurry, deformed hands, ugly",
        n: int = 1,
        guidance_scale: int = 7,
        num_inference_steps: int = 30,
        aspect_ratio: str = "1:1",
        seed: int = None,
        **kwargs
    ) -> AsyncResult:
        """ Функция создает асинхронный генератор для генерации изображений на основе текстового запроса.

        Args:
            cls : Ссылка на класс `ARTA`
            model (str): Модель для генерации изображения.
            messages (Messages): Список сообщений для формирования запроса.
            proxy (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
            negative_prompt (str, optional): Негативный запрос для генерации изображения. По умолчанию "blurry, deformed hands, ugly".
            n (int, optional): Количество изображений для генерации. По умолчанию 1.
            guidance_scale (int, optional): Масштаб соответствия запросу. По умолчанию 7.
            num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 30.
            aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
            seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Yields:
            Reasoning: Информация о процессе генерации.
            ImageResponse: Сгенерированные изображения.

        Raises:
            ResponseError: Если не удается инициировать генерацию изображения или происходит ошибка в процессе генерации.

        
        1. Функция извлекает модель для генерации изображения.
        2. Функция формирует текстовый запрос для генерации изображения.
        3. Функция получает токен аутентификации.
        4. Функция отправляет запрос на генерацию изображения.
        5. Функция проверяет статус генерации изображения.
        6. Если статус генерации "DONE", функция возвращает сгенерированные изображения.
        7. Если статус генерации "IN_QUEUE" или "IN_PROGRESS", функция ожидает и повторяет проверку статуса.
        8. Если происходит ошибка, функция вызывает исключение ResponseError.
        """
```

## Параметры класса

- `url` (str): URL сервиса AI-ARTA.
- `auth_url` (str): URL для аутентификации.
- `token_refresh_url` (str): URL для обновления токена.
- `image_generation_url` (str): URL для генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации изображения.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список доступных моделей изображений.
- `models` (list): Список доступных моделей (совпадает с `image_models`).

## Примеры

```python
# Пример создания асинхронного генератора для генерации изображений
async def main():
    from src.logger import logger
    from ..typing import Messages
    messages: Messages = [{"role": "user", "content": "Generate a futuristic cityscape"}]
    try:
        async for item in ARTA.create_async_generator(model="Flux", messages=messages):
            print(item)
    except Exception as ex:
        logger.error(f"Error during image generation: {ex}", ex, exc_info=True)

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())