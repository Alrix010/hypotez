# Модуль Voodoohop_Flux1Schnell

## Обзор

Модуль `Voodoohop_Flux1Schnell` предоставляет асинхронный генератор для создания изображений на основе текстовых запросов, используя API сервиса Voodoohop Flux-1-Schnell. Он позволяет генерировать изображения заданного размера с использованием указанного или случайного зерна (seed) для воспроизводимости результатов.

## Подробней

Этот модуль интегрируется с сервисом Voodoohop Flux-1-Schnell через его API для генерации изображений. Он принимает текстовые запросы и параметры генерации изображений, такие как ширина, высота, количество шагов и зерно, и возвращает URL сгенерированных изображений. Модуль также обрабатывает ошибки, возникающие в процессе генерации.

## Классы

### `Voodoohop_Flux1Schnell`

**Описание**: Класс `Voodoohop_Flux1Schnell` является асинхронным провайдером и миксином для моделей, который реализует логику взаимодействия с API Voodoohop Flux-1-Schnell для генерации изображений на основе текстовых запросов.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Название провайдера - "Voodoohop Flux-1-Schnell".
- `url` (str): URL сервиса - "https://voodoohop-flux-1-schnell.hf.space".
- `api_endpoint` (str): URL API endpoint для вызова - "https://voodoohop-flux-1-schnell.hf.space/call/infer".
- `working` (bool): Указывает, работает ли провайдер, по умолчанию `True`.
- `default_model` (str): Модель по умолчанию - "voodoohop-flux-1-schnell".
- `default_image_model` (str): Модель изображения по умолчанию - "voodoohop-flux-1-schnell".
- `model_aliases` (dict): Псевдонимы моделей, такие как `"flux-schnell"` и `"flux"`, указывающие на `default_model`.
- `image_models` (list): Список моделей изображений, полученный из ключей `model_aliases`.
- `models` (list): Список моделей, совпадающий с `image_models`.

**Методы**:
- `create_async_generator`: Асинхронный генератор для создания изображений на основе текстовых запросов.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    width: int = 768,
    height: int = 768,
    num_inference_steps: int = 2,
    seed: int = 0,
    randomize_seed: bool = True,
    **kwargs
) -> AsyncResult:
    """
    Асинхронно генерирует изображения на основе текстовых запросов, используя API Voodoohop Flux-1-Schnell.

    Args:
        cls (Voodoohop_Flux1Schnell): Класс, для которого вызывается метод.
        model (str): Используемая модель.
        messages (Messages): Список сообщений для формирования запроса.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
        width (int): Ширина генерируемого изображения. По умолчанию 768.
        height (int): Высота генерируемого изображения. По умолчанию 768.
        num_inference_steps (int): Количество шагов для генерации изображения. По умолчанию 2.
        seed (int): Зерно для генерации изображения. По умолчанию 0.
        randomize_seed (bool): Флаг для случайного зерна. По умолчанию `True`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий объекты `ImageResponse` с URL изображения.

    Raises:
        ResponseError: Если возникает ошибка при генерации изображения.

    """
    ...
```

**Назначение**: 
Функция `create_async_generator` является асинхронным генератором, который взаимодействует с API Voodoohop Flux-1-Schnell для генерации изображений на основе текстовых запросов. Она принимает параметры, такие как модель, сообщения, прокси, текстовый запрос, ширина, высота, количество шагов, зерно и флаг для случайного зерна, и возвращает асинхронный генератор, который выдает объекты `ImageResponse` с URL сгенерированного изображения.

**Параметры**:
- `cls` (Voodoohop_Flux1Schnell): Класс, для которого вызывается метод.
- `model` (str): Используемая модель.
- `messages` (Messages): Список сообщений для формирования запроса.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `prompt` (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
- `width` (int): Ширина генерируемого изображения. По умолчанию 768.
- `height` (int): Высота генерируемого изображения. По умолчанию 768.
- `num_inference_steps` (int): Количество шагов для генерации изображения. По умолчанию 2.
- `seed` (int): Зерно для генерации изображения. По умолчанию 0.
- `randomize_seed` (bool): Флаг для случайного зерна. По умолчанию `True`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий объекты `ImageResponse` с URL изображения.

**Вызывает исключения**:
- `ResponseError`: Если возникает ошибка при генерации изображения.

**Как работает функция**:

1. **Подготовка параметров**: Функция проверяет и корректирует параметры ширины и высоты изображения, чтобы они были кратны 8 и не меньше 32.
2. **Формирование запроса**: Формирует текстовый запрос для генерации изображения на основе предоставленных сообщений и запроса.
3. **Создание полезной нагрузки (payload)**: Создает структуру данных `payload`, которая содержит параметры запроса, такие как текстовый запрос, зерно, флаг случайного зерна, ширина, высота и количество шагов.
4. **Отправка запроса к API**: Использует асинхронную сессию для отправки POST-запроса к API Voodoohop Flux-1-Schnell с сформированной полезной нагрузкой.
5. **Обработка ответа**: Получает и обрабатывает ответ от API, проверяет наличие ошибок и извлекает `event_id` для дальнейшего получения статуса генерации.
6. **Ожидание завершения генерации**: В цикле отправляет GET-запросы к API для получения статуса генерации изображения.
7. **Обработка событий**: Читает и обрабатывает события, получаемые от API, проверяет наличие ошибок и извлекает URL сгенерированного изображения.
8. **Возврат результата**: Если генерация завершена успешно, функция возвращает объект `ImageResponse` с URL сгенерированного изображения.

**ASCII flowchart**:

```
Начало
  ↓
Подготовка параметров (ширина, высота, prompt)
  ↓
Создание payload
  ↓
Отправка POST-запроса к API
  ↓
Получение event_id
  ↓
Цикл запросов статуса
  │
  ├──→ Получение события
  │   ↓
  │   Проверка типа события
  │   │
  │   ├── "error" → Выброс ResponseError
  │   │
  │   └── "complete" → Извлечение URL изображения
  │       ↓
  │       Создание ImageResponse
  │       ↓
  │       Выдача ImageResponse
  │       ↓
  └── Конец
```

**Примеры**:

```python
# Пример 1: Генерация изображения с использованием параметров по умолчанию
async for image in Voodoohop_Flux1Schnell.create_async_generator(model="voodoohop-flux-1-schnell", messages=[{"role": "user", "content": "A cat"}]):
    print(image.images)

# Пример 2: Генерация изображения с указанием ширины, высоты и зерна
async for image in Voodoohop_Flux1Schnell.create_async_generator(model="voodoohop-flux-1-schnell", messages=[{"role": "user", "content": "A dog"}], width=512, height=512, seed=42):
    print(image.images)

# Пример 3: Генерация изображения с использованием прокси-сервера
async for image in Voodoohop_Flux1Schnell.create_async_generator(model="voodoohop-flux-1-schnell", messages=[{"role": "user", "content": "A bird"}], proxy="http://your-proxy-server:8080"):
    print(image.images)