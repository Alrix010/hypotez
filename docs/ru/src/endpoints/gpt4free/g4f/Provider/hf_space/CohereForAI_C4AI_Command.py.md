# Модуль `CohereForAI_C4AI_Command.py`

## Обзор

Модуль предназначен для взаимодействия с моделями CohereForAI C4AI Command через API, предоставляемое платформой Hugging Face Space. Он позволяет генерировать текст на основе предоставленных сообщений и управлять диалогом, поддерживая как стриминг ответов, так и генерацию заголовков.

## Подробней

Этот модуль предоставляет класс `CohereForAI_C4AI_Command`, который наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`. Он использует асинхронные запросы для взаимодействия с API, форматирует запросы и обрабатывает ответы в формате JSON. Модуль поддерживает выбор модели, передачу истории разговоров и проксирование запросов. Он также обеспечивает обработку ошибок и генерацию заголовков для диалогов.

## Классы

### `CohereForAI_C4AI_Command`

**Описание**: Класс для взаимодействия с моделями CohereForAI C4AI Command через API Hugging Face Space.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:

- `label` (str): Название провайдера - "CohereForAI C4AI Command".
- `url` (str): URL API Hugging Face Space.
- `conversation_url` (str): URL для управления диалогами.
- `working` (bool): Указывает, что провайдер находится в рабочем состоянии.
- `default_model` (str): Модель по умолчанию - "command-a-03-2025".
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `models` (list): Список доступных моделей.

**Методы**:

- `get_model(model: str, **kwargs) -> str`: Возвращает полное имя модели на основе псевдонима.
- `create_async_generator(model: str, messages: Messages, api_key: str = None, proxy: str = None, conversation: JsonConversation = None, return_conversation: bool = False, **kwargs) -> AsyncResult`: Создает асинхронный генератор для взаимодействия с API.

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str, **kwargs) -> str:
        """
        Возвращает полное имя модели на основе псевдонима.

        Args:
            model (str): Псевдоним модели.
            **kwargs: Дополнительные аргументы.

        Returns:
            str: Полное имя модели.
        """
        ...
```

**Назначение**:
Функция определяет полное имя модели на основе предоставленного псевдонима. Если модель находится в списке псевдонимов, возвращается соответствующее значение. В противном случае вызывается метод `get_model` из родительского класса.

**Параметры**:

- `model` (str): Псевдоним модели.
- `**kwargs`: Дополнительные аргументы, которые передаются в родительский метод `get_model`.

**Возвращает**:

- `str`: Полное имя модели.

**Как работает функция**:

1. **Проверка псевдонима**: Функция проверяет, содержится ли предоставленный `model` в значениях `model_aliases`.
2. **Возврат полного имени**: Если псевдоним найден, функция возвращает соответствующее ему полное имя модели.
3. **Вызов родительского метода**: Если псевдоним не найден, функция вызывает метод `get_model` из родительского класса `super().get_model(model, **kwargs)`.

```
Проверка псевдонима -> Возврат полного имени
        |
        Нет
        ↓
Вызов родительского метода
```

**Примеры**:

```python
# Пример 1: Получение полного имени модели по псевдониму
model_name = CohereForAI_C4AI_Command.get_model("command-r")
print(model_name)  # Вывод: command-a-03-2025

# Пример 2: Получение полного имени модели, если псевдоним отсутствует
model_name = CohereForAI_C4AI_Command.get_model("unknown_model")
# В данном случае будет вызван метод из родительского класса
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls, model: str, messages: Messages,
        api_key: str = None, 
        proxy: str = None,
        conversation: JsonConversation = None,
        return_conversation: bool = False,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с API.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений для отправки.
            api_key (str, optional): API ключ. По умолчанию `None`.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            conversation (JsonConversation, optional): Объект диалога. По умолчанию `None`.
            return_conversation (bool, optional): Возвращать ли объект диалога. По умолчанию `False`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов от API.
        """
        ...
```

**Назначение**:
Функция создает асинхронный генератор для взаимодействия с API CohereForAI C4AI Command. Она обрабатывает сообщения, устанавливает заголовки, управляет состоянием разговора и возвращает результаты в виде асинхронного генератора.

**Параметры**:

- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `api_key` (str, optional): API ключ для аутентификации. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `conversation` (JsonConversation, optional): Объект, представляющий текущий диалог. По умолчанию `None`.
- `return_conversation` (bool, optional): Флаг, указывающий, следует ли возвращать объект диалога. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Как работает функция**:

1. **Получение модели**: Функция вызывает `cls.get_model(model)` для получения имени модели.
2. **Подготовка заголовков**: Формируются HTTP-заголовки для запроса, включая `Origin`, `User-Agent`, `Accept`, `Accept-Language`, `Referer`, `Sec-Fetch-Dest`, `Sec-Fetch-Mode`, `Sec-Fetch-Site` и `Priority`. Если предоставлен `api_key`, добавляется заголовок `Authorization`.
3. **Создание сессии**: Создается асинхронная сессия `ClientSession` с заданными заголовками и куками (если есть объект диалога).
4. **Обработка сообщений**:
   - Извлекается системное сообщение из списка сообщений.
   - Форматируются входные сообщения.
5. **Управление диалогом**:
   - Если отсутствует объект диалога или модель/системное сообщение отличаются от текущего состояния, создается новый диалог.
   - Отправляется POST-запрос на `cls.conversation_url` с данными модели и системным сообщением.
   - Создается или обновляется объект `JsonConversation` с данными ответа и куками.
   - Если `return_conversation` имеет значение `True`, объект диалога возвращается через генератор.
6. **Получение идентификатора сообщения**:
   - Отправляется GET-запрос на URL с идентификатором диалога для получения данных о последнем сообщении.
   - Извлекается `message_id` из полученных данных.
7. **Формирование данных для запроса**:
   - Создается объект `FormData` с входными данными, идентификатором сообщения и параметрами запроса.
8. **Отправка запроса и обработка ответа**:
   - Отправляется POST-запрос на URL диалога с данными `FormData`.
   - Обрабатываются чанки ответа:
     - Если `data["type"] == "stream"`, возвращается текст.
     - Если `data["type"] == "title"`, возвращается заголовок.
     - Если `data["type"] == "finalAnswer"`, обработка завершается.

```
Получение модели -> Подготовка заголовков -> Создание сессии
        |
        Обработка сообщений -> Управление диалогом -> Получение идентификатора сообщения
        |
        Формирование данных для запроса -> Отправка запроса и обработка ответа
```

**Примеры**:

```python
# Пример 1: Создание асинхронного генератора с минимальными параметрами
async def main():
    messages = [{"role": "user", "content": "Hello, world!"}]
    async for response in CohereForAI_C4AI_Command.create_async_generator(model="command-a", messages=messages):
        print(response)

# Пример 2: Создание асинхронного генератора с API ключом и прокси
async def main():
    messages = [{"role": "user", "content": "Tell me a joke."}]
    async for response in CohereForAI_C4AI_Command.create_async_generator(model="command-r", messages=messages, api_key="YOUR_API_KEY", proxy="http://your_proxy:8080"):
        print(response)