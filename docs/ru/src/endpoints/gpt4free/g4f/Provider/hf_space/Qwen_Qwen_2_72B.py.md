# Модуль `Qwen_Qwen_2_72B`

## Обзор

Модуль предоставляет класс `Qwen_Qwen_2_72B`, который является асинхронным генератором для взаимодействия с моделью Qwen Qwen-2.72B через API Hugging Face Space. Он поддерживает потоковую передачу данных, системные сообщения и предоставляет возможность работы через прокси.

## Подробнее

Модуль предназначен для использования в асинхронных приложениях, требующих взаимодействия с большими языковыми моделями. Он обеспечивает удобный интерфейс для отправки запросов и получения ответов в режиме реального времени.

## Классы

### `Qwen_Qwen_2_72B`

**Описание**: Класс реализует асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.72B.
**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного генератора.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдеров.

**Атрибуты**:
- `label` (str): Метка провайдера, `"Qwen Qwen-2.72B"`.
- `url` (str): URL главной страницы сервиса, `"https://qwen-qwen2-72b-instruct.hf.space"`.
- `api_endpoint` (str): URL API для отправки запросов, `"https://qwen-qwen2-72b-instruct.hf.space/queue/join?"`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера, `True`.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных, `True`.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений, `True`.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений, `False`.
- `default_model` (str): Модель, используемая по умолчанию, `"qwen-qwen2-72b-instruct"`.
- `model_aliases` (dict): Алиасы моделей, `{"qwen-2-72b": default_model}`.
- `models` (list): Список поддерживаемых моделей, формируется на основе ключей `model_aliases`.

**Методы**:

- `create_async_generator`
    - Краткое описание:
    Создает асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.72B.
    - Параметры:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Список сообщений для отправки.
        - `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        - `**kwargs`: Дополнительные аргументы.
    - Возвращает:
        - `AsyncResult`: Асинхронный генератор, выдающий части ответа модели.

## Методы класса

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.72B.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий части ответа модели.

    """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с моделью Qwen Qwen-2.72B.

**Параметры**:
- `cls`: Ссылка на класс `Qwen_Qwen_2_72B`.
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа модели.

**Внутренние функции**:

- `generate_session_hash`
    ```python
    def generate_session_hash():
        """Generate a unique session hash."""
        return str(uuid.uuid4()).replace('-', '')[:12]
    ```
    - Назначение:
        Генерация уникального идентификатора сессии.
    - Параметры:
        Отсутствуют.
    - Возвращает:
        str: Уникальный идентификатор сессии длиной 12 символов.

**Как работает функция**:
1. **Генерация уникального session_hash**:
   - Вызывается внутренняя функция `generate_session_hash()`, которая генерирует уникальный идентификатор сессии (`session_hash`) на основе UUID.

2. **Подготовка заголовков и полезной нагрузки для запроса**:
   - Определяются заголовки (`headers_join`), включающие `accept`, `accept-language`, `content-type`, `origin`, `referer` и `user-agent`.
   - Извлекается системное сообщение из списка сообщений (`messages`) и объединяется в строку `system_prompt`.
   - Форматируется основной запрос (`prompt`) на основе оставшихся сообщений.
   - Подготавливается полезная нагрузка (`payload_join`) для отправки запроса, включающая `prompt`, пустой список, `system_prompt`, индекс функции (`fn_index`), идентификатор триггера (`trigger_id`) и `session_hash`.

3. **Отправка запроса и обработка ответа**:
   - Используется `aiohttp.ClientSession()` для асинхронной отправки HTTP-запросов.
   - Отправляется POST-запрос к `cls.api_endpoint` с заголовками `headers_join` и полезной нагрузкой `payload_join`.
   - Извлекается `event_id` из JSON-ответа.

4. **Подготовка и отправка запроса потока данных**:
   - Формируется URL (`url_data`) для запроса потока данных.
   - Определяются заголовки (`headers_data`) для запроса потока данных.
   - Определяются параметры (`params_data`), включающие `session_hash`.
   - Отправляется GET-запрос к `url_data` с заголовками `headers_data` и параметрами `params_data`.

5. **Обработка потока данных**:
   - Асинхронно итерируется по строкам в ответе (`response.content`).
   - Декодируется каждая строка (`decoded_line`) из байтов в UTF-8.
   - Если строка начинается с `'data: '`, то извлекается JSON-данные из строки.
   - Если `'msg'` в JSON-данных равно `'process_generating'`, то извлекаются фрагменты текста из `output_data` и передаются через `yield`.
   - Если `'msg'` равно `'process_completed'`, то извлекается полный ответ из `output_data`, очищается от дубликатов и передается через `yield`.

6. **Обработка ошибок**:
   - Если возникает ошибка при разборе JSON, то она логируется с использованием `debug.log`.

**Примеры**:

Пример вызова функции:

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.hf_space.Qwen_Qwen_2_72B import Qwen_Qwen_2_72B
from src.typing import Messages

async def main():
    model = "qwen-2-72b"
    messages: Messages = [
        {"role": "system", "content": "Ты — полезный помощник."},
        {"role": "user", "content": "Привет! Как дела?"}
    ]

    async for fragment in Qwen_Qwen_2_72B.create_async_generator(model=model, messages=messages):
        print(fragment, end="")

if __name__ == "__main__":
    asyncio.run(main())
```
## Параметры класса

- `label` (str): Метка провайдера.
- `url` (str): URL главной страницы сервиса.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `model_aliases` (dict): Алиасы моделей.
- `models` (list): Список поддерживаемых моделей.