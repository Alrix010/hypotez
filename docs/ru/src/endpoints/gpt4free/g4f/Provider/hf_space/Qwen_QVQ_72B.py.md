# Модуль `Qwen_QVQ_72B`

## Обзор

Модуль `Qwen_QVQ_72B` предоставляет класс для взаимодействия с моделью Qwen QVQ-72B, размещенной на huggingface space. Он позволяет генерировать ответы на основе текстовых сообщений и изображений, используя асинхронные запросы к API.

## Подробней

Этот модуль является частью системы для работы с различными языковыми моделями. Он реализует асинхронный генератор для обработки запросов к API Qwen QVQ-72B. Модуль поддерживает как текстовые запросы, так и запросы с изображениями, загружая изображения через API и отправляя их вместе с текстовым запросом. Он обрабатывает ответы от API в режиме реального времени, предоставляя сгенерированный текст по частям.

## Классы

### `Qwen_QVQ_72B`

**Описание**: Класс `Qwen_QVQ_72B` предоставляет интерфейс для взаимодействия с моделью Qwen QVQ-72B.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию ответов.
- `ProviderModelMixin`: Добавляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера, значение: `"Qwen QVQ-72B"`.
- `url` (str): URL huggingface space, значение: `"https://qwen-qvq-72b-preview.hf.space"`.
- `api_endpoint` (str): Эндпоинт API для генерации, значение: `"/gradio_api/call/generate"`.
- `working` (bool): Указывает, работает ли провайдер, значение: `True`.
- `default_model` (str): Модель по умолчанию, значение: `"qwen-qvq-72b-preview"`.
- `default_vision_model` (str): Vision модель по умолчанию, значение: `"qwen-qvq-72b-preview"`.
- `model_aliases` (dict): Алиасы моделей, значение: `{"qvq-72b": default_vision_model}`.
- `vision_models` (list): Список vision моделей, значение: `list(model_aliases.keys())`.
- `models` (list): Список моделей, значение: `vision_models`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от модели.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls, model: str, messages: Messages,
    media: MediaListType = None,
    api_key: str = None, 
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от модели Qwen QVQ-72B.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки в модель.
        media (MediaListType, optional): Список медиафайлов (изображений) для отправки в модель. По умолчанию `None`.
        api_key (str, optional): API ключ для доступа к модели. По умолчанию `None`.
        proxy (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текст от модели.

    Raises:
        ResponseError: Если происходит ошибка при запросе к API.
        RuntimeError: Если не удается прочитать ответ от API.
    """
    ...
```

**Назначение**: Создает асинхронный генератор для получения ответов от модели Qwen QVQ-72B.

**Параметры**:
- `cls` (type): Ссылка на класс.
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки в модель.
- `media` (MediaListType, optional): Список медиафайлов (изображений) для отправки в модель. По умолчанию `None`.
- `api_key` (str, optional): API ключ для доступа к модели. По умолчанию `None`.
- `proxy` (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от модели.

**Вызывает исключения**:
- `ResponseError`: Если происходит ошибка при запросе к API.
- `RuntimeError`: Если не удается прочитать ответ от API.

**Как работает функция**:

1. **Подготовка заголовков**: Создаются заголовки запроса, включая `Accept` и `Authorization` (если предоставлен `api_key`).
2. **Создание сессии**: Создается асинхронная сессия `ClientSession` с заданными заголовками.
3. **Обработка медиафайлов (если есть)**:
   - Если `media` предоставлен, создается `FormData` для загрузки изображения.
   - Изображение преобразуется в байты.
   - Выполняется POST-запрос к эндпоинту `/gradio_api/upload` для загрузки изображения.
   - Полученный ответ содержит информацию об изображении, включая его путь.
   - Формируются данные для запроса, включающие путь к изображению и отформатированные сообщения.
4. **Обработка текстовых сообщений (если нет медиафайлов)**:
   - Если `media` отсутствует, формируются данные для запроса, включающие `None` для изображения и отформатированные сообщения.
5. **Отправка запроса на генерацию**:
   - Выполняется POST-запрос к эндпоинту `/gradio_api/call/generate` с данными запроса.
   - Полученный ответ содержит `event_id`.
6. **Получение сгенерированного текста**:
   - Выполняется GET-запрос к эндпоинту `/gradio_api/call/generate/{event_id}` для получения сгенерированного текста.
   - Ответ обрабатывается по частям (chunks).
   - Если chunk начинается с `event:`, извлекается тип события (например, `error`, `complete`, `generating`).
   - Если chunk начинается с `data:`, извлекаются данные.
   - В случае события `error`, вызывается исключение `ResponseError`.
   - В случае события `generating`, извлекается текст и возвращается через генератор.
   - В случае события `complete`, завершается генерация.

**ASCII Flowchart**:

```
Начало
↓
Создание заголовков и сессии
↓
Есть медиафайлы?
├──→ Да → Загрузка изображения → Формирование данных с путем к изображению
│   ↓
└──→ Нет → Формирование данных с None для изображения
↓
Отправка POST-запроса на генерацию
↓
Получение event_id
↓
Получение сгенерированного текста по частям
│   (цикл по chunks)
↓
Обработка события (error, complete, generating)
↓
Вывод текста через генератор (если generating)
↓
Завершение
```

**Примеры**:

1. **Текстовый запрос**:
   ```python
   messages = [{"role": "user", "content": "What is the capital of France?"}]
   generator = Qwen_QVQ_72B.create_async_generator(model="qwen-qvq-72b-preview", messages=messages)
   ```

2. **Запрос с изображением**:
   ```python
   messages = [{"role": "user", "content": "Describe this image."}]
   media = [("image.jpg", open("image.jpg", "rb").read())]
   generator = Qwen_QVQ_72B.create_async_generator(model="qwen-qvq-72b-preview", messages=messages, media=media)
   ```

3. **Использование API ключа**:
   ```python
   messages = [{"role": "user", "content": "What is the capital of France?"}]
   api_key = "YOUR_API_KEY"
   generator = Qwen_QVQ_72B.create_async_generator(model="qwen-qvq-72b-preview", messages=messages, api_key=api_key)
   ```