# Модуль ChatGpt

## Обзор

Модуль `ChatGpt` предоставляет класс `ChatGpt`, который является провайдером для взаимодействия с моделью ChatGpt. Он позволяет создавать запросы к модели и получать ответы, поддерживая историю сообщений, системные сообщения и потоковую передачу данных.

## Подробней

Модуль `ChatGpt` используется для интеграции с API ChatGpt. Он включает в себя методы для форматирования запросов, инициализации сессий, получения токенов и обработки ответов от модели.

## Классы

### `ChatGpt`

**Описание**: Класс `ChatGpt` является провайдером для взаимодействия с моделью ChatGpt.

**Наследует**:
- `AbstractProvider`: Абстрактный базовый класс для провайдеров.
- `ProviderModelMixin`: Миксин для работы с моделями провайдера.

**Аттрибуты**:
- `label` (str): Метка провайдера, `"ChatGpt"`.
- `url` (str): URL для ChatGpt, `"https://chatgpt.com"`.
- `working` (bool): Флаг, указывающий, работает ли провайдер, `False`.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений, `True`.
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения, `True`.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных, `True`.
- `default_model` (str): Модель по умолчанию, `'auto'`.
- `models` (list): Список поддерживаемых моделей, включающий `default_model`, `'gpt-3.5-turbo'`, `'gpt-4o'`, `'gpt-4o-mini'`, `'gpt-4'`, `'gpt-4-turbo'`, `'chatgpt-4o-latest'`.
- `model_aliases` (dict): Словарь псевдонимов моделей, `{"gpt-4o": "chatgpt-4o-latest"}`.

**Методы**:
- `get_model(model: str) -> str`: Возвращает модель, используя псевдонимы, если необходимо.
- `create_completion(model: str, messages: Messages, stream: bool, **kwargs) -> CreateResult`: Создает запрос на завершение и возвращает результат.

### `ChatGpt.get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """
        Получает имя модели, используя псевдонимы, если необходимо.

        Args:
            model (str): Имя модели.

        Returns:
            str: Имя модели, которое будет использоваться.
        """
        ...
```

**Назначение**: Получает имя модели, используя псевдонимы, если необходимо.

**Параметры**:
- `model` (str): Имя модели.

**Возвращает**:
- `str`: Имя модели, которое будет использоваться.

**Как работает функция**:
1. Проверяет, есть ли модель в списке поддерживаемых моделей.
2. Если нет, проверяет, есть ли псевдоним для этой модели.
3. Если псевдоним есть, возвращает псевдоним.
4. Если нет ни модели, ни псевдонима, возвращает модель по умолчанию.

```ascii
    Проверка наличия модели в списке поддерживаемых моделей
    │
    └───> Модель в списке?
         │   └───> Да: Возврат модели
         │   └───> Нет: Проверка наличия псевдонима для модели
         │        │
         │        └───> Псевдоним существует?
         │             │   └───> Да: Возврат псевдонима
         │             │   └───> Нет: Возврат модели по умолчанию
         │             │
         └───> Конец
```

**Примеры**:
```python
    model = ChatGpt.get_model('gpt-4o')
    print(model)  # Вывод: chatgpt-4o-latest

    model = ChatGpt.get_model('gpt-3.5-turbo')
    print(model)  # Вывод: gpt-3.5-turbo

    model = ChatGpt.get_model('unknown-model')
    print(model)  # Вывод: auto
```

### `ChatGpt.create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        **kwargs
    ) -> CreateResult:
        """
        Создает запрос на завершение и возвращает результат.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений.
            stream (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
            **kwargs: Дополнительные аргументы.

        Returns:
            CreateResult: Результат создания запроса.

        Raises:
            ValueError: Если указанная модель недоступна.
        """
        ...
```

**Назначение**: Создает запрос на завершение и возвращает результат.

**Параметры**:
- `model` (str): Имя модели.
- `messages` (Messages): Список сообщений.
- `stream` (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Результат создания запроса.

**Вызывает исключения**:
- `ValueError`: Если указанная модель недоступна.

**Как работает функция**:
1. Получает имя модели с помощью `cls.get_model(model)`.
2. Проверяет, доступна ли полученная модель.
3. Если модель недоступна, вызывает исключение `ValueError`.
4. Инициализирует сессию с пользовательским агентом.
5. Получает конфигурацию и токен требований.
6. Формирует заголовки запроса.
7. Отправляет запрос к API ChatGpt для получения turnstile и proofofwork.
8. Если требуется turnstile, обрабатывает его.
9. Формирует данные запроса в формате JSON.
10. Отправляет запрос к API ChatGpt для получения ответа.
11. Обрабатывает ответ и возвращает результат.

**Внутренние функции**: Отсутствуют.

```ascii
    Получение имени модели
    │
    └───> Проверка доступности модели
         │   └───> Модель доступна?
         │        │   └───> Нет: Вызов исключения ValueError
         │        │   └───> Да: Инициализация сессии
         │        │        │
         │        │        └───> Получение конфигурации и токена требований
         │        │             │
         │        │             └───> Формирование заголовков запроса
         │        │                  │
         │        │                  └───> Отправка запроса для получения turnstile и proofofwork
         │        │                       │
         │        │                       └───> Требуется turnstile?
         │        │                            │   └───> Да: Обработка turnstile
         │        │                            │   └───> Нет: Пропуск обработки turnstile
         │        │                            │
         │        │                            └───> Формирование данных запроса в формате JSON
         │        │                                 │
         │        │                                 └───> Отправка запроса для получения ответа
         │        │                                      │
         │        │                                      └───> Обработка ответа и возврат результата
         │        │
         └───> Конец
```

**Примеры**:
```python
    messages = [{'role': 'user', 'content': 'Hello, how are you?'}]
    stream = False
    try:
        result = ChatGpt.create_completion(model='gpt-3.5-turbo', messages=messages, stream=stream)
        print(result)
    except ValueError as ex:
        print(f"Error: {ex}")
```

## Функции

### `format_conversation`

```python
def format_conversation(messages: list):
    """
    Форматирует список сообщений в формат, ожидаемый API ChatGpt.

    Args:
        messages (list): Список сообщений, где каждое сообщение представляет собой словарь
                       с ключами 'role' (роль отправителя: 'user' или 'assistant')
                       и 'content' (содержание сообщения).

    Returns:
        list: Список сообщений, отформатированных для API ChatGpt. Каждое сообщение
              представляет собой словарь с ключами:
                - 'id' (str): Уникальный идентификатор сообщения (UUID4).
                - 'author' (dict): Информация об авторе сообщения, содержащая ключ 'role'.
                - 'content' (dict): Содержание сообщения, содержащее:
                    - 'content_type' (str): Тип содержимого ('text').
                    - 'parts' (list): Список частей содержимого (сообщение в виде списка строк).
                - 'metadata' (dict): Метаданные сообщения, содержащие информацию о смещениях символов.
                - 'create_time' (float): Время создания сообщения (timestamp).
    """
    ...
```

**Назначение**: Форматирует список сообщений в формат, ожидаемый API ChatGpt.

**Параметры**:
- `messages` (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами `'role'` (роль отправителя: `'user'` или `'assistant'`) и `'content'` (содержание сообщения).

**Возвращает**:
- `list`: Список сообщений, отформатированных для API ChatGpt. Каждое сообщение представляет собой словарь с ключами:
    - `'id'` (str): Уникальный идентификатор сообщения (UUID4).
    - `'author'` (dict): Информация об авторе сообщения, содержащая ключ `'role'`.
    - `'content'` (dict): Содержание сообщения, содержащее:
        - `'content_type'` (str): Тип содержимого (`'text'`).
        - `'parts'` (list): Список частей содержимого (сообщение в виде списка строк).
    - `'metadata'` (dict): Метаданные сообщения, содержащие информацию о смещениях символов.
    - `'create_time'` (float): Время создания сообщения (timestamp).

**Как работает функция**:
1. Инициализирует пустой список `conversation`.
2. Проходит по каждому сообщению в списке `messages`.
3. Для каждого сообщения создает словарь с необходимой структурой, включая:
    - Уникальный `id` (UUID4).
    - Информацию об `author` (роль).
    - `content` с типом `'text'` и содержанием сообщения.
    - `metadata`.
    - `create_time` (текущее время).
4. Добавляет отформатированное сообщение в список `conversation`.
5. Возвращает список `conversation`.

**Внутренние функции**: Отсутствуют.

```ascii
    Начало
    │
    └───> Инициализация списка conversation
    │
    └───> Для каждого message в messages:
         │   └───> Создание словаря message_data
         │   │    └───> Генерация UUID для id
         │   │    └───> Заполнение author (role)
         │   │    └───> Заполнение content (content_type, parts)
         │   │    └───> Заполнение metadata
         │   │    └───> Получение текущего времени для create_time
         │   │    └───> Добавление message_data в conversation
         │
    └───> Возврат conversation
    │
    Конец
```

**Примеры**:
```python
    messages = [
        {'role': 'user', 'content': 'Hello!'},
        {'role': 'assistant', 'content': 'Hi there!'}
    ]
    formatted_messages = format_conversation(messages)
    print(formatted_messages)
```

### `init_session`

```python
def init_session(user_agent):
    """
    Инициализирует сессию requests с необходимыми заголовками и куками.

    Args:
        user_agent (str): User-agent для сессии.

    Returns:
        Session: Инициализированная сессия requests.
    """
    ...
```

**Назначение**: Инициализирует сессию `requests` с необходимыми заголовками и куками.

**Параметры**:
- `user_agent` (str): User-agent для сессии.

**Возвращает**:
- `Session`: Инициализированная сессия `requests`.

**Как работает функция**:
1. Создает объект сессии `requests.Session()`.
2. Определяет необходимые куки `_dd_s`.
3. Определяет необходимые заголовки, включая `accept`, `accept-language`, `cache-control`, `user-agent` и другие.
4. Выполняет GET-запрос к `https://chatgpt.com/` с указанными куками и заголовками для инициализации сессии.
5. Возвращает настроенную сессию.

**Внутренние функции**: Отсутствуют.

```ascii
    Начало
    │
    └───> Создание сессии
    │
    └───> Определение кук
    │
    └───> Определение заголовков
    │
    └───> Выполнение GET-запроса к chatgpt.com
    │
    └───> Возврат сессии
    │
    Конец
```

**Примеры**:
```python
    user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36'
    session = init_session(user_agent)
    print(session)