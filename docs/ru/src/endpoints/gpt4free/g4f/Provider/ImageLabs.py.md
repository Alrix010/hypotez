# Модуль для работы с ImageLabs API для генерации изображений
==============================================================

Модуль содержит класс `ImageLabs`, который используется для взаимодействия с API ImageLabs для генерации изображений на основе текстовых запросов.

## Обзор

Этот модуль предоставляет интерфейс для генерации изображений с использованием API ImageLabs. Он поддерживает асинхронные запросы и предоставляет возможность указания различных параметров генерации, таких как модель, промпт, размеры изображения и негативный промпт.

## Подробнее

Модуль `ImageLabs` является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими функциональности генерации изображений. Он использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов к API ImageLabs.

## Классы

### `ImageLabs`

**Описание**: Класс для взаимодействия с API ImageLabs для генерации изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL API ImageLabs.
- `api_endpoint` (str): URL для запроса генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`sdxl-turbo`).
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `image_models` (List[str]): Список поддерживаемых моделей изображений.
- `models` (List[str]): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для генерации изображений.
- `get_model`: Возвращает модель по умолчанию.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    # Image
    prompt: str = None,
    negative_prompt: str = "",
    width: int = 1152,
    height: int = 896,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для генерации изображений.

    Args:
        cls (ImageLabs): Класс ImageLabs.
        model (str): Модель для генерации изображений.
        messages (Messages): Список сообщений.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
        negative_prompt (str, optional): Негативный промпт для генерации изображения. По умолчанию "".
        width (int, optional): Ширина изображения. По умолчанию 1152.
        height (int, optional): Высота изображения. По умолчанию 896.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse`.

    Raises:
        Exception: Если возникает ошибка при генерации изображения.

    """
```

**Назначение**: Создает асинхронный генератор для генерации изображений на основе предоставленных параметров.

**Параметры**:
- `model` (str): Модель, используемая для генерации изображения.
- `messages` (Messages): Список сообщений, содержащий текстовый запрос.
- `proxy` (str, optional): URL прокси-сервера для использования при запросах. По умолчанию `None`.
- `prompt` (str, optional): Текстовый запрос для генерации изображения. Если не указан, берется из последнего сообщения. По умолчанию `None`.
- `negative_prompt` (str, optional): Указания, что не должно быть на изображении. По умолчанию "".
- `width` (int, optional): Ширина генерируемого изображения в пикселях. По умолчанию 1152.
- `height` (int, optional): Высота генерируемого изображения в пикселях. По умолчанию 896.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API ImageLabs.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает объекты `ImageResponse`, содержащие URL сгенерированного изображения.

**Вызывает исключения**:
- `Exception`: Если API ImageLabs возвращает ошибку в процессе генерации изображения.

**Как работает функция**:

1. **Инициализация**: Функция принимает параметры для генерации изображения, включая модель, текстовый запрос (промпт), размеры изображения и другие настройки.

2. **Формирование заголовков**: Создаются заголовки HTTP-запроса, которые включают информацию о типе контента, User-Agent и Referer.

3. **Создание асинхронной сессии**: Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов.

4. **Определение промпта**: Если промпт не указан явно, он извлекается из последнего сообщения в списке `messages`.

5. **Формирование payload**: Создается JSON-payload с параметрами запроса для API ImageLabs, включая промпт, seed, размеры изображения и негативный промпт.

6. **Запрос на генерацию**: Отправляется POST-запрос к API ImageLabs (`/txt2img`) с сформированным payload.

7. **Получение task_id**: Из ответа извлекается `task_id`, который используется для отслеживания прогресса генерации изображения.

8. **Опрос прогресса**: В цикле отправляются POST-запросы к API ImageLabs (`/progress`) для получения информации о прогрессе генерации изображения.

9. **Обработка ответа о прогрессе**:
   - Если статус `Done` или получен `final_image_url`, генератор возвращает объект `ImageResponse` с URL изображения и завершает работу.
   - Если статус содержит `error`, выбрасывается исключение `Exception` с сообщением об ошибке.

10. **Ожидание между опросами**: Если генерация еще не завершена, функция ожидает 1 секунду перед следующим запросом.

```
A: Инициализация параметров
|
B: Формирование заголовков
|
C: Создание асинхронной сессии
|
D: Определение промпта
|
E: Формирование payload
|
F: Запрос на генерацию
|
G: Получение task_id
|
H: Опрос прогресса
|
I: Обработка ответа о прогрессе (проверка статуса)
|
J: Если статус "Done" или получен URL -> возврат ImageResponse и завершение
|
K: Если статус "Error" -> выброс исключения
|
L: Ожидание между опросами
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from src.endpoints.gpt4free.g4f.Provider.ImageLabs import ImageLabs
async def main():
    model = "sdxl-turbo"
    messages = [{"content": "A beautiful sunset over the ocean"}]
    async for image_response in ImageLabs.create_async_generator(model=model, messages=messages):
        print(image_response.images)

if __name__ == "__main__":
    asyncio.run(main())
```

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """Возвращает модель по умолчанию.

    Args:
        cls (ImageLabs): Класс ImageLabs.
        model (str): Модель для генерации изображений.

    Returns:
        str: Модель, используемая по умолчанию (`sdxl-turbo`).
    """
```

**Назначение**: Возвращает модель по умолчанию для генерации изображений.

**Параметры**:
- `model` (str): Модель для генерации изображений (не используется).

**Возвращает**:
- `str`: Модель, используемая по умолчанию (`sdxl-turbo`).

**Как работает функция**:
Функция просто возвращает значение атрибута `cls.default_model`, который представляет собой модель, используемую по умолчанию. Параметр `model` игнорируется.

```
A: Получение модели по умолчанию (default_model)
|
B: Возврат модели по умолчанию
```

**Примеры**:

```python
# Пример использования get_model
from src.endpoints.gpt4free.g4f.Provider.ImageLabs import ImageLabs
model = ImageLabs.get_model("any_model")
print(model)  # Вывод: "sdxl-turbo"