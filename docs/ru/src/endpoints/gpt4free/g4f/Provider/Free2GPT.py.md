# Модуль для работы с провайдером Free2GPT
==========================================

Модуль содержит класс `Free2GPT`, который используется для взаимодействия с сервисом Free2GPT для генерации текста.
В модуле реализована поддержка асинхронного взаимодействия с API Free2GPT, включая обработку ошибок и ограничений скорости.

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [Free2GPT](#free2gpt)
- [Функции](#функции)
    - [generate_signature](#generate_signature)

## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с API Free2GPT. 
Он включает в себя класс `Free2GPT`, который наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`, 
обеспечивая поддержку асинхронной генерации текста и выбора моделей. 
Модуль также содержит функцию `generate_signature` для создания подписи запросов.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для использования в качестве одного из провайдеров 
для генерации текста. Он использует асинхронные запросы для взаимодействия с API Free2GPT, 
что позволяет эффективно обрабатывать большое количество запросов. 
Расположение модуля в проекте указывает на его роль как одного из компонентов системы, 
предоставляющих доступ к различным моделям генерации текста.

## Классы

### `Free2GPT`

**Описание**: Класс для взаимодействия с API Free2GPT.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает поддержку асинхронной генерации.
- `ProviderModelMixin`: Предоставляет функциональность для выбора моделей.

**Атрибуты**:
- `url` (str): URL API Free2GPT.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (List[str]): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения текста от API Free2GPT.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    connector: BaseConnector = None,
    **kwargs,
) -> AsyncResult:
    """Создает асинхронный генератор для получения текста от API Free2GPT.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        connector (BaseConnector, optional): Aiohttp коннектор. По умолчанию `None`.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текст от API.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: При возникновении других ошибок при запросе.
    """
```

**Назначение**: Создает асинхронный генератор для получения текста от API Free2GPT.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `connector` (BaseConnector, optional): Aiohttp коннектор. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от API.

**Вызывает исключения**:
- `RateLimitError`: Если достигнут лимит запросов.
- `Exception`: При возникновении других ошибок при запросе.

**Как работает функция**:

1. **Подготовка заголовков**: Функция подготавливает заголовки HTTP-запроса, включая User-Agent, Accept, Content-Type, Referer и Origin.
2. **Создание сессии**: Создается асинхронная сессия `ClientSession` с использованием предоставленного коннектора и заголовков.
3. **Формирование данных**: Формируются данные для отправки в теле запроса, включая сообщения, временную метку и подпись, сгенерированную функцией `generate_signature`.
4. **Отправка запроса**: Отправляется POST-запрос к API Free2GPT с использованием асинхронной сессии.
5. **Обработка ответа**: Обрабатывается ответ от API. Если статус ответа равен 500 и в тексте ответа содержится "Quota exceeded", выбрасывается исключение `RateLimitError`.
6. **Генерация чанков**: Если ответ успешен, функция начинает асинхронно итерировать по содержимому ответа и декодировать каждый чанк, возвращая его как часть асинхронного генератора.

```
Подготовка заголовков --> Создание асинхронной сессии --> Формирование данных --> Отправка POST-запроса --> Обработка ответа (проверка на RateLimitError) --> Генерация и возврат чанков
```

**Примеры**:

Пример использования `create_async_generator`:

```python
model = 'gemini-1.5-pro'
messages = [{"role": "user", "content": "Hello, world!"}]
async for chunk in Free2GPT.create_async_generator(model=model, messages=messages):
    print(chunk, end="")
```

## Функции

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """Генерирует подпись для запроса к API Free2GPT.

    Args:
        time (int): Временная метка.
        text (str): Текст сообщения.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Подпись, сгенерированная с использованием SHA256.
    """
```

**Назначение**: Генерирует подпись для запроса к API Free2GPT.

**Параметры**:
- `time` (int): Временная метка.
- `text` (str): Текст сообщения.
- `secret` (str, optional): Секретный ключ. По умолчанию "".

**Возвращает**:
- `str`: Подпись, сгенерированная с использованием SHA256.

**Как работает функция**:

1. **Формирование сообщения**: Функция формирует строку сообщения, объединяя временную метку, текст сообщения и секретный ключ через двоеточие.
2. **Кодирование сообщения**: Строка сообщения кодируется в байты.
3. **Вычисление SHA256**: Вычисляется SHA256 хэш от закодированного сообщения.
4. **Возврат хэша**: Хэш преобразуется в шестнадцатеричное представление и возвращается.

```
Формирование сообщения --> Кодирование сообщения в байты --> Вычисление SHA256 хэша --> Преобразование хэша в шестнадцатеричное представление и возврат
```

**Примеры**:

Пример использования `generate_signature`:

```python
time = int(time.time() * 1e3)
text = "Hello, world!"
signature = generate_signature(time, text)
print(signature)