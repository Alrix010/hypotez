## Модуль OpenaiChat.py

## Обзор

Модуль `OpenaiChat.py` предназначен для создания и управления диалогами с использованием сервиса OpenAI ChatGPT. Он обеспечивает асинхронную аутентификацию, загрузку изображений, создание сообщений и взаимодействие с API OpenAI для генерации текста и изображений. Модуль поддерживает работу с различными моделями, включая GPT-4, и предоставляет возможность использования истории сообщений и системных подсказок.

## Подробнее

Модуль `OpenaiChat` является частью проекта `hypotez` и предназначен для интеграции с сервисом OpenAI ChatGPT. Он использует асинхронные запросы для взаимодействия с API OpenAI, обеспечивая эффективную и неблокирующую работу. Модуль также поддерживает загрузку изображений и включение их в диалог, что позволяет создавать мультимодальные запросы.

## Классы

### `OpenaiChat`

**Описание**: Класс для создания и управления диалогами с сервисом OpenAI ChatGPT.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает асинхронную аутентификацию.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера ("OpenAI ChatGPT").
- `url` (str): URL сервиса ("https://chatgpt.com").
- `working` (bool): Флаг, указывающий, что провайдер работает (`True`).
- `use_nodriver` (bool): Флаг, указывающий на использование бездрайверного режима (`True`).
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку GPT-4 (`True`).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (`True`).
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель для генерации изображений, используемая по умолчанию.
- `image_models` (list): Список моделей для генерации изображений.
- `vision_models` (list): Список моделей для работы с текстом.
- `models` (list): Список поддерживаемых моделей.
- `synthesize_content_type` (str): Тип контента для синтеза речи ("audio/aac").
- `request_config` (RequestConfig): Объект конфигурации запросов.
- `_api_key` (str): API-ключ для аутентификации.
- `_headers` (dict): Заголовки запросов.
- `_cookies` (Cookies): Куки для аутентификации.
- `_expires` (int): Время истечения срока действия API-ключа.

**Принцип работы**:

Класс `OpenaiChat` предоставляет интерфейс для взаимодействия с API OpenAI ChatGPT. Он выполняет аутентификацию, создает сообщения, загружает изображения и отправляет запросы на генерацию текста и изображений. Класс также поддерживает управление диалогами, включая сохранение истории сообщений и использование системных подсказок.

**Методы**:
- `on_auth_async`: Асинхронный метод для аутентификации.
- `upload_images`: Асинхронный метод для загрузки изображений.
- `create_messages`: Метод для создания списка сообщений.
- `get_generated_image`: Асинхронный метод для получения сгенерированного изображения.
- `create_authed`: Асинхронный метод для создания генератора диалогов.
- `iter_messages_line`: Асинхронный метод для итерации по строкам сообщений.
- `synthesize`: Асинхронный метод для синтеза речи.
- `login`: Асинхронный метод для входа в систему.
- `nodriver_auth`: Асинхронный метод для аутентификации без драйвера.
- `get_default_headers`: Статический метод для получения заголовков по умолчанию.
- `_create_request_args`: Метод для создания аргументов запроса.
- `_update_request_args`: Метод для обновления аргументов запроса.
- `_set_api_key`: Метод для установки API-ключа.
- `_update_cookie_header`: Метод для обновления заголовка куки.

### `Conversation`

**Описание**: Класс для инкапсуляции полей ответа.

**Наследует**:
- `JsonConversation`: Класс для работы с JSON-ответами.

**Атрибуты**:
- `conversation_id` (str): Идентификатор диалога.
- `message_id` (str): Идентификатор сообщения.
- `user_id` (str): Идентификатор пользователя.
- `finish_reason` (str): Причина завершения диалога.
- `parent_message_id` (str): Идентификатор родительского сообщения.
- `is_thinking` (bool): Флаг, указывающий, что диалог находится в состоянии "размышления".

## Функции

### `on_auth_async`

**Назначение**: Асинхронный метод для аутентификации.

**Параметры**:
- `proxy` (str, optional): Прокси для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, выдающий результаты аутентификации.

**Вызывает исключения**:
- `MissingAuthError`: Если отсутствует ключ API.

**Как работает функция**:
Функция выполняет асинхронную аутентификацию, используя метод `login`. Она генерирует чанки данных, содержащие результаты аутентификации, включая API-ключ, куки и заголовки.

### `upload_images`

**Назначение**: Асинхронная функция для загрузки изображений на сервис и получения URL для скачивания.

**Параметры**:
- `session` (StreamSession): Объект StreamSession для выполнения запросов.
- `auth_result` (AuthResult): Результат аутентификации, содержащий заголовки.
- `media` (MediaListType): Список изображений для загрузки (PIL Image или bytes).

**Возвращает**:
- `ImageRequest`: Объект ImageRequest, содержащий URL для скачивания, имя файла и другие данные.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка при загрузке изображения.

**Как работает функция**:
Функция загружает изображения на сервис OpenAI и возвращает URL для скачивания. Она преобразует изображения в формат bytes, получает метаданные изображения и выполняет POST-запросы для загрузки и получения URL.

**Внутренние функции**:
- `upload_image(image, image_name)`: Асинхронная функция для загрузки отдельного изображения.

### `create_messages`

**Назначение**: Функция для создания списка сообщений для пользовательского ввода.

**Параметры**:
- `messages` (Messages): Список предыдущих сообщений.
- `image_requests` (ImageRequest, optional): Объект ответа изображения, если есть. По умолчанию `None`.
- `system_hints` (list, optional): Список системных подсказок. По умолчанию `None`.

**Возвращает**:
- `list`: Список сообщений с пользовательским вводом и изображением, если есть.

**Как работает функция**:
Функция создает список сообщений, форматируя их для отправки в API OpenAI. Она обрабатывает текстовые и мультимодальные сообщения, включая изображения, и добавляет метаданные к сообщениям.

### `get_generated_image`

**Назначение**: Асинхронная функция для получения сгенерированного изображения.

**Параметры**:
- `session` (StreamSession): Объект StreamSession для выполнения запросов.
- `auth_result` (AuthResult): Результат аутентификации, содержащий заголовки.
- `element` (dict): Элемент, содержащий информацию об изображении.
- `prompt` (str, optional): Подсказка для генерации изображения. По умолчанию `None`.

**Возвращает**:
- `ImageResponse`: Объект ImageResponse, содержащий URL для скачивания изображения и подсказку.

**Вызывает исключения**:
- `RuntimeError`: Если не удается получить изображение или происходит ошибка при скачивании.

**Как работает функция**:
Функция получает сгенерированное изображение, используя информацию из элемента `element`. Она выполняет GET-запрос для получения URL для скачивания изображения и возвращает объект `ImageResponse`.

### `create_authed`

**Назначение**: Создание асинхронного генератора для беседы.

**Параметры**:
- `model` (str): Название модели.
- `messages` (Messages): Список предыдущих сообщений.
- `auth_result` (AuthResult): Результат аутентификации.
- `proxy` (str, optional): Прокси для использования при запросах. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания для запросов. По умолчанию 180.
- `auto_continue` (bool, optional): Флаг для автоматического продолжения беседы. По умолчанию `False`.
- `action` (str, optional): Тип действия ('next', 'continue', 'variant'). По умолчанию "next".
- `conversation` (Conversation, optional): Объект беседы. По умолчанию `None`.
- `media` (MediaListType, optional): Изображения для включения в беседу. По умолчанию `None`.
- `return_conversation` (bool, optional): Флаг для включения полей ответа в вывод. По умолчанию `False`.
- `web_search` (bool, optional): Флаг для включения веб-поиска. По умолчанию `False`.
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронные результаты от генератора.

**Вызывает исключения**:
- `RuntimeError`: Если возникает ошибка во время обработки.

**Как работает функция**:
Функция создает асинхронный генератор для беседы с использованием OpenAI. Она обрабатывает сообщения, изображения и выполняет запросы к API OpenAI для генерации текста и изображений.

### `iter_messages_line`

**Назначение**: Асинхронная функция для итерации по строкам сообщений.

**Параметры**:
- `session` (StreamSession): Объект StreamSession для выполнения запросов.
- `auth_result` (AuthResult): Результат аутентификации, содержащий заголовки.
- `line` (bytes): Строка сообщения в формате bytes.
- `fields` (Conversation): Объект Conversation, содержащий информацию о диалоге.
- `sources` (Sources): Объект Sources, содержащий источники информации.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, выдающий сообщения и другие данные.

**Как работает функция**:
Функция итерирует по строкам сообщений, обрабатывая различные типы данных, включая текст, изображения и метаданные. Она извлекает информацию из строк и возвращает ее в виде объектов.

### `synthesize`

**Назначение**: Асинхронная функция для синтеза речи.

**Параметры**:
- `params` (dict): Параметры для синтеза речи.

**Возвращает**:
- `AsyncIterator[bytes]`: Асинхронный итератор, выдающий байты синтезированной речи.

**Как работает функция**:
Функция выполняет синтез речи, используя API OpenAI. Она отправляет GET-запрос с параметрами синтеза и возвращает байты синтезированной речи.

### `login`

**Назначение**: Асинхронная функция для входа в систему.

**Параметры**:
- `proxy` (str, optional): Прокси для использования. По умолчанию `None`.
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `proof_token` (str, optional): Токен доказательства работы. По умолчанию `None`.
- `cookies` (Cookies, optional): Куки для аутентификации. По умолчанию `None`.
- `headers` (dict, optional): Заголовки для аутентификации. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, выдающий результаты входа в систему.

**Вызывает исключения**:
- `NoValidHarFileError`: Если не удается получить API-ключ из HAR-файла.

**Как работает функция**:
Функция выполняет вход в систему, используя API-ключ, куки и заголовки. Она получает API-ключ из HAR-файла или использует предоставленный API-ключ.

### `nodriver_auth`

**Назначение**: Асинхронная функция для аутентификации без драйвера.

**Параметры**:
- `proxy` (str, optional): Прокси для использования. По умолчанию `None`.

**Как работает функция**:
Функция выполняет аутентификацию без использования драйвера, используя библиотеку `nodriver`. Она открывает страницу в браузере, выполняет действия для получения API-ключа и сохраняет куки и заголовки.

### `get_default_headers`

**Назначение**: Статический метод для получения заголовков по умолчанию.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `Dict[str, str]`: Словарь заголовков по умолчанию.

**Как работает функция**:
Функция возвращает словарь заголовков по умолчанию, используемых для запросов к API OpenAI.

### `_create_request_args`

**Назначение**: Метод для создания аргументов запроса.

**Параметры**:
- `cookies` (Cookies, optional): Куки для аутентификации. По умолчанию `None`.
- `headers` (dict, optional): Заголовки для аутентификации. По умолчанию `None`.
- `user_agent` (str, optional): User-Agent для запроса. По умолчанию `None`.

**Как работает функция**:
Функция создает аргументы запроса, объединяя заголовки по умолчанию с предоставленными заголовками и куками.

### `_update_request_args`

**Назначение**: Метод для обновления аргументов запроса.

**Параметры**:
- `auth_result` (AuthResult): Результат аутентификации.
- `session` (StreamSession): Объект StreamSession для выполнения запросов.

**Как работает функция**:
Функция обновляет аргументы запроса, добавляя куки из сессии в результат аутентификации.

### `_set_api_key`

**Назначение**: Метод для установки API-ключа.

**Параметры**:
- `api_key` (str): API-ключ для аутентификации.

**Возвращает**:
- `bool`: `True`, если API-ключ установлен успешно, `False` в противном случае.

**Как работает функция**:
Функция устанавливает API-ключ и добавляет его в заголовки запроса. Она также проверяет срок действия API-ключа.

### `_update_cookie_header`

**Назначение**: Метод для обновления заголовка куки.

**Параметры**:
- Отсутствуют.

**Как работает функция**:
Функция обновляет заголовок куки, используя текущие куки.

## Функция `get_cookies`

**Назначение**: Функция для получения кукисов.

**Параметры**:
- `urls` (Optional[Iterator[str]], optional): Итератор URL-адресов, для которых нужно получить кукисы. По умолчанию `None`.

**Возвращает**:
- `Generator[Dict, Dict, Dict[str, str]]`: Генератор, возвращающий словарь кукисов.

**Как работает функция**:
Функция отправляет команду `Network.getCookies` в Chrome DevTools Protocol (CDP) для получения кукисов для указанных URL-адресов. Она возвращает словарь, содержащий имена и значения кукисов.

**Примеры**:
```python
# Пример получения кукисов для одного URL
urls = ["https://chatgpt.com"]
cookies = get_cookies(urls)
for cookie in cookies:
    print(cookie)

# Пример получения кукисов для нескольких URL
urls = ["https://chatgpt.com", "https://openai.com"]
cookies = get_cookies(urls)
for cookie in cookies:
    print(cookie)