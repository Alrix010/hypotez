# Модуль для работы с Microsoft Designer
=================================================

Модуль `MicrosoftDesigner` предоставляет инструменты для генерации изображений с использованием API Microsoft Designer. Он включает в себя функциональность для асинхронной генерации изображений, получения токенов доступа и управления запросами к API.

## Обзор

Этот модуль предназначен для интеграции с Microsoft Designer API для создания изображений на основе текстовых запросов. Он поддерживает различные размеры изображений и использует асинхронные запросы для эффективной обработки. Модуль также включает механизмы для аутентификации и получения необходимых токенов доступа.

## Подробнее

Модуль `MicrosoftDesigner` является частью системы, которая позволяет генерировать изображения, используя возможности Microsoft Designer. Он обрабатывает запросы на создание изображений, получает токены доступа и возвращает сгенерированные изображения. Модуль использует файлы HAR для получения токенов доступа и user-agent, а также поддерживает асинхронные запросы для повышения производительности.

## Классы

### `MicrosoftDesigner`

**Описание**: Класс `MicrosoftDesigner` предоставляет методы для взаимодействия с API Microsoft Designer для генерации изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера, `"Microsoft Designer"`.
- `url` (str): URL Microsoft Designer, `"https://designer.microsoft.com"`.
- `working` (bool): Указывает, работает ли провайдер, `True`.
- `use_nodriver` (bool): Указывает, использовать ли бездрайверный режим, `True`.
- `needs_auth` (bool): Указывает, требуется ли аутентификация, `True`.
- `default_image_model` (str): Модель изображения по умолчанию, `"dall-e-3"`.
- `image_models` (List[str]): Список поддерживаемых моделей изображений, `[default_image_model, "1024x1024", "1024x1792", "1792x1024"]`.
- `models` (List[str]): Псевдоним для `image_models`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для генерации изображений.
- `generate`: Генерирует изображение на основе заданного запроса и размера.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для генерации изображений.

        Args:
            model (str): Модель для генерации изображений.
            messages (Messages): Сообщения для генерации изображения.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор изображений.

        Как работает функция:
        1. Определяет размер изображения на основе выбранной модели.
        2. Вызывает метод `generate` для создания изображения.
        3. Возвращает асинхронный генератор с результатом.

        Примеры:
            >>> async for image in MicrosoftDesigner.create_async_generator(model="dall-e-3", messages="example message"):
            ...     print(image)
        """
```

**Назначение**: Создает асинхронный генератор для генерации изображений.

**Параметры**:
- `model` (str): Модель для генерации изображений.
- `messages` (Messages): Сообщения для генерации изображения.
- `prompt` (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор изображений.

**Как работает функция**:

```
Определение размера изображения (image_size)  
│
└───> Вызов метода generate(prompt, image_size, proxy)  
│
└───> Возврат асинхронного генератора с результатом  
```

**Примеры**:

```python
async for image in MicrosoftDesigner.create_async_generator(model="dall-e-3", messages="example message"):
    print(image)
```

### `generate`

```python
    @classmethod
    async def generate(cls, prompt: str, image_size: str, proxy: str = None) -> ImageResponse:
        """Генерирует изображение на основе заданного запроса и размера.

        Args:
            prompt (str): Текстовый запрос для генерации изображения.
            image_size (str): Размер изображения.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            ImageResponse: Объект с информацией об изображении.

        Raises:
            NoValidHarFileError: Если не найдены валидные HAR-файлы.

        Как работает функция:
        1. Пытается прочитать токен доступа и user-agent из HAR-файлов.
        2. Если HAR-файлы не найдены или не содержат нужной информации, пытается получить токен доступа и user-agent с использованием браузера.
        3. Вызывает функцию `create_images` для создания изображений.
        4. Возвращает объект `ImageResponse` с информацией об изображениях.
        """
```

**Назначение**: Генерирует изображение на основе заданного запроса и размера.

**Параметры**:
- `prompt` (str): Текстовый запрос для генерации изображения.
- `image_size` (str): Размер изображения.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `ImageResponse`: Объект с информацией об изображении.

**Вызывает исключения**:
- `NoValidHarFileError`: Если не найдены валидные HAR-файлы.

**Как работает функция**:

```
Попытка чтения access_token и user_agent из HAR-файлов  
│
└───> Если HAR-файлы не найдены или не содержат нужной информации:
│     └───> Попытка получения access_token и user_agent с использованием браузера
│
└───> Вызов функции create_images(prompt, access_token, user_agent, image_size, proxy)  
│
└───> Возврат объекта ImageResponse с информацией об изображениях  
```

## Функции

### `create_images`

```python
async def create_images(prompt: str, access_token: str, user_agent: str, image_size: str, proxy: str = None, seed: int = None):
    """Создает изображения на основе заданного запроса, токена доступа и user-agent.

    Args:
        prompt (str): Текстовый запрос для генерации изображения.
        access_token (str): Токен доступа для аутентификации.
        user_agent (str): User-agent для запросов.
        image_size (str): Размер изображения.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.

    Returns:
        List[str]: Список URL сгенерированных изображений.
    """
```

**Назначение**: Создает изображения на основе заданного запроса, токена доступа и user-agent.

**Параметры**:
- `prompt` (str): Текстовый запрос для генерации изображения.
- `access_token` (str): Токен доступа для аутентификации.
- `user_agent` (str): User-agent для запросов.
- `image_size` (str): Размер изображения.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `seed` (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.

**Возвращает**:
- `List[str]`: Список URL сгенерированных изображений.

**Как работает функция**:

1.  **Инициализация**:
    *   Определение URL API для генерации изображений.
    *   Генерация случайного зерна (seed), если оно не предоставлено.
2.  **Формирование заголовков**:
    *   Создание словаря `headers` с необходимыми HTTP-заголовками, включая `User-Agent`, `Authorization` (с использованием токена доступа), и другие параметры, необходимые для запроса к API.
3.  **Формирование данных формы**:
    *   Создание объекта `aiohttp.FormData` и добавление полей, таких как `dalle-caption` (текстовый запрос), `dalle-scenario-name`, `dalle-batch-size`, `dalle-image-response-format`, `dalle-seed`, `ClientFlights`, `dalle-hear-back-in-ms`, `dalle-include-b64-thumbnails`, `dalle-aspect-ratio-scaling-factor-b64-thumbnails`, и `dalle-image-size`.
4.  **Отправка запроса и получение ответа**:
    *   Создание асинхронной сессии клиента с использованием `aiohttp.ClientSession` и `get_connector` для поддержки прокси.
    *   Отправка POST-запроса к API с заголовками и данными формы.
    *   Обработка ответа, включая проверку статуса с использованием `raise_for_status` и преобразование ответа в формат JSON.
5.  **Добавление дополнительных полей в форму**:
    *   Добавление полей `dalle-boost-count` и `dalle-poll-url` в объект `form_data` на основе данных, полученных из предыдущего ответа.
6.  **Опрос API**:
    *   Запуск бесконечного цикла для опроса API до тех пор, пока не будут получены изображения.
    *   Ожидание интервала, указанного в `polling_meta_data`.
    *   Отправка POST-запроса к API с обновленными заголовками и данными формы.
    *   Обработка ответа и извлечение URL изображений из `response_data`.
    *   Если изображения получены, функция возвращает список URL.

```
Инициализация URL и seed
│
└───> Формирование HTTP-заголовков (headers)
│
└───> Формирование данных формы (form_data)
│
└───> Отправка POST-запроса к API
│
└───> Получение и обработка ответа
│
└───> Добавление полей dalle-boost-count и dalle-poll-url в form_data
│
└───> Цикл опроса API
│     └───> Ожидание интервала poll_interval
│     └───> Отправка POST-запроса к API
│     └───> Получение и обработка ответа
│     └───> Извлечение URL изображений
│     └───> Возврат списка URL изображений (если они получены)
│
└───> Конец
```

### `readHAR`

```python
def readHAR(url: str) -> tuple[str, str]:
    """Читает HAR-файлы для получения токена доступа и user-agent.

    Args:
        url (str): URL для поиска в HAR-файлах.

    Returns:
        tuple[str, str]: Токен доступа и user-agent.

    Raises:
        NoValidHarFileError: Если не найдены валидные HAR-файлы.
    """
```

**Назначение**: Читает HAR-файлы для получения токена доступа и user-agent.

**Параметры**:
- `url` (str): URL для поиска в HAR-файлах.

**Возвращает**:
- `tuple[str, str]`: Токен доступа и user-agent.

**Вызывает исключения**:
- `NoValidHarFileError`: Если не найдены валидные HAR-файлы.

**Как работает функция**:

1.  **Инициализация**:
    *   Установка значений `api_key` и `user_agent` в `None`.
2.  **Итерация по HAR-файлам**:
    *   Получение списка путей к HAR-файлам с использованием функции `get_har_files()`.
    *   Итерация по каждому пути в списке.
3.  **Чтение и обработка HAR-файла**:
    *   Открытие каждого файла в режиме чтения байтов (`'rb'`).
    *   Попытка загрузки содержимого файла как JSON с использованием `json.loads()`.
    *   Если происходит ошибка `json.JSONDecodeError`, файл считается невалидным HAR-файлом, и цикл переходит к следующему файлу.
4.  **Поиск информации в HAR-файле**:
    *   Итерация по записям (`entries`) в секции `log` HAR-файла.
    *   Проверка, начинается ли URL запроса (`v['request']['url']`) с заданного `url`.
    *   Если URL совпадает, извлечение заголовков запроса с использованием функции `get_headers(v)`.
    *   Поиск заголовков `authorization` и `user-agent` в извлеченных заголовках.
    *   Если заголовок `authorization` найден, извлечение токена доступа (API key) из значения заголовка.
    *   Если заголовок `user-agent` найден, сохранение значения user-agent.
5.  **Проверка наличия токена доступа**:
    *   После завершения итерации по всем HAR-файлам, проверка, был ли найден токен доступа (`api_key`).
    *   Если токен доступа не найден (`api_key is None`), выбрасывается исключение `NoValidHarFileError` с сообщением об отсутствии токена доступа в HAR-файлах.
6.  **Возврат результатов**:
    *   Если токен доступа был найден, функция возвращает кортеж, содержащий `api_key` и `user_agent`.

```
Инициализация api_key и user_agent в None
│
└───> Итерация по HAR-файлам
│     └───> Чтение и обработка HAR-файла
│     └───> Поиск информации в HAR-файле (URL, headers)
│     └───> Извлечение api_key и user_agent из заголовков
│
└───> Проверка наличия api_key
│     └───> Если api_key is None:
│           └───> Выброс исключения NoValidHarFileError
│
└───> Возврат api_key и user_agent
```

### `get_access_token_and_user_agent`

```python
async def get_access_token_and_user_agent(url: str, proxy: str = None):
    """Получает токен доступа и user-agent с использованием браузера.

    Args:
        url (str): URL для получения токена доступа и user-agent.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.

    Returns:
        tuple[str, str]: Токен доступа и user-agent.
    """
```

**Назначение**: Получает токен доступа и user-agent с использованием браузера.

**Параметры**:
- `url` (str): URL для получения токена доступа и user-agent.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `tuple[str, str]`: Токен доступа и user-agent.

**Как работает функция**:

1.  **Запуск браузера**:
    *   Запускается браузер в безголовом режиме с использованием `get_nodriver`. Параметры `proxy` и `user_data_dir="designer"` передаются для настройки прокси и каталога пользовательских данных.
2.  **Получение страницы**:
    *   Браузер переходит по указанному `url` с помощью `browser.get(url)`.
3.  **Извлечение User-Agent**:
    *   Извлекается значение `user-agent` из браузера с использованием `page.evaluate("navigator.userAgent")`.
4.  **Извлечение токена доступа**:
    *   Запускается цикл `while`, который выполняется до тех пор, пока не будет получен токен доступа (`access_token`).
    *   Внутри цикла выполняется JavaScript-код в браузере с помощью `page.evaluate()`. Этот код ищет в `localStorage` элементы, у которых `credentialType` равен `"AccessToken"`, `expiresOn` больше текущего времени, и `target` включает `"designerappservice"`. Если такой элемент найден, его значение `secret` возвращается как токен доступа.
    *   Если токен доступа не найден, функция ожидает 1 секунду с помощью `asyncio.sleep(1)` и повторяет попытку.
5.  **Закрытие страницы**:
    *   После получения токена доступа страница закрывается с помощью `page.close()`.
6.  **Остановка браузера**:
    *   В блоке `finally` вызывается функция `stop_browser()`, чтобы остановить и закрыть браузер, независимо от того, успешно ли выполнились предыдущие шаги.
7.  **Возврат результатов**:
    *   Функция возвращает кортеж, содержащий `access_token` и `user_agent`.

```
Запуск браузера (get_nodriver)
│
└───> Получение страницы (browser.get(url))
│
└───> Извлечение User-Agent
│
└───> Цикл извлечения токена доступа
│     └───> Выполнение JavaScript-кода в браузере
│     └───> Проверка localStorage на наличие токена
│     └───> Ожидание 1 секунду, если токен не найден
│
└───> Закрытие страницы (page.close())
│
└───> Остановка браузера (stop_browser())
│
└───> Возврат access_token и user_agent