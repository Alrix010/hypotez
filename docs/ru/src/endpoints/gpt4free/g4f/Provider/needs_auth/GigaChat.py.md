# Модуль для работы с GigaChat API, требующим аутентификацию
=============================================================

Модуль содержит класс `GigaChat`, который используется для взаимодействия с API GigaChat от Сбербанка.
Этот класс поддерживает потоковую передачу данных и требует аутентификации через API-ключ.

## Обзор

Модуль предназначен для асинхронного взаимодействия с API GigaChat. Он обеспечивает получение токена доступа, необходимого для аутентификации, и отправку запросов к API для генерации текста.
Модуль также поддерживает потоковую передачу данных, что позволяет получать результаты генерации текста по частям.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с сервисом GigaChat.
Он использует асинхронные запросы для эффективного взаимодействия с API и поддерживает различные модели GigaChat.
Расположение файла в проекте указывает на то, что он является одним из поставщиков (Provider) API, требующих аутентификацию (needs_auth).

## Классы

### `GigaChat`

**Описание**: Класс для взаимодействия с API GigaChat.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL API GigaChat (`https://developers.sber.ru/gigachat`).
- `working` (bool): Указывает, работает ли провайдер (всегда `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (всегда `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (всегда `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (всегда `True`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (всегда `True`).
- `default_model` (str): Модель по умолчанию (`GigaChat:latest`).
- `models` (list[str]): Список поддерживаемых моделей (`[default_model, "GigaChat-Plus", "GigaChat-Pro"]`).

**Методы**:
- `create_async_generator`: Асинхронный генератор для получения данных от API GigaChat.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool = True,
    proxy: str = None,
    api_key: str = None,
    connector: BaseConnector = None,
    scope: str = "GIGACHAT_API_PERS",
    update_interval: float = 0,
    **kwargs
) -> AsyncResult:
    """Асинхронно создает генератор для взаимодействия с API GigaChat.

    Args:
        cls (Type[GigaChat]): Ссылка на класс `GigaChat`.
        model (str): Используемая модель GigaChat.
        messages (Messages): Список сообщений для отправки в API.
        stream (bool, optional): Флаг, указывающий на использование потоковой передачи данных. По умолчанию `True`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        connector (BaseConnector, optional): TCP коннектор для клиентской сессии. По умолчанию `None`.
        scope (str, optional): Область действия для получения токена доступа. По умолчанию `"GIGACHAT_API_PERS"`.
        update_interval (float, optional): Интервал обновления. По умолчанию `0`.
        **kwargs: Дополнительные параметры для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий данные от API GigaChat.

    Raises:
        MissingAuthError: Если не предоставлен API-ключ.

    Внутренние функции:
        Нет
    """
    ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API GigaChat.

**Параметры**:
- `cls`: Ссылка на класс `GigaChat`.
- `model` (str): Используемая модель GigaChat.
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool): Флаг, указывающий на использование потоковой передачи данных.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `connector (BaseConnector, optional)`:  Объект `BaseConnector` для управления сетевым подключением. По умолчанию `None`.
- `scope` (str, optional): Область действия для получения токена доступа. По умолчанию `"GIGACHAT_API_PERS"`.
- `update_interval` (float, optional): Интервал обновления. По умолчанию `0`.
- `**kwargs`: Дополнительные параметры для передачи в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий данные от API GigaChat.

**Вызывает исключения**:
- `MissingAuthError`: Если не предоставлен API-ключ.

**Как работает функция**:

1.  **Проверка наличия API-ключа**: Проверяет, предоставлен ли API-ключ. Если нет, вызывает исключение `MissingAuthError`.
2.  **Создание файла сертификата**: Создает файл сертификата `russian_trusted_root_ca.crt` в директории cookies, если он еще не существует.
    Этот сертификат необходим для установки доверенного соединения с серверами Сбербанка.
3.  **Создание SSL-контекста**: Если доступен модуль `ssl` и не передан коннектор, создает SSL-контекст с использованием сертификата.
    Это необходимо для обеспечения безопасного соединения.
4.  **Получение токена доступа**: Если токен доступа устарел (время истечения меньше 60 секунд), отправляет запрос на получение нового токена.
    Запрос отправляется на URL `https://ngw.devices.sberbank.ru:9443/api/v2/oauth` с использованием API-ключа.
5.  **Отправка запроса к API GigaChat**: Отправляет запрос к API GigaChat на URL `https://gigachat.devices.sberbank.ru/api/v1/chat/completions` с использованием полученного токена доступа.
    В теле запроса передаются параметры модели, сообщения, флаг потоковой передачи данных и другие параметры.
6.  **Обработка потоковой передачи данных**: Если включена потоковая передача данных, функция читает данные из ответа построчно.
    Каждая строка, начинающаяся с `data:`, содержит JSON-объект с данными.
    Функция извлекает содержимое сообщения из JSON-объекта и передает его в генератор.
    Если строка содержит `[DONE]`, функция завершает работу.
7.  **Обработка не потоковой передачи данных**: Если потоковая передача данных выключена, функция читает весь ответ целиком и возвращает содержимое сообщения.

**ASCII flowchart**:

```
    Проверка API-ключа
    ↓
    Создание/проверка сертификата
    ↓
    Проверка SSL и создание коннектора
    ↓
    Проверка актуальности токена
    │
    └─> [Токен устарел] -> Запрос нового токена
    ↓
    Отправка запроса к API GigaChat
    ↓
    Обработка ответа (потоковый/не потоковый)
    │
    └─> [Потоковый] -> Чтение данных построчно и извлечение содержимого
    │
    └─> [Не потоковый] -> Чтение всего ответа
    ↓
    Возврат содержимого сообщения
```

**Примеры**:

1.  Пример вызова с минимальным набором параметров:

```python
async for message in GigaChat.create_async_generator(model="GigaChat:latest", messages=[{"role": "user", "content": "Hello!"}], api_key="YOUR_API_KEY"):
    print(message)
```

2.  Пример вызова с использованием прокси-сервера:

```python
async for message in GigaChat.create_async_generator(model="GigaChat:latest", messages=[{"role": "user", "content": "Hello!"}], api_key="YOUR_API_KEY", proxy="http://your_proxy:8080"):
    print(message)
```

3.  Пример вызова с указанием области действия (scope):

```python
async for message in GigaChat.create_async_generator(model="GigaChat:latest", messages=[{"role": "user", "content": "Hello!"}], api_key="YOUR_API_KEY", scope="GIGACHAT_API_PERS"):
    print(message)
```