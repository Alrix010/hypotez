# Модуль `Anthropic`

## Обзор

Модуль `Anthropic` предоставляет интерфейс для взаимодействия с API Anthropic, в частности, с моделями Claude. Он наследуется от класса `OpenaiAPI` и реализует методы для получения моделей, создания асинхронных генераторов для обработки сообщений и формирования заголовков запросов. Модуль поддерживает потоковую передачу данных, использование системных сообщений и истории сообщений, а также обработку изображений.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения возможности взаимодействия с моделями Anthropic Claude через API. Он предоставляет функциональность для отправки запросов к API Anthropic, обработки ответов и управления параметрами запросов, такими как температура, максимальное количество токенов и т.д. Модуль также поддерживает передачу изображений в запросах и обработку ответов в потоковом режиме.

## Классы

### `Anthropic`

**Описание**: Класс `Anthropic` предоставляет методы для взаимодействия с API Anthropic.

**Наследует**:
- `OpenaiAPI`: Класс `Anthropic` наследует функциональность от класса `OpenaiAPI`, который, вероятно, предоставляет общую логику для взаимодействия с API OpenAI.

**Атрибуты**:
- `label` (str): Метка, идентифицирующая провайдера как "Anthropic API".
- `url` (str): URL консоли Anthropic.
- `login_url` (str): URL для входа в Anthropic.
- `working` (bool): Указывает, что API Anthropic работает (значение `True`).
- `api_base` (str): Базовый URL API Anthropic.
- `needs_auth` (bool): Указывает, требуется ли аутентификация для доступа к API (значение `True`).
- `supports_stream` (bool): Указывает, поддерживает ли API потоковую передачу данных (значение `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли API системные сообщения (значение `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли API историю сообщений (значение `True`).
- `default_model` (str): Модель, используемая по умолчанию ("claude-3-5-sonnet-latest").
- `models` (list[str]): Список поддерживаемых моделей.
- `models_aliases` (dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `get_models(api_key: str = None, **kwargs)`: Возвращает список доступных моделей.
- `create_async_generator(...)`: Создает асинхронный генератор для обработки сообщений.
- `get_headers(stream: bool, api_key: str = None, headers: dict = None)`: Возвращает заголовки запроса.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls, api_key: str = None, **kwargs) -> list[str]:
    """
    Получает список доступных моделей от API Anthropic.

    Args:
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        list[str]: Список идентификаторов доступных моделей.
    
    Raises:
        requests.exceptions.HTTPError: Если HTTP-запрос завершается с ошибкой.
    """
    ...
```

**Назначение**: Функция `get_models` получает список доступных моделей из API Anthropic. Она выполняет HTTP-запрос к API, используя предоставленный API-ключ для аутентификации. Если список моделей еще не был получен, функция выполняет запрос и сохраняет список моделей в атрибуте класса `models`.

**Параметры**:
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `list[str]`: Список идентификаторов доступных моделей.

**Вызывает исключения**:
- `requests.exceptions.HTTPError`: Если HTTP-запрос завершается с ошибкой.

**Как работает функция**:

1. **Проверка наличия моделей**: Функция сначала проверяет, был ли уже получен список моделей (проверяет, является ли `cls.models` пустым).
2. **Выполнение HTTP-запроса**: Если список моделей еще не получен, функция выполняет GET-запрос к API Anthropic для получения списка моделей.
3. **Обработка ответа**: Функция проверяет статус ответа и преобразует ответ в формат JSON.
4. **Извлечение идентификаторов моделей**: Функция извлекает идентификаторы моделей из JSON-ответа и сохраняет их в атрибуте класса `cls.models`.
5. **Возврат списка моделей**: Функция возвращает список идентификаторов моделей.

**Примеры**:

```python
# Пример вызова функции для получения списка моделей
models = Anthropic.get_models(api_key="your_api_key")
print(models)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    media: MediaListType = None,
    api_key: str = None,
    temperature: float = None,
    max_tokens: int = 4096,
    top_k: int = None,
    top_p: float = None,
    stop: list[str] = None,
    stream: bool = False,
    headers: dict = None,
    impersonate: str = None,
    tools: Optional[list] = None,
    extra_data: dict = {},
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API Anthropic.

    Args:
        model (str): Идентификатор модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса в секундах. По умолчанию 120.
        media (MediaListType, optional): Список медиа-файлов для отправки. По умолчанию `None`.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        temperature (float, optional): Температура для генерации текста. По умолчанию `None`.
        max_tokens (int, optional): Максимальное количество токенов для генерации. По умолчанию 4096.
        top_k (int, optional): Параметр top_k для генерации текста. По умолчанию `None`.
        top_p (float, optional): Параметр top_p для генерации текста. По умолчанию `None`.
        stop (list[str], optional): Список стоп-слов. По умолчанию `None`.
        stream (bool, optional): Указывает, использовать ли потоковую передачу данных. По умолчанию `False`.
        headers (dict, optional): Дополнительные заголовки для запроса. По умолчанию `None`.
        impersonate (str, optional): Идентификатор для имитации. По умолчанию `None`.
        tools (Optional[list], optional): Список инструментов для использования. По умолчанию `None`.
        extra_data (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор для обработки сообщений.

    Raises:
        MissingAuthError: Если отсутствует API-ключ.
    """
    ...
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с API Anthropic. Она принимает различные параметры, такие как модель, сообщения, прокси, время ожидания, медиа-файлы, API-ключ, температура, максимальное количество токенов и т.д. Функция отправляет запрос к API Anthropic и возвращает асинхронный генератор для обработки ответов.

**Параметры**:
- `model` (str): Идентификатор модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию 120.
- `media` (MediaListType, optional): Список медиа-файлов для отправки. По умолчанию `None`.
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `temperature` (float, optional): Температура для генерации текста. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов для генерации. По умолчанию 4096.
- `top_k` (int, optional): Параметр top_k для генерации текста. По умолчанию `None`.
- `top_p` (float, optional): Параметр top_p для генерации текста. По умолчанию `None`.
- `stop` (list[str], optional): Список стоп-слов. По умолчанию `None`.
- `stream` (bool, optional): Указывает, использовать ли потоковую передачу данных. По умолчанию `False`.
- `headers` (dict, optional): Дополнительные заголовки для запроса. По умолчанию `None`.
- `impersonate` (str, optional): Идентификатор для имитации. По умолчанию `None`.
- `tools` (Optional[list], optional): Список инструментов для использования. По умолчанию `None`.
- `extra_data` (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для обработки сообщений.

**Вызывает исключения**:
- `MissingAuthError`: Если отсутствует API-ключ.

**Как работает функция**:

1. **Проверка API-ключа**: Функция сначала проверяет, предоставлен ли API-ключ. Если API-ключ отсутствует, функция вызывает исключение `MissingAuthError`.
2. **Обработка медиа-файлов**: Если предоставлены медиа-файлы, функция преобразует их в формат base64 и добавляет в сообщение.
3. **Подготовка системного сообщения**: Функция извлекает системные сообщения из списка сообщений и объединяет их в одну строку.
4. **Создание сессии**: Функция создает асинхронную сессию с использованием `StreamSession`.
5. **Подготовка данных для запроса**: Функция подготавливает данные для запроса, включая сообщения, модель, температуру, максимальное количество токенов и т.д.
6. **Отправка запроса**: Функция отправляет POST-запрос к API Anthropic.
7. **Обработка ответа**: Функция обрабатывает ответ от API Anthropic. Если используется потоковая передача данных, функция обрабатывает каждый чанк данных и извлекает текст, информацию об использовании токенов и т.д. Если потоковая передача не используется, функция преобразует ответ в формат JSON и извлекает текст, информацию об использовании токенов и т.д.
8. **Возврат генератора**: Функция возвращает асинхронный генератор для обработки сообщений.

**Внутренние функции**:

Функция `create_async_generator` не содержит внутренних функций.

**Примеры**:

```python
# Пример вызова функции для создания асинхронного генератора
messages = [
    {"role": "user", "content": "Hello, how are you?"}
]
generator = Anthropic.create_async_generator(
    model="claude-3-opus-latest",
    messages=messages,
    api_key="your_api_key"
)
```

### `get_headers`

```python
@classmethod
def get_headers(cls, stream: bool, api_key: str = None, headers: dict = None) -> dict:
    """
    Формирует заголовки запроса для API Anthropic.

    Args:
        stream (bool): Указывает, используется ли потоковая передача данных.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        headers (dict, optional): Дополнительные заголовки. По умолчанию `None`.

    Returns:
        dict: Словарь заголовков запроса.
    """
    ...
```

**Назначение**: Функция `get_headers` формирует заголовки запроса для API Anthropic. Она принимает параметры, указывающие, используется ли потоковая передача данных, API-ключ и дополнительные заголовки. Функция возвращает словарь заголовков запроса, который включает заголовок `Accept`, заголовок `Content-Type`, заголовок `x-api-key` (если предоставлен API-ключ) и заголовок `anthropic-version`.

**Параметры**:
- `stream` (bool): Указывает, используется ли потоковая передача данных.
- `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
- `headers` (dict, optional): Дополнительные заголовки. По умолчанию `None`.

**Возвращает**:
- `dict`: Словарь заголовков запроса.

**Как работает функция**:

1. **Формирование базовых заголовков**: Функция формирует базовые заголовки, включая `Accept` и `Content-Type`.
2. **Добавление API-ключа**: Если предоставлен API-ключ, функция добавляет заголовок `x-api-key`.
3. **Добавление версии API**: Функция добавляет заголовок `anthropic-version`.
4. **Добавление дополнительных заголовков**: Если предоставлены дополнительные заголовки, функция добавляет их в словарь заголовков.
5. **Возврат словаря заголовков**: Функция возвращает словарь заголовков запроса.

**Внутренние функции**:

Функция `get_headers` не содержит внутренних функций.

**Примеры**:

```python
# Пример вызова функции для формирования заголовков запроса
headers = Anthropic.get_headers(stream=True, api_key="your_api_key")
print(headers)
```