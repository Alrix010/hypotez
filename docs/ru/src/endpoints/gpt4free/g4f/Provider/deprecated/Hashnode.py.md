# Модуль Hashnode.py

## Обзор

Модуль `Hashnode.py` предоставляет асинхронный класс `Hashnode`, предназначенный для взаимодействия с сервисом Hashnode для генерации текста на основе предоставленных сообщений и контекста поиска. Этот модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов и интегрируется с другими частями проекта `hypotez` для обеспечения функциональности работы с различными AI-моделями.

## Подробней

Модуль `Hashnode.py` служит для асинхронного взаимодействия с платформой Hashnode, предоставляя возможности генерации текста на основе истории сообщений и результатов веб-поиска. Он предназначен для использования в составе проекта `hypotez`, где требуется интеграция с различными AI-моделями. Класс `Hashnode` поддерживает GPT-3.5 Turbo и предоставляет механизм для выполнения веб-поиска и получения релевантных источников информации для улучшения качества генерации текста.

## Классы

### `SearchTypes`

**Описание**: Класс `SearchTypes` предоставляет набор статических атрибутов, представляющих различные типы поиска, которые могут быть использованы при взаимодействии с API Hashnode.

**Аттрибуты**:
- `quick` (str): Представляет быстрый тип поиска.
- `code` (str): Представляет тип поиска кода.
- `websearch` (str): Представляет тип веб-поиска.

### `Hashnode`

**Описание**: Класс `Hashnode` является асинхронным провайдером, который взаимодействует с API Hashnode для генерации текста на основе предоставленных сообщений и результатов поиска.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует от базового класса `AsyncGeneratorProvider`.

**Аттрибуты**:
- `url` (str): URL-адрес сервиса Hashnode.
- `working` (bool): Указывает, работает ли провайдер в данный момент (по умолчанию `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (по умолчанию `True`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo (по умолчанию `True`).
- `_sources` (list): Список источников, полученных в результате поиска.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения текстовых фрагментов от Hashnode.
- `get_sources()`: Возвращает список источников, использованных для генерации текста.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    search_type: str = SearchTypes.websearch,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения текстовых фрагментов от Hashnode.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        search_type (str): Тип поиска (`quick`, `code`, `websearch`). По умолчанию `SearchTypes.websearch`.
        proxy (str): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текстовые фрагменты.

    Raises:
        aiohttp.ClientResponseError: Если возникает ошибка при выполнении HTTP-запроса.

    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который взаимодействует с API Hashnode для генерации текста на основе предоставленных сообщений и результатов поиска.

**Параметры**:
- `cls`: Ссылка на класс `Hashnode`.
- `model` (str): Модель, которую следует использовать для генерации текста.
- `messages` (Messages): Список сообщений, представляющих историю разговора.
- `search_type` (str): Тип поиска, который следует использовать (по умолчанию `SearchTypes.websearch`).
- `proxy` (str): Адрес прокси-сервера, если необходимо использовать прокси.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает текстовые фрагменты, полученные от API Hashnode.

**Как работает функция**:
1. Формируются заголовки HTTP-запроса, включая User-Agent, Accept, Referer и Content-Type.
2. Создается асинхронная сессия `aiohttp.ClientSession` с установленными заголовками.
3. Извлекается последний запрос пользователя из списка сообщений.
4. Если указан тип поиска `websearch`, выполняется POST-запрос к API Hashnode для выполнения поиска.
5. Извлекаются результаты поиска из JSON-ответа и сохраняются в `cls._sources`.
6. Формируются данные для POST-запроса на основе истории сообщений, запроса пользователя, типа поиска и результатов поиска.
7. Выполняется POST-запрос к API Hashnode для получения завершения текста.
8. Асинхронно итерируется по содержимому ответа и генерируются текстовые фрагменты.

**Внутренние функции**:
Внутри функции `create_async_generator` используется асинхронный контекстный менеджер `async with ClientSession(headers=headers) as session:` для управления HTTP-сессией. Также используется асинхронный контекстный менеджер `async with session.post(...) as response:` для отправки POST-запросов и обработки ответов.

**ASCII flowchart**:

```
[Начало] --> [Формирование заголовков]
[Формирование заголовков] --> [Создание асинхронной сессии]
[Создание асинхронной сессии] --> [Извлечение последнего запроса пользователя]
[Извлечение последнего запроса пользователя] --> [Проверка типа поиска]
[Проверка типа поиска] --(websearch)--> [Выполнение POST-запроса для поиска]
[Выполнение POST-запроса для поиска] --> [Извлечение результатов поиска]
[Извлечение результатов поиска] --> [Формирование данных для POST-запроса]
[Проверка типа поиска] --(другой тип)--> [Формирование данных для POST-запроса]
[Формирование данных для POST-запроса] --> [Выполнение POST-запроса для завершения текста]
[Выполнение POST-запроса для завершения текста] --> [Асинхронная итерация по содержимому ответа]
[Асинхронная итерация по содержимому ответа] --> [Генерация текстовых фрагментов]
[Генерация текстовых фрагментов] --> [Конец]
```

**Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
search_type = SearchTypes.websearch
# async for chunk in Hashnode.create_async_generator(model, messages, search_type):
#     print(chunk, end="")
```

### `get_sources`

```python
@classmethod
def get_sources(cls) -> list:
    """Возвращает список источников, использованных для генерации текста.

    Returns:
        list: Список словарей, содержащих информацию об источниках.

    """
```

**Назначение**: Функция `get_sources` возвращает список источников, использованных для генерации текста.

**Параметры**:
- `cls`: Ссылка на класс `Hashnode`.

**Возвращает**:
- `list`: Список словарей, каждый из которых содержит ключи `"title"` и `"url"`, представляющие название и URL-адрес источника соответственно.

**Как работает функция**:
1. Функция итерируется по списку `cls._sources`.
2. Для каждого источника создается словарь с ключами `"title"` и `"url"`.
3. Возвращается список созданных словарей.

**ASCII flowchart**:

```
[Начало] --> [Итерация по cls._sources]
[Итерация по cls._sources] --> [Создание словаря для каждого источника]
[Создание словаря для каждого источника] --> [Возврат списка словарей]
[Возврат списка словарей] --> [Конец]
```

**Примеры**:

```python
# Пример использования get_sources
# sources = Hashnode.get_sources()
# print(sources)