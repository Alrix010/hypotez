# Модуль для работы с провайдером Ails (gpt4free)
=================================================

Модуль содержит класс `Ails`, который является асинхронным генераторным провайдером для взаимодействия с моделью GPT-3.5 Turbo через API ai.ls.

## Обзор

Модуль предоставляет возможность отправлять запросы к API ai.ls и получать ответы в режиме реального времени, используя асинхронный генератор. Он поддерживает работу через прокси, а также имеет встроенные механизмы для обработки ошибок и форматирования данных.

## Подробнее

Данный код используется для интеграции с сервисом ai.ls через API `api.caipacity.com`. Он позволяет отправлять текстовые запросы к модели `gpt-3.5-turbo` и получать ответы в потоковом режиме. Этот модуль предназначен для использования в асинхронных приложениях, где требуется обработка больших объемов данных или взаимодействие в реальном времени.

## Классы

### `Ails(AsyncGeneratorProvider)`

**Описание**:
Класс `Ails` представляет собой асинхронный генераторный провайдер для взаимодействия с API ai.ls.

**Наследует**:
`AsyncGeneratorProvider`: Базовый класс для асинхронных генераторных провайдеров.

**Атрибуты**:
- `url` (str): URL API ai.ls.
- `working` (bool): Указывает, работает ли провайдер (по умолчанию `False`).
- `supports_message_history` (bool): Поддерживает ли провайдер историю сообщений (по умолчанию `True`).
- `supports_gpt_35_turbo` (bool): Поддерживает ли провайдер модель GPT-3.5 Turbo (по умолчанию `True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API ai.ls.

## Функции

### `create_async_generator`

```python
@staticmethod
async def create_async_generator(
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API ai.ls.

    Args:
        model (str): Название модели, используемой для генерации (в данном случае всегда "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в API.
        stream (bool): Указывает, следует ли использовать потоковый режим.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы, такие как температура.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текстовые фрагменты ответа.

    Raises:
        Exception: Если ответ содержит недопустимые токены ("ai.ls" или "ai.ci").

    """
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API ai.ls и возвращает ответы в потоковом режиме. Она отвечает за формирование заголовков, тела запроса и обработку ответов от API.

**Как работает функция**:

1. **Формирование заголовков**:
   - Создаются заголовки запроса, включающие `authorization`, `client-id`, `client-v`, `content-type` и другие необходимые параметры.

2. **Создание асинхронной сессии**:
   - Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов.

3. **Формирование тела запроса**:
   - Подготавливается JSON-тело запроса, включающее модель, температуру, сообщения, дату и хеш.

4. **Отправка запроса и обработка ответа**:
   - Отправляется `POST`-запрос к API `api.caipacity.com`.
   - Полученный ответ обрабатывается построчно.
   - Каждая строка декодируется и проверяется на наличие префикса `"data: "`.
   - Если строка содержит данные, она преобразуется из JSON и извлекается токен.
   - Если токен содержит недопустимые подстроки (`"ai.ls"` или `"ai.ci"`), вызывается исключение.
   - Токен возвращается через `yield`, что позволяет использовать функцию как генератор.

**ASCII flowchart**:

```
+-----------------------+
|   Формирование заголовков   |
+-----------------------+
        |
        ↓
+-----------------------+
|  Создание асинхронной  |
|        сессии         |
+-----------------------+
        |
        ↓
+-----------------------+
| Формирование тела    |
|        запроса         |
+-----------------------+
        |
        ↓
+-----------------------+
|  Отправка POST-запроса  |
|  к api.caipacity.com  |
+-----------------------+
        |
        ↓
+-----------------------+
|   Обработка ответа    |
|       построчно        |
+-----------------------+
        |
        ↓
+-----------------------+
|   Извлечение токена    |
+-----------------------+
        |
        ↓
+-----------------------+
|  Проверка токена на   |
|   недопустимые строки  |
+-----------------------+
        |
        ↓
+-----------------------+
|     Выдача токена     |
|       через yield       |
+-----------------------+
```

**Примеры**:

```python
# Пример использования асинхронного генератора
async def example():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    stream = True
    proxy = None

    generator = await Ails.create_async_generator(model, messages, stream, proxy)
    async for token in generator:
        print(token, end="")

# Запуск примера
# import asyncio
# asyncio.run(example())
```

### `_hash`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """
    Создает SHA256 хеш на основе переданных данных.

    Args:
        json_data (dict[str, str]): Словарь, содержащий данные для хеширования.
            Обязательно должен содержать ключи "t" и "m".

    Returns:
        SHA256: SHA256 хеш в виде строки.

    """
```

**Назначение**:
Функция `_hash` генерирует SHA256 хеш на основе переданных данных, которые включают временную метку и содержимое сообщения.

**Как работает функция**:

1. **Формирование базовой строки**:
   - Создается строка, объединяющая временную метку (`json_data["t"]`), содержимое сообщения (`json_data["m"]`) и фиксированную строку `':WI,2rU#_r:r~aF4aJ36[.Z(/8Rv93Rf:{len(json_data["m"])}'`.

2. **Хеширование строки**:
   - Базовая строка кодируется в байты и хешируется с использованием алгоритма SHA256.
   - Результат хеширования преобразуется в шестнадцатеричную строку.

**ASCII flowchart**:

```
+-----------------------+
|  Формирование базовой |
|        строки         |
+-----------------------+
        |
        ↓
+-----------------------+
|  Кодирование строки в  |
|         байты          |
+-----------------------+
        |
        ↓
+-----------------------+
|    Хеширование SHA256   |
+-----------------------+
        |
        ↓
+-----------------------+
|Преобразование в шестн.|
|       строку          |
+-----------------------+
```

**Примеры**:

```python
# Пример использования функции _hash
import datetime
json_data = {"t": str(int(datetime.datetime.now().timestamp())), "m": "test message"}
hash_value = _hash(json_data)
print(hash_value)
```

### `_format_timestamp`

```python
def _format_timestamp(timestamp: int) -> str:
    """
    Форматирует временную метку.

    Args:
        timestamp (int): Временная метка в формате Unix timestamp (в миллисекундах).

    Returns:
        str: Отформатированная временная метка в виде строки.
    """
```

**Назначение**:
Функция `_format_timestamp` форматирует временную метку, корректируя её последнюю цифру.

**Как работает функция**:

1. **Коррекция последней цифры**:
   - Извлекается последняя цифра временной метки.
   - Если последняя цифра чётная, к ней добавляется 1; если нечётная, она остаётся без изменений.
   - Вычисляется новая временная метка путём вычитания последней цифры и добавления скорректированной цифры.

2. **Преобразование в строку**:
   - Отформатированная временная метка преобразуется в строку.

**ASCII flowchart**:

```
+-----------------------+
| Извлечение последней  |
|       цифры           |
+-----------------------+
        |
        ↓
+-----------------------+
| Коррекция последней   |
|       цифры           |
+-----------------------+
        |
        ↓
+-----------------------+
|Вычисление новой времен|
|       метки           |
+-----------------------+
        |
        ↓
+-----------------------+
|Преобразование в строку|
+-----------------------+
```

**Примеры**:

```python
# Пример использования функции _format_timestamp
timestamp = 1678886400000
formatted_timestamp = _format_timestamp(timestamp)
print(formatted_timestamp)