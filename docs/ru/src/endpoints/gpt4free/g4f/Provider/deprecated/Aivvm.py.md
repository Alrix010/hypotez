# Модуль `Aivvm`

## Обзор

Модуль `Aivvm` представляет собой реализацию абстрактного провайдера `AbstractProvider` для взаимодействия с сервисом `chat.aivvm.com`. Он предоставляет возможность создавать запросы к моделям, таким как `gpt-3.5-turbo` и `gpt-4`, с поддержкой потоковой передачи данных.

## Подробней

Модуль предназначен для интеграции с `chat.aivvm.com` для использования в качестве одного из провайдеров в проекте `hypotez`. Он позволяет отправлять запросы к различным моделям и получать ответы в потоковом режиме. Модуль содержит словарь `models`, который определяет соответствие между именами моделей и их идентификаторами, используемыми в API `Aivvm`.

## Классы

### `Aivvm`

**Описание**: Класс `Aivvm` реализует интерфейс взаимодействия с сервисом `chat.aivvm.com`.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для провайдеров.

**Атрибуты**:
- `url` (str): URL сервиса `chat.aivvm.com`.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `working` (bool): Флаг, указывающий на работоспособность провайдера (надо проверять).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку модели `gpt-4`.

**Методы**:
- `create_completion`: Метод для создания запроса к модели и получения ответа.

## Функции

### `create_completion`

```python
    @classmethod
    def create_completion(cls,
        model: str,
        messages: Messages,
        stream: bool,
        **kwargs
    ) -> CreateResult:
        """ Функция отправляет запрос к chat.aivvm.com для получения ответа от указанной модели.
        Args:
            model (str): Имя модели, которую необходимо использовать.
            messages (Messages): Список сообщений для отправки в запросе.
            stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
            **kwargs: Дополнительные аргументы, такие как `system_message` и `temperature`.

        Returns:
            CreateResult: Результат выполнения запроса.

        Raises:
            ValueError: Если указанная модель не поддерживается.
        """
```

**Назначение**: Создание запроса к API `chat.aivvm.com` для получения ответа от языковой модели.

**Параметры**:
- `model` (str): Имя модели, которую необходимо использовать. Если не указано, используется `gpt-3.5-turbo`.
- `messages` (Messages): Список сообщений, составляющих контекст диалога.
- `stream` (bool): Флаг, определяющий, будет ли ответ получен в потоковом режиме.
- `kwargs` (dict): Дополнительные параметры запроса:
    - `system_message` (str): Системное сообщение, определяющее роль модели. По умолчанию: `"You are ChatGPT, a large language model trained by OpenAI. Follow the user's instructions carefully. Respond using markdown."`.
    - `temperature` (float): Температура модели, определяющая случайность ответов. По умолчанию: `0.7`.

**Возвращает**:
- `CreateResult`: Результат выполнения запроса, представляющий собой генератор чанков текста, если `stream=True`, иначе - строку с полным ответом.

**Вызывает исключения**:
- `ValueError`: Если указанная модель не найдена в словаре `models`.
- `requests.exceptions.HTTPError`: Если HTTP-запрос завершился с ошибкой.

**Как работает функция**:

1. **Выбор модели**: Если модель не указана, используется `gpt-3.5-turbo`. Если указанная модель отсутствует в словаре `models`, выбрасывается исключение `ValueError`.
2. **Формирование JSON-данных**: Создается словарь `json_data`, содержащий информацию о модели, сообщениях, системном сообщении и температуре.
3. **Преобразование в JSON**: Словарь `json_data` преобразуется в JSON-строку `data`.
4. **Формирование заголовков**: Создается словарь `headers`, содержащий необходимые заголовки для HTTP-запроса.
5. **Отправка POST-запроса**: Отправляется POST-запрос к API `chat.aivvm.com/api/chat` с использованием библиотеки `requests`.
6. **Обработка ответа**: Если запрос успешен, функция итерируется по чанкам ответа и декодирует их в UTF-8, возвращая в виде генератора. При возникновении ошибки декодирования UnicodeDecodeError, применяется декодирование unicode-escape

**Пример**:
```python
# Пример использования функции create_completion
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
kwargs = {"system_message": "You are a helpful assistant.", "temperature": 0.5}

# Вызов функции create_completion
result = Aivvm.create_completion(model, messages, stream, **kwargs)

# Итерация по чанкам ответа
if stream:
    for chunk in result:
        print(chunk, end="")
```

ASCII-схема работы функции:

```
     Начало
      ↓
  Выбор модели
      ↓
Формирование JSON-данных
      ↓
 Преобразование в JSON
      ↓
  Формирование заголовков
      ↓
  Отправка POST-запроса
      ↓
  Обработка ответа
      ↓
      Конец