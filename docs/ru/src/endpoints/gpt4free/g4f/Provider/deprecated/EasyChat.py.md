# Модуль `EasyChat`

## Обзор

Модуль `EasyChat` предоставляет класс `EasyChat`, который является провайдером для взаимодействия с сервисом EasyChat, использующим GPT-3.5 Turbo. Этот модуль позволяет отправлять запросы на генерацию текста и получать результаты в потоковом или не потоковом режиме.

## Подробнее

Модуль предназначен для интеграции с различными AI-моделями через API сервиса EasyChat. Он поддерживает как потоковую, так и не потоковую генерацию текста, что позволяет использовать его в различных сценариях, требующих разной скорости и объема получаемых данных.
Расположение файла в проекте: `hypotez/src/endpoints/gpt4free/g4f/Provider/deprecated/EasyChat.py` указывает на то, что данный файл является частью более крупной системы, предоставляющей интерфейсы к различным API для работы с AI-моделями.

## Классы

### `EasyChat`

**Описание**: Класс `EasyChat` является провайдером для взаимодействия с сервисом EasyChat. Он наследует класс `AbstractProvider` и реализует методы для отправки запросов на генерацию текста и получения результатов.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес сервиса EasyChat. По умолчанию `"https://free.easychat.work"`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковый режим. По умолчанию `True`.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo. По умолчанию `True`.
- `working` (bool): Указывает, работает ли в данный момент провайдер. По умолчанию `False`.

### `create_completion`

```python
    @staticmethod
    def create_completion(
        model: str,
        messages: list[dict[str, str]],
        stream: bool, **kwargs: Any) -> CreateResult:
        """
        Создает запрос на completion к сервису EasyChat.

        Args:
            model (str): Идентификатор модели, которую необходимо использовать.
            messages (list[dict[str, str]]): Список сообщений для передачи в модель.
            stream (bool): Флаг, указывающий, следует ли использовать потоковый режим.
            **kwargs (Any): Дополнительные параметры запроса.

        Returns:
            CreateResult: Результат запроса.

        Raises:
            Exception: Если возникает ошибка при выполнении запроса.

        Пример:
            >>> EasyChat.create_completion(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello"}], stream=False)
            <generator object EasyChat.create_completion at 0x...>
        """
```

**Назначение**:
Функция `create_completion` отправляет запрос к сервису EasyChat для генерации текста на основе предоставленных входных данных. Она поддерживает как потоковый, так и не потоковый режимы работы.

**Параметры**:
- `model` (str): Идентификатор модели, которую необходимо использовать.
- `messages` (list[dict[str, str]]): Список сообщений для передачи в модель.
- `stream` (bool): Флаг, указывающий, следует ли использовать потоковый режим.
- `**kwargs` (Any): Дополнительные параметры запроса, такие как `temperature`, `presence_penalty`, `frequency_penalty`, `top_p`, `active_server`.

**Возвращает**:
- `CreateResult`: Генератор, возвращающий сгенерированный текст.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при выполнении запроса или получении ответа от сервера.

**Внутренние функции**:
Внутри данной функции нет внутренних функций.

**Как работает функция**:
1. **Инициализация**:
   - Определяется список активных серверов `active_servers`, из которых случайным образом выбирается один для отправки запроса.
   - Формируются заголовки запроса `headers`, включающие информацию о сервере, типе контента, User-Agent и другие необходимые параметры.
   - Формируется JSON-тело запроса `json_data`, включающее сообщения, модель, параметры температуры, штрафов и другие параметры, переданные через `kwargs`.

2. **Отправка запроса**:
   - Создается сессия `requests.Session()` для выполнения HTTP-запросов.
   - Выполняется GET-запрос к серверу для инициализации cookies.
   - Выполняется POST-запрос к API сервиса EasyChat с использованием сформированных заголовков и JSON-тела.

3. **Обработка ответа**:
   - Проверяется статус код ответа. Если он не равен 200, выбрасывается исключение с информацией об ошибке.
   - Если `stream` установлен в `False` (не потоковый режим):
     - Полученный JSON-ответ преобразуется в Python-словарь.
     - Извлекается сгенерированный текст из поля `choices` и возвращается через генератор.
     - Если поле `choices` отсутствует в ответе, выбрасывается исключение.
   - Если `stream` установлен в `True` (потоковый режим):
     - Итерируется по строкам в ответе.
     - Если строка содержит `b"content"`, она разделяется для извлечения данных.
     - Извлеченные данные преобразуются из JSON в Python-словарь и извлекается сгенерированный текст из поля `delta`.
     - Текст возвращается через генератор.

4. **Обработка ошибок**:
   - Функция перехватывает возможные исключения, возникающие в процессе выполнения запроса или обработки ответа, и логирует их с использованием `logger.error`.

```
   Инициализация активных серверов и заголовков
   │
   └───> Формирование JSON-тела запроса
        │
        └───> Создание сессии requests.Session()
             │
             └───> GET-запрос к серверу для инициализации cookies
                  │
                  └───> POST-запрос к API сервиса EasyChat
                       │
                       └───> Проверка статус кода ответа
                            │
                            ├───> stream == False
                            │    │
                            │    └───> Извлечение текста из JSON ответа
                            │
                            └───> stream == True
                                 │
                                 └───> Итерация по строкам в ответе
                                      │
                                      └───> Извлечение текста из поля delta
```

**Примеры**:

```python
    # Пример 1: Не потоковый запрос
    messages = [{"role": "user", "content": "Напиши короткое стихотворение о весне."}]
    result = EasyChat.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False)
    for item in result:
        print(item)

    # Пример 2: Потоковый запрос
    messages = [{"role": "user", "content": "Расскажи о себе."}]
    result = EasyChat.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True)
    for item in result:
        print(item)

    # Пример 3: Запрос с указанием температуры
    messages = [{"role": "user", "content": "Что такое машинное обучение?"}]
    result = EasyChat.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False, temperature=0.7)
    for item in result:
        print(item)