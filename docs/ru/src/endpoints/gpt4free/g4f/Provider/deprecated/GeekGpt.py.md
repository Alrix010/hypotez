# Модуль GeekGpt
## Обзор

Модуль `GeekGpt` представляет собой реализацию провайдера для взаимодействия с сервисом GeekGPT. Он позволяет отправлять запросы к моделям GPT, включая `gpt-3.5-turbo` и `gpt-4`, и получать ответы в потоковом режиме. Модуль поддерживает сохранение истории сообщений.

## Подробней

Модуль `GeekGpt` является частью системы, обеспечивающей взаимодействие с различными поставщиками языковых моделей. Он использует библиотеку `requests` для отправки HTTP-запросов и модуль `json` для обработки данных в формате JSON.

## Классы

### `GeekGpt`

**Описание**: Класс `GeekGpt` предоставляет интерфейс для взаимодействия с сервисом GeekGPT.

**Наследует**:
- `AbstractProvider`: Класс `GeekGpt` наследует `AbstractProvider`, что позволяет унифицировать доступ к различным поставщикам моделей.

**Атрибуты**:
- `url` (str): URL-адрес сервиса GeekGPT.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку модели `gpt-4`.

### `create_completion`
```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    **kwargs
) -> CreateResult:
    """
    Создает запрос на завершение текста к сервису GeekGPT.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
        **kwargs: Дополнительные параметры запроса.

    Returns:
        CreateResult: Результат запроса.

    Raises:
        RuntimeError: Если возникает ошибка при обработке данных ответа.
    """
```

**Назначение**: Метод `create_completion` отправляет запрос к сервису GeekGPT для генерации завершения текста на основе предоставленных сообщений и параметров.

**Параметры**:
- `cls`: Ссылка на класс.
- `model` (str): Имя используемой модели. Если не указано, используется `"gpt-3.5-turbo"`.
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `stream` (bool): Определяет, следует ли возвращать результат в виде потока.
- `**kwargs`: Дополнительные параметры, такие как `temperature`, `presence_penalty`, `top_p` и `frequency_penalty`.

**Возвращает**:
- `CreateResult`: Результат запроса к API, представляющий собой поток данных или завершенный текст.

**Вызывает исключения**:
- `RuntimeError`: Вызывается, если при обработке полученных данных возникает ошибка, например, если не удается распарсить JSON.

**Как работает функция**:
1. **Подготовка данных**: Функция принимает входные параметры, такие как модель, сообщения и дополнительные аргументы, и формирует на их основе JSON-структуру данных для отправки в запросе.
2. **Формирование заголовков**: Создаются заголовки HTTP-запроса, включая токен авторизации и тип контента.
3. **Отправка запроса**: С использованием библиотеки `requests` отправляется POST-запрос к API `https://ai.fakeopen.com/v1/chat/completions` с установленными заголовками и данными.
4. **Обработка потока данных**: Если установлен флаг `stream=True`, функция начинает итерацию по частям ответа, полученным от сервера. Каждая часть ответа проверяется на наличие содержимого (`b'content' in chunk`).
5. **Извлечение контента**: Из каждой части извлекается JSON-объект, содержащий сгенерированный контент. Если JSON-объект содержит сообщение об окончании потока (`"[DONE]"`), итерация прекращается.
6. **Обработка ошибок**: В случае возникновения исключений при обработке JSON-данных, функция возбуждает исключение `RuntimeError` с информацией об ошибке.
7. **Возврат контента**: Функция генерирует (yield) извлеченный контент, если он присутствует в текущей части ответа.

```
Подготовка запроса и данных  (A)
│
└── Формирование JSON (json_data), заголовков (headers)
│
Отправка POST-запроса к API (B)
│
└── Итерация по частям ответа (chunk)
│
Проверка наличия контента в ответе (C)
│
└── Есть контент?
│   ├── Да: Извлечение и обработка JSON (D)
│   │   └── Успешно?
│   │       ├── Да: yield контент (E)
│   │       └── Нет: Выброс RuntimeError (F)
│   └── Нет: Пропуск части
│
Конец итерации по частям ответа (G)
```
**Примеры**:
```python
# Пример 1: Создание запроса с минимальными параметрами
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
result = GeekGpt.create_completion(model=model, messages=messages, stream=stream)
for chunk in result:
    print(chunk, end="")

# Пример 2: Создание запроса с указанием температуры
model = "gpt-4"
messages = [{"role": "user", "content": "Tell me a joke."}]
stream = True
kwargs = {"temperature": 0.7}
result = GeekGpt.create_completion(model=model, messages=messages, stream=stream, **kwargs)
for chunk in result:
    print(chunk, end="")