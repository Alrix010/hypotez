# Модуль Aibn

## Обзор

Модуль предоставляет асинхронный генератор для взаимодействия с сервисом Aibn (https://aibn.cc), который предоставляет доступ к моделям, аналогичным GPT-3.5 Turbo. Модуль предназначен для асинхронной генерации ответов на основе предоставленных сообщений.

## Подробнее

Этот модуль является частью проекта `hypotez` и служит для обеспечения доступа к различным поставщикам моделей (providers) в рамках gpt4free. Он использует асинхронные запросы для взаимодействия с API сервиса Aibn и предоставляет результаты в виде асинхронного генератора. Модуль поддерживает сохранение истории сообщений и работает с моделью gpt-3.5-turbo.

## Классы

### `Aibn`

**Описание**: Класс `Aibn` является асинхронным генератором провайдером. Он взаимодействует с API сервиса Aibn для генерации текста на основе входных сообщений.

**Наследует**:
- `AsyncGeneratorProvider`: Класс наследуется от `AsyncGeneratorProvider`, который предоставляет базовую функциональность для асинхронных генераторов провайдеров.

**Аттрибуты**:
- `url` (str): URL сервиса Aibn (`https://aibn.cc`).
- `working` (bool): Указывает, работает ли провайдер в данный момент. По умолчанию `False`.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений. Значение `True`.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo. Значение `True`.

**Методы**:
- `create_async_generator`: Асинхронный метод-генератор для создания асинхронного генератора ответов от API Aibn.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API Aibn.

    Args:
        model (str): Модель для использования (например, "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от сервера в секундах. По умолчанию `120`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий части ответа от API Aibn.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса к API.

    """
```

**Назначение**: Создает асинхронный генератор для получения ответов от API Aibn.

**Параметры**:
- `cls`: Ссылка на класс `Aibn`.
- `model` (str): Имя модели, которую нужно использовать для генерации ответа.
- `messages` (Messages): Список сообщений, представляющих собой историю разговора.
- `proxy` (str, optional): URL прокси-сервера, через который нужно отправлять запросы. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от сервера в секундах. По умолчанию `120`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает части ответа от API Aibn по мере их поступления.

**Как работает функция**:

1.  **Инициализация**: Создается асинхронная сессия с использованием `StreamSession` для выполнения потоковых HTTP-запросов. Устанавливается impersonate="chrome107", прокси и таймаут.
2.  **Подготовка данных**: Формируется словарь `data`, содержащий сообщения, пустой пароль (`pass`), подпись (`sign`) и временную метку (`time`). Подпись генерируется с использованием функции `generate_signature`.
3.  **Выполнение запроса**: Отправляется POST-запрос к API (`f"{cls.url}/api/generate"`) с данными в формате JSON.
4.  **Обработка ответа**: Полученный ответ обрабатывается по частям (`response.iter_content()`), каждая часть декодируется и выдается через `yield`.

**ASCII схема работы функции**:

```
Начало
  ↓
Создание асинхронной сессии (StreamSession)
  ↓
Формирование данных запроса (data)
  ↓
Генерация подписи (generate_signature)
  ↓
Отправка POST-запроса к API Aibn
  ↓
Обработка потокового ответа (iter_content)
  ↓
Декодирование и выдача частей ответа (yield)
  ↓
Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import AsyncGenerator, List, Dict

async def main():
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in Aibn.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

### `generate_signature`

```python
def generate_signature(timestamp: int, message: str, secret: str = "undefined") -> str:
    """Генерирует подпись для запроса к API Aibn.

    Args:
        timestamp (int): Временная метка запроса.
        message (str): Сообщение для подписи.
        secret (str, optional): Секретный ключ. По умолчанию "undefined".

    Returns:
        str: SHA256-хеш, представляющий подпись.

    """
```

**Назначение**: Генерирует подпись для запроса к API Aibn.

**Параметры**:
- `timestamp` (int): Временная метка запроса.
- `message` (str): Сообщение, которое нужно подписать.
- `secret` (str, optional): Секретный ключ. По умолчанию `"undefined"`.

**Возвращает**:
- `str`: SHA256-хеш, представляющий подпись.

**Как работает функция**:

1.  **Формирование данных**: Создается строка `data` путем конкатенации временной метки, сообщения и секретного ключа через двоеточие.
2.  **Хеширование**: Строка `data` кодируется в байты и хешируется с использованием SHA256.
3.  **Возврат подписи**: Возвращается шестнадцатеричное представление хеша.

**ASCII схема работы функции**:

```
Начало
  ↓
Формирование строки данных (timestamp:message:secret)
  ↓
Кодирование строки в байты
  ↓
Вычисление SHA256-хеша
  ↓
Преобразование хеша в шестнадцатеричное представление
  ↓
Конец
```

**Примеры**:

```python
# Пример использования generate_signature
timestamp = int(time.time())
message = "Hello, how are you?"
signature = generate_signature(timestamp, message)
print(f"Signature: {signature}")