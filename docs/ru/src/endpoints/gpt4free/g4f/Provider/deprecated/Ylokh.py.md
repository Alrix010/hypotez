# Модуль Ylokh

## Обзор

Модуль `Ylokh` предоставляет асинхронный генератор для взаимодействия с API Ylokh, который позволяет получать ответы от языковой модели GPT-3.5 Turbo. Он поддерживает потоковую передачу данных и сохранение истории сообщений. Модуль предназначен для использования в асинхронных приложениях и интегрируется с другими компонентами проекта `hypotez`.

## Подробней

Модуль использует `StreamSession` из `requests` для асинхронной отправки запросов и получения потоковых ответов. Он также обрабатывает JSON-ответы и извлекает контент из них. Модуль предназначен для работы с API Ylokh, предоставляя удобный интерфейс для взаимодействия с моделью GPT-3.5 Turbo.

## Классы

### `Ylokh`

**Описание**: Класс `Ylokh` является поставщиком асинхронного генератора, который взаимодействует с API Ylokh для получения ответов от языковой модели.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL для взаимодействия с API Ylokh (`"https://chat.ylokh.xyz"`).
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo (`True`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = True,
        proxy: str = None,
        timeout: int = 120,
        **kwargs
    ) -> AsyncResult:
        """ Создает асинхронный генератор для взаимодействия с API Ylokh.

        Args:
            model (str): Имя модели для использования (например, "gpt-3.5-turbo").
            messages (Messages): Список сообщений для отправки в API.
            stream (bool, optional): Включает потоковую передачу данных. По умолчанию `True`.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
            **kwargs: Дополнительные аргументы для передачи в API.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий контент из ответов API.

        Raises:
            Exception: Если возникает ошибка при выполнении запроса к API.

        """
```

**Параметры**:
- `cls`: Ссылка на класс `Ylokh`.
- `model` (str): Имя модели для использования (например, "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool, optional): Включает потоковую передачу данных. По умолчанию `True`.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
- `**kwargs`: Дополнительные аргументы для передачи в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий контент из ответов API.

**Как работает функция**:

1. **Инициализация параметров**:
   - Устанавливает модель, если она не указана, в "gpt-3.5-turbo".
   - Определяет заголовки запроса, включая `Origin` и `Referer`.
   - Формирует данные запроса, включая сообщения, модель, параметры температуры, штрафы и флаг потоковой передачи.

2. **Отправка запроса**:
   - Использует `StreamSession` для асинхронной отправки POST-запроса к API Ylokh.
   - Включает параметры прокси и таймаута.

3. **Обработка потокового ответа**:
   - Если включена потоковая передача (`stream=True`):
     - Читает ответ построчно.
     - Декодирует каждую строку.
     - Если строка начинается с "data: ", извлекает JSON-данные.
     - Если строка "data: [DONE]", завершает чтение.
     - Извлекает контент из поля `content` в JSON-данных и возвращает его через генератор.

4. **Обработка не потокового ответа**:
   - Если потоковая передача не включена (`stream=False`):
     - Читает JSON-ответ целиком.
     - Извлекает контент из поля `content` в JSON-данных и возвращает его.

5. **Обработка ошибок**:
   - Если возникает HTTP ошибка, поднимает исключение `HTTPError`.

```
Инициализация параметров
│
├───► Отправка POST-запроса к API Ylokh
│   │
│   └───► Обработка потокового ответа (stream=True)
│       │   │
│       │   ├───► Чтение каждой строки ответа
│       │   │   │
│       │   ├───► Декодирование строки
│       │   │   │
│       │   ├───► Извлечение JSON-данных из строки "data: ..."
│       │   │   │
│       │   ├───► Проверка на "data: [DONE]" (завершение потока)
│       │   │   │
│       │   └───► Извлечение контента из JSON и генерация значения
│       │
│   │
│   └───► Обработка не потокового ответа (stream=False)
│       │
│       ├───► Чтение JSON-ответа целиком
│       │   │
│       └───► Извлечение контента из JSON и генерация значения
│
└───► Завершение
```

**Примеры**:

```python
# Пример использования асинхронного генератора с потоковой передачей
async for content in Ylokh.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello"}]):
    print(content, end="")

# Пример использования асинхронного генератора без потоковой передачи
content = [i async for i in Ylokh.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello"}], stream=False)][0]
print(content)