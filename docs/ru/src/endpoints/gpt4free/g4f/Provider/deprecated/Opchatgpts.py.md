# Модуль Opchatgpts

## Обзор

Модуль `Opchatgpts` предоставляет асинхронный генератор для взаимодействия с сервисом Opchatgpts.net. Он предназначен для получения ответов от модели GPT и поддерживает как историю сообщений, так и модель GPT-3.5 Turbo. Модуль использует `aiohttp` для асинхронных HTTP-запросов и предоставляет функциональность для потоковой передачи данных.

## Подробнее

Этот модуль позволяет интегрировать взаимодействие с Opchatgpts.net в асинхронные приложения, обеспечивая получение ответов в режиме реального времени через потоковую передачу данных. Он настраивает заголовки запросов, формирует данные для отправки и обрабатывает ответы, разделяя их на части для генерации результата.

## Классы

### `Opchatgpts`

**Описание**: Класс `Opchatgpts` является асинхронным генератором провайдера, который взаимодействует с API Opchatgpts.net.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL сервиса Opchatgpts.net.
- `working` (bool): Указывает, работает ли провайдер (в данном случае всегда `False`).
- `supports_message_history` (bool): Поддерживает ли провайдер историю сообщений (в данном случае `True`).
- `supports_gpt_35_turbo` (bool): Поддерживает ли провайдер модель GPT-3.5 Turbo (в данном случае `True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от Opchatgpts.net.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None, **kwargs) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от Opchatgpts.net.

    Args:
        cls (Opchatgpts): Ссылка на класс.
        model (str): Модель для использования (не используется в данной реализации).
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы (не используются в данной реализации).

    Returns:
        AsyncResult: Асинхронный генератор, выдающий части ответа от Opchatgpts.net.

    Raises:
        RuntimeError: Если полученная строка данных не соответствует ожидаемому формату.
        Exception: Если возникает ошибка при выполнении HTTP-запроса.
    """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Opchatgpts.net, отправляет сообщения и обрабатывает ответы в реальном времени.

**Параметры**:
- `cls` (Opchatgpts): Ссылка на класс.
- `model` (str): Модель для использования (фактически не используется в данной реализации).
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `proxy` (str, optional): Прокси-сервер для использования при выполнении запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые не используются в данной функции.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа от Opchatgpts.net.

**Вызывает исключения**:
- `RuntimeError`: Возникает, если полученная строка данных не соответствует ожидаемому формату (например, отсутствует ключ "type").
- `Exception`: Может возникнуть при выполнении HTTP-запроса, например, при ошибке подключения или получения некорректного ответа.

**Как работает функция**:

1.  **Подготовка заголовков**: Функция формирует заголовки HTTP-запроса, включая User-Agent, Accept, Origin и Referer, необходимые для взаимодействия с API Opchatgpts.net.
2.  **Создание сессии**: Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов. Сессия создается с заданными заголовками.
3.  **Формирование данных**: Подготавливаются данные для отправки в формате JSON, включая идентификаторы бота и чата, контекст, сообщения и флаг потоковой передачи.
4.  **Отправка запроса**: Выполняется POST-запрос к API Opchatgpts.net с использованием `session.post`. Если указан `proxy`, он также используется при выполнении запроса.
5.  **Обработка ответа**: Функция асинхронно итерируется по строкам ответа, полученным от сервера. Каждая строка проверяется на наличие префикса `b"data: "`.
6.  **Разбор данных**: Если строка начинается с `b"data: "`, она преобразуется из JSON в словарь. Проверяется наличие ключа `"type"` в словаре.
7.  **Генерация результата**: В зависимости от значения ключа `"type"`, функция выдает данные (если `"type" == "live"`) или завершает работу (если `"type" == "end"`).
8.  **Обработка ошибок**: Если в процессе разбора данных или проверки типа возникает ошибка, выбрасывается исключение `RuntimeError`.

```
Подготовка запроса и заголовков
│
├──► Создание асинхронной сессии (ClientSession)
│   │
│   ├──► Формирование данных запроса (JSON)
│   │   │
│   │   ├──► Отправка POST-запроса к API (session.post)
│   │   │   │
│   │   │   ├──► Обработка потока ответа
│   │   │   │   │
│   │   │   │   ├──► Проверка префикса "data: "
│   │   │   │   │   │
│   │   │   │   │   ├──► Разбор JSON-данных
│   │   │   │   │   │   │
│   │   │   │   │   │   ├──► Проверка типа сообщения ("type")
│   │   │   │   │   │   │   │
│   │   │   │   │   │   │   ├──► Выдача данных ("live") или завершение ("end")
│   │   │   │   │   │   │   │   │
│   │   │   │   │   │   │   └──◄ Обработка ошибок (RuntimeError)
│   │   │   │   │   │   │
│   │   │   │   │   │   └──◄ Ошибка разбора JSON
│   │   │   │   │   │
│   │   │   │   │   └──◄ Строка не начинается с "data: "
│   │   │   │   │
│   │   │   │   └──◄ Завершена обработка потока
│   │   │   │
│   │   │   └──◄ Ошибка при отправке запроса
│   │   │
│   │   └──◄ Ошибка формирования данных
│   │
│   └──◄ Ошибка создания сессии
│
└──◄ Запрос и заголовки подготовлены
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Привет!"},
        {"role": "assistant", "content": "Здравствуйте!"},
        {"role": "user", "content": "Как дела?"}
    ]
    async for message in Opchatgpts.create_async_generator(model="default", messages=messages):
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())