# Модуль `GPTalk.py`

## Обзор

Модуль предоставляет асинхронный класс `GPTalk` для взаимодействия с API gptalk.net. Он позволяет генерировать ответы от языковой модели, используя предоставленные сообщения, и поддерживает проксирование. Модуль использует `aiohttp` для асинхронных HTTP-запросов и `secrets` для генерации случайных fingerprint.

## Подробней

Этот модуль предназначен для асинхронного взаимодействия с API `gptalk.net`. Он предоставляет функциональность для аутентификации пользователя и отправки запросов на генерацию текста с использованием указанной языковой модели. Класс `GPTalk` управляет аутентификацией, повторным использованием токенов и отправкой сообщений, возвращая сгенерированный текст в виде асинхронного генератора.

## Классы

### `GPTalk`

**Описание**: Асинхронный провайдер для взаимодействия с API GPTalk.

**Принцип работы**:
1.  **Аутентификация**: При первом использовании или истечении срока действия текущего токена, класс выполняет аутентификацию, получая новый токен из API.
2.  **Формирование запроса**: На основе входных сообщений формируется JSON-запрос к API.
3.  **Отправка запроса**: Запрос отправляется на API `gptalk.net` с использованием `aiohttp`.
4.  **Обработка ответа**: Ответ от API обрабатывается построчно, извлекая содержимое сгенерированного текста и возвращая его через асинхронный генератор.
5.  **Повторное использование токена**: Класс повторно использует полученный токен аутентификации до тех пор, пока не истечет его срок действия или не будет достигнуто максимальное количество использований.

**Аттрибуты**:

*   `url` (str): URL API gptalk.net.
*   `working` (bool): Указывает, работает ли провайдер (по умолчанию `False`).
*   `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель "gpt-3.5-turbo" (по умолчанию `True`).
*   `_auth` (Optional[dict]): Содержит информацию об аутентификации (токен и срок действия).
*   `used_times` (int): Счетчик использований текущего токена.

**Методы**:

*   `create_async_generator()`: Создает асинхронный генератор для получения ответов от API GPTalk.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от API GPTalk.

        Args:
            model (str): Название модели для генерации текста.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий части сгенерированного текста.

        Raises:
            aiohttp.ClientResponseError: Если возникает ошибка при выполнении HTTP-запроса.

        """
```

**Назначение**: Функция `create_async_generator` создает и возвращает асинхронный генератор, который позволяет получать ответы от API GPTalk. Она выполняет аутентификацию (если необходимо), формирует и отправляет запрос к API, а затем обрабатывает полученный ответ, извлекая сгенерированный текст и возвращая его частями через генератор.

**Как работает функция**:

1.  **Инициализация**:
    *   Проверяет и устанавливает модель, если она не была передана.
    *   Получает текущий timestamp.
    *   Формирует заголовки HTTP-запроса, включая `user-agent`, `content-type` и другие необходимые параметры.
2.  **Аутентификация**:
    *   Проверяет, требуется ли новая аутентификация на основе наличия текущего токена (`cls._auth`), срока его действия (`cls._auth["expires_at"]`) и количества использований (`cls.used_times`).
    *   Если требуется аутентификация:
        *   Формирует JSON-запрос для аутентификации, включающий случайный `fingerprint` и платформу.
        *   Отправляет POST-запрос на endpoint `/api/chatgpt/user/login`.
        *   Обновляет данные аутентификации (`cls._auth`) на основе полученного ответа.
        *   Сбрасывает счетчик использований токена (`cls.used_times`).
3.  **Формирование запроса на генерацию текста**:
    *   Формирует JSON-запрос для генерации текста, включающий отформатированные сообщения (`content`), модель, параметры температуры и другие настройки.
4.  **Отправка запроса на генерацию текста**:
    *   Добавляет заголовок `authorization` с использованием текущего токена.
    *   Отправляет POST-запрос на endpoint `/api/chatgpt/chatapi/text`.
    *   Получает токен для стриминга (`token`).
    *   Увеличивает счетчик использований токена (`cls.used_times`).
5.  **Обработка стримингового ответа**:
    *   Отправляет GET-запрос на endpoint `/api/chatgpt/chatapi/stream` с параметром `token`.
    *   Обрабатывает ответ построчно:
        *   Проверяет, начинается ли строка с `data: `.
        *   Если строка начинается с `data: [DONE]`, завершает генерацию.
        *   Извлекает `content` из JSON-данных строки.
        *   Извлекает новую часть сгенерированного текста (разницу между текущим и предыдущим сообщением).
        *   Возвращает новую часть текста через `yield`.
        *   Обновляет `last_message` для следующей итерации.

**Блок-схема**:

```
    +-----------------------+
    |       Начало          |
    +-----------------------+
    |
    V
    +-----------------------+
    |   Проверка аутентификации    |
    |   (токен, срок действия,   |
    |    кол-во использований)   |
    +-----------------------+
    |
    +----ДА-----------------+----НЕТ---+
    |                       |
    V                       V
    +-----------------------+  +-----------------------+
    |    Аутентификация     |  |  Пропуск аутентификации |
    |    (запрос логина)    |  +-----------------------+
    +-----------------------+
    |
    V
    +-----------------------+
    |Формирование запроса на|
    |    генерацию текста    |
    +-----------------------+
    |
    V
    +-----------------------+
    |  Отправка запроса на   |
    |    генерацию текста    |
    +-----------------------+
    |
    V
    +-----------------------+
    |  Обработка стриминга   |
    |     ответа (yield)      |
    +-----------------------+
    |
    V
    +-----------------------+
    |       Конец           |
    +-----------------------+
```

**Примеры**:

```python
    # Пример использования функции create_async_generator
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for message_part in GPTalk.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(message_part, end="")

    # Пример использования с прокси
    messages = [{"role": "user", "content": "Tell me a joke."}]
    async for message_part in GPTalk.create_async_generator(model="gpt-3.5-turbo", messages=messages, proxy="http://your_proxy:8080"):
        print(message_part, end="")