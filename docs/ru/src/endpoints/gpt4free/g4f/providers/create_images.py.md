# Модуль для создания изображений

## Обзор

Модуль `create_images.py` предназначен для создания изображений на основе текстовых запросов. Он использует DALL-E 3 или аналогичные генераторы изображений. Входящие сообщения анализируются на предмет наличия специальных тегов `<img data-prompt="keywords for the image">`, содержащих текстовые подсказки для генерации изображений. Модуль предоставляет классы и методы для обработки этих запросов как в синхронном, так и в асинхронном режимах.

## Подробней

Этот модуль является частью проекта `hypotez` и служит для расширения возможностей языковой модели, позволяя ей генерировать изображения на основе текстовых описаний. Он интегрируется с другими провайдерами и использует их для обработки текстовых сообщений и создания изображений.
Основное назначение модуля - предоставить удобный интерфейс для создания изображений на основе текстовых запросов, встроенных в сообщения.

## Классы

### `CreateImagesProvider`

**Описание**: Класс `CreateImagesProvider` предназначен для обработки запросов на создание изображений на основе текстовых подсказок.

**Наследует**:
- `BaseProvider`: Базовый класс для всех провайдеров.

**Атрибуты**:
- `provider` (`ProviderType`): Провайдер, используемый для обработки задач, не связанных с изображениями.
- `create_images` (`callable`): Функция для синхронного создания изображений.
- `create_images_async` (`callable`): Функция для асинхронного создания изображений.
- `system_message` (`str`): Сообщение, объясняющее возможность создания изображений.
- `include_placeholder` (`bool`): Флаг, определяющий, следует ли включать заполнитель изображения в вывод.
- `__name__` (`str`): Имя провайдера.
- `url` (`str`): URL провайдера.
- `working` (`bool`): Указывает, работает ли провайдер.
- `supports_stream` (`bool`): Указывает, поддерживает ли провайдер потоковую передачу.

**Методы**:
- `__init__`: Инициализирует `CreateImagesProvider`.
- `create_completion`: Создает результат завершения, обрабатывая все запросы на создание изображений, найденные в сообщениях.
- `create_async`: Асинхронно создает ответ, обрабатывая все запросы на создание изображений, найденные в сообщениях.

### `__init__`

```python
def __init__(
    self,
    provider: ProviderType,
    create_images: callable,
    create_async: callable,
    system_message: str = system_message,
    include_placeholder: bool = True
) -> None:
    """
    Инициализирует CreateImagesProvider.

    Args:
        provider (ProviderType): Провайдер, используемый для обработки задач, не связанных с изображениями.
        create_images (callable): Функция для синхронного создания изображений.
        create_async (callable): Функция для асинхронного создания изображений.
        system_message (str, optional): Системное сообщение, которое будет добавлено к сообщениям. По умолчанию используется предопределенное сообщение.
        include_placeholder (bool, optional): Определяет, следует ли включать заполнитель изображения в вывод. По умолчанию True.
    """
```

**Назначение**:
Инициализирует экземпляр класса `CreateImagesProvider`, устанавливая необходимые атрибуты для дальнейшей работы с запросами на создание изображений.

**Параметры**:
- `provider` (`ProviderType`): Провайдер, используемый для обработки задач, не связанных с изображениями.
- `create_images` (`callable`): Функция для синхронного создания изображений.
- `create_async` (`callable`): Функция для асинхронного создания изображений.
- `system_message` (`str`, optional): Системное сообщение, которое будет добавлено к сообщениям. По умолчанию используется предопределенное сообщение.
- `include_placeholder` (`bool`, optional): Определяет, следует ли включать заполнитель изображения в вывод. По умолчанию `True`.

**Возвращает**:
- `None`

**Как работает**:
1. Присваивает входные параметры соответствующим атрибутам экземпляра класса.
2. Устанавливает имя и URL провайдера, а также его рабочее состояние и поддержку потоковой передачи.

**Примеры**:

```python
from unittest.mock import MagicMock

# Пример инициализации CreateImagesProvider
provider_mock = MagicMock()
provider_mock.__name__ = "MockProvider"
provider_mock.url = "http://example.com"
provider_mock.working = True
provider_mock.supports_stream = False

create_images_mock = MagicMock()
create_async_mock = MagicMock()

image_provider = CreateImagesProvider(
    provider=provider_mock,
    create_images=create_images_mock,
    create_async=create_async_mock
)

print(image_provider.__name__)  # MockProvider
print(image_provider.url)  # http://example.com
```

### `create_completion`

```python
def create_completion(
    self,
    model: str,
    messages: Messages,
    stream: bool = False,
    **kwargs
) -> CreateResult:
    """
    Создает результат завершения, обрабатывая все запросы на создание изображений, найденные в сообщениях.

    Args:
        model (str): Модель, используемая для создания.
        messages (Messages): Сообщения для обработки, которые могут содержать подсказки для создания изображений.
        stream (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию False.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Yields:
        CreateResult: Выдает фрагменты обработанных сообщений, включая данные изображения, если это применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения подсказок создания изображений. Когда такая подсказка найдена,
        он вызывает синхронную функцию создания изображений и включает полученное изображение в вывод.
    """
```

**Назначение**:
Создает результат завершения, обрабатывая сообщения и извлекая из них запросы на создание изображений. Метод анализирует сообщения, ищет теги `<img data-prompt="...">`, содержащие текстовые подсказки для генерации изображений, и использует синхронную функцию `create_images` для создания изображений на основе этих подсказок.

**Параметры**:
- `model` (`str`): Модель, используемая для создания.
- `messages` (`Messages`): Список сообщений для обработки.
- `stream` (`bool`, optional): Флаг, указывающий, следует ли использовать потоковый режим. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

**Возвращает**:
- `CreateResult`: Генератор, выдающий фрагменты обработанных сообщений, включая данные изображений, если они найдены.

**Как работает функция**:

     Начало
     ↓
     → Добавление системного сообщения в начало списка сообщений
     ↓
     → Итерирование по фрагментам, возвращаемым провайдером
     ↓
     → Проверка, является ли фрагмент ImageResponse
     │   ├── Да: Возврат фрагмента
     │   └── Нет: Проверка, является ли фрагмент строкой и содержит ли '<'
     │       ├── Да: Добавление фрагмента в буфер и проверка наличия '>'
     │       │   ├── Да: Поиск тега <img data-prompt="(.*?)"> в буфере
     │       │   │   ├── Найден: Извлечение подсказки и создание изображений
     │       │   │   │   ├── Включение заполнителя (placeholder), если необходимо
     │       │   │   │   └── Возврат созданных изображений
     │       │   │   └── Не найден: Возврат буфера
     │       │   └── Нет: Продолжение добавления в буфер
     │       └── Нет: Возврат фрагмента
     ↓
     Конец

**Примеры**:
```python
from unittest.mock import MagicMock

# Пример использования create_completion с моками
provider_mock = MagicMock()
provider_mock.create_completion.return_value = ["Hello", '<img data-prompt="cat">', "World"]
create_images_mock = MagicMock(return_value=["Image Data"])

image_provider = CreateImagesProvider(
    provider=provider_mock,
    create_images=create_images_mock,
    create_async=MagicMock()
)

messages_mock = [{"role": "user", "content": "Test message"}]

result = image_provider.create_completion(
    model="test_model",
    messages=messages_mock
)

for item in result:
    print(item)

# Вывод:
# Hello
# <img data-prompt="cat">
# Image Data
# World
```

### `create_async`

```python
async def create_async(
    self,
    model: str,
    messages: Messages,
    **kwargs
) -> str:
    """
    Асинхронно создает ответ, обрабатывая все запросы на создание изображений, найденные в сообщениях.

    Args:
        model (str): Модель, используемая для создания.
        messages (Messages): Сообщения для обработки, которые могут содержать подсказки для создания изображений.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Returns:
        str: Обработанная строка ответа, включая асинхронно сгенерированные данные изображения, если это применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения подсказок создания изображений. Когда такая подсказка найдена,
        он вызывает асинхронную функцию создания изображений и включает полученное изображение в вывод.
    """
```

**Назначение**:
Асинхронно создает ответ, обрабатывая сообщения и извлекая из них запросы на создание изображений. Метод анализирует сообщения, ищет теги `<img data-prompt="...">`, содержащие текстовые подсказки для генерации изображений, и использует асинхронную функцию `create_images_async` для создания изображений на основе этих подсказок.

**Параметры**:
- `model` (`str`): Модель, используемая для создания.
- `messages` (`Messages`): Список сообщений для обработки.
- `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

**Возвращает**:
- `str`: Обработанная строка ответа, включающая данные сгенерированных изображений.

**Как работает функция**:

     Начало
     ↓
     → Добавление системного сообщения в начало списка сообщений
     ↓
     → Получение ответа от провайдера асинхронно
     ↓
     → Поиск всех тегов <img data-prompt="(.*?)"> в ответе
     ↓
     → Создание списка асинхронных задач для генерации изображений
     ↓
     → Сбор результатов выполнения асинхронных задач
     ↓
     → Замена заполнителей (placeholder) в ответе на сгенерированные изображения
     ↓
     Конец

**Примеры**:
```python
import asyncio
from unittest.mock import MagicMock

async def main():
    # Пример использования create_async с моками
    provider_mock = MagicMock()
    provider_mock.create_async.return_value = "<img data-prompt='cat'>Hello<img data-prompt='dog'>"
    create_images_async_mock = MagicMock(side_effect=["Image Data Cat", "Image Data Dog"])

    image_provider = CreateImagesProvider(
        provider=provider_mock,
        create_images=MagicMock(),
        create_async=create_images_async_mock
    )

    messages_mock = [{"role": "user", "content": "Test message"}]

    result = await image_provider.create_async(
        model="test_model",
        messages=messages_mock
    )

    print(result)

    # Вывод:
    # Image Data CatHelloImage Data Dog

asyncio.run(main())
```