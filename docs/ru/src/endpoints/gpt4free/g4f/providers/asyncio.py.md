# Модуль asyncio

## Обзор

Модуль предоставляет асинхронные утилиты и функции, необходимые для работы с асинхронным кодом, такие как обработка событийных циклов, преобразование асинхронных генераторов в синхронные и наоборот. Также включает в себя фикс для `RuntimeError: async generator ignored GeneratorExit`.

## Подробней

Этот модуль содержит функции, упрощающие работу с асинхронными операциями, особенно при интеграции с синхронным кодом. В частности, он обрабатывает проблемы, связанные с вложенными асинхронными циклами и преобразованием асинхронных генераторов в синхронные и наоборот. Он также обрабатывает проблемы совместимости с библиотеками `nest_asyncio` и `uvloop`.

## Функции

### `get_running_loop`

```python
def get_running_loop(check_nested: bool) -> Optional[AbstractEventLoop]:
    """
    Получает текущий выполняющийся цикл событий.

    Args:
        check_nested (bool): Определяет, нужно ли проверять вложенность циклов событий.

    Returns:
        Optional[AbstractEventLoop]: Текущий выполняющийся цикл событий, или None, если цикл не найден.

    Raises:
        NestAsyncioError: Если `check_nested` равен True и не установлен пакет "nest_asyncio".
    """
```

**Назначение**: Функция пытается получить текущий выполняющийся цикл событий asyncio. Если цикл событий уже запущен, функция возвращает его. Если цикл событий не запущен, функция возвращает `None`. Если установлен `uvloop`, функция проверяет, что цикл не является экземпляром `uvloop.Loop`, чтобы избежать проблем совместимости. Если `nest_asyncio` не установлен и `check_nested` имеет значение `True`, функция выдает ошибку `NestAsyncioError`.

**Как работает функция**:

1.  Попытка получить текущий выполняющийся цикл событий с помощью `asyncio.get_running_loop()`.
2.  Если цикл получен, проверяется, является ли он экземпляром `uvloop.Loop` при наличии `uvloop`. Если это так, цикл возвращается.
3.  Проверяется, был ли применен патч `nest_asyncio` к классу цикла. Если нет, и `nest_asyncio` установлен, он применяется. Если `nest_asyncio` не установлен и `check_nested` имеет значение `True`, вызывается исключение `NestAsyncioError`.
4.  Если цикл не получен, возвращается `None`.

```
A: Попытка получить текущий цикл событий
│
├── B: Цикл получен?
│   ├── Да → C: Проверка на uvloop
│   │   ├── D: uvloop установлен?
│   │   │   ├── Да → E: Цикл является экземпляром uvloop.Loop?
│   │   │   │   ├── Да → Возврат цикла
│   │   │   │   └── Нет → F: Проверка на патч nest_asyncio
│   │   │   │       ├── Патч применен?
│   │   │   │       │   ├── Да → Возврат цикла
│   │   │   │       │   └── Нет → G: nest_asyncio установлен?
│   │   │   │       │       ├── Да → Применить патч nest_asyncio → Возврат цикла
│   │   │   │       │       └── Нет → H: check_nested == True?
│   │   │   │       │           ├── Да → Вызвать NestAsyncioError
│   │   │   │       │           └── Нет → Возврат цикла
│   │   │   │       └──
│   │   │   └── Нет → F: Проверка на патч nest_asyncio
│   │   │       ├── Патч применен?
│   │   │       │   ├── Да → Возврат цикла
│   │   │       │   └── Нет → G: nest_asyncio установлен?
│   │   │       │       ├── Да → Применить патч nest_asyncio → Возврат цикла
│   │   │       │       └── Нет → H: check_nested == True?
│   │   │       │           ├── Да → Вызвать NestAsyncioError
│   │   │       │           └── Нет → Возврат цикла
│   │   │       └──
│   └── Нет → Возврат None
│
└──
```

**Примеры**:

```python
loop = get_running_loop(check_nested=True)
if loop:
    print("Найден цикл событий")
else:
    print("Цикл событий не найден")
```

### `await_callback`

```python
async def await_callback(callback: Callable):
    """
    Асинхронно ожидает выполнения переданной функции обратного вызова.

    Args:
        callback (Callable): Функция обратного вызова, которую нужно выполнить.

    Returns:
        await callback(): Результат выполнения функции обратного вызова.
    """
```

**Назначение**: Функция предназначена для асинхронного ожидания выполнения переданной функции обратного вызова. Она используется для обертывания синхронных функций, которые должны быть вызваны в асинхронном контексте.

**Как работает функция**:

1.  Принимает функцию обратного вызова `callback`.
2.  Использует `await` для асинхронного выполнения этой функции.
3.  Возвращает результат выполнения функции.

```
A: Принять callback функцию
│
└── B: Асинхронно дождаться выполнения callback()
    │
    └── C: Вернуть результат callback()
```

**Примеры**:

```python
async def my_callback():
    return "Hello, async world!"

async def main():
    result = await await_callback(my_callback)
    print(result)  # Вывод: Hello, async world!
```

### `async_generator_to_list`

```python
async def async_generator_to_list(generator: AsyncIterator) -> list:
    """
    Преобразует асинхронный генератор в список.

    Args:
        generator (AsyncIterator): Асинхронный генератор.

    Returns:
        list: Список элементов, сгенерированных асинхронным генератором.
    """
```

**Назначение**: Функция преобразует асинхронный генератор в список. Это полезно, когда необходимо собрать все элементы, генерируемые асинхронным генератором, в одну структуру данных.

**Как работает функция**:

1.  Принимает асинхронный генератор `generator`.
2.  Использует асинхронное включение списка (`[item async for item in generator]`) для итерации по генератору.
3.  Собирает все элементы, сгенерированные генератором, в список.
4.  Возвращает полученный список.

```
A: Принять асинхронный генератор
│
└── B: Итерировать по генератору и собрать элементы в список
    │
    └── C: Вернуть список элементов
```

**Примеры**:

```python
async def my_generator():
    for i in range(3):
        yield i

async def main():
    result = await async_generator_to_list(my_generator())
    print(result)  # Вывод: [0, 1, 2]
```

### `to_sync_generator`

```python
def to_sync_generator(generator: AsyncIterator, stream: bool = True) -> Iterator:
    """
    Преобразует асинхронный генератор в синхронный генератор.

    Args:
        generator (AsyncIterator): Асинхронный генератор.
        stream (bool): Если True, генератор выдает элементы по одному. Если False, генератор выдает список всех элементов.

    Yields:
        Iterator: Синхронный генератор.
    """
```

**Назначение**: Эта функция преобразует асинхронный генератор в синхронный генератор. Это позволяет использовать асинхронный код в синхронных контекстах. Функция может выдавать элементы по одному (stream=True) или выдать сразу список всех элементов (stream=False).

**Как работает функция**:

1.  Получает текущий выполняющийся цикл событий с помощью `get_running_loop(check_nested=False)`.
2.  Если `stream` равен `False`, функция преобразует асинхронный генератор в список с помощью `asyncio.run(async_generator_to_list(generator))` и выдает элементы списка.
3.  Если цикл событий не найден, создает новый цикл событий и устанавливает его как текущий.
4.  Итерируется по асинхронному генератору, используя `loop.run_until_complete(await_callback(gen.__anext__))` для получения следующего элемента.
5.  Выдает каждый полученный элемент.
6.  После завершения генератора закрывает цикл событий, если он был создан внутри функции.

```
A: Принять асинхронный генератор и флаг stream
│
├── B: Получить текущий цикл событий
│   │
│   ├── C: stream == False?
│   │   ├── Да → Преобразовать генератор в список и выдать элементы
│   │   └── Нет → D: Цикл событий существует?
│   │       ├── Да → E: Итерировать по генератору и выдавать элементы
│   │       └── Нет → Создать новый цикл событий → E: Итерировать по генератору и выдавать элементы
│   │
│   └── Закрыть цикл событий, если он был создан внутри функции
│
└──
```

**Примеры**:

```python
async def my_async_generator():
    for i in range(3):
        yield i

def main():
    sync_generator = to_sync_generator(my_async_generator())
    for item in sync_generator:
        print(item)  # Вывод: 0, 1, 2
```

### `to_async_iterator`

```python
async def to_async_iterator(iterator) -> AsyncIterator:
    """
    Преобразует синхронный итератор или асинхронный итерируемый объект в асинхронный итератор.

    Args:
        iterator: Синхронный итератор, асинхронный итерируемый объект или корутина.

    Yields:
        AsyncIterator: Асинхронный итератор.
    """
```

**Назначение**: Эта функция преобразует синхронный итератор, асинхронный итерируемый объект или корутину в асинхронный итератор. Это позволяет унифицировать обработку различных типов итерируемых объектов в асинхронном коде.

**Как работает функция**:

1.  Проверяет, является ли входной объект асинхронным итерируемым объектом (имеет метод `__aiter__`).
2.  Если да, то асинхронно итерируется по нему и выдает элементы.
3.  Если входной объект является корутиной, то ожидает ее выполнения и выдает результат.
4.  Если входной объект является синхронным итератором, то итерируется по нему и выдает элементы.

```
A: Принять итератор
│
├── B: Итератор является асинхронным итерируемым объектом?
│   ├── Да → C: Асинхронно итерировать по итератору и выдавать элементы
│   └── Нет → D: Итератор является корутиной?
│       ├── Да → E: Ожидать выполнения корутины и выдать результат
│       └── Нет → F: Итерировать по итератору и выдавать элементы
│
└──
```

**Примеры**:

```python
async def main():
    # Пример 1: Синхронный итератор
    sync_iterator = [1, 2, 3]
    async_iterator = to_async_iterator(sync_iterator)
    async for item in async_iterator:
        print(item)  # Вывод: 1, 2, 3

    # Пример 2: Асинхронный итерируемый объект
    async def async_generator():
        for i in range(3):
            yield i
    async_iterator = to_async_iterator(async_generator())
    async for item in async_iterator:
        print(item)  # Вывод: 0, 1, 2

    # Пример 3: Корутина
    async def my_coroutine():
        return "Hello, async world!"
    async_iterator = to_async_iterator(my_coroutine())
    async for item in async_iterator:
        print(item)  # Вывод: Hello, async world!