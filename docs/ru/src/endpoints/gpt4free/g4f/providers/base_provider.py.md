# Модуль `base_provider`

## Обзор

Модуль `base_provider` предоставляет абстрактные классы и утилиты для реализации провайдеров, используемых для создания и обработки запросов к различным моделям искусственного интеллекта. Он содержит базовые классы для синхронных, асинхронных и асинхронных генераторных провайдеров, а также вспомогательные функции и классы для работы с параметрами, аутентификацией и обработкой ошибок.

## Подробней

Модуль содержит классы, которые служат основой для создания конкретных провайдеров, взаимодействующих с различными AI-моделями. В частности, он определяет абстрактные методы для создания завершений (completions) и асинхронные аналоги этих методов. Также, модуль предоставляет инструменты для управления параметрами запросов, обработки аутентификации и кэширования, а также для обработки ошибок, возникающих в процессе взаимодействия с AI-моделями.

## Классы

### `AbstractProvider`

**Описание**: Абстрактный базовый класс для всех провайдеров.

**Принцип работы**:
Этот класс задает интерфейс для создания completion (завершений) с использованием различных моделей. Он определяет абстрактный метод `create_completion`, который должен быть реализован в подклассах. Также, он предоставляет методы для получения функций создания (create functions) и управления параметрами.

**Методы**:
- `create_completion`: Абстрактный метод для создания completion.
- `create_async`: Асинхронный метод для создания completion.
- `get_create_function`: Возвращает функцию создания completion.
- `get_async_create_function`: Возвращает асинхронную функцию создания completion.
- `get_parameters`: Возвращает параметры, поддерживаемые провайдером.
- `params`: Возвращает строку с параметрами, поддерживаемыми провайдером.

### `AsyncProvider`

**Описание**: Класс для асинхронных провайдеров.

**Принцип работы**:
Этот класс предоставляет реализацию для асинхронного создания completion. Он наследуется от `AbstractProvider` и реализует метод `create_completion`, используя асинхронный метод `create_async`.

**Методы**:
- `create_completion`: Создает completion, используя асинхронный метод `create_async`.
- `create_async`: Абстрактный асинхронный метод для создания completion.
- `get_create_function`: Возвращает функцию создания completion.
- `get_async_create_function`: Возвращает асинхронную функцию создания completion.

### `AsyncGeneratorProvider`

**Описание**: Класс для асинхронных генераторных провайдеров.

**Принцип работы**:
Этот класс предоставляет реализацию для асинхронного создания completion с использованием генераторов. Он поддерживает потоковую передачу результатов (streaming) и реализует методы `create_completion` и `create_async_generator`.

**Методы**:
- `create_completion`: Создает потоковую completion, используя асинхронный генератор `create_async_generator`.
- `create_async_generator`: Абстрактный асинхронный генератор для создания completion.
- `get_create_function`: Возвращает функцию создания completion.
- `get_async_create_function`: Возвращает асинхронный генератор создания completion.

### `ProviderModelMixin`

**Описание**: Миксин для добавления поддержки моделей к провайдерам.

**Принцип работы**:
Этот класс предоставляет атрибуты и методы для управления моделями, поддерживаемыми провайдером. Он позволяет указывать модель по умолчанию, список поддерживаемых моделей и псевдонимы моделей.

**Методы**:
- `get_models`: Возвращает список поддерживаемых моделей.
- `get_model`: Возвращает модель на основе переданного имени или псевдонима.

### `RaiseErrorMixin`

**Описание**: Миксин для обработки ошибок в ответах от провайдеров.

**Принцип работы**:
Этот класс предоставляет статический метод `raise_error`, который анализирует данные ответа и вызывает исключение, если в ответе содержится информация об ошибке.

**Методы**:
- `raise_error`: Анализирует данные ответа и вызывает исключение, если обнаружена ошибка.

### `AuthFileMixin`

**Описание**: Миксин для работы с файлами аутентификации.

**Принцип работы**:
Этот класс предоставляет метод `get_cache_file`, который возвращает путь к файлу кэша, используемому для хранения информации об аутентификации.

**Методы**:
- `get_cache_file`: Возвращает путь к файлу кэша.

### `AsyncAuthedProvider`

**Описание**: Класс для асинхронных провайдеров с поддержкой аутентификации.

**Принцип работы**:
Этот класс предоставляет реализацию для асинхронной аутентификации и кэширования результатов аутентификации. Он наследуется от `AsyncGeneratorProvider` и `AuthFileMixin` и реализует методы `on_auth_async`, `on_auth`, `write_cache_file`, `create_completion` и `create_async_generator`.

**Методы**:
- `on_auth_async`: Асинхронный метод для аутентификации.
- `on_auth`: Синхронный метод для аутентификации.
- `write_cache_file`: Записывает результаты аутентификации в файл кэша.
- `create_completion`: Создает completion с использованием аутентификации.
- `create_async_generator`: Создает асинхронный генератор completion с использованием аутентификации.
- `get_create_function`: Возвращает функцию создания completion.
- `get_async_create_function`: Возвращает асинхронный генератор создания completion.

## Функции

### `create_async`

```python
    async def create_async(
        cls,
        model: str,
        messages: Messages,
        *,\n        timeout: int = None,
        loop: AbstractEventLoop = None,
        executor: ThreadPoolExecutor = None,
        **kwargs
    ) -> str:
        """
        Асинхронно создает результат на основе данной модели и сообщений.

        Args:
            cls (type): Класс, в котором вызывается этот метод.
            model (str): Модель для использования при создании.
            messages (Messages): Сообщения для обработки.
            loop (AbstractEventLoop, optional): Цикл событий для использования. По умолчанию `None`.
            executor (ThreadPoolExecutor, optional): Исполнитель для запуска асинхронных задач. По умолчанию `None`.
            **kwargs: Дополнительные именованные аргументы.

        Returns:
            str: Созданный результат в виде строки.
        """
```

**Назначение**: Асинхронное создание результата на основе заданной модели и сообщений.

**Параметры**:
- `cls` (type): Класс, в котором вызывается этот метод.
- `model` (str): Модель для использования при создании.
- `messages` (Messages): Сообщения для обработки.
- `timeout` (int, optional): Время ожидания выполнения. По умолчанию `None`.
- `loop` (AbstractEventLoop, optional): Цикл событий для использования. По умолчанию `None`.
- `executor` (ThreadPoolExecutor, optional): Исполнитель для запуска асинхронных задач. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `str`: Созданный результат в виде строки.

**Как работает функция**:

1.  **Инициализация цикла событий**: Если цикл событий (`loop`) не передан, функция получает текущий выполняющийся цикл событий.
2.  **Определение функции создания**: Определяется внутренняя функция `create_func`, которая вызывает `cls.create_completion` для создания результата и объединяет полученные чанки.
3.  **Запуск в executor**: Функция `create_func` запускается в executor с использованием `loop.run_in_executor`.
4.  **Ожидание результата**: Результат выполнения `create_func` ожидается в течение заданного времени (`timeout`) с использованием `asyncio.wait_for`.

**ASCII flowchart**:

```
    Начало
    │
    │ Получение/использование цикла событий (loop)
    │
    │ Определение create_func (вызов create_completion и объединение чанков)
    │
    │ Запуск create_func в executor
    │
    │ Ожидание результата с таймаутом
    │
    Конец
```

**Примеры**:

```python
    # Пример вызова create_async
    async def example():
        model = "gpt-3.5-turbo"
        messages = [{"role": "user", "content": "Hello"}]
        result = await AbstractProvider.create_async(model=model, messages=messages, timeout=10)
        print(result)

    asyncio.run(example())
```

### `get_parameters`

```python
    @classmethod
    def get_parameters(cls, as_json: bool = False) -> dict[str, Parameter]:
        """
        Возвращает параметры, поддерживаемые провайдером.

        Args:
            cls (type): Класс, в котором вызывается этот метод.
            as_json (bool): Если `True`, возвращает параметры в формате JSON.

        Returns:
            dict[str, Parameter]: Словарь параметров, поддерживаемых провайдером.
        """
```

**Назначение**: Возвращает параметры, поддерживаемые провайдером, в виде словаря.

**Параметры**:
- `cls` (type): Класс, в котором вызывается этот метод.
- `as_json` (bool, optional): Если `True`, возвращает параметры в формате JSON. По умолчанию `False`.

**Возвращает**:
- `dict[str, Parameter]`: Словарь параметров, поддерживаемых провайдером.

**Внутренние функции**:
- `get_type_as_var(annotation: type, key: str, default)`: Возвращает пример значения переменной на основе аннотации типа.

**Как работает функция**:

1.  **Получение параметров из сигнатуры**: Извлекает параметры из сигнатуры метода `create_async_generator` (если провайдер поддерживает асинхронные генераторы), `create_async` (если провайдер поддерживает асинхронный режим) или `create_completion`.
2.  **Фильтрация параметров**: Фильтрует параметры, оставляя только те, которые указаны в `SAFE_PARAMETERS` и, если `stream=True`, поддерживает потоковую передачу.
3.  **Форматирование JSON (опционально)**: Если `as_json=True`, преобразует параметры в формат JSON, используя примеры значений или значения по умолчанию.
4.  **Возврат параметров**: Возвращает словарь параметров.

**ASCII flowchart**:

```
    Начало
    │
    │ Получение параметров из сигнатуры
    │
    │ Фильтрация параметров (SAFE_PARAMETERS, stream)
    │
    │ as_json = True?
    ├── Да → Преобразование в формат JSON
    │   │
    │   └──get_type_as_var(annotation: type, key: str, default)
    │       │Возвращает пример значения переменной на основе аннотации типа
    └── Нет
    │
    │ Возврат параметров
    │
    Конец
```

**Примеры**:

```python
    # Пример вызова get_parameters
    parameters = AbstractProvider.get_parameters()
    print(parameters)

    parameters_json = AbstractProvider.get_parameters(as_json=True)
    print(parameters_json)
```

### `raise_error`

```python
    @staticmethod
    def raise_error(data: dict, status: int = None):
        """
        Вызывает исключение на основе данных об ошибке.

        Args:
            data (dict): Данные об ошибке.
            status (int, optional): HTTP-статус код. По умолчанию `None`.

        Raises:
            ResponseError: Если обнаружена общая ошибка.
            MissingAuthError: Если отсутствует аутентификация (статус 401).
            PaymentRequiredError: Если требуется оплата (статус 402).
        """
```

**Назначение**: Анализирует данные об ошибке и вызывает соответствующее исключение.

**Параметры**:
- `data` (dict): Данные об ошибке.
- `status` (int, optional): HTTP-статус код. По умолчанию `None`.

**Как работает функция**:

1.  **Проверка наличия ключей ошибки**: Проверяет наличие ключей `"error_message"` или `"error"` в данных.
2.  **Обработка различных форматов ошибок**: Обрабатывает различные форматы ошибок, включая строковые, логические и структурированные ошибки с кодами и сообщениями.
3.  **Вызов исключения**: Вызывает исключение `ResponseError` с соответствующим сообщением об ошибке. Если статус код равен 401, вызывается `MissingAuthError`, если 402 - `PaymentRequiredError`.

**ASCII flowchart**:

```
    Начало
    │
    │ Проверка наличия ключей ошибки (error_message, error)
    │
    │ Обработка различных форматов ошибок
    │
    │ Вызов исключения (ResponseError, MissingAuthError, PaymentRequiredError)
    │
    Конец
```

**Примеры**:

```python
    # Пример вызова raise_error
    data = {"error_message": "Some error occurred"}
    try:
        RaiseErrorMixin.raise_error(data)
    except ResponseError as ex:
        print(f"Caught error: {ex}")
```

### `on_auth_async`

```python
    @classmethod
    async def on_auth_async(cls, **kwargs) -> AuthResult:
       """
       Асинхронно выполняет аутентификацию.

       Args:
           **kwargs: Дополнительные именованные аргументы.

       Returns:
           AuthResult: Результат аутентификации.

       Raises:
           MissingAuthError: Если отсутствует API ключ.
       """
```

**Назначение**: Асинхронно выполняет аутентификацию.

**Параметры**:
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `AuthResult`: Результат аутентификации.

**Как работает функция**:

1.  **Проверка наличия API ключа**: Проверяет, передан ли API ключ в аргументах.
2.  **Вызов исключения**: Если API ключ не передан, вызывает исключение `MissingAuthError`.
3.  **Возврат результата**: Если API ключ передан, возвращает объект `AuthResult`.

**ASCII flowchart**:

```
    Начало
    │
    │ Проверка наличия API ключа
    │
    │ API ключ отсутствует?
    ├── Да → Вызов исключения MissingAuthError
    └── Нет → Возврат AuthResult
    │
    Конец
```

**Примеры**:

```python
    # Пример вызова on_auth_async
    async def example():
        try:
            result = await AsyncAuthedProvider.on_auth_async(api_key="123")
            print(result)
        except MissingAuthError as ex:
            print(f"Caught error: {ex}")

    asyncio.run(example())
```