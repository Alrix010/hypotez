# Модуль `helper`

## Обзор

Модуль `helper` содержит набор вспомогательных функций, используемых в проекте `hypotez`. Эти функции включают в себя преобразование данных в строку, форматирование промптов для моделей, генерацию случайных строк и другие утилиты.

## Подробней

Модуль предоставляет различные функции для работы со строками, сообщениями и другими типами данных. Он используется для подготовки данных перед отправкой в модели машинного обучения и для обработки результатов, полученных от этих моделей. Расположение модуля указывает на его роль в качестве вспомогательного инструмента для других модулей проекта.

## Функции

### `to_string`

```python
def to_string(value) -> str:
    """ Функция преобразует входное значение в строку.

    Args:
        value: Значение любого типа.

    Returns:
        str: Строковое представление входного значения.
             Возвращает пустую строку, если `value` является словарем и содержит ключ "name",
             или если `value` является словарем с ключом "bucket_id", в этом случае возвращает содержимое bucket_dir.
             Возвращает значение ключа "text", если `value` является словарем с ключом "type" == "text".
             Для списков возвращает объединенную строку элементов списка.
             В противном случае, возвращает строковое представление `value`.
    """
```
**Как работает функция**:
- Функция `to_string` принимает значение любого типа и преобразует его в строку.
- Если значение является строкой, она возвращается без изменений.
- Если значение является словарем, функция проверяет наличие ключей "name", "bucket_id" или "type". В зависимости от наличия этих ключей, она выполняет разные действия:
  - Если есть ключ "name", возвращается пустая строка.
  - Если есть ключ "bucket_id", считывается содержимое файла bucket_dir и возвращается в виде строки.
  - Если есть ключ "type" со значением "text", возвращается значение ключа "text".
- Если значение является списком, функция рекурсивно вызывает `to_string` для каждого элемента списка и объединяет результаты в одну строку.
- В противном случае, функция возвращает строковое представление входного значения.

**Примеры**:

```python
to_string("hello") # возвращает "hello"
to_string({"name": "test"}) # возвращает ""
to_string({"bucket_id": "123"}) # возвращает содержимое файла bucket_dir
to_string({"type": "text", "text": "world"}) # возвращает "world"
to_string([{"type": "text", "text": "one"}, {"type": "text", "text": "two"}]) # возвращает "onetwo"
```

### `format_prompt`

```python
def format_prompt(messages: Messages, add_special_tokens: bool = False, do_continue: bool = False, include_system: bool = True) -> str:
    """ Функция форматирует список сообщений в строку.

    Args:
        messages (Messages): Список словарей сообщений, каждый из которых содержит 'role' и 'content'.
        add_special_tokens (bool): Флаг, указывающий, следует ли добавлять специальные токены форматирования. По умолчанию `False`.
        do_continue (bool):  Если `True`, возвращает форматированную строку без добавления "Assistant:". По умолчанию `False`.
        include_system (bool): Флаг, указывающий, следует ли включать сообщения с role "system". По умолчанию `True`.

    Returns:
        str: Отформатированная строка, содержащая все сообщения.
    """
```
**Как работает функция**:

- Функция `format_prompt` принимает список сообщений и форматирует их в единую строку.
- Если `add_special_tokens` равно `False` и длина списка сообщений меньше или равна 1, функция возвращает строковое представление содержимого первого сообщения.
- Функция фильтрует сообщения на основе значения `include_system`, чтобы исключить системные сообщения, если это необходимо.
- Затем функция объединяет сообщения в строку, добавляя роль каждого сообщения перед его содержимым.
- В конце добавляется "Assistant:", если `do_continue` не равно `True`.

**Примеры**:

```python
messages = [{"role": "user", "content": "hello"}, {"role": "assistant", "content": "world"}]
format_prompt(messages) # возвращает "User: hello\nAssistant: world\nAssistant:"
format_prompt(messages, add_special_tokens=True) # возвращает "User: hello\nAssistant: world\nAssistant:"
format_prompt(messages, do_continue=True) # возвращает "User: hello\nAssistant: world"
format_prompt(messages, include_system=False) # возвращает "User: hello\nAssistant: world\nAssistant:"
```

### `get_system_prompt`

```python
def get_system_prompt(messages: Messages) -> str:
    """ Функция извлекает системные сообщения из списка сообщений и объединяет их в строку.

    Args:
        messages (Messages): Список словарей сообщений, каждый из которых содержит 'role' и 'content'.

    Returns:
        str: Строка, содержащая все системные сообщения, объединенные символом новой строки.
    """
```
**Как работает функция**:

- Функция `get_system_prompt` принимает список сообщений и извлекает из него все сообщения с ролью "system".
- Затем функция объединяет содержимое этих сообщений в одну строку, разделяя их символами новой строки.

**Примеры**:

```python
messages = [{"role": "system", "content": "initial message"}, {"role": "user", "content": "hello"}]
get_system_prompt(messages) # возвращает "initial message"
```

### `get_last_user_message`

```python
def get_last_user_message(messages: Messages) -> str:
    """ Функция получает последние сообщения пользователя из списка сообщений.

    Args:
        messages (Messages): Список словарей сообщений, каждый из которых содержит 'role' и 'content'.

    Returns:
        str: Строка, содержащая все последние сообщения от пользователя, объединенные символами новой строки.
    """
```
**Как работает функция**:

- Функция `get_last_user_message` принимает список сообщений и извлекает из него все последние сообщения с ролью "user".
- Функция проходит по списку сообщений в обратном порядке и добавляет содержимое каждого сообщения пользователя в список `user_messages`.
- Если встречается сообщение не от пользователя, функция возвращает объединенные сообщения пользователя.

**Примеры**:

```python
messages = [{"role": "user", "content": "hello"}, {"role": "assistant", "content": "world"}, {"role": "user", "content": "test"}]
get_last_user_message(messages) # возвращает "test"
messages = [{"role": "user", "content": "hello"}, {"role": "user", "content": "world"}]
get_last_user_message(messages) # возвращает "hello\nworld"
```

### `format_image_prompt`

```python
def format_image_prompt(messages, prompt: str = None) -> str:
    """ Функция форматирует промпт для генерации изображений.

    Args:
        messages: Список сообщений.
        prompt (str, optional): Промпт. Если `None`, используется последнее сообщение пользователя. По умолчанию `None`.

    Returns:
        str: Отформатированный промпт.
    """
```
**Как работает функция**:

- Функция `format_image_prompt` принимает список сообщений и опциональный промпт.
- Если промпт не указан, функция использует последнее сообщение пользователя из списка сообщений.
- Функция возвращает промпт.

**Примеры**:

```python
messages = [{"role": "user", "content": "cat"}]
format_image_prompt(messages) # возвращает "cat"
format_image_prompt(messages, prompt="dog") # возвращает "dog"
```

### `format_prompt_max_length`

```python
def format_prompt_max_length(messages: Messages, max_lenght: int) -> str:
    """ Функция форматирует промпт, обрезая его до максимальной длины.

    Args:
        messages (Messages): Список сообщений.
        max_lenght (int): Максимальная длина промпта.

    Returns:
        str: Отформатированный и обрезанный промпт.
    """
```
**Как работает функция**:

- Функция `format_prompt_max_length` принимает список сообщений и максимальную длину промпта.
- Функция форматирует промпт с использованием функции `format_prompt`.
- Если длина промпта превышает максимальную длину, функция пытается обрезать промпт, используя только последние несколько сообщений.
- Если и это не помогает, функция использует только последнее сообщение пользователя.
- Функция логирует информацию об обрезке промпта с помощью `debug.log`.

**Примеры**:

```python
messages = [{"role": "user", "content": "hello"}, {"role": "assistant", "content": "world"}]
format_prompt_max_length(messages, 5) # возвращает "world" (если обрезано)
```

### `get_random_string`

```python
def get_random_string(length: int = 10) -> str:
    """ Функция генерирует случайную строку указанной длины, состоящую из строчных букв и цифр.

    Args:
        length (int, optional): Длина случайной строки. По умолчанию 10.

    Returns:
        str: Случайная строка указанной длины.
    """
```
**Как работает функция**:

- Функция `get_random_string` генерирует случайную строку указанной длины, используя строчные буквы и цифры.

**Примеры**:

```python
get_random_string() # возвращает случайную строку длиной 10
get_random_string(5) # возвращает случайную строку длиной 5
```

### `get_random_hex`

```python
def get_random_hex(length: int = 32) -> str:
    """ Функция генерирует случайную шестнадцатеричную строку заданной длины.

    Returns:
        str: Случайная шестнадцатеричная строка из n символов.
    """
```
**Как работает функция**:

- Функция `get_random_hex` генерирует случайную шестнадцатеричную строку указанной длины.

**Примеры**:

```python
get_random_hex() # возвращает случайную шестнадцатеричную строку длиной 32
get_random_hex(16) # возвращает случайную шестнадцатеричную строку длиной 16
```

### `filter_none`

```python
def filter_none(**kwargs) -> dict:
    """ Функция фильтрует словарь, удаляя элементы со значением `None`.

    Args:
        **kwargs: Произвольные ключевые аргументы.

    Returns:
        dict: Новый словарь, содержащий только элементы, значения которых не равны `None`.
    """
```
**Как работает функция**:

- Функция `filter_none` принимает произвольные ключевые аргументы и создает новый словарь, содержащий только элементы, значения которых не равны `None`.

**Примеры**:

```python
filter_none(a=1, b=None, c=2) # возвращает {"a": 1, "c": 2}
```

### `async_concat_chunks`

```python
async def async_concat_chunks(chunks: AsyncIterator) -> str:
    """ Функция асинхронно объединяет чанки в строку.

    Args:
        chunks (AsyncIterator): Асинхронный итератор чанков.

    Returns:
        str: Объединенная строка из чанков.
    """
```
**Как работает функция**:

- Функция `async_concat_chunks` асинхронно объединяет чанки из асинхронного итератора в строку.
- Она использует `async for` для итерации по чанкам и объединяет их в одну строку.
- Функция вызывает `concat_chunks` для объединения чанков.

### `concat_chunks`

```python
def concat_chunks(chunks: Iterator) -> str:
    """ Функция объединяет чанки в строку.

    Args:
        chunks (Iterator): Итератор чанков.

    Returns:
        str: Объединенная строка из чанков.
    """
```
**Как работает функция**:

- Функция `concat_chunks` объединяет чанки из итератора в строку.
- Функция итерируется по чанкам и объединяет их в одну строку, пропуская чанки, являющиеся `None` или экземплярами `Exception`.

**Примеры**:

```python
concat_chunks(["hello", "world"]) # возвращает "helloworld"
concat_chunks(["hello", None, "world"]) # возвращает "helloworld"
```

### `format_cookies`

```python
def format_cookies(cookies: Cookies) -> str:
    """ Функция форматирует куки в строку для HTTP-запроса.

    Args:
        cookies (Cookies): Словарь куки.

    Returns:
        str: Строка, представляющая куки в формате "key=value; key=value".
    """
```
**Как работает функция**:

- Функция `format_cookies` форматирует словарь куки в строку, пригодную для использования в HTTP-запросах.
- Функция итерируется по словарю куки и объединяет их в строку в формате "key=value; key=value".

**Примеры**:

```python
cookies = {"name": "test", "value": "123"}
format_cookies(cookies) # возвращает "name=test; value=123"