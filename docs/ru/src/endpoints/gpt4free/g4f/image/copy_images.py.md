# Модуль для копирования изображений

## Обзор

Модуль `copy_images.py` предназначен для загрузки и локального сохранения изображений, полученных из различных источников, с обеспечением Unicode-безопасных имен файлов. Он предоставляет функциональность для обработки как URL-адресов изображений, так и data URI, а также проверяет допустимость типов медиафайлов.

## Подробнее

Этот модуль является важной частью проекта `hypotez`, поскольку обеспечивает возможность сохранения сгенерированных изображений локально, что необходимо для дальнейшей обработки или отображения. Он включает в себя функции для создания директории для изображений, извлечения расширений файлов, формирования безопасных имен файлов и обработки различных типов медиаданных.

## Функции

### `get_media_extension`

```python
def get_media_extension(media: str) -> str:
    """Извлекает расширение медиафайла из URL или имени файла.

    Args:
        media (str): URL или имя файла медиа.

    Returns:
        str: Расширение файла (например, ".jpg", ".png").

    Raises:
        ValueError: Если расширение не поддерживается.
    """
    ...
```

**Назначение**: Извлечение расширения медиафайла из предоставленного URL или имени файла.

**Параметры**:
- `media` (str): URL или имя файла, из которого нужно извлечь расширение.

**Возвращает**:
- `str`: Расширение файла, например ".jpg" или ".png".

**Вызывает исключения**:
- `ValueError`: Если расширение файла не поддерживается.

**Как работает функция**:
1.  Функция принимает строку `media`, которая может быть URL-адресом или именем файла.
2.  Парсится URL для извлечения пути.
3.  Извлекается расширение файла из пути или самой строки `media`.
4.  Если расширение не найдено, возвращается пустая строка.
5.  Проверяется, поддерживается ли расширение. Если нет, вызывается исключение `ValueError`.

**Примеры**:

```python
>>> get_media_extension("http://example.com/image.jpg")
'.jpg'
>>> get_media_extension("image.png")
'.png'
```

### `ensure_images_dir`

```python
def ensure_images_dir():
    """Создает директорию для изображений, если она не существует."""
    ...
```

**Назначение**: Создание директории `images_dir`, если она еще не существует.

**Как работает функция**:
1.  Функция пытается создать директорию `images_dir`, используя `os.makedirs` с параметром `exist_ok=True`, что позволяет избежать ошибок, если директория уже существует.

**Примеры**:
```python
>>> ensure_images_dir()
```

### `get_source_url`

```python
def get_source_url(image: str, default: str = None) -> str:
    """Извлекает исходный URL из параметра image, если он присутствует.

    Args:
        image (str): Строка, содержащая URL изображения.
        default (str, optional): Значение по умолчанию, если URL не найден. По умолчанию None.

    Returns:
        str: Исходный URL или значение по умолчанию.
    """
    ...
```

**Назначение**: Извлечение исходного URL из параметра `image`, если он присутствует в формате `url=...`.

**Параметры**:
- `image` (str): Строка, содержащая URL изображения.
- `default` (str, optional): Значение по умолчанию, если URL не найден. По умолчанию `None`.

**Возвращает**:
- `str`: Исходный URL или значение по умолчанию.

**Как работает функция**:
1.  Проверяется, содержит ли строка `image` параметр `url=`.
2.  Если параметр присутствует, извлекается и декодируется URL.
3.  Проверяется, начинается ли декодированный URL с `http://` или `https://`.
4.  Если все условия соблюдены, возвращается декодированный URL, иначе возвращается значение по умолчанию.

**Примеры**:

```python
>>> get_source_url("image.jpg?url=http://example.com/image.jpg")
'http://example.com/image.jpg'
>>> get_source_url("image.jpg", "default_url")
'default_url'
```

### `is_valid_media_type`

```python
def is_valid_media_type(content_type: str) -> bool:
    """Проверяет, является ли content_type допустимым типом медиа.

    Args:
        content_type (str): Тип контента для проверки.

    Returns:
        bool: True, если тип контента допустим, иначе False.
    """
    ...
```

**Назначение**: Проверка, является ли `content_type` допустимым типом медиа.

**Параметры**:
- `content_type` (str): Тип контента для проверки.

**Возвращает**:
- `bool`: `True`, если тип контента допустим, иначе `False`.

**Как работает функция**:
1.  Проверяется, содержится ли `content_type` в `MEDIA_TYPE_MAP` или начинается ли с `audio/` или `video/`.
2.  Возвращается `True`, если хотя бы одно из условий выполняется, иначе `False`.

**Примеры**:

```python
>>> is_valid_media_type("image/jpeg")
True
>>> is_valid_media_type("audio/mpeg")
True
>>> is_valid_media_type("text/html")
False
```

### `save_response_media`

```python
async def save_response_media(response: StreamResponse, prompt: str, tags: list[str]) -> AsyncIterator:
    """Сохраняет медиа из ответа в локальный файл и возвращает URL.

    Args:
        response (StreamResponse): Объект ответа с медиаданными.
        prompt (str): Описание изображения.
        tags (list[str]): Список тегов для файла.

    Yields:
        AsyncIterator: Объект ответа ImageResponse, AudioResponse или VideoResponse.
    """
    ...
```

**Назначение**: Сохранение медиаданных из ответа в локальный файл и возвращение URL.

**Параметры**:
- `response` (StreamResponse): Объект ответа с медиаданными.
- `prompt` (str): Описание изображения.
- `tags` (list[str]): Список тегов для файла.

**Возвращает**:
- `AsyncIterator`: Объект ответа `ImageResponse`, `AudioResponse` или `VideoResponse`.

**Как работает функция**:
1.  Извлекается `content_type` из заголовков ответа.
2.  Проверяется, является ли `content_type` допустимым типом медиа.
3.  Определяется расширение файла на основе `content_type`.
4.  Формируется имя файла с использованием тегов, описания и расширения.
5.  Определяется целевой путь для сохранения файла.
6.  Медиаданные записываются в файл чанками.
7.  Формируется URL медиафайла.
8.  Возвращается объект ответа в зависимости от типа медиа (`ImageResponse`, `AudioResponse` или `VideoResponse`).

**Примеры**:
```python
# Пример использования функции:
# response = await session.get("http://example.com/image.jpg")
# async for media_response in save_response_media(response, "example", ["test"]):
#     print(media_response.media_url)
```

### `get_filename`

```python
def get_filename(tags: list[str], alt: str, extension: str, image: str) -> str:
    """Формирует имя файла на основе тегов, альтернативного текста, расширения и хеша изображения.

    Args:
        tags (list[str]): Список тегов.
        alt (str): Альтернативный текст.
        extension (str): Расширение файла.
        image (str): Изображение (используется для хеширования).

    Returns:
        str: Сформированное имя файла.
    """
    ...
```

**Назначение**: Формирование имени файла на основе тегов, альтернативного текста, расширения и хеша изображения.

**Параметры**:
- `tags` (list[str]): Список тегов.
- `alt` (str): Альтернативный текст.
- `extension` (str): Расширение файла.
- `image` (str): Изображение (используется для хеширования).

**Возвращает**:
- `str`: Сформированное имя файла.

**Как работает функция**:
1.  Формируется имя файла, включающее текущее время, теги (если есть), альтернативный текст, хеш изображения и расширение файла.
2.  Используется `secure_filename` для обеспечения безопасности имени файла.

**Примеры**:

```python
>>> get_filename(["tag1", "tag2"], "alt_text", ".jpg", "image_data")
'1678886400_tag1+tag2+alt_text_1a2b3c4d5e6f7a8b.jpg'
```

### `copy_media`

```python
async def copy_media(
    images: list[str],\
    cookies: Optional[Cookies] = None,\
    headers: Optional[dict] = None,\
    proxy: Optional[str] = None,\
    alt: str = None,\
    tags: list[str] = None,\
    add_url: bool = True,\
    target: str = None,\
    ssl: bool = None\
) -> list[str]:
    """Загружает и сохраняет изображения локально с Unicode-безопасными именами файлов.
    Возвращает список относительных URL-адресов изображений.

    Args:
        images (list[str]): Список URL-адресов изображений для загрузки.
        cookies (Optional[Cookies], optional): Cookies для использования при запросе. По умолчанию None.
        headers (Optional[dict], optional): Заголовки для использования при запросе. По умолчанию None.
        proxy (Optional[str], optional): Прокси-сервер для использования при запросе. По умолчанию None.
        alt (str, optional): Альтернативный текст для использования в имени файла. По умолчанию None.
        tags (list[str], optional): Список тегов для использования в имени файла. По умолчанию None.
        add_url (bool, optional): Добавлять ли исходный URL в URL локального файла. По умолчанию True.
        target (str, optional): Целевой путь для сохранения изображения. По умолчанию None.
        ssl (bool, optional): Проверять ли SSL-сертификат. По умолчанию None.

    Returns:
        list[str]: Список относительных URL-адресов изображений.
    """
    ...
```

**Назначение**: Загрузка и локальное сохранение изображений с Unicode-безопасными именами файлов.

**Параметры**:
- `images` (list[str]): Список URL-адресов изображений для загрузки.
- `cookies` (Optional[Cookies], optional): Cookies для использования при запросе. По умолчанию `None`.
- `headers` (Optional[dict], optional): Заголовки для использования при запросе. По умолчанию `None`.
- `proxy` (Optional[str], optional): Прокси-сервер для использования при запросе. По умолчанию `None`.
- `alt` (str, optional): Альтернативный текст для использования в имени файла. По умолчанию `None`.
- `tags` (list[str], optional): Список тегов для использования в имени файла. По умолчанию `None`.
- `add_url` (bool, optional): Добавлять ли исходный URL в URL локального файла. По умолчанию `True`.
- `target` (str, optional): Целевой путь для сохранения изображения. По умолчанию `None`.
- `ssl` (bool, optional): Проверять ли SSL-сертификат. По умолчанию `None`.

**Возвращает**:
- `list[str]`: Список относительных URL-адресов изображений.

**Внутренние функции**:

### `copy_image`

```python
async def copy_image(image: str, target: str = None) -> str:
    """Обрабатывает отдельное изображение и возвращает его локальный URL.

    Args:
        image (str): URL изображения для копирования.
        target (str, optional): Целевой путь для сохранения изображения. По умолчанию None.

    Returns:
        str: Локальный URL изображения.
    """
    ...
```

**Назначение**: Обработка отдельного изображения и возвращение его локального URL.

**Параметры**:
- `image` (str): URL изображения для копирования.
- `target` (str, optional): Целевой путь для сохранения изображения. По умолчанию `None`.

**Возвращает**:
- `str`: Локальный URL изображения.

**Как работает функция**:
1.  Проверяется, является ли изображение уже локальным. Если да, возвращается без изменений.
2.  Формируется имя файла с использованием `get_filename`.
3.  Определяется целевой путь для сохранения изображения.
4.  Обрабатываются различные типы изображений:
    - Если изображение является data URI, оно извлекается и сохраняется.
    - Если изображение является URL, оно загружается с использованием `aiohttp`.
5.  Проверяется формат файла и, при необходимости, изменяется расширение.
6.  Формируется URL с безопасным кодированием.

**Как работает функция `copy_media`**:
1.  Инициализируется сессия `aiohttp` с заданными параметрами (proxy, cookies, headers).
2.  Определяется, нужно ли добавлять URL к имени файла.
3.  Для каждого URL изображения вызывается функция `copy_image`.
4.  Результаты собираются и возвращаются в виде списка URL-адресов.

```
Копирование медиафайлов
│
├─── Получение URL-адресов изображений
│   │
│   └─── Для каждого URL:
│       │
│       ├─── Проверка, является ли изображение локальным?
│       │   │
│       │   └─── Если да: возврат URL
│       │
│       ├─── Формирование имени файла (get_filename)
│       │   │
│       │   └─── Определение целевого пути
│       │
│       ├─── Проверка типа изображения (data URI или URL)
│       │   │
│       │   ├─── Если data URI: извлечение и сохранение
│       │   │
│       │   └─── Если URL:
│       │       │
│       │       ├─── Загрузка с использованием aiohttp
│       │       │
│       │       └─── Проверка content-type
│       │
│       ├─── Проверка формата файла и изменение расширения (если необходимо)
│       │
│       └─── Формирование и возврат URL
│
└─── Возврат списка URL-адресов
```

**Примеры**:

```python
#Пример
#images = ["http://example.com/image1.jpg", "http://example.com/image2.png"]
#result = await copy_media(images, tags=["test"], alt="example")
#print(result)