# Модуль media

## Обзор

Модуль `media` предоставляет функции для обработки медиа-контента, включая рендеринг изображений и аудио, а также объединение медиафайлов с сообщениями. Он используется для подготовки данных мультимедиа к отправке или отображению.

## Подробней

Модуль содержит функции для рендеринга медиа-файлов (изображений и аудио), объединения их с текстовыми сообщениями и подготовки сообщений для отображения. Он также включает функции для определения типа медиа-данных и преобразования их в нужный формат. Этот модуль, вероятно, используется для обработки мультимедийного контента перед отправкой в системы, требующие определенного формата данных.

## Функции

### `render_media`

```python
def render_media(bucket_id: str, name: str, url: str, as_path: bool = False, as_base64: bool = False) -> Union[str, Path]:
    """
    Рендерит медиа-файл, возвращая URL, путь к файлу или base64-представление данных.

    Args:
        bucket_id (str): Идентификатор бакета, где хранится медиа-файл.
        name (str): Имя файла.
        url (str): URL медиа-файла.
        as_path (bool): Если `True`, возвращает путь к файлу. По умолчанию `False`.
        as_base64 (bool): Если `True`, возвращает base64-представление данных. По умолчанию `False`.

    Returns:
        Union[str, Path]: URL, путь к файлу или base64-представление медиа-файла.

    Как работает функция:
    1. Проверяет, требуется ли вернуть путь к файлу или base64-представление, или если URL начинается с "/".
    2. Если требуется путь или base64, формирует путь к файлу на основе `bucket_id`, "media" и имени файла.
    3. Если запрошен путь (`as_path`), возвращает путь к файлу.
    4. Читает содержимое файла как байты.
    5. Кодирует байты в base64.
    6. Если запрошено base64-представление (`as_base64`), возвращает его.
    7. Формирует data URI на основе типа медиа и base64-представления.
    8. Если ни одно из условий не выполнено, возвращает исходный URL.
    """
```

**ASCII Flowchart**:

```
A: Проверка as_base64 или as_path или URL начинается с "/"
|
-- B: Формирование пути к файлу
|
C: Проверка as_path
|
-- D: Возврат пути к файлу
|
E: Чтение содержимого файла как байты
|
F: Кодирование байтов в base64
|
G: Проверка as_base64
|
-- H: Возврат base64-представления
|
I: Формирование data URI
|
J: Возврат URL
```

**Примеры**:

```python
render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png')
render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png', as_path=True)
render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png', as_base64=True)
```

### `render_part`

```python
def render_part(part: dict) -> dict:
    """
    Рендерит часть сообщения, преобразуя информацию о медиа-файле в формат, подходящий для отправки.

    Args:
        part (dict): Словарь, содержащий информацию о части сообщения.

    Returns:
        dict: Словарь с информацией о рендеренной части сообщения.

    Как работает функция:
    1. Проверяет наличие ключа "type" в `part`. Если есть, возвращает `part` без изменений.
    2. Если "type" отсутствует, извлекает имя файла из `part`.
    3. Если имя файла отсутствует, формирует путь к бакету и читает содержимое бакета, возвращая текстовое сообщение.
    4. Если файл является аудио, рендерит его в формат `input_audio`.
    5. Если файл не является аудио, рендерит его как URL изображения.
    """
```

**ASCII Flowchart**:

```
A: Проверка наличия "type" в part
|
-- B: Возврат part без изменений
|
C: Извлечение имени файла из part
|
D: Проверка наличия имени файла
|
-- E: Формирование пути к бакету и чтение содержимого
|
F: Проверка, является ли файл аудио
|
-- G: Рендеринг аудио в формат input_audio
|
H: Рендеринг изображения как URL
```

**Примеры**:

```python
render_part({'type': 'text', 'text': 'Hello'})
render_part({'bucket_id': 'test_bucket'})
render_part({'bucket_id': 'test_bucket', 'name': 'audio.mp3'})
render_part({'bucket_id': 'test_bucket', 'name': 'image.png'})
```

### `merge_media`

```python
def merge_media(media: list, messages: list) -> Iterator:
    """
    Объединяет медиафайлы с сообщениями пользователей.

    Args:
        media (list): Список медиафайлов.
        messages (list): Список сообщений.

    Yields:
        Iterator: Итератор, возвращающий пути к медиафайлам и их имена.

    Как работает функция:
    1. Инициализирует буфер для хранения путей к медиафайлам.
    2. Итерируется по сообщениям.
    3. Если роль сообщения "user", извлекает контент и итерируется по частям контента.
    4. Если часть контента содержит имя файла, рендерит путь к медиафайлу и добавляет его в буфер.
    5. Если часть контента имеет тип "image_url", добавляет URL изображения в буфер.
    6. После обработки сообщений, возвращает пути к медиафайлам из буфера, затем из списка `media`.
    """
```

**ASCII Flowchart**:

```
A: Инициализация буфера
|
B: Итерация по сообщениям
|
C: Проверка роли сообщения ("user")
|
-- D: Извлечение контента и итерация по частям
|
E: Проверка наличия имени файла в части контента
|
-- F: Рендеринг пути к медиафайлу и добавление в буфер
|
G: Проверка типа части контента ("image_url")
|
-- H: Добавление URL изображения в буфер
|
I: Возврат путей к медиафайлам из буфера и списка media
```

**Примеры**:

```python
messages = [{'role': 'user', 'content': [{'name': 'image.png', 'bucket_id': 'test_bucket'}]}]
media = ['/path/to/audio.mp3']
for item in merge_media(media, messages):
    print(item)
```

### `render_messages`

```python
def render_messages(messages: Messages, media: list = None) -> Iterator:
    """
    Рендерит сообщения, подготавливая их к отображению, включая преобразование медиафайлов в нужный формат.

    Args:
        messages (Messages): Список сообщений.
        media (list, optional): Список медиафайлов, связанных с сообщениями. По умолчанию `None`.

    Yields:
        Iterator: Итератор, возвращающий рендеренные сообщения.

    Как работает функция:
    1. Итерируется по сообщениям.
    2. Если контент сообщения - список, рендерит каждую часть контента с помощью `render_part`.
    3. Если есть медиафайлы и это последнее сообщение, добавляет медиафайлы в контент сообщения, преобразуя их в формат `input_audio` или `image_url`.
    4. Возвращает рендеренное сообщение.
    """
```

**ASCII Flowchart**:

```
A: Итерация по сообщениям
|
B: Проверка, является ли контент сообщения списком
|
-- C: Рендеринг каждой части контента с помощью render_part
|
D: Проверка наличия медиафайлов и является ли сообщение последним
|
-- E: Добавление медиафайлов в контент сообщения
|
F: Возврат рендеренного сообщения
```

**Примеры**:

```python
messages = [{'role': 'user', 'content': [{'name': 'image.png', 'bucket_id': 'test_bucket'}]}]
media = [('/path/to/audio.mp3', 'audio.mp3')]
for message in render_messages(messages, media):
    print(message)