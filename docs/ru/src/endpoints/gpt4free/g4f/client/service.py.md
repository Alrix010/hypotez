# Модуль service.py

## Обзор

Модуль `service.py` предназначен для получения и управления моделями и провайдерами в контексте библиотеки `gpt4free`. Он предоставляет функции для преобразования, получения и проверки доступности провайдеров и моделей, а также обрабатывает различные исключения, связанные с их использованием.

## Подробнее

Модуль содержит функции для преобразования строк в объекты-провайдеры, получения конкретных моделей и провайдеров, проверки их работоспособности и поддержки потоковой передачи. Он также обрабатывает логирование и проверку версий.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """
    Преобразует строку с именем провайдера в объект провайдера.

    Args:
        provider (str): Строка с именем провайдера или списком провайдеров, разделенных пробелами.

    Returns:
        ProviderType: Объект провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
    """
    ...
```

**Как работает функция**:

1.  **Проверка на наличие пробелов**: Функция проверяет, содержит ли строка `provider` пробелы. Если да, это означает, что передается список провайдеров.
2.  **Обработка списка провайдеров**: Если в строке есть пробелы, она разбивается на список имен провайдеров. Затем функция пытается преобразовать каждое имя в соответствующий объект провайдера, используя `ProviderUtils.convert`. Если какой-либо из провайдеров не найден, вызывается исключение `ProviderNotFoundError`.
3.  **Создание IterListProvider**: Если список провайдеров успешно преобразован, создается объект `IterListProvider`, который позволяет перебирать список провайдеров.
4.  **Обработка одиночного провайдера**: Если в строке `provider` нет пробелов, функция пытается найти соответствующий объект провайдера в `ProviderUtils.convert`. Если провайдер не найден, вызывается исключение `ProviderNotFoundError`.
5.  **Возврат провайдера**: Функция возвращает объект провайдера или объект `IterListProvider`, если был передан список провайдеров.

```ascii
Проверка наличия пробелов в имени провайдера -> Разбить строку на список провайдеров -> Преобразование каждого имени в объект провайдера ->  Создание IterListProvider -> Возврат IterListProvider

                                                                                                    OR

Проверка наличия пробелов в имени провайдера -> Поиск объекта провайдера в ProviderUtils.convert -> Возврат объекта провайдера
```

**Примеры**:

```python
# Пример 1: Преобразование существующего провайдера
provider = convert_to_provider("SyncProvider")

# Пример 2: Преобразование списка провайдеров
providers = convert_to_provider("AsyncProvider SyncProvider")

# Пример 3: Обработка несуществующего провайдера (вызовет исключение)
try:
    provider = convert_to_provider("NonExistentProvider")
except ProviderNotFoundError as ex:
    print(f"Ошибка: {ex}")
```

### `get_model_and_provider`

```python
def get_model_and_provider(model: Union[Model, str],
                           provider: Union[ProviderType, str, None],
                           stream: bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """
    Получает модель и провайдера на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования, либо как объект, либо как строковый идентификатор.
        provider (Union[ProviderType, str, None]): Провайдер для использования, либо как объект, строковый идентификатор, либо None.
        stream (bool): Указывает, следует ли выполнять операцию как поток.
        ignore_working (bool, optional): Если True, игнорирует рабочий статус провайдера. По умолчанию False.
        ignore_stream (bool, optional): Если True, игнорирует возможность потоковой передачи провайдера. По умолчанию False.
        logging (bool, optional): Если True, включает логирование. По умолчанию True.
        has_images (bool, optional): Указывает, есть ли изображения. По умолчанию False.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если провайдер не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается провайдером.
    """
    ...
```

**Как работает функция**:

1.  **Проверка версии**: Если `debug.version_check` истинно, выполняется проверка версии.
2.  **Преобразование провайдера**: Если `provider` является строкой, она преобразуется в объект провайдера с помощью функции `convert_to_provider`.
3.  **Преобразование модели**: Если `model` является строкой, она преобразуется в объект модели из `ModelUtils.convert`.
4.  **Определение провайдера и модели по умолчанию**: Если `provider` не указан, функция определяет провайдера и модель по умолчанию на основе флага `has_images` и наличия модели.
5.  **Обработка ошибок**: Функция проверяет, найден ли провайдер, работает ли он, и поддерживает ли он потоковую передачу, и вызывает соответствующие исключения в случае проблем.
6.  **Логирование**: Если `logging` истинно, функция записывает в лог информацию об используемом провайдере и модели.
7.  **Возврат модели и провайдера**: Функция возвращает имя модели и объект провайдера.

```ascii
Проверка версии -> Преобразование provider (если строка) -> Преобразование model (если строка) -> Определение провайдера и модели по умолчанию (если provider не указан) ->
Проверка ошибок (ProviderNotFoundError, ModelNotFoundError, ProviderNotWorkingError, StreamNotSupportedError) -> Логирование -> Возврат (model, provider)
```

**Примеры**:

```python
# Пример 1: Получение модели и провайдера по умолчанию
model, provider = get_model_and_provider(model=None, provider=None, stream=False, has_images=False)

# Пример 2: Получение модели и провайдера по имени
model, provider = get_model_and_provider(model="gpt-3.5-turbo", provider="GPT4FreeProvider", stream=True)

# Пример 3: Обработка ошибки, если провайдер не работает
try:
    model, provider = get_model_and_provider(model="gpt-3.5-turbo", provider="FauxPilot", stream=False)
except ProviderNotWorkingError as ex:
    print(f"Ошибка: {ex}")
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """
    Получает последнего использованного провайдера.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о провайдере в виде словаря.

    Returns:
        Union[ProviderType, dict[str, str]]: Последний использованный провайдер, либо как объект, либо как словарь.
    """
    ...
```

**Как работает функция**:

1.  **Получение последнего провайдера**: Функция получает последнего использованного провайдера из `debug.last_provider`.
2.  **Обработка RetryProvider**: Если последний провайдер является экземпляром `BaseRetryProvider`, функция получает последний провайдер из этого объекта.
3.  **Форматирование вывода**: Если `as_dict` истинно, функция возвращает информацию о провайдере в виде словаря, содержащего имя, URL, модель и метку (если есть).
4.  **Возврат провайдера**: Функция возвращает объект провайдера или словарь с информацией о провайдере.

```ascii
Получение последнего провайдера из debug.last_provider -> Обработка BaseRetryProvider (если является экземпляром) ->
Форматирование вывода в виде словаря (если as_dict) -> Возврат провайдера или словаря
```

**Примеры**:

```python
# Пример 1: Получение последнего провайдера как объекта
last_provider = get_last_provider()

# Пример 2: Получение последнего провайдера как словаря
last_provider_dict = get_last_provider(as_dict=True)