# Модуль для обработки статусов ответов и генерации исключений

## Обзор

Модуль `raise_for_status.py` предназначен для проверки статуса HTTP-ответов и генерации соответствующих исключений в случае ошибок. Он обрабатывает различные типы ответов, включая ответы от `aiohttp`, `requests`, а также стриминговые ответы. Модуль также включает функциональность для определения, является ли ошибка результатом защиты Cloudflare или OpenAI, и генерирует специфические исключения для этих случаев.

## Подробней

Этот модуль играет важную роль в обработке ошибок при взаимодействии с различными API, позволяя унифицировать и упростить процесс обработки ошибок. Он определяет, какие исключения следует вызывать в зависимости от статуса ответа и содержимого, что помогает улучшить стабильность и надежность приложения.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Проверяет, является ли переданный текст ответом от Cloudflare.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки ответа от Cloudflare, иначе `False`.

    Как работает функция:
    1. Функция проверяет наличие определенных строк в тексте, указывающих на то, что ответ сгенерирован Cloudflare.
    2. Если одна из строк найдена, функция возвращает `True`.
    3. В противном случае, функция возвращает `False`.

    ASCII flowchart:
    Проверка текста на признаки Cloudflare
    --> Обнаружение строки "Generated by cloudfront" или '<p id="cf-spinner-please-wait">'?
    |   No --> Обнаружение строки "<title>Attention Required! | Cloudflare</title>" или 'id="cf-cloudflare-status"'?
    |       No --> Обнаружение строки '<div id="cf-please-wait">' или "<title>Just a moment...</title>"?
    |           No --> Возврат False
    |           Yes --> Возврат True
    |       Yes --> Возврат True
    Yes --> Возврат True

    Примеры:
    >>> is_cloudflare('<html><body>Generated by cloudfront</body></html>')
    True
    >>> is_cloudflare('<html><body>Some other content</body></html>')
    False
    """
    ...
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Проверяет, является ли переданный текст ответом от OpenAI.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки ответа от OpenAI, иначе `False`.

    Как работает функция:
    1. Функция проверяет наличие определенных строк в тексте, указывающих на то, что ответ сгенерирован OpenAI.
    2. Если строка найдена, функция возвращает `True`.
    3. В противном случае, функция возвращает `False`.

    ASCII flowchart:
    Проверка текста на признаки OpenAI
    --> Обнаружение строки "<p>Unable to load site</p>" или 'id="challenge-error-text"'?
    |   No --> Возврат False
    Yes --> Возврат True

    Примеры:
    >>> is_openai('<html><body><p>Unable to load site</p></body></html>')
    True
    >>> is_openai('<html><body>Some other content</body></html>')
    False
    """
    ...
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект ответа, который необходимо проверить.
        message (str, optional): Сообщение об ошибке. Если не указано, пытается извлечь его из ответа. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и ответ от Cloudflare.
        ResponseStatusError: Если статус ответа 403 и ответ от OpenAI, или если статус ответа 502.
        RateLimitError: Если статус ответа 504 или 429/402.
        ResponseStatusError: Если статус ответа не входит в вышеперечисленные случаи.

    Как работает функция:
    1. Проверяется, успешен ли запрос (`response.ok`). Если да, функция завершается.
    2. Если `message` не предоставлено, функция пытается извлечь его из содержимого ответа. Если `content-type` - `application/json`, сообщение извлекается из JSON. Иначе, сообщение извлекается как текст.
    3. Если ответ является HTML, устанавливается флаг `is_html`.
    4. Если `message` все еще `None` или `is_html` равен `True`, функция устанавливает сообщение по умолчанию в зависимости от статуса ответа (например, "Unknown error (Cloudflare)" для статуса 520).
    5. В зависимости от статуса ответа и содержимого, функция вызывает соответствующее исключение.

    ASCII flowchart:
    Успешен ли запрос? (response.ok)
    |   Yes --> Завершение
    No --> message is None?
    |   Yes --> Извлечение message из response.json или response.text
    No --> content-type начинается с "text/html" или message начинается с "<!DOCTYPE"?
    |   Yes --> is_html = True
    No --> message is None или is_html?
    |   Yes --> Установка message по умолчанию в зависимости от response.status
    No --> response.status == 401?
    |   Yes --> Вызов MissingAuthError
    No --> response.status == 403 и is_cloudflare(message)?
    |   Yes --> Вызов CloudflareError
    No --> response.status == 403 и is_openai(message)?
    |   Yes --> Вызов ResponseStatusError
    No --> response.status == 502?
    |   Yes --> Вызов ResponseStatusError
    No --> response.status == 504 или response.status == 429 или response.status == 402?
    |   Yes --> Вызов RateLimitError
    No --> Вызов ResponseStatusError

    Примеры:
    (Предположим, что `response` - это объект `aiohttp.ClientResponse`)
    >>> await raise_for_status_async(response)
    """
    ...
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.
    Функция определяет, является ли переданный объект асинхронным или синхронным, и вызывает соответствующую функцию для обработки статуса.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа, который необходимо проверить.
        message (str, optional): Сообщение об ошибке. Если не указано, пытается извлечь его из ответа. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и ответ от Cloudflare.
        ResponseStatusError: Если статус ответа 403 и ответ от OpenAI, или если статус ответа 502.
        RateLimitError: Если статус ответа 504 или 429/402.
        ResponseStatusError: Если статус ответа не входит в вышеперечисленные случаи.

    Как работает функция:
    1. Проверяется наличие атрибута `status` в объекте `response`. Если он есть, это означает, что передан асинхронный ответ, и вызывается функция `raise_for_status_async`.
    2. Если атрибута `status` нет, функция проверяет, успешен ли запрос (`response.ok`). Если да, функция завершается.
    3. Если `message` не предоставлено, функция пытается извлечь его из содержимого ответа. Если `content-type` - `text/html` или `response.text` начинается с "<!DOCTYPE", устанавливается флаг `is_html`.
    4. Если `message` все еще `None` или `is_html` равен `True`, функция устанавливает сообщение по умолчанию в зависимости от статуса ответа (например, "Unknown error (Cloudflare)" для статуса 520).
    5. В зависимости от статуса ответа и содержимого, функция вызывает соответствующее исключение.

    ASCII flowchart:
    Имеет ли response атрибут status?
    |   Yes --> Вызов raise_for_status_async(response, message)
    No --> Успешен ли запрос? (response.ok)
    |   Yes --> Завершение
    No --> message is None?
    |   Yes --> Извлечение message из response.headers и response.text
    No --> content-type начинается с "text/html" или message начинается с "<!DOCTYPE"?
    |   Yes --> is_html = True
    No --> message is None или is_html?
    |   Yes --> Установка message по умолчанию в зависимости от response.status_code
    No --> response.status_code == 401?
    |   Yes --> Вызов MissingAuthError
    No --> response.status_code == 403 и is_cloudflare(response.text)?
    |   Yes --> Вызов CloudflareError
    No --> response.status_code == 403 и is_openai(response.text)?
    |   Yes --> Вызов ResponseStatusError
    No --> response.status_code == 502?
    |   Yes --> Вызов ResponseStatusError
    No --> response.status_code == 504 или response.status_code == 429 или response.status_code == 402?
    |   Yes --> Вызов RateLimitError
    No --> Вызов ResponseStatusError

    Примеры:
    (Предположим, что `response` - это объект `requests.Response`)
    >>> raise_for_status(response)
    """
    ...