# Документация модуля `js_api.py`

## Обзор

Модуль `js_api.py` предоставляет класс `JsApi`, который является расширением класса `Api`. Этот класс предназначен для интеграции с JavaScript-интерфейсом веб-приложения, обеспечивая взаимодействие между Python-бэкендом и клиентской частью. Он позволяет получать ответы от моделей, выбирать и отправлять изображения, а также управлять элементами интерфейса через JavaScript.

## Подробней

Модуль обеспечивает возможность выбора изображений с помощью диалогового окна выбора файлов или камеры устройства, а также отправку этих изображений в запросах к моделям. Кроме того, он позволяет обновлять состояние элементов пользовательского интерфейса, таких как выделение выбранного изображения.

## Классы

### `JsApi`

**Описание**: Класс `JsApi` расширяет класс `Api` и предоставляет API для взаимодействия с JavaScript-интерфейсом веб-приложения.

**Наследует**:

- `Api`: Класс `JsApi` наследует функциональность от класса `Api`, предоставляя базовые методы для работы с моделями и провайдерами.

**Атрибуты**:

- `image` (str | None): Путь к выбранному изображению или `None`, если изображение не выбрано.

**Методы**:

- `get_conversation()`: Получает ответы от модели и отправляет их в JavaScript-интерфейс.
- `choose_image()`: Открывает диалоговое окно выбора изображения.
- `take_picture()`: Запускает камеру для получения изображения.
- `on_image_selection()`: Обрабатывает выбор изображения из диалогового окна.
- `on_camera()`: Обрабатывает получение изображения с камеры.
- `set_selected()`: Устанавливает состояние выбранного элемента интерфейса.
- `get_version()`: Возвращает версию API.
- `get_models()`: Возвращает список доступных моделей.
- `get_providers()`: Возвращает список доступных провайдеров.
- `get_provider_models()`: Возвращает список моделей для указанного провайдера.

### `JsApi.get_conversation`

```python
def get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator:
    """
    Получает ответы от модели и отправляет их в JavaScript-интерфейс для отображения.

    Args:
        options (dict): Опции для запроса к модели.
        message_id (str, optional): Идентификатор сообщения. По умолчанию `None`.
        scroll (bool, optional): Флаг для прокрутки окна. По умолчанию `None`.

    Returns:
        Iterator: Итератор, предоставляющий ответы от модели.

    Raises:
        Exception: Если происходит ошибка при создании или обработке ответа.
    """
```

**Назначение**: Метод `get_conversation` получает ответы от модели, подготавливает их и отправляет в JavaScript-интерфейс для отображения в реальном времени.

**Параметры**:

- `options` (dict): Словарь с опциями для запроса к модели. Может включать такие параметры, как `conversation_id` и `provider`.
- `message_id` (str, optional): Идентификатор сообщения, который используется для связи между запросом и ответом. По умолчанию `None`.
- `scroll` (bool, optional): Флаг, указывающий, нужно ли прокручивать окно просмотра сообщений. По умолчанию `None`.

**Возвращает**:

- `Iterator`: Итератор, который предоставляет ответы от модели в виде отдельных сообщений.

**Как работает функция**:

1.  Получает ссылку на основное окно веб-приложения.
2.  Проверяет, было ли выбрано изображение. Если да, то открывает его в бинарном режиме и добавляет в опции запроса.
3.  Итерируется по сообщениям, полученным от метода `_create_response_stream`.
4.  Для каждого сообщения выполняет JavaScript-код в окне веб-приложения, который добавляет сообщение в пользовательский интерфейс. JavaScript-код также проверяет, не была ли остановлена генерация ответов.
5.  Если генерация остановлена, прерывает цикл.
6.  Сбрасывает атрибут `image` и снимает выделение с выбранного элемента интерфейса.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
options = {"conversation_id": "123", "provider": "openai", "prompt": "Hello!"}
for message in js_api_instance.get_conversation(options, message_id="456", scroll=True):
    print(message)
```

### `JsApi.choose_image`

```python
def choose_image(self):
    """
    Открывает диалоговое окно выбора изображения для выбора пользователем.
    """
```

**Назначение**: Метод `choose_image` открывает диалоговое окно, позволяющее пользователю выбрать изображение из файловой системы.

**Параметры**:

-   Отсутствуют.

**Возвращает**:

-   Отсутствует.

**Как работает функция**:

1.  Использует функцию `user_select_image`, которая, в свою очередь, вызывает `filechooser.open_file` из библиотеки `plyer`.
2.  Передает функцию `self.on_image_selection` в качестве обработчика выбора файла.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
js_api_instance.choose_image()
```

### `JsApi.take_picture`

```python
def take_picture(self):
    """
    Запускает камеру для получения изображения.
    """
```

**Назначение**: Метод `take_picture` запускает камеру устройства для получения изображения.

**Параметры**:

-   Отсутствуют.

**Возвращает**:

-   Отсутствует.

**Как работает функция**:

1.  Формирует имя файла для сохранения изображения, используя UUID для уникальности.
2.  Вызывает функцию `camera.take_picture` из библиотеки `plyer`, передавая имя файла и функцию `self.on_camera` в качестве обработчика завершения.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
js_api_instance.take_picture()
```

### `JsApi.on_image_selection`

```python
def on_image_selection(self, filename):
    """
    Обрабатывает выбор изображения из диалогового окна.

    Args:
        filename (str): Имя выбранного файла.
    """
```

**Назначение**: Метод `on_image_selection` обрабатывает имя файла, выбранного пользователем в диалоговом окне выбора изображения.

**Параметры**:

-   `filename` (str): Имя выбранного файла.

**Возвращает**:

-   Отсутствует.

**Как работает функция**:

1.  Проверяет, является ли `filename` списком и не является ли он пустым. Если да, то берет первый элемент списка.
2.  Проверяет, существует ли файл с указанным именем.
3.  Если файл существует, устанавливает атрибут `self.image` равным имени файла.
4.  В противном случае устанавливает атрибут `self.image` в `None`.
5.  Снимает или устанавливает выделение элемента интерфейса в зависимости от того, было ли выбрано изображение.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
js_api_instance.on_image_selection("example.png")
```

### `JsApi.on_camera`

```python
def on_camera(self, filename):
    """
    Обрабатывает получение изображения с камеры.

    Args:
        filename (str): Имя файла, в который сохранено изображение с камеры.
    """
```

**Назначение**: Метод `on_camera` обрабатывает имя файла, в который было сохранено изображение, полученное с камеры.

**Параметры**:

-   `filename` (str): Имя файла, в который сохранено изображение с камеры.

**Возвращает**:

-   Отсутствует.

**Как работает функция**:

1.  Проверяет, существует ли файл с указанным именем.
2.  Если файл существует, устанавливает атрибут `self.image` равным имени файла.
3.  В противном случае устанавливает атрибут `self.image` в `None`.
4.  Снимает или устанавливает выделение элемента интерфейса в зависимости от того, было ли получено изображение.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
js_api_instance.on_camera("camera_image.png")
```

### `JsApi.set_selected`

```python
def set_selected(self, input_id: str = None):
    """
    Устанавливает состояние выбранного элемента интерфейса.

    Args:
        input_id (str, optional): Идентификатор выбранного элемента. По умолчанию `None`.
    """
```

**Назначение**: Метод `set_selected` устанавливает состояние выбранного элемента интерфейса, добавляя или удаляя класс `selected` у соответствующего элемента.

**Параметры**:

-   `input_id` (str, optional): Идентификатор выбранного элемента интерфейса (`image` или `camera`). По умолчанию `None`.

**Возвращает**:

-   Отсутствует.

**Как работает функция**:

1.  Получает ссылку на основное окно веб-приложения.
2.  Удаляет класс `selected` у любого элемента с классом `image-label.selected`.
3.  Если `input_id` не равен `None` и является либо `image`, либо `camera`, добавляет класс `selected` к соответствующему элементу интерфейса.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
js_api_instance.set_selected("image")
```

### `JsApi.get_version`

```python
def get_version(self):
    """
    Возвращает версию API.
    """
```

**Назначение**: Метод `get_version` возвращает версию API, вызывая метод `get_version` родительского класса `Api`.

**Параметры**:

-   Отсутствуют.

**Возвращает**:

-   Версия API.

**Как работает функция**:

1.  Вызывает метод `get_version` родительского класса `Api`.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
version = js_api_instance.get_version()
print(version)
```

### `JsApi.get_models`

```python
def get_models(self):
    """
    Возвращает список доступных моделей.
    """
```

**Назначение**: Метод `get_models` возвращает список доступных моделей, вызывая метод `get_models` родительского класса `Api`.

**Параметры**:

-   Отсутствуют.

**Возвращает**:

-   Список доступных моделей.

**Как работает функция**:

1.  Вызывает метод `get_models` родительского класса `Api`.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
models = js_api_instance.get_models()
print(models)
```

### `JsApi.get_providers`

```python
def get_providers(self):
    """
    Возвращает список доступных провайдеров.
    """
```

**Назначение**: Метод `get_providers` возвращает список доступных провайдеров, вызывая метод `get_providers` родительского класса `Api`.

**Параметры**:

-   Отсутствуют.

**Возвращает**:

-   Список доступных провайдеров.

**Как работает функция**:

1.  Вызывает метод `get_providers` родительского класса `Api`.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
providers = js_api_instance.get_providers()
print(providers)
```

### `JsApi.get_provider_models`

```python
def get_provider_models(self, provider: str, **kwargs):
    """
    Возвращает список моделей для указанного провайдера.

    Args:
        provider (str): Имя провайдера.
        **kwargs: Дополнительные аргументы.
    """
```

**Назначение**: Метод `get_provider_models` возвращает список моделей, доступных для указанного провайдера, вызывая метод `get_provider_models` родительского класса `Api`.

**Параметры**:

-   `provider` (str): Имя провайдера.
-   `**kwargs`: Дополнительные аргументы, которые могут потребоваться для получения списка моделей.

**Возвращает**:

-   Список моделей для указанного провайдера.

**Как работает функция**:

1.  Вызывает метод `get_provider_models` родительского класса `Api`, передавая имя провайдера и дополнительные аргументы.

**Внутренние функции**: Отсутствуют.

**Примеры**:

```python
# Пример вызова функции
models = js_api_instance.get_provider_models("openai")
print(models)
```