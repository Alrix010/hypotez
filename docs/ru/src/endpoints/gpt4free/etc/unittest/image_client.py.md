# Модуль `image_client`

## Обзор

Модуль `image_client` содержит набор модульных тестов для проверки корректной работы асинхронного клиента `AsyncClient` при использовании различных поставщиков изображений, включая случаи, когда поставщики возвращают `None`, пропускаются из-за отсутствия аутентификации или вызывают исключения. Модуль использует `unittest` и `asyncio` для асинхронного тестирования.

## Подробнее

Этот модуль предназначен для тестирования отказоустойчивости и правильной обработки различных сценариев при работе с поставщиками изображений в асинхронном режиме. В частности, проверяется, как клиент обрабатывает ситуации, когда один из поставщиков недоступен или возвращает некорректные данные, и как это влияет на общий результат. Модуль использует моки (mocks) для имитации различных поставщиков изображений и их поведения.

## Классы

### `TestIterListProvider`

**Описание**: Класс `TestIterListProvider` наследуется от `unittest.IsolatedAsyncioTestCase` и содержит асинхронные тесты для проверки работы с поставщиками изображений.

**Наследует**: `unittest.IsolatedAsyncioTestCase`

**Атрибуты**:
- Нет специфических атрибутов, кроме тех, что предоставляет родительский класс `unittest.IsolatedAsyncioTestCase`.

**Методы**:
- `test_skip_provider()`: Проверяет, что клиент пропускает поставщика, если он не проходит аутентификацию.
- `test_only_one_result()`: Проверяет, что клиент возвращает результат только от одного поставщика, даже если их несколько возвращают результат.
- `test_skip_none()`: Проверяет, что клиент пропускает поставщика, если он возвращает `None`.
- `test_raise_exception()`: Проверяет, что исключение, вызванное поставщиком, корректно обрабатывается клиентом.

## Методы класса

### `test_skip_provider`

```python
async def test_skip_provider(self):
    """Проверяет, что клиент пропускает поставщика, если он не проходит аутентификацию."""
    ...
```

**Назначение**: Проверяет сценарий, когда один из поставщиков изображений в списке не проходит аутентификацию. В этом случае, тест убеждается, что клиент корректно пропускает этого поставщика и использует следующего в списке.

**Параметры**:
- `self` (TestIterListProvider): Ссылка на экземпляр класса `TestIterListProvider`.

**Возвращает**:
- None

**Как работает функция**:
- Создается экземпляр `AsyncClient` с `IterListProvider`, который содержит два поставщика: `MissingAuthProviderMock` (который всегда возвращает ошибку аутентификации) и `YieldImageResponseProviderMock` (который возвращает успешный результат).
- Вызывается метод `client.images.generate` для генерации изображения.
- Проверяется, что возвращенный объект является экземпляром `ImagesResponse`.
- Проверяется, что URL изображения в ответе соответствует ожидаемому значению ("Hello").

**Примеры**:
```python
# Пример использования test_skip_provider
# Создание экземпляра TestIterListProvider и запуск теста
test_case = TestIterListProvider()
asyncio.run(test_case.test_skip_provider())
```

### `test_only_one_result`

```python
async def test_only_one_result(self):
    """Проверяет, что клиент возвращает результат только от одного поставщика, даже если их несколько возвращают результат."""
    ...
```

**Назначение**: Проверяет ситуацию, когда несколько поставщиков изображений возвращают результат. Тест убеждается, что клиент использует результат только от одного из них.

**Параметры**:
- `self` (TestIterListProvider): Ссылка на экземпляр класса `TestIterListProvider`.

**Возвращает**:
- None

**Как работает функция**:
- Создается экземпляр `AsyncClient` с `IterListProvider`, который содержит два экземпляра `YieldImageResponseProviderMock` (оба возвращают успешный результат).
- Вызывается метод `client.images.generate` для генерации изображения.
- Проверяется, что возвращенный объект является экземпляром `ImagesResponse`.
- Проверяется, что URL изображения в ответе соответствует ожидаемому значению ("Hello").

**Примеры**:
```python
# Пример использования test_only_one_result
# Создание экземпляра TestIterListProvider и запуск теста
test_case = TestIterListProvider()
asyncio.run(test_case.test_only_one_result())
```

### `test_skip_none`

```python
async def test_skip_none(self):
    """Проверяет, что клиент пропускает поставщика, если он возвращает `None`."""
    ...
```

**Назначение**: Проверяет, что клиент корректно обрабатывает ситуацию, когда один из поставщиков изображений возвращает `None`. В этом случае, тест убеждается, что клиент пропускает этого поставщика и использует следующего в списке.

**Параметры**:
- `self` (TestIterListProvider): Ссылка на экземпляр класса `TestIterListProvider`.

**Возвращает**:
- None

**Как работает функция**:
- Создается экземпляр `AsyncClient` с `IterListProvider`, который содержит два поставщика: `YieldNoneProviderMock` (который возвращает `None`) и `YieldImageResponseProviderMock` (который возвращает успешный результат).
- Вызывается метод `client.images.generate` для генерации изображения.
- Проверяется, что возвращенный объект является экземпляром `ImagesResponse`.
- Проверяется, что URL изображения в ответе соответствует ожидаемому значению ("Hello").

**Примеры**:
```python
# Пример использования test_skip_none
# Создание экземпляра TestIterListProvider и запуск теста
test_case = TestIterListProvider()
asyncio.run(test_case.test_skip_none())
```

### `test_raise_exception`

```python
def test_raise_exception(self):
    """Проверяет, что исключение, вызванное поставщиком, корректно обрабатывается клиентом."""
    ...
```

**Назначение**: Проверяет, что исключение, вызванное одним из поставщиков изображений, корректно обрабатывается клиентом и приводит к ожидаемому результату (в данном случае, вызову исключения `RuntimeError`).

**Параметры**:
- `self` (TestIterListProvider): Ссылка на экземпляр класса `TestIterListProvider`.

**Возвращает**:
- None

**Как работает функция**:
- Определяется внутренняя асинхронная функция `run_exception`, которая создает экземпляр `AsyncClient` с `IterListProvider`, содержащим `YieldNoneProviderMock` и `AsyncRaiseExceptionProviderMock` (который вызывает исключение `RuntimeError`).
- Функция `run_exception` вызывает метод `client.images.generate`, который должен вызвать исключение.
- Тест проверяет, что вызов `asyncio.run(run_exception())` действительно вызывает исключение `RuntimeError`.

**Внутренние функции**:
- `run_exception`: Асинхронная функция, предназначенная для запуска процесса генерации изображений и проверки обработки исключения.

```python
async def run_exception():
    """Асинхронная функция, предназначенная для запуска процесса генерации изображений и проверки обработки исключения."""
    ...
```

**Примеры**:
```python
# Пример использования test_raise_exception
# Создание экземпляра TestIterListProvider и запуск теста
test_case = TestIterListProvider()
test_case.test_raise_exception()
```

## Запуск тестов

В блоке `if __name__ == '__main__':` вызывается `unittest.main()`, что позволяет запускать тесты при непосредственном выполнении скрипта.