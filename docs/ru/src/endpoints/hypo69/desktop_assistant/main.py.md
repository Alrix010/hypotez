# Модуль `main.py`

## Обзор

Модуль `main.py` представляет собой основной файл приложения, использующего FastAPI для создания API ассистента. Он включает в себя настройку CORS, определение моделей данных для запросов, маршруты для обработки запросов к чату и локализации, а также запуск локального сервера.

## Подробнее

Этот модуль является отправной точкой для запуска веб-приложения, предоставляющего интерфейс для взаимодействия с Google Gemini AI. Он обрабатывает запросы к чату, предоставляет статические файлы (HTML, CSS, JavaScript) и поддерживает локализацию интерфейса.

## Классы

### `ChatRequest`

**Описание**: Класс `ChatRequest` используется для определения структуры запроса к чату.

**Атрибуты**:
- `message` (str): Сообщение пользователя для отправки в чат.

## Функции

### `root`

```python
async def root() -> HTMLResponse:
    """
    Возвращает HTML-контент главной страницы.

    Returns:
        HTMLResponse: HTML-контент файла `index.html`.

    Raises:
        HTTPException: Если файл `index.html` не найден или произошла ошибка при его чтении.

    Example:
        Вызов данного endpoint вернет HTML-страницу для отображения в браузере.
    """
```

**Назначение**: Функция `root` обрабатывает GET-запросы к корневому пути ("/"). Она пытается прочитать содержимое файла `index.html` и вернуть его в качестве HTML-ответа.

**Как работает функция**:

1.  Определяется путь к файлу `index.html` в директории `templates`.
2.  Проверяется, существует ли файл. Если файл не найден, выбрасывается исключение `FileNotFoundError`.
3.  Если файл существует, его содержимое считывается в кодировке UTF-8.
4.  Содержимое возвращается в виде `HTMLResponse`.
5.  Если в процессе чтения файла возникает ошибка, она логируется с использованием `logger.error`, и выбрасывается исключение `HTTPException`.

**ASCII flowchart**:

```
A[Определение пути к index.html]
↓
B[Проверка существования файла]
↓
C[Чтение содержимого файла]
↓
D[Возврат HTMLResponse]
↓
E[Обработка ошибок]
```

**Примеры**:

-   При успешном выполнении возвращает HTML-страницу.
-   При отсутствии файла `index.html` возвращает HTTP 500 ошибку.

### `chat`

```python
async def chat(request: ChatRequest) -> dict:
    """
    Отправляет сообщение в Google Gemini AI и возвращает ответ.

    Args:
        request (ChatRequest): Объект `ChatRequest`, содержащий сообщение пользователя.

    Returns:
        dict: Словарь, содержащий ответ от модели Google Gemini AI.

    Raises:
        HTTPException: Если произошла ошибка при взаимодействии с моделью.

    Example:
        >>> request = ChatRequest(message="Hello, Gemini!")
        >>> await chat(request)
        {"response": "Hello, user!"}
    """
```

**Назначение**: Функция `chat` обрабатывает POST-запросы к пути "/api/chat". Она принимает сообщение от пользователя, отправляет его в Google Gemini AI и возвращает ответ.

**Как работает функция**:

1.  Проверяется, инициализирована ли глобальная переменная `model`. Если нет, создается экземпляр класса `GoogleGenerativeAI`.
2.  Вызывается метод `chat` объекта `model` с сообщением пользователя из объекта `request`.
3.  Полученный ответ возвращается в виде словаря.
4.  Если в процессе взаимодействия с моделью возникает ошибка, она логируется с использованием `logger.error`, и выбрасывается исключение `HTTPException`.

**ASCII flowchart**:

```
A[Проверка инициализации model]
↓
B[Инициализация GoogleGenerativeAI]
↓
C[Отправка сообщения в Gemini]
↓
D[Получение ответа]
↓
E[Возврат ответа]
↓
F[Обработка ошибок]
```

**Примеры**:

-   При успешном выполнении возвращает ответ от Google Gemini AI.
-   При возникновении ошибки возвращает HTTP 500 ошибку.

### `get_locale_file`

```python
def get_locale_file(lang: str) -> dict:
    """
    Загружает JSON-файл локализации для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        dict: Словарь с данными локализации из JSON-файла.

    Raises:
        HTTPException: Если файл локализации не найден, содержит ошибки JSON или произошла другая ошибка при чтении файла.

    Example:
        >>> get_locale_file("ru")
        {"greeting": "Привет"}
    """
```

**Назначение**: Функция `get_locale_file` загружает JSON-файл локализации для указанного языка.

**Как работает функция**:

1.  Формируется путь к файлу локализации на основе переданного кода языка.
2.  Файл открывается для чтения.
3.  Содержимое JSON-файла считывается и возвращается в виде словаря.
4.  Если файл не найден, возникает исключение `FileNotFoundError`, которое логируется, и выбрасывается исключение `HTTPException` с кодом 404.
5.  Если в JSON-файле обнаружены ошибки, возникает исключение `json.JSONDecodeError`, которое логируется, и выбрасывается исключение `HTTPException` с кодом 500.
6.  При возникновении любых других исключений они логируются, и выбрасывается исключение `HTTPException` с кодом 500.

**ASCII flowchart**:

```
A[Формирование пути к файлу локализации]
↓
B[Открытие файла]
↓
C[Чтение содержимого JSON]
↓
D[Возврат словаря с данными локализации]
↓
E[Обработка FileNotFoundError]
↓
F[Обработка JSONDecodeError]
↓
G[Обработка других исключений]
```

**Примеры**:

-   При успешном выполнении возвращает словарь с данными локализации.
-   При отсутствии файла локализации возвращает HTTP 404 ошибку.
-   При ошибке в JSON-файле возвращает HTTP 500 ошибку.

### `locales`

```python
async def locales(lang: str) -> dict:
    """
    Возвращает JSON-файл локализации для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        dict: Словарь с данными локализации из JSON-файла.

    Raises:
        HTTPException: Если файл локализации не найден, содержит ошибки JSON или произошла другая ошибка при чтении файла.

    Example:
        Вызов данного endpoint вернет JSON-файл с локализацией для указанного языка.
    """
```

**Назначение**: Функция `locales` обрабатывает GET-запросы к пути "/locales/{lang}.json". Она вызывает функцию `get_locale_file` для получения файла локализации и возвращает его.

**Как работает функция**:

1.  Вызывается функция `get_locale_file` с переданным кодом языка.
2.  Результат, возвращенный функцией `get_locale_file`, возвращается как результат работы функции `locales`.
3.  Все исключения, которые могут возникнуть в функции `get_locale_file`, будут также обработаны и переброшены в вызывающий код.

**ASCII flowchart**:

```
A[Вызов get_locale_file(lang)]
↓
B[Возврат результата get_locale_file]
```

**Примеры**:

-   При успешном выполнении возвращает JSON-файл с локализацией.
-   При отсутствии файла локализации возвращает HTTP 404 ошибку.
-   При ошибке в JSON-файле возвращает HTTP 500 ошибку.