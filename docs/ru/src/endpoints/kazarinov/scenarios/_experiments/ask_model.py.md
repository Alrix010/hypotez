# Модуль для проверки валидности ответов от модели

## Обзор

Модуль предназначен для проверки валидности ответов, полученных от AI-модели Google Gemini. Он включает в себя функциональность для загрузки инструкций, отправки запросов к модели на разных языках (русский и иврит), обработки полученных ответов в формате JSON и сохранения результатов.

## Подробней

Данный модуль является частью процесса обработки данных в проекте `hypotez` и используется в сценариях, связанных с анализом ответов от AI-модели. Он выполняет следующие основные шаги:

1.  Загрузка инструкций для модели на русском и иврите.
2.  Формирование запросов к модели на основе загруженных инструкций и списка продуктов.
3.  Отправка запросов к модели и получение ответов.
4.  Обработка ответов в формате JSON.
5.  Сохранение обработанных ответов в файлы.

Этот модуль важен для обеспечения корректности и надежности работы с AI-моделью, поскольку он включает в себя механизмы обработки ошибок и повторных попыток при получении ответов.

## Функции

### `model_ask`

```python
def model_ask(lang: str, attempts: int = 3) -> dict:
    """
    Получает ответ от модели Google Gemini на указанном языке.

    Args:
        lang (str): Язык запроса ('ru' для русского, 'he' для иврита).
        attempts (int, optional): Количество попыток запроса к модели в случае неудачи. По умолчанию 3.

    Returns:
        dict: Словарь с ответом от модели в формате JSON или пустой словарь в случае ошибки.

    Raises:
        Exception: Если возникает ошибка при запросе или обработке ответа от модели.
    """
```

**Как работает функция**:

1.  Определяет глобальные переменные: `model`, `q_ru`, `q_he`.
2.  Формирует запрос к модели на основе указанного языка (`q_ru` для русского, `q_he` для иврита).
3.  Отправляет запрос к модели с помощью метода `model.ask()`.
4.  Обрабатывает ответ от модели:
    *   Если ответ пустой, записывает ошибку в лог и возвращает пустой словарь.
    *   Парсит ответ в формат JSON с помощью `j_loads()`.
    *   Если парсинг не удался, записывает ошибку в лог и, если остались попытки, рекурсивно вызывает `model_ask()` с уменьшенным количеством попыток.
5.  Возвращает словарь с ответом от модели или пустой словарь в случае ошибки.

```
    Начало
    │
    ├── Определение языка (lang)
    │   │
    │   └── Выбор запроса (q_ru или q_he)
    │       │
    │       └── Отправка запроса к модели (model.ask)
    │           │
    │           ├── Ответ получен?
    │           │   ├── Да → Парсинг ответа (j_loads)
    │           │   │   │
    │           │   │   └── Успешный парсинг?
    │           │   │       ├── Да → Возврат словаря с ответом
    │           │   │       └── Нет → Ошибка парсинга, есть попытки?
    │           │   │           ├── Да → Рекурсивный вызов model_ask
    │           │   │           └── Нет → Лог ошибки, возврат пустого словаря
    │           │   └── Нет → Лог ошибки, возврат пустого словаря
    │   
    └── Конец
```

**Примеры**:

```python
# Пример вызова функции на русском языке
response_ru = model_ask(lang='ru')
print(response_ru)

# Пример вызова функции на иврите с 5 попытками
response_he = model_ask(lang='he', attempts=5)
print(response_he)