# Модуль для создания историй в TinyTroupe
## Обзор

Модуль `story.py` предназначен для создания и управления историями, основанными на симуляциях в TinyTroupe. Он предоставляет класс `TinyStory`, который позволяет генерировать истории об агентах или окружении, учитывая контекст, цели и ход симуляции.
Данный модуль помогает придать повествовательную структуру симуляциям, делая их более интересными и понятными.

## Подробней

Этот модуль предоставляет инструменты для создания историй на основе симуляций в TinyTroupe. Он содержит класс `TinyStory`, который позволяет генерировать и продолжать истории, учитывая текущее состояние симуляции, цели и контекст. Модуль использует OpenAI для генерации текста истории, основываясь на предоставленных шаблонах и данных симуляции.

## Классы

### `TinyStory`

**Описание**: Класс для создания и управления историями, основанными на симуляциях в TinyTroupe.

**Принцип работы**:
Класс `TinyStory` инициализируется либо с окружением (`TinyWorld`), либо с агентом (`TinyPerson`). Он использует текущие взаимодействия симуляции для создания или продолжения истории. Для генерации текста истории используются OpenAI и шаблоны Mustache.

**Атрибуты**:
- `environment` (TinyWorld, optional): Окружение, в котором происходит история. По умолчанию `None`.
- `agent` (TinyPerson, optional): Агент, о котором рассказывается история. По умолчанию `None`.
- `purpose` (str, optional): Цель истории. Используется для направления генерации истории. По умолчанию "Be a realistic simulation.".
- `context` (str, optional): Текущий контекст истории. Новая история будет добавлена к этому контексту. По умолчанию "".
- `first_n` (int, optional): Количество первых взаимодействий для включения в историю. По умолчанию 10.
- `last_n` (int, optional): Количество последних взаимодействий для включения в историю. По умолчанию 20.
- `include_omission_info` (bool, optional): Определяет, включать ли информацию об опущенных взаимодействиях. По умолчанию `True`.
- `current_story` (str): Текущая история.

**Методы**:
- `__init__`: Инициализирует объект `TinyStory`.
- `start_story`: Начинает новую историю.
- `continue_story`: Предлагает продолжение истории.
- `_current_story`: Возвращает текущую историю с учетом последних взаимодействий.

## Функции

### `__init__`

```python
def __init__(self, environment:TinyWorld=None, agent:TinyPerson=None, purpose:str="Be a realistic simulation.", context:str="",
                 first_n=10, last_n=20, include_omission_info:bool=True) -> None:
    """
    Инициализирует объект истории. История может быть об окружении или об агенте. Также имеет цель, которая
    используется для направления генерации истории. Истории знают, что они связаны с симуляциями, поэтому можно
    указать цели, связанные с симуляцией.

    Args:
        environment (TinyWorld, optional): Окружение, в котором происходит история. По умолчанию None.
        agent (TinyPerson, optional): Агент, о котором рассказывается история. По умолчанию None.
        purpose (str, optional): Цель истории. Используется для направления генерации истории. По умолчанию "Be a realistic simulation.".
        context (str, optional): Текущий контекст истории. Новая история будет добавлена к этому контексту. По умолчанию "".
        first_n (int, optional): Количество первых взаимодействий для включения в историю. По умолчанию 10.
        last_n (int, optional): Количество последних взаимодействий для включения в историю. По умолчанию 20.
        include_omission_info (bool, optional): Определяет, включать ли информацию об опущенных взаимодействиях. По умолчанию True.

    Raises:
        Exception: Если не предоставлено ни окружение, ни агент, или предоставлены оба одновременно.
    """
    ...
```

**Назначение**: Инициализация объекта `TinyStory`.

**Параметры**:
- `environment` (TinyWorld, optional): Окружение, в котором происходит история. По умолчанию `None`.
- `agent` (TinyPerson, optional): Агент, о котором рассказывается история. По умолчанию `None`.
- `purpose` (str, optional): Цель истории. Используется для направления генерации истории. По умолчанию "Be a realistic simulation.".
- `context` (str, optional): Текущий контекст истории. Новая история будет добавлена к этому контексту. По умолчанию "".
- `first_n` (int, optional): Количество первых взаимодействий для включения в историю. По умолчанию 10.
- `last_n` (int, optional): Количество последних взаимодействий для включения в историю. По умолчанию 20.
- `include_omission_info` (bool, optional): Определяет, включать ли информацию об опущенных взаимодействиях. По умолчанию `True`.

**Вызывает исключения**:
- `Exception`: Если не предоставлено ни окружение, ни агент, или предоставлены оба одновременно.

**Как работает функция**:

1.  **Проверка входных параметров**: Код проверяет, что передан ровно один из параметров: `environment` или `agent`. Если не передан ни один или переданы оба, вызывается исключение.
2.  **Инициализация атрибутов**: Инициализируются атрибуты класса, такие как `environment`, `agent`, `purpose`, `current_story`, `first_n`, `last_n` и `include_omission_info`.

**ASCII Flowchart**:

```
A[Проверка наличия environment или agent]
|
B[Инициализация атрибутов класса]
```

**Примеры**:

```python
from tinytroupe.environment import TinyWorld
from tinytroupe.story import TinyStory

# Пример 1: Инициализация с окружением
environment = TinyWorld()
story = TinyStory(environment=environment)

# Пример 2: Инициализация с агентом (предположим, что TinyPerson определен и импортирован)
# agent = TinyPerson()
# story = TinyStory(agent=agent)
```

### `start_story`

```python
def start_story(self, requirements="Start some interesting story about the agents.", number_of_words:int=100, include_plot_twist:bool=False) -> str:
    """
    Начинает новую историю.
    """
    ...
```

**Назначение**: Начинает новую историю на основе предоставленных требований и текущего контекста симуляции.

**Параметры**:
- `requirements` (str, optional): Требования к началу истории. По умолчанию "Start some interesting story about the agents.".
- `number_of_words` (int, optional): Количество слов в сгенерированной истории. По умолчанию 100.
- `include_plot_twist` (bool, optional): Определяет, нужно ли включать неожиданный поворот сюжета. По умолчанию `False`.

**Возвращает**:
- `str`: Сгенерированное начало истории.

**Как работает функция**:

1.  **Подготовка конфигурации**: Создается словарь `rendering_configs`, содержащий параметры для генерации истории, такие как цель, требования, текущая трасса симуляции, количество слов и необходимость включения сюжетного поворота.
2.  **Композиция сообщений**: Используется функция `compose_initial_LLM_messages_with_templates` для создания сообщений для языковой модели (LLM) на основе шаблонов Mustache.
3.  **Отправка сообщения в OpenAI**: Сообщения отправляются в OpenAI для генерации начала истории.
4.  **Обновление текущей истории**: Сгенерированное начало истории добавляется к текущей истории.
5.  **Возврат начала истории**: Возвращается сгенерированное начало истории.

**ASCII Flowchart**:

```
A[Подготовка конфигурации]
|
B[Композиция сообщений для LLM]
|
C[Отправка сообщения в OpenAI]
|
D[Обновление текущей истории]
|
E[Возврат начала истории]
```

**Примеры**:

```python
from tinytroupe.environment import TinyWorld
from tinytroupe.story import TinyStory

# Пример: Начало новой истории с настройками по умолчанию
environment = TinyWorld()
story = TinyStory(environment=environment)
start = story.start_story()
print(start)

# Пример: Начало новой истории с пользовательскими требованиями и количеством слов
environment = TinyWorld()
story = TinyStory(environment=environment)
start = story.start_story(requirements="Start a story about a conflict between agents", number_of_words=150)
print(start)
```

### `continue_story`

```python
def continue_story(self, requirements="Continue the story in an interesting way.", number_of_words:int=100, include_plot_twist:bool=False) -> str:
    """
    Предлагает продолжение истории.
    """
    ...
```

**Назначение**: Предлагает продолжение истории на основе предоставленных требований и текущего контекста симуляции.

**Параметры**:
- `requirements` (str, optional): Требования к продолжению истории. По умолчанию "Continue the story in an interesting way.".
- `number_of_words` (int, optional): Количество слов в сгенерированном продолжении истории. По умолчанию 100.
- `include_plot_twist` (bool, optional): Определяет, нужно ли включать неожиданный поворот сюжета. По умолчанию `False`.

**Возвращает**:
- `str`: Сгенерированное продолжение истории.

**Как работает функция**:

1.  **Подготовка конфигурации**: Создается словарь `rendering_configs`, содержащий параметры для генерации продолжения истории, такие как цель, требования, текущая трасса симуляции, количество слов и необходимость включения сюжетного поворота.
2.  **Композиция сообщений**: Используется функция `compose_initial_LLM_messages_with_templates` для создания сообщений для языковой модели (LLM) на основе шаблонов Mustache.
3.  **Отправка сообщения в OpenAI**: Сообщения отправляются в OpenAI для генерации продолжения истории.
4.  **Обновление текущей истории**: Сгенерированное продолжение истории добавляется к текущей истории.
5.  **Возврат продолжения истории**: Возвращается сгенерированное продолжение истории.

**ASCII Flowchart**:

```
A[Подготовка конфигурации]
|
B[Композиция сообщений для LLM]
|
C[Отправка сообщения в OpenAI]
|
D[Обновление текущей истории]
|
E[Возврат продолжения истории]
```

**Примеры**:

```python
from tinytroupe.environment import TinyWorld
from tinytroupe.story import TinyStory

# Пример: Продолжение истории с настройками по умолчанию
environment = TinyWorld()
story = TinyStory(environment=environment)
continuation = story.continue_story()
print(continuation)

# Пример: Продолжение истории с пользовательскими требованиями и количеством слов
environment = TinyWorld()
story = TinyStory(environment=environment)
continuation = story.continue_story(requirements="Continue the story with a new challenge", number_of_words=150)
print(continuation)
```

### `_current_story`

```python
def _current_story(self) -> str:
    """
    Возвращает текущую историю.
    """
    ...
```

**Назначение**: Возвращает текущую историю с учетом последних взаимодействий агента или окружения.

**Возвращает**:
- `str`: Текущая история с добавленными последними взаимодействиями.

**Как работает функция**:

1.  **Получение истории взаимодействий**: В зависимости от того, с чем был инициализирован объект `TinyStory` (с агентом или окружением), вызывается метод `pretty_current_interactions` для получения истории взаимодействий.
2.  **Добавление истории взаимодействий к текущей истории**: История взаимодействий добавляется к текущей истории.
3.  **Возврат текущей истории**: Возвращается обновленная текущая история.

**ASCII Flowchart**:

```
A[Проверка наличия agent или environment]
|
B[Получение истории взаимодействий]
|
C[Добавление истории взаимодействий к текущей истории]
|
D[Возврат текущей истории]
```

**Примеры**:

```python
from tinytroupe.environment import TinyWorld
from tinytroupe.story import TinyStory

# Пример: Получение текущей истории для окружения
environment = TinyWorld()
story = TinyStory(environment=environment)
current_story = story._current_story()
print(current_story)

# Пример: Получение текущей истории для агента (предположим, что TinyPerson определен и импортирован)
# agent = TinyPerson()
# story = TinyStory(agent=agent)
# current_story = story._current_story()
# print(current_story)