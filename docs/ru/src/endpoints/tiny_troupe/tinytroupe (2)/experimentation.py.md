# Модуль для проведения экспериментов

## Обзор

Этот модуль содержит классы для проведения A/B-тестирования и других экспериментов в Tiny Troupe. Он включает в себя функциональность для рандомизации вариантов, дерандомизации результатов и применения интервенций к агентам и средам.

## Подробнее

Модуль предоставляет инструменты для проведения экспериментов, включая рандомизацию выбора между вариантами, дерандомизацию для анализа результатов и применение интервенций для изменения поведения агентов и сред. Он содержит класс `ABRandomizer` для A/B-тестирования и класс `Intervention` для применения изменений.

## Классы

### `ABRandomizer`

**Описание**: Класс `ABRandomizer` предназначен для рандомизации между двумя вариантами и последующей дерандомизации.

**Атрибуты**:
- `choices` (dict): Словарь, хранящий информацию о том, как были рандомизированы элементы. Ключом является индекс элемента.
- `real_name_1` (str): Настоящее имя первого варианта.
- `real_name_2` (str): Настоящее имя второго варианта.
- `blind_name_a` (str): Имя первого варианта, представленное пользователю.
- `blind_name_b` (str): Имя второго варианта, представленное пользователю.
- `passtrough_name` (list): Список имен, которые не нужно рандомизировать и которые всегда возвращаются как есть.
- `random_seed` (int): Зерно для генератора случайных чисел.

**Принцип работы**:
Класс `ABRandomizer` инициализируется с реальными и "слепыми" именами для двух вариантов, а также списком имен, которые не должны быть рандомизированы. Метод `randomize` случайным образом меняет местами два варианта и сохраняет информацию об этом в словаре `choices`. Метод `derandomize` возвращает варианты в исходном порядке на основе информации, сохраненной в `choices`. Метод `derandomize_name` декодирует выбор, сделанный пользователем, и возвращает соответствующий реальный вариант.

### `Intervention`

**Описание**: Класс `Intervention` предназначен для определения и применения интервенций к агентам и средам.

**Атрибуты**:
- `agents` (list): Список агентов, к которым применяется интервенция.
- `environments` (list): Список сред, к которым применяется интервенция.
- `text_precondition` (str): Текстовое описание предусловия для применения интервенции.
- `precondition_func` (function): Функция, определяющая предусловие для применения интервенции.
- `effect_func` (function): Функция, определяющая эффект интервенции.

**Принцип работы**:
Класс `Intervention` инициализируется с агентами и/или средами, к которым будет применяться интервенция. Предусловия могут быть заданы как текстовое описание (`text_precondition`) или как функция (`precondition_func`). Эффект интервенции определяется функцией `effect_func`, которая применяется к агентам и средам при вызове метода `apply`.

## Методы класса `ABRandomizer`

### `__init__`

```python
def __init__(self, real_name_1="control", real_name_2="treatment",
                       blind_name_a="A", blind_name_b="B",
                       passtrough_name=[],
                       random_seed=42):
```

**Назначение**: Инициализирует экземпляр класса `ABRandomizer`.

**Параметры**:
- `real_name_1` (str): Настоящее имя первого варианта. По умолчанию "control".
- `real_name_2` (str): Настоящее имя второго варианта. По умолчанию "treatment".
- `blind_name_a` (str): Имя первого варианта, представленное пользователю. По умолчанию "A".
- `blind_name_b` (str): Имя второго варианта, представленное пользователю. По умолчанию "B".
- `passtrough_name` (list): Список имен, которые не нужно рандомизировать. По умолчанию пустой список.
- `random_seed` (int): Зерно для генератора случайных чисел. По умолчанию 42.

**Примеры**:

```python
randomizer = ABRandomizer(real_name_1="контроль", real_name_2="лечение", blind_name_a="A", blind_name_b="B", passtrough_name=["не_рандомизировать"], random_seed=123)
```

### `randomize`

```python
def randomize(self, i, a, b):
```

**Назначение**: Случайно меняет местами `a` и `b` и возвращает выбранные варианты.

**Параметры**:
- `i` (int): Индекс элемента.
- `a` (str): Первый вариант.
- `b` (str): Второй вариант.

**Возвращает**:
- `tuple[str, str]`: Кортеж из двух строк, представляющих рандомизированные варианты.

**Как работает функция**:
Функция `randomize` принимает индекс элемента `i` и два варианта `a` и `b`. Она использует генератор случайных чисел с фиксированным зерном (`self.random_seed`) для определения, следует ли менять местами варианты `a` и `b`. Если случайное число меньше 0.5, функция возвращает `a, b` без изменений и сохраняет `(0, 1)` в словаре `self.choices` для индекса `i`. В противном случае функция возвращает `b, a`, меняя варианты местами, и сохраняет `(1, 0)` в словаре `self.choices` для индекса `i`.

**Примеры**:

```python
randomizer = ABRandomizer()
a, b = randomizer.randomize(1, "вариант1", "вариант2")
print(f"Рандомизированные варианты: a={a}, b={b}")
```

### `derandomize`

```python
def derandomize(self, i, a, b):
```

**Назначение**: Возвращает варианты `a` и `b` в исходном порядке.

**Параметры**:
- `i` (int): Индекс элемента.
- `a` (str): Первый вариант.
- `b` (str): Второй вариант.

**Возвращает**:
- `tuple[str, str]`: Кортеж из двух строк, представляющих дерандомизированные варианты.

**Вызывает исключения**:
- `Exception`: Если для элемента `i` не найдена информация о рандомизации.

**Как работает функция**:
Функция `derandomize` принимает индекс элемента `i` и два варианта `a` и `b`. Она проверяет словарь `self.choices` для получения информации о том, как были рандомизированы варианты для элемента `i`. Если значение `self.choices[i]` равно `(0, 1)`, функция возвращает `a, b` без изменений. Если значение `self.choices[i]` равно `(1, 0)`, функция возвращает `b, a`, меняя варианты местами. Если для элемента `i` не найдена информация о рандомизации, функция вызывает исключение `Exception`.

**Примеры**:

```python
randomizer = ABRandomizer()
a, b = randomizer.randomize(1, "вариант1", "вариант2")
a, b = randomizer.derandomize(1, "вариант1", "вариант2")
print(f"Дерандомизированные варианты: a={a}, b={b}")
```

### `derandomize_name`

```python
def derandomize_name(self, i, blind_name):
```

**Назначение**: Декодирует выбор пользователя и возвращает соответствующий реальный вариант.

**Параметры**:
- `i` (int): Индекс элемента.
- `blind_name` (str): Выбор, сделанный пользователем.

**Возвращает**:
- `str`: Соответствующий реальный вариант.

**Вызывает исключения**:
- `Exception`: Если для элемента `i` не найдена информация о рандомизации или если выбор пользователя не распознан.

**Как работает функция**:
Функция `derandomize_name` принимает индекс элемента `i` и выбор пользователя `blind_name`. Она проверяет словарь `self.choices` для получения информации о том, как были рандомизированы варианты для элемента `i`. Если значение `self.choices[i]` равно `(0, 1)`, функция проверяет, соответствует ли `blind_name` значению `self.blind_name_a` или `self.blind_name_b`, и возвращает соответствующее реальное имя (`self.real_name_1` или `self.real_name_2`). Если значение `self.choices[i]` равно `(1, 0)`, функция выполняет аналогичную проверку, но возвращает противоположное реальное имя. Если для элемента `i` не найдена информация о рандомизации или если выбор пользователя не распознан, функция вызывает исключение `Exception`.

**Примеры**:

```python
randomizer = ABRandomizer(real_name_1="вариант1", real_name_2="вариант2", blind_name_a="A", blind_name_b="B")
randomizer.randomize(1, "A", "B")
real_name = randomizer.derandomize_name(1, "A")
print(f"Реальное имя: {real_name}")
```

## Методы класса `Intervention`

### `__init__`

```python
def __init__(self, agent=None, agents:list=None, environment=None, environments:list=None):
```

**Назначение**: Инициализирует экземпляр класса `Intervention`.

**Параметры**:
- `agent` (TinyPerson): Агент, к которому применяется интервенция.
- `agents` (list): Список агентов, к которым применяется интервенция.
- `environment` (TinyWorld): Среда, к которой применяется интервенция.
- `environments` (list): Список сред, к которым применяется интервенция.

**Вызывает исключения**:
- `Exception`: Если переданы одновременно `agent` и `agents` или `environment` и `environments`.
- `Exception`: Если не передан ни один из параметров (`agent`, `agents`, `environment`, `environments`).

**Как работает функция**:

Функция `__init__` инициализирует объект `Intervention`. Она принимает параметры `agent`, `agents`, `environment` и `environments`, которые представляют собой агентов и среды, к которым будет применена интервенция. Функция проверяет, чтобы не были переданы одновременно `agent` и `agents` или `environment` и `environments`, и чтобы хотя бы один из параметров был передан. Если эти условия не выполняются, функция вызывает исключение.

**Примеры**:

```python
# Пример 1: Создание интервенции для одного агента
agent = TinyPerson()
intervention = Intervention(agent=agent)

# Пример 2: Создание интервенции для списка агентов
agents = [TinyPerson(), TinyPerson()]
intervention = Intervention(agents=agents)
```

### `check_precondition`

```python
def check_precondition(self):
```

**Назначение**: Проверяет, выполнено ли предусловие для применения интервенции.

**Вызывает исключения**:
- `NotImplementedError`: Всегда вызывается, так как метод должен быть переопределен в подклассах.

**Как работает функция**:

Функция `check_precondition` проверяет, выполнено ли предусловие для применения интервенции. В текущей реализации функция всегда вызывает исключение `NotImplementedError`, указывая на то, что этот метод должен быть переопределен в подклассах для предоставления конкретной логики проверки предусловия.

**Примеры**:

```python
# Пример: Попытка вызова метода check_precondition
intervention = Intervention(agent=TinyPerson())
try:
    intervention.check_precondition()
except NotImplementedError as ex:
    print(f"Ошибка: {ex}")
```

### `apply`

```python
def apply(self):
```

**Назначение**: Применяет интервенцию.

**Как работает функция**:
Функция `apply` применяет эффект интервенции, вызывая функцию `self.effect_func` с аргументами `self.agents` и `self.environments`.

**Примеры**:

```python
def effect_func(agents, environments):
    print("Применение эффекта интервенции")

intervention = Intervention(agent=TinyPerson())
intervention.effect_func = effect_func
intervention.apply()
```

### `set_textual_precondition`

```python
def set_textual_precondition(self, text):
```

**Назначение**: Устанавливает предусловие в виде текста.

**Параметры**:
- `text` (str): Текст предусловия.

**Как работает функция**:

Функция `set_textual_precondition` устанавливает текстовое описание предусловия для применения интервенции. Это описание может быть использовано языковой моделью для определения, следует ли применять интервенцию.

**Примеры**:

```python
# Пример: Установка текстового предусловия
intervention = Intervention(agent=TinyPerson())
intervention.set_textual_precondition("Если агент находится в состоянии покоя")
print(f"Текстовое предусловие: {intervention.text_precondition}")
```

### `set_functional_precondition`

```python
def set_functional_precondition(self, func):
```

**Назначение**: Устанавливает предусловие в виде функции.

**Параметры**:
- `func` (function): Функция предусловия. Функция должна принимать аргументы: `agent`, `agents`, `environment`, `environments`.

**Как работает функция**:

Функция `set_functional_precondition` устанавливает функциональное предусловие для применения интервенции. Предоставленная функция будет вызываться для определения, следует ли применять интервенцию.

**Примеры**:

```python
# Пример: Установка функционального предусловия
def precondition_func(agent, agents, environment, environments):
    return agent.is_active()

intervention = Intervention(agent=TinyPerson())
intervention.set_functional_precondition(precondition_func)
print(f"Функциональное предусловие: {intervention.precondition_func}")
```

### `set_effect`

```python
def set_effect(self, effect_func):
```

**Назначение**: Устанавливает эффект интервенции.

**Параметры**:
- `effect_func` (function): Функция, определяющая эффект интервенции.

**Как работает функция**:

Функция `set_effect` устанавливает эффект интервенции, сохраняя предоставленную функцию в `self.effect_func`. Эта функция будет вызвана при применении интервенции.

**Примеры**:

```python
# Пример: Установка эффекта интервенции
def effect_func(agents, environments):
    for agent in agents:
        agent.increase_energy(10)

intervention = Intervention(agents=[TinyPerson()])
intervention.set_effect(effect_func)
print(f"Функция эффекта: {intervention.effect_func}")