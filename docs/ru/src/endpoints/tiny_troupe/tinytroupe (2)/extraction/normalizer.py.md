# Модуль нормализации текстовых элементов
================================================

Модуль предназначен для нормализации текстовых элементов, таких как пассажи, концепции и другие текстовые данные.
Он содержит класс `Normalizer`, который использует LLM для приведения различных входных элементов к небольшому набору нормализованных представлений.

Пример использования
----------------------

```python
normalizer = Normalizer(elements=['элемент1', 'элемент2'], n=2)
normalized_elements = normalizer.normalize(['элемент1', 'элемент3'])
```

## Оглавление

- [Обзор](#обзор)
- [Классы](#классы)
    - [Normalizer](#normalizer)
- [Функции](#функции)
    - [normalize](#normalize)

## Обзор

Модуль предоставляет класс `Normalizer`, который нормализует список текстовых элементов, используя LLM.
Нормализация выполняется на основе заданного количества выходных элементов `n`. Результаты нормализации кэшируются для повышения производительности.

## Подробнее

Модуль используется для унификации различных текстовых элементов к общему представлению, что полезно для анализа текста, поиска и других задач обработки естественного языка.
В основе нормализации лежит использование LLM для сопоставления входных элементов с предопределенным набором категорий.

## Классы

### `Normalizer`

**Описание**: Класс для нормализации текстовых элементов.

**Атрибуты**:

- `elements` (List[str]): Список элементов для нормализации.
- `n` (int): Количество нормализованных элементов для вывода.
- `verbose` (bool): Флаг для отображения отладочных сообщений.
- `normalized_elements` (dict): JSON-структура, где каждый выходной элемент является ключом к списку входных элементов, объединенных в него.
- `normalizing_map` (dict): Словарь, сопоставляющий каждый входной элемент с его нормализованным выводом (кэш).

**Методы**:

- `__init__`: Инициализирует класс `Normalizer`.
- `normalize`: Нормализует указанный элемент или элементы.

#### `__init__`

```python
def __init__(self, elements:List[str], n:int, verbose:bool=False):
    """
    Args:
        elements (list): Элементы для нормализации.
        n (int): Количество нормализованных элементов для вывода.
        verbose (bool, optional): Флаг для отображения отладочных сообщений. По умолчанию `False`.
    """
    ...
```

**Как работает класс**:

1.  **Инициализация**: Класс инициализируется списком элементов для нормализации, количеством нормализованных элементов, которые нужно вывести (`n`), и флагом `verbose` для отображения отладочных сообщений.
2.  **Уникальность элементов**: Убеждается, что все элементы уникальны, преобразуя список элементов во множество, а затем обратно в список.
3.  **Настройка LLM**:
    *   Формирует сообщения для LLM на основе шаблонов `normalizer.system.mustache` и `normalizer.user.mustache`.
    *   Отправляет сообщение в LLM для получения результатов нормализации.
4.  **Обработка результатов**: Извлекает JSON из ответа LLM и сохраняет его в `self.normalized_elements`.
    Этот результат представляет собой структуру, где каждый нормализованный элемент сопоставлен со списком исходных элементов, которые были в него объединены.
5.  **Кэширование**: Инициализирует пустой словарь `self.normalizing_map`, который будет использоваться в качестве кэша для хранения соответствий между исходными и нормализованными элементами. Это позволяет избежать повторных запросов к LLM для одних и тех же элементов.

**Примеры**:

```python
normalizer = Normalizer(elements=['элемент1', 'элемент2', 'элемент3'], n=2, verbose=True)
```

## Функции

### `normalize`

```python
def normalize(self, element_or_elements:Union[str, List[str]]) -> Union[str, List[str]]:
    """
    Args:
        element_or_elements (Union[str, List[str]]): Элемент или элементы для нормализации.

    Returns:
        str: Нормализованный элемент, если на входе была строка.
        list: Нормализованные элементы, если на входе был список, с сохранением порядка элементов входа.
    """
    ...
```

**Назначение**: Нормализует указанный элемент или элементы, используя кэш для повышения производительности.

**Параметры**:

- `element_or_elements` (Union[str, List[str]]): Элемент или список элементов для нормализации.

**Возвращает**:

- `Union[str, List[str]]`: Нормализованный элемент или список нормализованных элементов.

**Как работает функция**:

1.  **Обработка входных данных**: Функция принимает на вход либо один элемент в виде строки, либо список элементов. Если входные данные представлены строкой, они преобразуются в список, чтобы обеспечить единообразную обработку.
2.  **Кэширование**: Функция проверяет, есть ли уже нормализованные элементы в кэше (`self.normalizing_map`). Если элемент уже есть в кэше, он не отправляется на нормализацию повторно.
3.  **Подготовка к нормализации**: Для элементов, которых нет в кэше, формируется список `elements_to_normalize`.
4.  **Запрос к LLM**: Если есть элементы, требующие нормализации, формируется запрос к LLM с использованием шаблонов `normalizer.applier.system.mustache` и `normalizer.applier.user.mustache`.
    Результаты нормализации извлекаются из ответа LLM.
5.  **Обновление кэша**: Полученные нормализованные элементы добавляются в кэш `self.normalizing_map`.
6.  **Формирование результата**: Функция формирует список нормализованных элементов, используя значения из кэша.
7.  **Возврат результата**: Возвращается нормализованный элемент или список нормализованных элементов в зависимости от типа входных данных.

**Примеры**:

```python
normalizer = Normalizer(elements=['элемент1', 'элемент2', 'элемент3'], n=2)
normalized_element = normalizer.normalize('элемент1')
normalized_elements = normalizer.normalize(['элемент1', 'элемент4'])
```