# Модуль `factory.py`

## Обзор

Модуль `factory.py` предоставляет инструменты для создания агентов (TinyPerson) в рамках проекта `hypotez`. Он содержит классы `TinyFactory` и `TinyPersonFactory`, которые облегчают процесс создания и управления агентами, а также обеспечивают механизмы кэширования для оптимизации производительности.

## Подробней

Модуль содержит базовый класс `TinyFactory`, который служит основой для различных типов фабрик. Важной особенностью является возможность расширения системы, особенно в отношении кэширования транзакций. Также реализован класс `TinyPersonFactory`, который специализируется на создании экземпляров `TinyPerson` с использованием OpenAI LLM (Language Model).

## Классы

### `TinyFactory`

**Описание**:
Базовый класс для различных типов фабрик. Обеспечивает основу для расширения системы и управления кэшированием транзакций.

**Атрибуты**:

- `all_factories` (dict): Словарь всех созданных фабрик. Ключ - имя фабрики, значение - экземпляр фабрики.
- `name` (str): Уникальное имя фабрики.
- `simulation_id` (str, optional): ID симуляции, к которой принадлежит фабрика. По умолчанию `None`.

**Методы**:

- `__init__(self, simulation_id: str = None) -> None`
- `__repr__(self)`
- `set_simulation_for_free_factories(simulation)`
- `add_factory(factory)`
- `clear_factories()`
- `encode_complete_state() -> dict`
- `decode_complete_state(state: dict)`

#### `__init__(self, simulation_id: str = None) -> None`

**Назначение**:
Инициализирует экземпляр класса `TinyFactory`.

**Параметры**:
- `simulation_id` (str, optional): ID симуляции. По умолчанию `None`.

**Как работает функция**:
- Присваивает фабрике уникальное имя.
- Устанавливает ID симуляции.
- Добавляет фабрику в глобальный список фабрик (`TinyFactory.all_factories`).

#### `__repr__(self)`

**Назначение**:
Возвращает строковое представление объекта `TinyFactory`.

**Возвращает**:
- `str`: Строковое представление фабрики в формате "TinyFactory(name='factory_name')".

**Как работает функция**:
Форматирует строковое представление имени фабрики.

#### `set_simulation_for_free_factories(simulation)`

**Назначение**:
Устанавливает симуляцию для фабрик, у которых `simulation_id` равен `None`.

**Параметры**:
- `simulation` (obj): Объект симуляции.

**Как работает функция**:
Проходит по всем фабрикам и добавляет фабрики без simulation_id к указанной симуляции.

#### `add_factory(factory)`

**Назначение**:
Добавляет фабрику в список всех фабрик.

**Параметры**:
- `factory` (TinyFactory): Экземпляр фабрики для добавления.

**Вызывает исключения**:
- `ValueError`: Если фабрика с таким именем уже существует.

**Как работает функция**:
Проверяет уникальность имени фабрики и добавляет её в словарь `TinyFactory.all_factories`.

#### `clear_factories()`

**Назначение**:
Очищает глобальный список всех фабрик.

**Как работает функция**:
Обнуляет словарь `TinyFactory.all_factories`.

#### `encode_complete_state() -> dict`

**Назначение**:
Кодирует полное состояние фабрики.

**Возвращает**:
- `dict`: Словарь, представляющий состояние фабрики.

**Как работает функция**:
Создает глубокую копию словаря `__dict__`, содержащего состояние фабрики.

#### `decode_complete_state(state: dict)`

**Назначение**:
Декодирует полное состояние фабрики.

**Параметры**:
- `state` (dict): Словарь, представляющий состояние фабрики.

**Возвращает**:
- `TinyFactory`: Объект `TinyFactory` с восстановленным состоянием.

**Как работает функция**:
Обновляет словарь `__dict__` фабрики на основе предоставленного состояния.

### `TinyPersonFactory`

**Описание**:
Класс, специализирующийся на создании экземпляров `TinyPerson` с использованием OpenAI LLM.

**Наследует**:
- `TinyFactory`: Наследует базовый функционал фабрики.

**Атрибуты**:
- `person_prompt_template_path` (str): Путь к шаблону для генерации персонажей.
- `context_text` (str): Контекстный текст, используемый для генерации экземпляров `TinyPerson`.
- `generated_minibios` (list): Список сгенерированных мини-биографий персонажей.
- `generated_names` (list): Список сгенерированных имен персонажей.

**Методы**:
- `__init__(self, context_text, simulation_id: str = None)`
- `generate_person_factories(number_of_factories, generic_context_text)`
- `generate_person(agent_particularities: str = None, temperature: float = 1.5, attepmpts: int = 5)`
- `_aux_model_call(messages, temperature)`
- `_setup_agent(agent, configuration)`

#### `__init__(self, context_text, simulation_id: str = None)`

**Назначение**:
Инициализирует экземпляр класса `TinyPersonFactory`.

**Параметры**:
- `context_text` (str): Контекстный текст для генерации персонажей.
- `simulation_id` (str, optional): ID симуляции. По умолчанию `None`.

**Как работает функция**:
- Вызывает конструктор базового класса `TinyFactory`.
- Устанавливает путь к шаблону для генерации персонажей.
- Сохраняет контекстный текст.
- Инициализирует пустые списки для сгенерированных мини-биографий и имен.

#### `generate_person_factories(number_of_factories, generic_context_text)`

**Назначение**:
Генерирует список экземпляров `TinyPersonFactory` с использованием OpenAI LLM.

**Параметры**:
- `number_of_factories` (int): Количество экземпляров `TinyPersonFactory` для генерации.
- `generic_context_text` (str): Общий контекстный текст для генерации фабрик персонажей.

**Возвращает**:
- `list`: Список экземпляров `TinyPersonFactory`.

**Как работает функция**:
- Генерирует описание фабрики на основе контекста с использованием OpenAI LLM.
- Извлекает JSON из ответа LLM.
- Создает экземпляры `TinyPersonFactory` на основе извлеченных данных.

#### `generate_person(agent_particularities: str = None, temperature: float = 1.5, attepmpts: int = 5)`

**Назначение**:
Генерирует экземпляр `TinyPerson` с использованием OpenAI LLM.

**Параметры**:
- `agent_particularities` (str, optional): Особенности агента.
- `temperature` (float, optional): Температура для выборки из LLM. По умолчанию 1.5.
- `attepmpts` (int, optional): Количество попыток генерации. По умолчанию 5.

**Возвращает**:
- `TinyPerson`: Экземпляр `TinyPerson`, сгенерированный с использованием LLM.

**Как работает функция**:
- Генерирует спецификацию агента на основе контекста и особенностей с использованием OpenAI LLM.
- Проверяет уникальность имени агента.
- Создает экземпляр `TinyPerson` на основе сгенерированной спецификации.

**Внутренние функции**:

##### `aux_generate()`

**Назначение**:
Вспомогательная функция для генерации агента.

**Как работает функция**:
- Отправляет запрос в OpenAI LLM для генерации спецификации агента.
- Извлекает JSON из ответа LLM.
- Проверяет, не было ли имя агента сгенерировано ранее.

#### `_aux_model_call(self, messages, temperature)`

**Назначение**:
Вспомогательный метод для выполнения вызова модели.

**Параметры**:
- `messages` (list): Список сообщений для отправки в модель.
- `temperature` (float): Температура для выборки из LLM.

**Возвращает**:
- Ответ от OpenAI API.

**Как работает функция**:
Отправляет сообщения в OpenAI API и возвращает результат. Используется декоратор `@transactional` для кэширования результатов.

#### `_setup_agent(self, agent, configuration)`

**Назначение**:
Настраивает агента с необходимыми элементами.

**Параметры**:
- `agent` (TinyPerson): Экземпляр агента для настройки.
- `configuration` (dict): Словарь конфигурации агента.

**Как работает функция**:
Определяет параметры агента на основе предоставленной конфигурации. Используется декоратор `@transactional` для кэширования результатов.

## Примеры

Пример создания `TinyPersonFactory` и генерации `TinyPerson`:

```python
from tinytroupe.factory import TinyPersonFactory

# Создание фабрики персонажей с контекстом
factory = TinyPersonFactory(context_text="Действие происходит в средневековом замке.")

# Генерация персонажа с определенными особенностями
person = factory.generate_person(agent_particularities="Храбрый рыцарь, защитник королевства.")

if person:
    print(f"Сгенерирован персонаж: {person.get('name')}")
else:
    print("Не удалось сгенерировать персонажа.")