# Модуль управления симуляцией

## Обзор

Модуль `control.py` предоставляет механизмы управления симуляциями в проекте `tinytroupe`. Он включает классы и функции для запуска, остановки, сохранения состояния симуляции, а также для управления транзакциями и кэшированием.

## Подробнее

Модуль содержит классы `Simulation` и `Transaction`, а также набор вспомогательных функций для управления состоянием симуляции. Класс `Simulation` отвечает за управление агентами, средами и фабриками, а также за кэширование состояний симуляции для повышения производительности. Класс `Transaction` обеспечивает выполнение функций в контексте транзакции, что позволяет обеспечить консистентность состояния симуляции.

## Классы

### `Simulation`

**Описание**: Класс для управления симуляцией, включая агентов, среды и фабрики.

**Атрибуты**:

- `id` (str): Идентификатор симуляции. По умолчанию "default".
- `agents` (list): Список агентов в симуляции.
- `name_to_agent` (dict): Словарь, сопоставляющий имена агентов с их экземплярами.
- `environments` (list): Список сред в симуляции.
- `factories` (list): Список фабрик в симуляции.
- `name_to_factory` (dict): Словарь, сопоставляющий имена фабрик с их экземплярами.
- `name_to_environment` (dict): Словарь, сопоставляющий имена сред с их экземплярами.
- `status` (str): Статус симуляции ("stopped" или "started").
- `cache_path` (str): Путь к файлу кэша.
- `auto_checkpoint` (bool): Флаг автоматического сохранения состояния после каждой транзакции.
- `has_unsaved_cache_changes` (bool): Флаг, указывающий на наличие несохраненных изменений в кэше.
- `_under_transaction` (bool): Флаг, указывающий на то, что симуляция находится в состоянии транзакции.
- `cached_trace` (list): Список состояний симуляции, используемых для кэширования.
- `cache_misses` (int): Количество промахов кэша.
- `cache_hits` (int): Количество попаданий в кэш.
- `execution_trace` (list): Список состояний выполнения симуляции.

**Методы**:

- `__init__(self, id="default", cached_trace:list=None)`: Инициализирует новый экземпляр класса `Simulation`.
- `begin(self, cache_path:str=None, auto_checkpoint:bool=False)`: Отмечает начало управляемой симуляции.
- `end(self)`: Отмечает конец управляемой симуляции.
- `checkpoint(self)`: Сохраняет текущее состояние симуляции в файл.
- `add_agent(self, agent)`: Добавляет агента в симуляцию.
- `add_environment(self, environment)`: Добавляет среду в симуляцию.
- `add_factory(self, factory)`: Добавляет фабрику в симуляцию.
- `_execution_trace_position(self) -> int`: Возвращает текущую позицию в трассе выполнения, или -1, если трасса выполнения пуста.
- `_function_call_hash(self, function_name, *args, **kwargs) -> int`: Вычисляет хеш заданного вызова функции.
- `_skip_execution_with_cache(self)`: Пропускает текущее выполнение, предполагая, что в той же позиции есть кэшированное состояние.
- `_is_transaction_event_cached(self, event_hash) -> bool`: Проверяет, соответствует ли заданный хеш события соответствующему кэшированному хешу, если таковой имеется.
- `_drop_cached_trace_suffix(self)`: Удаляет суффикс кэшированной трассы, начиная с текущей позиции трассы выполнения.
- `_add_to_execution_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в список execution_trace и вычисляет соответствующий хеш.
- `_add_to_cache_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в список cached_trace и вычисляет соответствующий хеш.
- `_load_cache_file(self, cache_path:str)`: Загружает файл кэша из заданного пути.
- `_save_cache_file(self, cache_path:str)`: Сохраняет файл кэша по заданному пути. Всегда перезаписывает.
- `begin_transaction(self)`: Начинает транзакцию.
- `end_transaction(self)`: Завершает транзакцию.
- `is_under_transaction(self)`: Проверяет, находится ли агент в транзакции.
- `_clear_communications_buffers(self)`: Очищает буферы связи всех агентов и сред.
- `_encode_simulation_state(self) -> dict`: Кодирует текущее состояние симуляции, включая агентов, среды и другую важную информацию.
- `_decode_simulation_state(self, state: dict)`: Декодирует заданное состояние симуляции, включая агентов, среды и другую важную информацию.

#### `__init__`
```python
 def __init__(self, id="default", cached_trace:list=None):
    """
    Инициализирует новый экземпляр класса `Simulation`.

    Args:
        id (str, optional): Идентификатор симуляции. По умолчанию "default".
        cached_trace (list, optional): Список состояний симуляции, используемых для кэширования. По умолчанию `None`.
    """
```
Функция инициализирует объект класса `Simulation`. Она задает идентификатор симуляции, инициализирует списки для хранения агентов, сред и фабрик, а также словари для быстрого доступа к ним по имени. Также устанавливает статус симуляции в "stopped", определяет путь к файлу кэша и инициализирует другие параметры, связанные с кэшированием и транзакциями.
В конце функция инициализирует `cached_trace` списком состояний симуляции, используемых для кэширования. Если `cached_trace` не передан в качестве аргумента, то инициализирует пустой список.

#### `begin`
```python
def begin(self, cache_path:str=None, auto_checkpoint:bool=False):
    """
    Отмечает начало управляемой симуляции.

    Args:
        cache_path (str, optional): Путь к файлу кэша. Если не указан, используется путь по умолчанию, определенный в классе.
        auto_checkpoint (bool, optional): Флаг автоматического сохранения состояния после каждой транзакции. По умолчанию `False`.

    Raises:
        ValueError: Если симуляция уже запущена.
    """
```
Функция начинает симуляцию. Она устанавливает статус симуляции в "started", очищает списки агентов, сред и фабрик, сбрасывает счетчик идентификаторов и загружает файл кэша, если он существует.
Если `cache_path` не указан, функция использует путь по умолчанию, определенный в классе. Если `auto_checkpoint` установлен в `True`, функция будет автоматически сохранять состояние симуляции после каждой транзакции.

Внутри функция выполняет следующие действия:

1.  Проверяет статус симуляции и выбрасывает исключение `ValueError`, если симуляция уже запущена.
2.  Устанавливает путь к файлу кэша, если он указан.
3.  Устанавливает флаг автоматического сохранения состояния.
4.  Очищает списки агентов, сред и фабрик, используя статические методы `clear_agents()`, `clear_environments()` и `clear_factories()` соответствующих классов.
5.  Сбрасывает счетчик идентификаторов, используя функцию `utils.reset_fresh_id()`.
6.  Загружает файл кэша, если он существует, вызывая метод `_load_cache_file()`.

#### `end`
```python
def end(self):
    """
    Отмечает конец управляемой симуляции.

    Raises:
        ValueError: Если симуляция уже остановлена.
    """
```
Функция завершает симуляцию. Она устанавливает статус симуляции в "stopped" и сохраняет состояние симуляции в файл.
Если симуляция не была запущена, функция выбрасывает исключение `ValueError`.
Внутри функция выполняет следующие действия:

1.  Проверяет статус симуляции и выбрасывает исключение `ValueError`, если симуляция уже остановлена.
2.  Устанавливает статус симуляции в "stopped".
3.  Сохраняет состояние симуляции в файл, вызывая метод `checkpoint()`.

#### `checkpoint`
```python
def checkpoint(self):
    """
    Сохраняет текущее состояние симуляции в файл.
    """
```
Функция сохраняет текущее состояние симуляции в файл. Она вызывает метод `_save_cache_file()`, если есть несохраненные изменения в кэше.
Если нет несохраненных изменений, функция просто записывает сообщение в лог.
Внутри функция выполняет следующие действия:

1.  Проверяет флаг `has_unsaved_cache_changes`.
2.  Если флаг установлен, вызывает метод `_save_cache_file()` для сохранения состояния симуляции в файл.
3.  Если флаг не установлен, записывает сообщение в лог.

#### `add_agent`
```python
def add_agent(self, agent):
    """
    Добавляет агента в симуляцию.

    Args:
        agent: Экземпляр агента, который необходимо добавить в симуляцию.

    Raises:
        ValueError: Если имя агента уже существует в симуляции.
    """
```
Функция добавляет агента в симуляцию. Она проверяет, не существует ли уже агент с таким же именем, и добавляет агента в списки `agents` и `name_to_agent`.
Если агент с таким же именем уже существует, функция выбрасывает исключение `ValueError`.
Внутри функция выполняет следующие действия:

1.  Проверяет, существует ли уже агент с таким же именем в словаре `name_to_agent`.
2.  Если агент с таким же именем уже существует, выбрасывает исключение `ValueError`.
3.  Устанавливает идентификатор симуляции для агента.
4.  Добавляет агента в список `agents`.
5.  Добавляет агента в словарь `name_to_agent`.

#### `add_environment`
```python
def add_environment(self, environment):
    """
    Добавляет среду в симуляцию.

    Args:
        environment: Экземпляр среды, которую необходимо добавить в симуляцию.

    Raises:
        ValueError: Если имя среды уже существует в симуляции.
    """
```
Функция добавляет среду в симуляцию. Она проверяет, не существует ли уже среда с таким же именем, и добавляет среду в списки `environments` и `name_to_environment`.
Если среда с таким же именем уже существует, функция выбрасывает исключение `ValueError`.
Внутри функция выполняет следующие действия:

1.  Проверяет, существует ли уже среда с таким же именем в словаре `name_to_environment`.
2.  Если среда с таким же именем уже существует, выбрасывает исключение `ValueError`.
3.  Устанавливает идентификатор симуляции для среды.
4.  Добавляет среду в список `environments`.
5.  Добавляет среду в словарь `name_to_environment`.

#### `add_factory`
```python
def add_factory(self, factory):
    """
    Добавляет фабрику в симуляцию.

    Args:
        factory: Экземпляр фабрики, которую необходимо добавить в симуляцию.

    Raises:
        ValueError: Если имя фабрики уже существует в симуляции.
    """
```
Функция добавляет фабрику в симуляцию. Она проверяет, не существует ли уже фабрика с таким же именем, и добавляет фабрику в списки `factories` и `name_to_factory`.
Если фабрика с таким же именем уже существует, функция выбрасывает исключение `ValueError`.
Внутри функция выполняет следующие действия:

1.  Проверяет, существует ли уже фабрика с таким же именем в словаре `name_to_factory`.
2.  Если фабрика с таким же именем уже существует, выбрасывает исключение `ValueError`.
3.  Устанавливает идентификатор симуляции для фабрики.
4.  Добавляет фабрику в список `factories`.
5.  Добавляет фабрику в словарь `name_to_factory`.

#### `_execution_trace_position`
```python
def _execution_trace_position(self) -> int:
    """
    Возвращает текущую позицию в трассе выполнения, или -1, если трасса выполнения пуста.

    Returns:
        int: Индекс последнего элемента в списке `execution_trace` или -1, если список пуст.
    """
```
Функция возвращает текущую позицию в трассе выполнения. Если трасса выполнения пуста, функция возвращает -1.
Внутри функция вычисляет индекс последнего элемента в списке `execution_trace` и возвращает его.

#### `_function_call_hash`
```python
def _function_call_hash(self, function_name, *args, **kwargs) -> int:
    """
    Вычисляет хеш заданного вызова функции.

    Args:
        function_name: Имя вызываемой функции.
        *args: Позиционные аргументы, переданные в функцию.
        **kwargs: Именованные аргументы, переданные в функцию.

    Returns:
        int: Хеш вызова функции.
    """
```
Функция вычисляет хеш заданного вызова функции. Она объединяет имя функции, позиционные аргументы и именованные аргументы в строку и вычисляет хеш этой строки.
Внутри функция выполняет следующие действия:

1.  Создает строку, объединяющую имя функции, позиционные аргументы и именованные аргументы.
2.  Вычисляет хеш этой строки.
3.  Возвращает хеш.

#### `_skip_execution_with_cache`
```python
def _skip_execution_with_cache(self):
    """
    Пропускает текущее выполнение, предполагая, что в той же позиции есть кэшированное состояние.

    Raises:
        AssertionError: Если в текущей позиции трассы выполнения нет кэшированного состояния.
    """
```
Функция пропускает текущее выполнение, предполагая, что в той же позиции есть кэшированное состояние. Она добавляет кэшированное состояние в трассу выполнения.
Если в текущей позиции трассы выполнения нет кэшированного состояния, функция выбрасывает исключение `AssertionError`.
Внутри функция выполняет следующие действия:

1.  Проверяет, существует ли кэшированное состояние в текущей позиции трассы выполнения.
2.  Если кэшированное состояние не существует, выбрасывает исключение `AssertionError`.
3.  Добавляет кэшированное состояние в трассу выполнения.

#### `_is_transaction_event_cached`
```python
def _is_transaction_event_cached(self, event_hash) -> bool:
    """
    Проверяет, соответствует ли заданный хеш события соответствующему кэшированному хешу, если таковой имеется.
    Если соответствующего кэшированного состояния нет, возвращает `True`.

    Args:
        event_hash: Хеш события, которое необходимо проверить.

    Returns:
        bool: `True`, если хеш события соответствует кэшированному хешу или если соответствующего кэшированного состояния нет.
              `False`, если хеш события не соответствует кэшированному хешу.
    """
```
Функция проверяет, соответствует ли заданный хеш события соответствующему кэшированному хешу, если таковой имеется. Если соответствующего кэшированного состояния нет, функция возвращает `True`.
Внутри функция выполняет следующие действия:

1.  Проверяет, существует ли кэшированное состояние в текущей позиции трассы выполнения.
2.  Если кэшированное состояние не существует, возвращает `True`.
3.  Проверяет, соответствует ли хеш события хешу события в кэшированном состоянии.
4.  Если хеши событий не совпадают, возвращает `False`.
5.  Проверяет, соответствует ли хеш предыдущего состояния хешу предыдущего состояния в кэшированном состоянии.
6.  Если хеши предыдущих состояний не совпадают, возвращает `False`.
7.  Возвращает `True`.

#### `_drop_cached_trace_suffix`
```python
def _drop_cached_trace_suffix(self):
    """
    Удаляет суффикс кэшированной трассы, начиная с текущей позиции трассы выполнения.
    Это эффективно обновляет кэш до текущего состояния выполнения и начинает строить новый кэш с этого места.
    """
```
Функция удаляет суффикс кэшированной трассы, начиная с текущей позиции трассы выполнения. Это эффективно обновляет кэш до текущего состояния выполнения и начинает строить новый кэш с этого места.
Внутри функция усекает список `cached_trace` до текущей позиции трассы выполнения.

#### `_add_to_execution_trace`
```python
def _add_to_execution_trace(self, state: dict, event_hash: int, event_output):
    """
    Добавляет состояние в список execution_trace и вычисляет соответствующий хеш.
    Вычисленный хеш сравнивается с хешем кэшированной трассы в той же позиции,
    и если они не совпадают, выполнение прерывается. Аналогично, event_hash сравнивается
    с хешем события в кэшированной трассе в той же позиции, и если они не совпадают, выполнение
    прерывается.

    Args:
        state (dict): Состояние, которое необходимо добавить в трассу выполнения.
        event_hash (int): Хеш события, которое привело к этому состоянию.
        event_output: Выходные данные события.
    """
```
Функция добавляет состояние в список `execution_trace` и вычисляет соответствующий хеш.
Вычисленный хеш сравнивается с хешем кэшированной трассы в той же позиции, и если они не совпадают, выполнение прерывается. Аналогично, `event_hash` сравнивается с хешем события в кэшированной трассе в той же позиции, и если они не совпадают, выполнение прерывается.
Внутри функция выполняет следующие действия:

1.  Вычисляет хеш предыдущего состояния, если оно существует.
2.  Создает кортеж, содержащий хеш предыдущего состояния, хеш события и состояние.
3.  Добавляет кортеж в список `execution_trace`.

#### `_add_to_cache_trace`
```python
def _add_to_cache_trace(self, state: dict, event_hash: int, event_output):
    """
    Добавляет состояние в список cached_trace и вычисляет соответствующий хеш.

    Args:
        state (dict): Состояние, которое необходимо добавить в кэшированную трассу.
        event_hash (int): Хеш события, которое привело к этому состоянию.
        event_output: Выходные данные события.
    """
```
Функция добавляет состояние в список `cached_trace` и вычисляет соответствующий хеш.
Внутри функция выполняет следующие действия:

1.  Вычисляет хеш предыдущего состояния, если оно существует.
2.  Создает кортеж, содержащий хеш предыдущего состояния, хеш события и состояние.
3.  Добавляет кортеж в список `cached_trace`.
4.  Устанавливает флаг `has_unsaved_cache_changes` в `True`.

#### `_load_cache_file`
```python
def _load_cache_file(self, cache_path:str):
    """
    Загружает файл кэша из заданного пути.

    Args:
        cache_path (str): Путь к файлу кэша.
    """
```
Функция загружает файл кэша из заданного пути.
Внутри функция выполняет следующие действия:

1.  Пытается открыть файл кэша и загрузить его содержимое в список `cached_trace`.
2.  Если файл не найден, записывает сообщение в лог и инициализирует `cached_trace` пустым списком.

#### `_save_cache_file`
```python
def _save_cache_file(self, cache_path:str):
    """
    Сохраняет файл кэша по заданному пути. Всегда перезаписывает.

    Args:
        cache_path (str): Путь к файлу кэша.
    """
```
Функция сохраняет файл кэша по заданному пути. Всегда перезаписывает.
Внутри функция выполняет следующие действия:

1.  Пытается открыть временный файл и сохранить в него содержимое списка `cached_trace`.
2.  Заменяет исходный файл кэша временным файлом.
3.  Устанавливает флаг `has_unsaved_cache_changes` в `False`.

#### `begin_transaction`
```python
def begin_transaction(self):
    """
    Начинает транзакцию.
    """
```
Функция начинает транзакцию. Она устанавливает флаг `_under_transaction` в `True` и очищает буферы связи агентов и сред.
Внутри функция выполняет следующие действия:

1.  Устанавливает флаг `_under_transaction` в `True`.
2.  Очищает буферы связи агентов и сред, вызывая метод `_clear_communications_buffers()`.

#### `end_transaction`
```python
def end_transaction(self):
    """
    Завершает транзакцию.
    """
```
Функция завершает транзакцию. Она устанавливает флаг `_under_transaction` в `False`.
Внутри функция устанавливает флаг `_under_transaction` в `False`.

#### `is_under_transaction`
```python
def is_under_transaction(self):
    """
    Проверяет, находится ли агент в транзакции.
    """
```
Функция проверяет, находится ли агент в транзакции. Она возвращает значение флага `_under_transaction`.

#### `_clear_communications_buffers`
```python
def _clear_communications_buffers(self):
    """
    Очищает буферы связи всех агентов и сред.
    """
```
Функция очищает буферы связи всех агентов и сред. Она перебирает все агенты и среды в симуляции и вызывает метод `clear_communications_buffer()` для каждого из них.

#### `_encode_simulation_state`
```python
def _encode_simulation_state(self) -> dict:
    """
    Кодирует текущее состояние симуляции, включая агентов, среды и другую важную информацию.
    """
```
Функция кодирует текущее состояние симуляции, включая агентов, среды и другую важную информацию.
Внутри функция выполняет следующие действия:

1.  Создает словарь `state`.
2.  Перебирает всех агентов в симуляции и добавляет закодированное состояние каждого агента в список `state["agents"]`.
3.  Перебирает все среды в симуляции и добавляет закодированное состояние каждой среды в список `state["environments"]`.
4.  Перебирает все фабрики в симуляции и добавляет закодированное состояние каждой фабрики в список `state["factories"]`.
5.  Возвращает словарь `state`.

#### `_decode_simulation_state`
```python
def _decode_simulation_state(self, state: dict):
    """
    Декодирует заданное состояние симуляции, включая агентов, среды и другую важную информацию.

    Args:
        state (dict): Состояние, которое необходимо декодировать.
    """
```
Функция декодирует заданное состояние симуляции, включая агентов, среды и другую важную информацию.
Внутри функция выполняет следующие действия:

1.  Перебирает все закодированные состояния фабрик в списке `state["factories"]`.
2.  Для каждого закодированного состояния фабрики получает соответствующую фабрику из словаря `self.name_to_factory` и вызывает метод `decode_complete_state()` для декодирования состояния фабрики.
3.  Перебирает все закодированные состояния сред в списке `state["environments"]`.
4.  Для каждого закодированного состояния среды получает соответствующую среду из словаря `self.name_to_environment` и вызывает метод `decode_complete_state()` для декодирования состояния среды.
5.  Перебирает все закодированные состояния агентов в списке `state["agents"]`.
6.  Для каждого закодированного состояния агента получает соответствующего агента из словаря `self.name_to_agent` и вызывает метод `decode_complete_state()` для декодирования состояния агента.

### `Transaction`

**Описание**: Класс для управления транзакциями в симуляции.

**Атрибуты**:

- `obj_under_transaction`: Объект, над которым выполняется транзакция.
- `simulation`: Симуляция, в которой выполняется транзакция.
- `function_name` (str): Имя функции, выполняемой в транзакции.
- `function`: Функция, выполняемая в транзакции.
- `args` (tuple): Позиционные аргументы, переданные в функцию.
- `kwargs` (dict): Именованные аргументы, переданные в функцию.

**Методы**:

- `__init__(self, obj_under_transaction, simulation, function, *args, **kwargs)`: Инициализирует новый экземпляр класса `Transaction`.
- `execute(self)`: Выполняет транзакцию.
- `_encode_function_output(self, output) -> dict`: Кодирует заданный вывод функции.
- `_decode_function_output(self, encoded_output: dict)`: Декодирует заданный закодированный вывод функции.

#### `__init__`
```python
def __init__(self, obj_under_transaction, simulation, function, *args, **kwargs):
    """
    Инициализирует новый экземпляр класса `Transaction`.

    Args:
        obj_under_transaction: Объект, над которым выполняется транзакция.
        simulation: Симуляция, в которой выполняется транзакция.
        function: Функция, выполняемая в транзакции.
        *args: Позиционные аргументы, переданные в функцию.
        **kwargs: Именованные аргументы, переданные в функцию.
    """
```
Функция инициализирует объект класса `Transaction`. Она сохраняет переданные аргументы в атрибутах объекта и выполняет дополнительные действия в зависимости от типа объекта `obj_under_transaction`.
Если `simulation` не равен `None`, функция проверяет, захвачен ли уже объект `obj_under_transaction` другой симуляцией. Если объект не захвачен, функция добавляет его в симуляцию, вызывая соответствующие методы `add_agent()`, `add_environment()` или `add_factory()` класса `Simulation`.

#### `execute`
```python
def execute(self):
    """
    Выполняет транзакцию.
    """
```
Функция выполняет транзакцию. Она проверяет, запущена ли симуляция, и выполняет функцию `self.function` с заданными аргументами. Если симуляция запущена, функция использует механизм кэширования для повышения производительности.
Внутри функция выполняет следующие действия:

1.  Проверяет статус симуляции.
2.  Если симуляция не запущена, выполняет функцию `self.function` и возвращает результат.
3.  Если симуляция запущена, вычисляет хеш вызова функции.
4.  Проверяет, существует ли кэшированное состояние для данного хеша.
5.  Если кэшированное состояние существует, восстанавливает состояние симуляции из кэша и возвращает кэшированный результат.
6.  Если кэшированное состояние не существует, выполняет функцию `self.function`, кодирует результат и состояние симуляции, добавляет их в кэш и возвращает результат.

#### `_encode_function_output`
```python
def _encode_function_output(self, output) -> dict:
    """
    Кодирует заданный вывод функции.
    """
```
Функция кодирует заданный вывод функции для сохранения в кэше. Она проверяет тип вывода и выполняет соответствующие действия для кодирования.
Внутри функция выполняет следующие действия:

1.  Проверяет, является ли вывод `None`. Если да, возвращает `None`.
2.  Проверяет, является ли вывод экземпляром класса `TinyPerson`. Если да, возвращает словарь, содержащий тип объекта и его имя.
3.  Проверяет, является ли вывод экземпляром класса `TinyWorld`. Если да, возвращает словарь, содержащий тип объекта и его имя.
4.  Проверяет, является ли вывод экземпляром класса `TinyFactory`. Если да, возвращает словарь, содержащий тип объекта и его имя.
5.  Проверяет, является ли вывод одним из типов, поддерживаемых JSON (int, float, str, bool, list, dict, tuple). Если да, возвращает словарь, содержащий тип объекта и его значение.
6.  Если тип вывода не поддерживается, выбрасывает исключение `ValueError`.

#### `_decode_function_output`
```python
def _decode_function_output(self, encoded_output: dict):
    """
    Декодирует заданный закодированный вывод функции.
    """
```
Функция декодирует заданный закодированный вывод функции, полученный из кэша. Она проверяет тип закодированного вывода и выполняет соответствующие действия для декодирования.
Внутри функция выполняет следующие действия:

1.  Проверяет, является ли закодированный вывод `None`. Если да, возвращает `None`.
2.  Проверяет, является ли закодированный вывод ссылкой на `TinyPerson`. Если да, получает экземпляр `TinyPerson` по имени и возвращает его.
3.  Проверяет, является ли закодированный вывод ссылкой на `TinyWorld`. Если да, получает экземпляр `TinyWorld` по имени и возвращает его.
4.  Проверяет, является ли закодированный вывод ссылкой на `TinyFactory`. Если да, получает экземпляр `TinyFactory` по имени и возвращает его.
5.  Проверяет, является ли закодированный вывод JSON-значением. Если да, возвращает значение.
6.  Если тип закодированного вывода не поддерживается, выбрасывает исключение `ValueError`.

### `transactional`

```python
def transactional(func):
    """
    Декоратор, который делает функцию транзакционной для симуляции.
    """
```
Декоратор, который оборачивает функцию в транзакцию. Он создает объект `Transaction` и вызывает метод `execute()` для выполнения транзакции.

### `SkipTransaction`
```python
class SkipTransaction(Exception):
    pass
```

**Описание**: Исключение, используемое для прерывания транзакции.

### `CacheOutOfSync`
```python
class CacheOutOfSync(Exception):
    """
    Возникает, когда кэшированные и соответствующие свежевыполненные элементы не синхронизированы.
    """
```

**Описание**: Исключение, возникающее, когда кэшированные и соответствующие свежевыполненные элементы не синхронизированы.

### `ExecutionCached`
```python
class ExecutionCached(Exception):
    """
    Возникает, когда предложенное выполнение уже кэшировано.
    """
```

**Описание**: Исключение, возникающее, когда предложенное выполнение уже кэшировано.

## Функции

### `reset`

```python
def reset():
    """ 
    Сбрасывает все состояние управления симуляцией.
    """
```
Функция сбрасывает все состояние управления симуляцией. Она инициализирует глобальные переменные `_current_simulations` и `_current_simulation_id`.

### `_simulation`

```python
def _simulation(id="default"):
    """
    Возвращает текущую симуляцию.
    """
```

**Назначение**: Возвращает текущую симуляцию или создает новую, если она не существует.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию "default".

**Возвращает**:
- Экземпляр класса `Simulation`.

### `begin`

```python
def begin(cache_path=None, id="default", auto_checkpoint=False):
    """
    Отмечает начало управляемой симуляции.
    """
```

**Назначение**: Начинает симуляцию с заданными параметрами.

**Параметры**:
- `cache_path` (str, optional): Путь к файлу кэша.
- `id` (str, optional): Идентификатор симуляции. По умолчанию "default".
- `auto_checkpoint` (bool, optional): Флаг автоматического сохранения состояния после каждой транзакции. По умолчанию `False`.

**Вызывает исключения**:
- `ValueError`: Если симуляция уже запущена.

### `end`

```python
def end(id="default"):
    """
    Отмечает конец управляемой симуляции.
    """
```

**Назначение**: Завершает симуляцию.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию "default".

### `checkpoint`

```python
def checkpoint(id="default"):
    """
    Сохраняет текущее состояние симуляции.
    """
```

**Назначение**: Сохраняет текущее состояние симуляции в файл.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию "default".

### `current_simulation`

```python
def current_simulation():
    """
    Возвращает текущую симуляцию.
    """
```

**Назначение**: Возвращает текущую симуляцию.

**Возвращает**:
- Экземпляр класса `Simulation` или `None`, если симуляция не запущена.

### `cache_hits`

```python
def cache_hits(id="default"):
    """
    Возвращает количество попаданий в кэш.
    """
```

**Назначение**: Возвращает количество попаданий в кэш для заданной симуляции.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию "default".

**Возвращает**:
- Количество попаданий в кэш.

### `cache_misses`