# Модуль `grounding.py`

## Обзор

Модуль `grounding.py` предоставляет инструменты для подключения агента к внешним источникам знаний, таким как файлы, веб-страницы и базы данных. Он содержит абстрактный класс `GroundingConnector` и его реализации, использующие семантический поиск для извлечения релевантной информации. Модуль позволяет агенту "заземлять" свои знания, основываясь на внешних данных.

## Подробнее

Модуль определяет базовые классы для подключения к различным источникам данных и извлечения из них информации. Это позволяет агентам расширять свои знания, используя внешние ресурсы. В частности, реализована поддержка семантического поиска на основе библиотеки LLaMa-Index, что позволяет находить документы, релевантные запросу пользователя.

## Классы

### `GroundingConnector`

**Описание**: Абстрактный класс, представляющий коннектор для "заземления" знаний агента. Позволяет агенту получать доступ к внешним источникам, таким как файлы, веб-страницы, базы данных и т.д.

**Атрибуты**:
- `name` (str): Имя коннектора.

**Методы**:
- `retrieve_relevant(relevance_target: str, source: str, top_k: int = 20) -> list`:
    - **Назначение**: Извлекает все значения из памяти, релевантные заданной цели.
    - **Параметры**:
        - `relevance_target` (str): Цель релевантности.
        - `source` (str): Источник данных.
        - `top_k` (int, optional): Количество извлекаемых элементов. По умолчанию `20`.
    - **Возвращает**:
        - `list`: Список релевантных значений.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если метод не реализован в подклассе.
- `retrieve_by_name(name: str) -> str`:
    - **Назначение**: Извлекает источник контента по его имени.
    - **Параметры**:
        - `name` (str): Имя источника контента.
    - **Возвращает**:
        - `str`: Источник контента.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если метод не реализован в подклассе.
- `list_sources() -> list`:
    - **Назначение**: Перечисляет имена доступных источников контента.
    - **Параметры**:
        - `None`
    - **Возвращает**:
        - `list`: Список имен источников контента.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если метод не реализован в подклассе.

### `BaseSemanticGroundingConnector`

**Описание**: Базовый класс для семантических коннекторов. Индексирует и извлекает документы на основе семантического поиска (поиска на основе embeddings). Использует класс `VectorStoreIndex` из библиотеки `LLaMa-Index`.

**Наследует**: `GroundingConnector`

**Атрибуты**:
- `documents` (list): Список документов для индексации.
- `name_to_document` (dict): Словарь, сопоставляющий имена документов с самими документами.

**Методы**:
- `__init__(self, name: str = "Semantic Grounding") -> None`:
    - **Назначение**: Инициализирует экземпляр класса `BaseSemanticGroundingConnector`.
    - **Параметры**:
        - `name` (str, optional): Имя коннектора. По умолчанию "Semantic Grounding".
    - **Как работает функция**:
        - Вызывает конструктор базового класса `GroundingConnector` с переданным именем.
        - Инициализирует атрибуты `documents` и `name_to_document` значениями `None`.
- `_post_init(self)`:
    - **Назначение**: Выполняет постобработку после инициализации, так как класс имеет декоратор `@post_init`.
    - **Как работает функция**:
        - Инициализирует атрибут `index` значением `None`.
        - Если атрибуты `documents` или `name_to_document` не определены или равны `None`, то они инициализируются пустыми списками и словарями соответственно.
        - Вызывает метод `add_documents` для добавления документов.
- `retrieve_relevant(self, relevance_target: str, top_k: int = 20) -> list`:
    - **Назначение**: Извлекает все значения из памяти, релевантные заданной цели.
    - **Параметры**:
        - `relevance_target` (str): Цель релевантности.
        - `top_k` (int, optional): Количество извлекаемых элементов. По умолчанию `20`.
    - **Возвращает**:
        - `list`: Список релевантных значений.
    - **Как работает функция**:
        - Проверяет, инициализирован ли индекс (`self.index`).
        - Если индекс существует, создает объект `retriever` с помощью `self.index.as_retriever(similarity_top_k=top_k)`.
        - Вызывает метод `retrieve` объекта `retriever` с целью релевантности (`relevance_target`) для получения узлов (`nodes`).
        - Если индекс не существует, `nodes` устанавливается в пустой список.
        - Итерируется по узлам и формирует список извлеченных элементов, содержащий информацию об источнике, оценке сходства и релевантном контенте.
        - Логгирует первые 200 символов извлеченного контента для отладки.
        - Возвращает список извлеченных элементов.
- `retrieve_by_name(self, name: str) -> list`:
    - **Назначение**: Извлекает источник контента по его имени.
    - **Параметры**:
        - `name` (str): Имя источника контента.
    - **Возвращает**:
        - `list`: Список источников контента, соответствующих имени.
    - **Как работает функция**:
        - Инициализирует пустой список `results` для хранения результатов.
        - Проверяет, что `self.name_to_document` не `None` и что имя (`name`) присутствует в `self.name_to_document`.
        - Если имя найдено, извлекает список документов (`docs`) из `self.name_to_document[name]`.
        - Итерируется по документам в списке `docs`.
        - Для каждого документа формирует строку `content`, содержащую информацию об источнике, номере страницы и контенте (обрезанном до 10000 символов).
        - Добавляет строку `content` в список `results`.
        - Возвращает список результатов.
- `list_sources(self) -> list`:
    - **Назначение**: Перечисляет имена доступных источников контента.
    - **Параметры**:
        - `None`
    - **Возвращает**:
        - `list`: Список имен источников контента.
    - **Как работает функция**:
        - Проверяет, не `None` ли `self.name_to_document`.
        - Если `self.name_to_document` не `None`, возвращает список ключей из `self.name_to_document` (имена источников).
        - Если `self.name_to_document` равно `None`, возвращает пустой список.
- `add_document(self, document, doc_to_name_func=None) -> None`:
    - **Назначение**: Индексирует документ для семантического извлечения.
    - **Параметры**:
        - `document`: Документ для индексации.
        - `doc_to_name_func` (callable, optional): Функция для получения имени документа. По умолчанию `None`.
    - **Как работает функция**:
        - Вызывает метод `add_documents` с переданным документом и функцией `doc_to_name_func` в виде списка.
- `add_documents(self, new_documents, doc_to_name_func=None) -> list`:
    - **Назначение**: Индексирует документы для семантического извлечения.
    - **Параметры**:
        - `new_documents` (list): Список новых документов для индексации.
        - `doc_to_name_func` (callable, optional): Функция, которая извлекает имя из документа. По умолчанию `None`.
    - **Как работает функция**:
        - Проверяет, есть ли новые документы для добавления.
        - Если новые документы есть, добавляет их в список `self.documents`.
        - Перебирает документы в списке `new_documents`:
            - Очищает текст документа с помощью `utils.sanitize_raw_string(document.text)`.
            - Если предоставлена функция `doc_to_name_func`, использует ее для получения имени документа.
            - Добавляет документ в словарь `self.name_to_document` под соответствующим именем. Если имя уже есть в словаре, добавляет документ в список, связанный с этим именем.
        - После добавления всех документов обновляет индекс:
            - Если индекс `self.index` еще не создан, создает новый `VectorStoreIndex` на основе списка документов `self.documents`.
            - Если индекс уже существует, обновляет его с помощью `self.index.refresh(self.documents)`.

### `LocalFilesGroundingConnector`

**Описание**: Коннектор для "заземления" знаний на основе локальных файлов. Позволяет индексировать файлы из указанных папок и выполнять семантический поиск по их содержимому.

**Наследует**: `BaseSemanticGroundingConnector`

**Атрибуты**:
- `folders_paths` (list): Список путей к папкам с файлами для индексации.
- `loaded_folders_paths` (list): Список путей к уже загруженным папкам, чтобы избежать повторной загрузки.

**Методы**:
- `__init__(self, name: str = "Local Files", folders_paths: list = None) -> None`:
    - **Назначение**: Инициализирует экземпляр класса `LocalFilesGroundingConnector`.
    - **Параметры**:
        - `name` (str, optional): Имя коннектора. По умолчанию "Local Files".
        - `folders_paths` (list, optional): Список путей к папкам. По умолчанию `None`.
    -  **Как работает функция**:
        - Вызывает конструктор базового класса `BaseSemanticGroundingConnector` с переданным именем.
        - Инициализирует атрибут `folders_paths` переданным списком путей к папкам.
- `_post_init(self)`:
    - **Назначение**: Выполняет постобработку после инициализации, так как класс имеет декоратор `@post_init`.
    -  **Как работает функция**:
        - Инициализирует атрибут `loaded_folders_paths` значением `None`.
        - Если атрибут `folders_paths` не определен или равен `None`, то он инициализируется пустым списком.
        - Вызывает метод `add_folders` для добавления папок.
- `add_folders(self, folders_paths: list) -> None`:
    - **Назначение**: Добавляет пути к папкам с файлами, используемыми для "заземления".
    - **Параметры**:
        - `folders_paths` (list): Список путей к папкам.
    -  **Как работает функция**:
        - Проверяет, что `folders_paths` не `None`.
        - Перебирает папки в списке `folders_paths`.
        - Логгирует добавление папки в индекс.
        - Для каждой папки вызывает метод `add_folder`.
        - Если возникает исключение `FileNotFoundError` или `ValueError`, перехватывает его, выводит сообщение об ошибке, текущую рабочую директорию и предоставленный путь, а также предлагает проверить существование и доступность пути.
- `add_folder(self, folder_path: str) -> None`:
    - **Назначение**: Добавляет путь к папке с файлами, используемыми для "заземления".
    - **Параметры**:
        - `folder_path` (str): Путь к папке.
    -  **Как работает функция**:
        - Проверяет, что папка еще не была загружена (отсутствует в `self.loaded_folders_paths`).
        - Вызывает метод `_mark_folder_as_loaded` для отметки папки как загруженной.
        - Загружает данные из папки с помощью `SimpleDirectoryReader(folder_path).load_data()`.
        - Вызывает метод `add_documents` для добавления загруженных документов в индекс, используя лямбда-функцию для извлечения имени файла из метаданных документа.
        - Документы PDF будут разделены на страницы.
- `add_file_path(self, file_path: str) -> None`:
    - **Назначение**: Добавляет путь к файлу, используемому для "заземления".
    - **Параметры**:
        - `file_path` (str): Путь к файлу.
    -  **Как работает функция**:
        - Загружает данные из файла с помощью `SimpleDirectoryReader(input_files=[file_path]).load_data()`.
        - Логгирует добавление файла в индекс.
        - Вызывает метод `add_documents` для добавления загруженных документов в индекс, используя лямбда-функцию для извлечения имени файла из метаданных документа.
- `_mark_folder_as_loaded(self, folder_path: str) -> None`:
    - **Назначение**: Отмечает папку как загруженную, чтобы избежать повторной загрузки.
    - **Параметры**:
        - `folder_path` (str): Путь к папке.
    -  **Как работает функция**:
        - Если `folder_path` отсутствует в `self.loaded_folders_paths`, добавляет его.
        - Если `folder_path` отсутствует в `self.folders_paths`, добавляет его.

### `WebPagesGroundingConnector`

**Описание**: Коннектор для "заземления" знаний на основе веб-страниц. Позволяет индексировать контент с указанных веб-страниц и выполнять семантический поиск по их содержимому.

**Наследует**: `BaseSemanticGroundingConnector`

**Атрибуты**:
- `web_urls` (list): Список URL-адресов веб-страниц для индексации.
- `loaded_web_urls` (list): Список URL-адресов, которые уже были загружены.

**Методы**:
- `__init__(self, name: str = "Web Pages", web_urls: list = None) -> None`:
    - **Назначение**: Инициализирует экземпляр класса `WebPagesGroundingConnector`.
    - **Параметры**:
        - `name` (str, optional): Имя коннектора. По умолчанию "Web Pages".
        - `web_urls` (list, optional): Список URL-адресов веб-страниц. По умолчанию `None`.
    -  **Как работает функция**:
        - Вызывает конструктор базового класса `BaseSemanticGroundingConnector` с переданным именем.
        - Инициализирует атрибут `web_urls` переданным списком URL-адресов.
- `_post_init(self)`:
    - **Назначение**: Выполняет постобработку после инициализации, так как класс имеет декоратор `@post_init`.
    -  **Как работает функция**:
        - Инициализирует атрибут `loaded_web_urls` значением `None`.
        - Если атрибут `web_urls` не определен или равен `None`, то он инициализируется пустым списком.
        - Вызывает метод `add_web_urls` для добавления веб-страниц.
- `add_web_urls(self, web_urls: list) -> None`:
    - **Назначение**: Добавляет данные, полученные с указанных URL-адресов, для "заземления".
    - **Параметры**:
        - `web_urls` (list): Список URL-адресов веб-страниц.
    -  **Как работает функция**:
        - Фильтрует список `web_urls`, чтобы оставить только те URL-адреса, которых еще нет в `self.loaded_web_urls`.
        - Перебирает отфильтрованные URL-адреса.
        - Помечает каждый URL-адрес как загруженный, вызывая метод `self._mark_web_url_as_loaded(url)`.
        - Если есть новые URL-адреса для загрузки, загружает данные с помощью `SimpleWebPageReader(html_to_text=True).load_data(filtered_web_urls)`.
        - Вызывает метод `add_documents` для добавления загруженных документов в индекс, используя лямбда-функцию для извлечения идентификатора документа.
- `add_web_url(self, web_url: str) -> None`:
    - **Назначение**: Добавляет данные, полученные с указанного URL-адреса, для "заземления".
    - **Параметры**:
        - `web_url` (str): URL-адрес веб-страницы.
    -  **Как работает функция**:
        - Вызывает метод `add_web_urls` со списком, содержащим только переданный `web_url`.
- `_mark_web_url_as_loaded(self, web_url: str) -> None`:
    - **Назначение**: Отмечает веб-страницу как загруженную, чтобы избежать повторной загрузки.
    - **Параметры**:
        - `web_url` (str): URL-адрес веб-страницы.
    -  **Как работает функция**:
        - Если `web_url` отсутствует в `self.loaded_web_urls`, добавляет его.
        - Если `web_url` отсутствует в `self.web_urls`, добавляет его.