# Модуль `tiny_person_validator.py`

## Обзор

Модуль `tiny_person_validator.py` предназначен для валидации экземпляров класса `TinyPerson` с использованием языковой модели (LLM) OpenAI. Он содержит класс `TinyPersonValidator` с методом `validate_person`, который отправляет серию вопросов экземпляру `TinyPerson` и оценивает ответы с помощью LLM. Валидация позволяет определить степень соответствия личности заданным ожиданиям.

## Подробнее

Модуль использует шаблоны Mustache для генерации промптов и библиотеку `chevron` для их рендеринга. Логирование осуществляется через модуль `logging` с именем "tinytroupe". Результаты валидации включают оценку уверенности (confidence score) и обоснование (justification).

## Классы

### `TinyPersonValidator`

Описание класса для валидации личности `TinyPerson` с использованием LLM OpenAI.

#### Методы

- `validate_person(person, expectations=None, include_agent_spec=True, max_content_length=default_max_content_display_length)`

## Методы класса

### `validate_person`

```python
@staticmethod
def validate_person(person, expectations=None, include_agent_spec=True, max_content_length=default_max_content_display_length) -> tuple[float, str]:
    """
    Проверяет экземпляр TinyPerson, используя LLM OpenAI.

    Этот метод отправляет серию вопросов экземпляру TinyPerson для проверки его ответов с использованием LLM OpenAI.
    Метод возвращает значение типа float, представляющее оценку уверенности процесса проверки.
    Если процесс проверки завершается неудачно, метод возвращает None.

    Args:
        person (TinyPerson): Экземпляр TinyPerson, который необходимо проверить.
        expectations (str, optional): Ожидания, используемые в процессе проверки. По умолчанию None.
        include_agent_spec (bool, optional): Следует ли включать спецификацию агента в запрос. По умолчанию False.
        max_content_length (int, optional): Максимальная длина содержимого, отображаемого при отображении разговора.

    Returns:
        float: Оценка уверенности процесса проверки (от 0.0 до 1.0) или None, если процесс проверки завершается неудачно.
        str: Обоснование оценки проверки или None, если процесс проверки завершается неудачно.
    """
```

****

1.  **Инициализация**:
    *   Инициализируется список `current_messages` для хранения сообщений, которыми обменивается валидатор и `TinyPerson`.
    *   Определяется путь к шаблону промпта (`check_person.mustache`), который будет использоваться для генерации системного промпта.

2.  **Подготовка промпта**:
    *   Шаблон промпта считывается из файла.
    *   Системный промпт генерируется с использованием библиотеки `chevron` и включает в себя заданные ожидания (`expectations`).
    *   Формируется пользовательский промпт, который предписывает LLM задавать вопросы `TinyPerson`, основываясь на его характеристиках.
    *   В зависимости от значения `include_agent_spec`, в промпт добавляется либо полная спецификация персоны (`person._persona`), либо её краткая биография (`person.minibio()`).

3.  **Начало валидации**:
    *   В лог записывается информация о начале валидации личности.
    *   Создаются начальные сообщения для LLM, включающие системный и пользовательский промпты.

4.  **Взаимодействие с LLM и TinyPerson**:
    *   Цикл `while` продолжается до тех пор, пока LLM возвращает сообщения и не будет найдена строка `termination_mark` (```json) в содержимом сообщения.
    *   Вопросы, полученные от LLM, добавляются в `current_messages` и логируются.
    *   Эти вопросы передаются `TinyPerson` через метод `listen_and_act`, который генерирует ответы.
    *   Ответы `TinyPerson` логируются и добавляются в `current_messages`.
    *   LLM получает `current_messages` для генерации следующего сообщения.

5.  **Извлечение результатов**:
    *   После завершения цикла (когда в сообщении от LLM обнаружена строка `termination_mark`), извлекается JSON-контент из сообщения.
    *   Из JSON извлекаются оценка (`score`) и обоснование (`justification`).
    *   Оценка и обоснование логируются.
    *   Функция возвращает кортеж, содержащий оценку и обоснование.

6.  **Обработка ошибок**:
    *   Если в процессе взаимодействия с LLM не получено сообщений (message is None), функция возвращает `None, None`.

**Внутренние функции**:
Внутри данной функции нет внутренних функций.

**Примеры**:

Примеры вызова функции `validate_person` с различными параметрами:

```python
# Пример 1: Валидация с базовыми параметрами
score, justification = TinyPersonValidator.validate_person(person)

# Пример 2: Валидация с указанием ожиданий
score, justification = TinyPersonValidator.validate_person(person, expectations="Ожидается, что персона будет дружелюбной и общительной.")

# Пример 3: Валидация без включения спецификации агента
score, justification = TinyPersonValidator.validate_person(person, include_agent_spec=False)

# Пример 4: Валидация с ограничением длины контента
score, justification = TinyPersonValidator.validate_person(person, max_content_length=512)