# Модуль тестирования `test_control.py`

## Обзор

Этот модуль содержит модульные тесты для компонента `control` в проекте `tinytroupe`. Он проверяет правильность работы функций начала, контрольной точки и завершения симуляции, а также кэширование данных между симуляциями. Модуль использует `pytest` для организации тестов и включает проверки для различных сценариев, включая использование агентов, мира и фабрики персонажей.

## Подробнее

Модуль тестирования предназначен для проверки основных функций управления симуляцией, таких как запуск, сохранение состояния и завершение симуляции. Он также проверяет, что механизм кэширования работает правильно, повторно используя результаты предыдущих симуляций, когда это возможно. Это позволяет ускорить процесс тестирования и гарантировать согласованность результатов.

## Классы

В этом модуле нет классов, но он использует несколько классов из других модулей:

- `Simulation`
- `TinyPerson`
- `TinyToolUse`
- `TinyWorld`
- `TinyPersonFactory`
- `TinyEnricher`
- `ArtifactExporter`
- `TinyWordProcessor`

## Функции

### `test_begin_checkpoint_end_with_agent_only`

```python
def test_begin_checkpoint_end_with_agent_only(setup):
    """
    Тестирует сценарий, в котором симуляция начинается, создается контрольная точка и завершается с использованием только агентов.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции или наличие файлов не соответствуют ожиданиям.

    """
```

**Как работает функция**:

1.  **Удаление файла кэша**: Удаляет файл `control_test.cache.json`, если он существует.
2.  **Сброс состояния**: Сбрасывает состояние контроллера симуляции.
3.  **Проверка отсутствия симуляции**: Утверждает, что в данный момент не запущена ни одна симуляция.
4.  **Начало симуляции**: Запускает симуляцию с именем `control_test.cache.json`.
5.  **Проверка статуса симуляции**: Утверждает, что симуляция находится в состоянии `STATUS_STARTED`.
6.  **Создание объектов**: Создает экземпляры `ArtifactExporter`, `TinyEnricher` и `TinyToolUse`.
7.  **Создание и настройка агентов**: Создает и настраивает двух агентов (`agent_1` и `agent_2`) с использованием `create_oscar_the_architect` и `create_lisa_the_data_scientist`. Добавляет им способности и определяет атрибуты, такие как возраст и национальность.
8.  **Проверка наличия трассировки**: Утверждает, что существует как кэшированная, так и выполняемая трассировка.
9.  **Создание контрольной точки**: Создает контрольную точку симуляции.
10. **Взаимодействие агентов**: Агенты взаимодействуют, выполняя действия `listen_and_act`.
11. **Проверка создания файла**: Утверждает, что файл контрольной точки был создан.
12. **Завершение симуляции**: Завершает симуляцию.
13. **Проверка статуса завершения**: Утверждает, что симуляция находится в состоянии `STATUS_STOPPED`.

**ASCII Flowchart**:

```
    Начало теста
    |
    Удаление файла кэша -> Сброс состояния контроллера -> Проверка отсутствия симуляции
    |
    Начало симуляции -> Проверка статуса симуляции
    |
    Создание объектов (Exporter, Enricher, ToolUse)
    |
    Создание и настройка агентов (agent_1, agent_2) -> Добавление способностей и атрибутов
    |
    Проверка наличия трассировки
    |
    Создание контрольной точки
    |
    Взаимодействие агентов (listen_and_act)
    |
    Проверка создания файла кэша
    |
    Завершение симуляции -> Проверка статуса завершения
    |
    Конец теста
```

**Примеры**:

```python
test_begin_checkpoint_end_with_agent_only(setup=setup_fixture)
```

### `test_begin_checkpoint_end_with_world`

```python
def test_begin_checkpoint_end_with_world(setup):
    """
    Тестирует сценарий, в котором симуляция начинается, создается контрольная точка и завершается с использованием объекта `TinyWorld`.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции или наличие файлов не соответствуют ожиданиям.
    """
```

**Как работает функция**:

1.  **Удаление файла кэша**: Удаляет файл `control_test_world.cache.json`, если он существует.
2.  **Сброс состояния**: Сбрасывает состояние контроллера симуляции.
3.  **Проверка отсутствия симуляции**: Утверждает, что в данный момент не запущена ни одна симуляция.
4.  **Начало симуляции**: Запускает симуляцию с именем `control_test_world.cache.json`.
5.  **Проверка статуса симуляции**: Утверждает, что симуляция находится в состоянии `STATUS_STARTED`.
6.  **Создание мира**: Создает экземпляр `TinyWorld` с двумя агентами (`create_oscar_the_architect` и `create_lisa_the_data_scientist`).
7.  **Обеспечение доступности**: Делает всех агентов в мире доступными друг для друга.
8.  **Проверка наличия трассировки**: Утверждает, что существует как кэшированная, так и выполняемая трассировка.
9.  **Запуск мира**: Запускает симуляцию мира на 2 шага.
10. **Создание контрольной точки**: Создает контрольную точку симуляции.
11. **Проверка создания файла**: Утверждает, что файл контрольной точки был создан.
12. **Завершение симуляции**: Завершает симуляцию.
13. **Проверка статуса завершения**: Утверждает, что симуляция находится в состоянии `STATUS_STOPPED`.

**ASCII Flowchart**:

```
    Начало теста
    |
    Удаление файла кэша -> Сброс состояния контроллера -> Проверка отсутствия симуляции
    |
    Начало симуляции -> Проверка статуса симуляции
    |
    Создание мира (TinyWorld) с агентами
    |
    Обеспечение доступности агентов
    |
    Проверка наличия трассировки
    |
    Запуск мира (world.run)
    |
    Создание контрольной точки
    |
    Проверка создания файла кэша
    |
    Завершение симуляции -> Проверка статуса завершения
    |
    Конец теста
```

**Примеры**:

```python
test_begin_checkpoint_end_with_world(setup=setup_fixture)
```

### `test_begin_checkpoint_end_with_factory`

```python
def test_begin_checkpoint_end_with_factory(setup):
    """
    Тестирует сценарий, в котором симуляция начинается, создается контрольная точка и завершается с использованием `TinyPersonFactory`.
    Проверяет кэширование данных между итерациями симуляции.

    Args:
        setup: Фикстура pytest для настройки тестовой среды.

    Raises:
        AssertionError: Если состояние симуляции, наличие файлов, попадания/промахи кэша или атрибуты агентов не соответствуют ожиданиям.
    """
```

**Внутренние функции**:

#### `aux_simulation_to_repeat`

```python
    def aux_simulation_to_repeat(iteration, verbose=False):
        """
        Вспомогательная функция для выполнения одной итерации симуляции с использованием `TinyPersonFactory`.

        Args:
            iteration (int): Номер итерации симуляции.
            verbose (bool, optional): Флаг для включения детального логирования. По умолчанию `False`.

        Returns:
            TinyPerson: Сгенерированный агент.

        Raises:
            AssertionError: Если состояние симуляции не соответствует ожиданиям.
        """
```

**Как работает функция `aux_simulation_to_repeat`**:

1.  **Сброс состояния**: Сбрасывает состояние контроллера симуляции.
2.  **Проверка отсутствия симуляции**: Утверждает, что в данный момент не запущена ни одна симуляция.
3.  **Начало симуляции**: Запускает симуляцию с именем `control_test_personfactory.cache.json`.
4.  **Проверка статуса симуляции**: Утверждает, что симуляция находится в состоянии `STATUS_STARTED`.
5.  **Создание фабрики**: Создает экземпляр `TinyPersonFactory`.
6.  **Проверка наличия трассировки**: Утверждает, что существует как кэшированная, так и выполняемая трассировка.
7.  **Генерация агента**: Генерирует агента с использованием фабрики.
8.  **Проверка наличия трассировки**: Утверждает, что существует как кэшированная, так и выполняемая трассировка.
9.  **Создание контрольной точки**: Создает контрольную точку симуляции.
10. **Проверка создания файла**: Утверждает, что файл контрольной точки был создан.
11. **Завершение симуляции**: Завершает симуляцию.
12. **Проверка статуса завершения**: Утверждает, что симуляция находится в состоянии `STATUS_STOPPED`.
13. **Логирование (если verbose)**: Выводит отладочную информацию, если установлен флаг `verbose`.
14. **Возврат агента**: Возвращает сгенерированного агента.

**ASCII Flowchart для `aux_simulation_to_repeat`**:

```
    Начало функции
    |
    Сброс состояния контроллера -> Проверка отсутствия симуляции
    |
    Начало симуляции -> Проверка статуса симуляции
    |
    Создание фабрики (TinyPersonFactory)
    |
    Проверка наличия трассировки
    |
    Генерация агента (factory.generate_person)
    |
    Проверка наличия трассировки
    |
    Создание контрольной точки
    |
    Проверка создания файла кэша
    |
    Завершение симуляции -> Проверка статуса завершения
    |
    Логирование (если verbose)
    |
    Возврат агента
    |
    Конец функции
```

**Как работает функция `test_begin_checkpoint_end_with_factory`**:

1.  **Удаление файла кэша**: Удаляет файл `control_test_personfactory.cache.json`, если он существует.
2.  **Сброс состояния**: Сбрасывает состояние контроллера симуляции.
3.  **Проверка отсутствия симуляции**: Утверждает, что в данный момент не запущена ни одна симуляция.
4.  **Проверка промахов кэша**: Утверждает, что изначально нет промахов кэша.
5.  **Проверка попаданий кэша**: Утверждает, что изначально нет попаданий кэша.
6.  **Первая симуляция**: Выполняет первую итерацию симуляции с помощью `aux_simulation_to_repeat`.
7.  **Извлечение атрибутов**: Извлекает атрибуты (возраст, национальность, мини-биография) агента.
8.  **Вторая симуляция**: Выполняет вторую итерацию симуляции с помощью `aux_simulation_to_repeat`.
9.  **Извлечение атрибутов**: Извлекает атрибуты (возраст, национальность, мини-биография) агента.
10. **Проверка промахов кэша**: Утверждает, что по-прежнему нет промахов кэша.
11. **Проверка попаданий кэша**: Утверждает, что есть попадания кэша.
12. **Сравнение атрибутов**: Сравнивает атрибуты агентов из первой и второй симуляций, утверждая, что они одинаковы.
13. **Чтение содержимого кэша**: Читает содержимое файла кэша.
14. **Проверка содержимого кэша**: Утверждает, что файл кэша содержит вызовы `_aux_model_call` и `_setup_agent`, но не содержит вызовы `define` и `define_several`.

**ASCII Flowchart для `test_begin_checkpoint_end_with_factory`**:

```
    Начало теста
    |
    Удаление файла кэша -> Сброс состояния контроллера -> Проверка отсутствия симуляции
    |
    Проверка промахов кэша -> Проверка попаданий кэша
    |
    Первая симуляция (aux_simulation_to_repeat)
    |
    Извлечение атрибутов агента (возраст, национальность, мини-биография)
    |
    Вторая симуляция (aux_simulation_to_repeat)
    |
    Извлечение атрибутов агента (возраст, национальность, мини-биография)
    |
    Проверка промахов кэша -> Проверка попаданий кэша
    |
    Сравнение атрибутов агентов
    |
    Чтение содержимого файла кэша
    |
    Проверка содержимого файла кэша (наличие/отсутствие определенных вызовов)
    |
    Конец теста
```

**Примеры**:

```python
test_begin_checkpoint_end_with_factory(setup=setup_fixture)
```