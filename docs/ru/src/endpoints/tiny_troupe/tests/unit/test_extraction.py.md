# Модуль тестирования функций извлечения артефактов и нормализации текста
## Обзор

Модуль содержит набор тестов для проверки корректности работы функций извлечения артефактов и нормализации текста, используемых в проекте `hypotez`. В частности, тестируются классы `ArtifactExporter` и `Normalizer` из модуля `tinytroupe.extraction`.

## Подробнее

Модуль использует библиотеку `pytest` для организации и запуска тестов. Тесты охватывают экспорт данных в различных форматах (JSON, текст, DOCX) и нормализацию текстовых концепций. Он проверяет сохранение данных, корректность форматов и функциональность кэширования нормализатора. Расположение модуля в структуре проекта указывает на его роль в тестировании функциональности обработки и экспорта данных, что важно для обеспечения надежности и качества работы системы.

## Фикстуры

### `exporter`

```python
@pytest.fixture
def exporter():
    """
    Создает и возвращает экземпляр класса `ArtifactExporter` для использования в тестах.

    Returns:
        ArtifactExporter: Экземпляр класса `ArtifactExporter`, настроенный для экспорта в папку `EXPORT_BASE_FOLDER`.
    """
    ...
```

**Назначение**:
Фикстура создает экземпляр класса `ArtifactExporter`, который используется для экспорта артефактов в тестах.

**Возвращает**:
- `ArtifactExporter`: Объект `ArtifactExporter`, настроенный на использование папки `EXPORT_BASE_FOLDER` в качестве базовой директории для вывода.

**Как работает фикстура**:
1. Создается объект `ArtifactExporter` с указанием базовой папки для вывода.
2. Возвращается созданный объект для использования в тестах.

## Функции

### `test_export_json`

```python
def test_export_json(exporter):
    """
    Тестирует экспорт данных в формате JSON с использованием класса `ArtifactExporter`.

    Args:
        exporter: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.
    """
    ...
```

**Назначение**:
Тестирует экспорт данных в формате JSON с использованием класса `ArtifactExporter`. Функция создает тестовые данные, экспортирует их в JSON-файл и проверяет, что файл был создан корректно и содержит ожидаемые данные.

**Параметры**:
- `exporter`: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.

**Как работает функция**:

1.  **Определение тестовых данных**: Создается словарь `artifact_data`, содержащий тестовые данные (имя, возраст, род занятий, содержимое).
2.  **Экспорт данных в JSON**: Используется метод `exporter.export` для экспорта данных в формате JSON. Указывается имя артефакта (`test_artifact`), сами данные, тип содержимого (`record`) и целевой формат (`json`).
3.  **Проверка создания файла**: Проверяется, что файл `test_artifact.json` был создан в ожидаемой директории (`EXPORT_BASE_FOLDER/record`).
4.  **Проверка содержимого файла**: Файл открывается, данные из него считываются и сравниваются с исходными данными `artifact_data`.

**Примеры**:

```python
test_export_json(exporter())
```

### `test_export_text`

```python
def test_export_text(exporter):
    """
    Тестирует экспорт данных в текстовом формате с использованием класса `ArtifactExporter`.

    Args:
        exporter: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.
    """
    ...
```

**Назначение**:
Тестирует экспорт данных в текстовом формате с использованием класса `ArtifactExporter`. Функция создает текстовые данные, экспортирует их в TXT-файл и проверяет, что файл был создан корректно и содержит ожидаемые данные.

**Параметры**:
- `exporter`: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.

**Как работает функция**:

1.  **Определение тестовых данных**: Создается строковая переменная `artifact_data`, содержащая тестовый текст.
2.  **Экспорт данных в текст**: Используется метод `exporter.export` для экспорта данных в текстовом формате. Указывается имя артефакта (`test_artifact`), сами данные, тип содержимого (`text`) и целевой формат (`txt`).
3.  **Проверка создания файла**: Проверяется, что файл `test_artifact.txt` был создан в ожидаемой директории (`EXPORT_BASE_FOLDER/text`).
4.  **Проверка содержимого файла**: Файл открывается, данные из него считываются и сравниваются с исходными данными `artifact_data`.

**Примеры**:

```python
test_export_text(exporter())
```

### `test_export_docx`

```python
def test_export_docx(exporter):
    """
    Тестирует экспорт данных в формате DOCX с использованием класса `ArtifactExporter`.
    Проверяет, что форматирование Markdown корректно преобразуется в формат DOCX.

    Args:
        exporter: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.
    """
    ...
```

**Назначение**:
Тестирует экспорт данных в формате DOCX с использованием класса `ArtifactExporter`. Функция создает Markdown-текст, экспортирует его в DOCX-файл и проверяет, что файл был создан корректно и содержит преобразованный текст.

**Параметры**:
- `exporter`: Фикстура `exporter`, предоставляющая экземпляр класса `ArtifactExporter`.

**Как работает функция**:

1.  **Определение тестовых данных**: Создается многострочная строка `artifact_data`, содержащая Markdown-текст с различными элементами форматирования (заголовки, полужирный текст, курсив, ссылки).
2.  **Экспорт данных в DOCX**: Используется метод `exporter.export` для экспорта данных в формате DOCX. Указывается имя артефакта (`test_artifact`), сами данные, тип содержимого (`Document`), формат содержимого (`markdown`) и целевой формат (`docx`).
3.  **Проверка создания файла**: Проверяется, что файл `test_artifact.docx` был создан в ожидаемой директории (`EXPORT_BASE_FOLDER/Document`).
4.  **Проверка содержимого файла**:
    *   Файл открывается с использованием библиотеки `docx`.
    *   Текст извлекается из каждого параграфа документа.
    *   Проверяется, что извлеченный текст содержит часть исходного контента (например, "This is a sample markdown text").
    *   Проверяется, что в извлеченном тексте отсутствуют элементы Markdown (например, "#").

**Примеры**:

```python
test_export_docx(exporter())
```

### `test_normalizer`

```python
def test_normalizer():
    """
    Тестирует класс `Normalizer`, проверяя его способность нормализовывать концепции.
    Включает проверку количества нормализованных элементов, кэширования и корректности результатов нормализации.
    """
    ...
```

**Назначение**:
Тестирует класс `Normalizer`, проверяя его способность нормализовывать концепции. Функция создает экземпляр нормализатора, задает список концепций для нормализации и проверяет, что нормализатор корректно нормализует эти концепции, а также использует кэширование для оптимизации процесса.

**Как работает функция**:

1.  **Определение концепций**: Создается список `concepts`, содержащий набор концепций для нормализации.
2.  **Уникализация концепций**: Создается список `unique_concepts` путем удаления дубликатов из списка `concepts`.
3.  **Создание нормализатора**: Создается экземпляр класса `Normalizer` с указанием списка концепций, количества нормализованных элементов (`n=10`) и включенным режимом verbose (`verbose=True`).
4.  **Проверка количества нормализованных элементов**: Проверяется, что количество нормализованных элементов в `normalizer.normalized_elements` равно заданному значению (10).
5.  **Создание случайных бакетов концепций**: Создается список `random_concepts_buckets`, содержащий несколько бакетов, каждый из которых содержит случайную выборку из списка `concepts`.
6.  **Нормализация бакетов концепций**:
    *   Для каждого бакета из списка `random_concepts_buckets` выполняется следующее:
        *   Запоминается текущий размер кэша нормализатора (`init_cache_size`).
        *   Вызывается метод `normalizer.normalize` для нормализации бакета.
        *   Проверяется, что результат нормализации не равен `None`.
        *   Логируется процесс нормализации с использованием `logger.debug`.
        *   Выводится процесс нормализации в консоль.
        *   Запоминается размер кэша нормализатора после нормализации бакета (`next_cache_size`).
        *   Проверяется, что длина нормализованного списка концепций совпадает с длиной исходного бакета.
        *   Проверяется, что все элементы из нормализованного списка концепций присутствуют в ключах `normalizer.normalizing_map`.
        *   Проверяется, что размер кэша увеличился после нормализации нового бакета.
        *   Проверяется, что размер кэша не уменьшился после нормализации нового бакета.

**Примеры**:

```python
test_normalizer()
```