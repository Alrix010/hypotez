# Модуль тестирования утилит `tinytroupe`

## Обзор

Модуль содержит юнит-тесты для различных утилит, используемых в проекте `tinytroupe`.
В частности, тестируются функции извлечения JSON, обработки имен, повторных попыток при ошибках,
а также декоратор для интеграции с языковыми моделями (LLM).

## Подробнее

Этот модуль важен для обеспечения стабильности и корректности работы утилит, которые используются
в различных частях проекта `tinytroupe`. Тесты охватывают различные сценарии использования, включая
обработку ошибок и граничные случаи.

## Классы

В данном модуле класс `MockEntity` используется только для целей тестирования и не предназначен для использования вне тестов.

### `MockEntity`

**Описание**:
Класс-заглушка, используемый для имитации сущности с атрибутом `name` в тестах.

**Принцип работы**:
Класс просто инициализируется с заданным именем, которое затем может быть получено через атрибут `name`.

**Атрибуты**:
- `name` (str): Имя сущности.

**Методы**:
Отсутствуют.

## Функции

### `test_extract_json`

```python
def test_extract_json():
    """Функция тестирует извлечение JSON из текста.

    Args:
        Отсутствуют.

    Returns:
        None

    Raises:
        AssertionError: Если результат извлечения JSON не соответствует ожидаемому.

    Example:
        >>> test_extract_json()
    """
```

**Назначение**:
Функция `test_extract_json` выполняет тестирование функции `extract_json`, проверяя её способность извлекать JSON-объекты
из строк текста. Тестируются различные случаи, такие как извлечение простых JSON-объектов, JSON-массивов, объектов с экранированными
символами и обработка невалидного JSON.

**Как работает функция**:

1.  **Тест с простым JSON**: Извлекается JSON из строки `'Some text before {"key": "value"} some text after'` и проверяется, что результат равен `{"key": "value"}`.
2.  **Тест с JSON-массивом**: Извлекается JSON из строки `'Some text before [{"key": "value"}, {"key2": "value2"}] some text after'` и проверяется, что результат равен `[{"key": "value"}, {"key2": "value2"}]`.
3.  **Тест с экранированными символами**: Извлекается JSON из строки `'Some text before {"key": "\\\'value\\\'"} some text after'` и проверяется, что результат равен `{"key": "'value'"}`.
4.  **Тест с невалидным JSON**: Извлекается JSON из строки `'Some text before {"key": "value",} some text after'` и проверяется, что результат равен `{}`.
5.  **Тест без JSON**: Извлекается JSON из строки `'Some text with no JSON'` и проверяется, что результат равен `{}`.

```
Начало
│
├─── Простой JSON: Извлечение JSON из строки с простым JSON-объектом
│   │
│   └─── Проверка: Результат соответствует {"key": "value"}
│
├─── JSON-массив: Извлечение JSON из строки с массивом JSON-объектов
│   │
│   └─── Проверка: Результат соответствует [{"key": "value"}, {"key2": "value2"}]
│
├─── Экранированные символы: Извлечение JSON из строки с экранированными символами
│   │
│   └─── Проверка: Результат соответствует {"key": "'value'"}
│
├─── Невалидный JSON: Извлечение JSON из строки с невалидным JSON
│   │
│   └─── Проверка: Результат соответствует {}
│
└─── Отсутствие JSON: Извлечение JSON из строки без JSON
    │
    └─── Проверка: Результат соответствует {}
    │
Конец
```

**Примеры**:

```python
test_extract_json()
```

### `test_name_or_empty`

```python
def test_name_or_empty():
    """Функция тестирует функцию name_or_empty.

    Args:
        Отсутствуют.

    Returns:
        None

    Raises:
        AssertionError: Если результат не соответствует ожидаемому.

    Example:
        >>> test_name_or_empty()
    """
```

**Назначение**:
Функция `test_name_or_empty` тестирует функцию `name_or_empty`, которая должна возвращать имя объекта, если оно существует,
или пустую строку, если объект равен `None`.

**Как работает функция**:

1.  **Тест с именованной сущностью**: Создается экземпляр класса `MockEntity` с именем "Test" и проверяется, что функция `name_or_empty` возвращает "Test".
2.  **Тест с None**: Проверяется, что функция `name_or_empty` возвращает пустую строку, если ей передается `None`.

```
Начало
│
├─── Именованная сущность: Создание MockEntity с именем "Test"
│   │
│   └─── Проверка: Результат соответствует "Test"
│
└─── None: Передача None в функцию
    │
    └─── Проверка: Результат соответствует ""
    │
Конец
```

**Примеры**:

```python
test_name_or_empty()
```

### `test_repeat_on_error`

```python
def test_repeat_on_error():
    """Функция тестирует декоратор repeat_on_error.

    Args:
        Отсутствуют.

    Returns:
        None

    Raises:
        AssertionError: Если результат не соответствует ожидаемому.

    Example:
        >>> test_repeat_on_error()
    """
```

**Назначение**:
Функция `test_repeat_on_error` тестирует декоратор `repeat_on_error`, который предназначен для повторного выполнения функции
в случае возникновения определенных исключений.

**Как работает функция**:

1.  **Тест с повторами и исключением**: Определяется функция, которая вызывает исключение `DummyException`. Декоратор `repeat_on_error`
    настраивается на повтор 3 раза при возникновении `DummyException`. Проверяется, что функция вызывается 3 раза, и в конечном итоге
    возникает исключение `DummyException`.
2.  **Тест без исключений**: Определяется функция, которая не вызывает исключений. Декоратор `repeat_on_error` настраивается на повтор 3 раза
    при возникновении `DummyException`. Проверяется, что функция вызывается только один раз.
3.  **Тест с исключением, не указанным в списке**: Определяется функция, которая вызывает исключение `RuntimeError`. Декоратор `repeat_on_error`
    настраивается на повтор 3 раза при возникновении `DummyException`. Проверяется, что функция вызывается только один раз, и в конечном итоге
    возникает исключение `RuntimeError`.

```
Начало
│
├─── Повторы и исключение: Функция вызывает DummyException, retries=3
│   │
│   └─── Проверка: Функция вызывается 3 раза, возникает DummyException
│
├─── Без исключений: Функция не вызывает исключений, retries=3
│   │
│   └─── Проверка: Функция вызывается 1 раз
│
└─── Исключение не в списке: Функция вызывает RuntimeError, retries=3, exceptions=[DummyException]
    │
    └─── Проверка: Функция вызывается 1 раз, возникает RuntimeError
    │
Конец
```

**Примеры**:

```python
test_repeat_on_error()
```

### `test_llm_decorator`

```python
def test_llm_decorator():
    """Функция тестирует декоратор llm.

    Args:
        Отсутствуют.

    Returns:
        None

    Raises:
        AssertionError: Если результат не соответствует ожидаемому.

    Example:
        >>> test_llm_decorator()
    """
```

**Назначение**:
Функция `test_llm_decorator` тестирует декоратор `llm`, который, предположительно, предназначен для интеграции с языковыми моделями (LLM).
Тесты проверяют, что декоратор возвращает строку, а также корректно работает с различными параметрами и типами возвращаемых значений.

**Как работает функция**:

1.  **Тест без параметров**: Определяется функция `joke`, декорированная `@llm(temperature=0.5)`, которая возвращает строку "Tell me a joke.".
    Проверяется, что результат является строкой и имеет ненулевую длину.
2.  **Тест с параметрами**: Определяется функция `story`, декорированная `@llm(temperature=0.7)`, которая принимает параметр `character` и возвращает строку "Tell me a story about {character}.".
    Проверяется, что результат является строкой и имеет ненулевую длину.
3.  **Тест с функцией `restructure`**: Определяется функция `restructure`, которая принимает параметр `feedback` и возвращает строку, содержащую инструкцию по извлечению элементов из этого `feedback`.
    Проверяется, что результат является строкой и имеет ненулевую длину.
4.  **Тест с функцией `abstract`**: Определяется функция `abstract`, которая принимает параметр `feedback` и возвращает строку, содержащую инструкцию по преобразованию этого `feedback` в абстрактное правило.
    Проверяется, что результат является строкой и имеет ненулевую длину.
5.  **Тест с функцией `rephrase`**: Определяется функция `rephrase`, которая принимает параметры `behavior` и `rule` и возвращает строку, содержащую инструкцию по перефразированию `behavior` в соответствии с `rule`.
    Проверяется, что результат является строкой и имеет ненулевую длину.
6.  **Тест с функцией `is_sunny`**: Определяется функция `is_sunny`, декорированная `@llm()`, которая возвращает строку "Is it sunny today?".
    Предположительно, декоратор должен преобразовать возвращаемое значение в булев тип. Проверяется, что результат является булевым значением.
7.  **Тест с функцией `pi_value`**: Определяется функция `pi_value`, декорированная `@llm()`, которая возвращает строку "What is the value of pi?".
    Предположительно, декоратор должен преобразовать возвращаемое значение в число с плавающей точкой. Проверяется, что результат является числом с плавающей точкой.
8.  **Тест с функцией `lucky_number`**: Определяется функция `lucky_number`, декорированная `@llm()`, которая возвращает строку "What is my lucky number?".
    Предположительно, декоратор должен преобразовать возвращаемое значение в целое число. Проверяется, что результат является целым числом.

```
Начало
│
├─── joke: @llm(temperature=0.5) возвращает "Tell me a joke."
│   │
│   └─── Проверка: Результат - строка, длина > 0
│
├─── story: @llm(temperature=0.7) принимает character, возвращает "Tell me a story about {character}."
│   │
│   └─── Проверка: Результат - строка, длина > 0
│
├─── restructure: @llm(temperature=1.0) принимает feedback, возвращает инструкцию по извлечению элементов
│   │
│   └─── Проверка: Результат - строка, длина > 0
│
├─── abstract: @llm(temperature=1.0) принимает feedback, возвращает инструкцию по преобразованию в правило
│   │
│   └─── Проверка: Результат - строка, длина > 0
│
├─── rephrase: @llm(temperature=1.0) принимает behavior и rule, возвращает инструкцию по перефразированию
│   │
│   └─── Проверка: Результат - строка, длина > 0
│
├─── is_sunny: @llm() возвращает "Is it sunny today?", ожидается bool
│   │
│   └─── Проверка: Результат - bool
│
├─── pi_value: @llm() возвращает "What is the value of pi?", ожидается float
│   │
│   └─── Проверка: Результат - float
│
└─── lucky_number: @llm() возвращает "What is my lucky number?", ожидается int
    │
    └─── Проверка: Результат - int
    │
Конец
```

**Примеры**:

```python
test_llm_decorator()