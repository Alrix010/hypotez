# Модуль `xml2dict`

## Обзор

Модуль `xml2dict` предназначен для преобразования XML-строк в словари Python. Он включает функции для парсинга XML и создания Python-словарей, представляющих структуру XML. Модуль адаптирован для работы с PrestaShop, но может использоваться и для других XML-документов.

## Подробней

Модуль содержит функции для рекурсивного парсинга XML-узлов, обработки атрибутов и создания словарей, отражающих структуру XML-документа. Он также включает обработку пространств имен XML.
Код был адаптирован для работы с PrestaShop.

## Функции

### `_parse_node(node)`

**Назначение**: Рекурсивно разбирает XML-узел и возвращает его представление в виде словаря.

**Параметры**:
- `node`: XML-узел для разбора.

**Возвращает**:
- `tree` (dict): Словарь, представляющий XML-узел.

**Как работает функция**:

1.  Инициализирует пустой словарь `tree` для хранения структуры узла и пустой словарь `attrs` для хранения атрибутов узла.
2.  Проходит по всем атрибутам узла и добавляет их в словарь `attrs`, пропуская атрибуты `href` из пространства имен `http://www.w3.org/1999/xlink`.
3.  Извлекает текст (значение) узла, удаляя пробельные символы в начале и конце.
4.  Если у узла есть атрибуты, добавляет их в словарь `tree` под ключом `'attrs'`.
5.  Проходит по всем дочерним элементам узла.
    *   Рекурсивно вызывает `_parse_node` для каждого дочернего элемента.
    *   Создает словарь `cdict` с помощью функции `_make_dict`, где ключом является тег дочернего элемента, а значением - результат рекурсивного вызова `_parse_node`.
    *   Если дочерний элемент существует, значение текущего узла устанавливается в пустую строку.
    *   Если тег дочернего элемента встречается впервые, добавляет его в словарь `tree`.
    *   Если тег дочернего элемента встречается несколько раз, преобразует соответствующее значение в списке и добавляет новый элемент в этот список.
6.  Если у узла нет дочерних элементов, добавляет значение узла в словарь `tree` под ключом `'value'`.
7.  Если словарь `tree` содержит только ключ `'value'`, возвращает значение этого ключа.
8.  Возвращает словарь `tree`.

### `_make_dict(tag, value)`

**Назначение**: Создает новый словарь с тегом и значением. Если тег содержит пространство имен, разделяет его на пространство имен и имя тега.

**Параметры**:
-   `tag` (str): XML-тег.
-   `value`: Значение тега.

**Возвращает**:
-   `dict`: Словарь с тегом и значением.

**Как работает функция**:

1.  Принимает XML-тег и его значение в качестве параметров.
2.  Инициализирует `tag_values` значением `value`.
3.  Использует регулярное выражение для поиска пространства имен в теге.
    *   Если пространство имен найдено, извлекает его и имя тега.
    *   Создает словарь `tag_values`, содержащий пространство имен (`xmlns`) и значение (`value`).
    *   Заменяет `tag_values` словарем, содержащим пространство имен и исходное значение.
4.  Возвращает словарь, где ключ - тег, а значение - `tag_values`.

**Примеры**:

```python
_make_dict('address', 'some_value')  # {'address': 'some_value'}
_make_dict('{http://www.w3.org/1999/xlink}href', 'http://localhost:8080/api/addresses/1')  # {'href': {'value': 'http://localhost:8080/api/addresses/1', 'xmlns': 'http://www.w3.org/1999/xlink'}}
```

### `xml2dict(xml)`

**Назначение**: Преобразует XML-строку в словарь Python.

**Параметры**:
-   `xml` (str): XML-строка для преобразования.

**Возвращает**:
-   `dict`: Словарь, представляющий XML-строку.

**Как работает функция**:

1.  Парсит XML-строку с помощью `ET.fromstring()` и получает объект `element_tree`.
2.  Вызывает функцию `ET2dict` с полученным объектом `element_tree`.
3.  Возвращает словарь, полученный от функции `ET2dict`.

**Примеры**:

```python
xml_string = '<root><element>value</element></root>'
xml2dict(xml_string) #  {'root': {'element': 'value'}}
```

### `ET2dict(element_tree)`

**Назначение**: Преобразует объект ElementTree в словарь Python.

**Параметры**:
-   `element_tree`: Объект ElementTree для преобразования.

**Возвращает**:
-   `dict`: Словарь, представляющий структуру ElementTree.

**Как работает функция**:

1.  Вызывает функцию `_make_dict` с тегом корневого элемента и результатом вызова функции `_parse_node` для всего дерева элементов.
2.  Возвращает полученный словарь.

**Примеры**:

```python
import xml.etree.ElementTree as ET
xml_string = '<root><element>value</element></root>'
element_tree = ET.fromstring(xml_string)
ET2dict(element_tree) #  {'root': {'element': 'value'}}
```