# Модуль для конвертации XML и JSON данных
## Обзор

Модуль `xml_json_convertor.py` предоставляет утилиты для конвертации XML данных в словари и обратно. Он включает функции для парсинга XML строк, преобразования XML деревьев элементов в словари, а также для конвертации JSON словарей в XML строки. Модуль предназначен для работы с данными PrestaShop, где требуется преобразование данных между форматами XML и JSON.

## Подробней

Этот модуль предоставляет набор функций, упрощающих преобразование данных между форматами XML и JSON. Он включает функции для парсинга XML строк, преобразования XML деревьев элементов в словари, а также для конвертации JSON словарей в XML строки. Код модуля разработан с учетом специфики структуры данных, используемой в PrestaShop.

## Функции

### `dict2xml`

```python
def dict2xml(json_obj: dict, root_name: str = "product") -> str:
    """! Converts a JSON dictionary to an XML string.

    Args:
        json_obj (dict): JSON dictionary to convert.
        root_name (str, optional): Root element name. Defaults to "product".

    Returns:
        str: XML string representation of the JSON.
    """
```

**Назначение**: Преобразует JSON словарь в XML строку.

**Параметры**:

-   `json_obj` (dict): JSON словарь, который необходимо преобразовать.
-   `root_name` (str, optional): Имя корневого элемента XML. По умолчанию `"product"`.

**Возвращает**:

-   `str`: XML строковое представление JSON.

**Как работает функция**:

1.  Определяет внутреннюю функцию `build_xml_element`, которая рекурсивно строит XML элементы из JSON данных.
2.  Создает корневой элемент с именем, указанным в `root_name`.
3.  Вызывает `build_xml_element` для построения XML дерева на основе JSON данных.
4.  Преобразует XML дерево в строку и возвращает её.

```
JSON -> Создание корневого элемента
     |
     -> Рекурсивное построение XML элементов
     |
     -> Преобразование XML дерева в строку
     |
     XML
```

**Примеры**:

```python
json_data = {"product": {"name": "Test Product", "price": "10.00"}}
xml_output = dict2xml(json_data)
print(xml_output)  # Вывод: <product><name>Test Product</name><price>10.00</price></product>
```

#### Внутренние функции:

##### `build_xml_element`

```python
def build_xml_element(parent, data):
    """Recursively constructs XML elements from JSON data."""
```

**Назначение**: Рекурсивно строит XML элементы из JSON данных.

**Параметры**:

-   `parent`: Родительский XML элемент, к которому добавляются новые элементы.
-   `data`: JSON данные, которые необходимо преобразовать в XML.

**Как работает функция**:

1.  Проверяет тип данных: если это словарь, проходит по его элементам.
    -   Если ключ начинается с `"@"`, устанавливает его как атрибут родительского элемента.
    -   Если ключ равен `"#text"`, устанавливает значение элемента `parent.text`.
    -   Иначе создает новый дочерний элемент и рекурсивно вызывает `build_xml_element` для него.
2.  Если данные - список, проходит по элементам списка и рекурсивно вызывает `build_xml_element` для каждого элемента.
3.  Если данные - не словарь и не список, устанавливает текстовое значение родительского элемента.

```
JSON -> Проверка типа данных
     |
     -- Словарь: перебор элементов
     |    |
     |    -- Атрибут: установка атрибута
     |    |
     |    -- Текст: установка текста
     |    |
     |    -- Элемент: рекурсивный вызов
     |
     -- Список: перебор элементов и рекурсивный вызов
     |
     -- Другое: установка текста родительского элемента
```

### `_parse_node`

```python
def _parse_node(node: ET.Element) -> dict | str:
    """Parse an XML node into a dictionary.

    Args:
        node (ET.Element): The XML element to parse.

    Returns:
        dict | str: A dictionary representation of the XML node, or a string if the node has no attributes or children.
    """
```

**Назначение**: Преобразует XML узел в словарь.

**Параметры**:

-   `node` (ET.Element): XML элемент для парсинга.

**Возвращает**:

-   `dict | str`: Словарь, представляющий XML узел, или строка, если у узла нет атрибутов или потомков.

**Как работает функция**:

1.  Инициализирует словарь `tree` для хранения результатов.
2.  Извлекает атрибуты узла и сохраняет их в словаре `attrs`, пропуская атрибуты `href`.
3.  Извлекает текстовое значение узла.
4.  Если есть атрибуты, добавляет их в `tree`.
5.  Перебирает дочерние элементы узла, рекурсивно вызывая `_parse_node` для каждого из них.
6.  Формирует словарь `tree` на основе дочерних элементов.
7.  Если у узла нет потомков, добавляет текстовое значение в `tree`.
8.  Если `tree` содержит только значение, возвращает это значение.

```
XML Node -> Инициализация словаря
         |
         -> Извлечение атрибутов
         |
         -> Извлечение текстового значения
         |
         -> Перебор дочерних элементов
         |    |
         |    -> Рекурсивный вызов _parse_node
         |
         -> Формирование словаря
         |
         -> Возврат значения или словаря
```

### `_make_dict`

```python
def _make_dict(tag: str, value: any) -> dict:
    """Generate a new dictionary with tag and value.

    Args:
        tag (str): The tag name of the XML element.
        value (any): The value associated with the tag.

    Returns:
        dict: A dictionary with the tag name as the key and the value as the dictionary value.
    """
```

**Назначение**: Создает новый словарь с тегом и значением.

**Параметры**:

-   `tag` (str): Имя тега XML элемента.
-   `value` (any): Значение, связанное с тегом.

**Возвращает**:

-   `dict`: Словарь с именем тега в качестве ключа и значением в качестве значения словаря.

**Как работает функция**:

1.  Присваивает значение параметра `value` переменной `tag_values`.
2.  Ищет в теге регулярное выражение для извлечения пространства имен.
3.  Если пространство имен найдено, обновляет `tag_values` и тег.
4.  Возвращает словарь с тегом в качестве ключа и `tag_values` в качестве значения.

```
Tag, Value -> Присвоение значения
           |
           -> Поиск пространства имен
           |
           -> Обновление значения и тега (если найдено пространство имен)
           |
           -> Возврат словаря
```

### `xml2dict`

```python
def xml2dict(xml: str) -> dict:
    """Parse XML string into a dictionary.

    Args:
        xml (str): The XML string to parse.

    Returns:
        dict: The dictionary representation of the XML.
    """
```

**Назначение**: Преобразует XML строку в словарь.

**Параметры**:

-   `xml` (str): XML строка для парсинга.

**Возвращает**:

-   `dict`: Словарь, представляющий XML.

**Как работает функция**:

1.  Преобразует XML строку в дерево элементов с помощью `ET.fromstring`.
2.  Вызывает функцию `ET2dict` для преобразования дерева элементов в словарь.
3.  Возвращает полученный словарь.

```
XML String -> Преобразование в дерево элементов
           |
           -> Преобразование дерева элементов в словарь
           |
           -> Возврат словаря
```

### `ET2dict`

```python
def ET2dict(element_tree: ET.Element) -> dict:
    """Convert an XML element tree into a dictionary.

    Args:
        element_tree (ET.Element): The XML element tree.

    Returns:
        dict: The dictionary representation of the XML element tree.
    """
```

**Назначение**: Преобразует XML дерево элементов в словарь.

**Параметры**:

-   `element_tree` (ET.Element): XML дерево элементов.

**Возвращает**:

-   `dict`: Словарь, представляющий XML дерево элементов.

**Как работает функция**:

1.  Вызывает функцию `_make_dict` для преобразования дерева элементов в словарь.
2.  Возвращает полученный словарь.

```
XML Tree -> Преобразование в словарь
         |
         -> Возврат словаря
```

### `presta_fields_to_xml`

```python
def presta_fields_to_xml(presta_fields_dict: dict) -> str:
    """! Converts a JSON dictionary to an XML string with a fixed root name 'prestashop'.

    Args:
        presta_fields_dict (dict): JSON dictionary containing the data (without 'prestashop' key).

    Returns:
        str: XML string representation of the JSON.
    """
```

**Назначение**: Преобразует JSON словарь в XML строку с фиксированным корневым элементом "prestashop".

**Параметры**:

-   `presta_fields_dict` (dict): JSON словарь, содержащий данные (без ключа "prestashop").

**Возвращает**:

-   `str`: XML строковое представление JSON.

**Как работает функция**:

1.  Проверяет, является ли входной словарь пустым. Если да, возвращает пустую строку.
2.  Определяет внутреннюю функцию `build_xml_element`, которая рекурсивно строит XML элементы из JSON данных.
3.  Извлекает первый ключ из словаря (например, `"product"`, `"category"` и т. д.).
4.  Создает корневой элемент `"prestashop"`.
5.  Создает динамический элемент (например, `<product>`, `<category>`) внутри корневого элемента.
6.  Вызывает `build_xml_element` для построения XML дерева на основе JSON данных.
7.  Преобразует XML дерево в строку и возвращает её.

```
JSON -> Проверка на пустоту
     |
     -> Создание корневого элемента "prestashop"
     |
     -> Создание динамического элемента
     |
     -> Рекурсивное построение XML элементов
     |
     -> Преобразование XML дерева в строку
     |
     XML
```

**Примеры**:

```python
json_data = {"product": {"name": "Test Product", "price": "10.00"}}
xml_output = presta_fields_to_xml(json_data)
print(xml_output)
```

#### Внутренние функции:

##### `build_xml_element`

```python
def build_xml_element(parent, data):
    """Recursively constructs XML elements from JSON data."""
```

**Назначение**: Рекурсивно строит XML элементы из JSON данных.

**Параметры**:

-   `parent`: Родительский XML элемент, к которому добавляются новые элементы.
-   `data`: JSON данные, которые необходимо преобразовать в XML.

**Как работает функция**:

1.  Проверяет тип данных: если это словарь, проходит по его элементам.
    -   Если ключ начинается с `"@"`, устанавливает его как атрибут родительского элемента.
    -   Если ключ равен `"#text"`, устанавливает значение элемента `parent.text`.
    -   Иначе создает новый дочерний элемент и рекурсивно вызывает `build_xml_element` для него.
2.  Если данные - список, проходит по элементам списка и рекурсивно вызывает `build_xml_element` для каждого элемента.
3.  Если данные - не словарь и не список, устанавливает текстовое значение родительского элемента.

```
JSON -> Проверка типа данных
     |
     -- Словарь: перебор элементов
     |    |
     |    -- Атрибут: установка атрибута
     |    |
     |    -- Текст: установка текста
     |    |
     |    -- Элемент: рекурсивный вызов
     |
     -- Список: перебор элементов и рекурсивный вызов
     |
     -- Другое: установка текста родительского элемента
```