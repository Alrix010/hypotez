# Модуль `product_fields_translator`

## Обзор

Модуль `product_fields_translator` предназначен для перевода полей товара на языки, используемые в клиентской базе данных PrestaShop. Он обеспечивает соответствие между идентификаторами языков в системе поставщика и в системе клиента, а также позволяет обновлять и добавлять переводы товаров.

## Подробнее

Этот модуль играет важную роль в процессе интеграции данных о товарах из системы поставщика в систему клиента PrestaShop. Он учитывает различия в идентификаторах языков и обеспечивает правильное отображение мультиязычных полей товаров. Модуль использует схему языков клиента для преобразования идентификаторов языков в словаре полей товара.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
```

**Назначение**: Обновляет идентификатор языка в словаре `presta_fields_dict` на соответствующий идентификатор из схемы клиентских языков, если язык страницы совпадает.

**Параметры**:
- `presta_fields_dict` (dict): Словарь полей товара.
- `client_langs_schema` (dict | List[dict]): Схема языков клиента. Может быть списком словарей или словарем.
- `page_lang` (str): Язык страницы.

**Возвращает**:
- `dict`: Обновленный словарь `presta_fields_dict`.

**Как работает функция**:

1.  **Поиск идентификатора языка клиента**: Функция итерируется по схеме клиентских языков (`client_langs_schema`) и пытается найти соответствующий идентификатор языка, сравнивая `locale`, `iso_code` и `language_code` каждого языка в схеме с языком страницы (`page_lang`).
2.  **Обновление идентификатора в `presta_fields_dict`**: Если идентификатор языка найден, функция итерируется по полям в `presta_fields_dict` и, если поле содержит данные о языке, обновляет атрибут `id` в соответствии с найденным идентификатором языка клиента.

**Примеры**:

```python
presta_fields_dict = {
    'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Test'}]}
}
client_langs_schema = [
    {'id': '2', 'locale': 'ru-RU', 'iso_code': 'ru', 'language_code': 'ru-ru'}
]
page_lang = 'ru-RU'

updated_dict = rearrange_language_keys(presta_fields_dict, client_langs_schema, page_lang)
# Результат: {'name': {'language': [{'attrs': {'id': '2'}, 'value': 'Test'}]}}
```

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
\t    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,\n\t    полученные с сайта поставщика в виде словаря 
\t    ```
\t    {
\t\t    'language':[
\t\t\t\t\t    {'attrs':{'id':'1'}, 'value':value},
\t\t\t\t\t    ]
\t    }
\t    ```
\t    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была 
\t    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.
\t    Точные соответствия я получаю в схеме языков клиента 
\t    locator_description
\t    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера
\t    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON
\t  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. 
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
```

**Назначение**: Переводит мультиязычные поля в соответствии со схемой значений `id` языка в базе данных клиента.

**Параметры**:
- `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика.
- `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
- `page_lang` (str, optional): Язык страницы поставщика в коде (например, en-US, ru-RU, he_HE). Если не задан, функция пытается определить язык по тексту.

**Возвращает**:
- `dict`: Переведенный словарь полей товара `presta_fields_dict`.

**Как работает функция**:

1.  **Переупорядочивание ключей**: Вызывает функцию `rearrange_language_keys` для обновления идентификаторов языков в словаре `presta_fields_dict`.
2.  **Проверка и добавление перевода**: Проверяет, есть ли переводы товара в таблице переводов. Если перевода нет, добавляет текущий перевод как новый.
3.  **Перевод из таблицы**: Если переводы есть, функция итерируется по схемам языков клиента и переведенным записям, чтобы найти соответствия. Если соответствие найдено, функция записывает перевод из таблицы в `presta_fields_dict`.

**Примеры**:

```python
presta_fields_dict = {
    'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Test'}]},
    'reference': '123'
}
client_langs_schema = [
    {'id': '2', 'locale': 'ru-RU', 'iso_code': 'ru', 'language_code': 'ru-ru'}
]
page_lang = 'ru-RU'

translated_dict = translate_presta_fields_dict(presta_fields_dict, client_langs_schema, page_lang)
# Результат: {'name': {'language': [{'attrs': {'id': '2'}, 'value': 'Test'}]}, 'reference': '123'}
```