# Модуль `product_fields`

## Обзор

Модуль `product_fields` предназначен для описания и управления полями товара в формате, совместимом с API PrestaShop. Он содержит класс `ProductFields`, который позволяет задавать и получать значения различных полей товара, а также предоставляет методы для работы с мультиязычными значениями и ассоциациями.

## Подробнее

Этот модуль является частью проекта `hypotez` и используется для автоматизации процесса загрузки и обновления информации о товарах в PrestaShop. Модуль обеспечивает удобный интерфейс для работы с полями товаров, поддерживая мультиязычность и различные типы данных.

## Классы

### `ProductFields`

**Описание**: Класс для представления полей товара в формате API PrestaShop. Предоставляет интерфейс для управления полями товара, включая установку значений, работу с мультиязычными полями и управление ассоциациями (категории, изображения и т.д.).

**Принцип работы**:

1.  При инициализации класса происходит загрузка значений полей по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.
2.  Класс предоставляет свойства (property) для доступа к каждому полю товара. Для мультиязычных полей используется метод `_set_multilang_value` для установки значений на разных языках.
3.  Для работы с ассоциациями (категории, изображения и т.д.) предусмотрены методы для добавления, удаления и очистки связей.
4.  Метод `to_dict` преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

**Атрибуты**:

*   `presta_fields` (SimpleNamespace): Объект, хранящий значения полей товара. Инициализируется в методе `__post_init__`.
*   `id_lang` (int): ID языка, используемый по умолчанию для мультиязычных полей. По умолчанию равен 1.

**Методы**:

*   `__post_init__()`: Выполняет инициализацию объекта после его создания. Запускает метод `_payload()` для загрузки значений полей.
*   `_payload() -> bool`: Загружает значения полей по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.
*   `_set_multilang_value(field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool`: Устанавливает мультиязычное значение для указанного поля.
*   `to_dict() -> Dict[str, Any]`: Преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.
*   `_format_multilang_value(data: Any) -> List[Dict[str, str]]`: Форматирует мультиязычные значения в список словарей для PrestaShop API.
*   `_ensure_associations()`: Убеждается, что структура associations существует в presta_fields.
*   `additional_category_append(category_id: int | str)`: Добавляет связь с категорией, если ее еще нет.
*   `additional_categories_clear()`: Очищает все связи с категориями.
*   `product_image_append(image_id: int)`: Добавляет связь с изображением.
*   `product_images_clear()`: Очищает все связи с изображениями.
*   `images_urls_append(value: List[str] = None)`: Устанавливает список URL, откуда скачать дополнительные изображения.
*   `product_combination_append(combination_id: int)`: Добавляет связь с комбинацией.
*   `product_combinations_clear()`: Очищает все связи с комбинациями.
*   `product_options_append(product_option_value_id: int)`: Добавляет связь со значением опции продукта.
*   `product_options_clear()`: Очищает все связи со значениями опций продукта.
*   `product_features_append(feature_id: int, feature_value_id: int)`: Добавляет связь с характеристикой продукта.
*   `product_features_clear()`: Очищает все связи с характеристиками продукта.
*   `product_tag_append(tag_id: int)`: Добавляет связь с тегом.
*   `product_tags_clear()`: Очищает все связи с тегами.
*   `product_stock_available_append(stock_available_id: int, product_attribute_id: int)`: Добавляет связь с доступностью на складе.
*   `product_stock_availables_clear()`: Очищает все связи с доступностью на складе.
*   `product_attachment_append(attachment_id: int)`: Добавляет связь с вложением.
*   `product_attachments_clear()`: Очищает все связи с вложениями.
*   `product_accessory_append(accessory_id: int)`: Добавляет связь с аксессуаром.
*   `product_accessories_clear()`: Очищает все связи с аксессуарами.
*   `product_bundle_append(bundle_id: int, product_attribute_id: int, quantity: int)`: Добавляет связь с бандлом продукта.
*   `product_bundle_clear()`: Очищает все связи с бандлами продуктов.
*   Свойства (properties) для доступа к полям таблицы `ps_product` и `ps_product_lang`, такие как `id_product`, `name`, `description` и т.д.

## Функции

### `_payload`

```python
def _payload(self) -> bool:
    """
    Загрузка дефолтных значений полей.
    Returns:
        bool: True, если загрузка прошла успешно, иначе False.
    """
    ...
```

**Назначение**: Загружает значения полей товара по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.

**Параметры**:

*   Нет

**Возвращает**:

*   `bool`: `True`, если загрузка прошла успешно, иначе `False`.

**Вызывает исключения**:

*   `Exception`: В случае ошибок при чтении файлов или конвертации данных.

**Как работает функция**:

1.  Формирует путь к файлам `fields_list.txt` и `product_fields_default_values.json`, которые содержат список полей и их значения по умолчанию, соответственно.
2.  Считывает список полей из файла `fields_list.txt` с помощью функции `read_text_file` и сохраняет его в переменной `presta_fields_list`.
3.  Если не удалось прочитать список полей из файла, функция логирует ошибку и возвращает `False`.
4.  Пытается создать объект `SimpleNamespace` из списка полей, инициализируя все поля значением `None`.
5.  В случае ошибки при создании объекта `SimpleNamespace`, функция логирует ошибку и возвращает `None`.
6.  Загружает словарь значений полей из файла `product_fields_default_values.json` с помощью функции `j_loads`.
7.  Если не удалось загрузить словарь, функция логирует ошибку и возвращает `False`.
8.  Пытается установить значения полей объекта `presta_fields` из загруженного словаря.
9.  В случае ошибки при установке значений, функция логирует ошибку и возвращает `False`.
10. В случае успеха функция возвращает `True`.

**ASCII Flowchart**:

```
A [Определение путей к файлам]
|
B [Чтение списка полей из fields_list.txt]
|
C [Проверка успешности чтения списка полей]
|
D [Создание объекта SimpleNamespace из списка полей]
|
E [Чтение словаря значений полей из product_fields_default_values.json]
|
F [Проверка успешности чтения словаря]
|
G [Установка значений полей объекта presta_fields из словаря]
|
H [Возврат True в случае успеха]
```

**Примеры**:

```python
product_fields = ProductFields()
success = product_fields._payload()
print(success)  # Выведет True или False в зависимости от успешности загрузки
```

### `_set_multilang_value`

```python
def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool:
    """
    Устанавливает мультиязычное значение для заданного поля.

    Args:
        field_name (str): Имя поля (например, 'name', 'description').
        value (str): Значение для установки.
        id_lang (Optional[Union[int, str]]): ID языка. Если не указан, используется self.id_lan.

    Returns:
        bool: True, если значение успешно установлено, False в случае ошибки.
    """
    ...
```

**Назначение**: Устанавливает мультиязычное значение для заданного поля товара.

**Параметры**:

*   `field_name` (str): Имя поля, для которого устанавливается значение.
*   `value` (str): Значение, которое необходимо установить.
*   `id_lang` (Optional[int | str]): ID языка. Если не указан, используется `self.id_lang`.

**Возвращает**:

*   `bool`: `True`, если значение успешно установлено, `False` в случае ошибки.

**Вызывает исключения**:

*   `Exception`: В случае ошибки при установке значения.

**Внутренние функции**:

*   `escape_and_strip(text: str) -> str`: Очищает и экранирует строку, заменяя символы `\'` и `\"` на `\\\'` и `\\"`, удаляя пробелы в начале и конце.

**Как работает функция**:

1.  Экранирует и очищает входящее значение `value` с помощью внутренней функции `escape_and_strip`.
2.  Определяет ID языка `id_lang`. Если `id_lang` не передан, используется `self.id_lang`.
3.  Формирует структуру данных `lang_data` для хранения значения и ID языка.
4.  Пытается получить текущее значение поля `field_name` из объекта `self.presta_fields`.
5.  Если поле не существует, создает его и присваивает ему словарь с данными о языке.
6.  Если поле существует, проверяет, является ли оно словарем с ключом `'language'`, содержащим список. Если нет, создает словарь с данными о языке.
7.  Если поле существует и имеет правильную структуру, ищет в списке языков язык с соответствующим `id_lang`. Если язык найден, обновляет его значение. Если язык не найден, добавляет новую запись в список.
8.  В случае успеха возвращает `True`.
9.  В случае ошибки логирует ошибку и возвращает `False`.

**ASCII Flowchart**:

```
A [Экранирование и очистка значения]
|
B [Определение ID языка]
|
C [Формирование структуры данных lang_data]
|
D [Получение текущего значения поля]
|
E [Проверка существования поля]
|
F [Создание поля, если оно не существует]
|
G [Проверка структуры поля]
|
H [Создание словаря с данными о языке, если структура неправильная]
|
I [Поиск языка в списке языков]
|
J [Обновление значения языка, если он найден]
|
K [Добавление новой записи о языке, если он не найден]
|
L [Возврат True в случае успеха]
```

**Примеры**:

```python
product_fields = ProductFields()
success = product_fields._set_multilang_value('name', 'Test Product', id_lang=1)
print(success)  # Выведет True или False в зависимости от успешности установки
```

### `to_dict`

```python
def to_dict(self) -> Dict[str, Any]:
    """
    Преобразует объект ProductFields в словарь для PrestaShop API,
    исключая ключи, значения которых равны None или пустой строке,
    и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

    Returns:
        Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
    """
    ...
```

**Назначение**: Преобразует объект `ProductFields` в словарь, пригодный для отправки в API PrestaShop.

**Параметры**:

*   Нет

**Возвращает**:

*   `Dict[str, Any]`: Словарь с полями, готовый для PrestaShop API.

**Как работает функция**:

1.  Создает пустой словарь `product_dict`.
2.  Для каждого поля товара (например, `id_product`, `name`, `description` и т.д.) проверяет, установлено ли значение.
3.  Если значение установлено, преобразует его в строку и добавляет в словарь `product_dict`.
4.  Для мультиязычных полей вызывает метод `_format_multilang_value` для форматирования значений.
5.  Обрабатывает ассоциации (категории, изображения и т.д.), добавляя их в словарь `product_dict` в нужном формате.
6.  Возвращает словарь `product_dict`.

**ASCII Flowchart**:

```
A [Создание пустого словаря product_dict]
|
B [Перебор полей товара]
|
C [Проверка, установлено ли значение поля]
|
D [Преобразование значения в строку и добавление в словарь]
|
E [Форматирование мультиязычных значений]
|
F [Обработка ассоциаций]
|
G [Возврат словаря product_dict]
```

**Примеры**:

```python
product_fields = ProductFields()
product_fields.name = 'Test Product'
product_dict = product_fields.to_dict()
print(product_dict)  # Выведет словарь с полями товара
```

-------------------------------------------------------------------------------------