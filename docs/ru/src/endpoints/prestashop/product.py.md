# Модуль `product`

## Обзор

Модуль `product` предназначен для взаимодействия с товарами в PrestaShop. Он предоставляет классы и функции для получения информации о товарах, добавления новых товаров, а также для работы с категориями товаров. Модуль использует API PrestaShop для выполнения этих задач.

## Подробней

Этот модуль является частью проекта `hypotez` и отвечает за интеграцию с PrestaShop для управления товарными позициями. Он включает в себя:

- Класс `Config` для хранения конфигурационных параметров API PrestaShop.
- Класс `PrestaProduct`, который наследует `PrestaShop` и предоставляет методы для работы с товарами, такие как получение схемы товара, добавление нового товара и получение родительских категорий.
- Функции для примеров использования, такие как добавление нового товара (`example_add_new_product`) и получение информации о товаре (`example_get_product`).

Модуль использует модуль `logger` для логирования ошибок и отладочной информации.

## Классы

### `Config`

**Описание**: Класс конфигурации для настроек продукта PrestaShop.

**Принцип работы**:
Класс `Config` содержит статические переменные, определяющие параметры подключения к API PrestaShop, такие как домен API, ключ API и формат данных для запросов. Он также определяет, используются ли переменные окружения или параметры из `keepass` для получения учетных данных.

**Атрибуты**:

- `USE_ENV` (bool): Указывает, использовать ли переменные окружения для конфигурации. По умолчанию `False`.
- `MODE` (str): Режим работы (например, `dev`, `dev8`). По умолчанию `'dev'`.
- `POST_FORMAT` (str): Формат отправляемых данных (например, `XML`). По умолчанию `'XML'`.
- `API_DOMAIN` (str): Домен API PrestaShop.
- `API_KEY` (str): Ключ API PrestaShop.

### `PrestaProduct`

**Описание**: Класс для манипуляций с товарами в PrestaShop.

**Принцип работы**:
Класс `PrestaProduct` наследует класс `PrestaShop` и предоставляет методы для взаимодействия с API PrestaShop для управления товарами. Он включает в себя методы для получения схемы товара, добавления нового товара и получения родительских категорий.

**Методы**:

- `__init__(self, api_key: Optional[str] = '', api_domain: Optional[str] = '', *args, **kwargs) -> None`:
    Инициализирует объект `PrestaProduct`.
    
    **Параметры**:
    - `api_key` (Optional[str], optional): Ключ API PrestaShop. По умолчанию ''.
    - `api_domain` (Optional[str], optional): Домен API PrestaShop. По умолчанию ''.

    **Как работает функция**:
     1.  Инициализирует класс `PrestaProduct` с ключом API и доменом API, наследуя функциональность от класса `PrestaShop`.
     2.  Если `api_key` или `api_domain` не предоставлены, использует значения по умолчанию из класса `Config`.

     ```ascii
     Инициализация PrestaProduct
     │
     ├─── Проверка api_key
     │    └─── Использовать Config.API_KEY, если api_key не предоставлен
     │
     ├─── Проверка api_domain
     │    └─── Использовать Config.API_DOMAIN, если api_domain не предоставлен
     │
     └─── Инициализация PrestaShop с api_key и api_domain
     ```

- `get_product_schema(self, resource_id: Optional[str | int] = None, schema: Optional[str] = 'blank') -> dict`:
    Получает схему для ресурса товара из PrestaShop.
    
    **Параметры**:
    - `resource_id` (Optional[str  |  int], optional): ID ресурса товара. По умолчанию `None`.
    - `schema` (Optional[str], optional): Тип схемы. По умолчанию `'blank'`.

    **Возвращает**:
    - `dict`: Схема для ресурса товара.

    **Как работает функция**:
     1.  Получает схему товара, используя метод `get_schema` класса `PrestaShop`.
     2.  Передает параметры `resource`, `resource_id`, `schema` и `display` для формирования запроса к API PrestaShop.

     ```ascii
     Получение схемы товара
     │
     └─── Вызов get_schema с параметрами resource='products', resource_id, schema, display='full'
     │
     └─── Возврат схемы товара
     ```

- `get_parent_category(self, id_category: int) -> Optional[int]`:
    Рекурсивно извлекает родительские категории из PrestaShop для заданной категории.
    
    **Параметры**:
    - `id_category` (int): ID категории.

    **Возвращает**:
    - `Optional[int]`: ID родительской категории (int).

    **Вызывает исключения**:
    - `Exception`: Если возникает ошибка при получении категории.

    **Как работает функция**:
     1.  Выполняет чтение данных о категории из PrestaShop по её ID.
     2.  Извлекает ID родительской категории из полученных данных.
     3.  Обрабатывает исключения при запросе к API и логирует ошибки.

     ```ascii
     Получение родительской категории
     │
     ├─── Чтение данных категории из PrestaShop по id_category
     │
     ├─── Извлечение id_parent из данных категории
     │
     ├─── Обработка исключений
     │    └─── Логирование ошибок, если категория не найдена или произошла ошибка при запросе
     │
     └─── Возврат id_parent
     ```

- `_add_parent_categories(self, f: ProductFields) -> None`:
    Вычисляет и добавляет все родительские категории для списка ID категорий к объекту `ProductFields`.
    
    **Параметры**:
    - `f` (ProductFields): Объект `ProductFields`, к которому нужно добавить родительские категории.

    **Как работает функция**:
     1.  Перебирает дополнительные категории из объекта `ProductFields`.
     2.  Проверяет, является ли категория корневой (ID 1 или 2).
     3.  Рекурсивно получает родительские категории, пока не достигнет корневой категории.
     4.  Добавляет родительские категории в объект `ProductFields`.

     ```ascii
     Добавление родительских категорий
     │
     ├─── Перебор дополнительных категорий из ProductFields
     │
     ├─── Проверка, является ли категория корневой (ID 1 или 2)
     │
     ├─── Рекурсивное получение родительских категорий
     │    └─── Вызов get_parent_category для получения родительской категории
     │    └─── Добавление родительской категории в ProductFields
     │
     └─── Завершение
     ```

- `get_product(self, id_product: int, **kwards) -> dict`:
    Возвращает словарь полей товара из магазина PrestaShop.
    
    **Параметры**:
    - `id_product` (int): Значение поля ID в таблице `product` PrestaShop.
    - `**kwards`: Дополнительные параметры запроса.

    **Возвращает**:
    - `dict`: Словарь, содержащий информацию о товаре.

    **Как работает функция**:
     1.  Формирует параметры запроса для получения данных о товаре в формате JSON.
     2.  Вызывает метод `read` для выполнения запроса к API PrestaShop.
     3.  Возвращает словарь с полями товара.

     ```ascii
     Получение информации о товаре
     │
     ├─── Формирование параметров запроса (data_format='JSON')
     │
     ├─── Вызов метода read с параметрами resource='products', resource_id=id_product, **kwards
     │
     └─── Возврат словаря с информацией о товаре
     ```

- `add_new_product(self, f: ProductFields) -> dict`:
    Добавляет новый продукт в PrestaShop.
    
    **Параметры**:
    - `f` (ProductFields): Экземпляр класса `ProductFields`, содержащий информацию о продукте.

    **Возвращает**:
    - `dict`: Возвращает объект `ProductFields` с установленным `id_product`, если продукт был успешно добавлен, иначе `None`.

    **Как работает функция**:
     1.  Дополняет `id_category_default` в поле `additional_categories` для поиска родительских категорий.
     2.  Вызывает метод `_add_parent_categories` для добавления родительских категорий.
     3.  Преобразует объект `ProductFields` в словарь формата PrestaShop.
     4.  Преобразует словарь в XML-формат (если `Config.POST_FORMAT == 'XML'`).
     5.  Отправляет данные в API PrestaShop для создания нового продукта.
     6.  Загружает изображение продукта (если указан `local_image_path`).
     7.  Логирует информацию о добавленном продукте и возвращает объект `ProductFields` с `id_product`.

     ```ascii
     Добавление нового продукта
     │
     ├─── Дополнение id_category_default в additional_categories
     │
     ├─── Добавление родительских категорий (_add_parent_categories)
     │
     ├─── Преобразование ProductFields в словарь формата PrestaShop
     │
     ├─── Преобразование словаря в XML-формат (если Config.POST_FORMAT == 'XML')
     │
     ├─── Отправка данных в API PrestaShop для создания нового продукта
     │
     ├─── Загрузка изображения продукта (если local_image_path указан)
     │
     └─── Логирование информации о добавленном продукте и возврат ProductFields с id_product
     ```

## Функции

### `example_add_new_product() -> None`

**Назначение**: Пример добавления товара в PrestaShop.

**Как работает функция**:

 1. Создает экземпляр класса `PrestaProduct` с использованием API_KEY и API_DOMAIN из класса `Config`.
 2. Загружает пример данных о продукте из JSON-файла.
 3. Преобразует пример данных в XML формат, используя функцию `presta_fields_to_xml`.
 4. Отправляет данные о продукте в PrestaShop, используя метод `_exec`.

```ascii
example_add_new_product
│
├─── Создание экземпляра PrestaProduct
│
├─── Загрузка данных о продукте из JSON-файла
│
├─── Преобразование данных в XML-формат
│
└─── Отправка данных о продукте в PrestaShop через API
```

### `example_get_product(id_product: int, **kwards) -> None`

**Назначение**: Пример получения информации о товаре из PrestaShop.

**Параметры**:

- `id_product` (int): ID товара, информацию о котором необходимо получить.

**Как работает функция**:

 1. Создает экземпляр класса `PrestaProduct` с использованием API_KEY и API_DOMAIN из класса `Config`.
 2. Формирует словарь `kwards` с параметрами запроса, такими как формат данных (`data_format`), отображение (`display`) и схема (`schema`).
 3. Вызывает метод `get_product` для получения информации о товаре с указанным ID.
 4. Сохраняет полученную информацию о товаре в JSON-файл.

```ascii
example_get_product
│
├─── Создание экземпляра PrestaProduct
│
├─── Формирование параметров запроса (data_format, display, schema)
│
├─── Вызов метода get_product для получения информации о товаре
│
└─── Сохранение информации о товаре в JSON-файл
```