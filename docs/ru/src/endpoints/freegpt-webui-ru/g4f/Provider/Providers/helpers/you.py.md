# Модуль для взаимодействия с API You.com

## Обзор

Модуль предназначен для отправки запросов к API You.com и получения ответов в режиме стриминга. Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и предназначен для интеграции с другими частями проекта `hypotez`.

## Подробней

Модуль содержит функции для преобразования сообщений в формат, ожидаемый API You.com, и отправки запросов с необходимыми заголовками. Он также обрабатывает ответы, извлекая полезную информацию и выводя ее в режиме реального времени.

## Функции

### `transform`

```python
def transform(messages: list) -> list:
    """Преобразует список сообщений в формат, ожидаемый API You.com.

    Args:
        messages (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами 'role' и 'content'.

    Returns:
        list: Список словарей, где каждый словарь содержит ключи 'question' и 'answer'.

    Как работает функция:
    1. Инициализируется пустой список `result` для хранения преобразованных сообщений и индекс `i` для итерации по входному списку `messages`.
    2. Запускается цикл `while`, который продолжается до тех пор, пока `i` меньше длины списка `messages`.
    3. Внутри цикла проверяется роль текущего сообщения:
       - Если `messages[i]['role'] == 'user'`, то сообщение рассматривается как вопрос. Значение 'content' этого сообщения присваивается переменной `question`, а индекс `i` увеличивается на 1.
       - Далее проверяется, существует ли следующее сообщение и имеет ли оно роль 'assistant'. Если да, то это сообщение рассматривается как ответ на предыдущий вопрос. Значение 'content' этого сообщения присваивается переменной `answer`, а индекс `i` снова увеличивается на 1. Если следующего сообщения нет или его роль не 'assistant', то переменной `answer` присваивается пустая строка.
       - В `result` добавляется словарь с ключами `question` и `answer`, содержащими соответственно вопрос и ответ.
       - Если `messages[i]['role'] == 'assistant'`, то сообщение рассматривается как ответ без вопроса. В `result` добавляется словарь с пустым вопросом и ответом, взятым из 'content' текущего сообщения. Индекс `i` увеличивается на 1.
       - Если `messages[i]['role'] == 'system'`, то сообщение рассматривается как системное сообщение. В `result` добавляется словарь с вопросом, взятым из 'content' текущего сообщения, и пустым ответом. Индекс `i` увеличивается на 1.
    4. Цикл завершается, когда все сообщения в списке `messages` обработаны.
    5. Функция возвращает список `result`, содержащий преобразованные сообщения.

    ASCII flowchart:

    Начало --> Проверка роли сообщения
               |
               -- user? --> Извлечение вопроса --> Проверка следующего сообщения --> assistant? --> Извлечение ответа --> Добавление в результат
               |         |                                                     |
               |         ------------------------------------------------------- NO  --> answer = '' -->  Добавление в результат
               |
               -- assistant? --> Извлечение ответа --> Добавление в результат
               |
               -- system? --> Извлечение вопроса --> Добавление в результат
               |
               ----------------------------------------------------------------------------------------------------------
               |
               Конец цикла --> Возврат результата

    Примеры:
        >>> messages = [{'role': 'user', 'content': 'Привет'}, {'role': 'assistant', 'content': 'Здравствуйте'}]
        >>> transform(messages)
        [{'question': 'Привет', 'answer': 'Здравствуйте'}]

        >>> messages = [{'role': 'user', 'content': 'Как дела?'}]
        >>> transform(messages)
        [{'question': 'Как дела?', 'answer': ''}]

        >>> messages = [{'role': 'assistant', 'content': 'Все хорошо'}]
        >>> transform(messages)
        [{'question': '', 'answer': 'Все хорошо'}]
    """
    result = []
    i = 0

    while i < len(messages):
        if messages[i]['role'] == 'user':
            question = messages[i]['content']
            i += 1

            if i < len(messages) and messages[i]['role'] == 'assistant':
                answer = messages[i]['content']
                i += 1
            else:
                answer = ''

            result.append({'question': question, 'answer': answer})

        elif messages[i]['role'] == 'assistant':
            result.append({'question': '', 'answer': messages[i]['content']})
            i += 1

        elif messages[i]['role'] == 'system':
            result.append({'question': messages[i]['content'], 'answer': ''})
            i += 1
            
    return result
```

### `output`

```python
def output(chunk):
    """Обрабатывает полученный чанк данных из API You.com.

    Args:
        chunk (bytes): Чанк данных, полученный из API.

    Как работает функция:
    1. Проверяет, содержит ли чанк данных строку `b'"youChatToken"'`.
    2. Если строка найдена, декодирует чанк, разделяет его по строке `'data: '` и загружает JSON из второй части.
    3. Извлекает значение ключа `'youChatToken'` из загруженного JSON и выводит его в стандартный поток вывода,
       не добавляя символ новой строки в конце и сбрасывая буфер вывода.

    ASCII flowchart:

    Начало --> Проверка наличия youChatToken в чанке
               |
               -- Да --> Декодирование чанка --> Разделение по 'data: ' --> Загрузка JSON --> Извлечение youChatToken --> Вывод в stdout
               |
               -- Нет --> Конец

    """
    if b'"youChatToken"' in chunk:
        chunk_json = json.loads(chunk.decode().split('data: ')[1])

        print(chunk_json['youChatToken'], flush=True, end = '')