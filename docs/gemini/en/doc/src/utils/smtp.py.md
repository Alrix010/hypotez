# Модуль SMTP Email Interface

## Обзор

Модуль `src.utils.smtp.py` предоставляет функциональность для отправки и получения электронной почты с использованием сервера SMTP или IMAP. Он содержит функции для отправки писем с помощью SMTP и получения писем с помощью IMAP.

## Подробности

Модуль предназначен для взаимодействия с почтовыми серверами SMTP и IMAP для отправки и получения электронных писем. 

- **Безопасность:** 
    - Не храните учетные данные (логин, пароль) непосредственно в коде. Используйте переменные окружения (например, `os.environ`).
- **Обработка ошибок:** 
    - Модуль включает в себя надежную обработку ошибок, регистрируя исключения с подробной информацией (тема, текст письма и т. д.) для облегчения отладки.
- **Парсинг писем:** 
    - Функция `receive` умеет обрабатывать различные форматы электронных писем, предотвращая потенциальные проблемы.

## Таблица содержания

- [Функции](#функции)
    - [send](#send)
    - [receive](#receive)

## Функции

### send

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Отправляет электронное письмо. Возвращает True, если отправка прошла успешно, False в противном случае. Регистрирует ошибки."""
    try:
        # Создает SMTP-соединение
        smtp = smtplib.SMTP(_connection['server'], _connection['port'])
        smtp.ehlo()
        smtp.starttls()
        smtp.login(_connection['user'], _connection['password'])

        message = MIMEText(body)
        message["Subject"] = subject
        message["From"] = _connection['user']
        message["To"] = to

        smtp.sendmail(_connection['user'], to, message.as_string())
        smtp.quit()
        return True

    except Exception as ex:
        logger.error(f"Ошибка отправки письма. Тема: {subject}. Текст: {body}. Ошибка: {ex}", exc_info=True)
        return False
```

**Описание:**

- Функция `send` используется для отправки электронных писем через сервер SMTP.
- Она принимает три аргумента:
    - `subject`: Тема письма (необязательный параметр).
    - `body`: Текст письма (необязательный параметр).
    - `to`: Адрес получателя (необязательный параметр).
- Функция устанавливает соединение с сервером SMTP, используя данные из словаря `_connection`.
- Она создает объект `MIMEText` для представления письма, заполняет его заголовки (тема, отправитель, получатель) и отправляет письмо.
- Функция возвращает `True`, если отправка прошла успешно, и `False` в случае ошибки. 
- В случае ошибки функция записывает ее в лог с помощью `logger.error`.

### receive

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Получает электронные письма. Возвращает список словарей с данными писем, если получение прошло успешно, иначе None. Регистрирует ошибки."""
    try:
        mail = imaplib.IMAP4_SSL(imap_server)
        mail.login(user, password)
        mail.select(folder)

        status, data = mail.search(None, 'ALL')
        email_ids = data[0].split()

        emails = []
        for email_id in email_ids:
            status, data = mail.fetch(email_id, '(RFC822)')
            raw_email = data[0][1]
            msg = email.message_from_bytes(raw_email)

            email_data = {
                'subject': msg['subject'],
                'from': msg['from'],
                'body': msg.get_payload(decode=True, _charset="utf-8").decode("utf-8", "ignore")  # Декодирование и обработка возможных ошибок
            }
            emails.append(email_data)

        mail.close()
        mail.logout()
        return emails

    except Exception as ex:
        logger.error(f"Ошибка при получении писем: {ex}", exc_info=True)
        return None
```

**Описание:**

- Функция `receive` используется для получения электронных писем с сервера IMAP.
- Она принимает четыре аргумента:
    - `imap_server`: Адрес сервера IMAP.
    - `user`: Логин пользователя.
    - `password`: Пароль пользователя.
    - `folder`: Имя папки, из которой нужно получить письма (по умолчанию 'inbox').
- Функция устанавливает соединение с сервером IMAP, используя предоставленные данные.
- Она получает список идентификаторов писем, а затем для каждого идентификатора извлекает сырые данные письма.
- После этого данные парсятся и сохраняются в словарь с ключами 'subject', 'from' и 'body'.
- Список таких словарей возвращается из функции.
- В случае ошибки функция записывает ее в лог с помощью `logger.error`.

## Важные замечания по безопасности и надежности

- **Словарь _connection:** Не храните учетные данные (логин, пароль) напрямую в коде. Используйте переменные окружения (например, `os.environ`).
- **Обработка ошибок:** Модуль включает в себя надежную обработку ошибок, регистрируя исключения с подробной информацией (тема, текст письма и т. д.). Это очень полезно для отладки.
- **Парсинг писем:** Функция `receive` умеет обрабатывать различные форматы электронных писем, предотвращая потенциальные проблемы.
- **Обработка MIME:** Модуль правильно использует `MIMEText` для создания сообщения, что необходимо для отправки обычных текстовых писем.