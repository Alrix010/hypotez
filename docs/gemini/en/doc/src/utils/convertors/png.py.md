# Модуль `src.utils.convertors.png`

## Обзор

Модуль `src.utils.convertors.png` предоставляет инструменты для преобразования текста в изображения PNG. Он использует библиотеку Pillow (PIL) для создания изображений с текстом, фоном, границами и шрифтами.

## Детали

Этот модуль используется в `hypotez` для создания изображений из текстовых файлов.  Он позволяет генерировать изображения PNG с текстом, который может быть получен из файла или списка строк. Модуль предоставляет функции для настройки таких параметров, как размер холста, отступы, цвет фона, цвет текста, шрифт и уровень детализации логгирования.

## Классы

### `TextToImageGenerator`

**Описание**: Класс `TextToImageGenerator`  предоставляет функционал для генерации изображений PNG из текста. Он позволяет задать различные параметры, такие как размер изображения, шрифт, цвет фона и текст, а также управлять уровнем детализации логгирования.

**Атрибуты**:

- `default_output_dir` (Path): Путь по умолчанию для сохранения выходных файлов PNG.
- `default_canvas_size` (Tuple[int, int]): Размер холста по умолчанию.
- `default_padding` (float): Отступ по умолчанию в виде доли размера холста.
- `default_background` (str): Цвет фона по умолчанию.
- `default_text_color` (str): Цвет текста по умолчанию.
- `default_log_level` (str): Уровень детализации логгирования по умолчанию.

**Методы**:

#### `generate_images`

**Цель**:  Генерирует изображения PNG из предоставленных текстовых строк.

**Параметры**:

- `lines` (List[str]): Список строк, из которых необходимо сгенерировать изображения.
- `output_dir` (str | Path, optional):  Каталог для сохранения выходных изображений. По умолчанию `"./output"`.
- `font` (str | ImageFont.ImageFont, optional): Шрифт, который необходимо использовать для текста. По умолчанию "sans-serif".
- `canvas_size` (Tuple[int, int], optional): Размер холста в пикселях. По умолчанию (1024, 1024).
- `padding` (float, optional): Доля размера холста, которая будет использоваться как пустая граница. По умолчанию 0.10.
- `background_color` (str, optional): Цвет фона для изображений. По умолчанию "white".
- `text_color` (str, optional): Цвет текста. По умолчанию "black".
- `log_level` (int | str | bool, optional): Уровень детализации логгирования. По умолчанию "WARNING".
- `clobber` (bool, optional):  Если `True`, перезаписывает существующие файлы. По умолчанию `False`.

**Возвращает**:

- `List[Path]`: Список путей к сгенерированным изображениям PNG.

**Пример**:

```python
>>> generator = TextToImageGenerator()
>>> lines = ["Text 1", "Text 2", "Text 3"]
>>> output_dir = "./output"
>>> images = await generator.generate_images(lines, output_dir=output_dir)
>>> print(images)
[PosixPath('./output/Text 1.png'), PosixPath('./output/Text 2.png'), PosixPath('./output/Text 3.png')]
```

**Описание работы функции**: 

- Функция `generate_images` создает изображения PNG для каждой строки текста в списке `lines`. 
- Она использует `output_directory` для сохранения изображений, если не указано иное. 
- Функция настраивает логгирование в соответствии с уровнем `log_level`. 
- Она использует `canvas_size` и `padding` для создания холста с границами. 
- Функция генерирует изображение PNG для каждой строки с помощью `generate_png` и сохраняет его в `output_directory`.
- В случае, если файл с таким именем уже существует, функция выводит предупреждение в лог. 
- Если `clobber` установлен в `True`, функция перезаписывает существующие файлы. 
- После завершения функция возвращает список путей к сгенерированным изображениям.

#### `generate_png`

**Цель**:  Создает изображение PNG с заданным текстом, шрифтом и цветами.

**Параметры**:

- `text` (str):  Текст, который необходимо отобразить на изображении.
- `canvas_size` (Tuple[int, int]): Размер холста в пикселях.
- `padding` (float): Процент отступа, используемого для границы.
- `background_color` (str): Цвет фона изображения.
- `text_color` (str): Цвет текста.
- `font` (str | ImageFont.ImageFont): Шрифт, который необходимо использовать для текста.

**Возвращает**:

- `Image`: Сгенерированное изображение PNG.

**Описание работы функции**:

- Функция `generate_png` создает новое изображение PNG заданного размера `canvas_size` и цвета `background_color`.
- Она создает объект `ImageDraw` для рисования на изображении.
- Затем она настраивает шрифт `font` с помощью `ImageFont.truetype` и использует `get_font_size` для определения подходящего размера шрифта для холста и отступов.
- Функция вычисляет положение текста с помощью `center_text_position` для центрального размещения текста на холсте. 
- После этого текст размещается на изображении с помощью `draw.text`. 
- Функция возвращает сгенерированное изображение.


#### `center_text_position`

**Цель**: Вычисляет положение для центрирования текста на холсте.

**Параметры**:

- `draw` (ImageDraw.Draw): Экземпляр класса `ImageDraw`.
- `text` (str):  Текст, который необходимо отобразить.
- `font` (ImageFont.ImageFont):  Шрифт, который используется для текста.
- `canvas_size` (Tuple[int, int]): Размер холста в пикселях.

**Возвращает**:

- `Tuple[int, int]`: Координаты для центрирования текста.

**Описание работы функции**:

- Функция `center_text_position` вычисляет размер текста с помощью `draw.textsize`.
- Затем она вычисляет координаты для центрирования текста на холсте, используя размер холста и размер текста. 
- Функция возвращает координаты, необходимые для центрального размещения текста на изображении.


#### `overlay_images`

**Цель**:  Накладывает одно изображение PNG поверх другого в заданном положении.

**Параметры**:

- `background_path` (str | Path): Путь к фоновому изображению PNG.
- `overlay_path` (str | Path): Путь к изображению PNG, которое необходимо наложить.
- `position` (tuple[int, int], optional):  Координаты (x, y), где будет размещен накладываемый объект. По умолчанию (0, 0).
- `alpha` (float, optional):  Уровень прозрачности накладываемого изображения (0.0 - 1.0). По умолчанию 1.0.

**Возвращает**:

- `Image`:  Полученное изображение с наложенным объектом.

**Пример**:

```python
>>> result_image = overlay_images("background.png", "overlay.png", position=(50, 50), alpha=0.8)
>>> result_image.save("result.png")
```

**Описание работы функции**:

- Функция `overlay_images` открывает фоновое изображение и изображение, которое необходимо наложить.
-  Если размер накладываемого изображения отличается от размера фонового изображения, функция  переразмеряет  накладываемый объект. 
- Функция настраивает прозрачность накладываемого объекта.
-  Затем она вставляет накладываемый объект поверх фонового изображения в заданном положении.
-  Функция возвращает изображение с наложенным объектом.


#### `assign_path`

**Цель**:  Определяет правильный путь для выходных файлов PNG, создавая каталог, если необходимо.

**Параметры**:

- `output_dir` (str | Path):  Путь к каталогу для сохранения выходных файлов PNG.
- `file_name` (str):  Имя файла.

**Возвращает**:

- `Path`:  Путь к выходному файлу PNG.

**Описание работы функции**:

-  Функция `assign_path`  проверяет, существует ли каталог `output_dir`. 
-  Если каталог не существует, функция создает его. 
-  Затем она объединяет путь к каталогу и имя файла, чтобы получить полный путь к выходному файлу PNG. 
-  Функция возвращает этот путь.


#### `center_text_position`

**Цель**:  Вычисляет положение для центрирования текста на холсте.

**Параметры**:

- `draw` (ImageDraw.Draw): Экземпляр `ImageDraw`.
- `text` (str): Текст для отображения.
- `font` (ImageFont.ImageFont):  Шрифт, используемый для текста.
- `canvas_size` (Tuple[int, int]): Размер холста в пикселях.

**Возвращает**:

- `Tuple[int, int]`:  Координаты для центрирования текста.

**Описание работы функции**:

- Функция `center_text_position`  вычисляет ширину и высоту текста с помощью `draw.textsize`.
-  Затем она вычисляет координаты для центрирования текста на холсте, используя размер холста и размер текста.
-  Функция возвращает эти координаты.

#### `not_comment_or_blank`

**Цель**: Проверяет, является ли строка комментарием или пустой строкой.

**Параметры**:

- `line` (str): Строка для проверки.

**Возвращает**:

- `bool`: `True`, если строка не является комментарием или пустой строкой, и `False` в противном случае.

**Описание работы функции**:

- Функция `not_comment_or_blank`  проверяет, начинается ли строка с символа `#` (комментарий). 
-  Если строка не пустая и не начинается с `#`, функция возвращает `True`, в противном случае `False`.


#### `which_exist`

**Цель**: Проверяет, какие имена файлов уже существуют в каталоге.

**Параметры**:

- `output_dir` (str | Path):  Путь к каталогу.
- `lines` (List[str]):  Список строк, представляющих имена файлов.

**Возвращает**:

- `List[str]`: Список имен файлов, которые уже существуют в каталоге.

**Описание работы функции**:

-  Функция `which_exist`  проверяет, существует ли каждый файл из списка `lines` в каталоге `output_dir`.
-  Функция возвращает список имен файлов, которые уже существуют в каталоге.

#### `get_characters`

**Цель**: Извлекает текстовые строки из входного файла или списка, фильтруя комментарии и пустые строки.

**Параметры**:

- `file_path` (str | Path): Путь к файлу или списку строк.

**Возвращает**:

- `List[str]`:  Список строк, полученных из файла или списка.

**Описание работы функции**:

-  Функция `get_characters`  извлекает строки из файла или списка, используя `not_comment_or_blank` для фильтрации комментариев и пустых строк. 
-  Функция возвращает список полученных строк.

#### `parse_size`

**Цель**:  Преобразует строку в объект `Size`.

**Параметры**:

- `size` (str):  Строка, представляющая размер.

**Возвращает**:

- `Size`:  Объект `Size`, представляющий размер.

**Описание работы функции**:

- Функция `parse_size`  преобразует строку, представляющую размер, в объект `Size`. 
- Функция возвращает объект `Size`.

#### `get_max_text_size`

**Цель**: Вычисляет максимальный размер текста, основываясь на шрифте и текстовых строках.

**Параметры**:

- `lines` (List[str]):  Список строк текста.
- `font` (ImageFont.ImageFont):  Шрифт, используемый для текста.

**Возвращает**:

- `Tuple[int, int]`:  Максимальный размер текста в пикселях.

**Описание работы функции**:

-  Функция `get_max_text_size`  вычисляет размер каждой строки текста с помощью `draw.textsize`. 
-  Затем она определяет максимальную ширину и высоту среди всех строк. 
-  Функция возвращает максимальный размер текста.

#### `get_font`

**Цель**:  Определяет размер шрифта, основываясь на размере холста и отступе.

**Параметры**:

- `canvas_size` (Tuple[int, int]):  Размер холста в пикселях.
- `padding` (float):  Процент отступа.

**Возвращает**:

- `int`:  Размер шрифта.

**Описание работы функции**:

-  Функция `get_font`  вычисляет размер шрифта, исходя из размера холста и отступа.
-  Она учитывает размер холста и отступ, чтобы определить размер шрифта, который позволит разместить текст на холсте с отступом.
-  Функция возвращает размер шрифта.

#### `setup_logging`

**Цель**:  Настраивает логгирование на основе заданного уровня логгирования.

**Параметры**:

- `level` (int | str | bool):  Уровень детализации логгирования.

**Описание работы функции**:

-  Функция `setup_logging`  настраивает логгирование, используя `logger` из модуля `src.logger.logger`.
-  Она устанавливает уровень детализации логгирования в соответствии с `level`.

#### `error`

**Цель**:  Регистрирует ошибку и вызывает исключение.

**Параметры**:

- `msg` (str):  Сообщение об ошибке.
- `ex` (Exception):  Исключение, которое необходимо вызвать.

**Описание работы функции**:

-  Функция `error`  регистрирует ошибку с помощью `logger.error` и вызывает исключение `ex`.

## Функции

### `webp2png`

**Цель**: Преобразует изображение WEBP в формат PNG.

**Параметры**:

- `webp_path` (str): Путь к входному файлу WEBP.
- `png_path` (str): Путь для сохранения преобразованного файла PNG.

**Пример**:

```python
webp2png('image.webp', 'image.png')
```

**Описание работы функции**:

-  Функция `webp2png`  открывает изображение WEBP с помощью `Image.open`.
-  Затем она сохраняет изображение в формате PNG с помощью `img.save`.
-  Функция возвращает `True`, если преобразование прошло успешно, и `False`, если возникла ошибка.

## Примеры

**Пример 1: Создание изображений PNG из текстового файла**

```python
from src.utils.convertors.png import TextToImageGenerator
from pathlib import Path

# Создаем экземпляр класса TextToImageGenerator
generator = TextToImageGenerator()

# Указываем путь к текстовому файлу
file_path = Path("./example.txt")

# Получаем строки из текстового файла
lines = generator.get_characters(file_path)

# Генерируем изображения PNG для каждой строки
images = generator.generate_images(lines, output_dir="./output")

# Вывод списка созданных файлов
print(images)
```

**Пример 2:  Использование функции `overlay_images` для наложения изображений**

```python
from src.utils.convertors.png import overlay_images
from pathlib import Path

# Путь к фоновому изображению
background_path = Path("./background.png")

# Путь к накладываемому изображению
overlay_path = Path("./overlay.png")

# Наложение изображений с заданным положением и прозрачностью
result_image = overlay_images(background_path, overlay_path, position=(50, 50), alpha=0.8)

# Сохранение полученного изображения
result_image.save("result.png")
```

**Пример 3: Преобразование изображения WEBP в формат PNG**

```python
from src.utils.convertors.png import webp2png

# Путь к файлу WEBP
webp_path = "image.webp"

# Путь для сохранения файла PNG
png_path = "image.png"

# Преобразование изображения WEBP в формат PNG
webp2png(webp_path, png_path)
```