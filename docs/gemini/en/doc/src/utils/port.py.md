# Модуль для поиска свободного сетевого порта

## Обзор

Модуль `src/utils/port.py` предоставляет функцию `get_free_port`, которая позволяет найти свободный порт на указанном хосте. Функция поддерживает поиск свободных портов в заданных диапазонах, как в виде строки "min-max", так и в виде списка строк или списка списков чисел.

## Детали

Модуль `src/utils/port.py` используется для определения доступного порта для сетевого соединения. Он предоставляет функцию `get_free_port`, которая использует сокеты для проверки занятости портов и предлагает свободный порт.

## Функции

### `get_free_port`

**Назначение**:  Находит и возвращает свободный порт в указанном диапазоне(ах) или первый доступный порт, если диапазон не задан.

**Параметры**:

- `host` (str): Адрес хоста для проверки доступности портов.
- `port_range` (PortRangeType, optional): Диапазон(ы) портов. Может быть строкой "min-max", списком строк "min-max", списком списков чисел [min, max] или None. По умолчанию None.

**Возвращает**:

- `int`: Номер доступного порта.

**Возвращает исключения**:

- `ValueError`: Если не удалось найти свободный порт в указанном диапазоне(ах) или если формат диапазона некорректен.

**Внутренние функции**:

- `_is_port_in_use`: Проверяет, используется ли данный порт на указанном хосте.
- `_parse_port_range`: Парсит строку диапазона портов "min-max" в кортеж (min_port, max_port).

**Как работает функция**:

1.  Функция `get_free_port` сначала проверяет, задан ли диапазон портов (`port_range`).
2.  Если диапазон задан, функция анализирует его формат. Она может быть строкой "min-max", списком строк "min-max", списком списков чисел [min, max] или None.
3.  Для каждого диапазона функция перебирает порты в заданном диапазоне и использует функцию `_is_port_in_use` для проверки, свободен ли порт.
4.  Если порт свободен, функция возвращает его номер.
5.  Если диапазон не задан, функция перебирает порты, начиная с 1024, и проверяет, свободен ли каждый порт.
6.  Если порт свободен, функция возвращает его номер.
7.  Если ни один свободный порт не найден, функция возвращает исключение `ValueError`.

**Примеры**:

```python
>>> get_free_port('localhost', '3000-3005')
3001
>>> get_free_port('localhost', ['4000-4005', [5000, 5010]])
5002
```

## Внутренние функции

### `_is_port_in_use`

**Назначение**:  Проверяет, используется ли данный порт на указанном хосте.

**Параметры**:

- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:

- `bool`: True, если порт используется, False в противном случае.

**Как работает функция**:

1.  Функция создает сокет с использованием контекстного менеджера для автоматического закрытия.
2.  Функция пытается привязать сокет к адресу и порту.
3.  Если привязка удалась, порт свободен, и функция возвращает `False`.
4.  Если произошла `OSError` (например, "Address already in use"), порт занят, и функция возвращает `True`.
5.  Если произошла любая другая ошибка, функция логирует ее и возвращает `True`, считая порт недоступным или проблемным.

### `_parse_port_range`

**Назначение**:  Парсит строку диапазона портов "min-max" в кортеж (min_port, max_port).

**Параметры**:

- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:

- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Возвращает исключения**:

- `ValueError`: Если формат строки диапазона портов некорректен.

**Как работает функция**:

1.  Функция разбивает строку по символу "-".
2.  Функция проверяет, что получилось ровно две части.
3.  Функция преобразует части в целые числа.
4.  Функция проверяет корректность диапазона (минимум меньше максимума).
5.  Функция проверяет допустимость номеров портов (от 1 до 65535).
6.  Функция возвращает кортеж, содержащий минимальный и максимальный номера портов.

## Детали параметров

- `host` (str): Адрес хоста для проверки доступности портов.
- `port_range` (PortRangeType, optional): Диапазон(ы) портов. Может быть строкой "min-max", списком строк "min-max", списком списков чисел [min, max] или None. По умолчанию None.

## Примеры

- `get_free_port('localhost', '3000-3005')`:  Найти свободный порт в диапазоне от 3000 до 3005 на хосте "localhost".
- `get_free_port('localhost', ['4000-4005', [5000, 5010]])`: Найти свободный порт в диапазонах от 4000 до 4005 и от 5000 до 5010 на хосте "localhost".
- `get_free_port('localhost')`: Найти первый свободный порт на хосте "localhost", начиная с порта 1024.