# Модуль FastAPI для RPC-управления сервером

## Обзор

Этот модуль предоставляет функциональность для удаленного управления FastAPI-сервером через XML-RPC. Он разделен на две основные части:

- `fast_api_rpc.py` (серверная часть)
- `main.py` (клиентская часть)

Серверная часть реализует XML-RPC-сервер, который обрабатывает запросы от клиента и вызывает соответствующие функции управления сервером. 
Клиентская часть предоставляет простой консольный интерфейс для взаимодействия с сервером и отправки команд.

## Детали

Модуль позволяет выполнять следующие действия:

- **Запуск сервера:** Запускает FastAPI-сервер на заданном порту.
- **Остановка сервера:** Останавливает запущенный FastAPI-сервер.
- **Остановка всех серверов:** Останавливает все запущенные FastAPI-серверы.
- **Проверка статуса серверов:** Выводит информацию о статусе запущенных FastAPI-серверов.
- **Добавление нового маршрута:** Добавляет новый маршрут в FastAPI-сервер.
- **Выключение сервера:** Выключает XML-RPC-сервер и завершает работу.

## Classes

### `FastApiServer`

**Описание:** Класс, представляющий FastAPI-сервер.

**Inherits:** None

**Attributes:**
- `app` (`FastAPI`): экземпляр FastAPI.
- `port` (`int`): порт, на котором работает сервер.
- `host` (`str`): хост, на котором работает сервер.

**Methods:**
- `start_server`(): Запускает сервер.
- `stop_server`(): Останавливает сервер.

### `CommandHandler`

**Описание:** Класс, управляющий вызовами функций управления сервером.

**Inherits:** None

**Attributes:**
- `rpc_server` (`SimpleXMLRPCServer`): экземпляр XML-RPC-сервера.

**Methods:**
- `start_server`(): Запускает FastAPI-сервер.
- `stop_server`(): Останавливает FastAPI-сервер.
- `stop_all_servers`(): Останавливает все запущенные FastAPI-серверы.
- `status_servers`(): Выводит информацию о статусе запущенных FastAPI-серверов.
- `add_new_route`(): Добавляет новый маршрут в FastAPI-сервер.
- `shutdown`(): Выключает XML-RPC-сервер.
- `register_instance`(): Регистрирует методы `CommandHandler` для удаленного вызова.

## Functions

### `start_server(port: int = 8000, host: str = '0.0.0.0')`

**Purpose:** Запускает FastAPI-сервер на заданном порту.

**Parameters:**
- `port` (`int`): Порт, на котором будет запущен сервер. По умолчанию `8000`.
- `host` (`str`): Хост, на котором будет запущен сервер. По умолчанию `0.0.0.0`.

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при запуске сервера.

**How the Function Works:**
- Создает экземпляр FastAPI.
- Добавляет маршруты, которые мы создали в `fast_api_rpc.py`.
- Запускает сервер на заданном порту и хосте.
- Выводит информацию о запущенном сервере в консоль.

**Examples:**
```python
start_server(port=8000, host='0.0.0.0')
```

### `stop_server(port: int = 8000, host: str = '0.0.0.0')`

**Purpose:** Останавливает FastAPI-сервер, запущенный на заданном порту.

**Parameters:**
- `port` (`int`): Порт, на котором работает сервер. По умолчанию `8000`.
- `host` (`str`): Хост, на котором работает сервер. По умолчанию `0.0.0.0`.

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при остановке сервера.

**How the Function Works:**
- Попытка получить информацию о запущенном сервере.
- Если сервер работает - выключаем его.
- Выводим информацию о остановке сервера в консоль.

**Examples:**
```python
stop_server(port=8000, host='0.0.0.0')
```

### `stop_all_servers()`

**Purpose:** Останавливает все запущенные FastAPI-серверы.

**Parameters:**
- None

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при остановке серверов.

**How the Function Works:**
- Получаем список запущенных серверов.
- Для каждого сервера из списка вызываем функцию `stop_server`.
- Выводим информацию о остановке всех серверов в консоль.

**Examples:**
```python
stop_all_servers()
```

### `status_servers()`

**Purpose:** Выводит информацию о статусе запущенных FastAPI-серверов.

**Parameters:**
- None

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при получении информации о серверах.

**How the Function Works:**
- Получаем список запущенных серверов.
- Выводим информацию о каждом сервере в консоль:
    - Порт.
    - Хост.
    - Статус (запущен или нет).

**Examples:**
```python
status_servers()
```

### `add_new_route(path: str, endpoint: str, methods: list = ['GET'])`

**Purpose:** Добавляет новый маршрут в FastAPI-сервер.

**Parameters:**
- `path` (`str`): Путь к новому маршруту.
- `endpoint` (`str`): Имя функции, которая будет обрабатывать этот маршрут.
- `methods` (`list`): Список HTTP-методов, которые будут разрешены для этого маршрута. По умолчанию `['GET']`.

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при добавлении маршрута.

**How the Function Works:**
- Получаем список запущенных серверов.
- Для каждого сервера из списка вызываем функцию `add_new_route` на экземпляре FastAPI.
- Добавляем новый маршрут с указанными параметрами.
- Выводим информацию о добавленном маршруте в консоль.

**Examples:**
```python
add_new_route(path='/test', endpoint='test_endpoint', methods=['GET', 'POST'])
```

### `shutdown()`

**Purpose:** Выключает XML-RPC-сервер и завершает работу.

**Parameters:**
- None

**Returns:**
- `None`

**Raises Exceptions:**
- `Exception`: Если возникла ошибка при выключении сервера.

**How the Function Works:**
- Останавливаем XML-RPC-сервер.
- Выводим сообщение о завершении работы.

**Examples:**
```python
shutdown()
```

## Пример использования

### `main.py`

```python
from xmlrpc.client import ServerProxy
import sys

def main():
    """
    Основная функция, которая запускает клиентскую часть приложения.
    """
    rpc_client = ServerProxy("http://localhost:9000", allow_none=True)

    while True:
        print("Меню:")
        print("1. Запустить сервер")
        print("2. Остановить сервер")
        print("3. Остановка всех серверов")
        print("4. Статус серверов")
        print("5. Добавить новый маршрут")
        print("6. Выключить")

        choice = input("Введите номер команды: ")

        if choice == '1':
            port = input("Введите порт: ")
            rpc_client.start_server(port=int(port))
        elif choice == '2':
            port = input("Введите порт: ")
            rpc_client.stop_server(port=int(port))
        elif choice == '3':
            rpc_client.stop_all_servers()
        elif choice == '4':
            rpc_client.status_servers()
        elif choice == '5':
            path = input("Введите путь к маршруту: ")
            endpoint = input("Введите имя функции: ")
            methods = input("Введите список HTTP-методов: ").split(",")
            rpc_client.add_new_route(path=path, endpoint=endpoint, methods=methods)
        elif choice == '6':
            rpc_client.shutdown()
            break
        else:
            print("Неверный выбор!")

if __name__ == "__main__":
    main()
```

## Ключевые моменты

- **Разделение ответственности:** Серверная часть (`fast_api_rpc.py`) отвечает за управление FastAPI-сервером, клиентская часть (`main.py`) отвечает за взаимодействие с пользователем.
- **XML-RPC:** Используется для связи между сервером и клиентом, позволяя вызывать методы управления сервером из клиентской программы.
- **Потоки:** XML-RPC-сервер запущен в отдельном потоке, что позволяет ему работать параллельно с остальным кодом.
- **Удаленный вызов:** `ServerProxy` позволяет вызывать методы, как если бы они были частью локального кода, хотя на самом деле они выполняются на удаленном сервере.

## Преимущества данного подхода

- **Управление сервером из другой программы:** Можно контролировать запущенный сервер через другой процесс или с другой машины.
- **Разделение кода:** Логика управления сервером и пользовательский интерфейс разделены, что делает код более модульным и легким в обслуживании.
- **Гибкость:** Можно добавлять новые методы управления сервером, просто добавив их в `CommandHandler`, и они автоматически станут доступны через RPC.