# Минибот для обслуживания запросов на создание прайслиста для Казаринова

## Обзор

Модуль `minibot.py` содержит код телеграм-бота, который предназначен для автоматизации процесса создания прайслистов для Казаринова. Бот принимает запросы от пользователя, обрабатывает их, используя модель ИИ Gemini, и генерирует прайслист на основе полученной информации. 

## Подробности

### Основные возможности бота:

- **Обработка текстовых сообщений:** Бот принимает текстовые сообщения от пользователя и использует модель Gemini для ответа на вопросы, выполнения задач или получения дополнительной информации.
- **Обработка URL:** Бот принимает URL-адреса, которые должны начинаться с `https://one-tab.com` или `https://www.one-tab.com`, и извлекает информацию о товарах, которые будут включены в прайслист.
- **Создание прайслиста:** Бот создает прайслист на основе полученных данных, используя набор сценариев, которые включают в себя сбор информации о товарах, обработку цен, формирование таблицы и вывод результата.
- **Отправка файлов:** Бот может отправлять пользователю PDF-файлы, фотографии и другие документы.
- **Обработка голосовых сообщений:** Бот может распознавать голосовые сообщения и обрабатывать полученный текст.

### Структура кода

- **`config.py`:** Содержит конфигурационные параметры бота, включая токен бота, ID канала, директорию с фотографиями и другие настройки.
- **`BotHandler`:** Класс обработчика команд, который обрабатывает все события, связанные с ботом.
- **`run_bot()`:** Функция, которая запускает бот в режиме polling и обеспечивает его перезапуск в случае возникновения ошибок.

## Классы

### `Config`

**Описание**: Класс для хранения конфигурационных параметров бота.

**Атрибуты**:

- `ENDPOINT` (str): Имя эндпоинта (в данном случае "kazarinov").
- `MODE` (str): Режим работы бота: `'PRODUCTION'` или `'DEV'`.
- `BOT_TOKEN` (str): Токен телеграм-бота.
- `CHANNEL_ID` (str): ID канала, в который будет отправляться информация.
- `PHOTO_DIR` (Path): Директория, содержащая фотографии для отправки.
- `COMMAND_INFO` (str): Информация о боте, которая отображается при использовании команды `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, которое отправляется при использовании неизвестной команды.
- `START_MESSAGE` (str): Сообщение, которое отправляется при запуске бота.
- `HELP_MESSAGE` (str): Сообщение, которое отправляется при использовании команды `/help`.
- `WINDOW_MODE` (str): Режим окна, в котором будут запускаться сценарии.

### `BotHandler`

**Описание**: Класс обработчика событий для телеграм-бота.

**Атрибуты**:

- `base_dir` (Path): Базовая директория проекта.
- `questions_list` (list): Список вопросов, которые бот может использовать при запросе "next".
- `model` (GoogleGenerativeAi): Объект модели Gemini.

**Методы**:

- `handle_message(bot:telebot, message:\'message\')`: Обработка текстовых сообщений.
- `_send_user_flowchart(bot, chat_id)`: Отправка схемы user_flowchart.
- `_handle_url(bot, message:\'message\')`: Обработка URL, присланного пользователем.
- `_handle_next_command(bot, message)`: Обработка команды `--next` и ее аналогов.
- `help_command(bot, message)`: Обработка команды `/help`.
- `send_pdf(bot, message, pdf_file)`: Обработка команды `/sendpdf` для отправки PDF.
- `handle_voice(bot, message)`: Обработка голосовых сообщений.
- `_transcribe_voice(file_path)`: Транскрибирование голосового сообщения (заглушка).
- `handle_document(bot, message)`: Обработка полученных документов.

## Функции

### `run_bot() -> None`

**Описание**: Запускает polling-бота в бесконечном цикле с автоматическим восстановлением при ошибках.

**Параметры**:

-  None

**Возвращает**:

- None

**Исключения**:

- `Exception`: Повторно пробрасывается при фатальной ошибке, если бот не может быть запущен.

**Как работает функция**:

Функция запускает бот в режиме polling, используя метод `bot.infinity_polling()`. 
При возникновении исключений во время работы бота, функция пытается остановить бот,
затем ожидает 10 секунд и снова запускает его.
Если во время повторного запуска возникают ошибки, функция пробрасывает их дальше.

**Пример**:

```python
if __name__ == '__main__':
    run_bot()
```


## Примеры

### Запуск бота

```python
if __name__ == '__main__':
    run_bot()
```

### Отправка сообщения боту

```python
# Отправка текстового сообщения
bot.send_message(chat_id, "Hello, world!")

# Отправка голосового сообщения
bot.send_voice(chat_id, voice_file_path)

# Отправка документа
bot.send_document(chat_id, document_file_path)
```

### Обработка URL

```python
# Получение URL от пользователя
url = message.text

# Обработка URL
handler._handle_url(bot, message)
```

### Обработка команды `--next`

```python
# Получение команды от пользователя
command = message.text

# Обработка команды
handler._handle_next_command(bot, message)
```

## Дополнительные сведения

- Бот использует библиотеку `telebot` для взаимодействия с Telegram API.
- Бот использует модель Gemini для обработки текстовых сообщений и генерации ответов.
- Бот использует набор сценариев для автоматизации процесса создания прайслиста.
- Бот хранит конфигурационные параметры в файле `config.py`.
- Бот использует логгер `logger` из модуля `src.logger` для записи информации о своей работе.

## Параметры

- `BOT_TOKEN` (str): Токен телеграм-бота, необходимый для аутентификации.
- `CHANNEL_ID` (str): ID канала, куда бот будет отправлять информацию.
- `PHOTO_DIR` (Path): Путь к директории с изображениями, которые бот может отправлять.
- `COMMAND_INFO` (str): Информация о боте, которая отображается при использовании команды `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, которое отправляется при использовании неизвестной команды.
- `START_MESSAGE` (str): Сообщение, которое отправляется при запуске бота.
- `HELP_MESSAGE` (str): Сообщение, которое отправляется при использовании команды `/help`.
- `WINDOW_MODE` (str): Режим окна, в котором будут запускаться сценарии.

## Использование

Для запуска бота необходимо:

1. Получить токен бота от Telegram.
2. Задать значения конфигурационных параметров в файле `config.py`.
3. Запустить скрипт `minibot.py`.
4. После запуска бота, вы можете отправлять ему сообщения в Telegram, используя его уникальный username.

## Ошибки

- **Ошибка при обработке текстового сообщения:** Возможные причины: ошибка модели Gemini, ошибка в обработке текста.
- **Ошибка при обработке URL:** Возможные причины: некорректный URL, ошибка при парсинге OneTab.
- **Ошибка при отправке файлов:** Возможные причины: ошибка при загрузке файла, ошибка при отправке файла в Telegram.
- **Ошибка при обработке голосовых сообщений:** Возможные причины: ошибка при загрузке файла, ошибка при транскрибировании.

## Устранение неполадок

- **Проверить конфигурационные параметры:** Убедитесь, что все конфигурационные параметры заданы корректно.
- **Проверить подключение к интернету:** Бот должен иметь доступ к интернету для работы с моделями ИИ и Telegram API.
- **Проверить журнал ошибок:** В журнале ошибок могут быть записаны сведения о возникших ошибках.
- **Обратиться к документации:** Документация по `telebot` и Gemini может помочь в решении проблем.
- **Спросить разработчика:** Если проблема не удается решить самостоятельно, обратитесь к разработчику бота.