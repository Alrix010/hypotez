# Модуль `minibot`

## Обзор

Модуль `minibot` предназначен для обслуживания запросов на создание прайс-листов для Казаринова через Telegram-бота. Он включает в себя обработку текстовых и голосовых сообщений, документов, а также команды для взаимодействия с ботом.

## Подробнее

Модуль содержит классы и функции для обработки сообщений от пользователей, взаимодействия с внешними сервисами (например, Google Gemini для генерации ответов), и отправки различных типов ответов (текст, фото, документы) через Telegram API.

## Классы

### `Config`

**Описание**: Класс `Config` содержит настройки для бота, такие как токен, ID канала, пути к директориям и сообщения.

**Атрибуты**:
- `ENDPOINT` (str): Имя endpoint.
- `MODE` (str): Режим работы бота (`PRODUCTION` или `DEV`).
- `BOT_TOKEN` (str): Токен Telegram-бота.
- `CHANNEL_ID` (str): ID Telegram-канала.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте, отображаемая по команде `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение для неизвестных команд.
- `START_MESSAGE` (str): Приветственное сообщение при старте бота.
- `HELP_MESSAGE` (str): Сообщение с информацией о доступных командах.
- `WINDOW_MODE` (str): Режим окна.

**Принцип работы**:
Класс `Config` определяет параметры работы бота, такие как токен доступа, идентификаторы каналов и сообщения, используемые для взаимодействия с пользователями. В зависимости от режима `MODE` выбирается токен бота (боевой или тестовый).

### `BotHandler`

**Описание**: Класс `BotHandler` отвечает за обработку команд и сообщений, полученных от Telegram-бота.

**Атрибуты**:
- `base_dir` (Path): Базовая директория модуля.
- `questions_list` (List[str]): Список вопросов для обработки команды `--next`.
- `model` (GoogleGenerativeAi): Экземпляр класса `GoogleGenerativeAi` для взаимодействия с моделью Gemini.

**Методы**:
- `__init__`: Инициализация обработчика событий телеграм-бота.
- `handle_message`: Обработка текстовых сообщений.
- `_send_user_flowchart`: Отправка схемы user_flowchart.
- `_handle_url`: Обработка URL, присланного пользователем.
- `_handle_next_command`: Обработка команды '--next' и её аналогов.
- `help_command`: Обработка команды /help.
- `send_pdf`: Обработка команды /sendpdf для отправки PDF.
- `handle_voice`: Обработка голосовых сообщений.
- `_transcribe_voice`: Транскрибирование голосового сообщения (заглушка).
- `handle_document`: Обработка полученных документов.

## Методы класса `BotHandler`

### `__init__`

```python
def __init__(self):
    """Инициализация обработчика событий телеграм-бота."""
    ...
```

**Описание**: Инициализирует обработчик событий телеграм-бота, загружает список вопросов и инициализирует модель `GoogleGenerativeAi`.

### `handle_message`

```python
def handle_message(self, bot:telebot, message:'message'):
    """Обработка текстовых сообщений."""
    ...
```

**Описание**: Обрабатывает текстовые сообщения, полученные от пользователя. Если сообщение является URL, обрабатывает его как ссылку на OneTab. Если сообщение является командой `--next` или её аналогом, запрашивает у модели случайный вопрос из списка и отправляет пользователю вопрос и ответ. В противном случае отправляет сообщение в модель и отправляет полученный ответ пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает текстовые сообщения от пользователя. Если сообщение содержит URL, функция вызывает `_handle_url` для обработки URL. Если сообщение содержит команду следующего вопроса, функция вызывает `_handle_next_command`. В противном случае функция вызывает `self.model.chat(text)` для получения ответа от модели Gemini и отправляет ответ пользователю.

### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """Отправка схемы user_flowchart."""
    ...
```

**Описание**: Отправляет пользователю схему `user_flowchart` в виде фотографии.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `chat_id` (int): ID чата пользователя.

**Принцип работы**:
Функция отправляет пользователю схему `user_flowchart` в виде фотографии. Если файл не найден, отправляет сообщение об ошибке.

### `_handle_url`

```python
def _handle_url(self, bot, message:'message'):
    """Обработка URL, присланного пользователем."""
    ...
```

**Описание**: Обрабатывает URL, присланный пользователем. Если URL является ссылкой на OneTab, извлекает данные о товаре и URL комплектующих, запускает сценарий обработки этих данных.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает URL, присланный пользователем. Если URL не является ссылкой на OneTab, отправляет сообщение об ошибке. Иначе извлекает данные о товаре и URL комплектующих с помощью `fetch_target_urls_onetab`, затем запускает асинхронный сценарий `Scenario.run_scenario_async` для обработки этих данных.

### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """Обработка команды '--next' и её аналогов."""
    ...
```

**Описание**: Обрабатывает команду `--next` и её аналоги. Отправляет пользователю случайный вопрос из списка и ответ на него, полученный от модели.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция выбирает случайный вопрос из `self.questions_list`, отправляет его пользователю, получает ответ от модели с помощью `self.model.ask(question)` и отправляет полученный ответ пользователю.

### `help_command`

```python
def help_command(self, bot, message):
    """Обработка команды /help."""
    ...
```

**Описание**: Обрабатывает команду `/help`. Отправляет пользователю сообщение со списком доступных команд.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю сообщение со списком доступных команд.

### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """Обработка команды /sendpdf для отправки PDF."""
    ...
```

**Описание**: Обрабатывает команду `/sendpdf`. Отправляет пользователю PDF-файл.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.
- `pdf_file` (str): Путь к PDF-файлу.

**Принцип работы**:
Функция отправляет пользователю PDF-файл. Если файл не найден, отправляет сообщение об ошибке.

### `handle_voice`

```python
def handle_voice(self, bot, message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**: Обрабатывает голосовые сообщения.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает голосовые сообщения, полученные от пользователя. Загружает файл, сохраняет его во временную директорию, транскрибирует его и отправляет распознанный текст пользователю.

### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """Транскрибирование голосового сообщения (заглушка)."""
    ...
```

**Описание**: Транскрибирует голосовое сообщение (заглушка).

**Параметры**:
- `file_path` (str): Путь к файлу голосового сообщения.

**Принцип работы**:
Функция транскрибирует голосовое сообщение и возвращает распознанный текст. В текущей реализации возвращает заглушку "Распознавание голоса ещё не реализовано.".

### `handle_document`

```python
def handle_document(self, bot, message):
    """Обработка полученных документов."""
    ...
```

**Описание**: Обрабатывает полученные документы.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает документы, полученные от пользователя. Загружает файл, сохраняет его во временную директорию и отправляет сообщение об успешном сохранении.

## Функции

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """Обработка команды /start."""
    ...
```

**Описание**: Обрабатывает команду `/start`. Отправляет пользователю приветственное сообщение.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю приветственное сообщение, хранящееся в `config.START_MESSAGE`.

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """Обработка команды /help."""
    ...
```

**Описание**: Обрабатывает команду `/help`. Вызывает метод `help_command` класса `BotHandler` для отображения списка доступных команд.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция вызывает метод `handler.help_command(bot, message)` для отображения списка доступных команд.

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """Обработка команды /info."""
    ...
```

**Описание**: Обрабатывает команду `/info`. Отправляет пользователю информацию о боте.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю информацию о боте, хранящуюся в `config.COMMAND_INFO`.

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """Обработка команды /time."""
    ...
```

**Описание**: Обрабатывает команду `/time`. Отправляет пользователю текущее время.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю текущее время, полученное с помощью `datetime.datetime.now()`.

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """Обработка команды /photo."""
    ...
```

**Описание**: Обрабатывает команду `/photo`. Отправляет пользователю случайную фотографию из директории.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю случайную фотографию из директории, указанной в `config.PHOTO_DIR`. Если директория не найдена или в ней нет файлов, отправляет сообщение об ошибке.

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**: Обрабатывает голосовые сообщения.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает голосовые сообщения, вызывает метод `handle_voice` класса `BotHandler`.

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """Обработка полученных документов."""
    ...
```

**Описание**: Обрабатывает сообщения с документами.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает сообщения с документами, вызывает метод `handle_document` класса `BotHandler`.

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """Обработка текстовых сообщений, не начинающихся с '/'."""
    ...
```

**Описание**: Обрабатывает текстовые сообщения, не начинающиеся с символа `/`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция обрабатывает текстовые сообщения, вызывает метод `handle_message` класса `BotHandler`.

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """Обработка неизвестных команд."""
    ...
```

**Описание**: Обрабатывает неизвестные команды.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Принцип работы**:
Функция отправляет пользователю сообщение о неизвестной команде, используя текст из `config.UNKNOWN_COMMAND_MESSAGE`.

### `run_bot`

```python
def run_bot() -> None:
    """
    Запускает polling-бота в бесконечном цикле с автоматическим восстановлением при ошибках.

    При возникновении исключений выполняется остановка бота и повторный запуск через 10 секунд.

    Raises:
        Exception: Повторно пробрасывается при фатальной ошибке, если бот не может быть запущен.
    """
    ...
```

**Описание**: Запускает polling-бота в бесконечном цикле с автоматическим восстановлением при ошибках.

**Принцип работы**:
Функция запускает polling-бота в бесконечном цикле с автоматическим восстановлением при ошибках. В случае возникновения исключений выполняется остановка бота и повторный запуск через 10 секунд.

## Запуск бота

```python
if __name__ == '__main__':
    run_bot()
```

При запуске модуля выполняется функция `run_bot()`, которая инициализирует и запускает Telegram-бота.