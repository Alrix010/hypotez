# Модуль `main.py`

## Обзор

Модуль `main.py` представляет собой основной файл приложения для простого чата с использованием модели Gemini. Он содержит определение FastAPI приложения, обработку запросов к чату и запуск локального сервера.

## Более детально

Модуль использует FastAPI для создания API, которое позволяет общаться с моделью Google Gemini. Он включает в себя настройку CORS для разрешения запросов с разных доменов, определение модели запроса чата и обработку ошибок.

## Структура модуля

- Импорт необходимых библиотек и модулей
- Настройка FastAPI приложения
- Определение модели запроса чата `ChatRequest`
- Инициализация модели Google Gemini `GoogleGenerativeAi`
- Определение маршрутов:
  - `/`: для отображения HTML страницы
  - `/api/chat`: для обработки запросов к чату
- Запуск локального сервера с использованием uvicorn

## Классы

### `ChatRequest`

**Описание**: Модель запроса чата, используемая для валидации входящих сообщений.

**Атрибуты**:

- `message` (str): Сообщение пользователя.

**Принцип работы**:
Класс `ChatRequest` используется для определения структуры данных, ожидаемых в теле POST-запроса к эндпоинту `/api/chat`. Он наследуется от `BaseModel` из библиотеки Pydantic и определяет единственное поле `message`, которое должно быть строкой. Pydantic автоматически выполняет валидацию входящих данных на соответствие этой структуре.

## Функции

### `root`

```python
async def root():
    """ Отображает HTML страницу.

    Returns:
        HTMLResponse: HTML содержание страницы.

    Raises:
        HTTPException: Если происходит ошибка при чтении HTML файла.

    Пример:
        >>> response = await root()
        >>> type(response)
        <class 'fastapi.responses.HTMLResponse'>
    """
```

**Описание**: Асинхронная функция для отображения HTML страницы.

**Возвращаемое значение**:
- `HTMLResponse`: HTML содержание страницы.

**Исключения**:
- `HTTPException`: Если происходит ошибка при чтении HTML файла.

**Как работает функция**:
- Функция пытается прочитать HTML файл, путь к которому определяется переменной `gs.fast_api.index_path`.
- Если чтение файла успешно, функция возвращает `HTMLResponse` с содержимым файла.
- Если происходит ошибка при чтении файла, функция возбуждает исключение `HTTPException` с кодом состояния 500 и детальным описанием ошибки.

**Примеры**:
```python
# Пример вызова функции root
response = await root()
print(type(response))
```

### `chat`

```python
async def chat(request: ChatRequest):
    """ Обрабатывает запросы к чату.

    Args:
        request (ChatRequest): Запрос чата, содержащий сообщение пользователя.

    Returns:
        dict: Ответ от модели Gemini.

    Raises:
        HTTPException: Если происходит ошибка при обработке запроса.

    Пример:
        >>> from pydantic import BaseModel
        >>> class ChatRequest(BaseModel):
        ...     message: str
        >>> request = ChatRequest(message="Hello")
        >>> response = await chat(request)
        >>> type(response)
        <class 'dict'>
    """
```

**Описание**: Асинхронная функция для обработки запросов к чату.

**Параметры**:
- `request` (ChatRequest): Запрос чата, содержащий сообщение пользователя.

**Возвращаемое значение**:
- `dict`: Ответ от модели Gemini.

**Исключения**:
- `HTTPException`: Если происходит ошибка при обработке запроса.

**Как работает функция**:
- Функция принимает запрос типа `ChatRequest`, содержащий сообщение пользователя.
- Функция вызывает метод `chat` модели `GoogleGenerativeAi` для получения ответа.
- Функция возвращает словарь с ответом от модели Gemini.
- Если происходит ошибка при обработке запроса, функция логирует ошибку и возбуждает исключение `HTTPException` с кодом состояния 500 и детальным описанием ошибки.

**Примеры**:
```python
# Пример вызова функции chat
from pydantic import BaseModel
class ChatRequest(BaseModel):
    message: str
request = ChatRequest(message="Hello")
response = await chat(request)
print(type(response))
```

## Запуск сервера

```python
if __name__ == "__main__":
    uvicorn.run(app, host=gs.fast_api.host, port=int(gs.fast_api.port))
```

**Описание**: Запуск локального сервера с использованием uvicorn.

**Как работает**:
- Код запускает Uvicorn сервер, используя параметры хоста и порта, определенные в `gs.fast_api`.
- Это позволяет запустить приложение и принимать входящие HTTP запросы.