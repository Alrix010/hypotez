# Модуль Phind

## Обзор

Модуль `Phind` предоставляет класс `Phind`, который является асинхронным генератором ответов от поставщика Phind. Он поддерживает потоковую передачу и историю сообщений.

## Подробнее

Модуль взаимодействует с сервисом `Phind` для генерации ответов на основе предоставленных сообщений. Он использует асинхронные запросы для получения ответов и поддерживает потоковую передачу данных.

## Классы

### `Phind`

**Описание**: Класс `Phind` является асинхронным поставщиком генератора.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных поставщиков генераторов.

**Атрибуты**:
- `url` (str): URL сервиса Phind (`https://www.phind.com`).
- `working` (bool): Указывает, работает ли сервис (по умолчанию `False`).
- `lockdown` (bool): Указывает, находится ли сервис в режиме блокировки (по умолчанию `True`).
- `supports_stream` (bool): Указывает, поддерживает ли сервис потоковую передачу (по умолчанию `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли сервис историю сообщений (по умолчанию `True`).

**Принцип работы**:
Класс использует асинхронные запросы для взаимодействия с сервисом `Phind`. Он генерирует запросы на основе предоставленных сообщений и возвращает ответы в виде асинхронного генератора. Поддерживается потоковая передача данных, что позволяет получать ответы по частям.

### Методы класса

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    creative_mode: bool = False,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от Phind.

    Args:
        cls (Phind): Ссылка на класс.
        model (str): Модель, используемая для генерации ответа.
        messages (Messages): Список сообщений для отправки в Phind.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию 120.
        creative_mode (bool, optional): Включает креативный режим. По умолчанию `False`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от Phind.

    Raises:
        RuntimeError: Если получен ответ с ошибкой от Phind.

    """
```

- **Параметры**:
    - `cls` (Phind): Ссылка на класс.
    - `model` (str): Модель, используемая для генерации ответа.
    - `messages` (Messages): Список сообщений для отправки в Phind.
    - `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
    - `timeout` (int, optional): Время ожидания ответа в секундах. По умолчанию 120.
    - `creative_mode` (bool, optional): Включает креативный режим. По умолчанию `False`.
    - `**kwargs`: Дополнительные параметры.

- **Возвращает**:
    - `AsyncResult`: Асинхронный генератор, возвращающий ответы от Phind.

- **Как работает**:
    1. Функция формирует заголовки запроса, включая информацию о происхождении и реферере.
    2. Создается сессия с использованием `StreamSession` для выполнения асинхронных запросов.
    3. Извлекаются данные о `challengeSeeds` из HTML-кода главной страницы `Phind`.
    4. Формируется структура данных для отправки запроса, включающая вопрос, историю вопросов и ответов, настройки и контекст.
    5. Генерируется `challenge` с использованием функции `generate_challenge`.
    6. Отправляется POST-запрос к API `Phind`.
    7. Полученные данные построчно обрабатываются, извлекаются полезные фрагменты ответа и передаются через генератор.
    8. В случае обнаружения ошибок в ответе, выбрасывается исключение `RuntimeError`.

- **Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-4"
messages = [
    {"role": "user", "content": "Hello, Phind!"},
    {"role": "assistant", "content": "Hello, user!"}
]
proxy = "http://your_proxy:8080"
timeout = 150
creative_mode = True

async def example():
    generator = await Phind.create_async_generator(
        model=model,
        messages=messages,
        proxy=proxy,
        timeout=timeout,
        creative_mode=creative_mode
    )
    async for chunk in generator:
        print(chunk)

# Запуск примера
# asyncio.run(example())
```

## Функции

### `deterministic_stringify`

```python
def deterministic_stringify(obj):
    """
    Преобразует объект в строку в детерминированном порядке.

    Args:
        obj (Any): Объект для преобразования в строку.

    Returns:
        str: Строковое представление объекта.

    """
```

- **Описание**: Преобразует объект (словарь, список, булево значение, число или строку) в строку JSON в детерминированном порядке, что означает, что порядок элементов в словарях и списках всегда будет одинаковым.
- **Параметры**:
    - `obj` (Any): Объект для преобразования.
- **Возвращает**:
    - `str`: Строковое представление объекта.
- **Как работает**:
    1. Функция определяет тип входного значения и обрабатывает его соответствующим образом.
    2. Для списков и словарей используется рекурсивный вызов `deterministic_stringify` для обработки вложенных значений.
    3. Элементы словарей сортируются по ключам, чтобы обеспечить детерминированный порядок.
    4. Булевы значения преобразуются в строки "true" или "false".
    5. Числа форматируются с фиксированной точностью и удаляются незначащие нули.
    6. Строки заключаются в двойные кавычки.
- **Внутренние функции**:
    - `handle_value(value)`: Обрабатывает каждое значение в словаре или списке.
- **Примеры**:
```python
# Пример использования deterministic_stringify
obj = {"b": 2, "a": 1}
result = deterministic_stringify(obj)
print(result)  # Вывод: a:1.00000000,b:2.00000000
```

### `prng_general`

```python
def prng_general(seed, multiplier, addend, modulus):
    """
    Генерирует псевдослучайное число с использованием общих параметров.

    Args:
        seed (int): Начальное значение.
        multiplier (int): Множитель.
        addend (int): Приращение.
        modulus (int): Модуль.

    Returns:
        float: Псевдослучайное число в диапазоне [0, 1).

    """
```

- **Описание**: Генерирует псевдослучайное число с использованием заданных параметров.
- **Параметры**:
    - `seed` (int): Начальное значение.
    - `multiplier` (int): Множитель.
    - `addend` (int): Приращение.
    - `modulus` (int): Модуль.
- **Возвращает**:
    - `float`: Псевдослучайное число в диапазоне [0, 1).
- **Как работает**:
    1. Вычисляет новое значение `a` по формуле `a = seed * multiplier + addend`.
    2. Если `a` отрицательное, возвращает `((a % modulus) - modulus) / modulus`.
    3. Если `a` положительное, возвращает `(a % modulus) / modulus`.
- **Примеры**:
```python
# Пример использования prng_general
seed = 123
multiplier = 456
addend = 789
modulus = 1000
result = prng_general(seed, multiplier, addend, modulus)
print(result)
```

### `generate_challenge_seed`

```python
def generate_challenge_seed(l):
    """
    Генерирует начальное значение для challenge на основе входных данных.

    Args:
        l (Any): Входные данные для генерации начального значения.

    Returns:
        int: Начальное значение для challenge.

    """
```

- **Описание**: Генерирует начальное значение для challenge на основе входных данных.
- **Параметры**:
    - `l` (Any): Входные данные для генерации начального значения.
- **Возвращает**:
    - `int`: Начальное значение для challenge.
- **Как работает**:
    1. Преобразует входные данные в строку с использованием `deterministic_stringify`.
    2. Кодирует строку с использованием `parse.quote`.
    3. Вычисляет хеш-значение закодированной строки с помощью функции `simple_hash`.
- **Примеры**:
```python
# Пример использования generate_challenge_seed
data = {"question": "Hello", "answer": "Hi"}
result = generate_challenge_seed(data)
print(result)
```

### `simple_hash`

```python
def simple_hash(s):
    """
    Вычисляет простое хеш-значение для строки.

    Args:
        s (str): Строка для вычисления хеш-значения.

    Returns:
        int: Хеш-значение строки.

    """
```

- **Описание**: Вычисляет простое хеш-значение для строки.
- **Параметры**:
    - `s` (str): Строка для вычисления хеш-значения.
- **Возвращает**:
    - `int`: Хеш-значение строки.
- **Как работает**:
    1. Инициализирует хеш-значение `d` нулем.
    2. Итерируется по каждому символу в строке.
    3. Если длина символа больше 1 или его код больше или равен 256, пропускает символ.
    4. Вычисляет новое хеш-значение по формуле `d = ((d << 5) - d + ord(char[0])) & 0xFFFFFFFF`.
    5. Если `d` больше `0x7FFFFFFF`, вычитает `0x100000000`.
    6. Возвращает хеш-значение.
- **Примеры**:
```python
# Пример использования simple_hash
string = "Hello"
result = simple_hash(string)
print(result)
```

### `generate_challenge`

```python
def generate_challenge(obj, **kwargs):
    """
    Генерирует challenge на основе объекта и дополнительных параметров.

    Args:
        obj (Any): Объект для генерации challenge.
        **kwargs: Дополнительные параметры для prng_general.

    Returns:
        float: Сгенерированный challenge.

    """
```

- **Описание**: Генерирует challenge на основе объекта и дополнительных параметров.
- **Параметры**:
    - `obj` (Any): Объект для генерации challenge.
    - `**kwargs`: Дополнительные параметры для `prng_general`.
- **Возвращает**:
    - `float`: Сгенерированный challenge.
- **Как работает**:
    1. Генерирует начальное значение для challenge с помощью `generate_challenge_seed`.
    2. Вызывает функцию `prng_general` с начальным значением и дополнительными параметрами.
- **Примеры**:
```python
# Пример использования generate_challenge
data = {"question": "Hello", "answer": "Hi"}
kwargs = {"multiplier": 456, "addend": 789, "modulus": 1000}
result = generate_challenge(data, **kwargs)
print(result)
```