# Модуль `AmigoChat`

## Обзор

Модуль `AmigoChat` предоставляет асинхронный генератор для взаимодействия с API AmigoChat, поддерживающим как текстовые, так и графические модели. Он включает в себя поддержку потоковой передачи, системных сообщений и истории сообщений. Модуль использует библиотеку `aiohttp` для асинхронных HTTP-запросов.

## Детали
Модуль содержит класс `AmigoChat`, который является подклассом `AsyncGeneratorProvider` и `ProviderModelMixin`. Он определяет URL-адреса API, поддерживает потоковую передачу и предоставляет методы для создания асинхронных генераторов для текстовых и графических моделей. Он также включает в себя обработку ошибок и механизм повторных попыток.

## Классы

### `AmigoChat`

**Описание**: Класс для взаимодействия с API AmigoChat. Поддерживает как текстовые, так и графические модели.
**Наследует**: `AsyncGeneratorProvider`, `ProviderModelMixin`

**Атрибуты**:
- `url` (str): Базовый URL для AmigoChat.
- `chat_api_endpoint` (str): URL для API чата.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель по умолчанию, используемая, если не указана другая.
- `chat_models` (list): Список поддерживаемых моделей чата.
- `image_models` (list): Список поддерживаемых моделей изображений.
- `models` (list): Объединенный список моделей чата и изображений.
- `model_aliases` (dict): Словарь псевдонимов моделей для удобства использования.

**Принцип работы**:

Класс `AmigoChat` предоставляет интерфейс для взаимодействия с API AmigoChat. Он поддерживает как текстовые ответы, так и генерацию изображений, используя разные конечные точки API. Класс определяет, какие модели чата и изображений он поддерживает, а также псевдонимы для этих моделей. `create_async_generator` - это основной метод, который обрабатывает логику запросов к API. Он генерирует уникальные идентификаторы устройств и чатов, обрабатывает потоковую передачу ответов и повторные попытки в случае сбоев. Для API чата он отправляет сообщения и параметры модели, получает потоковые ответы и возвращает контент. Для API изображений он отправляет запросы и возвращает URL-адреса сгенерированных изображений.

**Методы**:
- `get_personaId(cls, model: str) -> str`: Возвращает идентификатор персоны для данной модели.
- `generate_chat_id() -> str`: Генерирует идентификатор чата в формате шестнадцатеричных цифр 8-4-4-4-12.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для взаимодействия с API AmigoChat.

## Методы класса

### `get_personaId`

```python
@classmethod
def get_personaId(cls, model: str) -> str:
    """
    Функция извлекает идентификатор личности (personaId) для указанной модели.

    Args:
        model (str): Название модели, для которой требуется получить идентификатор личности.

    Returns:
        str: Идентификатор личности для указанной модели.

    Raises:
        ValueError: Если модель не найдена в списках моделей чата или изображений.

    Пример:
        >>> AmigoChat.get_personaId('gpt-4o-mini')
        'amigo'
    """
    ...
```

### `generate_chat_id`

```python
@staticmethod
def generate_chat_id() -> str:
    """
    Функция генерирует уникальный идентификатор чата в формате UUID.

    Returns:
        str: Сгенерированный идентификатор чата.

    Пример:
        >>> AmigoChat.generate_chat_id()
        'a1b2c3d4-e5f6-7890-1234-567890abcdef'  # Пример сгенерированного UUID
    """
    ...
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    stream: bool = False,
    timeout: int = 300,
    frequency_penalty: float = 0,
    max_tokens: int = 4000,
    presence_penalty: float = 0,
    temperature: float = 0.5,
    top_p: float = 0.95,
    **kwargs
) -> AsyncResult:
    """
    Функция создает асинхронный генератор для взаимодействия с API AmigoChat.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        stream (bool, optional): Включить потоковую передачу ответов. По умолчанию `False`.
        timeout (int, optional): Время ожидания запроса в секундах. По умолчанию 300.
        frequency_penalty (float, optional): Штраф за частоту. По умолчанию 0.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 4000.
        presence_penalty (float, optional): Штраф за присутствие. По умолчанию 0.
        temperature (float, optional): Температура генерации. По умолчанию 0.5.
        top_p (float, optional): Значение top_p. По умолчанию 0.95.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий контент от API.

    Raises:
        Exception: Если происходит ошибка во время запроса к API или если достигнуто максимальное количество повторных попыток.

    Как функция работает:
    - Функция принимает различные параметры для настройки запроса к API AmigoChat, такие как модель, сообщения, прокси, потоковая передача, тайм-аут и параметры модели.
    - Генерируется уникальный идентификатор устройства (device_uuid) для каждого запроса.
    - Функция выполняет несколько попыток отправки запроса, если возникают ошибки.
    - Для текстовых моделей (не изображений) функция отправляет POST-запрос к конечной точке API чата с использованием aiohttp.
    - Если потоковая передача включена, функция итерирует по строкам ответа, извлекает контент из каждого чанка JSON и возвращает его через генератор.
    - Для моделей изображений функция отправляет POST-запрос к конечной точке API изображений и возвращает URL-адреса сгенерированных изображений.
    - В случае возникновения ошибок функция повторяет запрос до трех раз, прежде чем вызвать исключение.

    Пример:
        >>> async for message in AmigoChat.create_async_generator(model='gpt-4o-mini', messages=[{'role': 'user', 'content': 'Hello'}]):
        ...     print(message)
        Hello!
    """
    ...
```

## Параметры класса
- `url` (str): Базовый URL для AmigoChat.
- `chat_api_endpoint` (str): URL для API чата.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель по умолчанию, используемая, если не указана другая.
- `chat_models` (list): Список поддерживаемых моделей чата.
- `image_models` (list): Список поддерживаемых моделей изображений.
- `models` (list): Объединенный список моделей чата и изображений.
- `model_aliases` (dict): Словарь псевдонимов моделей для удобства использования.