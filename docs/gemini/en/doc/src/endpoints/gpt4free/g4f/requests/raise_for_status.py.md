# Модуль для обработки статусов ответов

## Обзор

Модуль предназначен для обработки HTTP-статусов ответов от серверов, включая обработку ошибок Cloudflare, ошибок, связанных с OpenAI, и других общих ошибок. Он содержит функции для асинхронной и синхронной проверки статусов ответов и возбуждения исключений в случае ошибок.

## Детали

Модуль предоставляет функциональность для определения, является ли ответ страницей Cloudflare или OpenAI, и соответственно обрабатывает ошибки. Код также определяет тип контента ответа для более точной обработки ошибок.

## Классы

### `CloudflareError`

**Описание**:
Класс исключения для обозначения ошибок, связанных с Cloudflare.

**Наследует от**:
- `ResponseStatusError`: Наследует от `ResponseStatusError` и представляет собой специфический тип ошибки HTTP-статуса, связанной с Cloudflare.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом от Cloudflare.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки ответа Cloudflare, иначе `False`.
    """
```

**Назначение**:
Функция проверяет, содержит ли текст ответа признаки, характерные для Cloudflare, такие как сообщения об ошибках или элементы HTML, используемые Cloudflare.

**Параметры**:
- `text` (str): Текст ответа, который анализируется на наличие признаков Cloudflare.

**Возвращает**:
- `bool`: Возвращает `True`, если текст содержит признаки Cloudflare, и `False` в противном случае.

**Как работает**:
- Функция проверяет наличие определенных строк в тексте, таких как "Generated by cloudfront", '<p id="cf-spinner-please-wait">', "<title>Attention Required! | Cloudflare</title>", \'id="cf-cloudflare-status"\', '<div id="cf-please-wait">', и "<title>Just a moment...</title>".
- Если какая-либо из этих строк найдена, функция возвращает `True`, указывая на то, что текст, вероятно, является ответом от Cloudflare. В противном случае возвращается `False`.

**Примеры**:

```python
>>> is_cloudflare('<html><title>Attention Required! | Cloudflare</title></html>')
True
>>> is_cloudflare('<html><body>Some content</body></html>')
False
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом от OpenAI.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки ответа OpenAI, иначе `False`.
    """
```

**Назначение**:
Функция проверяет, содержит ли текст ответа признаки, характерные для OpenAI, такие как сообщения об ошибках.

**Параметры**:
- `text` (str): Текст ответа, который анализируется на наличие признаков OpenAI.

**Возвращает**:
- `bool`: Возвращает `True`, если текст содержит признаки OpenAI, и `False` в противном случае.

**Как работает**:
- Функция проверяет наличие определенных строк в тексте, таких как "<p>Unable to load site</p>" или \'id="challenge-error-text"\'.
- Если какая-либо из этих строк найдена, функция возвращает `True`, указывая на то, что текст, вероятно, является ответом от OpenAI. В противном случае возвращается `False`.

**Примеры**:

```python
>>> is_openai('<html><p>Unable to load site</p></html>')
True
>>> is_openai('<html><body>Some content</body></html>')
False
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект ответа, который необходимо проверить.
        message (str, optional): Сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401 (не авторизован).
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI Bot, 502 (Bad Gateway) или любая другая ошибка.
        RateLimitError: Если статус ответа 504 (Gateway Timeout) или 429, 402 (Превышен лимит запросов).
    """
```

**Назначение**:
Асинхронная функция для проверки статуса HTTP-ответа и возбуждения исключения, если ответ содержит код ошибки.

**Параметры**:
- `response` (Union[StreamResponse, ClientResponse]): Объект ответа, который необходимо проверить. Это может быть `StreamResponse` или `ClientResponse` из библиотеки `aiohttp`.
- `message` (str, optional): Необязательное сообщение об ошибке. Если не указано, функция попытается извлечь сообщение из тела ответа. По умолчанию `None`.

**Исключения**:
- `MissingAuthError`: Возбуждается, если статус ответа равен 401 (не авторизован).
- `CloudflareError`: Возбуждается, если статус ответа равен 403 и ответ идентифицирован как ответ Cloudflare с использованием функции `is_cloudflare`.
- `ResponseStatusError`: Возбуждается в следующих случаях:
    - Статус ответа равен 403 и ответ идентифицирован как ответ OpenAI.
    - Статус ответа равен 502 (Bad Gateway).
    - В других случаях ошибок, когда статус ответа не является 200-299 (успешный).
- `RateLimitError`: Возбуждается, если статус ответа равен 504 (Gateway Timeout) или 429, 402 (Превышен лимит запросов).

**Как работает**:
1. **Проверка успешности**: Если `response.ok` равно `True` (т.е. статус ответа находится в диапазоне 200-299), функция не делает ничего и возвращается.
2. **Извлечение сообщения об ошибке**:
   - Если `message` не предоставлено, функция пытается извлечь его из тела ответа.
   - Если тип контента — `application/json`, функция пытается разобрать JSON и извлечь сообщение из поля `error` или `message`.
   - Если тип контента не JSON, функция извлекает текст из тела ответа.
   - Если тип контента `text/html` или тело ответа начинается с "<!DOCTYPE", флаг `is_html` устанавливается в `True`.
3. **Обработка ошибок Cloudflare и OpenAI**: Если статус ответа равен 403, функция проверяет, является ли ответ страницей Cloudflare или OpenAI, используя функции `is_cloudflare` и `is_openai` соответственно, и возбуждает соответствующее исключение.
4. **Возбуждение исключений для других кодов ошибок**: Для других кодов ошибок функция возбуждает исключения `MissingAuthError`, `RateLimitError` или `ResponseStatusError` с соответствующим сообщением.
5. **Обработка неизвестных ошибок**: Если статус ответа равен 520, сообщение устанавливается как "Unknown error (Cloudflare)".

**Примеры**:

```python
# Пример использования с моковым объектом response
class MockResponse:
    def __init__(self, status, headers, text):
        self.status = status
        self.headers = headers
        self.text = text
        self.ok = status == 200

    async def json(self):
        return {"error": {"message": self.text}}

    async def text(self):
        return self.text

# Пример успешного ответа
response = MockResponse(200, {}, "Success")
await raise_for_status_async(response)  # Ничего не произойдет

# Пример ответа с ошибкой 403 и Cloudflare
response = MockResponse(403, {"content-type": "text/html"}, '<html><title>Attention Required! | Cloudflare</title></html>')
try:
    await raise_for_status_async(response)
except CloudflareError as ex:
    print(f"Caught error: {ex}")

# Пример ответа с ошибкой 504
response = MockResponse(504, {}, "Gateway Timeout")
try:
    await raise_for_status_async(response)
except RateLimitError as ex:
    print(f"Caught error: {ex}")
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа, который необходимо проверить.
        message (str, optional): Сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401 (не авторизован).
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI Bot, 502 (Bad Gateway) или любая другая ошибка.
        RateLimitError: Если статус ответа 504 (Gateway Timeout) или 429, 402 (Превышен лимит запросов).
    """
```

**Назначение**:
Функция для проверки статуса HTTP-ответа и возбуждения исключения, если ответ содержит код ошибки. Функция поддерживает как асинхронные, так и синхронные ответы.

**Параметры**:
- `response` (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа, который необходимо проверить. Это может быть `Response` или `StreamResponse` (синхронные ответы), `ClientResponse` (асинхронный ответ от aiohttp) или `RequestsResponse` (ответ от библиотеки requests).
- `message` (str, optional): Необязательное сообщение об ошибке. Если не указано, функция попытается извлечь сообщение из тела ответа. По умолчанию `None`.

**Исключения**:
- `MissingAuthError`: Возбуждается, если статус ответа равен 401 (не авторизован).
- `CloudflareError`: Возбуждается, если статус ответа равен 403 и ответ идентифицирован как ответ Cloudflare с использованием функции `is_cloudflare`.
- `ResponseStatusError`: Возбуждается в следующих случаях:
    - Статус ответа равен 403 и ответ идентифицирован как ответ OpenAI.
    - Статус ответа равен 502 (Bad Gateway).
    - В других случаях ошибок, когда статус ответа не является 200-299 (успешный).
- `RateLimitError`: Возбуждается, если статус ответа равен 504 (Gateway Timeout) или 429, 402 (Превышен лимит запросов).

**Как работает**:
1. **Определение типа ответа**: Функция проверяет, содержит ли объект `response` атрибут `status`. Если атрибут присутствует, считается, что это асинхронный ответ, и вызывается функция `raise_for_status_async` для его обработки.
2. **Проверка успешности**: Если `response.ok` равно `True` (т.е. статус ответа находится в диапазоне 200-299), функция не делает ничего и возвращается.
3. **Извлечение сообщения об ошибке**:
   - Если `message` не предоставлено, функция пытается извлечь его из тела ответа.
   - Если тип контента — `text/html` или тело ответа начинается с "<!DOCTYPE", флаг `is_html` устанавливается в `True`.
   - Сообщение об ошибке извлекается из `response.text`.
4. **Обработка ошибок Cloudflare и OpenAI**: Если статус ответа равен 403, функция проверяет, является ли ответ страницей Cloudflare или OpenAI, используя функции `is_cloudflare` и `is_openai` соответственно, и возбуждает соответствующее исключение.
5. **Возбуждение исключений для других кодов ошибок**: Для других кодов ошибок функция возбуждает исключения `MissingAuthError`, `RateLimitError` или `ResponseStatusError` с соответствующим сообщением.
6. **Обработка неизвестных ошибок**: Если статус ответа равен 520, сообщение устанавливается как "Unknown error (Cloudflare)".

**Примеры**:

```python
# Пример использования с моковым объектом response
class MockResponse:
    def __init__(self, status_code, headers, text):
        self.status_code = status_code
        self.headers = headers
        self.text = text
        self.ok = status_code == 200

# Пример успешного ответа
response = MockResponse(200, {}, "Success")
raise_for_status(response)  # Ничего не произойдет

# Пример ответа с ошибкой 403 и Cloudflare
response = MockResponse(403, {"content-type": "text/html"}, '<html><title>Attention Required! | Cloudflare</title></html>')
try:
    raise_for_status(response)
except CloudflareError as ex:
    print(f"Caught error: {ex}")

# Пример ответа с ошибкой 504
response = MockResponse(504, {}, "Gateway Timeout")
try:
    raise_for_status(response)
except RateLimitError as ex:
    print(f"Caught error: {ex}")
```