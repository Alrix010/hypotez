# Модуль `DeepInfra.py`

## Обзор

Модуль `DeepInfra.py` предназначен для взаимодействия с сервисом DeepInfra для выполнения задач генерации текста и изображений. Он содержит класс `DeepInfra`, который наследуется от `OpenaiTemplate` и предоставляет методы для получения моделей, создания асинхронных генераторов текста и создания асинхронных изображений. Модуль требует аутентификации для работы.

## Подробнее

Модуль предоставляет интерфейс для работы с DeepInfra API, позволяя пользователям использовать различные модели для генерации текста и изображений. Он также обрабатывает запросы к API, устанавливает необходимые заголовки и обрабатывает ответы, возвращая результаты в удобном формате.

## Классы

### `DeepInfra`

**Описание**:
Класс `DeepInfra` предназначен для взаимодействия с API DeepInfra.

**Наследует**:
- `OpenaiTemplate`: Класс наследуется от `OpenaiTemplate`, который, вероятно, предоставляет базовый функционал для работы с API OpenAI.

**Атрибуты**:
- `url` (str): URL главной страницы DeepInfra.
- `login_url` (str): URL страницы для получения API ключей.
- `api_base` (str): Базовый URL для API DeepInfra.
- `working` (bool): Флаг, указывающий, что провайдер работает.
- `needs_auth` (bool): Флаг, указывающий, что для работы требуется аутенфикация.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (list): Список доступных моделей для генерации текста и изображений.
- `image_models` (list): Список доступных моделей для генерации изображений.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `get_image_models()`: Получает список доступных моделей для генерации изображений.
- `create_async_generator()`: Создает асинхронный генератор для генерации текста или изображения.
- `create_async_image()`: Создает асинхронное изображение.

## Методы класса

### `get_models`

```python
@classmethod
def get_models(cls, **kwargs) -> list[str]:
    """
    Функция получает список доступных моделей из API DeepInfra.

    Args:
        **kwargs: Произвольные аргументы.

    Returns:
        list[str]: Список доступных моделей.
    """
```

**Назначение**:
Метод `get_models` используется для получения списка доступных моделей из API DeepInfra. Если список моделей еще не был получен, он запрашивает его из API и сохраняет в атрибуте класса `models`.

**Как работает**:
1. Проверяется, был ли уже получен список моделей (проверяется атрибут `cls.models`).
2. Если список моделей не был получен, выполняется GET-запрос к API DeepInfra для получения списка моделей.
3. Полученный JSON-ответ преобразуется в список моделей и сохраняется в атрибуте класса `models` и `image_models`.
4. Возвращается список доступных моделей.

**Примеры**:

```python
models = DeepInfra.get_models()
print(models)
```

### `get_image_models`

```python
@classmethod
def get_image_models(cls, **kwargs) -> list[str]:
    """
    Функция получает список доступных моделей для генерации изображений из API DeepInfra.

    Args:
        **kwargs: Произвольные аргументы.

    Returns:
        list[str]: Список доступных моделей для генерации изображений.
    """
```

**Назначение**:
Метод `get_image_models` используется для получения списка доступных моделей для генерации изображений из API DeepInfra. Если список моделей еще не был получен, он вызывает метод `get_models` для его получения.

**Как работает**:
1. Проверяется, был ли уже получен список моделей для генерации изображений (проверяется атрибут `cls.image_models`).
2. Если список моделей не был получен, вызывается метод `get_models` для его получения.
3. Возвращается список доступных моделей для генерации изображений.

**Примеры**:

```python
image_models = DeepInfra.get_image_models()
print(image_models)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    prompt: str = None,
    temperature: float = 0.7,
    max_tokens: int = 1028,
    **kwargs
) -> AsyncResult:
    """
    Функция создает асинхронный генератор для генерации текста или изображения.

    Args:
        model (str): Название модели для генерации.
        messages (Messages): Список сообщений для генерации.
        stream (bool): Флаг, указывающий, нужно ли использовать потоковую передачу данных.
        prompt (str, optional): Промпт для генерации изображения. По умолчанию `None`.
        temperature (float, optional): Температура для генерации текста. По умолчанию 0.7.
        max_tokens (int, optional): Максимальное количество токенов для генерации текста. По умолчанию 1028.
        **kwargs: Произвольные аргументы.

    Yields:
        AsyncResult: Асинхронный результат генерации.
    """
```

**Назначение**:
Метод `create_async_generator` используется для создания асинхронного генератора, который генерирует текст или изображения на основе переданных параметров.

**Как работает**:
1. Проверяется, является ли указанная модель моделью для генерации изображений.
2. Если модель является моделью для генерации изображений, вызывается метод `create_async_image` для создания изображения.
3. Если модель не является моделью для генерации изображений, устанавливаются заголовки для запроса к API.
4. Вызывается метод `create_async_generator` базового класса `OpenaiTemplate` для генерации текста.
5. Возвращается асинхронный результат генерации.

**Примеры**:

```python
async for chunk in DeepInfra.create_async_generator(
    model="meta-llama/Meta-Llama-3.1-70B-Instruct",
    messages=[{"role": "user", "content": "Hello, how are you?"}],
    stream=True
):
    print(chunk)
```

### `create_async_image`

```python
@classmethod
async def create_async_image(
    cls,
    prompt: str,
    model: str,
    api_key: str = None,
    api_base: str = "https://api.deepinfra.com/v1/inference",
    proxy: str = None,
    timeout: int = 180,
    extra_data: dict = {},
    **kwargs
) -> ImageResponse:
    """
    Функция создает асинхронное изображение.

    Args:
        prompt (str): Промпт для генерации изображения.
        model (str): Название модели для генерации изображения.
        api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
        api_base (str, optional): Базовый URL для API DeepInfra. По умолчанию "https://api.deepinfra.com/v1/inference".
        proxy (str, optional): Прокси сервер для использования. По умолчанию `None`.
        timeout (int, optional): Максимальное время ожидания ответа от API. По умолчанию 180.
        extra_data (dict, optional): Дополнительные данные для передачи в запросе. По умолчанию {}.
        **kwargs: Произвольные аргументы.

    Returns:
        ImageResponse: Объект `ImageResponse`, содержащий сгенерированное изображение.
    """
```

**Назначение**:
Метод `create_async_image` используется для создания асинхронного изображения на основе переданных параметров.

**Как работает**:
1. Устанавливаются заголовки для запроса к API.
2. Если передан API ключ, он добавляется в заголовки.
3. Создается асинхронная сессия с использованием `StreamSession`.
4. Получается название модели.
5. Формируются данные для запроса.
6. Выполняется POST-запрос к API DeepInfra для генерации изображения.
7. Обрабатывается ответ от API и извлекается изображение.
8. Возвращается объект `ImageResponse`, содержащий сгенерированное изображение.

**Примеры**:

```python
image = await DeepInfra.create_async_image(
    prompt="A cat sitting on a mat",
    model="stabilityai/sd3.5",
    api_key="YOUR_API_KEY"
)
print(image.image)