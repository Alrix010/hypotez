# Module Jmuz

## Обзор

Модуль `Jmuz` представляет собой класс `Jmuz`, который является подклассом `OpenaiTemplate` и предназначен для работы с API Jmuz.me для взаимодействия с различными моделями, такими как GPT-4o и Gemini. Модуль поддерживает потоковую передачу данных и предоставляет интерфейс для отправки сообщений и получения ответов от этих моделей. Также модуль содержит настройки для работы с API, включая URL, API key и заголовки.

## Более подробно

Модуль `Jmuz` используется для упрощения взаимодействия с API Jmuz.me. Он содержит предопределенные настройки, такие как URL, API key и заголовки, что упрощает настройку и использование API. Кроме того, модуль предоставляет методы для получения списка доступных моделей и создания асинхронного генератора для потоковой передачи данных. Это позволяет легко интегрировать функциональность Jmuz.me в проекты, требующие взаимодействия с AI-моделями.

## Классы

### `Jmuz`

**Описание**: Класс `Jmuz` является подклассом `OpenaiTemplate` и предоставляет интерфейс для работы с API Jmuz.me.

**Наследует**:
- `OpenaiTemplate`: Класс, предоставляющий общие методы и атрибуты для работы с OpenAI-подобными API.

**Атрибуты**:
- `url` (str): URL для присоединения к Discord.
- `api_base` (str): Базовый URL API Jmuz.me.
- `api_key` (str): API key для аутентификации.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_system_message` (bool): Указывает, поддерживает ли модель системные сообщения.
- `default_model` (str): Модель, используемая по умолчанию ("gpt-4o").
- `model_aliases` (dict): Псевдонимы моделей для совместимости.

**Принцип работы**:
Класс `Jmuz` использует атрибуты класса для настройки соединения с API Jmuz.me. Он переопределяет некоторые методы из `OpenaiTemplate`, чтобы адаптировать их к особенностям API Jmuz.me. Например, метод `create_async_generator` используется для создания асинхронного генератора, который отправляет сообщения в API и получает ответы в потоковом режиме.

**Методы**:
- `get_models(**kwargs)`: Возвращает список доступных моделей.
- `create_async_generator(model: str, messages: Messages, stream: bool = True, api_key: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения потоковых ответов от API.

## Методы класса

### `get_models`

```python
@classmethod
def get_models(cls, **kwargs):
    """
    Возвращает список доступных моделей.

    Args:
        **kwargs: Дополнительные параметры.

    Returns:
        list: Список доступных моделей.
    """
```

**Назначение**:
Метод `get_models` используется для получения списка доступных моделей из API Jmuz. Если список моделей еще не был получен, он вызывает метод `super().get_models` для получения списка моделей из базового класса `OpenaiTemplate`.

**Параметры**:
- `cls` (type): Ссылка на класс.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в метод `super().get_models`.

**Возвращает**:
- `list`: Список доступных моделей.

**Пример**:
```python
models = Jmuz.get_models()
print(models)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = True,
        api_key: str = None, # Remove api_key from kwargs
        **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения потоковых ответов от API.

    Args:
        model (str): Название модели.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Указывает, использовать ли потоковую передачу. По умолчанию `True`.
        api_key (str): API key для аутентификации. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий потоковые ответы от API.
    """
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор, который отправляет сообщения в API Jmuz.me и получает ответы в потоковом режиме. Он использует метод `super().create_async_generator` из базового класса `OpenaiTemplate` для отправки запроса и получения ответа.

**Параметры**:
- `cls` (type): Ссылка на класс.
- `model` (str): Название модели.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool): Указывает, использовать ли потоковую передачу. По умолчанию `True`.
- `api_key` (str): API key для аутентификации. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий потоковые ответы от API.

**Как работает функция**:

1. **Подготовка заголовков**:
   - Создаются заголовки (`headers`) для HTTP-запроса, включая `Authorization` с API key, `Content-Type` как `application/json`, `accept` как `*/*` и `user-agent`.

2. **Асинхронная генерация чанков данных**:
   - Вызывается `super().create_async_generator` для получения чанков данных из API Jmuz.me.
   - Указываются параметры, такие как `model`, `messages`, `api_base`, `api_key`, `stream` и `headers`.

3. **Фильтрация и обработка чанков**:
   - Происходит итерация по каждому чанку данных, полученному из генератора.
   - Чанки добавляются в буфер (`buffer`).
   - Проверяются условия для фильтрации нежелательных данных:
     - Если буфер начинается с "Join for free" или содержит "https://discord.gg/", данные отбрасываются.
     - Если буфер начинается с "o1-preview", данные отбрасываются.
   - Удаляются начальные пробелы из буфера, если это первый чанк.
   - Если после фильтрации в буфере остаются данные, они передаются как результат.

4. **Возврат чанков данных**:
   - Каждый чанк данных возвращается как результат асинхронного генератора.

**Примеры**:

```python
import asyncio
from typing import List, Dict

async def main():
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello"}]
    async for chunk in Jmuz.create_async_generator(model="gpt-4o", messages=messages):
        print(chunk)

if __name__ == "__main__":
    asyncio.run(main())
```

## Параметры класса

- `url` (str): URL для присоединения к Discord.
- `api_base` (str): Базовый URL API Jmuz.me.
- `api_key` (str): API key для аутентификации.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_system_message` (bool): Указывает, поддерживает ли модель системные сообщения.
- `default_model` (str): Модель, используемая по умолчанию ("gpt-4o").
- `model_aliases` (dict): Псевдонимы моделей для совместимости.