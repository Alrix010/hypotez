# Модуль media.py

## Обзор

Модуль `media.py` предназначен для обработки медиа-контента в проекте `hypotez`. Он включает функции для рендеринга медиафайлов (изображений и аудио), преобразования сообщений с медиа-контентом и объединения медиафайлов с сообщениями. Модуль также предоставляет возможность представления медиа-контента в различных форматах, таких как пути к файлам, base64-encoded строки и data URI.

## Подробнее

Модуль содержит функции для рендеринга медиа из указанных bucket-ов, слияния медиафайлов с сообщениями и рендеринга сообщений для обработки мультимедийного контента. В нем определены функции для работы с различными типами медиаданных и их преобразования в нужные форматы.

## Функции

### `render_media`

```python
def render_media(bucket_id: str, name: str, url: str, as_path: bool = False, as_base64: bool = False) -> Union[str, Path]:
    """Функция выполняет рендеринг медиа-файла в зависимости от указанных параметров.

    Args:
        bucket_id (str): Идентификатор bucket-а, в котором хранится медиафайл.
        name (str): Имя медиафайла.
        url (str): URL медиафайла.
        as_path (bool, optional): Если `True`, возвращает путь к файлу. По умолчанию `False`.
        as_base64 (bool, optional): Если `True`, возвращает медиафайл в формате base64. По умолчанию `False`.

    Returns:
        Union[str, Path]: Путь к файлу, base64-encoded строка или data URI медиафайла.

    Как работает функция:
    - Проверяет, нужно ли вернуть путь к файлу или base64-encoded представление.
    - Формирует путь к файлу на основе `bucket_id`, типа "media" и имени файла.
    - Если `as_path` установлен в `True`, функция возвращает путь к файлу.
    - Если `as_base64` установлен в `True`, файл считывается, кодируется в base64 и возвращается в виде строки.
    - Если ни `as_path`, ни `as_base64` не установлены, формируется data URI и возвращается.
    - Если URL начинается с "/", предполагается, что файл находится локально и обрабатывается аналогично.
    - Если все условия не выполняются, возвращается исходный URL.

    Примеры:
        >>> render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png', as_path=True)
        PosixPath('test_bucket/media/image.png')

        >>> render_media(bucket_id='test_bucket', name='audio.mp3', url='http://example.com/audio.mp3')
        'http://example.com/audio.mp3'
    """
    ...
```

### `render_part`

```python
def render_part(part: dict) -> dict:
    """Функция выполняет рендеринг отдельной части контента (текст, изображение, аудио).

    Args:
        part (dict): Словарь с данными о части контента.

    Returns:
        dict: Словарь с информацией о типе и содержимом части контента.

    Как работает функция:
    - Проверяет наличие ключа "type" в словаре `part`. Если он есть, функция возвращает `part` без изменений.
    - Если ключ "type" отсутствует, проверяется наличие имени файла (`filename`).
    - Если имя файла отсутствует, формируется путь к bucket-у и возвращается текстовое представление содержимого bucket-а.
    - Если имя файла указывает на аудиофайл (определяется с помощью `is_data_an_audio`), формируется словарь с типом "input_audio" и данными в формате base64.
    - В противном случае формируется словарь с типом "image_url" и URL отрендеренного изображения.

    Примеры:
        >>> render_part({'bucket_id': 'test_bucket', 'name': 'audio.mp3'})
        {'type': 'input_audio', 'input_audio': {'data': 'base64encodeddata', 'format': 'mp3'}}

        >>> render_part({'type': 'text', 'text': 'Hello, world!'})
        {'type': 'text', 'text': 'Hello, world!'}
    """
    ...
```

### `merge_media`

```python
def merge_media(media: list, messages: list) -> Iterator:
    """Функция выполняет слияние медиафайлов с сообщениями.

    Args:
        media (list): Список медиафайлов.
        messages (list): Список сообщений.

    Yields:
        Iterator: Итератор, возвращающий медиафайлы и сообщения.

    Как работает функция:
    - Функция принимает два списка: `media` (медиафайлы) и `messages` (сообщения).
    - Она итерируется по сообщениям и, если роль сообщения "user", анализирует контент сообщения.
    - Если контент является списком, функция проходит по каждому элементу списка (части контента).
    - Если в части контента отсутствует ключ "type", но есть ключ "name", функция рендерит медиафайл, получая путь к нему, и добавляет его в буфер.
    - Если тип части контента "image_url", функция добавляет URL изображения в буфер.
    - После обработки всех сообщений пользователя функция возвращает все медиафайлы из буфера, а затем медиафайлы из входного списка `media`.

    Примеры:
        >>> messages = [{'role': 'user', 'content': [{'name': 'image.png', 'bucket_id': 'test_bucket'}]}]
        >>> list(merge_media(media=[], messages=messages))
        [(PosixPath('test_bucket/media/image.png'), 'image.png')]

        >>> messages = [{'role': 'assistant', 'content': 'OK'}]
        >>> list(merge_media(media=[], messages=messages))
        []
    """
    ...
```

### `render_messages`

```python
def render_messages(messages: Messages, media: list = None) -> Iterator:
    """Функция выполняет рендеринг сообщений с медиа-контентом.

    Args:
        messages (Messages): Список сообщений для рендеринга.
        media (list, optional): Список медиафайлов для добавления к последнему сообщению. По умолчанию `None`.

    Yields:
        Iterator: Итератор, возвращающий отрендеренные сообщения.

    Как работает функция:
    - Функция принимает список сообщений и опциональный список медиафайлов.
    - Итерируется по сообщениям.
    - Если контент сообщения является списком, рендерит каждую часть контента с помощью `render_part`.
    - Если есть медиафайлы и это последнее сообщение, добавляет медиафайлы к контенту сообщения, преобразуя их в формат "input_audio" или "image_url".
    - Возвращает отрендеренные сообщения.

    Примеры:
        >>> messages = [{'role': 'user', 'content': [{'name': 'audio.mp3', 'bucket_id': 'test_bucket'}]}]
        >>> list(render_messages(messages=messages))
        [{'role': 'user', 'content': [{'type': 'input_audio', 'input_audio': {'data': 'base64encodeddata', 'format': 'mp3'}}]}]

        >>> messages = [{'role': 'assistant', 'content': 'OK'}]
        >>> list(render_messages(messages=messages))
        [{'role': 'assistant', 'content': 'OK'}]
    """
    ...