## Модуль `Copilot.py`

### Обзор

Этот модуль предоставляет интерфейс для взаимодействия с Microsoft Copilot через API. Он включает в себя функции для создания запросов, обработки ответов и управления сессиями разговоров. Модуль поддерживает потоковую передачу данных, работу с медиа-файлами и аутентификацию.

### Подробности

Модуль `Copilot` предназначен для интеграции с сервисом Microsoft Copilot, предоставляя возможности для обмена сообщениями и получения ответов. Он использует библиотеки `curl_cffi` и `nodriver` для выполнения HTTP-запросов и управления сессиями. В случае отсутствия необходимых библиотек, модуль предусматривает обработку исключений и предлагает установить недостающие зависимости.

## Классы

### `Conversation`

**Описание**: Класс для представления разговора с Copilot.

**Наследует**: `JsonConversation`

**Атрибуты**:

-   `conversation_id` (str): Идентификатор разговора.

**Методы**:

*   `__init__(self, conversation_id: str)`
    *   **Описание**: Инициализирует экземпляр класса `Conversation`.
    *   **Параметры**:
        *   `conversation_id` (str): Идентификатор разговора.
    *   **Возвращает**: `None`

### `Copilot`

**Описание**: Класс для взаимодействия с Microsoft Copilot.

**Наследует**: `AbstractProvider`, `ProviderModelMixin`

**Атрибуты**:

-   `label` (str): Метка провайдера ("Microsoft Copilot").
-   `url` (str): URL сервиса Copilot ("https://copilot.microsoft.com").
-   `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
-   `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (True).
-   `default_model` (str): Модель по умолчанию ("Copilot").
-   `models` (list): Список поддерживаемых моделей (\["Copilot", "Think Deeper"] ).
-   `model_aliases` (dict): Псевдонимы моделей.
-   `websocket_url` (str): URL для подключения к WebSocket ("wss://copilot.microsoft.com/c/api/chat?api-version=2").
-   `conversation_url` (str): URL для управления разговорами ("https://copilot.microsoft.com/c/api/conversations").
-   `_access_token` (str): Токен доступа.
-   `_cookies` (dict): Куки.

**Принцип работы**:

Класс `Copilot` предоставляет методы для создания запросов к Microsoft Copilot, обработки ответов и управления сессиями разговоров. Он использует библиотеки `curl_cffi` и `nodriver` для выполнения HTTP-запросов и управления сессиями. Класс поддерживает потоковую передачу данных, работу с медиа-файлами и аутентификацию.

**Методы**:

*   `create_completion(cls, model: str, messages: Messages, stream: bool = False, proxy: str = None, timeout: int = 900, prompt: str = None, media: MediaListType = None, conversation: BaseConversation = None, return_conversation: bool = False, api_key: str = None, **kwargs) -> CreateResult`
    *   **Описание**: Создает запрос к Copilot и обрабатывает ответ.
    *   **Параметры**:
        *   `model` (str): Модель для использования.
        *   `messages` (Messages): Список сообщений для отправки.
        *   `stream` (bool): Флаг, указывающий на необходимость потоковой передачи данных.
        *   `proxy` (str): URL прокси-сервера.
        *   `timeout` (int): Время ожидания ответа.
        *   `prompt` (str): Текст запроса.
        *   `media` (MediaListType): Список медиа-файлов для отправки.
        *   `conversation` (BaseConversation): Объект разговора.
        *   `return_conversation` (bool): Флаг, указывающий на необходимость возврата объекта разговора.
        *   `api_key` (str): API ключ для аутентификации.
        *   `**kwargs`: Дополнительные аргументы.
    *   **Возвращает**: `CreateResult`
    *   **Вызывает**:
        *   `MissingRequirementsError`: Если не установлена библиотека `curl_cffi`.
        *   `NoValidHarFileError`: Если не найден валидный HAR-файл.
        *   `MissingAuthError`: Если отсутствует токен доступа.

## Функции

### `get_access_token_and_cookies(url: str, proxy: str = None, target: str = "ChatAI")`

**Описание**: Асинхронная функция для получения токена доступа и куки из браузера.

**Параметры**:

-   `url` (str): URL для получения токена доступа.
-   `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
-   `target` (str, optional): Цель для получения токена доступа. По умолчанию "ChatAI".

**Возвращает**:

-   `tuple[str, dict]`: Кортеж, содержащий токен доступа и словарь куки.

**Как работает функция**:

1.  Запускает браузер с использованием `nodriver`.
2.  Переходит по указанному `url`.
3.  Выполняет JavaScript-код для извлечения токена доступа из `localStorage`.
4.  Получает куки из браузера.
5.  Закрывает страницу и останавливает браузер.
6.  Возвращает токен доступа и куки.

### `readHAR(url: str)`

**Описание**: Функция для чтения токена доступа и куки из HAR-файла.

**Параметры**:

-   `url` (str): URL для поиска в HAR-файлах.

**Возвращает**:

-   `tuple[str, dict]`: Кортеж, содержащий токен доступа и словарь куки.

**Вызывает**:

-   `NoValidHarFileError`: Если не найден токен доступа в HAR-файлах.

**Как работает функция**:

1.  Перебирает HAR-файлы, полученные с помощью `get_har_files()`.
2.  Читает содержимое каждого файла.
3.  Ищет записи, URL которых начинаются с указанного `url`.
4.  Извлекает токен доступа из заголовка `authorization`.
5.  Извлекает куки из запроса.
6.  Если токен доступа не найден, вызывает исключение `NoValidHarFileError`.
7.  Возвращает токен доступа и куки.

### `get_clarity() -> bytes`

**Описание**: Функция для получения тела запроса Clarity.

**Возвращает**:

-   `bytes`: Тело запроса Clarity в виде байтов.

**Как работает функция**:

1.  Декодирует строку base64.
2.  Возвращает декодированные байты.

**Примеры**:

```python
body = get_clarity()
print(body)