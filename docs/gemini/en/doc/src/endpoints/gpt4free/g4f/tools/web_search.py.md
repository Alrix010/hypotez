# Модуль для веб-поиска

## Обзор

Модуль предназначен для выполнения веб-поиска с использованием DuckDuckGo Search и извлечения текста из найденных веб-страниц. Он предоставляет функциональность для запроса поисковой системы, извлечения и очистки текста из HTML-контента, а также кэширования результатов для повышения производительности. Модуль включает классы для представления результатов поиска и вспомогательные функции для обработки текста и HTML.

## Подробнее

Модуль использует библиотеку `duckduckgo_search` для выполнения поисковых запросов и `beautifulsoup4` для парсинга HTML. Он также включает функциональность для кэширования результатов поиска и извлеченного текста, чтобы избежать повторных запросов и повысить производительность.
Модуль предназначен для использования в задачах, требующих автоматического извлечения информации из интернета, например, для создания ответов на запросы пользователей на основе результатов поиска.
В `hypotez` проекте используется для обработки пользовательских запросов, требующих информации из интернета.

## Классы

### `SearchResults`

**Описание**: Класс для представления результатов поиска.

**Атрибуты**:
- `results` (list): Список объектов `SearchResultEntry`, представляющих результаты поиска.
- `used_words` (int): Количество использованных слов.

**Методы**:
- `from_dict(data: dict)`: Создает экземпляр класса из словаря.
- `__iter__()`: Возвращает итератор по результатам поиска.
- `__str__()`: Возвращает строковое представление результатов поиска.
- `__len__()` -> int: Возвращает количество результатов поиска.
- `get_sources()` -> Sources: Возвращает список источников в формате `Sources`.
- `get_dict()`: Возвращает словарь, представляющий объект.

### `SearchResultEntry`

**Описание**: Класс для представления отдельного результата поиска.

**Атрибуты**:
- `title` (str): Заголовок результата поиска.
- `url` (str): URL результата поиска.
- `snippet` (str): Краткое описание результата поиска.
- `text` (str, optional): Полный текст, извлеченный из веб-страницы. По умолчанию `None`.

**Методы**:
- `set_text(text: str)`: Устанавливает текст результата поиска.
- `get_dict()`:  Возвращает словарь, представляющий объект.

## Функции

### `scrape_text`

```python
def scrape_text(html: str, max_words: int = None, add_source=True, count_images: int = 2) -> Iterator[str]:
    """Извлекает текст из HTML-кода, ограничивая количество слов и добавляя источник.

    Args:
        html (str): HTML-код для извлечения текста.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool, optional): Добавлять ли источник в конец извлеченного текста. По умолчанию `True`.
        count_images (int, optional): Максимальное количество изображений для извлечения. По умолчанию `2`.

    Returns:
        Iterator[str]: Итератор по извлеченным текстовым фрагментам.

    Как работает:
    - Функция использует BeautifulSoup для парсинга HTML-кода.
    - Выбирает основной контент из HTML, используя различные селекторы.
    - Извлекает текст из параграфов, заголовков и таблиц.
    - Ограничивает количество извлекаемых слов, если указано `max_words`.
    - Добавляет ссылку на источник, если `add_source` установлен в `True`.
    - Игнорирует дубликаты слов.
    """
```

### `fetch_and_scrape`

```python
async def fetch_and_scrape(session: ClientSession, url: str, max_words: int = None, add_source: bool = False) -> str:
    """Асинхронно загружает HTML-код с веб-страницы и извлекает текст.

    Args:
        session (ClientSession): Асинхронная сессия для выполнения HTTP-запросов.
        url (str): URL веб-страницы для загрузки и извлечения текста.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool, optional): Добавлять ли источник в конец извлеченного текста. По умолчанию `False`.

    Returns:
        str: Извлеченный текст или `None` в случае ошибки.

    Как работает:
    - Функция сначала пытается прочитать текст из кэш-файла.
    - Если кэш-файл не существует, она выполняет HTTP-запрос к указанному URL.
    - Извлекает HTML-код из ответа.
    - Извлекает текст из HTML-кода с использованием функции `scrape_text`.
    - Сохраняет извлеченный текст в кэш-файл.
    - Обрабатывает ошибки HTTP-запросов и возвращает `None` в случае ошибки.
    """
```

### `search`

```python
async def search(query: str, max_results: int = 5, max_words: int = 2500, backend: str = "auto", add_text: bool = True, timeout: int = 5, region: str = "wt-wt") -> SearchResults:
    """Выполняет поиск в DuckDuckGo и возвращает результаты.

    Args:
        query (str): Поисковый запрос.
        max_results (int, optional): Максимальное количество результатов для возврата. По умолчанию `5`.
        max_words (int, optional): Максимальное количество слов для извлечения из каждой страницы. По умолчанию `2500`.
        backend (str, optional): Бэкэнд для поиска. По умолчанию "auto".
        add_text (bool, optional): Извлекать ли текст из веб-страниц. По умолчанию `True`.
        timeout (int, optional): Время ожидания HTTP-запроса в секундах. По умолчанию `5`.
        region (str, optional): Регион поиска. По умолчанию "wt-wt".

    Returns:
        SearchResults: Объект `SearchResults`, содержащий результаты поиска.

    Raises:
        MissingRequirementsError: Если отсутствуют необходимые библиотеки (`duckduckgo-search` или `beautifulsoup4`).

    Как работает:
    - Функция выполняет поиск с использованием DuckDuckGo Search.
    - Извлекает результаты поиска и создает объекты `SearchResultEntry`.
    - Если `add_text` установлен в `True`, она асинхронно загружает и извлекает текст из каждой веб-страницы.
    - Ограничивает общее количество слов, извлеченных из веб-страниц, используя параметр `max_words`.
    - Возвращает объект `SearchResults`, содержащий отформатированные результаты поиска.
    """
```

### `do_search`

```python
async def do_search(prompt: str, query: str = None, instructions: str = DEFAULT_INSTRUCTIONS, **kwargs) -> tuple[str, Sources]:
    """Выполняет поиск и формирует ответ на основе результатов поиска.

    Args:
        prompt (str): Исходный запрос пользователя.
        query (str, optional): Поисковый запрос. Если не указан, используется первая строка запроса пользователя. По умолчанию `None`.
        instructions (str, optional): Инструкции для формирования ответа на основе результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
        **kwargs: Дополнительные параметры для функции `search`.

    Returns:
        tuple[str, Sources]: Кортеж, содержащий новый запрос и источники результатов поиска.

    Как работает:
    - Если в запросе уже есть результаты поиска, функция возвращает исходный запрос без изменений.
    - Если поисковый запрос не указан, функция использует первую строку запроса пользователя в качестве поискового запроса.
    - Выполняет поиск с использованием функции `search`.
    - Формирует новый запрос, включающий результаты поиска и инструкции для формирования ответа.
    - Кэширует результаты поиска.
    """
```

### `get_search_message`

```python
def get_search_message(prompt: str, raise_search_exceptions=False, **kwargs) -> str:
    """Выполняет поиск и возвращает сообщение с результатами.

    Args:
        prompt (str): Запрос пользователя.
        raise_search_exceptions (bool, optional): Вызывать ли исключения, возникающие при поиске. По умолчанию `False`.
        **kwargs: Дополнительные параметры для функции `do_search`.

    Returns:
        str: Сообщение с результатами поиска.

    Как работает:
    - Функция выполняет поиск с использованием функции `do_search`.
    - Обрабатывает исключения, возникающие при поиске, и возвращает исходный запрос в случае ошибки.
    """
```

### `spacy_get_keywords`

```python
def spacy_get_keywords(text: str):
    """Извлекает ключевые слова из текста с использованием spaCy.

    Args:
        text (str): Текст для извлечения ключевых слов.

    Returns:
        keywords: Ключевые слова.

    Как работает:
    - Функция извлекает ключевые слова из текста, используя spaCy.
    """
```