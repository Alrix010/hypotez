# Модуль поиска в интернете

## Обзор

Этот модуль предоставляет функциональность для поиска в интернете с использованием DuckDuckGo API и последующей обработки результатов для создания ответов на запросы пользователя. Модуль также включает в себя функции для извлечения ключевых слов из текста с помощью spaCy.

## Содержание

- **Классы:**
    - `SearchResults`
    - `SearchResultEntry`
- **Функции:**
    - `scrape_text`
    - `fetch_and_scrape`
    - `search`
    - `do_search`
    - `get_search_message`
    - `spacy_get_keywords`

## Классы

### `SearchResults`

**Описание**: Класс `SearchResults` представляет собой контейнер для хранения результатов поиска в интернете. Он предоставляет методы для итерации по результатам, получения источников, представления результатов в виде строки и преобразования в словарь.

**Атрибуты**:

- `results` (list): Список объектов `SearchResultEntry`, представляющих найденные результаты.
- `used_words` (int): Количество слов, использованных для формирования результатов поиска.

**Методы**:

- `__init__(self, results: list, used_words: int)`: Инициализирует объект `SearchResults`.
- `from_dict(cls, data: dict)`: Создает объект `SearchResults` из словаря.
- `__iter__(self)`: Возвращает итератор по результатам поиска.
- `__str__(self)`: Возвращает строковое представление результатов поиска.
- `__len__(self) -> int`: Возвращает количество результатов поиска.
- `get_sources(self) -> Sources`: Возвращает список источников.
- `get_dict(self)`: Возвращает словарь с результатами поиска.

### `SearchResultEntry`

**Описание**: Класс `SearchResultEntry` представляет собой отдельный результат поиска, содержащий информацию о заголовке, URL, фрагменте текста и полном тексте веб-страницы.

**Атрибуты**:

- `title` (str): Заголовок веб-страницы.
- `url` (str): URL веб-страницы.
- `snippet` (str): Фрагмент текста, найденный в результатах поиска.
- `text` (str): Полный текст веб-страницы (может быть `None`).

**Методы**:

- `__init__(self, title: str, url: str, snippet: str, text: str = None)`: Инициализирует объект `SearchResultEntry`.
- `set_text(self, text: str)`: Задает текст веб-страницы.

## Функции

### `scrape_text`

**Описание**: Функция `scrape_text` извлекает текст из HTML-кода веб-страницы, используя библиотеку BeautifulSoup. 

**Параметры**:

- `html` (str): HTML-код веб-страницы.
- `max_words` (int): Максимальное количество слов для извлечения текста.
- `add_source` (bool): Флаг, указывающий, следует ли добавлять источник в текст.
- `count_images` (int): Максимальное количество изображений, которые будут включены в текст.

**Возвращает**:

- `Iterator[str]`: Итератор, который выдает строки текста, извлеченные из HTML-кода.

**Как работает функция**:

- Функция парсит HTML-код с помощью `BeautifulSoup`.
- Она выбирает наиболее релевантные элементы, которые содержат текст.
- Она удаляет нерелевантные элементы, такие как скрытые элементы или элементы с ненужным содержимым.
- Функция фильтрует изображения и выбирает наиболее релевантные для вывода.
-  Функция выдает текст с разбиением на строки. 

**Примеры**:

```python
html = "<html><head><title>Example Title</title></head><body><h1>Example Heading</h1><p>Example paragraph.</p></body></html>"
text = list(scrape_text(html))
print(text)
```

### `fetch_and_scrape`

**Описание**: Функция `fetch_and_scrape` выполняет запрос к веб-странице, извлекает HTML-код и затем вызывает функцию `scrape_text` для извлечения текста из HTML-кода.

**Параметры**:

- `session` (ClientSession): Сессия для выполнения HTTP-запросов.
- `url` (str): URL веб-страницы.
- `max_words` (int): Максимальное количество слов для извлечения текста.
- `add_source` (bool): Флаг, указывающий, следует ли добавлять источник в текст.

**Возвращает**:

- `str`: Текст, извлеченный из веб-страницы.

**Как работает функция**:

- Функция использует асинхронный подход для выполнения запросов к веб-страницам.
- Она сохраняет данные в локальный кеш для повышения производительности.
- Она обрабатывает ошибки, возникающие при запросе к веб-странице.

### `search`

**Описание**: Функция `search` выполняет поиск в интернете с использованием DuckDuckGo API.

**Параметры**:

- `query` (str): Поисковый запрос.
- `max_results` (int): Максимальное количество результатов поиска.
- `max_words` (int): Максимальное количество слов для извлечения текста из результатов поиска.
- `backend` (str): Бекенд DuckDuckGo API.
- `add_text` (bool): Флаг, указывающий, следует ли извлекать текст из веб-страниц.
- `timeout` (int): Время ожидания для выполнения запросов к веб-страницам.
- `region` (str): Регион для поиска.

**Возвращает**:

- `SearchResults`: Объект `SearchResults` с результатами поиска.

**Как работает функция**:

- Функция использует DuckDuckGo API для выполнения поиска.
- Она фильтрует результаты, чтобы исключить ссылки на Google.
- Она извлекает текст из веб-страниц, если `add_text` установлен в `True`.

### `do_search`

**Описание**: Функция `do_search` выполняет поиск в интернете с использованием функции `search` и формирует строку, которая включает в себя результаты поиска и исходный запрос пользователя.

**Параметры**:

- `prompt` (str): Запрос пользователя.
- `query` (str): Поисковый запрос (может быть `None`).
- `instructions` (str): Дополнительные инструкции для модели.
- `kwargs`: Дополнительные аргументы для функции `search`.

**Возвращает**:

- `tuple[str, Sources]`: Кортеж, содержащий строку с результатами поиска и исходным запросом и объект `Sources` со списком источников.

**Как работает функция**:

- Функция проверяет, есть ли уже результаты поиска в запросе.
- Она формирует поисковый запрос, если он не был задан.
- Она выполняет поиск в интернете с помощью функции `search`.
- Она добавляет результаты поиска к исходному запросу пользователя.

### `get_search_message`

**Описание**: Функция `get_search_message` выполняет поиск в интернете с использованием функции `do_search` и обрабатывает ошибки, возникающие при выполнении поиска.

**Параметры**:

- `prompt` (str): Запрос пользователя.
- `raise_search_exceptions` (bool): Флаг, указывающий, следует ли перехватывать исключения, возникающие при выполнении поиска.
- `kwargs`: Дополнительные аргументы для функции `do_search`.

**Возвращает**:

- `str`: Строка с результатами поиска и исходным запросом.

**Как работает функция**:

- Она использует `asyncio.run` для выполнения асинхронной функции `do_search`.
- Она обрабатывает исключения, возникающие при выполнении поиска, и выводит сообщение об ошибке.

### `spacy_get_keywords`

**Описание**: Функция `spacy_get_keywords` извлекает ключевые слова из текста с помощью библиотеки spaCy.

**Параметры**:

- `text` (str): Текст, из которого нужно извлечь ключевые слова.

**Возвращает**:

- `list`: Список ключевых слов.

**Как работает функция**:

- Она использует модель spaCy для обработки текста.
- Она фильтрует слова, которые не являются существительными, собственными именами или прилагательными.
- Она добавляет именованные сущности в список ключевых слов.
- Она удаляет дубликаты из списка ключевых слов.