# Модуль: PerplexityLabs.py

## Обзор

Модуль `PerplexityLabs.py` предоставляет асинхронный интерфейс для взаимодействия с API Perplexity Labs. Он включает в себя функциональность для установления соединения через WebSocket, отправки запросов и получения ответов от моделей Perplexity Labs. Модуль поддерживает различные модели, такие как "r1-1776", "sonar-pro", "sonar" и другие.

## Подробнее

Этот модуль предназначен для асинхронного взаимодействия с API Perplexity Labs. Он использует WebSocket для обмена сообщениями и поддерживает различные модели Perplexity Labs. Модуль обрабатывает установление соединения, отправку данных и получение результатов, предоставляя удобный интерфейс для интеграции с другими частями проекта.

## Классы

### `PerplexityLabs`

**Описание**: Класс `PerplexityLabs` предоставляет асинхронный генератор для работы с API Perplexity Labs.
**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Добавляет поддержку выбора и управления моделями.

**Атрибуты**:
- `url` (str): URL главной страницы Perplexity Labs.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (list): Список поддерживаемых моделей.

**Принцип работы**:

Класс устанавливает соединение с API Perplexity Labs через WebSocket, отправляет запросы и получает ответы. Он использует асинхронный генератор для обработки потоковых данных, что позволяет эффективно обрабатывать большие объемы информации.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API.

## Методы класса

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """ Создает асинхронный генератор для взаимодействия с API Perplexity Labs.

    Args:
        cls (PerplexityLabs): Ссылка на класс `PerplexityLabs`.
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий результаты взаимодействия с API.

    Raises:
        ResponseError: Если возникает ошибка при обработке ответа от API.
        RuntimeError: Если возникает неизвестная ошибка.

    Как работает функция:
    - Формирует заголовки запроса, включая Origin и Referer.
    - Устанавливает асинхронное соединение с использованием `StreamSession`.
    - Выполняет серию запросов для установления соединения WebSocket.
    - Отправляет данные сообщений через WebSocket и получает ответы.
    - Преобразует полученные данные в формат, пригодный для использования, и передает их через генератор.
    - Обрабатывает ошибки и исключения, возникающие в процессе обмена сообщениями.
    - Извлекает цитирования и устанавливает причину завершения (`FinishReason`) на основе полученных данных.
    - В случае необходимости отправляет keep-alive сообщения (`"3"`).
    """
```

## Параметры класса

- `url` (str): URL главной страницы Perplexity Labs.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (list): Список поддерживаемых моделей.

**Примеры**:

```python
# Пример использования create_async_generator
messages = [{"role": "user", "content": "Hello, Perplexity Labs!"}]
model = "r1-1776"

async def main():
    async for message in PerplexityLabs.create_async_generator(model=model, messages=messages):
        print(message)

# Запуск примера
# import asyncio
# asyncio.run(main())