# Модуль `Ails.py`

## Обзор

Модуль `Ails.py` предоставляет асинхронный генератор для взаимодействия с провайдером Ails (ai.ls) для получения ответов от модели GPT-3.5-turbo. Он включает в себя функции для создания асинхронного генератора запросов и обработки ответов, а также вспомогательные функции для форматирования временных меток и создания хешей. Модуль предназначен для использования в проектах, требующих асинхронного взаимодействия с AI сервисами через API.

## Подробнее

Модуль предназначен для асинхронного взаимодействия с API сервиса Ails для получения ответов от языковой модели GPT-3.5-turbo. Он использует библиотеку `aiohttp` для выполнения HTTP запросов и предоставляет функциональность для стриминга ответов. Важной особенностью модуля является поддержка истории сообщений и возможность работы через прокси.

## Классы

### `Ails`

**Описание**: Класс `Ails` является асинхронным генератором провайдера, который взаимодействует с сервисом ai.ls.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных генераторов провайдеров.

**Атрибуты**:
- `url` (str): URL сервиса ai.ls.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель GPT-3.5-turbo.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для запросов к API.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """ Функция создает асинхронный генератор для взаимодействия с API сервиса Ails.

        Args:
            model (str): Модель, используемая для генерации ответа.
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Флаг, указывающий, следует ли использовать потоковую передачу.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы, такие как температура.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий токены из ответа API.

        Raises:
            Exception: Если ответ содержит запрещенные токены, такие как "ai.ls" или "ai.ci".
        """
```

**Как работает функция**:

1.  **Формирование заголовков**: Функция создает заголовки для HTTP запроса, включая `authorization`, `client-id`, `client-v`, и другие необходимые параметры.
2.  **Создание асинхронной сессии**: Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP запросов.
3.  **Формирование данных запроса**: Создается JSON payload с информацией о модели, температуре, сообщениях и временных метках.
4.  **Отправка запроса**: Отправляется POST запрос к API сервиса Ails.
5.  **Обработка потока ответов**: Читает ответ построчно, извлекает токены из JSON, и генерирует их.
6.  **Проверка на ошибки**: Проверяет наличие запрещенных токенов в ответе и вызывает исключение, если они найдены.

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict, AsyncGenerator, Any

async def main():
    model: str = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Привет!"}]
    stream: bool = True
    proxy: str | None = None

    async def result_handler(result: AsyncGenerator[str, Any]):
        async for token in result:
            print(token, end="")

    result: AsyncGenerator[str, Any] = await Ails.create_async_generator(model, messages, stream, proxy)
    await result_handler(result)

if __name__ == "__main__":
    asyncio.run(main())
```

## Функции

### `_hash`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """ Функция создает SHA256 хеш из переданных данных.

    Args:
        json_data (dict[str, str]): Словарь с данными для хеширования.

    Returns:
        SHA256: SHA256 хеш в виде строки.
    """
```

**Как работает функция**:

1.  **Формирование строки**: Функция формирует строку, объединяя временную метку и сообщение с фиксированным ключом и длиной сообщения.
2.  **Хеширование**: Использует `hashlib.sha256` для создания хеша SHA256 от сформированной строки.

**Примеры**:

```python
# Пример использования функции _hash
json_data: dict[str, str] = {"t": "1678886400000", "m": "Hello"}
hashed_value: SHA256 = _hash(json_data)
print(hashed_value)
```

### `_format_timestamp`

```python
def _format_timestamp(timestamp: int) -> str:
    """ Функция форматирует временную метку.

    Args:
        timestamp (int): Временная метка в формате Unix timestamp.

    Returns:
        str: Отформатированная временная метка в виде строки.
    """
```

**Как работает функция**:

1.  **Преобразование временной метки**: Функция изменяет временную метку, добавляя или вычитая единицу в зависимости от четности последней цифры временной метки.

**Примеры**:

```python
# Пример использования функции _format_timestamp
timestamp: int = 1678886405000
formatted_timestamp: str = _format_timestamp(timestamp)
print(formatted_timestamp)