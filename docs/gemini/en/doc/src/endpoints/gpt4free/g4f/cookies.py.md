# Модуль для работы с куки (Cookies)

## Обзор

Этот модуль предназначен для управления куки, используемыми в проекте `hypotez`. Он позволяет загружать куки из различных браузеров, сохранять их, а также читать из файлов в формате HAR и JSON. Модуль обеспечивает гибкость в работе с куки для различных доменов и поддерживает кэширование результатов для повышения производительности.

## Подробнее

Модуль предоставляет функциональность для загрузки куки из различных браузеров, таких как Chrome, Firefox, Opera и других, используя библиотеку `browser_cookie3`. Также поддерживается чтение куки из файлов HAR и JSON, что позволяет использовать сохраненные куки для различных целей. Модуль включает в себя классы и функции для управления куки, такие как `CookiesConfig`, `get_cookies`, `set_cookies` и другие.

## Классы

### `CookiesConfig`

**Описание**: Класс для конфигурации куки.

**Атрибуты**:
- `cookies` (Dict[str, Cookies]): Словарь, содержащий куки для различных доменов.
- `cookies_dir` (str): Путь к директории, где хранятся файлы с куки.

### **Принцип работы**:
Класс `CookiesConfig` предназначен для хранения глобальной конфигурации, связанной с куки. Он содержит словарь `cookies`, где ключами являются домены, а значениями - куки для этих доменов. Также класс содержит путь к директории, где хранятся файлы с куки.

## Функции

### `g4f`

```python
def g4f(domain_name: str) -> list:
    """
    Загружает куки из браузера 'g4f' (если он существует).

    Args:
        domain_name (str): Домен, для которого нужно загрузить куки.

    Returns:
        list: Список куки.
    """
```

**Назначение**: Функция загружает куки из браузера с именем 'g4f', если он установлен и доступен в системе.

**Параметры**:
- `domain_name` (str): Домен, для которого необходимо получить куки.

**Возвращает**:
- `list`: Список куки, если они найдены, или пустой список, если браузер 'g4f' не установлен или куки не найдены.

### `get_cookies`

```python
def get_cookies(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False, cache_result: bool = True) -> Dict[str, str]:
    """
    Загружает куки для заданного домена из всех поддерживаемых браузеров и кэширует результаты.

    Args:
        domain_name (str): Домен, для которого нужно загрузить куки.
        raise_requirements_error (bool): Если `True`, вызывает исключение `MissingRequirementsError`, если не установлена библиотека `browser_cookie3`. По умолчанию `True`.
        single_browser (bool): Если `True`, загружает куки только из первого найденного браузера. По умолчанию `False`.
        cache_result (bool): Если `True`, кэширует результаты загрузки куки. По умолчанию `True`.

    Returns:
        Dict[str, str]: Словарь куки, где ключи - имена куки, а значения - их значения.
    """
```

**Назначение**: Функция загружает куки для указанного домена из всех поддерживаемых браузеров и кэширует результаты для повышения производительности.

**Параметры**:
- `domain_name` (str): Домен, для которого нужно получить куки.
- `raise_requirements_error` (bool): Флаг, указывающий, нужно ли вызывать исключение, если не установлены необходимые библиотеки.
- `single_browser` (bool): Флаг, указывающий, нужно ли загружать куки только из одного браузера.
- `cache_result` (bool): Флаг, указывающий, нужно ли кэшировать результаты.

**Возвращает**:
- `Dict[str, str]`: Словарь куки, где ключами являются имена куки, а значениями - их значения.

**Как функция работает**:
1. Проверяет, есть ли куки для данного домена в кэше (`CookiesConfig.cookies`). Если есть и `cache_result` равен `True`, возвращает кэшированные куки.
2. Если куки в кэше отсутствуют или `cache_result` равен `False`, вызывает функцию `load_cookies_from_browsers` для загрузки куки из браузеров.
3. Если `cache_result` равен `True`, сохраняет загруженные куки в кэш (`CookiesConfig.cookies`).
4. Возвращает загруженные куки.

### `set_cookies`

```python
def set_cookies(domain_name: str, cookies: Cookies = None) -> None:
    """
    Устанавливает куки для заданного домена.

    Args:
        domain_name (str): Домен, для которого нужно установить куки.
        cookies (Cookies, optional): Словарь куки, где ключи - имена куки, а значения - их значения. Если `None`, куки для домена удаляются. По умолчанию `None`.
    """
```

**Назначение**: Функция устанавливает куки для указанного домена или удаляет их, если передан `None` в качестве куки.

**Параметры**:
- `domain_name` (str): Домен, для которого нужно установить куки.
- `cookies` (Cookies, optional): Словарь куки, где ключами являются имена куки, а значениями - их значения. Если `None`, куки для домена удаляются. По умолчанию `None`.

**Как функция работает**:
1. Проверяет, переданы ли куки.
2. Если куки переданы, устанавливает их в `CookiesConfig.cookies` для указанного домена.
3. Если куки не переданы (равны `None`), удаляет куки для указанного домена из `CookiesConfig.cookies`, если они там есть.

### `load_cookies_from_browsers`

```python
def load_cookies_from_browsers(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False) -> Cookies:
    """
    Вспомогательная функция для загрузки куки из различных браузеров.

    Args:
        domain_name (str): Домен, для которого нужно загрузить куки.
        raise_requirements_error (bool): Если `True`, вызывает исключение `MissingRequirementsError`, если не установлена библиотека `browser_cookie3`. По умолчанию `True`.
        single_browser (bool): Если `True`, загружает куки только из первого найденного браузера. По умолчанию `False`.

    Returns:
        Dict[str, str]: Словарь куки, где ключи - имена куки, а значения - их значения.
    """
```

**Назначение**: Функция загружает куки из различных установленных браузеров, таких как Chrome, Firefox, Opera и другие.

**Параметры**:
- `domain_name` (str): Домен, для которого нужно получить куки.
- `raise_requirements_error` (bool): Флаг, указывающий, нужно ли вызывать исключение, если не установлены необходимые библиотеки.
- `single_browser` (bool): Флаг, указывающий, нужно ли загружать куки только из одного браузера.

**Возвращает**:
- `Dict[str, str]`: Словарь куки, где ключами являются имена куки, а значениями - их значения.

**Как функция работает**:
1. Проверяет, установлена ли библиотека `browser_cookie3`. Если нет и `raise_requirements_error` равен `True`, вызывает исключение `MissingRequirementsError`.
2. Итерируется по списку браузеров (`browsers`).
3. Для каждого браузера пытается загрузить куки, используя функцию, соответствующую браузеру (например, `chrome`, `firefox`).
4. Если загрузка куки прошла успешно, добавляет куки в общий словарь `cookies`, пропуская куки с истекшим сроком действия.
5. Если `single_browser` равен `True`, прекращает итерацию после загрузки куки из первого браузера.
6. Возвращает словарь `cookies`.

### `set_cookies_dir`

```python
def set_cookies_dir(dir: str) -> None:
    """
    Устанавливает директорию для хранения файлов с куки.

    Args:
        dir (str): Путь к директории.
    """
```

**Назначение**: Функция устанавливает директорию, которая будет использоваться для чтения файлов с куки.

**Параметры**:
- `dir` (str): Путь к директории.

**Как функция работает**:
1. Устанавливает значение `CookiesConfig.cookies_dir` равным переданному пути.

### `get_cookies_dir`

```python
def get_cookies_dir() -> str:
    """
    Возвращает директорию, используемую для хранения файлов с куки.

    Returns:
        str: Путь к директории.
    """
```

**Назначение**: Функция возвращает директорию, используемую для хранения файлов с куки.

**Возвращает**:
- `str`: Путь к директории.

**Как функция работает**:
1. Возвращает значение `CookiesConfig.cookies_dir`.

### `read_cookie_files`

```python
def read_cookie_files(dirPath: str = None):
    """
    Читает файлы с куки из указанной директории.

    Args:
        dirPath (str, optional): Путь к директории. Если `None`, используется `CookiesConfig.cookies_dir`. По умолчанию `None`.
    """
```

**Назначение**: Функция читает файлы куки из указанной директории и загружает их в `CookiesConfig.cookies`. Поддерживаются файлы в формате HAR и JSON.

**Параметры**:
- `dirPath` (str, optional): Путь к директории с файлами куки. Если не указан, используется значение из `CookiesConfig.cookies_dir`. По умолчанию `None`.

**Как функция работает**:
1. Определяет путь к директории, из которой нужно читать файлы куки. Если `dirPath` не указан, использует значение из `CookiesConfig.cookies_dir`.
2. Проверяет, доступна ли директория для чтения. Если нет, записывает сообщение об ошибке в лог и завершает работу.
3. Ищет в директории файлы с расширениями `.har` и `.json`.
4. Для каждого найденного файла `.har`:
   - Открывает файл и пытается загрузить его содержимое как JSON.
   - Если файл не является HAR-файлом (не удается распарсить JSON), переходит к следующему файлу.
   - Извлекает куки из записей HAR-файла и добавляет их в `CookiesConfig.cookies`.
5. Для каждого найденного файла `.json`:
   - Открывает файл и пытается загрузить его содержимое как JSON.
   - Если файл не является JSON-файлом или не содержит ожидаемую структуру (список словарей с ключом "domain"), переходит к следующему файлу.
   - Извлекает куки из JSON-файла и добавляет их в `CookiesConfig.cookies`.

### Внутренняя функция `get_domain`

```python
def get_domain(v: dict) -> str:
        host = [h["value"] for h in v[\'request\'][\'headers\'] if h["name"].lower() in ("host", ":authority")]
        if not host:
            return
        host = host.pop()
        for d in DOMAINS:
            if d in host:
                return d
```

**Назначение**: Функция извлекает домен из записи HAR-файла.

**Параметры**:
- `v` (dict): Запись из HAR-файла.

**Возвращает**:
- `str`: Домен, найденный в записи HAR-файла.

**Как функция работает**:
1. Извлекает значение заголовка "host" или ":authority" из записи HAR-файла.
2. Если заголовок не найден, возвращает `None`.
3. Извлекает домен из значения заголовка, проверяя наличие одного из доменов из списка `DOMAINS`.
4. Возвращает найденный домен.

## Примеры

### Использование `get_cookies`

```python
from src.endpoints.gpt4free.g4f import cookies

domain_name = ".google.com"
cookies = cookies.get_cookies(domain_name)
if cookies:
    print(f"Куки для домена {domain_name}: {cookies}")
else:
    print(f"Куки для домена {domain_name} не найдены.")
```

### Использование `set_cookies`

```python
from src.endpoints.gpt4free.g4f import cookies

domain_name = ".example.com"
new_cookies = {"cookie1": "value1", "cookie2": "value2"}
cookies.set_cookies(domain_name, new_cookies)
print(f"Куки для домена {domain_name} установлены.")
```

### Использование `read_cookie_files`

```python
from src.endpoints.gpt4free.g4f import cookies

cookies_dir = "./har_and_cookies"
cookies.read_cookie_files(cookies_dir)
print(f"Куки прочитаны из файлов в директории {cookies_dir}.")
```