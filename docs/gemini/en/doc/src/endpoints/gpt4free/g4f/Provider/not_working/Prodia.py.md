# Модуль `Prodia`

## Обзор

Модуль `Prodia` предоставляет асинхронный генератор изображений с использованием API [Prodia](https://app.prodia.com). Он позволяет генерировать изображения на основе текстовых запросов, используя различные модели и параметры. Модуль включает в себя выбор модели, настройку параметров генерации и асинхронный опрос статуса задачи для получения готового изображения.

## Подробнее

Этот модуль используется для интеграции с сервисом генерации изображений Prodia. Он предоставляет функциональность для асинхронной генерации изображений на основе предоставленных текстовых запросов и параметров.  Он позволяет выбирать модель, указывать негативные запросы, настраивать количество шагов, коэффициент конфигурации (CFG), начальное зерно (seed), метод выборки (sampler) и соотношение сторон изображения (aspect ratio). Модуль асинхронно опрашивает API Prodia для получения статуса задачи и возвращает URL готового изображения.

## Классы

### `Prodia`

**Описание**:
Класс `Prodia` является асинхронным провайдером генерации изображений, который взаимодействует с API Prodia для создания изображений на основе текстовых запросов.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса Prodia.
- `api_endpoint` (str): URL API для генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `image_models` (List[str]): Список доступных моделей изображений.
- `models` (List[str]): Список всех доступных моделей.

**Принцип работы**:
Класс использует асинхронные запросы к API Prodia для генерации изображений. Он предоставляет методы для выбора модели, создания запроса и опроса статуса задачи до получения готового изображения.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе предоставленного алиаса или имени, или модель по умолчанию, если модель не найдена.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, negative_prompt: str = "", steps: str = 20, cfg: str = 7, seed: Optional[int] = None, sampler: str = "DPM++ 2M Karras", aspect_ratio: str = "square", **kwargs) -> AsyncResult`: Создает асинхронный генератор для генерации изображений на основе предоставленных параметров.
- `_poll_job(cls, session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str`: Опрашивает API Prodia для получения статуса задачи генерации изображения.

## Методы класса

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """
    Функция выбирает подходящую модель из списка доступных или использует модель по умолчанию.

    Args:
        model (str): Название модели, которую необходимо получить.

    Returns:
        str: Строка с именем модели.
    """
```

**Назначение**:
Метод `get_model` определяет, какая модель должна использоваться для генерации изображений. Если запрошенная модель есть в списке доступных моделей, она и будет использована. В противном случае будет использована модель по умолчанию.

**Параметры**:
- `model` (str): Название запрошенной модели.

**Возвращает**:
- `str`: Строка с именем модели, которую следует использовать.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    negative_prompt: str = "",
    steps: str = 20,  # 1-25
    cfg: str = 7,  # 0-20
    seed: Optional[int] = None,
    sampler: str = "DPM++ 2M Karras",
    aspect_ratio: str = "square",  # "square", "portrait", "landscape"
    **kwargs,
) -> AsyncResult:
    """
    Функция создает асинхронный генератор для создания изображений на основе текстового запроса.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений, содержащих текстовый запрос.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        negative_prompt (str, optional): Негативный запрос, описывающий, чего не должно быть на изображении. По умолчанию "".
        steps (str, optional): Количество шагов для генерации изображения. Должно быть в диапазоне 1-25. По умолчанию "20".
        cfg (str, optional): Коэффициент конфигурации. Должен быть в диапазоне 0-20. По умолчанию "7".
        seed (Optional[int], optional): Зерно для генерации случайных чисел. По умолчанию `None`.
        sampler (str, optional): Метод выборки. По умолчанию "DPM++ 2M Karras".
        aspect_ratio (str, optional): Соотношение сторон изображения. Должно быть "square", "portrait" или "landscape". По умолчанию "square".
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий `ImageResponse` с URL изображения.
    """
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор, который отправляет запрос к API Prodia для генерации изображения на основе заданных параметров.

**Параметры**:
- `model` (str): Название модели для генерации.
- `messages` (Messages): Список сообщений, содержащий текстовый запрос для генерации изображения.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `negative_prompt` (str, optional): Негативный запрос, описывающий, чего не должно быть на изображении. По умолчанию пустая строка.
- `steps` (str, optional): Количество шагов для генерации изображения. По умолчанию "20".
- `cfg` (str, optional): Коэффициент конфигурации. По умолчанию "7".
- `seed` (Optional[int], optional): Зерно для генерации случайных чисел. Если не указано, генерируется случайное число. По умолчанию `None`.
- `sampler` (str, optional): Метод выборки. По умолчанию "DPM++ 2M Karras".
- `aspect_ratio` (str, optional): Соотношение сторон изображения. По умолчанию "square".
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий объект `ImageResponse` с URL сгенерированного изображения.

### `_poll_job`

```python
@classmethod
async def _poll_job(
    cls,
    session: ClientSession,
    job_id: str,
    proxy: str,
    max_attempts: int = 30,
    delay: int = 2,
) -> str:
    """
    Функция асинхронно опрашивает API Prodia для получения статуса задачи генерации изображения.

    Args:
        session (ClientSession): Асинхронная HTTP-сессия.
        job_id (str): Идентификатор задачи.
        proxy (str): Прокси-сервер для использования.
        max_attempts (int, optional): Максимальное количество попыток опроса. По умолчанию 30.
        delay (int, optional): Задержка между попытками опроса в секундах. По умолчанию 2.

    Returns:
        str: URL сгенерированного изображения.

    Raises:
        Exception: Если генерация изображения не удалась или истекло время ожидания.
    """
```

**Назначение**:
Метод `_poll_job` асинхронно опрашивает API Prodia, чтобы узнать статус выполнения задачи генерации изображения.

**Параметры**:
- `session` (ClientSession): Асинхронная HTTP-сессия для выполнения запросов.
- `job_id` (str): Идентификатор задачи генерации изображения.
- `proxy` (str): URL прокси-сервера для использования.
- `max_attempts` (int, optional): Максимальное количество попыток опроса API. По умолчанию 30.
- `delay` (int, optional): Задержка в секундах между попытками опроса. По умолчанию 2.

**Возвращает**:
- `str`: URL сгенерированного изображения, если задача успешно выполнена.

**Вызывает исключения**:
- `Exception`: Если задача завершилась неудачей или истекло время ожидания.

## Переменные класса

- `url` (str): URL сервиса Prodia.
- `api_endpoint` (str): URL API для генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `image_models` (List[str]): Список доступных моделей изображений.
- `models` (List[str]): Список всех доступных моделей.

## Примеры

Пример использования класса `Prodia` для генерации изображения:

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.not_working.Prodia import Prodia
from src.typing import Messages

async def main():
    messages: Messages = [{"role": "user", "content": "A beautiful landscape"}]
    model = Prodia.default_model
    async for image_response in Prodia.create_async_generator(model=model, messages=messages):
        if image_response:
            print(f"Image URL: {image_response.url}")
            break

if __name__ == "__main__":
    asyncio.run(main())