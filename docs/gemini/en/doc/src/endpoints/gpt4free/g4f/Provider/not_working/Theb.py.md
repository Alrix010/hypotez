# Модуль `Theb.py`

## Обзор

Модуль `Theb.py` предоставляет реализацию провайдера `TheB.AI` для проекта `hypotez`. Он позволяет взаимодействовать с различными моделями `TheB.AI`, такими как `GPT-3.5 Turbo`, `GPT-4`, `Claude 2` и другими, используя веб-драйвер для обхода защиты от автоматизированного доступа. Модуль поддерживает потоковую передачу ответов и использует `selenium` для взаимодействия с веб-интерфейсом `TheB.AI`.

## Более детально

Этот модуль предназначен для интеграции с платформой `TheB.AI`, предоставляя удобный интерфейс для отправки запросов к различным моделям и получения ответов в потоковом режиме. Он использует веб-драйвер для автоматизации взаимодействия с веб-сайтом `TheB.AI`, что позволяет обходить ограничения, накладываемые на автоматизированный доступ. Модуль также содержит вспомогательные функции для форматирования запросов и обработки ответов.

## Классы

### `Theb`

**Описание**: Класс `Theb` является провайдером для взаимодействия с `TheB.AI`. Он наследуется от `AbstractProvider` и реализует метод `create_completion` для отправки запросов к моделям `TheB.AI` и получения ответов.

**Наследует**:
- `AbstractProvider`: Абстрактный базовый класс для всех провайдеров.

**Атрибуты**:
- `label` (str): Метка провайдера, `"TheB.AI"`.
- `url` (str): URL веб-сайта `TheB.AI`, `"https://beta.theb.ai"`.
- `working` (bool): Указывает, работает ли провайдер в данный момент, `False`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу ответов, `True`.
- `models` (dict): Словарь доступных моделей и их отображаемые имена.

**Принцип работы**:
Класс `Theb` использует веб-драйвер `selenium` для автоматизации взаимодействия с веб-сайтом `TheB.AI`. Он открывает веб-сайт, выбирает указанную модель (если она указана) и отправляет запрос. Ответ получается в потоковом режиме с использованием JavaScript и `selenium`.

**Методы**:
- `create_completion`: Метод для создания запроса к модели и получения ответа.

## Методы класса

### `create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        webdriver: WebDriver = None,
        virtual_display: bool = True,
        **kwargs
    ) -> CreateResult:
        """ Функция отправляет запрос к модели TheB.AI и возвращает результат.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Указывает, следует ли возвращать ответ в потоковом режиме.
            proxy (str, optional): Прокси-сервер для использования. Defaults to None.
            webdriver (WebDriver, optional): Экземпляр веб-драйвера для использования. Defaults to None.
            virtual_display (bool, optional): Использовать ли виртуальный дисплей. Defaults to True.
            **kwargs: Дополнительные аргументы.

        Returns:
            CreateResult: Результат выполнения запроса.

        Пример:
            Примеры вызовов с полным набором параметров, которые могут быть переданы в функцию.
        """
```

### Как работает функция:

1. **Преобразование имени модели**: Если `model` находится в словаре `models`, то происходит замена имени модели на соответствующее значение для `TheB.AI`.
2. **Форматирование промпта**: Используется функция `format_prompt` для преобразования списка сообщений в строку промпта.
3. **Создание сессии веб-драйвера**: Создается экземпляр класса `WebDriverSession` для управления веб-драйвером.
4. **Запуск веб-драйвера**: Внутри контекстного менеджера `web_session` запускается или используется существующий веб-драйвер.
5. **Внедрение JavaScript**: Внедряется JavaScript-код для перехвата запросов к API `/api/conversation` и получения потоковых ответов.
6. **Открытие веб-сайта**: Открывается главная страница `TheB.AI` (`f"{cls.url}/home"`).
7. **Ожидание загрузки**: Ожидается, пока не станет видимым элемент с `ID "textareaAutosize"`.
8. **Обработка оверлея**: Предпринимаются попытки кликнуть на элементы с классом `driver-overlay`, чтобы закрыть всплывающие окна.
9. **Выбор модели (если указана)**: Если указана модель, выполняется выбор модели на веб-сайте.
   - Кликается на элемент `#SelectModel svg`, чтобы открыть панель выбора моделей.
   - Выбирается нужная модель из списка и нажимается кнопка подтверждения.
10. **Отправка промпта**: В поле `textareaAutosize` вводится отформатированный промпт.
11. **Чтение ответа**: Используется JavaScript-код для чтения потоковых данных из `window._reader` и извлечения полезной информации из JSON-ответов.
12. **Генерация результата**: Функция возвращает генератор, который выдает чанки данных по мере их поступления.

## Примеры

```python
# Пример вызова create_completion
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, world!"}]
stream = True

# response_generator = Theb.create_completion(model=model, messages=messages, stream=stream)
# for chunk in response_generator:
#     print(chunk)