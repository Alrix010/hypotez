# Модуль `Myshell.py`

## Обзор

Модуль предоставляет асинхронтный класс `Myshell`, который позволяет взаимодействовать с API Myshell для генерации текста. Он использует веб-сокеты для обмена сообщениями в реальном времени и поддерживает модели, такие как "samantha", "gpt-3.5-turbo" и "gpt-4".

## Подробнее

Этот модуль реализует асинхронный генератор, который отправляет запросы к API Myshell и возвращает сгенерированный текст по частям. Он включает в себя функции для создания уникальных идентификаторов посетителей и подписей запросов, что необходимо для аутентификации и обеспечения безопасности соединения. Модуль обрабатывает различные типы сообщений, включая текстовые потоки и сообщения об ошибках, а также автоматически отвечает на ping-сообщения для поддержания соединения.

## Классы

### `Myshell`

**Описание**: Асинхронный класс, предоставляющий функциональность для взаимодействия с API Myshell.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров генерации текста.

**Атрибуты**:
- `url` (str): URL для подключения к API Myshell (`"https://app.myshell.ai/chat"`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели "gpt-3.5-turbo" (по умолчанию `True`).
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку модели "gpt-4" (по умолчанию `True`).

**Методы**:
- `create_async_generator(model: str, messages: Messages, proxy: str = None, timeout: int = 90, **kwargs) -> AsyncResult`: Асинхронный генератор для создания потока текста от API Myshell.

## Методы класса

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 90,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения текстовых ответов от API Myshell.

    Args:
        model (str): Идентификатор модели для использования (например, "samantha", "gpt-3.5-turbo", "gpt-4").
        messages (Messages): Список сообщений для отправки в запросе.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от сервера в секундах. По умолчанию `90`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текстовые фрагменты.

    Raises:
        ValueError: Если указанная модель не поддерживается.
        RuntimeError: Если получено неожиданное сообщение от сервера.
    """
```

**Как работает функция**:
1. **Выбор модели**:
   - Проверяет, указана ли модель. Если нет, использует модель "samantha" по умолчанию.
   - Если модель указана, проверяет, поддерживается ли она (есть ли в словаре `models`). Если нет, выбрасывает исключение `ValueError`.
2. **Создание идентификатора посетителя**:
   - Генерирует уникальный идентификатор посетителя (`visitor_id`) с использованием функции `generate_visitor_id`.
3. **Установка соединения**:
   - Создает асинхронную сессию с помощью `aiohttp.ClientSession` с указанием заголовка `User-Agent`.
   - Подключается к WebSocket API Myshell.
4. **Обмен сообщениями**:
   - Отправляет и получает приветственное сообщение для установки соединения.
   - Отправляет сообщение с данными чата, включая текст запроса, идентификатор бота и подпись.
5. **Получение и обработка ответов**:
   - Получает сообщения из WebSocket в асинхронном цикле.
   - Обрабатывает ping-сообщения, отправляя ответные сообщения.
   - Извлекает текстовые фрагменты из сообщений `text_stream` и возвращает их через генератор.
   - При получении сообщений `message_replied` или `need_verify_captcha` выбрасывает исключение `RuntimeError`.

**Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for message in Myshell.create_async_generator(model=model, messages=messages):
    print(message)
```

## Функции

### `generate_timestamp`

```python
def generate_timestamp() -> str:
    """
    Генерирует временную метку для подписи запроса.

    Returns:
        str: Сгенерированная временная метка.
    """
```

### `generate_signature`

```python
def generate_signature(text: str):
    """
    Генерирует подпись для запроса на основе текста, временной метки и секретного ключа.

    Args:
        text (str): Текст запроса.

    Returns:
        dict: Словарь, содержащий подпись, временную метку и версию.
    """
```

### `xor_hash`

```python
def xor_hash(B: str):
    """
    Вычисляет XOR-хеш строки.

    Args:
        B (str): Входная строка.

    Returns:
        str: XOR-хеш строки в шестнадцатеричном формате.
    """
```

### `performance`

```python
def performance() -> str:
    """
    Измеряет производительность для генерации уникального идентификатора.

    Returns:
        str: Шестнадцатеричное представление времени и количества итераций.
    """
```

### `generate_visitor_id`

```python
def generate_visitor_id(user_agent: str) -> str:
    """
    Генерирует уникальный идентификатор посетителя на основе User-Agent.

    Args:
        user_agent (str): User-Agent браузера.

    Returns:
        str: Сгенерированный идентификатор посетителя.
    """
```