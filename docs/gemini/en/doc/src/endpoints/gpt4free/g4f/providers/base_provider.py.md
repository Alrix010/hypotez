# Документация для `base_provider.py`

## Обзор

Файл `base_provider.py` содержит абстрактные классы и миксины, которые служат основой для реализации различных провайдеров в проекте `hypotez`. Он определяет интерфейсы для создания завершений, асинхронной обработки и работы с параметрами моделей.

## Подробнее

В этом файле определены базовые классы и утилиты, необходимые для интеграции различных поставщиков API, таких как OpenAI и Google Gemini, в систему `hypotez`. Он включает в себя абстрактные классы для синхронного и асинхронного взаимодействия, а также вспомогательные функции для обработки параметров и ошибок.

## Содержание

1.  [Константы](#константы)
2.  [Классы](#классы)
    *   [AbstractProvider](#abstractprovider)
    *   [AsyncProvider](#asyncprovider)
    *   [AsyncGeneratorProvider](#asyncgeneratorprovider)
    *   [ProviderModelMixin](#providermodelmixin)
    *   [RaiseErrorMixin](#raiseerrormixin)
    *   [AuthFileMixin](#authfilemixin)
    *   [AsyncAuthedProvider](#asyncauthedprovider)

## Константы

### `SAFE_PARAMETERS`

Список безопасных параметров, которые можно использовать при создании запросов к API.

### `BASIC_PARAMETERS`

Словарь, содержащий базовые параметры для запросов к API, такие как провайдер, модель, сообщения и т. д.

### `PARAMETER_EXAMPLES`

Словарь с примерами значений параметров, используемых при создании запросов к API.

## Классы

### `AbstractProvider`

Абстрактный класс, определяющий интерфейс для провайдеров.

**Описание**:
Этот класс служит базовым классом для всех провайдеров и определяет основные методы, которые должны быть реализованы в производных классах.

**Методы**:

*   `create_completion(model: str, messages: Messages, stream: bool, **kwargs) -> CreateResult`
    *   **Назначение**: Создает завершение с заданными параметрами.
    *   **Параметры**:
        *   `model` (str): Модель для использования.
        *   `messages` (Messages): Сообщения для обработки.
        *   `stream` (bool): Использовать ли потоковую передачу.
        *   `kwargs: dict[str, Any]`: Дополнительные параметры.
    *   **Возвращает**:
        *   `CreateResult`: Результат процесса создания.
    *   **Вызывает**:
        *   `NotImplementedError`: Если метод не реализован в производном классе.
*   `create_async(model: str, messages: Messages, *, timeout: int = None, loop: AbstractEventLoop = None, executor: ThreadPoolExecutor = None, **kwargs) -> str`
    *   **Назначение**: Асинхронно создает результат на основе заданной модели и сообщений.
    *   **Параметры**:
        *   `model` (str): Модель для использования при создании.
        *   `messages` (Messages): Сообщения для обработки.
        *   `timeout` (int, optional): Время ожидания для асинхронной операции. По умолчанию `None`.
        *   `loop` (AbstractEventLoop, optional): Используемый event loop. По умолчанию `None`.
        *   `executor` (ThreadPoolExecutor, optional): Executor для выполнения асинхронных задач. По умолчанию `None`.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `str`: Созданный результат в виде строки.

    **Внутренние функции**:

    *   `create_func() -> str`:
        *   **Назначение**: Функция создает результат завершения и объединяет его в строку.
        *   **Возвращает**:
            *   `str`: Объединенная строка результата завершения.
        *   **Принцип работы**:
            *   Вызывает `cls.create_completion` с переданными параметрами, получает результат и объединяет его в строку с помощью `concat_chunks`.

    **Пример**:

    ```python
    result = await AbstractProvider.create_async(model="test_model", messages=[{"role": "user", "content": "test message"}])
    ```

*   `get_create_function() -> callable`
    *   **Назначение**: Возвращает функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Функция для создания завершений.
*   `get_async_create_function() -> callable`
    *   **Назначение**: Возвращает асинхронную функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Асинхронная функция для создания завершений.
*   `get_parameters(as_json: bool = False) -> dict[str, Parameter]`
    *   **Назначение**: Возвращает параметры, поддерживаемые провайдером.
    *   **Параметры**:
        *   `as_json` (bool, optional): Вернуть ли параметры в формате JSON. По умолчанию `False`.
    *   **Возвращает**:
        *   `dict[str, Parameter]`: Словарь параметров.

    **Внутренние функции**:

    *   `get_type_as_var(annotation: type, key: str, default)`:
        *   **Назначение**: Определяет тип переменной на основе аннотации и возвращает соответствующее значение.
        *   **Параметры**:
            *   `annotation` (type): Аннотация типа переменной.
            *   `key` (str): Ключ параметра.
            *   `default`: Значение по умолчанию.
        *   **Возвращает**:
            *   Различные типы данных в зависимости от аннотации.
        *   **Принцип работы**:
            *   В зависимости от типа аннотации возвращает пример значения для параметра.
            Например, для `int` возвращает `0`, для `str` возвращает `""`.
*   `params: str`
    *   **Назначение**: Возвращает параметры, поддерживаемые провайдером, в виде строки.

### `AsyncProvider`

Класс, предоставляющий асинхронную функциональность для создания завершений.

**Описание**:
Этот класс расширяет `AbstractProvider` и предоставляет методы для асинхронного создания завершений.

**Методы**:

*   `create_completion(model: str, messages: Messages, stream: bool = False, **kwargs) -> CreateResult`
    *   **Назначение**: Создает результат завершения синхронно.
    *   **Параметры**:
        *   `model` (str): Модель для использования при создании.
        *   `messages` (Messages): Сообщения для обработки.
        *   `stream` (bool): Указывает, следует ли передавать результаты потоком. По умолчанию `False`.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `CreateResult`: Результат создания завершения.

    **Пример**:

    ```python
    result = AsyncProvider.create_completion(model="test_model", messages=[{"role": "user", "content": "test message"}])
    ```

*   `create_async(model: str, messages: Messages, **kwargs) -> str`
    *   **Назначение**: Абстрактный метод для создания асинхронных результатов.
    *   **Параметры**:
        *   `model` (str): Модель для использования при создании.
        *   `messages` (Messages): Сообщения для обработки.
        *   `**kwargs`: Дополнительные параметры.
    *   **Вызывает**:
        *   `NotImplementedError`: Если этот метод не переопределен в производных классах.
    *   **Возвращает**:
        *   `str`: Созданный результат в виде строки.
*   `get_create_function() -> callable`
    *   **Назначение**: Возвращает функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Функция для создания завершений.
*   `get_async_create_function() -> callable`
    *   **Назначение**: Возвращает асинхронную функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Асинхронная функция для создания завершений.

### `AsyncGeneratorProvider`

Класс, предоставляющий функциональность асинхронного генератора для потоковой передачи результатов.

**Описание**:
Этот класс расширяет `AbstractProvider` и предоставляет методы для создания потоковых завершений с использованием асинхронных генераторов.

**Методы**:

*   `create_completion(model: str, messages: Messages, stream: bool = True, **kwargs) -> CreateResult`
    *   **Назначение**: Создает результат потоковой передачи завершения синхронно.
    *   **Параметры**:
        *   `model` (str): Модель для использования при создании.
        *   `messages` (Messages): Сообщения для обработки.
        *   `stream` (bool): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `CreateResult`: Результат создания потоковой передачи завершения.

    **Пример**:

    ```python
    result = AsyncGeneratorProvider.create_completion(model="test_model", messages=[{"role": "user", "content": "test message"}])
    ```

*   `create_async_generator(model: str, messages: Messages, stream: bool = True, **kwargs) -> AsyncResult`
    *   **Назначение**: Абстрактный метод для создания асинхронного генератора.
    *   **Параметры**:
        *   `model` (str): Модель для использования при создании.
        *   `messages` (Messages): Сообщения для обработки.
        *   `stream` (bool): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        *   `**kwargs`: Дополнительные параметры.
    *   **Вызывает**:
        *   `NotImplementedError`: Если этот метод не переопределен в производных классах.
    *   **Возвращает**:
        *   `AsyncResult`: Асинхронный генератор, выдающий результаты.
*   `get_create_function() -> callable`
    *   **Назначение**: Возвращает функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Функция для создания завершений.
*   `get_async_create_function() -> callable`
    *   **Назначение**: Возвращает асинхронную функцию для создания генератора завершений.
    *   **Возвращает**:
        *   `callable`: Асинхронная функция для создания генератора завершений.

### `ProviderModelMixin`

Миксин для добавления информации о моделях, поддерживаемых провайдером.

**Описание**:
Этот миксин предоставляет атрибуты и методы для управления информацией о моделях, таких как модель по умолчанию, список поддерживаемых моделей и псевдонимы моделей.

**Атрибуты**:

*   `default_model` (str): Модель, используемая по умолчанию.
*   `models` (list[str]): Список поддерживаемых моделей.
*   `model_aliases` (dict[str, str]): Словарь псевдонимов моделей.
*    `image_models` (list): Список моделей для изображений.
*    `vision_models` (list): Список моделей для работы с видео.
*   `last_model` (str): Последняя использованная модель.

**Методы**:

*   `get_models(**kwargs) -> list[str]`
    *   **Назначение**: Возвращает список поддерживаемых моделей.
    *   **Параметры**:
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `list[str]`: Список поддерживаемых моделей.

    **Пример**:

    ```python
    models = ProviderModelMixin.get_models()
    ```

*   `get_model(model: str, **kwargs) -> str`
    *   **Назначение**: Возвращает модель на основе заданного имени или псевдонима.
    *   **Параметры**:
        *   `model` (str): Имя модели или псевдоним.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `str`: Имя модели.
    *   **Вызывает**:
        *   `ModelNotSupportedError`: Если модель не поддерживается.

### `RaiseErrorMixin`

Миксин для обработки ошибок, возвращаемых провайдером.

**Описание**:
Этот миксин предоставляет метод для обработки ошибок, возвращаемых API провайдера.

**Методы**:

*   `raise_error(data: dict, status: int = None)`
    *   **Назначение**: Вызывает исключение на основе данных об ошибке.
    *   **Параметры**:
        *   `data` (dict): Данные об ошибке.
        *   `status` (int, optional): HTTP-статус ответа. По умолчанию `None`.
    *   **Вызывает**:
        *   `ResponseError`: Если в данных есть сообщение об ошибке.
        *   `MissingAuthError`: Если статус 401 (отсутствует аутентификация).
        *   `PaymentRequiredError`: Если статус 402 (требуется оплата).

    **Пример**:

    ```python
    RaiseErrorMixin.raise_error({"error_message": "Test error"})
    ```

### `AuthFileMixin`

Миксин для работы с файлами аутентификации.

**Описание**:
Этот миксин предоставляет методы для получения пути к файлу кэша аутентификации.

**Методы**:

*   `get_cache_file() -> Path`
    *   **Назначение**: Возвращает путь к файлу кэша.
    *   **Возвращает**:
        *   `Path`: Путь к файлу кэша.

    **Пример**:

    ```python
    cache_file = AuthFileMixin.get_cache_file()
    ```

### `AsyncAuthedProvider`

Класс, предоставляющий асинхронную аутентификацию для провайдеров.

**Описание**:
Этот класс расширяет `AsyncGeneratorProvider` и `AuthFileMixin` и предоставляет методы для асинхронной аутентификации и кэширования результатов аутентификации.

**Методы**:

*   `on_auth_async(**kwargs) -> AuthResult`
    *   **Назначение**: Асинхронно выполняет аутентификацию.
    *   **Параметры**:
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `AuthResult`: Результат аутентификации.
    *   **Вызывает**:
        *   `MissingAuthError`: Если отсутствует API-ключ.

    **Пример**:

    ```python
    auth_result = await AsyncAuthedProvider.on_auth_async(api_key="test_key")
    ```

*   `on_auth(**kwargs) -> AuthResult`
    *   **Назначение**: Выполняет аутентификацию синхронно.
    *   **Параметры**:
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `AuthResult`: Результат аутентификации.
*   `get_create_function() -> callable`
    *   **Назначение**: Возвращает функцию для создания завершений.
    *   **Возвращает**:
        *   `callable`: Функция для создания завершений.
*   `get_async_create_function() -> callable`
    *   **Назначение**: Возвращает асинхронную функцию для создания генератора завершений.
    *   **Возвращает**:
        *   `callable`: Асинхронная функция для создания генератора завершений.
*   `write_cache_file(cache_file: Path, auth_result: AuthResult = None)`
    *   **Назначение**: Записывает результаты аутентификации в файл кэша.
    *   **Параметры**:
        *   `cache_file` (Path): Путь к файлу кэша.
        *   `auth_result` (AuthResult, optional): Результат аутентификации. По умолчанию `None`.

    **Пример**:

    ```python
    AsyncAuthedProvider.write_cache_file(cache_file, auth_result)
    ```

*   `create_completion(model: str, messages: Messages, **kwargs) -> CreateResult`
    *   **Назначение**: Создает завершение с использованием аутентификации.
    *   **Параметры**:
        *   `model` (str): Модель для использования.
        *   `messages` (Messages): Сообщения для обработки.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `CreateResult`: Результат создания процесса.

    **Принцип работы**:

    *   Пытается загрузить результаты аутентификации из файла кэша.
    *   Если файл отсутствует или аутентификация не удалась, выполняет аутентификацию и сохраняет результаты в файл кэша.
*   `create_async_generator(model: str, messages: Messages, **kwargs) -> AsyncResult`
    *   **Назначение**: Создает асинхронный генератор с использованием аутентификации.
    *   **Параметры**:
        *   `model` (str): Модель для использования.
        *   `messages` (Messages): Сообщения для обработки.
        *   `**kwargs`: Дополнительные параметры.
    *   **Возвращает**:
        *   `AsyncResult`: Асинхронный генератор, выдающий результаты.

    **Принцип работы**:

    *   Пытается загрузить результаты аутентификации из файла кэша.
    *   Если файл отсутствует или аутентификация не удалась, выполняет аутентификацию и сохраняет результаты в файл кэша.