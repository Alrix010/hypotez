# Модуль retry_provider.py

## Обзор

Модуль содержит классы для повторных попыток при использовании нескольких провайдеров для создания завершений.
Включает классы `IterListProvider` и `RetryProvider`, которые позволяют перебирать список провайдеров и повторять попытки
в случае сбоев.

## Более подробно

Этот модуль предназначен для повышения надежности процесса создания завершений за счет использования нескольких
провайдеров и повторных попыток в случае сбоев. Класс `IterListProvider` предоставляет базовую функциональность для
перебора списка провайдеров, а класс `RetryProvider` добавляет возможность повторных попыток для одного провайдера.

## Классы

### `IterListProvider`

**Описание**: Предоставляет функциональность для итерации по списку провайдеров и создания завершений с использованием доступных провайдеров.
**Наследуется от**: `BaseRetryProvider`

**Атрибуты**:
- `providers` (List[Type[BaseProvider]]): Список провайдеров для использования.
- `shuffle` (bool): Флаг, указывающий, нужно ли перемешивать список провайдеров.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `last_provider` (Type[BaseProvider]): Последний использованный провайдер.

**Методы**:
- `__init__`: Инициализирует класс `IterListProvider`.
- `create_completion`: Создает завершение с использованием доступных провайдеров.
- `create_async_generator`: Асинхронно создает генератор завершений с использованием доступных провайдеров.
- `get_create_function`: Возвращает функцию для создания завершений.
- `get_async_create_function`: Возвращает асинхронную функцию для создания завершений.
- `get_providers`: Возвращает список провайдеров, поддерживающих потоковую передачу, и не включенных в список игнорируемых.

#### `__init__`

```python
def __init__(
        self,
        providers: List[Type[BaseProvider]],
        shuffle: bool = True
    ) -> None:
    """
    Инициализирует BaseRetryProvider.
    Args:
        providers (List[Type[BaseProvider]]): Список провайдеров для использования.
        shuffle (bool): Флаг, указывающий, нужно ли перемешивать список провайдеров.
    """
```

#### `create_completion`

```python
def create_completion(
        self,
        model: str,
        messages: Messages,
        stream: bool = False,
        ignore_stream: bool = False,
        ignored: list[str] = [],
        **kwargs,
    ) -> CreateResult:
    """
    Создает завершение с использованием доступных провайдеров с возможностью потоковой передачи ответа.
    Args:
        model (str): Модель, используемая для завершения.
        messages (Messages): Сообщения, используемые для генерации завершения.
        stream (bool, optional): Флаг, указывающий, следует ли передавать ответ потоком. По умолчанию False.
        ignore_stream (bool, optional): Флаг, указывающий, следует ли игнорировать потоковую передачу. По умолчанию False.
        ignored (list[str], optional): Список имен провайдеров, которые следует игнорировать. По умолчанию [].
    Yields:
        CreateResult: Токены или результаты завершения.
    Raises:
        Exception: Любое исключение, возникшее в процессе завершения.
    """
```

Как работает функция:
- Функция перебирает список провайдеров, полученный из `self.get_providers()`.
- Для каждого провайдера вызывается функция `provider.get_create_function()`, чтобы получить функцию создания завершения.
- Функция `create_completion` вызывается с параметрами `model`, `messages` и `stream`.
- Результаты передаются через `yield` для потоковой обработки.
- Если во время работы с провайдером возникает исключение, оно регистрируется, и происходит переход к следующему провайдеру.
- Если ни один из провайдеров не смог обработать запрос, вызывается исключение `raise_exceptions()`.

#### `create_async_generator`

```python
async def create_async_generator(
        self,
        model: str,
        messages: Messages,
        stream: bool = True,
        ignore_stream: bool = False,
        ignored: list[str] = [],
        **kwargs
    ) -> AsyncResult:
    """
    Асинхронно создает генератор с использованием доступных провайдеров с возможностью потоковой передачи ответа.
    Args:
        model (str): Модель, используемая для завершения.
        messages (Messages): Сообщения, используемые для генерации завершения.
        stream (bool, optional): Флаг, указывающий, следует ли передавать ответ потоком. По умолчанию True.
        ignore_stream (bool, optional): Флаг, указывающий, следует ли игнорировать потоковую передачу. По умолчанию False.
        ignored (list[str], optional): Список имен провайдеров, которые следует игнорировать. По умолчанию [].
    Yields:
        AsyncResult: Асинхронные токены или результаты завершения.
    Raises:
        Exception: Любое исключение, возникшее в процессе завершения.
    """
```

Как работает функция:
- Функция асинхронно перебирает список провайдеров, полученный из `self.get_providers()`.
- Для каждого провайдера вызывается функция `provider.get_async_create_function()`, чтобы получить асинхронную функцию создания завершения.
- Асинхронная функция `create_async_generator` вызывается с параметрами `model`, `messages` и `stream`.
- Результаты передаются через `yield` для потоковой обработки.
- Если во время работы с провайдером возникает исключение, оно регистрируется, и происходит переход к следующему провайдеру.
- Если ни один из провайдеров не смог обработать запрос, вызывается исключение `raise_exceptions()`.

#### `get_create_function`

```python
def get_create_function(self) -> callable:
    """
    Возвращает функцию для создания завершений.
    """
```

#### `get_async_create_function`

```python
def get_async_create_function(self) -> callable:
    """
    Возвращает асинхронную функцию для создания завершений.
    """
```

#### `get_providers`

```python
def get_providers(self, stream: bool, ignored: list[str]) -> list[ProviderType]:
    """
    Возвращает список провайдеров, поддерживающих потоковую передачу, и не включенных в список игнорируемых.
    Args:
        stream (bool): Флаг, указывающий, требуется ли потоковая передача.
        ignored (list[str]): Список имен провайдеров, которые следует игнорировать.
    Returns:
        list[ProviderType]: Список провайдеров, удовлетворяющих условиям.
    """
```

Как работает функция:
- Функция создает список провайдеров, исключая те, которые не поддерживают потоковую передачу, если она требуется, и те, которые находятся в списке игнорируемых.
- Если установлен флаг `self.shuffle`, список провайдеров перемешивается случайным образом.
- Возвращает отфильтрованный и, возможно, перемешанный список провайдеров.

### `RetryProvider`

**Описание**: Предоставляет функциональность для повторных попыток при использовании одного провайдера.
**Наследуется от**: `IterListProvider`

**Атрибуты**:
- `single_provider_retry` (bool): Флаг, указывающий, следует ли повторять попытки для одного провайдера в случае сбоя.
- `max_retries` (int): Максимальное количество повторных попыток для одного провайдера.

**Методы**:
- `__init__`: Инициализирует класс `RetryProvider`.
- `create_completion`: Создает завершение с использованием доступных провайдеров с возможностью повторных попыток.
- `create_async_generator`: Асинхронно создает генератор завершений с использованием доступных провайдеров с возможностью повторных попыток.

#### `__init__`

```python
def __init__(
        self,
        providers: List[Type[BaseProvider]],
        shuffle: bool = True,
        single_provider_retry: bool = False,
        max_retries: int = 3,
    ) -> None:
    """
    Инициализирует BaseRetryProvider.
    Args:
        providers (List[Type[BaseProvider]]): Список провайдеров для использования.
        shuffle (bool): Флаг, указывающий, нужно ли перемешивать список провайдеров.
        single_provider_retry (bool): Флаг, указывающий, следует ли повторять попытки для одного провайдера в случае сбоя.
        max_retries (int): Максимальное количество повторных попыток для одного провайдера.
    """
```

#### `create_completion`

```python
def create_completion(
        self,
        model: str,
        messages: Messages,
        stream: bool = False,
        **kwargs,
    ) -> CreateResult:
    """
    Создает завершение с использованием доступных провайдеров с возможностью потоковой передачи ответа.
    Args:
        model (str): Модель, используемая для завершения.
        messages (Messages): Сообщения, используемые для генерации завершения.
        stream (bool, optional): Флаг, указывающий, следует ли передавать ответ потоком. По умолчанию False.
    Yields:
        CreateResult: Токены или результаты завершения.
    Raises:
        Exception: Любое исключение, возникшее в процессе завершения.
    """
```

Как работает функция:
- Если `self.single_provider_retry` имеет значение `True`, функция пытается использовать первого провайдера из списка `self.providers` `self.max_retries` раз.
- Если во время работы с провайдером возникает исключение, оно регистрируется, и делается повторная попытка.
- Если после `self.max_retries` попыток ни одна не удалась, вызывается исключение `raise_exceptions()`.
- Если `self.single_provider_retry` имеет значение `False`, функция вызывает метод `create_completion` родительского класса `IterListProvider`.

#### `create_async_generator`

```python
async def create_async_generator(
        self,
        model: str,
        messages: Messages,
        stream: bool = True,
        **kwargs
    ) -> AsyncResult:
    """
    Асинхронно создает генератор с использованием доступных провайдеров с возможностью потоковой передачи ответа.
    Args:
        model (str): Модель, используемая для завершения.
        messages (Messages): Сообщения, используемые для генерации завершения.
        stream (bool, optional): Флаг, указывающий, следует ли передавать ответ потоком. По умолчанию True.
    """
```

Как работает функция:
- Если `self.single_provider_retry` имеет значение `True`, функция пытается использовать первого провайдера из списка `self.providers` `self.max_retries` раз.
- Если во время работы с провайдером возникает исключение, оно регистрируется, и делается повторная попытка.
- Если после `self.max_retries` попыток ни одна не удалась, вызывается исключение `raise_exceptions()`.
- Если `self.single_provider_retry` имеет значение `False`, функция вызывает метод `create_async_generator` родительского класса `IterListProvider`.

## Функции

### `raise_exceptions`

```python
def raise_exceptions(exceptions: dict) -> None:
    """
    Вызывает объединенное исключение, если во время повторных попыток возникли какие-либо исключения.
    Raises:
        RetryProviderError: Если какой-либо провайдер столкнулся с исключением.
        RetryNoProviderError: Если провайдер не найден.
    """
```

Как работает функция:
- Функция проверяет, есть ли какие-либо исключения в словаре `exceptions`.
- Если исключения есть, вызывается исключение `RetryProviderError` с информацией о каждом провайдере и его исключении.
- Если исключений нет, вызывается исключение `RetryNoProviderError`.