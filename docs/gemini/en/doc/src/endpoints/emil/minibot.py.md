# Модуль: src.endpoints.emil.minibot

## Обзор

Модуль представляет собой простой Telegram-бот, предназначенный для обработки запросов, связанных с сайтом emil-design.com. Он включает в себя обработку текстовых сообщений, URL-адресов, голосовых сообщений и документов. Бот использует Google Gemini для генерации ответов на текстовые запросы и сценарии для обработки URL-адресов one-tab.com.

## Более подробная информация

Этот модуль является частью проекта `hypotez` и предназначен для предоставления интерфейса взаимодействия с пользователями через Telegram. Он использует библиотеку `telebot` для взаимодействия с API Telegram и библиотеку `python-dotenv` для загрузки конфигурационных параметров из файла `.env`. Модуль содержит классы и функции для обработки различных типов сообщений, отправки ответов пользователям, а также для выполнения сценариев обработки URL-адресов.

## Классы

### `BotHandler`

**Описание**: Обработчик команд, получаемых от бота.

**Атрибуты**:
- `base_dir` (Path): Базовая директория для хранения ресурсов, таких как схема user_flowchart.
- `scenario` (Scenario): Экземпляр класса `Scenario` для выполнения сценариев обработки URL.
- `model` (GoogleGenerativeAi): Экземпляр класса `GoogleGenerativeAi` для взаимодействия с моделью Google Gemini.
- `questions_list` (List[str]): Список вопросов, используемых при обработке команды `--next`.

**Методы**:
- `handle_message(bot: telebot, message: 'message')`: Обрабатывает текстовые сообщения.
- `_send_user_flowchart(bot, chat_id)`: Отправляет схему user_flowchart.
- `_handle_url(bot, message: 'message')`: Обрабатывает URL, присланный пользователем.
- `_handle_next_command(bot, message)`: Обрабатывает команду '--next' и её аналоги.
- `help_command(bot, message)`: Обрабатывает команду /help.
- `send_pdf(bot, message, pdf_file)`: Обрабатывает команду /sendpdf для отправки PDF.
- `handle_voice(bot, message)`: Обрабатывает голосовые сообщения.
- `_transcribe_voice(file_path)`: Транскрибирует голосовое сообщение (заглушка).
- `handle_document(bot, message)`: Обрабатывает полученные документы.

### `Config`

**Описание**: Класс конфигурации бота.

**Атрибуты**:
- `BOT_TOKEN` (str): Токен Telegram-бота, загружается из переменной окружения `TELEGRAM_BOT_TOKEN` или из базы данных (в зависимости от значения `USE_ENV`).
- `CHANNEL_ID` (str): ID канала Telegram.
- `PHOTO_DIR` (Path): Директория для хранения фотографий.
- `COMMAND_INFO` (str): Информация о боте, отображается при использовании команды /info.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, отображаемое при вводе неизвестной команды.
- `START_MESSAGE` (str): Сообщение, отображаемое при старте бота.
- `HELP_MESSAGE` (str): Сообщение, отображаемое при использовании команды /help.

## Методы класса `BotHandler`

### `handle_message`

```python
def handle_message(self, bot:telebot, message:'message'):
    """Обработка текстовых сообщений.
    
    Аргументы:
        bot (telebot): Экземпляр бота Telebot.
        message ('message'): Объект сообщения от пользователя.
    
    Возвращает:
        None
        
    Функция проверяет, является ли сообщение командой `?`, URL-адресом или специальной командой типа `--next`.
    В зависимости от типа сообщения вызываются соответствующие обработчики:
    - `?`: Вызывается метод `_send_user_flowchart` для отправки схемы user_flowchart.
    - URL: Вызывается метод `_handle_url` для обработки URL-адреса.
    - Специальные команды: Вызывается метод `_handle_next_command` для обработки команды.
    - В противном случае, текст сообщения отправляется в модель Google Gemini для получения ответа.
    
    При возникновении ошибки во время взаимодействия с моделью, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```
### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """Отправка схемы user_flowchart.

    Аргументы:
        bot: Экземпляр бота Telebot.
        chat_id: Идентификатор чата, куда отправлять схему.

    Возвращает:
        None

    Функция отправляет фотографию `user_flowchart.png` пользователю.
    Если файл не найден, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

### `_handle_url`

```python
def _handle_url(self, bot, message:'message'):
    """Обработка URL, присланного пользователем.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message ('message'): Объект сообщения от пользователя.

    Возвращает:
        None

    Функция обрабатывает URL, присланный пользователем. Если URL не начинается с `https://one-tab.com`,
    пользователю отправляется сообщение с просьбой проверить URL.
    Если URL валидный, функция пытается извлечь данные о товаре и URL-адреса комплектующих.
    При успешном извлечении данных, запускается сценарий обработки URL-адресов.
    В случае возникновения ошибки, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """Обработка команды '--next' и её аналогов.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция обрабатывает команду '--next' и её аналоги.
    Выбирается случайный вопрос из списка `questions_list`, отправляется пользователю,
    а затем отправляет ответ, сгенерированный моделью на этот вопрос.
    В случае возникновения ошибки, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

### `help_command`

```python
def help_command(self, bot, message):
    """Обработка команды /help.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю список доступных команд.
    """
```

### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """Обработка команды /sendpdf для отправки PDF.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message: Объект сообщения от пользователя.
        pdf_file: Путь к PDF-файлу.

    Возвращает:
        None

    Функция отправляет PDF-файл пользователю.
    В случае возникновения ошибки, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

### `handle_voice`

```python
def handle_voice(self, bot, message):
    """Обработка голосовых сообщений.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция обрабатывает голосовые сообщения, полученные от пользователя.
    Она загружает голосовое сообщение, сохраняет его во временный файл,
    транскрибирует его в текст (в текущей версии это заглушка) и отправляет распознанный текст пользователю.
    В случае возникновения ошибки, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """Транскрибирование голосового сообщения (заглушка).

    Аргументы:
        file_path: Путь к файлу голосового сообщения.

    Возвращает:
        str: Распознанный текст.

    Функция транскрибирует голосовое сообщение в текст.
    В текущей версии это заглушка, возвращающая сообщение о том, что распознавание голоса ещё не реализовано.
    """
```

### `handle_document`

```python
def handle_document(self, bot, message):
    """Обработка полученных документов.

    Аргументы:
        bot: Экземпляр бота Telebot.
        message: Объект сообщения от пользователя.

    Возвращает:
        bool: True в случае успешной обработки, False в случае ошибки.

    Функция обрабатывает документы, полученные от пользователя.
    Она загружает документ, сохраняет его во временный файл и отправляет пользователю сообщение об успешном сохранении.
    В случае возникновения ошибки, регистрируется ошибка и отправляется сообщение об ошибке пользователю.
    """
```

## Функции

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """Обрабатывает команду /start.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю приветственное сообщение.
    """
```

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """Обрабатывает команду /help.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция вызывает метод `help_command` класса `BotHandler` для отправки списка доступных команд.
    """
```

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """Обрабатывает команду /info.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю информацию о боте.
    """
```

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """Обрабатывает команду /time.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю текущее время.
    """
```

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """Обрабатывает команду /photo.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю случайную фотографию из директории `PHOTO_DIR`.
    """
```

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """Обрабатывает голосовые сообщения.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция вызывает метод `handle_voice` класса `BotHandler` для обработки голосового сообщения.
    """
```

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """Обрабатывает сообщения с документами.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция вызывает метод `handle_document` класса `BotHandler` для обработки документа.
    """
```

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """Обрабатывает текстовые сообщения, не начинающиеся с '/'.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция вызывает метод `handle_message` класса `BotHandler` для обработки текстового сообщения.
    """
```

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """Обрабатывает неизвестные команды.

    Аргументы:
        message: Объект сообщения от пользователя.

    Возвращает:
        None

    Функция отправляет пользователю сообщение о неизвестной команде.
    """