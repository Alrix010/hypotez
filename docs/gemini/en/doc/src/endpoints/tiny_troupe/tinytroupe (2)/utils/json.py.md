# Модуль `json.py`

## Обзор

Этот модуль содержит утилиты для работы с сериализацией и десериализацией объектов в JSON-формат. Основным элементом является класс `JsonSerializableRegistry`, который предоставляет возможности для хранения и обработки данных, связанных с различными объектами.

## Детали

Данный модуль предназначен для решения задач, связанных с обработкой объектов, которые необходимо преобразовать в JSON-формат и наоборот. 

## Классы

### `JsonSerializableRegistry`

**Описание**: Базовый класс, предоставляющий функции для сериализации и десериализации объектов в JSON.

**Наследование**: Класс не наследует другие классы.

**Атрибуты**:

 - `class_mapping` (dict): Словарь, хранящий сопоставление имен классов с их определениями. Используется для восстановления объектов из JSON.

**Методы**:

#### `to_json(self, include: list = None, suppress: list = None, file_path: str = None, serialization_type_field_name = "json_serializable_class_name") -> dict`

**Описание**: Преобразует объект в JSON-представление.

**Параметры**:

 - `include` (list, optional): Список атрибутов, которые должны быть включены в сериализацию. Переопределяет стандартное поведение. По умолчанию None.
 - `suppress` (list, optional): Список атрибутов, которые должны быть исключены из сериализации. Переопределяет стандартное поведение. По умолчанию None.
 - `file_path` (str, optional): Путь к файлу, в который будет записан JSON. По умолчанию None.

**Возвращаемое значение**:

 - `dict`: Словарь, содержащий JSON-представление объекта.

**Как работает метод**:

 - Метод собирает все сериализуемые атрибуты из иерархии классов объекта, используя метод `__mro__` для перебора всех базовых классов.
 - Если переданы параметры `include` или `suppress`, они переопределяют стандартное поведение, определяемое атрибутами `serializable_attributes` и `suppress_attributes_from_serialization` в классах.
 - Метод рекурсивно сериализует вложенные объекты, которые наследуют `JsonSerializableRegistry`, используя `to_json`.
 - После сериализации, если указан путь к файлу, метод записывает JSON в этот файл.
 - Метод возвращает словарь с JSON-представлением объекта.

#### `from_json(cls, json_dict_or_path, suppress: list = None, serialization_type_field_name = "json_serializable_class_name", post_init_params: dict = None)`

**Описание**: Загружает JSON-представление объекта и создает экземпляр класса.

**Параметры**:

 - `json_dict_or_path` (dict or str): Словарь, представляющий JSON-представление объекта, или путь к файлу, из которого необходимо загрузить JSON.
 - `suppress` (list, optional): Список атрибутов, которые не должны быть загружены. По умолчанию None.

**Возвращаемое значение**:

 - `JsonSerializableRegistry`: Экземпляр класса, заполненный данными из `json_dict_or_path`.

**Как работает метод**:

 - Метод считывает JSON из переданного словаря или файла.
 - Извлекает имя класса объекта из JSON-представления с использованием ключа `serialization_type_field_name`.
 - Использует `class_mapping` для получения определения класса, соответствующего имени.
 - Создает экземпляр класса без вызова `__init__` с использованием `__new__`.
 - Перебирает все атрибуты из JSON-представления и устанавливает их в экземпляр класса, используя соответствующие методы сериализации для вложенных объектов.
 - Вызывает `_post_deserialization_init`, если он доступен, для дополнительной инициализации после десериализации.
 - Возвращает созданный экземпляр.

#### `__init_subclass__(cls, **kwargs)`

**Описание**: Вызывается при создании подкласса.

**Параметры**:

 - `kwargs` (dict): Справочник с ключевыми аргументами.

**Как работает метод**:

 - Регистрирует подкласс в `class_mapping` с использованием его имени в качестве ключа.
 - Расширяет атрибуты `serializable_attributes`, `suppress_attributes_from_serialization` и `custom_serialization_initializers` из базовых классов, чтобы автоматически включить необходимые атрибуты в сериализацию.

#### `_post_deserialization_init(self, **kwargs)`

**Описание**: Вызывается после десериализации объекта.

**Параметры**:

 - `kwargs` (dict): Справочник с ключевыми аргументами.

**Как работает метод**:

 - Вызывает метод `_post_init`, если он доступен, для дополнительной инициализации объекта после десериализации.

#### `_programmatic_name_to_json_name(cls, name)`

**Описание**: Преобразует имя атрибута в формат JSON, используя "snake_case" стиль.

**Параметры**:

 - `name` (str): Имя атрибута.

**Возвращаемое значение**:

 - `str`: Имя атрибута в формате JSON.

#### `_json_name_to_programmatic_name(cls, name)`

**Описание**: Преобразует имя атрибута из JSON-формата в программистский формат.

**Параметры**:

 - `name` (str): Имя атрибута.

**Возвращаемое значение**:

 - `str`: Имя атрибута в программистском формате.

## Функции

### `post_init(cls)`

**Описание**: Декоратор, который вызывает метод `_post_init` в классе после вызова `__init__`.

**Параметры**:

 - `cls` (type): Класс, для которого будет установлен метод `_post_init`.

**Возвращаемое значение**:

 - `type`: Измененный класс с добавленным методом `_post_init`.

**Как работает функция**:

 - Создает новый метод `__init__`, который вызывает исходный `__init__` класса и затем метод `_post_init`, если он определен.
 - Заменяет исходный `__init__` класса новым методом.
 - Возвращает измененный класс.

### `merge_dicts(current, additions, overwrite=False, error_on_conflict=True)`

**Описание**: Объединяет два словаря и возвращает новый словарь.

**Параметры**:

 - `current` (dict): Исходный словарь.
 - `additions` (dict): Словарь с значениями, которые необходимо добавить.
 - `overwrite` (bool): Флаг, указывающий, следует ли перезаписывать значения, если они одинакового типа, но не оба списка/словари.
 - `error_on_conflict` (bool): Флаг, указывающий, следует ли генерировать ошибку при конфликте, если `overwrite` равен False.

**Возвращаемое значение**:

 - `dict`: Новый словарь с объединенными значениями.

**Как работает функция**:

 - Создает копию исходного словаря, чтобы не изменять его.
 - Перебирает все ключи в словаре `additions`.
 - Если ключ присутствует в обоих словарях, функция рекурсивно объединяет значения, если они являются словарями.
 - Если значения являются списками, они объединяются и дубликаты удаляются.
 - Если значения имеют разные типы, генерируется ошибка.
 - Если значения имеют одинаковый тип, но не оба списка/словари, значение из `additions` перезаписывает значение в `current`, если `overwrite` равен True.
 - Если `overwrite` равен False, то в случае конфликта генерируется ошибка, если `error_on_conflict` равен True.
 - Если ключ не найден в `current`, то значение из `additions` добавляется в `merged`.
 - Возвращается новый словарь с объединенными значениями.

### `remove_duplicates(lst)`

**Описание**: Удаляет дубликаты из списка, сохраняя порядок элементов.

**Параметры**:

 - `lst` (list): Список, из которого необходимо удалить дубликаты.

**Возвращаемое значение**:

 - `list`: Новый список без дубликатов.

**Как работает функция**:

 - Создает список `seen` для отслеживания уже встреченных элементов.
 - Создает новый список `result` для хранения уникальных элементов.
 - Перебирает элементы в исходном списке.
 - Если элемент не был встречен ранее, он добавляется в `seen` и `result`.
 - Возвращает новый список `result` без дубликатов.


## Примеры

```python
from hypotez.src.endpoints.tiny_troupe.tinytroupe (2).utils.json import JsonSerializableRegistry, merge_dicts, remove_duplicates

class MyObject(JsonSerializableRegistry):
    """
    Пример класса, который наследует JsonSerializableRegistry
    """

    serializable_attributes = ['name', 'age']

    def __init__(self, name: str, age: int):
        """
        Инициализирует объект.
        """
        self.name = name
        self.age = age

obj = MyObject("Alice", 30)

# Сериализация объекта в JSON
json_data = obj.to_json()
print(json_data)

# Десериализация объекта из JSON
new_obj = MyObject.from_json(json_data)
print(new_obj.name)
print(new_obj.age)

# Пример использования merge_dicts
dict1 = {'a': 1, 'b': 2, 'c': {'d': 3, 'e': 4}, 'f': [5, 6]}
dict2 = {'c': {'f': 5, 'g': 6}, 'h': 7, 'f': [7, 8]}

merged_dict = merge_dicts(dict1, dict2)
print(merged_dict)

# Пример использования remove_duplicates
lst = [1, 2, 2, 3, 3, 3, 4, 4, 4, 4]
unique_lst = remove_duplicates(lst)
print(unique_lst)

```

## Дополнительные сведения

 - Класс `JsonSerializableRegistry` обеспечивает возможность расширения, позволяя подклассам определять свои собственные сериализуемые атрибуты и логику сериализации/десериализации.
 - Функция `merge_dicts` предлагает гибкий подход к объединению словарей, учитывая различные типы данных и опции перезаписи.
 - Функция `remove_duplicates` гарантирует, что списки будут содержать только уникальные элементы, сохраняя порядок элементов.

## Ограничения

 - Модуль в настоящее время не обеспечивает поддержку сериализации/десериализации объектов, которые не наследуют `JsonSerializableRegistry`.
 - Модуль использует "snake_case" стиль для преобразования имен атрибутов в JSON-формат.

## Внешние ссылки

 - [JSON](https://www.json.org/)
 - [Python: `json` модуль](https://docs.python.org/3/library/json.html)
 - [Python: `__mro__` атрибут](https://docs.python.org/3/library/inspect.html#inspect.getmro)
 - [Python: `__init_subclass__` метод](https://docs.python.org/3/reference/datamodel.html#object.__init_subclass__)
 - [Python: Декораторы](https://docs.python.org/3/glossary.html#term-decorator)