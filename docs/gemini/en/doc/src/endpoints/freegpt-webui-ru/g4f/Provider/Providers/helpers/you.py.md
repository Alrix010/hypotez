# Модуль `you.py`

## Обзор

Модуль предназначен для взаимодействия с API `you.com` для получения ответов на запросы. Он включает в себя преобразование формата сообщений, отправку запросов и обработку ответов. Модуль использует библиотеку `curl_cffi` для выполнения HTTP-запросов.

## Подробнее

Этот модуль является частью проекта `hypotez` и отвечает за интеграцию с `you.com`. Он принимает сообщения, преобразует их в нужный формат для API, отправляет запрос и обрабатывает полученные ответы.

## Структура модуля

- Импорт необходимых библиотек: `sys`, `json`, `urllib.parse`, `curl_cffi`.
- Загрузка конфигурации из аргументов командной строки.
- Определение функции `transform` для преобразования формата сообщений.
- Формирование заголовков HTTP-запроса.
- Формирование параметров запроса.
- Функция `output` для обработки чанков данных, возвращаемых сервером.
- Основной цикл для отправки запросов и обработки ответов.

## Функции

### `transform`

```python
def transform(messages: list) -> list:
    """Преобразует список сообщений в формат, ожидаемый API you.com.

    Функция обрабатывает список сообщений, разделяя их на вопросы и ответы,
    и формирует новый список словарей, где каждый словарь содержит поля
    'question' и 'answer'.

    Args:
        messages (list): Список сообщений, где каждое сообщение представлено
                         словарем с ключами 'role' и 'content'.

    Returns:
        list: Список словарей, где каждый словарь содержит ключи 'question'
              и 'answer', представляющие вопрос и ответ соответственно.

    Пример:
        >>> messages = [
        ...     {'role': 'user', 'content': 'Привет'},
        ...     {'role': 'assistant', 'content': 'Здравствуйте'}
        ... ]
        >>> transform(messages)
        [{'question': 'Привет', 'answer': 'Здравствуйте'}]
    """
    ...
```

**Как работает функция**:

- Функция `transform` преобразует список сообщений в формат, который ожидает API `you.com`.
- Она итерируется по списку сообщений, разделяя их на вопросы (роль `user`) и ответы (роль `assistant`).
- Если подряд идут вопрос и ответ, они объединяются в один словарь.
- Если идет только вопрос или только ответ, они добавляются в результат как есть.
- Сообщения с ролью `system` также добавляются в результат.

**Примеры**:

```python
messages = [
    {'role': 'user', 'content': 'Привет'},
    {'role': 'assistant', 'content': 'Здравствуйте'}
]
transform(messages)  # Вывод: [{'question': 'Привет', 'answer': 'Здравствуйте'}]

messages = [
    {'role': 'user', 'content': 'Привет'}
]
transform(messages)  # Вывод: [{'question': 'Привет', 'answer': ''}]

messages = [
    {'role': 'assistant', 'content': 'Здравствуйте'}
]
transform(messages)  # Вывод: [{'question': '', 'answer': 'Здравствуйте'}]
```

### `output`

```python
def output(chunk):
    """Обрабатывает чанк данных, полученный от сервера.

    Функция проверяет, содержит ли чанк данных токен 'youChatToken',
    и если да, извлекает и печатает его.

    Args:
        chunk: Чанк данных, полученный от сервера.

    Returns:
        None

    Пример:
        >>> chunk = b'data: {"youChatToken": "токен"}'
        >>> output(chunk)  # Вывод: токен
    """
    ...
```

**Как работает функция**:

- Функция `output` обрабатывает чанки данных, которые возвращает сервер `you.com`.
- Она ищет в чанке строку `b'"youChatToken"'`.
- Если строка найдена, функция извлекает JSON из чанка, разделяя его по строке `data: `.
- Затем извлекается значение `youChatToken` и выводится в консоль.

**Примеры**:

```python
chunk = b'data: {"youChatToken": "токен"}'
output(chunk)  # Вывод: токен
```

## Переменные

- `config`: Словарь с конфигурацией, загруженный из аргументов командной строки.
- `messages`: Список сообщений, извлеченный из конфигурации.
- `prompt`: Текст запроса, извлеченный из последнего сообщения пользователя.
- `headers`: Словарь с HTTP-заголовками для запроса.
- `params`: Строка с параметрами запроса, закодированная в формате URL.

## Как работает модуль

1. **Загрузка конфигурации**:
   - Модуль принимает JSON-конфигурацию в качестве аргумента командной строки.
   - Эта конфигурация содержит список сообщений для отправки в API `you.com`.

2. **Преобразование сообщений**:
   - Функция `transform` преобразует список сообщений в формат, ожидаемый API `you.com`.
   - Она разделяет сообщения на вопросы и ответы и формирует из них список словарей.

3. **Формирование HTTP-запроса**:
   - Формируются HTTP-заголовки, включающие `Content-Type`, `Accept`, `User-Agent` и другие.
   - Формируются параметры запроса, включающие текст запроса (`prompt`), домен (`domain`) и преобразованные сообщения (`chat`).

4. **Отправка запроса и обработка ответа**:
   - Используется библиотека `curl_cffi` для отправки HTTP-запроса к API `you.com`.
   - Функция `output` вызывается для каждого чанка данных, возвращаемого сервером.
   - Если в чанке найден токен `youChatToken`, он извлекается и выводится в консоль.

5. **Обработка ошибок**:
   - Если при отправке запроса возникает ошибка, модуль перехватывает исключение и повторяет попытку.

## Примеры использования

Для запуска модуля необходимо передать JSON-конфигурацию в качестве аргумента командной строки:

```bash
python you.py '{"messages": [{"role": "user", "content": "Привет"}]}'
```

## Зависимости

- `sys`
- `json`
- `urllib.parse`
- `curl_cffi`