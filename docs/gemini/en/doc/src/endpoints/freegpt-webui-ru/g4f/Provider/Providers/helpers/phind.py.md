# Модуль для работы с Phind API

## Обзор

Модуль предоставляет функциональность для взаимодействия с API Phind для получения ответов на вопросы.
Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и обрабатывает ответы, возвращаемые API.

## Более подробно

Этот код отправляет запросы к API Phind для получения ответов на вопросы, используя предоставленные параметры конфигурации.
Он обрабатывает ответ потоково, извлекая полезные данные и выводя их в консоль. Код также включает обработку ошибок и повторные попытки в случае сбоев.

## Функции

### `output(chunk)`

```python
def output(chunk):
    """Обрабатывает фрагмент данных, полученный от API Phind.

    Args:
        chunk (bytes): Фрагмент данных в байтовом формате, полученный от API.

    Returns:
        None

    Raises:
        json.decoder.JSONDecodeError: Если не удается декодировать JSON из фрагмента данных.
   """
```

**Назначение**:

Функция `output` предназначена для обработки данных, получаемых от API Phind в виде фрагментов (chunks). Она фильтрует метаданные Phind, удаляет ненужные символы и декодирует фрагмент данных из байтового формата в строку. Затем функция выводит очищенные данные в консоль.

**Как работает функция**:

1. **Проверка наличия метаданных**:
   - Проверяет, содержит ли фрагмент данных маркер `b'PHIND_METADATA'`. Если да, функция завершает выполнение, чтобы избежать обработки метаданных.

2. **Обработка специальных случаев**:
   - Проверяет, равен ли фрагмент данных определенной последовательности байтов, указывающей на пустые данные (`b'data:  \\r\\ndata: \\r\\ndata: \\r\\n\\r\\n'`). Если да, заменяет его на `b'data:  \\n\\r\\n\\r\\n'`.

3. **Декодирование фрагмента**:
   - Декодирует фрагмент данных из байтов в строку, используя кодировку UTF-8.

4. **Замена символов**:
   - Выполняет замену определенных последовательностей символов для очистки данных:
     - Заменяет `'data: \\r\\n\\r\\ndata: '` на `'data: \\n'`.
     - Заменяет `'\\r\\ndata: \\r\\ndata: \\r\\n\\r\\n'` на `'\\n\\r\\n\\r\\n'`.
     - Заменяет `'data: '` на `''` и `'\\r\\n\\r\\n'` на `''`.

5. **Вывод в консоль**:
   - Выводит очищенный фрагмент данных в консоль с помощью `print(chunk, flush=True, end = '')`. Параметр `flush=True` обеспечивает немедленный вывод данных, а `end = ''` предотвращает добавление новой строки после каждого фрагмента.

6. **Обработка исключений**:
   - Обрабатывает исключение `json.decoder.JSONDecodeError`, которое может возникнуть, если фрагмент данных не является корректным JSON. В случае ошибки исключение игнорируется, и функция продолжает выполнение.

**Примеры**:

```python
# Пример вызова функции output с фиктивными данными
chunk = b"data:  This is a test chunk\\r\\n\\r\\n"
output(chunk)
```

## Classes

### `No classes`

В данном модуле классы отсутствуют.

## Переменные

- `config (dict)`: Словарь, содержащий параметры конфигурации, полученные из аргументов командной строки.
- `prompt (str)`: Текст запроса, извлеченный из конфигурации.
- `skill (str)`: Уровень квалификации, определяемый на основе модели, указанной в конфигурации.
- `json_data (str)`: JSON-представление данных запроса, отправляемых в API Phind.
- `headers (dict)`: Словарь, содержащий заголовки HTTP-запроса.
- `response (requests.Response)`: Объект ответа, полученный от API Phind.
- `e (Exception)`: Объект исключения, возникающего при выполнении запроса.

## Как работает код:

1. **Импорт библиотек**:
   - Импортирует необходимые библиотеки: `sys`, `json`, `datetime` и `urllib.parse`.
   - Импортирует `requests` из библиотеки `curl_cffi` для выполнения HTTP-запросов.

2. **Загрузка конфигурации**:
   - Загружает конфигурацию из аргументов командной строки, используя `json.loads(sys.argv[1])`.
   - Извлекает текст запроса из конфигурации: `prompt = config['messages'][-1]['content']`.
   - Определяет уровень квалификации (`skill`) на основе модели, указанной в конфигурации.

3. **Формирование JSON-данных**:
   - Формирует JSON-данные для отправки в API Phind, включая текст запроса, уровень квалификации, текущую дату и другие параметры.
   - Преобразует JSON-данные в строку с помощью `json.dumps()`.

4. **Формирование заголовков**:
   - Формирует словарь `headers`, содержащий заголовки HTTP-запроса, включая `Content-Type`, `User-Agent`, `Referer` и другие.

5. **Отправка запроса и обработка ответа**:
   - Входит в бесконечный цикл `while True`.
   - Пытается отправить POST-запрос к API Phind с использованием `requests.post()`.
   - В качестве `content_callback` передает функцию `output` для обработки потоковых данных ответа.
   - Устанавливает таймаут для запроса и имитирует браузер Safari.
   - В случае успешного выполнения запроса выходит из цикла с помощью `exit(0)`.
   - В случае возникновения ошибки выводит сообщение об ошибке и повторяет попытку.

## Примеры

Пример запуска скрипта с параметрами конфигурации:

```bash
python your_script_name.py '{"model": "gpt-4", "messages": [{"content": "What is the capital of France?"}]}'
```

В этом примере скрипт будет отправлять запрос в API Phind с вопросом "What is the capital of France?" и моделью "gpt-4".