# Модуль mega.py

## Обзор

Модуль предоставляет класс `Mega` для взаимодействия с API сервиса Mega.co.nz, включая функциональность для аутентификации, скачивания и загрузки файлов. Он обеспечивает методы для входа в систему с использованием email/пароля или временных ключей, скачивания файлов из публичных и приватных источников, а также загрузки файлов на сервис.

## Детали

Этот модуль реализует взаимодействие с API Mega.co.nz, используя криптографические функции для обеспечения безопасности данных. Он включает в себя методы для аутентификации, скачивания и загрузки файлов, а также для управления файлами в облачном хранилище.

## Классы

### `Mega`

**Описание**:
Класс для взаимодействия с API сервиса Mega.co.nz.

**Атрибуты**:
- `seqno` (int): Порядковый номер для API-запросов.
- `sid` (str | None): Идентификатор сессии пользователя после аутентификации.
- `master_key` (list[int]): Главный ключ пользователя, полученный после расшифровки данных аутентификации.
- `rsa_priv_key` (list[int]): Приватный RSA-ключ пользователя, используемый для расшифровки идентификатора сессии.
- `root_id` (str): Идентификатор корневой директории ("Cloud Drive").
- `inbox_id` (str): Идентификатор папки "Inbox".
- `trashbin_id` (str): Идентификатор корзины.

**Методы**:
- `__init__()`: Инициализирует экземпляр класса `Mega` со случайным номером последовательности и пустым идентификатором сессии.
- `from_credentials(email: str, password: str) -> Mega`: Создает экземпляр класса `Mega` и выполняет вход пользователя с использованием email и пароля.
- `from_ephemeral() -> Mega`: Создает экземпляр класса `Mega` и выполняет вход с использованием временных ключей.
- `api_req(data: dict) -> dict`: Выполняет API-запрос к сервису Mega.co.nz.
- `login_user(email: str, password: str) -> None`: Выполняет вход пользователя с использованием email и пароля.
- `login_ephemeral() -> None`: Выполняет вход с использованием временных ключей.
- `_login_common(res: dict, password: list[int]) -> None`: Общая логика для завершения процесса входа в систему.
- `get_files() -> dict`: Получает список файлов и директорий из облачного хранилища.
- `download_from_url(url: str) -> str`: Скачивает файл по публичной ссылке.
- `download_file(file_id: str, file_key: str, public: bool = False, store_path: str | None = None) -> str`: Скачивает файл по его идентификатору и ключу.
- `get_public_url(file_id: str, file_key: list[int]) -> str`: Получает публичную ссылку на файл.
- `uploadfile(filename: str, dst: str | None = None) -> dict`: Загружает файл в облачное хранилище.

## Методы класса

### `__init__`

```python
def __init__(self) -> None
```

**Описание**:
Инициализирует новый экземпляр класса `Mega`.

**Как работает**:
- Устанавливает случайный номер последовательности (`seqno`) для будущих API-запросов.
- Инициализирует идентификатор сессии (`sid`) как `None`.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> Mega
```

**Описание**:
Создает экземпляр класса `Mega` и выполняет вход пользователя с использованием email и пароля.

**Параметры**:
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, аутентифицированный с использованием предоставленных учетных данных.

**Как работает**:
- Создает экземпляр класса `Mega`.
- Вызывает метод `login_user` для аутентификации пользователя.
- Возвращает созданный экземпляр класса `Mega`.

**Пример**:

```python
mega_instance = Mega.from_credentials('user@example.com', 'password')
```

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> Mega
```

**Описание**:
Создает экземпляр класса `Mega` и выполняет вход с использованием временных ключей.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, аутентифицированный с использованием временных ключей.

**Как работает**:
- Создает экземпляр класса `Mega`.
- Вызывает метод `login_ephemeral` для аутентификации с использованием временных ключей.
- Возвращает созданный экземпляр класса `Mega`.

**Пример**:

```python
mega_instance = Mega.from_ephemeral()
```

### `api_req`

```python
def api_req(self, data: dict) -> dict
```

**Описание**:
Выполняет API-запрос к сервису Mega.co.nz.

**Параметры**:
- `data` (dict): Словарь с данными запроса.

**Возвращает**:
- `dict`: Словарь с данными ответа от API.

**Вызывает**:
- `MegaRequestException`: Если API возвращает код ошибки.

**Как работает**:
- Добавляет параметры `id` (порядковый номер запроса) и `sid` (идентификатор сессии, если есть) к данным запроса.
- Преобразует данные в JSON-формат.
- Отправляет POST-запрос к API.
- Обрабатывает ответ API и возвращает данные.

**Пример**:

```python
response = self.api_req({'a': 'f', 'c': 1})
```

### `login_user`

```python
def login_user(self, email: str, password: str) -> None
```

**Описание**:
Выполняет вход пользователя с использованием email и пароля.

**Параметры**:
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Как работает**:
- Подготавливает AES-ключ из пароля.
- Вычисляет хеш email и пароля.
- Выполняет API-запрос для аутентификации пользователя.
- Вызывает метод `_login_common` для завершения процесса входа.

**Пример**:

```python
self.login_user('user@example.com', 'password')
```

### `login_ephemeral`

```python
def login_ephemeral(self) -> None
```

**Описание**:
Выполняет вход с использованием временных ключей.

**Как работает**:
- Генерирует случайные ключи.
- Выполняет API-запрос для получения идентификатора пользователя.
- Выполняет API-запрос для аутентификации пользователя.
- Вызывает метод `_login_common` для завершения процесса входа.

### `_login_common`

```python
def _login_common(self, res: dict, password: list[int]) -> None
```

**Описание**:
Общая логика для завершения процесса входа в систему.

**Параметры**:
- `res` (dict): Словарь с данными ответа от API.
- `password` (list[int]) : Ключ пароля пользователя.

**Вызывает**:
- `MegaIncorrectPasswordExcetion`: Если email и/или пароль неверны.

**Как работает**:
- Расшифровывает главный ключ пользователя.
- Извлекает и устанавливает идентификатор сессии.
- Если идентификатор сессии зашифрован с использованием RSA, расшифровывает его.

### `get_files`

```python
def get_files(self) -> dict
```

**Описание**:
Получает список файлов и директорий из облачного хранилища.

**Возвращает**:
- `dict`: Словарь с данными о файлах и директориях.

**Как работает**:
- Выполняет API-запрос для получения списка файлов.
- Расшифровывает ключи и атрибуты файлов и директорий.
- Устанавливает идентификаторы корневой директории, папки "Inbox" и корзины.

### `download_from_url`

```python
def download_from_url(self, url: str) -> str
```

**Описание**:
Скачивает файл по публичной ссылке.

**Параметры**:
- `url` (str): URL публичной ссылки на файл.

**Возвращает**:
- `str`: Имя скачанного файла.

**Как работает**:
- Извлекает идентификатор файла и ключ из URL.
- Вызывает метод `download_file` для скачивания файла.

**Пример**:

```python
file_name = self.download_from_url('https://mega.co.nz/#!file_id!file_key')
```

### `download_file`

```python
def download_file(self, file_id: str, file_key: str, public: bool = False, store_path: str | None = None) -> str
```

**Описание**:
Скачивает файл по его идентификатору и ключу.

**Параметры**:
- `file_id` (str): Идентификатор файла.
- `file_key` (str): Ключ файла.
- `public` (bool): Флаг, указывающий, является ли файл публичным. По умолчанию `False`.
- `store_path` (str | None): Путь для сохранения файла. Если не указан, файл сохраняется в текущей директории. По умолчанию `None`.

**Возвращает**:
- `str`: Имя скачанного файла.

**Вызывает**:
- `ValueError`: Если не совпадают MAC-адреса.

**Как работает**:
- Выполняет API-запрос для получения данных о файле.
- Расшифровывает атрибуты файла.
- Скачивает файл по частям, расшифровывает каждую часть и записывает ее в выходной файл.
- Выполняет проверку целостности файла.

### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list[int]) -> str
```

**Описание**:
Получает публичную ссылку на файл.

**Параметры**:
- `file_id` (str): Идентификатор файла.
- `file_key` (list[int]): Ключ файла.

**Возвращает**:
- `str`: Публичная ссылка на файл.

**Как работает**:
- Выполняет API-запрос для получения публичного дескриптора файла.
- Формирует URL с использованием идентификатора и ключа файла.

**Пример**:

```python
public_url = self.get_public_url('file_id', [1, 2, 3, 4, 5, 6, 7, 8])
```

### `uploadfile`

```python
def uploadfile(self, filename: str, dst: str | None = None) -> dict
```

**Описание**:
Загружает файл в облачное хранилище.

**Параметры**:
- `filename` (str): Путь к файлу для загрузки.
- `dst` (str | None): Идентификатор директории назначения. Если не указан, файл загружается в корневую директорию. По умолчанию `None`.

**Возвращает**:
- `dict`: Данные об загруженном файле.

**Как работает**:
- Открывает файл для чтения в двоичном режиме.
- Определяет размер файла.
- Выполняет API-запрос для получения URL загрузки.
- Шифрует файл по частям и отправляет каждую часть на URL загрузки.
- Вычисляет MAC-адрес файла.
- Выполняет API-запрос для завершения процесса загрузки.