# Модуль `catalog_router`

## Обзор

Этот модуль содержит маршрутизатор (`catalog_router`) для обработки запросов, связанных с каталогом товаров в Telegram-боте. Он обрабатывает отображение каталога, выбор категорий, отображение товаров в категориях и организацию процесса покупки товаров через различные платежные системы.

## Подробнее

Модуль использует `aiogram` для обработки входящих запросов от пользователей Telegram. Он взаимодействует с базой данных через `SQLAlchemy` для получения информации о категориях и товарах. Поддерживаются платежные системы ЮKassa, Stars и Robocassa. Логика успешной оплаты обрабатывается в отдельной функции `successful_payment_logic`.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `page_catalog`

```python
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """ Отображает каталог товаров.

    Функция обрабатывает запрос пользователя на отображение каталога товаров.
    Она извлекает данные о категориях товаров из базы данных и отправляет
    пользователю сообщение со списком категорий, представленным в виде клавиатуры.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без коммита.

    Raises:
        Exception: Обрабатывается любое исключение, возникающее при удалении предыдущего сообщения.

    Как работает функция:
        1. Отвечает на обратный вызов сообщением "Загрузка каталога...".
        2. Пытается удалить предыдущее сообщение пользователя, чтобы интерфейс оставался чистым.
        3. Извлекает все категории товаров из базы данных, используя `CategoryDao.find_all`.
        4. Отправляет пользователю сообщение со списком категорий, используя клавиатуру `catalog_kb`.

    Примеры:
        Предположим, есть объект `call: CallbackQuery` и асинхровая сессия `session_without_commit: AsyncSession`.
        Вызов функции будет выглядеть так:
        ```python
        await page_catalog(call, session_without_commit)
        ```
    """
```

### `page_catalog_products`

```python
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """ Отображает товары выбранной категории.

    Функция обрабатывает запрос пользователя на отображение товаров в определенной категории.
    Она извлекает идентификатор категории из данных обратного вызова,
    запрашивает список товаров этой категории из базы данных и отправляет
    пользователю сообщение с описанием каждого товара и кнопками для покупки.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без коммита.

    Как работает функция:
        1. Извлекает `category_id` из `call.data`, который имеет формат "category_{id}".
        2. Извлекает все товары, принадлежащие данной категории, используя `ProductDao.find_all`.
        3. Если товары найдены, для каждого товара формируется текстовое описание и отправляется пользователю вместе с клавиатурой для покупки (`product_kb`).
        4. Если товары не найдены, отправляет пользователю сообщение "В данной категории нет товаров.".

    Примеры:
        Предположим, есть объект `call: CallbackQuery` с данными, содержащими идентификатор категории,
        и асинхровая сессия `session_without_commit: AsyncSession`.
        Вызов функции будет выглядеть так:
        ```python
        await page_catalog_products(call, session_without_commit)
        ```
    """
```

### `process_about`

```python
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """ Обрабатывает запрос на покупку товара.

    Функция обрабатывает запрос пользователя на покупку товара через различные
    платежные системы (ЮKassa, Stars, Robocassa). Она извлекает информацию
    о типе платежа и идентификаторе товара из данных обратного вызова и
    вызывает соответствующую функцию для организации процесса оплаты.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без коммита.

    Как работает функция:
        1. Извлекает информацию о пользователе из базы данных, используя `UserDAO.find_one_or_none`.
        2. Разделяет данные из `call.data` для получения типа платежа (`payment_type`), идентификатора товара (`product_id`) и цены (`price`).
        3. В зависимости от типа платежа вызывает соответствующую функцию (`send_yukassa_invoice`, `send_stars_invoice` или `send_robocassa_invoice`).
        4. Удаляет исходное сообщение пользователя.

    Примеры:
        Предположим, есть объект `call: CallbackQuery` с данными, содержащими тип платежа,
        идентификатор товара и цену, а также асинхровая сессия `session_without_commit: AsyncSession`.
        Вызов функции будет выглядеть так:
        ```python
        await process_about(call, session_without_commit)
        ```
    """
```

### `send_yukassa_invoice`

```python
async def send_yukassa_invoice(call, user_info, product_id, price):
    """ Отправляет инвойс для оплаты через ЮKassa.

    Функция отправляет пользователю инвойс для оплаты товара через платежную
    систему ЮKassa. Она формирует инвойс с указанием названия товара, описания,
    цены и других параметров, необходимых для проведения платежа.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        user_info: Информация о пользователе.
        product_id: Идентификатор товара.
        price: Цена товара.

    Как работает функция:
        1. Отправляет инвойс пользователю, используя `bot.send_invoice`.
        2. Инвойс содержит название, описание, payload (для идентификации платежа), токен провайдера ЮKassa, валюту и цену.
        3. Клавиатура `get_product_buy_youkassa` прикрепляется к инвойсу.

    Примеры:
        Предположим, есть объект `call: CallbackQuery`, информация о пользователе `user_info`,
        идентификатор товара `product_id` и цена товара `price`.
        Вызов функции будет выглядеть так:
        ```python
        await send_yukassa_invoice(call, user_info, product_id, price)
        ```
    """
```

### `send_robocassa_invoice`

```python
async def send_robocassa_invoice(call, user_info, product_id, price, session: AsyncSession):
    """ Отправляет ссылку для оплаты через Robocassa.

    Функция формирует ссылку для оплаты товара через платежную систему Robocassa
    и отправляет ее пользователю. Ссылка содержит параметры, необходимые для
    проведения платежа, включая идентификатор платежа, описание товара и цену.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        user_info: Информация о пользователе.
        product_id: Идентификатор товара.
        price: Цена товара.
        session (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.

    Как работает функция:
        1. Получает следующий идентификатор платежа из базы данных, используя `PurchaseDao.get_next_id`.
        2. Формирует описание платежа.
        3. Генерирует ссылку для оплаты, используя `generate_payment_link`.
        4. Отправляет пользователю сообщение со ссылкой для оплаты и клавиатурой `get_product_buy_robocassa`.

    Примеры:
        Предположим, есть объект `call: CallbackQuery`, информация о пользователе `user_info`,
        идентификатор товара `product_id`, цена товара `price` и асинхровая сессия `session: AsyncSession`.
        Вызов функции будет выглядеть так:
        ```python
        await send_robocassa_invoice(call, user_info, product_id, price, session)
        ```
    """
```

### `send_stars_invoice`

```python
async def send_stars_invoice(call, user_info, product_id, stars_price):
    """ Отправляет инвойс для оплаты через Stars.

    Функция отправляет пользователю инвойс для оплаты товара через внутреннюю
    валюту Stars. Она формирует инвойс с указанием названия товара, описания,
    цены в Stars и других параметров, необходимых для проведения платежа.

    Args:
        call (CallbackQuery): Объект обратного вызова от Telegram.
        user_info: Информация о пользователе.
        product_id: Идентификатор товара.
        stars_price: Цена товара в Stars.

    Как работает функция:
        1. Отправляет инвойс пользователю, используя `bot.send_invoice`.
        2. Инвойс содержит название, описание, payload (для идентификации платежа), валюту XTR и цену в Stars.
        3. Клавиатура `get_product_buy_stars` прикрепляется к инвойсу.

    Примеры:
        Предположим, есть объект `call: CallbackQuery`, информация о пользователе `user_info`,
        идентификатор товара `product_id` и цена товара в Stars `stars_price`.
        Вызов функции будет выглядеть так:
        ```python
        await send_stars_invoice(call, user_info, product_id, stars_price)
        ```
    """
```

### `pre_checkout_query`

```python
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """ Подтверждает готовность к оплате.

    Функция обрабатывает предварительный запрос перед оплатой и подтверждает
    готовность бота к обработке платежа.

    Args:
        pre_checkout_q (PreCheckoutQuery): Объект предварительного запроса перед оплатой от Telegram.

    Как работает функция:
        1. Отвечает на предварительный запрос, подтверждая готовность к оплате, используя `bot.answer_pre_checkout_query`.

    Примеры:
        Предположим, есть объект `pre_checkout_q: PreCheckoutQuery`.
        Вызов функции будет выглядеть так:
        ```python
        await pre_checkout_query(pre_checkout_q)
        ```
    """
```

### `successful_payment`

```python
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """ Обрабатывает успешную оплату.

    Функция обрабатывает уведомление об успешной оплате товара. Она извлекает
    информацию о платеже из сообщения, сохраняет данные о платеже в базе данных
    и уведомляет пользователя об успешной оплате.

    Args:
        message (Message): Объект сообщения от Telegram об успешной оплате.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных с коммитом.

    Как работает функция:
        1. Извлекает информацию о платеже из `message.successful_payment`.
        2. Разделяет данные из `payment_info.invoice_payload` для получения типа платежа, идентификатора пользователя и идентификатора товара.
        3. Определяет цену и валюту платежа.
        4. Формирует словарь `payment_data` с информацией о платеже.
        5. Вызывает функцию `successful_payment_logic` для обработки логики успешной оплаты.

    Примеры:
        Предположим, есть объект `message: Message` с информацией об успешной оплате
        и асинхровая сессия `session_with_commit: AsyncSession`.
        Вызов функции будет выглядеть так:
        ```python
        await successful_payment(message, session_with_commit)
        ```
    """
```

## Переменные

В данном модуле используются следующие переменные:

- `catalog_router`: Объект `Router` из библиотеки `aiogram`, предназначенный для маршрутизации запросов, связанных с каталогом товаров.

```python
catalog_router = Router()