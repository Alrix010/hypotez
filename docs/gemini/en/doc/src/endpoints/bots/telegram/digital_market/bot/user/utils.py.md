# Модуль `utils.py`

## Обзор

Модуль содержит утилиты для обработки успешных платежей в Telegram-боте цифрового рынка. Он включает в себя логику добавления информации о покупке в базу данных, отправку уведомлений администраторам и пользователям, а также обработку возврата звезд при оплате звездами.

## Детали

Модуль предназначен для обработки успешных транзакций в Telegram-боте, взаимодействуя с базой данных для сохранения информации о покупке и отправляя уведомления заинтересованным сторонам.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """ Функция выполняет логику обработки успешной оплаты.

    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy для выполнения операций с базой данных.
        payment_data: Данные о платеже.
        currency: Валюта платежа.
        user_tg_id: Telegram ID пользователя, совершившего оплату.
        bot (Bot): Экземпляр бота aiogram для отправки сообщений.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке уведомления администраторам.

    Как работает функция:
    - Извлекает данные о продукте и платеже из `payment_data`.
    - Добавляет информацию о покупке в базу данных через `PurchaseDao.add`.
    - Находит данные о продукте в базе данных через `ProductDao.find_one_or_none_by_id`.
    - Отправляет уведомления администраторам о совершенной покупке.
    - Формирует текст сообщения для пользователя с информацией о покупке.
    - Отправляет пользователю сообщение с информацией о покупке и, если применимо, отправляет файл продукта.
    - Если тип оплаты - "stars", инициирует возврат звезд пользователю.

    Примеры:
    Пример вызова функции с различными параметрами.
    """
```

**Параметры:**

- `session` (AsyncSession): Сессия базы данных SQLAlchemy, используемая для выполнения операций с базой данных.
- `payment_data`: Данные о платеже, включающие `product_id`, `price`, `payment_type`, `payment_id` и `user_id`.
- `currency`: Валюта, в которой был произведен платеж.
- `user_tg_id`: Telegram ID пользователя, совершившего покупку.
- `bot` (Bot): Экземпляр бота aiogram, используемый для отправки сообщений пользователям и администраторам.

**Описание работы:**

1.  **Извлечение данных**: Функция извлекает `product_id`, `price`, `payment_type`, `payment_id` и `user_id` из `payment_data`.
2.  **Добавление информации о покупке**: Использует `PurchaseDao.add` для добавления записи о покупке в базу данных.
3.  **Получение данных о товаре**: Функция извлекает данные о товаре из базы данных на основе `product_id`.
4.  **Уведомление администраторов**: Отправляет уведомления каждому администратору в списке `settings.ADMIN_IDS` о новой покупке. В случае ошибки логирует ее.
5.  **Формирование сообщения для пользователя**: Функция формирует сообщение для пользователя, содержащее информацию о названии товара, описании, цене и закрытом контенте.
6.  **Отправка сообщения пользователю**: Отправляет сообщение пользователю, содержащее информацию о товаре. Если товар содержит файл (`product_data.file_id`), отправляет файл.
7.  **Возврат звезд**: Если тип оплаты - "звезды" (`payment_type == 'stars'`), инициирует возврат звезд пользователю.

**Примеры:**

Пример вызова функции:

```python
# Пример вызова функции
# await successful_payment_logic(session, payment_data, currency, user_tg_id, bot)