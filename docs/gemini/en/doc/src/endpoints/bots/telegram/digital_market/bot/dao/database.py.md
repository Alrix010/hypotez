# Модуль `database.py`

## Обзор

Модуль `database.py` предназначен для настройки и управления базой данных, используемой в Telegram-боте для цифрового рынка. Он определяет базовый класс для моделей базы данных, настраивает подключение к базе данных и предоставляет инструменты для взаимодействия с ней.

## Более подробно

Модуль использует SQLAlchemy для асинхронного взаимодействия с базой данных. Он определяет базовый класс `Base`, от которого наследуются все остальные модели базы данных. Также он настраивает движок SQLAlchemy и фабрику сессий для работы с базой данных асинхронно.

## Классы

### `Base`

**Описание**:
Базовый класс для всех моделей базы данных. Предоставляет общие атрибуты, такие как `id`, `created_at` и `updated_at`, а также метод `to_dict` для преобразования объекта в словарь.

**Наследует**:
- `AsyncAttrs`: Предоставляет атрибуты для асинхронного взаимодействия с базой данных.
- `DeclarativeBase`: Базовый класс для декларативного отображения моделей SQLAlchemy.

**Атрибуты**:
- `id` (int): Уникальный идентификатор записи в базе данных, первичный ключ и автоинкрементное поле.
- `created_at` (datetime): Дата и время создания записи, устанавливается автоматически при создании записи.
- `updated_at` (datetime): Дата и время последнего обновления записи, обновляется автоматически при каждом изменении записи.

**Методы**:
- `to_dict()`: Преобразует объект в словарь, где ключами являются имена столбцов таблицы, а значениями - значения соответствующих атрибутов объекта.

**Принцип работы**:

Класс `Base` служит основой для всех моделей базы данных в проекте. Он определяет общую структуру таблиц, включая поля для идентификации и временных меток. Атрибуты `created_at` и `updated_at` автоматически заполняются при создании и обновлении записей соответственно. Метод `to_dict` упрощает преобразование объектов в словари для удобной сериализации и передачи данных.

## Методы класса

### `__tablename__`

```python
    @classmethod
    @property
    def __tablename__(cls) -> str:
        return cls.__name__.lower() + 's'
```

**Назначение**: Возвращает имя таблицы в базе данных на основе имени класса, преобразованного в нижний регистр и с добавлением суффикса "s".

**Параметры**:
- `cls` (class): Ссылка на класс, для которого вызывается метод.

**Возвращает**:
- `str`: Имя таблицы в базе данных.

**Пример работы**:

Если имя класса `User`, то метод вернет `users`.

### `to_dict`

```python
    def to_dict(self) -> dict:
        # Метод для преобразования объекта в словарь
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

**Назначение**: Преобразует объект в словарь, где ключами являются имена столбцов таблицы, а значениями - значения соответствующих атрибутов объекта.

**Параметры**:
- Нет.

**Возвращает**:
- `dict`: Словарь, представляющий объект.

**Как работает функция**:
- Функция выполняет итерацию по всем столбцам таблицы (`self.__table__.columns`).
- Для каждого столбца (`c`) она извлекает имя столбца (`c.name`) и значение соответствующего атрибута объекта (`getattr(self, c.name)`).
- Затем она создает словарь, где ключами являются имена столбцов, а значениями - значения атрибутов.

**Примеры**:

Пример преобразования объекта в словарь:

```python
from datetime import datetime
from sqlalchemy import Column, Integer, String, DateTime, func
from sqlalchemy.orm import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)
    created_at = Column(DateTime, server_default=func.now())

    def to_dict(self):
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}

# Пример использования
user = User(id=1, name='John Doe', email='john.doe@example.com')
user_dict = user.to_dict()
print(user_dict)
# {'id': 1, 'name': 'John Doe', 'email': 'john.doe@example.com', 'created_at': None}
```

## Переменные модуля

- `engine`: Асинхронный движок SQLAlchemy, используемый для подключения к базе данных. Создается с использованием URL, полученного из конфигурации (`database_url`).
- `async_session_maker`: Фабрика сессий SQLAlchemy, используемая для создания асинхронных сессий для работы с базой данных.