# Модуль админ-панели бота

## Обзор

Модуль реализует админ-панель для управления ботом, позволяя администраторам добавлять, удалять и редактировать товары, а также получать статистику.

## Детали

Этот модуль находится в `hypotez/src/endpoints/bots/telegram/digital_market/bot/admin/admin.py` и отвечает за обработку команд и запросов от администраторов бота. Он использует aiogram для обработки запросов, SQLalchemy для взаимодействия с базой данных и различные вспомогательные функции для форматирования и проверки данных.

## Классы

### `class AddProduct(StatesGroup)`

**Описание**: Класс, представляющий собой набор состояний для сценария добавления нового товара.

**Атрибуты**:

- `name` (State): Состояние, в котором пользователь вводит имя товара.
- `description` (State): Состояние, в котором пользователь вводит описание товара.
- `price` (State): Состояние, в котором пользователь вводит цену товара.
- `file_id` (State): Состояние, в котором пользователь отправляет файл или указывает, что файл не требуется.
- `category_id` (State): Состояние, в котором пользователь выбирает категорию товара.
- `hidden_content` (State): Состояние, в котором пользователь вводит скрытый контент, который будет доступен после покупки.
- `confirm_add` (State): Состояние, в котором пользователь подтверждает добавление товара.

## Функции

### `start_admin(call: CallbackQuery)`

**Назначение**:  Функция запускает админ-панель бота.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Проверяет, является ли пользователь администратором, используя `settings.ADMIN_IDS`.
- Отправляет сообщение с кнопками для выбора действий в админ-панели.

### `admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession)`

**Назначение**:  Функция отображает статистику бота, включая количество пользователей, новых пользователей за различные периоды времени, и статистику по заказам.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `session_without_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Использует `UserDAO.get_statistics` для получения статистики по пользователям.
- Использует `PurchaseDao.get_payment_stats` для получения статистики по платежам.
- Формирует сообщение с полученной статистикой и отправляет его пользователю.

### `admin_process_cancel(call: CallbackQuery, state: FSMContext)`

**Назначение**:  Функция отменяет текущую операцию добавления товара.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Очищает состояние `state`.
- Отправляет сообщение об отмене операции добавления товара.

### `admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession)`

**Назначение**:  Функция запускает режим удаления товаров.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `session_without_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Получает список всех товаров из базы данных с помощью `ProductDao.find_all`.
- Отправляет сообщения с описанием каждого товара, добавляя кнопку для его удаления.

### `admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession)`

**Назначение**:  Функция удаляет товар по указанному ID.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `session_with_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Извлекает ID товара из `call.data`.
- Удаляет товар из базы данных с помощью `ProductDao.delete`.
- Отправляет сообщение об успешном удалении товара.

### `admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession)`

**Назначение**:  Функция запускает режим управления товарами.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `session_without_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Получает количество товаров из базы данных с помощью `ProductDao.count`.
- Отправляет сообщение с кнопками для выбора действия с товарами (добавление, удаление).

### `admin_process_add_product(call: CallbackQuery, state: FSMContext)`

**Назначение**:  Функция запускает сценарий добавления нового товара.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Устанавливает состояние сценария `state` в `AddProduct.name`.
- Отправляет сообщение с просьбой ввести имя товара.

### `admin_process_name(message: Message, state: FSMContext)`

**Назначение**:  Функция обрабатывает ввод имени товара.

**Параметры**:

- `message` (Message): Объект, представляющий сообщение от пользователя.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Сохраняет введенное имя товара в `state`.
- Устанавливает состояние сценария `state` в `AddProduct.description`.
- Отправляет сообщение с просьбой ввести описание товара.

### `admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession)`

**Назначение**:  Функция обрабатывает ввод описания товара.

**Параметры**:

- `message` (Message): Объект, представляющий сообщение от пользователя.
- `state` (FSMContext): Объект состояния для управления сценарием.
- `session_without_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Сохраняет введенное описание товара в `state`.
- Получает список категорий товаров из базы данных с помощью `CategoryDao.find_all`.
- Устанавливает состояние сценария `state` в `AddProduct.category_id`.
- Отправляет сообщение с кнопками для выбора категории товара.

### `admin_process_category(call: CallbackQuery, state: FSMContext)`

**Назначение**:  Функция обрабатывает выбор категории товара.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Извлекает ID выбранной категории из `call.data`.
- Сохраняет ID категории в `state`.
- Устанавливает состояние сценария `state` в `AddProduct.price`.
- Отправляет сообщение с просьбой ввести цену товара.

### `admin_process_price(message: Message, state: FSMContext)`

**Назначение**:  Функция обрабатывает ввод цены товара.

**Параметры**:

- `message` (Message): Объект, представляющий сообщение от пользователя.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Проверяет, является ли введенное значение целым числом.
- Сохраняет цену товара в `state`.
- Устанавливает состояние сценария `state` в `AddProduct.file_id`.
- Отправляет сообщение с просьбой отправить файл или выбрать опцию "БЕЗ ФАЙЛА".

### `admin_process_without_file(call: CallbackQuery, state: FSMContext)`

**Назначение**:  Функция обрабатывает выбор опции "БЕЗ ФАЙЛА" при добавлении товара.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Сохраняет `None` в `state` в качестве file_id.
- Устанавливает состояние сценария `state` в `AddProduct.hidden_content`.
- Отправляет сообщение с просьбой ввести скрытый контент.

### `admin_process_without_file(message: Message, state: FSMContext)`

**Назначение**:  Функция обрабатывает отправку файла при добавлении товара.

**Параметры**:

- `message` (Message): Объект, представляющий сообщение от пользователя.
- `state` (FSMContext): Объект состояния для управления сценарием.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Сохраняет ID отправленного файла в `state`.
- Устанавливает состояние сценария `state` в `AddProduct.hidden_content`.
- Отправляет сообщение с просьбой ввести скрытый контент.

### `admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession)`

**Назначение**:  Функция обрабатывает ввод скрытого контента.

**Параметры**:

- `message` (Message): Объект, представляющий сообщение от пользователя.
- `state` (FSMContext): Объект состояния для управления сценарием.
- `session_without_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Сохраняет введенный скрытый контент в `state`.
- Получает информацию о выбранной категории из базы данных с помощью `CategoryDao.find_one_or_none_by_id`.
- Формирует сообщение с описанием товара и кнопкой "Подтвердить".
- Устанавливает состояние сценария `state` в `AddProduct.confirm_add`.

### `admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession)`

**Назначение**:  Функция подтверждает добавление товара в базу данных.

**Параметры**:

- `call` (CallbackQuery): Объект, представляющий запрос CallbackQuery.
- `state` (FSMContext): Объект состояния для управления сценарием.
- `session_with_commit` (AsyncSession): Объект асинхронной сессии для взаимодействия с базой данных.

**Возвращает**:

- `None`: Не возвращает значения.

**Как работает**:

- Извлекает данные товара из `state`.
- Добавляет товар в базу данных с помощью `ProductDao.add`.
- Отправляет сообщение об успешном добавлении товара.