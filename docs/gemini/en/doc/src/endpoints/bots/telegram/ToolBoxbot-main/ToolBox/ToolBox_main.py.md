# Модуль `ToolBox_main.py`

## Обзор

Модуль `ToolBox_main.py` является основным модулем для Telegram-бота `ToolBox`, который предоставляет пользователям различные инструменты для генерации текста и изображений. Он обрабатывает команды, запросы и платежи, а также управляет подписками пользователей.

## Подробнее

Модуль инициализирует и настраивает Telegram-бота, подключается к базе данных для хранения данных пользователей и обрабатывает различные типы запросов, включая текстовые команды, запросы изображений и платежи. Он также включает логику для управления тарифными планами и проверки времени окончания подписки.

## Классы

### `DataBase`

**Описание**: Класс для управления базой данных пользователей.

**Наследует**:

**Атрибуты**:
    - `db_name` (str): Имя файла базы данных.
    - `table_name` (str): Имя таблицы в базе данных.
    - `titles` (dict): Словарь, содержащий заголовки столбцов таблицы базы данных.

**Методы**:
    - `create()`: Создает таблицу в базе данных, если она не существует.
    - `load_data_from_db()`: Загружает данные из базы данных в словарь.
    - `insert_or_update_data(user_id, data)`: Вставляет или обновляет данные пользователя в базе данных.

### `ToolBox`

**Описание**: Класс, содержащий различные методы и функции для обработки запросов пользователей. Более подробное описание функциональности смотрите в документации к соответствующим модулям.

**Наследует**:

**Атрибуты**:
    - `bot`: Объект Telegram-бота.
    - `data`: Список данных для обработки.
    - Различные параметры конфигурации и обработчики.

**Методы**:
   - `start_request(message)`: Обрабатывает команду `/start` и отправляет приветственное сообщение пользователю.
   - `Text_types(message)`: Отправляет пользователю список типов текстов для генерации.
   - `ImageSize(message)`: Отправляет пользователю список размеров изображений для генерации.
   - `FreeArea(message)`: Активирует бесплатный режим для пользователя.
   - `TariffArea(message)`: Отправляет пользователю информацию о доступных тарифах.
   - `Basic_tariff(message)`: Обрабатывает запрос на подключение базового тарифа.
   - `Pro_tariff(message)`: Обрабатывает запрос на подключение профессионального тарифа.
   - `TariffExit(message)`: Выводит из области выбора тарифа.
   - `OneTextArea(message, index)`: Обрабатывает запрос на генерацию одного текста.
   - `SomeTextsArea(message, index)`: Обрабатывает запрос на генерацию нескольких текстов.
   - `FreeCommand(message, sessions_messages)`: Обрабатывает команду в бесплатном режиме.
   - `TextCommands(message, i)`: Обрабатывает команду для генерации текста определенного типа.
   - `SomeTextsCommand(message, i)`: Обрабатывает команду для генерации нескольких текстов определенного типа.
   - `ImageCommand(message, prompt, size)`: Обрабатывает команду для генерации изображения.
   - `Image_Regen_And_Upscale(message, prompt, size, seed, timeout)`: Генерирует изображение и увеличивает его разрешение.
   - `BeforeUpscale(message)`: Отправляет сообщение перед увеличением разрешения изображения.
   - `ImageChange(message)`: Выводит информацию о сгенерированном изображении.
   - `FreeTariffEnd(message)`: Выводит сообщение об окончании бесплатного тарифа.
   - `TarrifEnd(message)`: Выводит сообщение об окончании тарифа.
   - `restart(message)`: Перезапускает бота.
   - `restart_markup(message)`: Перезапускает разметку бота.

## Функции

### `process_pre_checkout_query(pre_checkout_query)`

**Назначение**: Обрабатывает предварительный запрос перед оплатой.

**Параметры**:
   - `pre_checkout_query` (telebot.types.PreCheckoutQuery): Объект запроса перед оплатой.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция отвечает на предварительный запрос перед оплатой, подтверждая возможность проведения платежа.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   process_pre_checkout_query(pre_checkout_query)
   ```

### `successful_payment(message)`

**Назначение**: Обрабатывает успешный платеж.

**Параметры**:
   - `message` (telebot.types.Message): Объект сообщения с информацией об успешном платеже.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из сообщения.
   - Определяет, какой тариф был оплачен (basic или pro).
   - Активирует соответствующие параметры подписки для пользователя в базе данных.
   - Начисляет токены пользователю.
   - Устанавливает дату окончания подписки.
   - Обновляет данные пользователя в базе данных.
   - Отправляет пользователю сообщение об успешной активации подписки.
   - Перезапускает бота для пользователя.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   successful_payment(message)
   ```

### `StartProcessing(message)`

**Назначение**: Обрабатывает команду `/start`.

**Параметры**:
   - `message` (telebot.types.Message): Объект сообщения с командой `/start`.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из сообщения.
   - Инициализирует данные пользователя, если их нет в базе данных, или загружает существующие данные.
   - Обновляет или вставляет данные пользователя в базу данных.
   - Вызывает функцию `start_request` из объекта `tb` для отправки стартового сообщения пользователю.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   StartProcessing(message)
   ```

### `personal_account(message)`

**Назначение**: Отображает информацию о тарифном плане пользователя.

**Параметры**:
   - `message` (telebot.types.Message): Объект сообщения с командой `/profile`.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из сообщения.
   - Проверяет, какой тарифный план активен у пользователя (basic, pro или отсутствие подписки).
   - Отправляет пользователю сообщение с информацией о его тарифном плане.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   personal_account(message)
   ```

### `show_stat(message)`

**Назначение**: Отображает статистику бота (только для администраторов).

**Параметры**:
   - `message` (telebot.types.Message): Объект сообщения с командой `/stat`.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из сообщения.
   - Проверяет, является ли пользователь администратором (ID пользователя находится в списке разрешенных).
   - Отправляет пользователю сообщение со статистикой бота, включая общее количество пользователей и количество пользователей с промокодом.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   show_stat(message)
   ```

### `generate_promo_code(length)`

**Назначение**: Генерирует случайный промокод заданной длины.

**Параметры**:
   - `length` (int): Длина промокода.

**Возвращает**:
   - `str`: Сгенерированный промокод.

**Как работает**:
   - Функция генерирует случайный промокод заданной длины, используя символы из `string.ascii_letters` и `string.digits`.

**Примеры**:
   ```python
   # Пример вызова функции
   promo_code = generate_promo_code(10)
   print(promo_code)  # Вывод: случайный промокод длиной 10 символов
   ```

### `CallsProcessing(call)`

**Назначение**: Обрабатывает callback-запросы от кнопок в Telegram-боте.

**Параметры**:
   - `call` (telebot.types.CallbackQuery): Объект callback-запроса.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из callback-запроса.
   - Создает данные пользователя, если их нет в базе данных.
   - Определяет, какая кнопка была нажата, и выполняет соответствующие действия.
   - Обновляет данные пользователя в базе данных.
   - Вызывает различные методы объекта `tb` для обработки запроса.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   CallsProcessing(call)
   ```

### `TokensCancelletionPattern(user_id, func, message, i=None)`

**Назначение**: Обрабатывает списание токенов или бесплатных запросов для пользователя.

**Параметры**:
   - `user_id` (str): ID пользователя.
   - `func` (callable): Функция для обработки запроса (генерация текста или изображения).
   - `message` (telebot.types.Message): Объект сообщения.
   - `i` (int, optional): Индекс для текстовых команд. По умолчанию `None`.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает информацию о токенах и бесплатных запросах пользователя из базы данных.
   - Проверяет, достаточно ли токенов или бесплатных запросов для выполнения запроса.
   - Вызывает функцию `func` для обработки запроса.
   - Списывает токены или бесплатные запросы.
   - Обновляет данные пользователя в базе данных.
   - Если токены или бесплатные запросы закончились, отправляет пользователю сообщение об окончании тарифа.

**Примеры**:
   ```python
   # Пример вызова функции
   TokensCancelletionPattern(user_id, tb.TextCommands, message, 0)
   ```

### `TasksProcessing(message)`

**Назначение**: Обрабатывает входящие текстовые сообщения и фотографии от пользователя.

**Параметры**:
   - `message` (telebot.types.Message): Объект сообщения.

**Возвращает**:
   - `None`

**Как работает**:
   - Функция извлекает ID пользователя из сообщения.
   - Обрабатывает запросы на генерацию изображений, если они активны.
   - Обрабатывает сообщения в бесплатном режиме.
   - Обрабатывает текстовые команды.
   - Обновляет данные пользователя в базе данных.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически библиотекой telebot)
   TasksProcessing(message)
   ```

### `end_check_tariff_time()`

**Назначение**: Проверяет время окончания действия тарифа для всех пользователей.

**Параметры**:
   - `None`

**Возвращает**:
   - `None`

**Как работает**:
   - Функция асинхронно проверяет для каждого пользователя в базе данных, не истекло ли время действия его тарифа.
   - Если время истекло, обнуляет параметры подписки пользователя.
   - Обновляет данные пользователя в базе данных.
   - Функция выполняется в бесконечном цикле с интервалом в 10 секунд.

**Примеры**:
   ```python
   # Пример вызова функции (обычно вызывается автоматически asyncio.run())
   asyncio.run(end_check_tariff_time())
   ```

## Запуск бота

В блоке `if __name__ == "__main__":` запускается бот в отдельном потоке и асинхронно выполняется проверка времени окончания действия тарифа.
```python
if __name__ == "__main__":
    Thread(target=bot.infinity_polling).start()
    asyncio.run(end_check_tariff_time())