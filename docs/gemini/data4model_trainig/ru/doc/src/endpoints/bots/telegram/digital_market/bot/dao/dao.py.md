# Модуль для работы с базой данных бота цифрового рынка
========================================================

Модуль содержит классы DAO (Data Access Object) для взаимодействия с базой данных,
включая модели пользователей, покупок, категорий и продуктов.

## Обзор

Этот модуль предоставляет Data Access Object (DAO) для работы с базой данных бота цифрового рынка.
Он включает классы для выполнения операций CRUD (Create, Read, Update, Delete)
для моделей `User`, `Purchase`, `Category` и `Product`.
Кроме того, модуль содержит методы для получения статистической информации о пользователях и покупках.

## Подробней

Модуль использует SQLAlchemy для взаимодействия с базой данных.
Классы DAO наследуются от базового класса `BaseDAO`, который предоставляет общую функциональность
для работы с моделями базы данных.
Модуль также использует `loguru` для логирования событий и ошибок.

## Содержание

- [Классы](#классы)
    - [UserDAO](#userdao)
        - [Метод `get_purchase_statistics`](#get_purchase_statistics)
        - [Метод `get_purchased_products`](#get_purchased_products)
        - [Метод `get_statistics`](#get_statistics)
    - [PurchaseDao](#purchasedao)
        - [Метод `get_payment_stats`](#get_payment_stats)
        - [Метод `get_full_summ`](#get_full_summ)
        - [Метод `get_next_id`](#get_next_id)
    - [CategoryDao](#categorydao)
    - [ProductDao](#productdao)

## Классы

### `UserDAO`

**Описание**:
Класс для доступа к данным пользователей.

**Наследует**:
`BaseDAO[User]` - расширяет базовый класс DAO для выполнения операций с моделью `User`.

**Методы**:
- `get_purchase_statistics`: Получает статистику покупок пользователя.
- `get_purchased_products`: Получает список приобретенных пользователем продуктов.
- `get_statistics`: Получает общую статистику по пользователям (общее количество, новые за сегодня, неделю, месяц).

#### `get_purchase_statistics`

```python
@classmethod
async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
    """
    Получает статистику покупок пользователя.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Telegram ID пользователя.

    Returns:
        Optional[Dict[str, int]]: Словарь со статистикой покупок пользователя
        (общее количество покупок и общая сумма). Возвращает `None` в случае ошибки или отсутствия данных.

    """
    ...
```

**Назначение**:
Получает статистику о покупках пользователя, включая общее количество покупок и общую сумму потраченных средств.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.
- `telegram_id` (int): Уникальный идентификатор пользователя в Telegram.

**Возвращает**:
- `Optional[Dict[str, int]]`: Словарь, содержащий статистику покупок пользователя.
  - `'total_purchases'` (int): Общее количество покупок.
  - `'total_amount'` (int): Общая сумма потраченных средств.
  Возвращает `None`, если пользователь не найден или произошла ошибка при выполнении запроса.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при выполнении запроса к базе данных.

**Как работает функция**:
1. Формирует SQL-запрос, который подсчитывает общее количество покупок и общую сумму покупок для заданного `telegram_id`.
2. Выполняет запрос в асинхронной сессии базы данных.
3. Обрабатывает результат запроса, извлекая общее количество покупок и общую сумму.
4. Возвращает словарь, содержащий извлеченную статистику.
5. В случае возникновения ошибки SQLAlchemy при выполнении запроса, печатает сообщение об ошибке и возвращает `None`.
6. Если `total_amount` равно `None`, устанавливает значение `0`.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
telegram_id = 123456789
stats = await UserDAO.get_purchase_statistics(session, telegram_id)
if stats:
    print(f"Total purchases: {stats['total_purchases']}")
    print(f"Total amount: {stats['total_amount']}")
else:
    print("No purchase statistics found for this user.")
```

#### `get_purchased_products`

```python
    @classmethod
    async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
        """
        Получает список приобретенных пользователем продуктов.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): Telegram ID пользователя.

        Returns:
            Optional[List[Purchase]]: Список покупок пользователя. Возвращает `None` в случае ошибки или отсутствия данных.

        """
        ...
```

**Назначение**:
Извлекает список всех покупок, совершенных пользователем с указанным `telegram_id`.
Каждая покупка включает информацию о продукте.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.
- `telegram_id` (int): Уникальный идентификатор пользователя в Telegram.

**Возвращает**:
- `Optional[List[Purchase]]`: Список объектов `Purchase`, представляющих покупки пользователя.
  Каждый объект `Purchase` содержит информацию о продукте.
  Возвращает `None`, если пользователь не найден или произошла ошибка при выполнении запроса.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при выполнении запроса к базе данных.

**Как работает функция**:
1. Формирует SQL-запрос, который извлекает пользователя с указанным `telegram_id`
   и загружает связанные с ним покупки и продукты.
2. Выполняет запрос в асинхронной сессии базы данных.
3. Извлекает объект пользователя из результата запроса.
4. Если пользователь не найден, возвращает `None`.
5. Если пользователь найден, возвращает список его покупок.
6. В случае возникновения ошибки SQLAlchemy при выполнении запроса, печатает сообщение об ошибке и возвращает `None`.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
telegram_id = 123456789
purchases = await UserDAO.get_purchased_products(session, telegram_id)
if purchases:
    for purchase in purchases:
        print(f"Product: {purchase.product.name}, Price: {purchase.price}")
else:
    print("No purchases found for this user.")
```

#### `get_statistics`

```python
    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        """
        Получает общую статистику по пользователям.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            dict: Словарь со статистикой по пользователям.

        Raises:
            SQLAlchemyError: Если возникает ошибка при получении статистики.

        """
        ...
```

**Назначение**:
Получает общую статистику по пользователям, включая общее количество пользователей,
количество новых пользователей за сегодня, за последнюю неделю и за последний месяц.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.

**Возвращает**:
- `dict`: Словарь, содержащий статистику по пользователям.
  - `'total_users'` (int): Общее количество пользователей.
  - `'new_today'` (int): Количество новых пользователей, зарегистрированных сегодня.
  - `'new_week'` (int): Количество новых пользователей, зарегистрированных за последнюю неделю.
  - `'new_month'` (int): Количество новых пользователей, зарегистрированных за последний месяц.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при выполнении запроса к базе данных.

**Как работает функция**:
1. Получает текущую дату и время в UTC.
2. Формирует SQL-запрос, который подсчитывает общее количество пользователей,
   количество новых пользователей за сегодня, за последнюю неделю и за последний месяц.
3. Выполняет запрос в асинхронной сессии базы данных.
4. Извлекает результаты запроса.
5. Формирует словарь, содержащий извлеченную статистику.
6. Логирует информацию об успешном получении статистики.
7. Возвращает словарь со статистикой.
8. В случае возникновения ошибки SQLAlchemy при выполнении запроса, логирует сообщение об ошибке и вызывает исключение.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
statistics = await UserDAO.get_statistics(session)
print(f"Total users: {statistics['total_users']}")
print(f"New today: {statistics['new_today']}")
print(f"New week: {statistics['new_week']}")
print(f"New month: {statistics['new_month']}")
```

### `PurchaseDao`

**Описание**:
Класс для доступа к данным о покупках.

**Наследует**:
`BaseDAO[Purchase]` - расширяет базовый класс DAO для выполнения операций с моделью `Purchase`.

**Методы**:
- `get_payment_stats`: Получает статистику по типам оплат.
- `get_full_summ`: Получает общую сумму всех покупок.
- `get_next_id`: Получает следующий доступный ID для новой покупки.

#### `get_payment_stats`

```python
    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """
        Получает статистику по типам оплат.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            str: Отформатированная строка со статистикой по типам оплат.

        """
        ...
```

**Назначение**:
Получает статистику о типах оплат, используемых при совершении покупок,
и возвращает ее в виде отформатированной строки.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.

**Возвращает**:
- `str`: Отформатированная строка, содержащая статистику по типам оплат (Юкасса, Робокасса, STARS).

**Вызывает исключения**:
- Отсутствуют явные исключения, но могут возникнуть исключения SQLAlchemyError при работе с базой данных.

**Как работает функция**:
1. Формирует SQL-запрос, который группирует покупки по типу оплаты и вычисляет общую сумму для каждого типа оплаты.
2. Выполняет запрос в асинхронной сессии базы данных.
3. Обрабатывает результаты запроса, формируя словарь, где ключами являются типы оплат, а значениями - общие суммы.
4. Форматирует словарь в строку, содержащую статистику по типам оплат.
5. Возвращает отформатированную строку.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
payment_stats = await PurchaseDao.get_payment_stats(session)
print(payment_stats)
```

#### `get_full_summ`

```python
    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """
        Получает общую сумму всех покупок.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            int: Общая сумма всех покупок.

        """
        ...
```

**Назначение**:
Вычисляет и возвращает общую сумму всех покупок, хранящихся в базе данных.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.

**Возвращает**:
- `int`: Общая сумма всех покупок. Если в базе данных нет покупок, возвращает 0.

**Вызывает исключения**:
- Отсутствуют явные исключения, но могут возникнуть исключения SQLAlchemyError при работе с базой данных.

**Как работает функция**:
1. Формирует SQL-запрос, который вычисляет общую сумму всех покупок.
2. Выполняет запрос в асинхронной сессии базы данных.
3. Извлекает результат запроса.
4. Если результат запроса равен `None`, возвращает 0.
5. В противном случае возвращает общую сумму покупок.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
full_summ = await PurchaseDao.get_full_summ(session)
print(f"Full sum: {full_summ}")
```

#### `get_next_id`

```python
    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        Возвращает следующий свободный ID для новой записи.

        :param session: Асинхронная сессия базы данных
        :return: Следующий свободный ID
        """
        ...
```

**Назначение**:
Определяет и возвращает следующий доступный ID для новой записи в таблице `Purchase`.
Используется для предотвращения конфликтов при добавлении новых данных.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных для выполнения запросов.

**Возвращает**:
- `int`: Следующий свободный ID. Если таблица пуста, возвращает 1.

**Вызывает исключения**:
- Отсутствуют явные исключения, но могут возникнуть исключения SQLAlchemyError при работе с базой данных.

**Как работает функция**:
1. Формирует SQL-запрос, который определяет максимальный ID в таблице `Purchase` и добавляет к нему 1.
   Если таблица пуста, возвращает 1.
2. Выполняет запрос в асинхронной сессии базы данных.
3. Извлекает результат запроса.
4. Возвращает следующий свободный ID.

```python
    async def inner_function():
        """ Внутрняя функция не используется """
```

**Примеры**:

```python
# Пример вызова функции
next_id = await PurchaseDao.get_next_id(session)
print(f"Next ID: {next_id}")
```

### `CategoryDao`

**Описание**:
Класс для доступа к данным о категориях.

**Наследует**:
`BaseDAO[Category]` - расширяет базовый класс DAO для выполнения операций с моделью `Category`.

**Методы**:
- Отсутствуют специфические методы, используются методы базового класса `BaseDAO`.

### `ProductDao`

**Описание**:
Класс для доступа к данным о продуктах.

**Наследует**:
`BaseDAO[Product]` - расширяет базовый класс DAO для выполнения операций с моделью `Product`.

**Методы**:
- Отсутствуют специфические методы, используются методы базового класса `BaseDAO`.