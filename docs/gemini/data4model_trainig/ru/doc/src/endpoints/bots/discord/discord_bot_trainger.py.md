# Модуль discord_bot_trainger.py

## Обзор

Модуль `discord_bot_trainger.py` предназначен для создания и управления Discord-ботом, который может выполнять различные задачи, такие как:
- Приветствие пользователей.
- Подключение и отключение от голосовых каналов.
- Обучение модели на основе предоставленных данных.
- Тестирование модели с использованием тестовых данных.
- Архивирование файлов в указанном каталоге.
- Выбор набора данных для обучения модели.
- Отображение инструкций из внешнего файла.
- Коррекция предыдущих ответов бота.
- Сбор обратной связи от пользователей.
- Отправка файлов пользователям.
- Распознавание речи в аудиофайлах и воспроизведение текста в голосовом канале.

## Подробней

Этот модуль является частью проекта `hypotez` и реализует функциональность Discord-бота, который взаимодействует с пользователями через текстовые и голосовые каналы. Бот использует библиотеку `discord.py` для интеграции с Discord API и выполняет задачи, связанные с обучением и тестированием AI-моделей. Модуль включает в себя обработку команд, обучение модели, тестирование модели, архивирование файлов, выбор набора данных, отображение инструкций, коррекцию ответов, сбор обратной связи, отправку файлов, распознавание речи и воспроизведение текста в голосовом канале.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `on_ready`

```python
@bot.event
async def on_ready():
    """Called when the bot is ready."""
    ...
```

**Назначение**: Вызывается, когда бот успешно подключился к Discord.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция логирует информацию о том, что бот успешно подключился к Discord, используя `logger.info`.

**Примеры**:
```python
# Пример вызова функции on_ready
# Функция вызывается автоматически при подключении бота к Discord.
```

### `hi`

```python
@bot.command(name='hi')
async def hi(ctx):
    """Welcome message."""
    ...
```

**Назначение**: Отправляет приветственное сообщение в канал, из которого была вызвана команда.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.

**Возвращает**:
- `bool`: `True` в случае успешного выполнения.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция логирует информацию о вызове команды `hi` с использованием `logger.info` и отправляет сообщение "HI!" в канал, из которого была вызвана команда.

**Примеры**:
```python
# Пример вызова команды hi
# !hi
```

### `join`

```python
@bot.command(name='join')
async def join(ctx):
    """Connect the bot to the voice channel."""
    ...
```

**Назначение**: Подключает бота к голосовому каналу, в котором находится пользователь, вызвавший команду.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция проверяет, находится ли пользователь в голосовом канале. Если да, то бот подключается к этому каналу и отправляет сообщение об успешном подключении. Если пользователь не находится в голосовом канале, бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды join
# !join
```

### `leave`

```python
@bot.command(name='leave')
async def leave(ctx):
    """Disconnect the bot from the voice channel."""
    ...
```

**Назначение**: Отключает бота от текущего голосового канала.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция проверяет, подключен ли бот к голосовому каналу. Если да, то бот отключается от этого канала и отправляет сообщение об успешном отключении. Если бот не подключен к голосовому каналу, бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды leave
# !leave
```

### `train`

```python
@bot.command(name='train')
async def train(ctx, data: str = None, data_dir: str = None, positive: bool = True, attachment: discord.Attachment = None):
    """Train the model with the provided data."""
    ...
```

**Назначение**: Запускает обучение модели с использованием предоставленных данных.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `data` (str, optional): Текстовые данные для обучения модели. По умолчанию `None`.
- `data_dir` (str, optional): Путь к каталогу с данными для обучения модели. По умолчанию `None`.
- `positive` (bool, optional): Указывает, являются ли предоставленные данные положительными или отрицательными. По умолчанию `True`.
- `attachment` (discord.Attachment, optional): Файл с данными для обучения модели. По умолчанию `None`.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция проверяет, был ли предоставлен файл для обучения модели. Если да, то файл сохраняется во временный каталог. Затем функция вызывает метод `train` объекта `model` для запуска обучения модели. Если обучение запущено успешно, бот отправляет сообщение с идентификатором задачи. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды train с текстовыми данными
# !train data="Some training data"

# Пример вызова команды train с файлом
# !train attachment=file.txt
```

### `test`

```python
@bot.command(name='test')
async def test(ctx, test_data: str):
    """Test the model with the provided test data."""
    ...
```

**Назначение**: Запускает тестирование модели с использованием предоставленных данных.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `test_data` (str): Данные для тестирования модели в формате JSON.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- `json.JSONDecodeError`: Если предоставленные данные не являются валидным JSON.

**Как работает функция**:
Функция пытается загрузить данные для тестирования модели из JSON-строки. Затем функция вызывает метод `predict` объекта `model` для получения предсказаний модели. Если предсказания получены успешно, бот отправляет сообщение с предсказаниями. В противном случае бот отправляет сообщение об ошибке. Если предоставленные данные не являются валидным JSON, бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды test
# !test test_data='{"key": "value"}'
```

### `archive`

```python
@bot.command(name='archive')
async def archive(ctx, directory: str):
    """Archive files in the specified directory."""
    ...
```

**Назначение**: Архивирует файлы в указанном каталоге.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `directory` (str): Путь к каталогу, файлы в котором необходимо архивировать.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при архивировании файлов.

**Как работает функция**:
Функция вызывает метод `archive_files` объекта `model` для архивирования файлов в указанном каталоге. Если архивирование выполнено успешно, бот отправляет сообщение об успешном архивировании. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды archive
# !archive directory="/path/to/directory"
```

### `select_dataset`

```python
@bot.command(name='select_dataset')
async def select_dataset(ctx, path_to_dir_positive: str, positive: bool = True):
    """Select a dataset for training the model."""
    ...
```

**Назначение**: Выбирает набор данных для обучения модели.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `path_to_dir_positive` (str): Путь к каталогу с положительными данными для обучения модели.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция вызывает метод `select_dataset_and_archive` объекта `model` для выбора набора данных и его архивирования. Если выбор набора данных выполнен успешно, бот отправляет сообщение с информацией о выбранном наборе данных. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды select_dataset
# !select_dataset path_to_dir_positive="/path/to/dataset"
```

### `instruction`

```python
@bot.command(name='instruction')
async def instruction(ctx):
    """Display the instruction message from an external file."""
    ...
```

**Назначение**: Отображает инструкции из внешнего файла.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при чтении файла с инструкциями.

**Как работает функция**:
Функция пытается прочитать файл с инструкциями по указанному пути. Если файл существует, бот отправляет содержимое файла в канал. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды instruction
# !instruction
```

### `correct`

```python
@bot.command(name='correct')
async def correct(ctx, message_id: int, *, correction: str):
    """Correct a previous response by providing the message ID and the correction."""
    ...
```

**Назначение**: Корректирует предыдущий ответ бота, предоставляя идентификатор сообщения и исправление.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `message_id` (int): Идентификатор сообщения, которое необходимо исправить.
- `correction` (str): Текст исправления.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при получении сообщения или сохранении исправления.

**Как работает функция**:
Функция пытается получить сообщение по указанному идентификатору. Если сообщение найдено, функция логирует информацию об исправлении и сохраняет исправление с использованием функции `store_correction`. Затем бот отправляет сообщение об успешном получении исправления. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды correct
# !correct message_id=1234567890 correction="This is the corrected text"
```

### `store_correction`

```python
def store_correction(original_text: str, correction: str):
    """Store the correction for future reference or retraining."""
    ...
```

**Назначение**: Сохраняет исправление для дальнейшего использования или переобучения модели.

**Параметры**:
- `original_text` (str): Оригинальный текст сообщения.
- `correction` (str): Текст исправления.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция логирует информацию о вызове функции `store_correction` и сохраняет оригинальный текст и исправление в файл `corrections_log.txt`.

**Примеры**:
```python
# Пример вызова функции store_correction
# store_correction("Original text", "Corrected text")
```

### `feedback`

```python
@bot.command(name='feedback')
async def feedback(ctx, *, feedback_text: str):
    """Submit feedback about the model's response."""
    ...
```

**Назначение**: Отправляет отзыв о ответе модели.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `feedback_text` (str): Текст отзыва.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция логирует информацию о вызове команды `feedback` и сохраняет отзыв с использованием функции `store_correction`. Затем бот отправляет сообщение благодарности за отзыв.

**Примеры**:
```python
# Пример вызова команды feedback
# !feedback This is some feedback about the model's response
```

### `getfile`

```python
@bot.command(name='getfile')
async def getfile(ctx, file_path: str):
    """Attach a file from the given path."""
    ...
```

**Назначение**: Прикрепляет файл из указанного пути к сообщению.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и сервере.
- `file_path` (str): Путь к файлу, который необходимо прикрепить.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция логирует информацию о вызове команды `getfile` и проверяет, существует ли файл по указанному пути. Если файл существует, бот отправляет сообщение с прикрепленным файлом. В противном случае бот отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова команды getfile
# !getfile file_path="/path/to/file.txt"
```

### `text_to_speech_and_play`

```python
async def text_to_speech_and_play(text, channel):
    """Convert text to speech and play it in a voice channel."""
    ...
```

**Назначение**: Преобразует текст в речь и воспроизводит его в голосовом канале.

**Параметры**:
- `text` (str): Текст, который необходимо преобразовать в речь.
- `channel` (discord.VoiceChannel): Голосовой канал, в котором необходимо воспроизвести речь.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция использует библиотеку `gTTS` для преобразования текста в речь и сохраняет аудиофайл во временный каталог. Затем функция подключается к голосовому каналу и воспроизводит аудиофайл. После завершения воспроизведения функция отключается от голосового канала. В процессе воспроизведения логируется информация о завершении воспроизведения с использованием `logger.info`.

**Примеры**:
```python
# Пример вызова функции text_to_speech_and_play
# await text_to_speech_and_play("Hello, world!", channel)
```

### `on_message`

```python
@bot.event
async def on_message(message):
    """Handle incoming messages and respond to voice commands."""
    ...
```

**Назначение**: Обрабатывает входящие сообщения и отвечает на голосовые команды.

**Параметры**:
- `message` (discord.Message): Входящее сообщение.

**Возвращает**:
- Ничего.

**Вызывает исключения**:
- Отсутствуют.

**Как работает функция**:
Функция проверяет, является ли автор сообщения ботом. Если да, то сообщение игнорируется. Если сообщение начинается с префикса команды, то сообщение обрабатывается как команда. Если сообщение содержит вложения, то проверяется, является ли вложение аудиофайлом. Если да, то аудиофайл распознается и отправляется ответ. В противном случае сообщение отправляется модели для получения ответа. Если пользователь находится в голосовом канале, то ответ воспроизводится в голосовом канале. В противном случае ответ отправляется в текстовый канал.

**Примеры**:
```python
# Пример вызова функции on_message
# Функция вызывается автоматически при получении нового сообщения в Discord.
```

## Параметры модуля

- `path_to_ffmpeg` (str): Путь к исполняемому файлу `ffmpeg`.
- `PREFIX` (str): Префикс для команд бота (по умолчанию `!`).
- `intents` (discord.Intents): Настройки интентов Discord для бота.
- `bot` (discord.ext.commands.Bot): Объект бота Discord.
- `model` (src.ai.openai.model.training.Model): Объект модели для обучения и тестирования.

## Примеры

Запуск бота:

```python
if __name__ == "__main__":
    bot.run(gs.credentials.discord.bot_token)
```

Этот код запускает бота с использованием токена, хранящегося в `gs.credentials.discord.bot_token`.