# Модуль ToolBox_requests.py

## Обзор

Модуль `ToolBox_requests.py` содержит класс `ToolBox`, который является основным классом для обработки запросов от Telegram-бота. Класс включает в себя методы для обработки текстовых и графических запросов, управления тарифами и взаимодействия с нейронными сетями.

## Подробней

Этот модуль является центральным звеном в обработке запросов пользователей Telegram-бота. Он использует другие модули для выполнения конкретных задач, таких как генерация текста и изображений с использованием нейронных сетей. Класс `ToolBox` инициализирует основные параметры бота, загружает текстовые подсказки (prompts) и определяет обработчики для различных типов запросов.

## Классы

### `ToolBox`

**Описание**: Основной класс для обработки запросов от Telegram-бота.

**Наследует**:
- `keyboards`: Предоставляет методы для создания клавиатур.
- `neural_networks`: Предоставляет методы для взаимодействия с нейронными сетями.

**Атрибуты**:
- `name` (list): Список названий основных кнопок меню.
- `data` (list): Список данных, связанных с основными кнопками меню.
- `prompts_text` (dict): Словарь с текстовыми подсказками (prompts) для различных запросов.
- `bot` (telebot.TeleBot): Экземпляр Telegram-бота.
- `keyboard_blank` (lambda): Лямбда-функция для создания inline-клавиатур.
- `reply_keyboard` (lambda): Лямбда-функция для создания markup-клавиатур.
- `__delay` (lambda): Лямбда-функция для отправки уведомления о задержке.
- `start_request` (lambda): Лямбда-функция для обработки стартового запроса.
- `restart` (lambda): Лямбда-функция для перезапуска бота.
- `restart_markup` (lambda): Лямбда-функция для перезапуска бота с редактированием сообщения.
- `OneTextArea` (lambda): Лямбда-функция для отправки запроса с одним текстовым полем.
- `SomeTextsArea` (lambda): Лямбда-функция для отправки запроса с несколькими текстовыми полями.
- `ImageSize` (lambda): Лямбда-функция для выбора размера изображения.
- `ImageArea` (lambda): Лямбда-функция для отправки запроса на генерацию изображения.
- `ImageChange` (lambda): Лямбда-функция для выбора действия после генерации изображения.
- `BeforeUpscale` (lambda): Лямбда-функция для выбора действия перед улучшением качества изображения.
- `FreeArea` (lambda): Лямбда-функция для отправки запроса в свободном режиме.
- `TariffArea` (lambda): Лямбда-функция для отображения информации о тарифах.
- `TariffExit` (lambda): Лямбда-функция для выхода из раздела тарифов.
- `TarrifEnd` (lambda): Лямбда-функция для уведомления об окончании тарифного плана.
- `FreeTariffEnd` (lambda): Лямбда-функция для уведомления об окончании бесплатных запросов.
- `SomeTexts` (lambda): Лямбда-функция для выбора типа текстового запроса (один или несколько текстов).

**Принцип работы**:

Класс `ToolBox` инициализируется с основными настройками и данными, необходимыми для работы Telegram-бота. Он определяет лямбда-функции для обработки различных типов запросов, что позволяет упростить и стандартизировать код. Класс также содержит методы для взаимодействия с нейронными сетями и управления тарифами.

## Методы класса

### `__init__`

```python
def __init__(self):
    """
    Инициализирует класс ToolBox, настраивает кнопки меню, загружает подсказки и инициализирует Telegram-бота.
    """
```

### `__gpt_4o_mini`

```python
def __gpt_4o_mini(self, prompt: list[dict], message) -> tuple[dict[str, str], int, int]:
    """
    Обрабатывает запрос к GPT 4o mini, отправляет запрос и возвращает ответ.

    Args:
        prompt (list[dict]): Список словарей с запросами для модели GPT.
        message: Объект сообщения Telegram.

    Returns:
        tuple[dict[str, str], int, int]: Кортеж, содержащий ответ, количество входящих и исходящих токенов.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Отправляет уведомление о задержке пользователю.
2. Вызывает метод `_free_gpt_4o_mini` из родительского класса (`neural_networks`) для получения ответа от модели GPT.
3. Редактирует сообщение с уведомлением о задержке, заменяя его на ответ от модели GPT.
4. Возвращает ответ и количество использованных токенов.

**Примеры**:
```python
# Пример вызова функции
# response, incoming_tokens, outgoing_tokens = self.__gpt_4o_mini(prompt=[{"role": "user", "content": "Привет"}], message=message)
```

### `__FLUX_schnell`

```python
def __FLUX_schnell(self, prompt: str, size: list[int], message, seed: int, num_inference_steps: int)-> None:
    """
    Генерирует изображение с использованием FLUX schnell, отправляет изображение пользователю.

    Args:
        prompt (str): Текстовое описание изображения.
        size (list[int]): Размеры изображения (ширина, высота).
        message: Объект сообщения Telegram.
        seed (int): Зерно для генерации случайных чисел.
        num_inference_steps (int): Количество шагов для генерации изображения.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Отправляет уведомление о задержке пользователю.
2. В цикле пытается сгенерировать изображение с использованием метода `_FLUX_schnell` из родительского класса (`neural_networks`).
3. При возникновении ошибки в процессе генерации, повторяет попытку.
4. После успешной генерации отправляет изображение пользователю и удаляет сообщение с уведомлением о задержке.
5. Если при генерации произошла ошибка, отправляет пользователю сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции
# self.__FLUX_schnell(prompt="Кошка в космосе", size=[1024, 1024], message=message, seed=12345, num_inference_steps=4)
```

### `Text_types`

```python
def Text_types(self, message):
    """
    Отображает типы текстов для выбора пользователем.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        types.InlineKeyboardMarkup: Inline-клавиатура с типами текстов.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Определяет список названий и данных для кнопок с типами текстов.
2. Редактирует сообщение пользователя, заменяя его на сообщение с inline-клавиатурой, содержащей типы текстов.

**Примеры**:
```python
# Пример вызова функции
# self.Text_types(message)
```

### `Basic_tariff`

```python
def Basic_tariff(self, message):
    """
    Предлагает пользователю подключить BASIC тариф.

    Args:
        message: Объект сообщения Telegram.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Создает inline-клавиатуру с кнопками для подключения BASIC тарифа и возврата к списку тарифов.
2. Определяет цену для BASIC тарифа.
3. Удаляет сообщение пользователя и отправляет счет на оплату BASIC тарифа.

**Примеры**:
```python
# Пример вызова функции
# self.Basic_tariff(message)
```

### `Pro_tariff`

```python
def Pro_tariff(self, message):
    """
    Предлагает пользователю подключить PRO тариф.

    Args:
        message: Объект сообщения Telegram.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Создает inline-клавиатуру с кнопками для подключения PRO тарифа и возврата к списку тарифов.
2. Определяет цену для PRO тарифа.
3. Удаляет сообщение пользователя и отправляет счет на оплату PRO тарифа.

**Примеры**:
```python
# Пример вызова функции
# self.Pro_tariff(message)
```

### `TextCommands`

```python
def TextCommands(self, message, ind: int):
    """
    Обрабатывает текстовые команды пользователя.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды в списке команд.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих и исходящих токенов, а также 1.
    """
```

**Внутренние функции**:

- `Text_next_step(message)`: обрабатывает следующий шаг для текстовых команд, где требуется ввод текста от пользователя.

**Как работает функция**:
1. Инициализирует пустой список `info` для хранения информации о запросе.
2. Проверяет, содержит ли команда текстовый ввод (`TEXT` в `pc.commands_size[ind]`).
3. Если команда содержит текстовый ввод, отправляет пользователю запрос на ввод текста.
4. Регистрирует функцию `Text_next_step` для обработки следующего шага.
5. Внутри `Text_next_step`:
   - Добавляет введенный пользователем текст в список `info`.
   - Если количество введенных параметров меньше необходимого, добавляет значения по умолчанию.
   - Получает prompt с помощью `pc.get_prompt`.
   - Вызывает `__gpt_4o_mini` для обработки запроса.
   - Перезапускает бота с помощью `self.restart(message)`.
6. Если команда не содержит текстовый ввод, сразу получает prompt и обрабатывает запрос с помощью `__gpt_4o_mini`.

**Примеры**:
```python
# Пример вызова функции
# self.TextCommands(message, 0)
```

### `SomeTextsCommand`

```python
def SomeTextsCommand(self, message, ind: int, tokens: dict[str, int]):
    """
    Обрабатывает команды для генерации нескольких текстов.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды в списке команд.
        tokens (dict[str, int]): Словарь с информацией о доступных токенах.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих и исходящих токенов, а также количество сгенерированных текстов.
    """
```

**Внутренние функции**:

- `Text_next_step(message)`: обрабатывает следующий шаг, когда требуется ввод текста источника.
- `Params_addition(message)`: обрабатывает ввод дополнительных параметров для генерации текстов.
- `process_prompt(i)`: генерирует текст на основе prompt и возвращает использованные токены.

**Как работает функция**:
1. Получает количество текстов для генерации от пользователя.
2. Для каждого текста запрашивает текст источника, если это необходимо.
3. Запрашивает дополнительные параметры для генерации текстов.
4. Для каждого текста генерирует prompt и отправляет запрос в модель.
5. Возвращает общее количество использованных токенов и количество сгенерированных текстов.

**Примеры**:
```python
# Пример вызова функции
# self.SomeTextsCommand(message, 0, {"incoming_tokens": 1000, "outgoing_tokens": 1000, "free_requests": 10})
```

### `ImageCommand`

```python
def ImageCommand(self, message, prompt: str, size: list[int]):
    """
    Обрабатывает команду для генерации изображения.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текстовое описание изображения.
        size (list[int]): Размеры изображения (ширина, высота).

    Returns:
        int: Зерно, использованное для генерации изображения.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Генерирует случайное зерно для генерации изображения.
2. Вызывает метод `__FLUX_schnell` для генерации изображения.
3. Вызывает метод `ImageChange` для отображения опций после генерации изображения.
4. Возвращает зерно, использованное для генерации изображения.

**Примеры**:
```python
# Пример вызова функции
# self.ImageCommand(message, "Кошка в космосе", [1024, 1024])
```

### `Image_Regen_And_Upscale`

```python
def Image_Regen_And_Upscale(self, message, prompt: str, size: list[int], seed, num_inference_steps=4):
    """
    Обрабатывает команды для регенерации и улучшения качества изображения.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текстовое описание изображения.
        size (list[int]): Размеры изображения (ширина, высота).
        seed (int): Зерно для генерации случайных чисел.
        num_inference_steps (int): Количество шагов для генерации изображения. По умолчанию 4.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Вызывает метод `__FLUX_schnell` для регенерации или улучшения качества изображения.

**Примеры**:
```python
# Пример вызова функции
# self.Image_Regen_And_Upscale(message, "Кошка в космосе", [1024, 1024], 12345)
```

### `FreeCommand`

```python
def FreeCommand(self, message, prompts: list[str]):
    """
    Обрабатывает команду в свободном режиме.

    Args:
        message: Объект сообщения Telegram.
        prompts (list[str]): Список подсказок для модели.

    Returns:
        tuple[int, int, list[str]]: Кортеж, содержащий количество входящих и исходящих токенов, а также обновленный список подсказок.
    """
```

**Внутренние функции**:
Отсутствуют

**Как работает функция**:
1. Добавляет сообщение пользователя в список подсказок.
2. Вызывает метод `__gpt_4o_mini` для обработки запроса.
3. Добавляет ответ модели в список подсказок.
4. Возвращает количество использованных токенов и обновленный список подсказок.

**Примеры**:
```python
# Пример вызова функции
# self.FreeCommand(message, [{"role": "system", "content": "Ты - полезный ассистент"}])
```