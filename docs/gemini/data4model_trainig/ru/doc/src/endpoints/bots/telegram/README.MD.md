# Документация для модуля `src.endpoints.bots.telegram`

## Обзор

Этот модуль реализует Telegram-бота, который обрабатывает различные команды, голосовые сообщения и текстовые сообщения от пользователей. Бот может отправлять приветственные сообщения, предоставлять справку, отправлять PDF-файлы, транскрибировать голосовые сообщения и читать содержимое текстовых документов.

## Подробней

Этот код является частью проекта `hypotez` и предназначен для обеспечения взаимодействия с пользователями через Telegram. Он использует библиотеку `python-telegram-bot` для создания и управления ботом, а также другие модули для обработки файлов, преобразования голоса в текст и выполнения асинхронных задач.
Рассматриваемый модуль обеспечивает интеграцию Telegram-бота с другими компонентами системы, позволяя пользователям взаимодействовать с системой через Telegram. Бот выполняет следующие функции:

1.  **Инициализация бота:** Бот инициализируется с использованием токена, который используется для аутентификации в Telegram API.
2.  **Обработка команд:** Бот обрабатывает команды, такие как `/start`, `/help` и `/sendpdf`, предоставляя пользователям соответствующие ответы и функциональность.
3.  **Обработка сообщений:** Бот обрабатывает входящие текстовые сообщения, голосовые сообщения и файлы документов.
4.  **Транскрипция голосовых сообщений:** Бот скачивает голосовое сообщение, сохраняет его локально и пытается транскрибировать его в текст.
5.  **Чтение содержимого документов:** Бот скачивает файл документа, сохраняет его локально и читает его содержимое.

## Основные модули и библиотеки

-   `python-telegram-bot`: Основная библиотека для создания Telegram-ботов.
-   `pathlib`: Для работы с путями к файлам.
-   `tempfile`: Для создания временных файлов.
-   `asyncio`: Для асинхронного выполнения задач.
-   `requests`: Для скачивания файлов.
-   `src.utils.convertors.tts`: Для преобразования речи в текст.
-   `src.utils.file`: Для чтения текстовых файлов.

## Классы

### `TelegramBot`

**Описание**: Класс для управления Telegram-ботом.

**Атрибуты**:

-   `token` (str): Токен бота для аутентификации в Telegram API.

**Методы**:

-   `__init__(self, token: str)`: Инициализирует бота с токеном и регистрирует обработчики.
-   `register_handlers(self)`: Регистрирует обработчики команд и сообщений.
-   `start(self, update: Update, context: CallbackContext)`: Обрабатывает команду `/start`.
-   `help_command(self, update: Update, context: CallbackContext)`: Обрабатывает команду `/help`.
-   `send_pdf(self, pdf_file: str | Path)`: Отправляет PDF-файл пользователю.
-   `handle_voice(self, update: Update, context: CallbackContext)`: Обрабатывает голосовые сообщения и транскрибирует аудио.
-   `transcribe_voice(self, file_path: Path) -> str`: Транскрибирует голосовые сообщения (заглушка).
-   `handle_document(self, update: Update, context: CallbackContext) -> str`: Обрабатывает файлы документов и читает их содержимое.
-   `handle_message(self, update: Update, context: CallbackContext) -> str`: Обрабатывает текстовые сообщения и возвращает полученный текст.

## Методы класса `TelegramBot`

### `__init__(self, token: str)`

**Назначение**: Инициализирует экземпляр класса `TelegramBot`.

**Параметры**:

-   `token` (str): Токен, используемый для аутентификации бота в Telegram API.

**Как работает функция**:

-   Сохраняет токен бота в атрибуте `token`.
-   Создает экземпляр `Application` из библиотеки `python-telegram-bot` для управления ботом.
-   Вызывает метод `register_handlers` для регистрации обработчиков команд и сообщений.

### `register_handlers(self)`

**Назначение**: Регистрирует обработчики команд и сообщений для бота.

**Как работает функция**:

-   Регистрирует обработчики команд `/start`, `/help` и `/sendpdf` с соответствующими функциями-обработчиками (`start`, `help_command`, `send_pdf`).
-   Регистрирует обработчики для голосовых сообщений, документов и текстовых сообщений с соответствующими функциями-обработчиками (`handle_voice`, `handle_document`, `handle_message`).

### `start(self, update: Update, context: CallbackContext)`

**Назначение**: Обрабатывает команду `/start`, отправляя приветственное сообщение пользователю.

**Параметры**:

-   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
-   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте команды.

**Как работает функция**:

-   Отправляет приветственное сообщение пользователю, используя метод `update.message.reply_text`.

### `help_command(self, update: Update, context: CallbackContext)`

**Назначение**: Обрабатывает команду `/help`, отправляя список доступных команд пользователю.

**Параметры**:

-   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
-   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте команды.

**Как работает функция**:

-   Отправляет список доступных команд пользователю, используя метод `update.message.reply_text`.

### `send_pdf(self, pdf_file: str | Path)`

**Назначение**: Отправляет PDF-файл пользователю в ответ на команду `/sendpdf`.

**Параметры**:

-   `pdf_file` (str | Path): Путь к PDF-файлу, который нужно отправить.

**Как работает функция**:

-   Отправляет PDF-файл пользователю, используя метод `update.message.reply_document`.

### `handle_voice(self, update: Update, context: CallbackContext)`

**Назначение**: Обрабатывает голосовые сообщения, полученные от пользователя.

**Параметры**:

-   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
-   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте сообщения.

**Как работает функция**:

-   Получает объект `Voice` из объекта `update`.
-   Получает информацию о файле голосового сообщения, используя метод `get_file`.
-   Скачивает файл голосового сообщения во временный файл, используя метод `download_to_drive`.
-   Вызывает метод `transcribe_voice` для транскрибирования голосового сообщения в текст.
-   Отправляет транскрибированный текст пользователю, используя метод `update.message.reply_text`.

### `transcribe_voice(self, file_path: Path) -> str`

**Назначение**: Транскрибирует голосовое сообщение в текст.

**Параметры**:

-   `file_path` (Path): Путь к файлу голосового сообщения.

**Как работает функция**:

-   Возвращает строку "Voice Transcription", так как функция является заглушкой и не выполняет реальную транскрипцию.

### `handle_document(self, update: Update, context: CallbackContext) -> str`

**Назначение**: Обрабатывает файлы документов, полученные от пользователя.

**Параметры**:

-   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
-   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте сообщения.

**Как работает функция**:

-   Получает объект `Document` из объекта `update`.
-   Получает информацию о файле документа, используя метод `get_file`.
-   Скачивает файл документа во временный файл, используя метод `download_to_drive`.
-   Читает содержимое файла документа, используя функцию `read_text_file` из модуля `src.utils.file`.
-   Отправляет содержимое файла документа пользователю, используя метод `update.message.reply_text`.

### `handle_message(self, update: Update, context: CallbackContext) -> str`

**Назначение**: Обрабатывает текстовые сообщения, полученные от пользователя.

**Параметры**:

-   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
-   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте сообщения.

**Как работает функция**:

-   Получает текст сообщения из объекта `update`.
-   Отправляет полученный текст обратно пользователю, используя метод `update.message.reply_text`.

## Главная функция

### `main()`

**Назначение**: Инициализирует и запускает Telegram-бота.

**Как работает функция**:

-   Получает токен бота из переменной окружения `TELEGRAM_TOKEN`.
-   Создает экземпляр класса `TelegramBot`, передавая токен в конструктор.
-   Запускает бота, используя метод `run_polling`.