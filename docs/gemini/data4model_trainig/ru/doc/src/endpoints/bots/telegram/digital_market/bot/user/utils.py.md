# Модуль `utils.py` для обработки успешных платежей в Telegram-боте

## Обзор

Модуль содержит функцию `successful_payment_logic`, которая обрабатывает логику после успешной оплаты товара пользователем через Telegram-бота. Включает в себя добавление информации о покупке в базу данных, отправку уведомлений администраторам и предоставление информации о товаре пользователю.

## Подробней

Этот модуль является важной частью логики работы Telegram-бота для цифрового рынка. Он отвечает за фиксацию факта покупки, оповещение заинтересованных сторон (администраторов) и предоставление покупателю всей необходимой информации о приобретенном товаре.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """
    Обрабатывает логику после успешной оплаты товара пользователем.

    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy для выполнения операций с базой данных.
        payment_data (dict): Словарь с данными о платеже, такими как ID продукта, цена, тип платежа и ID пользователя.
        currency (str): Валюта платежа.
        user_tg_id (int): ID пользователя в Telegram.
        bot (Bot): Экземпляр Telegram-бота для отправки сообщений.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке уведомления администраторам.

    Пример:
        >>> payment_data = {"product_id": 123, "price": 10.0, "payment_type": "card", "payment_id": "payment_123", "user_id": 456}
        >>> await successful_payment_logic(session, payment_data, "USD", 789, bot)
    """
    ...
```

**Назначение**: Обработка логики после успешной оплаты товара пользователем. Функция выполняет следующие действия: сохраняет информацию о покупке в базе данных, отправляет уведомления администраторам о новой покупке и отправляет пользователю информацию о приобретенном товаре, включая детали, закрытое описание и, если есть, файл товара. Также, если тип платежа - "stars", инициирует возврат звезд за покупку.

**Параметры**:
- `session` (AsyncSession): Сессия базы данных SQLAlchemy для выполнения операций с базой данных. Используется для добавления информации о покупке и поиска данных о продукте.
- `payment_data` (dict): Словарь с данными о платеже, включая `product_id`, `price`, `payment_type`, `payment_id` и `user_id`.
- `currency` (str): Валюта платежа.
- `user_tg_id` (int): ID пользователя в Telegram.
- `bot` (Bot): Экземпляр Telegram-бота для отправки сообщений.

**Возвращает**:
- `None`: Функция ничего не возвращает явно, но выполняет операции записи в базу данных и отправки сообщений.

**Вызывает исключения**:
- `Exception`: Возникает, если происходит ошибка при отправке уведомления администраторам.

**Как работает функция**:

1.  Извлекает данные о продукте и платеже из входных параметров.
2.  Добавляет информацию о покупке в базу данных через `PurchaseDao.add`.
3.  Находит данные о продукте по `product_id` через `ProductDao.find_one_or_none_by_id`.
4.  Отправляет уведомления всем администраторам, указанным в `settings.ADMIN_IDS`, о совершённой покупке. В случае ошибки логирует её с помощью `logger.error`.
5.  Формирует текст сообщения для пользователя, содержащий информацию о товаре: название, описание, цену, закрытое описание и наличие файла.
6.  Отправляет пользователю сообщение с информацией о товаре и/или файл товара, если он есть. Использует клавиатуру `main_user_kb` для навигации.
7.  Если тип платежа — `stars`, выполняет автоматический возврат звезд за покупку через `bot.refund_star_payment`.

**Примеры**:

Пример вызова функции с различными параметрами:

```python
payment_data = {
    "product_id": 123,
    "price": 10.50,
    "payment_type": "card",
    "payment_id": "payment_123",
    "user_id": 456
}
await successful_payment_logic(session, payment_data, "USD", 789, bot)

payment_data = {
    "product_id": 456,
    "price": 50,
    "payment_type": "stars",
    "payment_id": "payment_456",
    "user_id": 123
}
await successful_payment_logic(session, payment_data, "STARS", 789, bot)