# Модуль DeepAi.py

## Обзор

Модуль `DeepAi.py` предоставляет интерфейс для взаимодействия с API DeepAI для создания чат-ботов. Он включает в себя функцию `_create_completion`, которая отправляет запросы к API DeepAI и возвращает ответы. Модуль использует библиотеки `requests`, `json`, `random` и `hashlib` для выполнения HTTP-запросов, обработки JSON, генерации случайных чисел и хеширования данных.

## Подробней

Модуль предназначен для использования в проектах, требующих интеграции с сервисами DeepAI. Он предоставляет удобный способ отправки сообщений и получения ответов от чат-бота DeepAI. Важной особенностью является функция `_create_completion`, которая генерирует API-ключ и отправляет запросы к API.

## Функции

### `_create_completion`

**Назначение**: Отправляет запрос к API DeepAI для создания завершения чата и возвращает ответ в виде потока.

**Параметры**:

-   `model` (str): Идентификатор используемой модели.
-   `messages` (list): Список сообщений в формате истории чата.
-   `stream` (bool): Флаг, указывающий, следует ли возвращать ответ в виде потока.
-   `**kwargs`: Дополнительные аргументы.

**Возвращает**:

-   `Generator[str, None, None]`: Генератор, выдающий части ответа от API DeepAI.

**Вызывает исключения**:

-   `requests.exceptions.HTTPError`: Если HTTP-запрос возвращает код ошибки.

**Внутренние функции**:

#### `md5`

```python
def md5(text: str) -> str:
    """
    Вычисляет MD5-хеш строки.

    Args:
        text (str): Строка для хеширования.

    Returns:
        str: MD5-хеш строки в обратном порядке.
    """
```

**Назначение**: Вычисляет MD5-хеш переданной строки.

**Параметры**:

-   `text` (str): Строка, для которой вычисляется MD5-хеш.

**Возвращает**:

-   `str`: MD5-хеш строки в обратном порядке.

**Как работает функция**:

1.  Кодирует входную строку `text` в байты, используя кодировку UTF-8.
2.  Вычисляет MD5-хеш полученных байтов с помощью `hashlib.md5()`.
3.  Преобразует хеш в шестнадцатеричную строку с помощью `.hexdigest()`.
4.  Разворачивает строку в обратном порядке `[::-1]` и возвращает её.

#### `get_api_key`

```python
def get_api_key(user_agent: str) -> str:
    """
    Генерирует API-ключ на основе user-agent.

    Args:
        user_agent (str): Строка user-agent.

    Returns:
        str: Сгенерированный API-ключ.
    """
```

**Назначение**: Генерирует API-ключ на основе предоставленного user-agent.

**Параметры**:

-   `user_agent` (str): Строка, представляющая user-agent.

**Возвращает**:

-   `str`: Сгенерированный API-ключ.

**Как работает функция**:

1.  Генерирует случайное целое число `part1` в диапазоне от 0 до 10^11.
2.  Вычисляет MD5-хеш строки, состоящей из user-agent, MD5-хеша user-agent, MD5-хеша user-agent, `part1` и строки "x".
3.  Формирует API-ключ, объединяя строку "tryit-", `part1` и вычисленный хеш `part2`.

**Как работает функция `_create_completion`**:

1.  Определяет две внутренние функции: `md5` для вычисления MD5-хеша и `get_api_key` для генерации API-ключа.
2.  Устанавливает user-agent для HTTP-запросов.
3.  Формирует заголовки запроса, включая API-ключ и user-agent.
4.  Формирует данные для отправки в запросе, включая стиль чата и историю чата в формате JSON.
5.  Отправляет POST-запрос к API DeepAI (`https://api.deepai.org/chat_response`) с заголовками и данными.
6.  Итерируется по чанкам ответа от сервера и декодирует каждый чанк, возвращая его через генератор.

**Примеры**:

```python
# Пример вызова функции _create_completion
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
generator = _create_completion(model=model, messages=messages, stream=stream)
for chunk in generator:
    print(chunk, end="")
```

## Переменные

-   `url` (str): URL API DeepAI (`https://deepai.org`).
-   `model` (list): Список поддерживаемых моделей (`['gpt-3.5-turbo']`).
-   `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи (`True`).
-   `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации (`False`).
-   `params` (str): Строка, содержащая информацию о поддержке типов данных функцией `_create_completion`.