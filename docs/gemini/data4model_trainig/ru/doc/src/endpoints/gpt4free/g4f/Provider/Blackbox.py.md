# Модуль для работы с Blackbox AI
=================================

Модуль `Blackbox.py` предоставляет класс `Blackbox`, который является асинхронным генератором для взаимодействия с API Blackbox AI. Он поддерживает потоковую передачу сообщений, системные сообщения и историю сообщений. Модуль также включает в себя функциональность для работы с изображениями и проверки премиум-доступа.

## Обзор

Модуль предназначен для интеграции с Blackbox AI, предоставляя удобный интерфейс для отправки запросов и получения ответов. Он включает в себя поддержку различных моделей, как текстовых, так и графических, а также механизмы для управления сессиями и проверки авторизации пользователей.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения взаимодействия с сервисом Blackbox AI. Он предоставляет функциональность для генерации текста и изображений, а также для управления сессиями пользователей и проверки их премиум-доступа. Модуль использует асинхронные запросы для обеспечения высокой производительности и поддерживает потоковую передачу данных.

## Классы

### `Conversation`

**Описание**: Класс для хранения информации о текущем разговоре с Blackbox AI.
**Наследует**: `JsonConversation`

**Атрибуты**:
- `validated_value` (str): Валидированное значение для текущей сессии.
- `chat_id` (str): Идентификатор текущего чата.
- `message_history` (Messages): История сообщений в текущем чате.
- `model` (str): Модель, используемая в разговоре.

**Методы**:
- `__init__(self, model: str)`: Инициализирует объект разговора с указанной моделью.

### `Blackbox`

**Описание**: Класс для взаимодействия с API Blackbox AI. Предоставляет методы для генерации текста и изображений, управления сессиями и проверки авторизации пользователей.
**Наследует**: `AsyncGeneratorProvider`, `ProviderModelMixin`

**Атрибуты**:
- `label` (str): Метка провайдера ("Blackbox AI").
- `url` (str): URL главной страницы Blackbox AI ("https://www.blackbox.ai").
- `api_endpoint` (str): URL API Blackbox AI ("https://www.blackbox.ai/api/chat").
- `working` (bool): Указывает, работает ли провайдер (True).
- `supports_stream` (bool): Поддерживает ли провайдер потоковую передачу (True).
- `supports_system_message` (bool): Поддерживает ли провайдер системные сообщения (True).
- `supports_message_history` (bool): Поддерживает ли провайдер историю сообщений (True).
- `default_model` (str): Модель по умолчанию ("blackboxai").
- `default_vision_model` (str): Модель для обработки изображений по умолчанию (default_model).
- `default_image_model` (str): Модель для генерации изображений по умолчанию ('flux').
- `fallback_models` (list): Список бесплатных моделей, используемых по умолчанию.
- `image_models` (list): Список моделей для генерации изображений.
- `vision_models` (list): Список моделей для обработки изображений.
- `userSelectedModel` (list): Список моделей, выбранных пользователем.
- `agentMode` (dict): Конфигурации для различных режимов агентов.
- `trendingAgentMode` (dict): Конфигурации для популярных режимов агентов.
- `_all_models` (list): Полный список моделей, доступных для авторизованных пользователей.
- `models` (list): Список моделей, используемых по умолчанию (fallback_models).
- `model_aliases` (dict): Псевдонимы моделей для удобства использования.

**Принцип работы**:

Класс `Blackbox` предоставляет интерфейс для взаимодействия с API Blackbox AI. Он использует асинхронные запросы для обеспечения высокой производительности и поддерживает потоковую передачу данных. Класс включает в себя методы для генерации текста и изображений, управления сессиями и проверки авторизации пользователей.

## Методы класса

### `generate_session(cls, id_length: int = 21, days_ahead: int = 365) -> dict`

**Назначение**: Генерирует динамическую сессию с правильным ID и форматом истечения срока действия.

**Параметры**:
- `id_length` (int): Длина числового ID (по умолчанию: 21).
- `days_ahead` (int): Количество дней до истечения срока действия (по умолчанию: 365).

**Возвращает**:
- `dict`: Словарь сессии с информацией о пользователе и сроком действия.

**Как работает функция**:
- Генерирует числовой ID заданной длины.
- Генерирует дату истечения срока действия, отстоящую от текущей даты на указанное количество дней.
- Декодирует закодированный email.
- Генерирует случайный ID изображения для нового формата URL.
- Возвращает словарь, содержащий информацию о пользователе, email, URL изображения и срок действия сессии.

**Примеры**:

```python
session = Blackbox.generate_session()
print(session)
# {'user': {'name': 'BLACKBOX AI', 'email': 'gisele@blackbox.ai', 'image': 'https://lh3.googleusercontent.com/a/ACg8oc...=s96-c', 'id': '...'}, 'expires': '2024-07-04T14:28:34.123Z'}
```

### `fetch_validated(cls, url: str = "https://www.blackbox.ai", force_refresh: bool = False) -> Optional[str]`

**Назначение**: Извлекает валидированное значение с веб-сайта Blackbox AI.

**Параметры**:
- `url` (str): URL веб-сайта для извлечения данных (по умолчанию: "https://www.blackbox.ai").
- `force_refresh` (bool): Принудительное обновление кэша (по умолчанию: False).

**Возвращает**:
- `Optional[str]`: Валидированное значение или `None`, если не найдено.

**Как работает функция**:
- Проверяет наличие кэшированного значения в файле `blackbox.json`.
- Если кэш не найден или `force_refresh` установлен в `True`, выполняет HTTP-запрос к указанному URL.
- Извлекает JavaScript-файлы, соответствующие шаблону `js_file_pattern`.
- Ищет UUID в содержимом JavaScript-файлов, используя шаблон `uuid_pattern`.
- Проверяет контекст UUID на наличие символов, указывающих на валидность.
- Кэширует валидированное значение в файл `blackbox.json`.
- Возвращает валидированное значение или `None` в случае ошибки.

**Примеры**:

```python
validated_value = await Blackbox.fetch_validated()
if validated_value:
    print(f"Validated value: {validated_value}")
else:
    print("Validated value not found.")
```

### `generate_id(cls, length: int = 7) -> str`

**Назначение**: Генерирует случайный ID заданной длины.

**Параметры**:
- `length` (int): Длина генерируемого ID (по умолчанию: 7).

**Возвращает**:
- `str`: Случайный ID.

**Как работает функция**:
- Генерирует случайный ID, используя символы из `string.ascii_letters` и `string.digits`.
- Возвращает сгенерированный ID.

**Примеры**:

```python
random_id = Blackbox.generate_id()
print(f"Generated ID: {random_id}")
```

### `get_models(cls) -> list`

**Назначение**: Возвращает список доступных моделей на основе статуса авторизации.

**Возвращает**:
- `list`: Список доступных моделей.

**Как работает функция**:
- Проверяет наличие премиум-доступа с помощью метода `_check_premium_access`.
- Если у пользователя есть премиум-доступ, возвращает полный список моделей (`cls._all_models`).
- Если у пользователя нет премиум-доступа, возвращает список бесплатных моделей (`cls.fallback_models`).

**Примеры**:

```python
models = Blackbox.get_models()
print(f"Available models: {models}")
```

### `_check_premium_access(cls) -> bool`

**Назначение**: Проверяет наличие авторизованной сессии в HAR-файлах.

**Возвращает**:
- `bool`: `True`, если найдена валидная сессия, отличающаяся от демонстрационной, иначе `False`.

**Как работает функция**:
- Просматривает HAR-файлы в каталоге `har_dir`.
- Извлекает данные сессии из HAR-файлов.
- Сравнивает данные сессии с данными демонстрационной сессии.
- Возвращает `True`, если найдена валидная сессия, отличающаяся от демонстрационной, иначе `False`.

**Примеры**:

```python
has_premium_access = Blackbox._check_premium_access()
if has_premium_access:
    print("User has premium access.")
else:
    print("User does not have premium access.")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        media: MediaListType = None,
        top_p: float = None,
        temperature: float = None,
        max_tokens: int = None,
        conversation: Conversation = None,
        return_conversation: bool = False,
        **kwargs
    ) -> AsyncResult:
        ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Blackbox AI.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `prompt` (str, optional): Дополнительный промпт. По умолчанию `None`.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `media` (MediaListType, optional): Список медиа-файлов для отправки. По умолчанию `None`.
- `top_p` (float, optional): Значение top_p. По умолчанию `None`.
- `temperature` (float, optional): Значение temperature. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `None`.
- `conversation` (Conversation, optional): Объект разговора. По умолчанию `None`.
- `return_conversation` (bool, optional): Возвращать ли объект разговора. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения ответов от API.

**Как работает функция**:
- Получает модель для использования.
- Формирует заголовки запроса.
- Создает или использует существующий объект разговора.
- Формирует текущие сообщения для отправки.
- Добавляет медиа-файлы в сообщение, если они есть.
- Получает данные сессии из HAR-файлов или генерирует новую сессию.
- Формирует данные для отправки в API.
- Отправляет запрос к API и получает ответ.
- Обрабатывает ответ и возвращает его в виде асинхронного генератора.

**Внутренние функции**:

Внутри данной функции нет внутренних функций.

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, Blackbox AI!"}]
async for response in Blackbox.create_async_generator(model="blackboxai", messages=messages):
    print(response)
```

## Параметры класса

- `label` (str): Метка провайдера ("Blackbox AI").
- `url` (str): URL главной страницы Blackbox AI ("https://www.blackbox.ai").
- `api_endpoint` (str): URL API Blackbox AI ("https://www.blackbox.ai/api/chat").
- `working` (bool): Указывает, работает ли провайдер (True).
- `supports_stream` (bool): Поддерживает ли провайдер потоковую передачу (True).
- `supports_system_message` (bool): Поддерживает ли провайдер системные сообщения (True).
- `supports_message_history` (bool): Поддерживает ли провайдер историю сообщений (True).
- `default_model` (str): Модель по умолчанию ("blackboxai").
- `default_vision_model` (str): Модель для обработки изображений по умолчанию (default_model).
- `default_image_model` (str): Модель для генерации изображений по умолчанию ('flux').
- `fallback_models` (list): Список бесплатных моделей, используемых по умолчанию.
- `image_models` (list): Список моделей для генерации изображений.
- `vision_models` (list): Список моделей для обработки изображений.
- `userSelectedModel` (list): Список моделей, выбранных пользователем.
- `agentMode` (dict): Конфигурации для различных режимов агентов.
- `trendingAgentMode` (dict): Конфигурации для популярных режимов агентов.
- `_all_models` (list): Полный список моделей, доступных для авторизованных пользователей.
- `models` (list): Список моделей, используемых по умолчанию (fallback_models).
- `model_aliases` (dict): Псевдонимы моделей для удобства использования.