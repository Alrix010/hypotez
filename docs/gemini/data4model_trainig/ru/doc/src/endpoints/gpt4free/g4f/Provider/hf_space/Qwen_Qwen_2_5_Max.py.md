# Модуль Qwen_Qwen_2_5_Max
## Обзор

Модуль `Qwen_Qwen_2_5_Max` предоставляет асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5-Max через Hugging Face Space. Он позволяет отправлять запросы к модели и получать ответы в виде асинхронного потока данных. Поддерживает потоковую передачу, системные сообщения, но не поддерживает историю сообщений.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта, требующими взаимодействия с языковой моделью Qwen Qwen-2.5-Max. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет удобный интерфейс для отправки запросов и обработки ответов. Расположение файла в структуре проекта указывает на его роль как одного из провайдеров для работы с различными моделями GPT4Free.

## Классы

### `Qwen_Qwen_2_5_Max`

**Описание**: Класс `Qwen_Qwen_2_5_Max` реализует асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5-Max.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного провайдера генератора.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера ("Qwen Qwen-2.5-Max").
- `url` (str): URL Hugging Face Space, где размещена модель.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи ответов.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель по умолчанию ("qwen-qwen2-5-max").
- `model_aliases` (dict): Псевдонимы моделей.
- `models` (list): Список поддерживаемых моделей.

**Принцип работы**:

Класс использует асинхронные HTTP-запросы для взаимодействия с API модели. Он генерирует уникальный идентификатор сессии для каждого запроса, формирует полезную нагрузку с учетом системных сообщений и истории сообщений, а затем отправляет запрос к API. Ответ обрабатывается построчно, извлекаются фрагменты текста, и генерируется асинхронный поток данных.

## Методы класса

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.5-Max.

        Args:
            model (str): Название модели.
            messages (Messages): Список сообщений для отправки модели.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий фрагменты текста от модели.

        Raises:
            aiohttp.ClientError: Если возникает ошибка при выполнении HTTP-запроса.
            json.JSONDecodeError: Если не удается декодировать JSON из ответа сервера.

        Example:
            >>> async for fragment in Qwen_Qwen_2_5_Max.create_async_generator(model='qwen-2-5-max', messages=[{'role': 'user', 'content': 'Hello'}]):
            ...     print(fragment, end='')
            Hello!
        """
```

**Внутренние функции**:

#### `generate_session_hash`

```python
        def generate_session_hash():
            """Generate a unique session hash."""
            return str(uuid.uuid4()).replace('-', '')[:8] + str(uuid.uuid4()).replace('-', '')[:4]
```

**Назначение**: Функция создает уникальный хеш сессии, используемый для идентификации сессии взаимодействия с моделью.

**Как работает функция**:
- Генерирует UUID (универсальный уникальный идентификатор).
- Удаляет все дефисы из UUID.
- Извлекает первые 8 символов из первой половины UUID и первые 4 символа из второй половины UUID.
- Объединяет эти символы и возвращает полученную строку.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `str`: Уникальный хеш сессии.

**Примеры**:
```python
>>> generate_session_hash()
'a1b2c3d4e5f6'
```

**Как работает функция `create_async_generator`**:

1. **Генерация уникального идентификатора сессии**:
   - Вызывается функция `generate_session_hash()` для создания уникального идентификатора сессии.

2. **Подготовка HTTP-заголовков**:
   - Определяются HTTP-заголовки для запроса, включая `User-Agent`, `Accept`, `Referer`, `content-type`, `Origin` и `Connection`.

3. **Подготовка содержимого запроса (prompt)**:
   - Извлекаются системные сообщения из списка `messages` и объединяются в строку `system_prompt`.
   - Если системные сообщения отсутствуют, устанавливается значение по умолчанию: "You are a helpful assistant."
   - Фильтруются сообщения, исключая системные сообщения.
   - Форматируется запрос `prompt` с использованием функции `format_prompt`.

4. **Формирование полезной нагрузки (payload)**:
   - Формируется словарь `payload_join`, содержащий данные для отправки в запросе, включая `prompt`, `system_prompt` и `session_hash`.

5. **Отправка запроса и обработка ответа**:
   - Используется `aiohttp.ClientSession` для отправки асинхронного POST-запроса к `cls.api_endpoint` с установленными заголовками и полезной нагрузкой.
   - Извлекается `event_id` из JSON-ответа на POST-запрос.

6. **Подготовка к потоковой передаче данных**:
   - Формируются URL (`url_data`) и заголовки (`headers_data`) для запроса потоковых данных.
   - Устанавливаются параметры запроса (`params_data`), включая `session_hash`.

7. **Получение и обработка потоковых данных**:
   - Отправляется GET-запрос к `url_data` с установленными заголовками и параметрами.
   - Читается ответ построчно.
   - Если строка начинается с `data: `, извлекается JSON-данные из строки.
   - Если JSON-данные содержат сообщение `process_generating`, извлекаются фрагменты текста из `output_data` и генерируются в асинхронном генераторе.
   - Если JSON-данные содержат сообщение `process_completed`, извлекается окончательный ответ из `output_data`, очищается от дубликатов и генерируется в асинхронном генераторе.

8. **Обработка ошибок**:
   - Если не удается декодировать JSON-данные, регистрируется ошибка с использованием `debug.log`.

## Параметры класса

- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки модели.
- `proxy` (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры конфигурации.

## Примеры

Пример использования класса `Qwen_Qwen_2_5_Max` для создания асинхронного генератора и получения ответов от модели:

```python
import asyncio

async def main():
    messages = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "What is the capital of France?"}
    ]
    async for fragment in Qwen_Qwen_2_5_Max.create_async_generator(model="qwen-2-5-max", messages=messages):
        print(fragment, end="")

if __name__ == "__main__":
    asyncio.run(main())