# Модуль для работы с партнерскими продуктами AliExpress

## Обзор

Модуль `affiliated_products_generator.py` предназначен для получения информации о партнерских продуктах с платформы AliExpress. Он предоставляет класс `AliAffiliatedProducts`, который позволяет собирать данные о продуктах по их идентификаторам или URL-адресам, получать партнерские ссылки, сохранять изображения и видео, а также генерировать данные для рекламных кампаний.

## Подробнее

Модуль взаимодействует с API AliExpress через класс `AliApi` (родительский класс для `AliAffiliatedProducts`) и использует другие утилиты для обработки данных, такие как сохранение изображений и видео, чтение и запись файлов JSON и текстовых файлов. Он также включает функциональность для нормализации URL-адресов и работы с HTML-шаблонами для генерации контента рекламных кампаний.

Модуль предназначен для автоматизации процесса сбора и подготовки данных о продуктах AliExpress для использования в рекламных кампаниях, например, в PrestaShop.

## Классы

### `AliAffiliatedProducts`

**Описание**: Класс для сбора полных данных о продуктах из URL-адресов или идентификаторов продуктов.

**Наследует**: `AliApi`

**Атрибуты**:
- `language` (str): Язык для рекламной кампании (по умолчанию `None`).
- `currency` (str): Валюта для рекламной кампании (по умолчанию `None`).

**Методы**:
- `__init__`: Инициализирует класс `AliAffiliatedProducts`.
- `process_affiliate_products`: Обрабатывает список идентификаторов или URL-адресов продуктов и возвращает список продуктов с партнерскими ссылками и сохраненными изображениями.

#### `__init__`

```python
def __init__(self, language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs):
    """
    Инициализирует класс AliAffiliatedProducts.

    Args:
        language (str | dict): Язык для рекламной кампании (по умолчанию 'EN').
        currency (str): Валюта для рекламной кампании (по умолчанию 'USD').
    """
    ...
```

**Назначение**: Инициализация экземпляра класса `AliAffiliatedProducts`.

**Параметры**:
- `language` (str | dict): Язык рекламной кампании. По умолчанию 'EN'.
- `currency` (str): Валюта рекламной кампании. По умолчанию 'USD'.
- `*args`: Произвольные позиционные аргументы, передаваемые в конструктор родительского класса.
- `**kwargs`: Произвольные именованные аргументы, передаваемые в конструктор родительского класса.

**Как работает функция**:

- Проверяет, указаны ли язык и валюта. Если нет, записывает критическую ошибку в лог.
- Вызывает конструктор родительского класса `AliApi`, передавая язык и валюту.
- Устанавливает значения атрибутов `language` и `currency` экземпляра класса.

**Примеры**:

```python
affiliated_products = AliAffiliatedProducts(language='RU', currency='RUB')
```

#### `process_affiliate_products`

```python
async def process_affiliate_products(self, prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]:
    """
    Обрабатывает список идентификаторов или URL-адресов продуктов и возвращает список продуктов с партнерскими ссылками и сохраненными изображениями.

    Args:
        prod_ids (list[str]): Список URL-адресов или идентификаторов продуктов.
        category_root (Path | str): Путь к корневой директории категории.

    Returns:
        list[SimpleNamespace]: Список обработанных продуктов с партнерскими ссылками и сохраненными изображениями.
    """
    ...
```

**Назначение**: Обработка списка идентификаторов или URL-адресов продуктов для получения партнерских ссылок, деталей продуктов, сохранения изображений и видео.

**Параметры**:
- `prod_ids` (list[str]): Список URL-адресов или идентификаторов продуктов.
- `category_root` (Path | str): Путь к корневой директории категории, где будут сохранены изображения и видео.

**Возвращает**:
- `list[SimpleNamespace]`: Список обработанных продуктов с партнерскими ссылками и сохраненными изображениями. Каждый элемент списка представляет собой объект `SimpleNamespace` с информацией о продукте.

**Как работает функция**:

1.  **Инициализация**:
    *   Инициализирует пустые списки `_promotion_links` и `_prod_urls` для хранения партнерских ссылок и URL-адресов продуктов соответственно.
    *   Нормализует URL-адреса продуктов, приводя их к виду `https://aliexpress.com/item/<product_id>.html` с помощью функции `ensure_https`.
2.  **Получение партнерских ссылок**:
    *   Перебирает нормализованные URL-адреса продуктов.
    *   Для каждого URL-адреса пытается получить партнерские ссылки с помощью метода `get_affiliate_links` родительского класса `AliApi`.
    *   Если партнерские ссылки найдены, добавляет их в список `_promotion_links`, а URL-адрес продукта - в список `_prod_urls`.
    *   Логирует информацию о найденной партнерской ссылке.
3.  **Обработка отсутствующих партнерских ссылок**:
    *   Если ни для одного продукта не удалось найти партнерскую ссылку, записывает предупреждение в лог и возвращает `None`.
4.  **Получение деталей продуктов**:
    *   Получает детали продуктов для URL-адресов с партнерскими ссылками с помощью метода `retrieve_product_details`.
    *   Если не удалось получить детали продуктов, возвращает `None`.
5.  **Сохранение изображений и видео**:
    *   Перебирает список полученных продуктов и соответствующие им партнерские ссылки.
    *   Для каждого продукта:
        *   Добавляет язык и партнерскую ссылку к данным продукта.
        *   Формирует путь для сохранения изображения продукта в подкаталоге `images` корневой директории категории.
        *   Сохраняет изображение продукта, используя URL-адрес главного изображения продукта и сформированный путь.
        *   Логирует информацию о сохраненном изображении.
        *   Сохраняет локальный путь к изображению в атрибуте `local_image_path` продукта.
        *   Если у продукта есть видео, формирует путь для сохранения видео в подкаталоге `videos` корневой директории категории и сохраняет видео.
        *   Логирует информацию о сохраненном видео.
        *   Сохраняет локальный путь к видео в атрибуте `local_video_path` продукта.
    *   Добавляет обработанный продукт в список `affiliated_products_list`.
6.  **Сохранение заголовков продуктов**:
    *   Формирует путь для сохранения заголовков продуктов в текстовый файл `product_titles.txt` в подкаталоге, соответствующем языку и валюте.
    *   Сохраняет список заголовков продуктов в текстовый файл.
7.  **Возврат результата**:
    *   Возвращает список обработанных продуктов `affiliated_products_list`.

**Примеры**:

```python
# Пример вызова функции process_affiliate_products
prod_ids = ["https://aliexpress.com/item/1234567890.html", "https://aliexpress.com/item/0987654321.html"]
category_root = "/path/to/category"
affiliated_products = await self.process_affiliate_products(prod_ids, category_root)
for product in affiliated_products:
    print(product.product_title)
    print(product.promotion_link)
    print(product.local_image_path)
```
```python
    async def save_text_file(
        file_path: Path | str,
        content: str | list[str] | None = None,
        open_encoding: str = 'utf-8',
        logger_level: int = 20
    ) -> None:
        """
        Сохраняет текст в файл.

        Args:
            file_path (Path | str): Путь к файлу.
            content (str | list[str] | None, optional): Содержимое для записи. Defaults to None.
            open_encoding (str, optional): Кодировка файла. Defaults to 'utf-8'.
            logger_level (int, optional): Уровень логирования. Defaults to 20.

        Raises:
            Exception: Вызывается, если произошла ошибка при записи в файл.

        Example:
            >>> file_path = Path("example.txt")
            >>> content = "Hello, world!"
            >>> await save_text_file(file_path, content)
        """
        ...
```
## Переменные
- `_promotion_links` (list): Список партнерских ссылок, полученных для продуктов.
- `_prod_urls` (list): Список URL-адресов продуктов, для которых были найдены партнерские ссылки.
- `normilized_prod_urls` (list): Список нормализованных URL-адресов продуктов.
- `print_flag` (str): Флаг для переключения режима печати (в одну строку или с новой строки).
- `_affiliated_products` (List[SimpleNamespace]): Список объектов `SimpleNamespace`, содержащих детали продуктов.
- `affiliated_products_list` (list[SimpleNamespace]): Список обработанных продуктов с партнерскими ссылками и сохраненными изображениями.
- `product_titles` (list): Список заголовков продуктов.
- `product_titles_path` (Path): Путь к файлу, в котором будут сохранены заголовки продуктов.