# Модуль `playwrid.py`

## Обзор

Модуль `playwrid.py` является частью проекта `hypotez` и предназначен для создания Playwright-краулера. Он предоставляет класс `Playwrid`, который является подклассом `PlaywrightCrawler` из библиотеки `crawlee`. Класс `Playwrid` позволяет настраивать параметры запуска браузера, такие как `user_agent` и другие опции Playwright. Модуль также включает функциональность для выполнения различных действий на веб-странице, таких как навигация, получение содержимого элементов и выполнение JavaScript-кода.

## Подробней

Основное назначение модуля - предоставить удобный интерфейс для автоматизации взаимодействия с веб-страницами с использованием Playwright. Это включает в себя возможность запуска браузера с определенными настройками, навигацию по URL, извлечение данных из элементов на странице и выполнение действий, таких как клики. Модуль использует библиотеку `crawlee` для управления краулингом и Playwright для взаимодействия с браузером.

## Классы

### `Playwrid`

**Описание**: Класс `Playwrid` наследуется от `PlaywrightCrawler` и предоставляет дополнительные функции для настройки и управления Playwright-краулером.

**Наследует**:
- `PlaywrightCrawler`

**Атрибуты**:
- `driver_name` (str): Имя драйвера, по умолчанию `'playwrid'`.
- `base_path` (Path): Путь к базовой директории модуля.
- `config` (SimpleNamespace): Конфигурация, загруженная из `playwrid.json`.
- `context` (Any): Контекст выполнения краулера.

**Методы**:
- `__init__`: Инициализирует класс `Playwrid` с заданными параметрами запуска браузера, настройками и агентом пользователя.
- `_set_launch_options`: Настраивает параметры запуска для Playwright.
- `start`: Запускает Playwrid Crawler и переходит по указанному URL.
- `current_url`: Возвращает текущий URL браузера.
- `get_page_content`: Возвращает HTML-содержимое текущей страницы.
- `get_element_content`: Возвращает внутреннее HTML-содержимое элемента по CSS-селектору.
- `get_element_value_by_xpath`: Возвращает текстовое значение элемента по XPath.
- `click_element`: Кликает на элемент на странице по CSS-селектору.
- `execute_locator`: Выполняет локатор через executor.

#### `__init__`

```python
def __init__(self, user_agent: Optional[str] = None, options: Optional[List[str]] = None, *args, **kwargs) -> None
```

**Назначение**: Инициализирует экземпляр класса `Playwrid`.

**Параметры**:
- `user_agent` (Optional[str], optional): User-Agent, который будет использоваться для браузера. По умолчанию `None`.
- `options` (Optional[List[str]], optional): Список опций командной строки для запуска браузера. По умолчанию `None`.
- `*args`: Произвольные позиционные аргументы, передаваемые в конструктор родительского класса.
- `**kwargs`: Произвольные именованные аргументы, передаваемые в конструктор родительского класса.

**Как работает функция**:

1. Настраивает параметры запуска браузера с помощью метода `_set_launch_options`.
2. Инициализирует `PlaywrightExecutor`.
3. Вызывает конструктор родительского класса `PlaywrightCrawler` с переданными аргументами, исключая `launch_options`, если родительский класс не принимает их напрямую.
4. Если `PlaywrightCrawler` не принимает `launch_options`, пытается установить их отдельно, предполагая наличие метода `set_launch_options`.

#### `_set_launch_options`

```python
def _set_launch_options(self, user_agent: Optional[str] = None, options: Optional[List[str]] = None) -> Dict[str, Any]
```

**Назначение**: Конфигурирует параметры запуска для Playwright.

**Параметры**:
- `user_agent` (Optional[str], optional): User-Agent, который будет использоваться для браузера. По умолчанию `None`.
- `options` (Optional[List[str]], optional): Список опций командной строки для запуска браузера. По умолчанию `None`.

**Возвращает**:
- `Dict[str, Any]`: Словарь с параметрами запуска для Playwright.

**Как работает функция**:

1. Инициализирует словарь `launch_options` с параметрами `headless` и `args` из конфигурации, если они определены. В противном случае использует значения по умолчанию `True` для `headless` и пустой список для `args`.
2. Если передан `user_agent`, добавляет его в словарь `launch_options`.
3. Если переданы дополнительные опции `options`, расширяет список `args` в `launch_options`.

**Примеры**:

```python
browser = Playwrid(user_agent='Custom User Agent', options=['--disable-gpu', '--no-sandbox'])
launch_options = browser._set_launch_options(user_agent='Custom User Agent', options=['--disable-gpu', '--no-sandbox'])
print(launch_options)  # Вывод: {'headless': True, 'args': ['--disable-gpu', '--no-sandbox'], 'user_agent': 'Custom User Agent'}
```

#### `start`

```python
async def start(self, url: str) -> None
```

**Назначение**: Запускает Playwright Crawler и переходит по указанному URL.

**Параметры**:
- `url` (str): URL для перехода.

**Как работает функция**:

1. Логирует информацию о начале запуска краулера для указанного URL.
2. Запускает `PlaywrightExecutor` для управления браузером.
3. Переходит по указанному URL с помощью `PlaywrightExecutor`.
4. Запускает основной цикл краулинга с помощью метода `run` родительского класса.
5. Получает контекст краулинга для дальнейшего использования.
6. Обрабатывает исключения, которые могут возникнуть в процессе запуска краулера, и логирует критическую ошибку.

**Примеры**:

```python
browser = Playwrid()
asyncio.run(browser.start('https://www.example.com'))
```

#### `current_url`

```python
@property
def current_url(self) -> Optional[str]
```

**Назначение**: Возвращает текущий URL браузера.

**Возвращает**:
- `Optional[str]`: Текущий URL или `None`, если контекст или страница не определены.

**Как работает функция**:

1. Проверяет, определен ли контекст краулинга и страница в контексте.
2. Если контекст и страница определены, возвращает текущий URL страницы.
3. В противном случае возвращает `None`.

#### `get_page_content`

```python
def get_page_content(self) -> Optional[str]
```

**Назначение**: Возвращает HTML-содержимое текущей страницы.

**Возвращает**:
- `Optional[str]`: HTML-содержимое страницы или `None`, если контекст или страница не определены.

**Как работает функция**:

1. Проверяет, определен ли контекст краулинга и страница в контексте.
2. Если контекст и страница определены, возвращает HTML-содержимое страницы.
3. В противном случае возвращает `None`.

#### `get_element_content`

```python
async def get_element_content(self, selector: str) -> Optional[str]
```

**Назначение**: Возвращает внутреннее HTML-содержимое элемента по CSS-селектору.

**Параметры**:
- `selector` (str): CSS-селектор элемента.

**Возвращает**:
- `Optional[str]`: Внутреннее HTML-содержимое элемента или `None`, если элемент не найден или произошла ошибка.

**Как работает функция**:

1. Проверяет, определен ли контекст краулинга и страница в контексте.
2. Если контекст и страница определены, пытается найти элемент с помощью переданного CSS-селектора.
3. Если элемент найден, возвращает его внутреннее HTML-содержимое.
4. Если элемент не найден или произошла ошибка, логирует предупреждение и возвращает `None`.

#### `get_element_value_by_xpath`

```python
async def get_element_value_by_xpath(self, xpath: str) -> Optional[str]
```

**Назначение**: Возвращает текстовое значение элемента по XPath.

**Параметры**:
- `xpath` (str): XPath элемента.

**Возвращает**:
- `Optional[str]`: Текстовое значение элемента или `None`, если элемент не найден или произошла ошибка.

**Как работает функция**:

1. Проверяет, определен ли контекст краулинга и страница в контексте.
2. Если контекст и страница определены, пытается найти элемент с помощью переданного XPath.
3. Если элемент найден, возвращает его текстовое значение.
4. Если элемент не найден или произошла ошибка, логирует предупреждение и возвращает `None`.

#### `click_element`

```python
async def click_element(self, selector: str) -> None
```

**Назначение**: Кликает на элемент на странице по CSS-селектору.

**Параметры**:
- `selector` (str): CSS-селектор элемента для клика.

**Как работает функция**:

1. Проверяет, определен ли контекст краулинга и страница в контексте.
2. Если контекст и страница определены, пытается найти элемент с помощью переданного CSS-селектора.
3. Если элемент найден, выполняет клик на элементе.
4. Если элемент не найден или произошла ошибка, логирует предупреждение.

#### `execute_locator`

```python
async def execute_locator(self, locator: dict | SimpleNamespace, message: Optional[str] = None, typing_speed: float = 0) -> str | List[str] | bytes | List[bytes] | bool
```

**Назначение**: Выполняет локатор через executor.

**Параметры**:
- `locator` (dict | SimpleNamespace): Данные локатора.
- `message` (Optional[str], optional): Опциональное сообщение для событий. По умолчанию `None`.
- `typing_speed` (float): Скорость печати.

**Возвращает**:
- `str | List[str] | bytes | List[bytes] | bool`: Execution status.

**Как работает функция**:

1. Вызывает метод `execute_locator` у объекта `self.executor` с переданными параметрами.
2. Возвращает результат выполнения локатора.

## Примеры

В основном блоке `if __name__ == "__main__":` представлен пример использования класса `Playwrid`. В этом примере создается экземпляр класса, запускается браузер, выполняются различные действия на странице (получение содержимого, клик на элемент) и выводятся результаты.