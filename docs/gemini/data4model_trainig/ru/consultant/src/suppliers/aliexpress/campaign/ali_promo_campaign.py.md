### **Анализ кода модуля `ali_promo_campaign.py`**

## \file /src/suppliers/aliexpress/campaign/ali_promo_campaign.py
# -*- coding: utf-8 -*-
#! .pyenv/bin/python3

"""
Модуль AliPromoCampaign
=======================

### Назначение:
Модуль предназначен для управления рекламными кампаниями на платформе AliExpress, включая обработку данных о категориях и товарах, создание и редактирование JSON-файлов с информацией о кампаниях, а также использование AI для генерации данных о кампаниях.

### Описание:
Класс `AliPromoCampaign` позволяет загружать и обрабатывать данные рекламных кампаний, управлять категориями и товарами, а также использовать ИИ для генерации описаний и других данных. Модуль поддерживает различные языки и валюты, обеспечивая гибкость в настройке кампаний.

### Примеры:
Пример инициализации рекламной кампании:

    >>> campaign = AliPromoCampaign("new_campaign", "EN", "USD")
    >>> print(campaign.campaign_name)

Пример обработки всей кампании:

    >>> campaign = AliPromoCampaign("new_campaign", "EN", "USD")
    >>> campaign.process_campaign()

Пример обработки данных о товарах в категории:

    >>> campaign = AliPromoCampaign("new_campaign", "EN", "USD")
    >>> products = campaign.process_category_products("electronics")

Пример заполнения данных категорий с использованием AI:

    >>> campaign = AliPromoCampaign("new_campaign", "EN", "USD")
    >>> campaign.process_llm_category("Electronics")
"""

import header
import asyncio
import time
import copy
import html
from pathlib import Path
from types import SimpleNamespace
from typing import List, Optional, Dict
import header
from src import gs
from src.suppliers.aliexpress import campaign
from src.suppliers.aliexpress.affiliated_products_generator import AliAffiliatedProducts
from src.suppliers.aliexpress.utils import locales
from src.ai.gemini import GoogleGenerativeAi
from src.ai.openai import OpenAIModel
from src.suppliers.aliexpress.campaign.html_generators import (
    ProductHTMLGenerator,
    CategoryHTMLGenerator,
    CampaignHTMLGenerator,
)
from src.logger.logger import logger

from src.utils.file import (read_text_file,
                        get_filenames_from_directory,
                        get_directory_names,
                        )\nfrom src.utils.jjson import j_dumps, j_loads_ns, j_loads
from src.utils.convertors.csv import csv2dict
from src.utils.file import save_text_file
from src.utils.printer import pprint

from src.suppliers.aliexpress.utils.extract_product_id import extract_prod_ids
from src.logger.logger import logger

class AliPromoCampaign:
    """Управление рекламной кампанией."""

    # Class attributes declaration
    language: str = None
    currency: str = None
    base_path: Path = None
    campaign_name: str = None
    campaign: SimpleNamespace = None
    campaign_ai: SimpleNamespace = None
    gemini: GoogleGenerativeAi = None
    openai: OpenAIModel = None

    def __init__(
        self,
        campaign_name: str,
        language: Optional[str] = None,
        currency: Optional[str] = None,
        model:str = 'openai'
    ):
        """Инициализация объекта AliPromoCampaign для рекламной кампании.

        Args:
            campaign_file (Optional[str | Path]): Путь к файлу кампании или ссылка для загрузки кампании.
            campaign_name (Optional[str]): Название кампании.
            language (Optional[str | dict]): Язык, используемый в кампании.
            currency (Optional[str]): Валюта, используемая в кампании.

        Returns:
            SimpleNamespace: Объект, представляющий кампанию.

        Example:
            >>> campaign = AliPromoCampaign(campaign_name="SummerSale", language="EN", currency="USD")
            >>> print(campaign.campaign_name)

        """
        ...
        self.base_path = gs.path.google_drive / "aliexpress" / "campaigns" / campaign_name
        campaign_file_path = self.base_path / f"{language}_{currency}.json"
        self.campaign = j_loads_ns(
            campaign_file_path, exc_info=False
        )  # <- файла может не быть, если я создаю новую рекламную камапнию - файл будет создан ИИ
        if not self.campaign:
            logger.warning(
                f"Campaign file not found at {campaign_file_path=}\\nStart as new \\n (Start build JSON file, categories, products etc.)"
            )
            """ Если в корне рекламной кампании нет файла JSON -> запускается процесс создания новой реклмной кампании
            создадутся категории из названий директорий ц директории `catergorry`,\n            соберутся affiliated товары в файлы <product_id>.JSON\n            сгенеририуется ai параметры\n            """
            self.process_new_campaign(
                campaign_name=campaign_name, language=language, currency=currency
            )  # <- создание новой рекламной кампании
            return
        if self.campaign.language and self.campaign.currency:\n            self.language, self.currency = (
                self.campaign.language,
                self.campaign.currency,
            )
        else:
            self.language, self.currency = language, currency

        #self.campaign_ai = copy.copy(self.campaign)
        self._models_payload()


    def _models_payload(self):\n        \"\"\" \"\"\"\n        #self.campaign_ai_file_name = f"{self.language}_{self.currency}_{model}_{gs.now}.json"
        system_instruction_path = gs.path.src / \'ai\' / \'prompts\' / \'aliexpress_campaign\' / \'system_instruction.txt\'\n        system_instruction: str = read_text_file(system_instruction_path)\n        #self.model = OpenAIModel(system_instruction=system_instruction, \n        #                         assistant_id = gs.credentials.openai.assistant.category_descriptions)  \n        self.gemini = GoogleGenerativeAi(system_instruction = system_instruction)\n        assistant_id = "asst_dr5AgQnhhhnef5OSMzQ9zdk9" # <-  задача asst_dr5AgQnhhhnef5OSMzQ9zdk9 создание категорий и описаний на основе списка названий товаров\n        #self.openai = OpenAIModel(system_instruction = system_instruction, assistant_id = assistant_id)\n\n    def process_campaign(self):\n        \"\"\"Функция итерируется по категориям рекламной кампании и обрабатывает товары категории через генератор партнерских ссылок.\n\n        Example:\n            >>> campaign.process_campaign()\n        \"\"\"\n        ...\n        categories_names_list = get_directory_names(self.base_path / \'category\') # читаю название папок категорий\n        for category_name in categories_names_list:\n            logger.info(f"Starting {category_name=}")\n            self.process_category_products(category_name)\n            logger.info(f"Starting AI category")\n            self.process_llm_category(category_name)\n            ...\n\n\n    def process_campaign_category(\n        self, category_name: str\n    ) -> list[SimpleNamespace] | None:\n        \"\"\"\n        Processes a specific category within a campaign for all languages and currencies.\n        @param campaign_name: Name of the advertising campaign.\n        @param category_name: Category for the campaign.\n        @param language: Language for the campaign.\n        @param currency: Currency for the campaign.\n        @return: List of product titles within the category.\n        \"\"\"\n        ...\n        # Process category products and get the list of products\n        self.process_category_products(category_name=category_name)\n        self.process_llm_category(category_name=category_name)\n\n    def process_new_campaign(\n        self,\n        campaign_name: str,\n        language: Optional[str] = None,\n        currency: Optional[str] = None,\n    ):\n        \"\"\"Создание новой рекламной кампании.\n        Условия для создания кампании:\n        - директория кампании с питоник названием\n        - вложенная директория `campaign`, в ней директории с питоник названиями категорий\n        - файл sources.txt и/или директория `sources` с файлами `<product)id>.html`\n\n        Args:\n            campaign_name (Optional[str]): Название рекламной кампании.\n            language (Optional[str]): Язык для кампании (необязательно).\n            currency (Optional[str]): Валюта для кампании (необязательно).\n\n        Returns:\n            List[Tuple[str, Any]]: Список кортежей с именами категорий и их обработанными результатами.\n\n        Example:\n            >>> campaign.process_new_campaign(campaign_name="HolidaySale", language="RU", currency="ILS")\n\n        Flowchart:\n        ┌──────────────────────────────────────────────┐\n        │ Start                                        │\n        └──────────────────────────────────────────────┘\n                          │\n                          ▼\n        ┌───────────────────────────────────────────────┐\n        │ Check if `self.language` and `self.currency`  │\n        │ are set                                       │\n        └───────────────────────────────────────────────┘\n                          │\n                ┌─────────┴──────────────────────────┐\n                │                                    │\n                ▼                                    ▼\n        ┌─────────────────────────────┐   ┌──────────────────────────────────────┐\n        │Yes: `locale` = `{language:  │   │No: `locale` = {                      │\n        │currency}`                   │   │     "EN": "USD",                     │\n        │                             │   │     "HE": "ILS",                     │\n        │                             │   │     "RU": "ILS"                      │\n        │                             │   │    }                                 │\n        └─────────────────────────────┘   └──────────────────────────────────────┘\n                         │                         │\n                         ▼                         ▼\n        ┌───────────────────────────────────────────────┐\n        │ For each `language`, `currency` in `locale`:  │\n        │ - Set `self.language`, `self.currency`        │\n        │ - Initialize `self.campaign`                  │\n        └───────────────────────────────────────────────┘\n                         │\n                         ▼\n        ┌───────────────────────────────────────────────┐\n        │ Call `self.set_categories_from_directories()` │\n        │ to populate categories                        │\n        └───────────────────────────────────────────────┘\n                         │\n                         ▼\n        ┌───────────────────────────────────────────────┐\n        │ Copy `self.campaign` to `self.campaign_ai`    │\n        │ and set `self.campaign_ai_file_name`          │\n        └───────────────────────────────────────────────┘\n                         │\n                         ▼\n        ┌───────────────────────────────────────────────┐\n        │ For each `category_name` in campaign:         │\n        │ - Call `self.process_category_products`       │\n        │ - Call `self.process_llm_category`             │\n        └───────────────────────────────────────────────┘\n                         │\n                         ▼\n        ┌──────────────────────────────────────────────┐\n        │ End                                          │\n        └──────────────────────────────────────────────┘\n\n        \"\"\"\n        ...\n        if not language and not currency:\n            # Process all locales if language or currency is not provided\n            _l = [(lang, curr) for locale in locales for lang, curr in locale.items()]\n        else:\n            _l = [(language, currency)]\n\n        for language, currency in _l:\n            self.language, self.currency = language, currency\n            self.campaign = SimpleNamespace(\n                **{\n                    "campaign_name": campaign_name,\n                    "title": "",\n                    "language": language,\n                    "currency": currency,\n                    "description": "",\n                    "category": SimpleNamespace(),\n                }\n            )\n\n            self.set_categories_from_directories()\n            self.campaign_ai = copy.copy(\n                self.campaign\n            )  # <- паралельно создаю ai кампанию\n            self.campaign_ai_file_name = f"{language}_{currency}_AI_{gs.now}.json"\n            for category_name in self.campaign.category.__dict__:\n                self.process_category_products(category_name)\n\n                self.process_llm_category(category_name)\n                j_dumps(\n                    self.campaign_ai,\n                    self.base_path / f"{self.language}_{self.currency}.json",\n                )  # <- в вновь созданный файл категорий\n\n    def process_llm_category(self, category_name: Optional[str] = None):\n        \"\"\"Processes the AI campaign for a specified category or all categories.\n\n            This method processes AI-generated data for the specified category in the campaign.\n            If no category name is provided, it processes all categories.\n\n            Args:\n                category_name (Optional[str]): The name of the category to process. If not provided, all categories are processed.\n\n            Example:\n                >>> campaign.process_llm_category("Electronics")\n                >>> campaign.process_llm_category()\n\n            Flowchart:\n            ┌──────────────────────────────────────────────┐\n            │ Start                                        │\n            └──────────────────────────────────────────────┘\n                                │\n                                ▼\n            ┌───────────────────────────────────────────────┐\n            │ Load system instructions from JSON file       │\n            └───────────────────────────────────────────────┘\n                                │\n                                ▼\n            ┌───────────────────────────────────────────────┐\n            │ Initialize AI model with system instructions  │\n            └───────────────────────────────────────────────┘\n                                │\n                                ▼\n            ┌───────────────────────────────────────────────┐\n            │ Check if `category_name` is provided          │\n            └───────────────────────────────────────────────┘\n                                │\n                ┌─────────────────┴───────────────────┐\n                │                                     │\n                ▼                                     ▼\n        ┌─────────────────────────────────────┐   ┌────────────────────────────────────┐\n        │ Process specified category          │   │ Iterate over all categories        │\n        │ - Load product titles               │   │ - Call `_process_category`         │\n        │ - Generate prompt                   │   │   for each category                │\n        │ - Get response from AI model        │   └────────────────────────────────────┘\n        │ - Update or add category            │\n        └─────────────────────────────────────┘\n                                │\n                                ▼\n            ┌───────────────────────────────────────────────┐\n            │ Save updated campaign data to file            │\n            └───────────────────────────────────────────────┘\n                                │\n                                ▼\n            ┌──────────────────────────────────────────────┐\n            │ End                                          │\n            └──────────────────────────────────────────────┘\n\n        \"\"\"\n        campaign_ai = copy.copy(self.campaign)\n\n\n        def _process_category(category_name: str):\n            \"\"\"Processes AI-generated category data and updates the campaign category.\"\"\"\n\n            titles_path: Path = (\n                self.base_path\n                / "category"\n                / category_name\n                / f"{campaign_ai.language}_{campaign_ai.currency}"\n                / "product_titles.txt"\n            )\n            product_titles = read_text_file(titles_path, as_list=True)\n            prompt = f"language={campaign_ai.language}\\n{category_name=}\\n{product_titles=}"\n\n            if not self.gemini or not self.openai:\n                self._models_payload()\n\n            def get_response(_attempts: int = 5):\n                \"\"\"Gets the response from the AI model.\"\"\"\n                #return [self.gemini.ask(prompt), self.openai.ask(prompt)]\n                #gemini_response, openai_response = self.gemini.ask(prompt), self.openai.ask(prompt)\n                return self.gemini.ask(prompt)\n                ...\n\n            response = get_response()\n            if not response:\n                return\n\n            try:\n                res_ns: SimpleNamespace = j_loads_ns(response)  # <- превращаю ответ машины в объект SimpleNamespace\n                if hasattr(campaign_ai.category, category_name):\n                    current_category = getattr(campaign_ai.category, category_name)\n                    nested_category_ns = getattr(res_ns, category_name)\n                    for key, value in vars(nested_category_ns).items():\n                        setattr(current_category, key, fix_json_string(value))\n                    logger.debug(f"Category {category_name=} updated", None, False)\n                else:\n                    setattr(campaign_ai.category, category_name, res_ns)\n                    logger.debug(f"Category {category_name=} created")\n            except Exception as ex:\n                logger.error(f"Error updating campaign for {category_name=}: ", ex, exc_info=False)\n                ...\n\n        # if category_name:\n        #     if not _process_category(category_name):\n        #         return\n        # else:\n        #     for category_name in vars(campaign_ai.category).keys():\n        #         _process_category(category_name)\n        \n        for category_name in vars(campaign_ai.category).keys():\n            _process_category(category_name)\n\n        j_dumps(campaign_ai, self.base_path / "ai" / f"gemini_{gs.now}_{self.language}_{self.currency}.json")\n        return\n\n    def process_category_products(\n        self, category_name: str\n    ) -> Optional[List[SimpleNamespace]]:\n        \"\"\"Processes products in a specific category.\n\n                Args:\n                    category_name (str): The name of the category.\n\n                Returns:\n                    Optional[List[SimpleNamespace]]: A list of `SimpleNamespace` objects representing the products.\n                    Returns `None` if no products are found.\n\n                Example:\n                    >>> products: List[SimpleNamespace] = campaign.process_category_products("Electronics")\n                    >>> print(len(products))\n                    20\n                    >>> for product in products:\n                    >>>     pprint(product)  # Use pprint from `src.utils.pprint`\n\n                Notes:\n                    The function attempts to read product IDs from both HTML files and text files within the specified category\'s\n                    `sources` directory. If no product IDs are found, an error is logged, and the function returns `None`.\n                    If affiliated products are found, they are returned; otherwise, an error is logged, and the function returns `None`.\n                Flowchart:\n        ┌───────────────────────────────────────────────────────────┐\n        │ Start                                                     │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Call `read_sources(category_name)` to get product IDs     │\n        │ - Searches for product IDs in HTML files and sources.txt  │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Check if `prod_ids` is empty                              │\n        │ - If empty, log an error and return `None`                │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Initialize `AliAffiliatedProducts` with `language`        │\n        │ and `currency`                                            │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Call `process_affiliate_products`                         │\n        │ - Pass `campaign`, `category_name`, and `prod_ids`        │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Check if `affiliated_products` is empty                   │\n        │ - If empty, log an error and return `None`                │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ Return `affiliated_products`                              │\n        └───────────────────────────────────────────────────────────┘\n                      │\n                      ▼\n        ┌───────────────────────────────────────────────────────────┐\n        │ End                                                       │\n        └───────────────────────────────────────────────────────────┘\n\n        \"\"\"\n\n        def read_sources(category_name: str) -> Optional[List[str]]:\n            \"\"\"Reads product sources and extracts product IDs.\n\n            Args:\n                category_name (str): The name of the category.\n\n            Returns:\n                Optional[List[str]]: A list of product IDs if found; otherwise, `None`.\n\n            Example:\n                >>> product_ids: Optional[List[str]] = read_sources("Electronics")\n                >>> print(product_ids)\n                [\'12345\', \'67890\', ...]\n\n            Notes:\n                This function looks for product IDs in both HTML files and a `sources.txt` file located\n                in the category\'s `sources` directory. If no product IDs are found, it returns `None`.\n            \"\"\"\n            product_ids = []\n            html_files = get_filenames(\n                self.base_path / "category" / category_name / "sources",\n                extensions=".html",\n                exc_info=False,\n            )\n            if html_files:\n                product_ids.extend(extract_prod_ids(html_files))\n            product_urls = read_text_file(\n                self.base_path / "category" / category_name / "sources.txt",\n                as_list = True,\n                exc_info = False,\n            )\n\n            if product_urls:\n                _ = extract_prod_ids(product_urls)\n                product_ids.extend(_)\n            if not product_ids:\n                return \n            return product_ids\n\n        prod_ids = read_sources(category_name)\n\n        if not prod_ids:\n            logger.error(\n                f"No products found in category {category_name}/{self.language}_{self.currency}.",\n                exc_info=False,\n            )\n            ...\n            return\n\n        promo_generator = AliAffiliatedProducts(\n            language = self.language, currency = self.currency\n        )\n\n        return asyncio.run(promo_generator.process_affiliate_products(\n            prod_ids = prod_ids,\n            category_root = self.base_path\n            / "category"\n            / category_name,\n        ))\n\n\n    def dump_category_products_files(\n        self, category_name: str, products: List[SimpleNamespace]\n    ):\n        \"\"\"Сохранение данных о товарах в JSON файлы.\n\n        Args:\n            category_name (str): Имя категории.\n            products (List[SimpleNamespace]): Список объектов SimpleNamespace, представляющих товары.\n\n        Example:\n            >>> campaign.dump_category_products_files("Electronics", products)\n        \"\"\"\n        if not products:\n            logger.warning("No products to save.")\n            return\n\n        category_path = Path(self.base_path / "category" / category_name)\n        for product in products:\n            product_id = getattr(product, "product_id", None)\n            if not product_id:\n                logger.warning(f"Skipping product without product_id: {product}")\n                continue\n            j_dumps(product, category_path / f"{product_id}.json")\n\n    def set_categories_from_directories(self):\n        \"\"\"Устанавливает категории рекламной кампании из названий директорий в `category`.\n\n        Преобразует каждый элемент списка категорий в объект `SimpleNamespace` с атрибутами\n        `category_name`, `title`, и `description`.\n\n        Example:\n            >>> self.set_categories_from_directories()\n            >>> print(self.campaign.category.category1.category_name)\n        \"\"\"\n        category_dirs = self.base_path / "category"\n        categories = get_directory_names(category_dirs)\n\n        # Ensure that self.campaign.category is an object of SimpleNamespace\n        if not hasattr(self.campaign, "category"):\n            self.campaign.category = SimpleNamespace()\n\n        # Add each category as an attribute to the campaign\'s category SimpleNamespace\n        for category_name in categories:\n            setattr(\n                self.campaign.category,\n                category_name,\n                SimpleNamespace(category_name=category_name, title="", description=""),\n            )\n\n    \n    async def generate_output(self, campaign_name: str, category_path: str | Path, products_list: list[SimpleNamespace] | SimpleNamespace):\n        \"\"\"\n        Saves product data in various formats:\n\n        - `<product_id>.json`: Contains all product parameters, one file per product.\n        - `ai_{timestamp}.json`: A common file for all products with specific keys.\n        - `promotion_links.txt`: A list of product links, created in the `save_promotion_links()` function.\n        - `category_products_titles.json`: File containing title, `product_id`, `first_category_name`, and `second_category_name` of each product in the category.\n\n        Args:\n            campaign_name (str): The name of the campaign for the output files.\n            category_path (str | Path): The path to save the output files.\n            products_list (list[SimpleNamespace] | SimpleNamespace): List of products or a single product to save.\n\n        Returns:\n            None\n\n        Example:\n            >>> products_list: list[SimpleNamespace] = [\n            ...     SimpleNamespace(product_id="123", product_title="Product A", promotion_link="http://example.com/product_a", \n            ...                     first_level_category_id=1, first_level_category_name="Category1",\n            ...                     second_level_category_id=2, second_level_category_name="Subcategory1", \n            ...                     product_main_image_url="http://example.com/image.png", product_video_url="http://example.com/video.mp4"),\n            ...     SimpleNamespace(product_id="124", product_title="Product B", promotion_link="http://example.com/product_b",\n            ...                     first_level_category_id=1, first_level_category_name="Category1",\n            ...                     second_level_category_id=3, second_level_category_name="Subcategory2",\n            ...                     product_main_image_url="http://example.com/image2.png", product_video_url="http://example.com/video2.mp4")\n            ... ]\n            >>> category_path: Path = Path("/path/to/category")\n            >>> await generate_output("CampaignName", category_path, products_list)\n\n        Flowchart:\n            ┌───────────────────────────────┐\n            │  Start `generate_output`      │\n            └───────────────────────────────┘\n                        │\n                        ▼\n            ┌───────────────────────────────┐\n            │ Format `timestamp` for file   │\n            │ names.                        │\n            └───────────────────────────────┘\n                        │\n                        ▼\n            ┌───────────────────────────────┐\n            │ Check if `products_list` is   │\n            │ a list; if not, convert it to │\n            │ a list.                       │\n            └───────────────────────────────┘\n                        │\n                        ▼\n        ┌───────────────────────────────┐\n        │ Initialize `_data_for_openai`,│\n        │ `_promotion_links_list`, and  │\n        │ `_product_titles` lists.      │\n        └───────────────────────────────┘\n                        │\n                        ▼\n    ┌─────────────────────────────────────────┐\n    │ For each `product` in `products_list`:  │\n    └─────────────────────────────────────────┘\n                        │\n                        ▼\n    ┌───────────────────────────────────────────────┐\n    │ 1. Create `categories_convertor` dictionary   │\n    │ for `product`.                                │\n    └───────────────────────────────────────────────┘\n                        │\n                        ▼\n    ┌───────────────────────────────────────────────┐\n    │ 2. Add `categories_convertor` to `product`.   │\n    └───────────────────────────────────────────────┘\n                        │\n                        ▼\n    ┌───────────────────────────────────────────────┐\n    │ 3. Save `product` as `<product_id>.json`.     │\n    └───────────────────────────────────────────────┘\n                        │\n                        ▼\n    ┌───────────────────────────────────────────────┐\n    │ 4. Append `product_title` and                 │\n    │ `promotion_link` to their respective lists.   │\n    └───────────────────────────────────────────────┘\n                        │                                               \n                        ▼\n        ┌───────────────────────────────┐\n        │ Call `save_product_titles`    │\n        │ with `_product_titles` and    │\n        │ `category_path`.              │\n        └───────────────────────────────┘\n                        │\n                        ▼\n        ┌───────────────────────────────┐\n        │ Call `save_promotion_links`   │\n        │ with `_promotion_links_list`  │\n        │ and `category_path`.          │\n        └───────────────────────────────┘\n                        │\n                        ▼\n        ┌───────────────────────────────────┐\n        │ Call `generate_html` with         │\n        │ `campaign_name`, `category_path`, │\n        │ and `products_list`.              │\n        └───────────────────────────────────┘\n                        │\n                        ▼\n        ┌───────────────────────────────┐\n        │  End `generate_output`        │\n        └───────────────────────────────┘\n\n        \"\"\"\n        timestamp = datetime.now().strftime("%Y-%m-%d %H%M%S")\n        products_list = products_list if isinstance(products_list, list) else [products_list]\n        _data_for_openai: dict = {}\n        _promotion_links_list: list = []\n        _product_titles: list = []\n\n        for product in products_list:\n            # Adding the categories_convertor dictionary\n            categories_convertor = {\n                str(product.first_level_category_id): {\n                    "ali_category_name": product.first_level_category_name,\n                    "ali_parent": "",\n                    "PrestaShop_categories": [],\n                    "PrestaShop_main_category": ""\n                },\n                str(product.second_level_category_id): {\n                    "ali_category_name": product.second_level_category_name,\n                    "ali_parent": str(product.first_level_category_id),\n                    "PrestaShop_categories": [],\n                    "PrestaShop_main_category": ""\n                }\n            }\n            product.categories_convertor = categories_convertor\n\n            # Save individual product JSON\n            j_dumps(product, Path(category_path / f"{self.language}_{self.currency}" / f"{product.product_id}.json"), exc_info=False)\n            _product_titles.append(product.product_title)\n            _promotion_links_list.append(product.promotion_link)\n\n        await self.save_product_titles(product_titles=_product_titles, category_path=category_path)\n        await self.save_promotion_links(promotion_links=_promotion_links_list, category_path=category_path)\n        await self.generate_html(campaign_name=campaign_name, category_path=category_path, products_list=products_list)\n\n    async def generate_html(self, campaign_name:str, category_path: str | Path, products_list: list[SimpleNamespace] | SimpleNamespace):\n        \"\"\" Creates an HTML file for the category and a root index file.\n    \n        @param products_list: List of products to include in the HTML.\n        @param category_path: Path to save the HTML file.\n        \"\"\"\n        ...\n        products_list = products_list if isinstance(products_list, list) else [products_list]\n\n        category_name = Path(category_path).name\n        category_html_path:Path = Path(category_path) /  f"{self.language}_{self.currency}" / f\'{category_name}.html\'\n    \n        # Initialize the category dictionary to store product titles\n        category = {\n            "products_titles": []\n        }\n    \n        html_content = f\"\"\"<!DOCTYPE html>\n        <html lang="en">\n        <head>\n        <meta charset="UTF-8">\n        <meta name="viewport" content="width=device-width, initial-scale=1.0">\n        <title>{category_name} Products</title>\n        <link rel="stylesheet" href="styles.css">\n        </head>\n        <body>\n        <h1>{category_name} Products</h1>\n        <div class="product-grid">\n        \"\"\"\n\n        for product in products_list:\n            # Add the product\'s details to the category\'s products_titles\n            category["products_titles"].append({\n                "title": product.product_title,\n                "product_id": product.product_id,\n                "first_category_name": product.first_level_category_name,\n                "second_category_name": product.second_level_category_name\n            })\n\n