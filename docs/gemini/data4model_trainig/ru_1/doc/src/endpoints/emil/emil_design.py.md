# Модуль `emil_design`

## Обзор

Модуль `emil_design` предназначен для управления и обработки изображений, а также для продвижения контента на платформах Facebook и PrestaShop. Он ориентирован на работу с магазином `emil-design.com`.

## Подробней

Этот модуль предоставляет функциональность для автоматизации процессов, связанных с описанием изображений с использованием AI, загрузкой информации о продуктах в PrestaShop и продвижением этих продуктов в социальных сетях, таких как Facebook. Модуль использует различные API и инструменты для достижения этих целей.

## Классы

### `Config`

**Описание**: Класс `Config` предназначен для хранения и управления конфигурационными параметрами, необходимыми для работы с API PrestaShop. Он определяет конечную точку API (`ENDPOINT`), режим работы (`MODE`), формат POST-запросов (`POST_FORMAT`), а также домен API (`API_DOMAIN`) и ключ API (`API_KEY`). Класс поддерживает как использование переменных окружения, так и чтение параметров из `gs.credentials`.

**Атрибуты**:
- `ENDPOINT` (str): Конечная точка API, по умолчанию `'emil'`.
- `MODE` (str): Режим работы, определяющий используемый API (dev, dev8, prod).
- `POST_FORMAT` (str): Формат POST-запросов, по умолчанию `'XML'`.
- `API_DOMAIN` (str): Домен API.
- `API_KEY` (str): Ключ API.

**Принцип работы**:
Класс `Config` сначала пытается загрузить значения `API_DOMAIN` и `API_KEY` из переменных окружения, если `USE_ENV` установлен в `True`. В противном случае, он использует значения, хранящиеся в `gs.credentials` в зависимости от значения `MODE`. Если `MODE` не имеет допустимого значения, устанавливается режим `dev`.

### `EmilDesign`

**Описание**: Класс `EmilDesign` предназначен для описания изображений с использованием моделей AI (Gemini и OpenAI), продвижения этих изображений в Facebook и загрузки информации о продуктах в PrestaShop.

**Атрибуты**:
- `gemini` (Optional[GoogleGenerativeAi]): Экземпляр класса `GoogleGenerativeAi` для работы с моделью Gemini.
- `openai` (Optional[OpenAIModel]): Экземпляр класса `OpenAIModel` для работы с моделью OpenAI.
- `base_path` (Path): Путь к базовой директории модуля, используется для хранения конфигурационных файлов и инструкций.
- `config` (SimpleNamespace): Конфигурация, загруженная из JSON-файла.
- `data_path` (Path): Путь к директории с данными (изображения, описания).
- `gemini_api` (str): Ключ API для Gemini.
- `presta_api` (str): Ключ API для PrestaShop.
- `presta_domain` (str): Домен PrestaShop.

**Принцип работы**:
Класс `EmilDesign` инициализирует пути к файлам конфигурации и данным, а также загружает ключи API для Gemini и PrestaShop из переменных окружения или `gs.credentials`. Он предоставляет методы для описания изображений с использованием AI, продвижения контента в Facebook и загрузки информации о продуктах в PrestaShop.

**Методы**:
- `describe_images`: Описывает изображения с использованием моделей Gemini и OpenAI.
- `promote_to_facebook`: Продвигает изображения и их описания в Facebook.
- `upload_described_products_to_prestashop`: Загружает информацию о продуктах в PrestaShop.

## Методы класса

### `describe_images`

```python
def describe_images(
    self,
    lang: str,
    models: dict = {
        'gemini': {'model_name': 'gemini-1.5-flash'},
        'openai': {'model_name': 'gpt-4o-mini', 'assistant_id': 'asst_uDr5aVY3qRByRwt5qFiMDk43'},
    },
) -> None:
    """
    Описывает изображения на основе предоставленных инструкций и примеров, используя модели Gemini и OpenAI.

    Args:
        lang (str): Язык для описания.
        models (dict, optional): Конфигурация моделей. По умолчанию используются модели Gemini и OpenAI.

    Returns:
        None

    Raises:
        FileNotFoundError: Если файлы инструкций не найдены.
        Exception: Если происходит ошибка во время обработки изображений.
    """
    ...
```

**Назначение**: Описывает изображения, используя модели Gemini и OpenAI, на основе предоставленных инструкций и примеров.

**Параметры**:
- `lang` (str): Язык, на котором должно быть сгенерировано описание изображений.
- `models` (dict, optional): Словарь, содержащий конфигурации используемых моделей. По умолчанию включает конфигурации для Gemini и OpenAI.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если не удается найти файлы инструкций.
- `Exception`: Возникает при любой ошибке, возникшей во время обработки изображений.

**Внутренние функции**:
- Отсутствуют

**Как работает функция**:
1. Формирует путь к файлам инструкций и категорий мебели на основе переданного языка.
2. Считывает содержимое файлов инструкций и категорий мебели.
3. Добавляет категории мебели в системную инструкцию.
4. Определяет пути к файлу с описанными изображениями и директории с изображениями для обработки.
5. Формирует список изображений, которые еще не были обработаны.
6. Инициализирует модели Gemini и/или OpenAI, если это указано в конфигурации.
7. Перебирает список изображений для обработки.
8. Получает необработанные данные изображения.
9. Запрашивает описание изображения у модели Gemini.
10. Сохраняет полученное описание в JSON-файл.
11. Добавляет путь к обработанному изображению в список обработанных изображений и сохраняет его в файл.
12. Делает паузу между запросами, чтобы избежать перегрузки API.

**Примеры**:

```python
emil = EmilDesign()
emil.describe_images('he')
```

### `promote_to_facebook`

```python
async def promote_to_facebook(self) -> None:
    """
    Продвигает изображения и их описания в Facebook.

    Args:
        None

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка во время продвижения в Facebook.
    """
    ...
```

**Назначение**: Продвигает изображения и их описания в Facebook, используя веб-драйвер для автоматизации действий.

**Параметры**:
- Отсутствуют

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Возникает при любой ошибке, произошедшей во время продвижения в Facebook.

**Внутренние функции**:
- Отсутствуют

**Как работает функция**:
1. Инициализирует веб-драйвер Chrome.
2. Открывает указанную группу Facebook.
3. Загружает описания изображений из JSON-файла.
4. Перебирает сообщения с описаниями.
5. Формирует объект сообщения с заголовком и описанием.
6. Вызывает функцию `post_message` для публикации сообщения в Facebook.

**Примеры**:

```python
emil = EmilDesign()
asyncio.run(emil.promote_to_facebook())
```

### `upload_described_products_to_prestashop`

```python
def upload_described_products_to_prestashop(
    self, products_list: Optional[List[SimpleNamespace]] = None, id_lang: Optional[int | str] = 2, *args, **kwards
) -> bool:
    """
    Загружает информацию о продуктах в PrestaShop.

    Args:
        products_list (Optional[List[SimpleNamespace]], optional): Список информации о продуктах. По умолчанию `None`.
        id_lang (Optional[int | str], optional): ID языка для PrestaShop.

    Returns:
        bool: `True`, если загрузка прошла успешно, `False` в противном случае.

    Raises:
        FileNotFoundError: Если файл `locales.json` не найден.
        Exception: Если происходит ошибка во время загрузки в PrestaShop.
    """
    ...
```

**Назначение**: Загружает информацию о продуктах в PrestaShop, используя API PrestaShop.

**Параметры**:
- `products_list` (Optional[List[SimpleNamespace]], optional): Список информации о продуктах. По умолчанию `None`.
- `id_lang` (Optional[int | str], optional): ID языка для PrestaShop.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если не удается найти файл `locales.json`.
- `Exception`: Возникает при любой ошибке, произошедшей во время загрузки в PrestaShop.

**Внутренние функции**:
- Отсутствуют

**Как работает функция**:
1. Получает список файлов с информацией о продуктах из указанной директории.
2. Загружает информацию о продуктах из JSON-файлов.
3. Инициализирует класс `PrestaProduct` для работы с API PrestaShop.
4. Загружает соответствия языков из файла `locales.json`.
5. Проверяет формат ID языка и преобразует его, если необходимо.
6. Перебирает список продуктов.
7. Формирует объект `ProductFields` с информацией о продукте.
8. Добавляет новый продукт в PrestaShop с помощью метода `add_new_product` класса `PrestaProduct`.

**Примеры**:

```python
emil = EmilDesign()
emil.upload_described_products_to_prestashop(id_lang=2)