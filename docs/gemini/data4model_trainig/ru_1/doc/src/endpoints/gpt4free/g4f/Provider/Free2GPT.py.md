# Модуль `Free2GPT`

## Обзор

Модуль `Free2GPT` предоставляет асинхронный интерфейс для взаимодействия с сервисом `chat10.free2gpt.xyz`. Он позволяет генерировать ответы на основе предоставленных сообщений, используя модели `gemini-1.5-pro` или `gemini-1.5-flash`. Модуль поддерживает прокси и обеспечивает обработку ошибок, включая ограничение скорости запросов.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими функциональности генерации текста. Он использует асинхронные запросы для неблокирующей работы и предоставляет возможность использования прокси для обхода ограничений сети.

## Классы

### `Free2GPT`

**Описание**: Класс `Free2GPT` предоставляет методы для взаимодействия с сервисом `chat10.free2gpt.xyz`. Он поддерживает асинхронную генерацию текста на основе предоставленных сообщений и модели.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса `chat10.free2gpt.xyz`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-pro`).
- `models` (List[str]): Список поддерживаемых моделей (`gemini-1.5-pro`, `gemini-1.5-flash`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от сервиса.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    connector: BaseConnector = None,
    **kwargs,
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от сервиса.

    Args:
        model (str): Модель для использования (например, `gemini-1.5-pro`).
        messages (Messages): Список сообщений для отправки в сервис.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        connector (BaseConnector, optional): Aiohttp коннектор. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий чанки текста ответа.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: При других ошибках при запросе.

    """
    ...
```

**Назначение**: Создает асинхронный генератор для получения ответов от сервиса `chat10.free2gpt.xyz`.

**Параметры**:
- `cls`: Ссылка на класс `Free2GPT`.
- `model` (str): Модель для использования (например, `gemini-1.5-pro`).
- `messages` (Messages): Список сообщений для отправки в сервис.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `connector` (BaseConnector, optional): Aiohttp коннектор. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий чанки текста ответа.

**Вызывает исключения**:
- `RateLimitError`: Если достигнут лимит запросов.
- `Exception`: При других ошибках при запросе.

**Как работает функция**:

1. **Формирование заголовков**:
   - Определяются заголовки HTTP-запроса, включая `User-Agent`, `Accept`, `Accept-Language`, `Accept-Encoding`, `Content-Type`, `Referer` и `Origin`.

2. **Создание сессии**:
   - Создается асинхронная сессия `aiohttp` с использованием предоставленного коннектора и заголовков.

3. **Формирование данных**:
   - Вычисляется текущее время в миллисекундах.
   - Формируется словарь `data`, включающий сообщения, временную метку, пароль (который всегда `None`) и подпись, сгенерированную функцией `generate_signature`.

4. **Отправка запроса**:
   - Отправляется POST-запрос к `f"{cls.url}/api/generate"` с использованием `aiohttp`.

5. **Обработка ответа**:
   - Проверяется статус ответа. Если статус равен 500 и текст ответа содержит "Quota exceeded", вызывается исключение `RateLimitError`.
   - Для всех остальных ошибок вызывается `raise_for_status(response)`, чтобы вызвать исключение для некорректного статуса ответа.

6. **Генерация чанков**:
   - Асинхронно итерируется по чанкам содержимого ответа.
   - Декодируется каждый чанк в строку, игнорируя ошибки декодирования, и выдается через `yield`.

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from aiohttp import TCPConnector

async def main():
    messages = [{"role": "user", "content": "Hello, world!"}]
    proxy = "http://your_proxy:8080"
    connector = TCPConnector(limit=50)
    
    async for chunk in Free2GPT.create_async_generator(model='gemini-1.5-pro', messages=messages, proxy=proxy, connector=connector):
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

## Функции

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """
    Генерирует подпись для запроса.

    Args:
        time (int): Временная метка.
        text (str): Текст сообщения.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись в формате hexdigest.

    """
    ...
```

**Назначение**: Генерирует подпись для запроса к API.

**Параметры**:
- `time` (int): Временная метка.
- `text` (str): Текст сообщения.
- `secret` (str, optional): Секретный ключ. По умолчанию "".

**Возвращает**:
- `str`: Сгенерированная подпись в формате hexdigest.

**Как работает функция**:

1. **Формирование сообщения**:
   - Формируется строка `message` путем конкатенации временной метки, текста сообщения и секретного ключа (если он предоставлен) через двоеточие.

2. **Вычисление SHA256**:
   - Вычисляется SHA256-хеш от строки `message`, закодированной в UTF-8.

3. **Возврат подписи**:
   - Возвращается полученный хеш в формате hexdigest.

**Примеры**:

```python
# Пример использования generate_signature
time = int(time.time() * 1e3)
text = "Hello, world!"
signature = generate_signature(time, text)
print(signature)