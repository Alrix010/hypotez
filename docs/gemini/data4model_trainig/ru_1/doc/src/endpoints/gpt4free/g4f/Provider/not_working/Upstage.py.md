# Модуль для работы с Upstage API
## Обзор

Модуль предоставляет класс `Upstage`, который позволяет взаимодействовать с API Upstage для генерации текста. Он использует асинхронные запросы для получения ответов от API и предоставляет возможность стриминга ответов.

## Подробней

Этот модуль предназначен для интеграции с сервисом Upstage, предоставляющим доступ к моделям генерации текста, таким как Solar. Он обеспечивает асинхронное взаимодействие с API Upstage, поддерживая стриминг ответов для более быстрой и плавной работы. Модуль включает в себя выбор модели, форматирование запросов и обработку ответов от API.

## Классы

### `Upstage`

**Описание**: Класс для взаимодействия с API Upstage.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Добавляет функциональность выбора модели.

**Атрибуты**:

- `url` (str): URL главной страницы Upstage.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию (`solar-pro`).
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Псевдонимы моделей для удобства использования.

**Принцип работы**:

Класс `Upstage` предназначен для асинхронного взаимодействия с API Upstage. Он использует `aiohttp.ClientSession` для отправки HTTP-запросов. Основная функциональность заключается в методе `create_async_generator`, который отправляет запрос к API Upstage и возвращает асинхронный генератор, выдающий текст по частям.

## Методы класса

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """
    Возвращает имя модели на основе предоставленного псевдонима или имени.

    Args:
        model (str): Имя модели или псевдоним.

    Returns:
        str: Имя модели, если псевдоним найден, иначе исходное имя или имя модели по умолчанию.

    """
```

**Назначение**: Получает имя модели на основе предоставленного псевдонима или имени.

**Параметры**:

- `model` (str): Имя модели или псевдоним.

**Возвращает**:

- `str`: Имя модели, если псевдоним найден, иначе исходное имя или имя модели по умолчанию.

**Как работает функция**:

Функция `get_model` принимает имя модели в качестве аргумента. Если имя модели присутствует в списке поддерживаемых моделей, она возвращает это имя. Если имя модели присутствует в словаре псевдонимов моделей (`model_aliases`), она возвращает соответствующее значение. В противном случае она возвращает имя модели по умолчанию (`default_model`).

**Примеры**:

```python
Upstage.get_model('solar-pro')  # Возвращает 'solar-pro'
Upstage.get_model('solar-mini') # Возвращает 'upstage/solar-1-mini-chat-ja'
Upstage.get_model('unknown')    # Возвращает 'solar-pro'
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API Upstage.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текст по частям.

    """
```

**Назначение**: Создает асинхронный генератор для получения ответов от API Upstage.

**Параметры**:

- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `kwargs` (dict): Дополнительные аргументы.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, выдающий текст по частям.

**Как работает функция**:

Функция `create_async_generator` выполняет следующие шаги:

1.  Получает имя модели с помощью `cls.get_model(model)`.
2.  Формирует заголовки HTTP-запроса, включая User-Agent, Content-Type и другие необходимые параметры.
3.  Создает `aiohttp.ClientSession` с заданными заголовками.
4.  Формирует данные запроса в формате JSON, включая сообщения и имя модели.
5.  Отправляет POST-запрос к API Upstage (`cls.api_endpoint`) с использованием `session.post`.
6.  Обрабатывает ответ от API построчно, декодируя строки из UTF-8.
7.  Извлекает контент из JSON-ответа, если строка начинается с `"data: "` и не равна `"data: [DONE]"`.
8.  Преобразует JSON-ответ в словарь с помощью `json.loads`.
9.  Извлекает контент из поля `content` внутри `data['choices'][0]['delta']`.
10. Генерирует контент, если он существует.
11. Завершает работу, когда строка равна `"data: [DONE]"`.
12. Обрабатывает исключение `json.JSONDecodeError`, если не удается декодировать JSON.

**Примеры**:

```python
async def example():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in Upstage.create_async_generator(model='solar-pro', messages=messages):
        print(chunk, end='')