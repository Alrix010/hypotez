# Модуль для реализации API, используемого в JavaScript коде

## Обзор

Модуль `js_api.py` предоставляет класс `JsApi`, который расширяет функциональность класса `Api` и предоставляет методы, доступные для вызова из JavaScript-кода, выполняющегося в веб-интерфейсе. Этот API позволяет взаимодействовать с функциональностью получения ответов от различных провайдеров, выбора изображений, использования камеры и управления состоянием пользовательского интерфейса.

## Подробней

Этот модуль играет ключевую роль в обеспечении взаимодействия между веб-интерфейсом и серверной частью приложения, предоставляя JavaScript-коду возможность запрашивать информацию, отправлять данные и управлять поведением пользовательского интерфейса. Он включает в себя методы для работы с изображениями (выбор из файловой системы или получение снимка с камеры) и для передачи запросов на получение ответов от различных провайдеров, таких как GPT-4.

## Классы

### `JsApi`

**Описание**: Класс `JsApi` расширяет класс `Api` и предоставляет методы для взаимодействия с JavaScript-кодом в веб-интерфейсе.

**Наследует**:
- `Api`: `JsApi` наследует функциональность от класса `Api`, включая методы для получения версий, моделей и провайдеров.

**Атрибуты**:
- `image` (str | None): Путь к выбранному изображению. Изначально `None`.
- `app_storage_path` (str): Путь к каталогу для хранения изображений, полученных с камеры.

**Методы**:
- `get_conversation()`: Получает разговор.
- `choose_image()`: Открывает диалог выбора изображения.
- `take_picture()`: Делает снимок с камеры.
- `on_image_selection()`: Обрабатывает выбор изображения.
- `on_camera()`: Обрабатывает снимок с камеры.
- `set_selected()`: Устанавливает состояние выбранного элемента интерфейса.
- `get_version()`: Возвращает версию API.
- `get_models()`: Возвращает список доступных моделей.
- `get_providers()`: Возвращает список доступных провайдеров.
- `get_provider_models()`: Возвращает список моделей, доступных для указанного провайдера.

**Принцип работы**:
`JsApi` служит мостом между JavaScript-кодом, выполняющимся в веб-интерфейсе, и серверной частью приложения. Он предоставляет набор методов, которые JavaScript-код может вызывать для выполнения различных задач, таких как получение ответов от провайдеров, выбор изображений, использование камеры и управление состоянием пользовательского интерфейса. Класс использует библиотеку `webview` для взаимодействия с веб-интерфейсом и библиотеки `plyer` для доступа к функциям операционной системы, таким как файловый менеджер и камера.

## Методы класса

### `get_conversation`

```python
def get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator:
    """
    Получает разговор, отправляя сообщения частями в веб-интерфейс.

    Args:
        options (dict): Параметры для создания запроса.
        message_id (str, optional): Идентификатор сообщения. По умолчанию `None`.
        scroll (bool, optional): Указывать, нужно ли прокручивать окно. По умолчанию `None`.

    Returns:
        Iterator: Итератор для обработки сообщений.

    Raises:
        Не вызывает исключений напрямую, но может пробрасывать исключения, возникшие в вызываемых методах.

    Как работает функция:
    - Получает первое окно из списка `webview.windows`.
    - Проверяет, было ли выбрано изображение, и добавляет его в параметры запроса.
    - Итерируется по сообщениям, полученным от метода `_create_response_stream`.
    - Использует `window.evaluate_js` для передачи фрагментов сообщений в JavaScript-код.
    - Проверяет, не была ли остановлена обработка сообщений в JavaScript-коде.
    - Сбрасывает атрибут `image` и вызывает метод `set_selected` для сброса состояния выбранного элемента интерфейса.
    """
```

### `choose_image`

```python
def choose_image(self):
    """
    Открывает диалог выбора изображения.

    Args:
        Нет.

    Returns:
        Нет.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Использует `filechooser.open_file` для открытия диалога выбора файла.
    - При выборе файла вызывается метод `self.on_image_selection`.
    """
```

### `take_picture`

```python
def take_picture(self):
    """
    Делает снимок с камеры.

    Args:
        Нет.

    Returns:
        Нет.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Формирует имя файла для сохранения снимка.
    - Использует `camera.take_picture` для получения снимка с камеры.
    - После получения снимка вызывается метод `self.on_camera`.
    """
```

### `on_image_selection`

```python
def on_image_selection(self, filename):
    """
    Обрабатывает выбор изображения.

    Args:
        filename (str | list): Имя выбранного файла или список имен файлов.

    Returns:
        Нет.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Извлекает имя файла из списка, если `filename` является списком.
    - Проверяет, существует ли файл.
    - Устанавливает атрибут `self.image` в имя файла, если файл существует, или в `None`, если файл не существует.
    - Вызывает метод `self.set_selected` для обновления состояния выбранного элемента интерфейса.
    """
```

### `on_camera`

```python
def on_camera(self, filename):
    """
    Обрабатывает снимок с камеры.

    Args:
        filename (str): Имя файла, в котором сохранен снимок.

    Returns:
        Нет.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Проверяет, существует ли файл.
    - Устанавливает атрибут `self.image` в имя файла, если файл существует, или в `None`, если файл не существует.
    - Вызывает метод `self.set_selected` для обновления состояния выбранного элемента интерфейса.
    """
```

### `set_selected`

```python
def set_selected(self, input_id: str = None):
    """
    Устанавливает состояние выбранного элемента интерфейса.

    Args:
        input_id (str, optional): Идентификатор выбранного элемента. По умолчанию `None`.

    Returns:
        Нет.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Получает первое окно из списка `webview.windows`.
    - Удаляет класс `selected` у всех элементов с классом `image-label.selected`.
    - Добавляет класс `selected` к элементу с идентификатором `input_id`, если `input_id` указан и является одним из "image" или "camera".
    """
```

### `get_version`

```python
def get_version(self):
    """
    Возвращает версию API.

    Args:
        Нет.

    Returns:
        str: Версия API.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Вызывает метод `get_version` родительского класса `Api`.
    """
```

### `get_models`

```python
def get_models(self):
    """
    Возвращает список доступных моделей.

    Args:
        Нет.

    Returns:
        list: Список доступных моделей.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Вызывает метод `get_models` родительского класса `Api`.
    """
```

### `get_providers`

```python
def get_providers(self):
    """
    Возвращает список доступных провайдеров.

    Args:
        Нет.

    Returns:
        list: Список доступных провайдеров.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Вызывает метод `get_providers` родительского класса `Api`.
    """
```

### `get_provider_models`

```python
def get_provider_models(self, provider: str, **kwargs):
    """
    Возвращает список моделей, доступных для указанного провайдера.

    Args:
        provider (str): Имя провайдера.
        **kwargs: Дополнительные параметры.

    Returns:
        list: Список моделей, доступных для указанного провайдера.

    Raises:
        Не вызывает исключений.

    Как работает функция:
    - Вызывает метод `get_provider_models` родительского класса `Api`.
    """
```