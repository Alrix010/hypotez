# Модуль для работы с куки
=================================================

Модуль предоставляет функциональность для загрузки и управления кукисами из различных источников, таких как браузеры и файлы (HAR и JSON).

## Обзор

Модуль `cookies.py` предназначен для автоматического извлечения кукисов из установленных браузеров (Chrome, Firefox, Opera и др.) и файлов, что позволяет использовать их при выполнении запросов к различным веб-сервисам. Это полезно для автоматизации входа в систему, обхода ограничений и т.д.

## Подробнее

Модуль содержит функции для:

- Получения кукисов из браузеров.
- Установки и удаления кукисов для определенного домена.
- Загрузки кукисов из файлов HAR и JSON.
- Управления каталогом, в котором хранятся файлы с кукисами.

В проекте `hypotez` этот модуль может использоваться для автоматической аутентификации при взаимодействии с веб-сервисами, требующими авторизации.

## Функции

### `g4f`

```python
def g4f(domain_name: str) -> list:
    """
    Загружает куки из браузера 'g4f' (если он существует).

    Args:
        domain_name (str): Домен, для которого загружаются куки.

    Returns:
        list: Список кукисов.
    """
```

**Назначение**:
Функция пытается загрузить кукисы из специального браузера `g4f`, если он установлен и настроен. Этот браузер, вероятно, используется для специфических задач, связанных с проектом `hypotez`.

**Как работает функция**:
1. Проверяет, установлен ли пакет `platformdirs`. Если нет, возвращает пустой список.
2. Определяет каталог конфигурации пользователя для `g4f`.
3. Формирует путь к файлу кукисов.
4. Проверяет существование файла кукисов. Если файл не существует, возвращает пустой список.
5. Использует функцию `chrome` из `browser_cookie3` для чтения кукисов из файла и возвращает их в виде списка.

**Примеры**:

```python
cookies = g4f(".google.com")
if cookies:
    print(f"Найдено {len(cookies)} кукисов для домена .google.com")
```

### `get_cookies`

```python
def get_cookies(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False, cache_result: bool = True) -> Dict[str, str]:
    """
    Загружает кукисы для заданного домена из всех поддерживаемых браузеров и кэширует результаты.

    Args:
        domain_name (str): Домен, для которого загружаются кукисы.
        raise_requirements_error (bool, optional): Если `True`, вызывает исключение `MissingRequirementsError`, если не установлен пакет `browser_cookie3`. По умолчанию `True`.
        single_browser (bool, optional): Если `True`, загружает кукисы только из первого найденного браузера. По умолчанию `False`.
        cache_result (bool, optional): Если `True`, кэширует результаты загрузки кукисов. По умолчанию `True`.

    Returns:
        Dict[str, str]: Словарь с именами и значениями кукисов.
    """
```

**Назначение**:
Функция предназначена для получения кукисов для указанного домена. Она использует кэширование для повышения производительности и может загружать кукисы только из одного браузера для экономии времени.

**Как работает функция**:
1. Проверяет, включено ли кэширование и есть ли кукисы для данного домена в кэше. Если да, возвращает кукисы из кэша.
2. Вызывает функцию `load_cookies_from_browsers` для загрузки кукисов из браузеров.
3. Если кэширование включено, сохраняет полученные кукисы в кэше.
4. Возвращает словарь с кукисами.

**Примеры**:

```python
cookies = get_cookies(".google.com")
if cookies:
    print(f"Найдено {len(cookies)} кукисов для домена .google.com")
```

### `set_cookies`

```python
def set_cookies(domain_name: str, cookies: Cookies = None) -> None:
    """
    Устанавливает кукисы для заданного домена.

    Args:
        domain_name (str): Домен, для которого устанавливаются кукисы.
        cookies (Cookies, optional): Словарь с кукисами для установки. Если `None`, кукисы для данного домена удаляются. По умолчанию `None`.
    """
```

**Назначение**:
Функция позволяет установить или удалить кукисы для определенного домена. Если передать словарь кукисов, они будут сохранены в кэше. Если передать `None`, кукисы для данного домена будут удалены из кэша.

**Как работает функция**:
1. Если передан словарь `cookies`, он сохраняется в кэше `CookiesConfig.cookies` для указанного домена.
2. Если `cookies` равен `None`, и для данного домена есть кукисы в кэше, они удаляются из кэша.

**Примеры**:

```python
cookies = {"name1": "value1", "name2": "value2"}
set_cookies(".example.com", cookies)

# Удаление кукисов для домена .example.com
set_cookies(".example.com")
```

### `load_cookies_from_browsers`

```python
def load_cookies_from_browsers(domain_name: str, raise_requirements_error: bool = True, single_browser: bool = False) -> Cookies:
    """
    Вспомогательная функция для загрузки кукисов из различных браузеров.

    Args:
        domain_name (str): Домен, для которого загружаются кукисы.
        raise_requirements_error (bool, optional): Если `True`, вызывает исключение `MissingRequirementsError`, если не установлен пакет `browser_cookie3`. По умолчанию `True`.
        single_browser (bool, optional): Если `True`, загружает кукисы только из первого найденного браузера. По умолчанию `False`.

    Returns:
        Dict[str, str]: Словарь с именами и значениями кукисов.
    """
```

**Назначение**:
Функция пытается загрузить кукисы для указанного домена из всех поддерживаемых браузеров, используя библиотеку `browser_cookie3`.

**Как работает функция**:
1. Проверяет, установлен ли пакет `browser_cookie3`. Если нет и `raise_requirements_error` равен `True`, вызывает исключение `MissingRequirementsError`. В противном случае возвращает пустой словарь.
2. Перебирает список браузеров `browsers`.
3. Для каждого браузера пытается получить кукисы, используя соответствующую функцию из `browser_cookie3`.
4. Если кукисы успешно получены, добавляет их в общий словарь `cookies`, исключая кукисы с истекшим сроком действия.
5. Если `single_browser` равен `True`, прекращает перебор браузеров после первого успешного получения кукисов.
6. Обрабатывает исключения `BrowserCookieError` и другие исключения, возникающие при чтении кукисов из браузера, логируя ошибки.
7. Возвращает словарь с кукисами.

**Примеры**:

```python
cookies = load_cookies_from_browsers(".google.com")
if cookies:
    print(f"Найдено {len(cookies)} кукисов для домена .google.com")
```

### `set_cookies_dir`

```python
def set_cookies_dir(dir: str) -> None:
    """
    Устанавливает каталог для хранения файлов с кукисами.

    Args:
        dir (str): Путь к каталогу.
    """
```

**Назначение**:
Функция устанавливает каталог, который будет использоваться для чтения файлов с кукисами (HAR и JSON).

**Как работает функция**:
1. Устанавливает значение атрибута `CookiesConfig.cookies_dir` равным переданному пути `dir`.

**Примеры**:

```python
set_cookies_dir("./my_cookies")
```

### `get_cookies_dir`

```python
def get_cookies_dir() -> str:
    """
    Возвращает каталог для хранения файлов с кукисами.

    Returns:
        str: Путь к каталогу.
    """
```

**Назначение**:
Функция возвращает текущий каталог, используемый для хранения файлов с кукисами.

**Как работает функция**:
1. Возвращает значение атрибута `CookiesConfig.cookies_dir`.

**Примеры**:

```python
dir_path = get_cookies_dir()
print(f"Текущий каталог для хранения кукисов: {dir_path}")
```

### `read_cookie_files`

```python
def read_cookie_files(dirPath: str = None) -> None:
    """
    Считывает файлы кукисов из указанного каталога (HAR и JSON).

    Args:
        dirPath (str, optional): Путь к каталогу. Если `None`, используется `CookiesConfig.cookies_dir`. По умолчанию `None`.
    """
```

**Назначение**:
Функция предназначена для чтения кукисов из файлов, хранящихся в формате HAR (HTTP Archive) и JSON. Она позволяет загружать кукисы, сохраненные ранее, для использования в текущей сессии.

**Как работает функция**:
1. Определяет путь к каталогу с файлами кукисов. Если `dirPath` не указан, использует значение `CookiesConfig.cookies_dir`.
2. Проверяет, доступен ли каталог для чтения. Если нет, логирует сообщение об ошибке и завершает работу.
3. Ищет в каталоге файлы с расширениями `.har` и `.json`.
4. Для каждого файла HAR пытается извлечь кукисы из записей HTTP-запросов.
5. Для каждого файла JSON пытается извлечь кукисы из объектов JSON, содержащих информацию о домене и значениях кукисов.
6. Сохраняет извлеченные кукисы в кэше `CookiesConfig.cookies`.
7. Логирует информацию о количестве добавленных кукисов для каждого домена.

**Внутренние функции**:

*   `get_domain(v: dict) -> str`
    *   **Назначение**: Извлекает домен из записи HAR-файла.
    *   **Как работает**:
        1.  Проходит по заголовкам HTTP-запроса в записи HAR-файла.
        2.  Ищет заголовки `host` или `:authority`.
        3.  Если находит один из этих заголовков, извлекает значение хоста.
        4.  Проверяет, содержит ли хост один из доменов, перечисленных в `DOMAINS`.
        5.  Если находит совпадение, возвращает домен.

**Примеры**:

```python
read_cookie_files("./my_cookies")
```

## Классы

### `CookiesConfig`

**Описание**: Класс предназначен для хранения конфигурации кукисов, такой как каталог для хранения файлов с кукисами и кэш кукисов.

**Атрибуты**:
- `cookies` (Dict[str, Cookies]): Словарь, содержащий кукисы для разных доменов.
- `cookies_dir` (str): Путь к каталогу, в котором хранятся файлы с кукисами.

**Методы**:
Класс не имеет методов, только атрибуты для хранения конфигурации.

### `DOMAINS`

Список доменов, используемый для определения домена из HAR-файлов.

## Переменные

### `browsers`

Список браузеров, из которых можно извлечь кукисы.

### `has_browser_cookie3`

Флаг, указывающий, установлен ли пакет `browser_cookie3`.

### `DOMAINS`

Список доменов, используемый при чтении HAR файлов

```python
DOMAINS = [
    ".bing.com",
    ".meta.ai",
    ".google.com",
    "www.whiterabbitneo.com",
    "huggingface.co",
    "chat.reka.ai",
    "chatgpt.com",
    ".cerebras.ai",
    "github.com",
    "huggingface.co",
    ".huggingface.co"
]