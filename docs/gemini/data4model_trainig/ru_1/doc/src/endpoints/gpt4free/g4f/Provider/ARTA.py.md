# Модуль для работы с ARTA (AsyncGeneratorProvider)
## Обзор

Модуль `ARTA` предоставляет асинхронный интерфейс для взаимодействия с сервисом генерации изображений AI-ARTA. Он включает в себя функциональность для аутентификации, запроса генерации изображений и проверки статуса генерации.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими генерации изображений с использованием AI-ARTA. Он использует асинхронные запросы для неблокирующего взаимодействия с API.

## Классы

### `ARTA`

**Описание**: Класс `ARTA` является асинхронным провайдером генерации изображений, который взаимодействует с сервисом AI-ARTA.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию.
- `ProviderModelMixin`: Предоставляет миксин для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса AI-ARTA.
- `auth_url` (str): URL для аутентификации.
- `token_refresh_url` (str): URL для обновления токена.
- `image_generation_url` (str): URL для генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель изображений по умолчанию.
- `model_aliases` (dict): Словарь с псевдонимами моделей.
- `image_models` (list): Список доступных моделей изображений.
- `models` (list): Список доступных моделей.

**Принцип работы**:
Класс `ARTA` использует асинхронные запросы для взаимодействия с API AI-ARTA. Он выполняет аутентификацию, запрашивает генерацию изображений и проверяет статус генерации, возвращая результаты в виде асинхронного генератора.

**Методы**:
- `get_auth_file()`: Возвращает путь к файлу аутентификации.
- `create_token()`: Создает токен аутентификации.
- `refresh_token()`: Обновляет токен аутентификации.
- `read_and_refresh_token()`: Считывает и обновляет токен аутентификации.
- `create_async_generator()`: Создает асинхронный генератор для генерации изображений.

## Методы класса

### `get_auth_file`

```python
@classmethod
def get_auth_file(cls) -> Path:
    """
    Определяет путь к файлу, в котором хранится информация об аутентификации для класса ARTA.

    Returns:
        Path: Объект `Path`, представляющий путь к файлу аутентификации.

    Как работает функция:
    - Функция создает путь к директории, где хранятся файлы cookie, используя метод `get_cookies_dir()`.
    - Если директория не существует, она создается.
    - Формируется имя файла, которое включает префикс "auth_", имя класса (`ARTA`) и расширение ".json".
    - Полный путь к файлу формируется путем объединения пути к директории и имени файла.
    - Функция возвращает объект `Path`, представляющий полный путь к файлу аутентификации.
    """
    ...
```

### `create_token`

```python
@classmethod
async def create_token(cls, path: Path, proxy: str | None = None) -> dict:
    """
    Создает токен аутентификации, необходимый для доступа к сервису AI-ARTA.

    Args:
        path (Path): Путь для сохранения данных аутентификации.
        proxy (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        dict: Данные аутентификации, содержащие токен.

    Raises:
        ResponseError: Если не удается получить токен аутентификации.

    Как работает функция:
    - Функция выполняет POST-запрос к `auth_url` с полезной нагрузкой `auth_payload` для получения токена аутентификации.
    - Если токен не получен, выбрасывается исключение `ResponseError`.
    - Полученные данные аутентификации сохраняются в файл, указанный в параметре `path`.
    - Функция возвращает словарь, содержащий данные аутентификации.
    """
    ...
```

### `refresh_token`

```python
@classmethod
async def refresh_token(cls, refresh_token: str, proxy: str | None = None) -> tuple[str, str]:
    """
    Обновляет токен аутентификации, используя refresh token.

    Args:
        refresh_token (str): Refresh token для обновления.
        proxy (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        tuple[str, str]: Новый токен и новый refresh token.

    Как работает функция:
    - Функция выполняет POST-запрос к `token_refresh_url` с полезной нагрузкой, содержащей `refresh_token`.
    - Из ответа извлекаются новый `id_token` и `refresh_token`.
    - Функция возвращает кортеж, содержащий новый `id_token` и `refresh_token`.
    """
    ...
```

### `read_and_refresh_token`

```python
@classmethod
async def read_and_refresh_token(cls, proxy: str | None = None) -> dict:
    """
    Считывает существующий токен аутентификации из файла и, при необходимости, обновляет его.

    Args:
        proxy (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        dict: Данные аутентификации, содержащие токен.

    Как работает функция:
    - Функция пытается считать данные аутентификации из файла, путь к которому определяется методом `cls.get_auth_file()`.
    - Если файл существует и время его последнего изменения меньше, чем `expiresIn`, функция возвращает считанные данные.
    - Если файл существует, но время его последнего изменения больше половины `expiresIn`, функция обновляет токен с использованием метода `cls.refresh_token()`.
    - Если файл не существует или не удается считать данные, функция создает новый токен с использованием метода `cls.create_token()`.
    - Функция возвращает словарь, содержащий данные аутентификации.
    """
    ...
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    negative_prompt: str = "blurry, deformed hands, ugly",
    n: int = 1,
    guidance_scale: int = 7,
    num_inference_steps: int = 30,
    aspect_ratio: str = "1:1",
    seed: int = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для запроса генерации изображений.

    Args:
        model (str): Модель для генерации изображений.
        messages (Messages): Список сообщений для формирования запроса.
        proxy (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.
        prompt (Optional[str], optional): Текст запроса. По умолчанию `None`.
        negative_prompt (Optional[str], optional): Негативный текст запроса. По умолчанию "blurry, deformed hands, ugly".
        n (Optional[int], optional): Количество изображений для генерации. По умолчанию 1.
        guidance_scale (Optional[int], optional): Масштаб соответствия запросу. По умолчанию 7.
        num_inference_steps (Optional[int], optional): Количество шагов для генерации. По умолчанию 30.
        aspect_ratio (Optional[str], optional): Соотношение сторон изображения. По умолчанию "1:1".
        seed (Optional[int], optional): Зерно для генерации случайных чисел. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Yields:
        AsyncResult: Объекты `Reasoning` и `ImageResponse`, содержащие информацию о процессе генерации и сгенерированные изображения.

    Raises:
        ResponseError: Если не удается инициировать генерацию изображения или происходит ошибка в процессе генерации.

    Как работает функция:
    - Функция принимает параметры для генерации изображения, включая модель, текст запроса, количество изображений и другие параметры.
    - Если `seed` не указан, генерируется случайное значение.
    - Функция получает токен аутентификации с использованием метода `cls.read_and_refresh_token()`.
    - Функция формирует полезную нагрузку запроса, содержащую параметры генерации изображения.
    - Функция выполняет POST-запрос к `image_generation_url` с полезной нагрузкой и заголовком `Authorization`.
    - После успешной отправки запроса функция начинает проверять статус генерации, выполняя GET-запросы к `status_check_url`.
    - Если статус равен "DONE", функция извлекает URL сгенерированных изображений и возвращает их в виде объекта `ImageResponse`.
    - Если статус равен "IN_QUEUE" или "IN_PROGRESS", функция ожидает несколько секунд и повторяет проверку статуса.
    - Если происходит ошибка в процессе генерации, выбрасывается исключение `ResponseError`.

    Пример:
    ```python
    # Пример вызова create_async_generator
    async for result in ARTA.create_async_generator(
        model="Realistic tattoo",
        messages=[{"role": "user", "content": "Generate an image of dragon"}],
        prompt="dragon",
        n=1
    ):
        if isinstance(result, Reasoning):
            print(f"Reasoning: {result.status}")
        elif isinstance(result, ImageResponse):
            print(f"Image URLs: {result.images}")
    ```
    """
    ...