# Модуль `AmigoChat.py`

## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с сервисом AmigoChat.io для выполнения задач генерации текста и изображений. Он включает поддержку различных моделей, таких как GPT-4o, Gemini, Claude, Qwen и другие, а также предоставляет функциональность для работы с API AmigoChat.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с различными AI-моделями через API AmigoChat. Он позволяет генерировать текст и изображения, используя разные модели, и предоставляет удобный интерфейс для работы с этими моделями. Модуль также поддерживает стриминг ответов для текстовых моделей и обработку ошибок.

## Классы

### `AmigoChat`

**Описание**: Класс `AmigoChat` предоставляет методы для взаимодействия с API AmigoChat для генерации текста и изображений.
**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): Базовый URL сервиса AmigoChat.
- `chat_api_endpoint` (str): URL для API генерации текста.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `chat_models` (list[str]): Список моделей, поддерживаемых для генерации текста.
- `image_models` (list[str]): Список моделей, поддерживаемых для генерации изображений.
- `models` (list[str]): Объединенный список моделей для генерации текста и изображений.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей для удобства использования.

**Принцип работы**:

Класс `AmigoChat` использует API AmigoChat для генерации текста и изображений. Он поддерживает различные модели и предоставляет методы для выбора модели, генерации идентификаторов чата и создания асинхронных генераторов для получения ответов от API. Класс также обрабатывает ошибки и повторные попытки при сбоях.

**Методы**:
- `get_personaId(cls, model: str) -> str`: Возвращает идентификатор персоны для указанной модели.
- `generate_chat_id() -> str`: Генерирует уникальный идентификатор чата.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API.

## Методы класса

### `get_personaId`

```python
    @classmethod
    def get_personaId(cls, model: str) -> str:
        """
        Возвращает идентификатор персоны для указанной модели.

        Args:
            model (str): Название модели.

        Returns:
            str: Идентификатор персоны для модели.

        Raises:
            ValueError: Если модель не найдена в списках поддерживаемых моделей.

        Как работает функция:
        - Проверяет, находится ли модель в списке моделей чата (`cls.chat_models`). Если да, возвращает `persona_id` из словаря `MODELS['chat'][model]`.
        - Если модель не найдена в списке моделей чата, проверяет, находится ли она в списке моделей изображений (`cls.image_models`). Если да, возвращает `persona_id` из словаря `MODELS['image'][model]`.
        - Если модель не найдена ни в одном из списков, вызывает исключение `ValueError` с сообщением об ошибке.

        Примеры:
            >>> AmigoChat.get_personaId('gpt-4o-mini')
            'amigo'

            >>> AmigoChat.get_personaId('flux-pro/v1.1')
            'flux-1-1-pro'
        """
        ...
```

### `generate_chat_id`

```python
    @staticmethod
    def generate_chat_id() -> str:
        """
        Генерирует уникальный идентификатор чата в формате 8-4-4-4-12 шестнадцатеричных цифр.

        Returns:
            str: Уникальный идентификатор чата.

        Как работает функция:
        - Использует функцию `uuid.uuid4()` для генерации UUID.
        - Преобразует UUID в строку.

        Примеры:
            >>> AmigoChat.generate_chat_id()
            'a1b2c3d4-e5f6-7890-1234-567890abcdef'
        """
        ...
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        stream: bool = False,
        timeout: int = 300,
        frequency_penalty: float = 0,
        max_tokens: int = 4000,
        presence_penalty: float = 0,
        temperature: float = 0.5,
        top_p: float = 0.95,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от API AmigoChat.

        Args:
            model (str): Название модели.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            stream (bool, optional): Флаг, указывающий, использовать ли потоковую передачу данных. По умолчанию `False`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию 300.
            frequency_penalty (float, optional): Штраф за частоту использования слов. По умолчанию 0.
            max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 4000.
            presence_penalty (float, optional): Штраф за наличие слов в ответе. По умолчанию 0.
            temperature (float, optional): Температура для генерации текста. По умолчанию 0.5.
            top_p (float, optional): Значение Top-p для генерации текста. По умолчанию 0.95.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов от API.

        Raises:
            ResponseStatusError: Если API возвращает ошибку статуса.
            Exception: Если возникает другая ошибка при взаимодействии с API.

        Как работает функция:
        - Получает название модели, используя метод `cls.get_model(model)`.
        - Генерирует уникальный идентификатор устройства (`device_uuid`).
        - Устанавливает максимальное количество повторных попыток (`max_retries`) равным 3.
        - Инициализирует счетчик повторных попыток (`retry_count`) равным 0.
        - В цикле `while` выполняет следующие действия до тех пор, пока счетчик повторных попыток не достигнет максимального значения:
            - Формирует заголовки запроса (`headers`) с необходимой информацией об устройстве и авторизации.
            - Создает асинхронную сессию (`StreamSession`) с заданными заголовками и прокси-сервером.
            - Если модель не находится в списке моделей изображений (`cls.image_models`):
                - Формирует данные запроса (`data`) для API генерации текста, включая идентификатор чата, параметры генерации и список сообщений.
                - Отправляет POST-запрос к API (`cls.chat_api_endpoint`) с данными запроса и временем ожидания.
                - Обрабатывает ответ от API построчно, декодируя каждую строку и удаляя префикс `data: `.
                - Извлекает содержимое (`content`) из каждой строки и возвращает его с помощью `yield`.
            - Если модель находится в списке моделей изображений (`cls.image_models`):
                - Извлекает запрос (`prompt`) из последнего сообщения.
                - Формирует данные запроса (`data`) для API генерации изображений, включая запрос и название модели.
                - Отправляет POST-запрос к API (`cls.image_api_endpoint`) с данными запроса.
                - Обрабатывает ответ от API, извлекая URL изображений и возвращая объект `ImageResponse`.
            - Если возникает исключение `ResponseStatusError` или `Exception`, увеличивает счетчик повторных попыток и генерирует новый идентификатор устройства.
            - Если счетчик повторных попыток достигает максимального значения, вызывает исключение.

        Примеры:
            >>> messages = [{'role': 'user', 'content': 'Hello, how are you?'}]
            >>> generator = AmigoChat.create_async_generator(model='gpt-4o-mini', messages=messages)
            >>> async for message in generator:
            ...     print(message)
        """
        ...
```

## Параметры класса

- `url` (str): Базовый URL сервиса AmigoChat.
- `chat_api_endpoint` (str): URL для API генерации текста.
- `image_api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `chat_models` (list[str]): Список моделей, поддерживаемых для генерации текста.
- `image_models` (list[str]): Список моделей, поддерживаемых для генерации изображений.
- `models` (list[str]): Объединенный список моделей для генерации текста и изображений.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей для удобства использования.