# Модуль для работы с провайдером Ails
=======================================

Модуль содержит класс :class:`Ails`, который предоставляет асинхронный генератор для взаимодействия с моделью GPT-3.5-turbo через API ai.ls.
Этот модуль предназначен для использования в асинхронных приложениях, где требуется потоковая передача данных.

## Обзор

Модуль `Ails` реализует асинхронный генератор провайдера для взаимодействия с API `ai.ls`. Он поддерживает потоковую передачу данных и предназначен для использования с моделью `gpt-3.5-turbo`. Модуль включает функции для форматирования временных меток и создания хешей, необходимых для запросов к API.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с AI-моделями через API `ai.ls`. Он обеспечивает асинхронное взаимодействие, что позволяет эффективно использовать ресурсы и обрабатывать данные в режиме реального времени.

## Классы

### `Ails`

**Описание**: Класс `Ails` является асинхронным генератором провайдера для взаимодействия с API `ai.ls`.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных генераторов провайдеров.

**Атрибуты**:
- `url` (str): URL API `ai.ls`.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с API ai.ls.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Указывает, должна ли быть включена потоковая передача данных.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий токены из API.

        Raises:
            Exception: Если возникает ошибка в ответе от API или если ответ содержит запрещенные токены.

        Example:
            >>> model = "gpt-3.5-turbo"
            >>> messages = [{"role": "user", "content": "Hello, world!"}]
            >>> stream = True
            >>> async for token in Ails.create_async_generator(model, messages, stream):
            ...     print(token, end="")
            Hello, world!
        """
        ...
```

**Назначение**:
Создает асинхронный генератор для взаимодействия с API `ai.ls`.

**Параметры**:
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool): Указывает, должна ли быть включена потоковая передача данных.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, такие как `temperature`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий токены из API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка в ответе от API или если ответ содержит запрещенные токены.

**Как работает функция**:
1. **Определение заголовков**: Определяются заголовки HTTP-запроса, включая авторизацию, идентификатор клиента и User-Agent.
2. **Создание сессии**: Создается асинхронная сессия с использованием `aiohttp.ClientSession` с заданными заголовками.
3. **Формирование данных запроса**: Формируются данные JSON для отправки в API, включая модель, температуру, сообщения, временную метку и хеш.
4. **Отправка запроса**: Отправляется POST-запрос к API `ai.ls` с использованием асинхронной сессии.
5. **Обработка ответа**: Полученный ответ обрабатывается построчно. Каждая строка декодируется и проверяется на наличие префикса `data: `. Если строка содержит данные, они загружаются из JSON и извлекается токен.
6. **Проверка токена**: Извлеченный токен проверяется на наличие запрещенных подстрок (`ai.ls` или `ai.ci`). Если токен содержит запрещенные подстроки, вызывается исключение.
7. **Генерация токенов**: Если токен прошел все проверки, он возвращается через генератор.

**Примеры**:

```python
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, world!"}]
stream = True
async for token in Ails.create_async_generator(model, messages, stream):
    print(token, end="")
```

## Функции

### `_hash`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """
    Создает SHA256 хеш из переданных данных.

    Args:
        json_data (dict[str, str]): Словарь с данными для хеширования.

    Returns:
        SHA256: SHA256 хеш.

    Example:
        >>> json_data = {"t": "1627780800000", "m": "Hello"}
        >>> _hash(json_data)
        <sha256 хеш>
    """
    ...
```

**Назначение**:
Создает SHA256 хеш из переданных данных.

**Параметры**:
- `json_data` (dict[str, str]): Словарь с данными для хеширования.

**Возвращает**:
- `SHA256`: SHA256 хеш.

**Как работает функция**:
1. **Формирование строки**: Формируется базовая строка для хеширования путем конкатенации значений из `json_data` и фиксированных строк.
2. **Хеширование**: Базовая строка кодируется в байты и хешируется с использованием SHA256.
3. **Возврат хеша**: Возвращается SHA256 хеш в шестнадцатеричном формате.

**Примеры**:

```python
json_data = {"t": "1627780800000", "m": "Hello"}
_hash(json_data)
```

### `_format_timestamp`

```python
def _format_timestamp(timestamp: int) -> str:
    """
    Форматирует временную метку.

    Args:
        timestamp (int): Временная метка для форматирования.

    Returns:
        str: Отформатированная временная метка.

    Example:
        >>> _format_timestamp(1627780800005)
        '1627780806'
    """
    ...
```

**Назначение**:
Форматирует временную метку, изменяя последнюю цифру в зависимости от ее четности.

**Параметры**:
- `timestamp` (int): Временная метка для форматирования.

**Возвращает**:
- `str`: Отформатированная временная метка.

**Как работает функция**:
1. **Извлечение последней цифры**: Извлекается последняя цифра из временной метки.
2. **Изменение цифры**: Если последняя цифра четная, она увеличивается на 1; в противном случае остается без изменений.
3. **Формирование новой временной метки**: Новая временная метка формируется путем вычитания последней цифры из исходной временной метки и добавления измененной цифры.
4. **Возврат отформатированной временной метки**: Возвращается отформатированная временная метка в виде строки.

**Примеры**:

```python
_format_timestamp(1627780800005)
```