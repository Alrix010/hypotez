# Модуль для работы с сервисом Mega.nz
=========================================

Модуль предоставляет класс `Mega` для взаимодействия с сервисом Mega.nz. Он позволяет выполнять такие операции, как вход в систему, получение списка файлов, скачивание файлов и загрузка файлов.

## Обзор

Этот модуль предоставляет интерфейс для взаимодействия с API сервиса Mega.nz. Он включает в себя функциональность для аутентификации, скачивания и загрузки файлов. Модуль использует различные криптографические методы для обеспечения безопасности передаваемых данных.

## Подробнее

Модуль содержит класс `Mega`, который инкапсулирует всю логику взаимодействия с API Mega.nz. Он использует библиотеки `requests`, `urlobject` и `Crypto` для выполнения HTTP-запросов и криптографических операций.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с сервисом Mega.nz.

**Атрибуты**:
- `seqno (int)`:  Идентификатор последовательности запросов.
- `sid (str)`:  Идентификатор сессии пользователя.
- `master_key (list)`: Мастер-ключ пользователя.
- `rsa_priv_key (list)`:  Приватный RSA-ключ пользователя.
- `root_id (str)`:  Идентификатор корневой папки пользователя.
- `inbox_id (str)`: Идентификатор папки входящих сообщений пользователя.
- `trashbin_id (str)`: Идентификатор корзины пользователя.

**Методы**:
- `__init__()`:  Инициализирует экземпляр класса `Mega`.
- `from_credentials(email, password)`: Создает экземпляр класса `Mega` и выполняет вход в систему с использованием email и пароля.
- `from_ephemeral()`: Создает экземпляр класса `Mega` и выполняет анонимный вход в систему.
- `api_req(data)`:  Выполняет API-запрос к сервису Mega.nz.
- `login_user(email, password)`:  Выполняет вход в систему с использованием email и пароля.
- `login_ephemeral()`:  Выполняет анонимный вход в систему.
- `_login_common(res, password)`:  Общая логика для входа в систему.
- `get_files()`:  Получает список файлов и папок пользователя.
- `download_from_url(url)`:  Скачивает файл по публичной ссылке.
- `download_file(file_id, file_key, public=False, store_path=None)`:  Скачивает файл по его идентификатору и ключу.
- `get_public_url(file_id, file_key)`:  Генерирует публичную ссылку на файл.
- `uploadfile(filename, dst=None)`:  Загружает файл на сервис Mega.nz.

#### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    Принцип работы:
        Инициализирует атрибуты seqno (случайное целое число), sid (None).
    """
```

#### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str):
    """
    Создает экземпляр класса Mega и выполняет вход в систему с использованием email и пароля.

    Args:
        cls (Mega): Класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный с использованием предоставленных учетных данных.

    Принцип работы:
        1. Создает экземпляр класса Mega.
        2. Вызывает метод login_user для аутентификации пользователя.
        3. Возвращает созданный экземпляр класса Mega.

    """
```

#### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls):
    """
    Создает экземпляр класса Mega и выполняет анонимный вход в систему.

    Args:
        cls (Mega): Класс Mega.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный анонимно.

    Принцип работы:
        1. Создает экземпляр класса Mega.
        2. Вызывает метод login_ephemeral для выполнения анонимного входа.
        3. Возвращает созданный экземпляр класса Mega.

    """
```

#### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Выполняет API-запрос к сервису Mega.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Словарь с данными для отправки в API-запросе.

    Returns:
        dict: Ответ от API в формате словаря.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    Принцип работы:
        1. Устанавливает параметры запроса, включая идентификатор запроса (seqno) и идентификатор сессии (sid), если он существует.
        2. Преобразует данные в формат JSON.
        3. Выполняет POST-запрос к API сервиса Mega.nz.
        4. Преобразует ответ в формат JSON.
        5. Если ответ содержит код ошибки, выбрасывает исключение MegaRequestException.
        6. Возвращает данные из ответа API.

    """
```

#### `login_user`

```python
def login_user(self, email: str, password: str):
    """
    Выполняет вход в систему с использованием email и пароля.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    Принцип работы:
        1. Подготавливает AES-ключ на основе пароля.
        2. Вычисляет хеш email и AES-ключа.
        3. Выполняет API-запрос для аутентификации пользователя.
        4. Вызывает метод _login_common для обработки ответа API.

    """
```

#### `login_ephemeral`

```python
def login_ephemeral(self):
    """
    Выполняет анонимный вход в систему.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    Raises:
        MegaRequestException: Если API возвращает код ошибки.

    Принцип работы:
        1. Генерирует случайные ключи.
        2. Выполняет API-запрос для получения идентификатора пользователя.
        3. Выполняет API-запрос для аутентификации пользователя.
        4. Вызывает метод _login_common для обработки ответа API.

    """
```

#### `_login_common`

```python
def _login_common(self, res: dict, password: list):
    """
    Общая логика для входа в систему.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от API.
        password (list): Ключ, используемый для шифрования.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если email и/или пароль неверны.

    Принцип работы:
        1. Проверяет, не является ли ответ кодом ошибки.
        2. Расшифровывает мастер-ключ пользователя.
        3. Если в ответе содержится идентификатор сессии (tsid), использует его для аутентификации.
        4. Если в ответе содержится идентификатор сессии (csid), расшифровывает приватный RSA-ключ и использует его для аутентификации.

    """
```

#### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов и папок пользователя.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Словарь с информацией о файлах и папках пользователя.

    Принцип работы:
        1. Выполняет API-запрос для получения списка файлов.
        2. Для каждого файла расшифровывает ключ и атрибуты.
        3. Сохраняет идентификаторы корневой папки, папки входящих сообщений и корзины.
        4. Возвращает словарь с информацией о файлах и папках.

    """
```

#### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): Публичная ссылка на файл.

    Returns:
        str: Имя скачанного файла.

    Принцип работы:
        1. Извлекает идентификатор файла и ключ из URL.
        2. Вызывает метод download_file для скачивания файла.
        3. Возвращает имя скачанного файла.

    """
```

#### `download_file`

```python
def download_file(self, file_id: str, file_key: str, public: bool = False, store_path: Optional[str] = None) -> str:
    """
    Скачивает файл по его идентификатору и ключу.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.
        public (bool): Указывает, является ли файл публичным. По умолчанию `False`.
        store_path (Optional[str]): Путь для сохранения скачанного файла. По умолчанию `None`.

    Returns:
        str: Имя скачанного файла.

    Raises:
        ValueError: Если не совпадают MAC-адреса.

    Принцип работы:
        1. Выполняет API-запрос для получения информации о файле.
        2. Расшифровывает ключ и атрибуты файла.
        3. Получает URL файла.
        4. Скачивает файл по частям, расшифровывая каждую часть.
        5. Проверяет целостность файла с помощью MAC-адреса.
        6. Сохраняет файл на диск.
        7. Возвращает имя скачанного файла.

    """
```

#### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list) -> str:
    """
    Генерирует публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (list): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.

    Принцип работы:
        1. Выполняет API-запрос для получения публичного идентификатора файла.
        2. Преобразует ключ файла в формат Base64.
        3. Формирует URL-адрес публичной ссылки.
        4. Возвращает публичную ссылку на файл.

    """
```

#### `uploadfile`

```python
def uploadfile(self, filename: str, dst: Optional[str] = None) -> dict:
    """
    Загружает файл на сервис Mega.nz.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Имя файла для загрузки.
        dst (Optional[str]): Идентификатор папки назначения. По умолчанию `None`.

    Returns:
        dict: Ответ от API.

    Принцип работы:
        1. Открывает файл для чтения в бинарном режиме.
        2. Определяет размер файла.
        3. Выполняет API-запрос для получения URL-адреса для загрузки.
        4. Генерирует случайные ключи для шифрования файла.
        5. Шифрует файл по частям и отправляет каждую часть на URL-адрес для загрузки.
        6. Вычисляет MAC-адрес файла для проверки целостности.
        7. Формирует метаданные файла, включая имя файла и зашифрованные атрибуты.
        8. Выполняет API-запрос для завершения загрузки файла.
        9. Возвращает ответ от API.

    """