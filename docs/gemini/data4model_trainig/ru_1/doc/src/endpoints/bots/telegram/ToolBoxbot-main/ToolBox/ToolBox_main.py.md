# Модуль ToolBox_main

## Обзор

Модуль `ToolBox_main.py` является основным модулем для Telegram-бота `ToolBox`. Он обрабатывает различные команды и запросы пользователей, управляет тарифами, генерирует текст и изображения, а также взаимодействует с базой данных для хранения информации о пользователях.

## Подробнее

Этот модуль является центральным элементом Telegram-бота, обрабатывающим взаимодействие с пользователями. Он включает в себя обработку команд, таких как `/start`, `/profile`, а также обработку платных подписок, промокодов и реферальных ссылок. Модуль использует базу данных для хранения информации о пользователях и их подписках, а также интегрирован с другими модулями, такими как `ToolBox_requests` и `ToolBox_DataBase`.

## Классы

В данном модуле классы не определены.

## Функции

### `process_pre_checkout_query`

```python
def process_pre_checkout_query(pre_checkout_query: types.PreCheckoutQuery) -> None:
    """Обрабатывает предварительный запрос перед оплатой.

    Args:
        pre_checkout_query (types.PreCheckoutQuery): Объект запроса от Telegram перед подтверждением оплаты.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает предварительный запрос перед оплатой, подтверждая возможность проведения платежа.

**Параметры**:
- `pre_checkout_query` (types.PreCheckoutQuery): Объект запроса от Telegram, содержащий информацию о предварительной оплате.

**Как работает функция**:
Функция принимает запрос `pre_checkout_query` и использует метод `answer_pre_checkout_query` объекта `bot` для подтверждения возможности проведения оплаты. Если оплата подтверждена, бот отправляет ответ `ok=True`, что позволяет пользователю продолжить процесс оплаты.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при поступлении запроса
```

### `successful_payment`

```python
def successful_payment(message: types.Message) -> None:
    """Обрабатывает успешное завершение оплаты.

    Args:
        message (types.Message): Объект сообщения от Telegram об успешной оплате.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает уведомление об успешной оплате от пользователя, обновляя данные о подписке пользователя в базе данных и отправляя подтверждающее сообщение.

**Параметры**:
- `message` (types.Message): Объект сообщения от Telegram, содержащий информацию об успешной оплате.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `message`.
2.  Определяет тип оплаченного тарифа (`basic` или `pro`) на основе `invoice_payload`.
3.  Обновляет параметры подписки пользователя в словаре `db`.
4.  Начисляет токены в зависимости от типа подписки.
5.  Устанавливает дату окончания подписки.
6.  Обновляет информацию о пользователе в базе данных с помощью `base.insert_or_update_data`.
7.  Отправляет пользователю сообщение с благодарностью за оплату и подтверждением активации подписки.
8.  Вызывает функцию `tb.restart(message)` для перезапуска бота и обновления интерфейса пользователя.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при поступлении сообщения об успешной оплате
```

### `StartProcessing`

```python
def StartProcessing(message: types.Message) -> None:
    """Обрабатывает команду /start.

    Args:
        message (types.Message): Объект сообщения от Telegram с командой /start.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает команду `/start`, инициализируя или обновляя данные пользователя в базе данных и отправляя стартовое сообщение.

**Параметры**:
- `message` (types.Message): Объект сообщения от Telegram, содержащий команду `/start`.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `message`.
2.  Проверяет, существует ли пользователь в базе данных `db`.
3.  Если пользователя нет, создает запись с использованием шаблона `DATA_PATTERN`. Если пользователь существует, обновляет его данные, сохраняя информацию о подписке, токенах и реферальной ссылке.
4.  Обновляет или добавляет данные пользователя в базу данных с помощью `base.insert_or_update_data`.
5.  Вызывает функцию `tb.start_request(message)` для отправки стартового сообщения и отображения начального интерфейса.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при поступлении команды /start
```

### `personal_account`

```python
def personal_account(message: types.Message) -> None:
    """Отображает информацию о текущем тарифном плане пользователя.

    Args:
        message (types.Message): Объект сообщения от Telegram с командой /profile.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает команду `/profile`, отображая информацию о текущем тарифном плане пользователя.

**Параметры**:
- `message` (types.Message): Объект сообщения от Telegram, содержащий команду `/profile`.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `message`.
2.  Проверяет, какой тарифный план активен у пользователя (`BASIC`, `PRO` или отсутствие подписки).
3.  Отправляет пользователю сообщение с информацией о его тарифном плане, включая текстовые и графические генерации.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при поступлении команды /profile
```

### `show_stat`

```python
def show_stat(message: types.Message) -> None:
    """Отображает статистику бота (только для администраторов).

    Args:
        message (types.Message): Объект сообщения от Telegram с командой /stat.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает команду `/stat`, отображая статистику использования бота (количество пользователей и количество пользователей с промокодом).

**Параметры**:
- `message` (types.Message): Объект сообщения от Telegram, содержащий команду `/stat`.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `message`.
2.  Проверяет, является ли `user_id` администратором (входит ли в список `['2004851715', '206635551']`).
3.  Если пользователь является администратором, отправляет сообщение со статистикой: общее количество пользователей и количество пользователей, использовавших промокод.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при поступлении команды /stat от администратора
```

### `generate_promo_code`

```python
def generate_promo_code(length: int) -> str:
    """Генерирует случайный промокод заданной длины.

    Args:
        length (int): Длина промокода.

    Returns:
        str: Сгенерированный промокод.

    """
```

**Назначение**:
Функция генерирует случайный промокод заданной длины, используя буквы и цифры.

**Параметры**:
- `length` (int): Длина генерируемого промокода.

**Как работает функция**:
1.  Определяет набор символов, из которых будет состоять промокод (буквы и цифры).
2.  Использует `random.choices` для случайного выбора символов из набора указанной длины.
3.  Объединяет выбранные символы в строку и возвращает ее.

**Примеры**:
```python
>>> generate_promo_code(10)
'a1b2c3d4e5'
```

### `CallsProcessing`

```python
def CallsProcessing(call: types.CallbackQuery) -> None:
    """Обрабатывает callback-запросы от inline-кнопок.

    Args:
        call (types.CallbackQuery): Объект callback-запроса от Telegram.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает callback-запросы от inline-кнопок, выполняя различные действия в зависимости от данных, переданных в запросе.

**Параметры**:
- `call` (types.CallbackQuery): Объект callback-запроса от Telegram, содержащий информацию о нажатой кнопке.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `call`.
2.  Проверяет наличие пользователя в базе данных, при необходимости создавая запись.
3.  Определяет, какая кнопка была нажата, и выполняет соответствующее действие:
    *   Обработка основных кнопок меню (`text`, `images`, `free`, `tariff`).
    *   Выбор размера изображения.
    *   Обработка запросов на улучшение или регенерацию изображения.
    *   Выбор тарифного плана (`basic`, `pro`, `promo`, `ref`).
    *   Выбор типа текста для генерации.
    *   Обработка кнопок выхода из различных разделов меню.
    *   Обработка кнопок для выбора конкретного типа текста.
4.  Обновляет данные пользователя в базе данных при необходимости.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при нажатии на inline-кнопку
```

### `TokensCancelletionPattern`

```python
def TokensCancelletionPattern(user_id: str, func: callable, message: types.Message, i: Optional[int] = None) -> None:
    """Шаблон для обработки списания токенов или запросов у пользователя.

    Args:
        user_id (str): Идентификатор пользователя.
        func (callable): Функция для выполнения (генерация текста или изображения).
        message (types.Message): Объект сообщения от Telegram.
        i (Optional[int], optional): Индекс для текстовых задач. По умолчанию `None`.

    Returns:
        None

    """
```

**Назначение**:
Функция является шаблоном для обработки списания токенов или бесплатных запросов у пользователя при выполнении задач генерации текста или изображений.

**Параметры**:
- `user_id` (str): Идентификатор пользователя.
- `func` (callable): Функция, выполняющая генерацию текста или изображения.
- `message` (types.Message): Объект сообщения от Telegram.
- `i` (Optional[int], optional): Индекс для текстовых задач. По умолчанию `None`.

**Как работает функция**:
1.  Извлекает информацию о количестве входящих и исходящих токенов, а также количестве бесплатных запросов из базы данных.
2.  Проверяет, достаточно ли токенов или бесплатных запросов для выполнения операции.
3.  Вызывает переданную функцию `func` для выполнения задачи (генерации текста или изображения).
4.  Списывает токены или бесплатные запросы в зависимости от доступности.
5.  Если у пользователя закончились токены или бесплатные запросы, отправляет уведомление и предлагает приобрести подписку.

**Примеры**:
```python
# Пример вызова
# thr = Thread(target=TokensCancelletionPattern, args=(user_id, tb.TextCommands, message, i))
```

### `TasksProcessing`

```python
def TasksProcessing(message: types.Message) -> None:
    """Обрабатывает входящие текстовые сообщения и фотографии.

    Args:
        message (types.Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**:
Функция обрабатывает входящие текстовые сообщения и фотографии от пользователя, запуская соответствующие задачи (генерацию изображений или текста).

**Параметры**:
- `message` (types.Message): Объект сообщения от Telegram.

**Как работает функция**:
1.  Извлекает `user_id` из объекта `message`.
2.  Определяет тип контента сообщения (текст или фото) и выполняет соответствующие действия:
    *   Если включена генерация изображений (`db[user_id]['images'] != ""`), обрабатывает запрос на генерацию изображения, сохраняя параметры и запуская процесс генерации.
    *   Если пользователь находится в режиме бесплатного использования (`db[user_id]['free']`), обрабатывает текстовые сообщения или фотографии, передавая их в функцию `tb.FreeCommand` для генерации ответа.
    *   Если пользователь выбрал один из типов текста для генерации, запускает соответствующую функцию (`tb.TextCommands` или `tb.SomeTextsCommand`) для генерации текста.
3.  Обновляет данные пользователя в базе данных при необходимости.

**Примеры**:
```python
# Пример вызова автоматически обрабатывается библиотекой telebot при получении текстового сообщения или фотографии
```

### `end_check_tariff_time`

```python
async def end_check_tariff_time() -> None:
    """Проверяет время окончания действия тарифа у пользователей.

    Args:
        None

    Returns:
        None

    """
```

**Назначение**:
Функция асинхронно проверяет время окончания действия тарифа у пользователей и обновляет их статус, если время истекло.

**Как работает функция**:
1.  Запускает бесконечный цикл.
2.  Перебирает всех пользователей в базе данных.
3.  Вычисляет разницу между датой окончания подписки и текущим временем.
4.  Если время подписки истекло, сбрасывает параметры подписки пользователя (`basic`, `pro`) и количество бесплатных запросов до начальных значений.
5.  Обновляет данные пользователя в базе данных.
6.  Засыпает на 10 секунд.

**Примеры**:
```python
# Пример вызова
# asyncio.run(end_check_tariff_time())
```

## Параметры класса

- `N` (int): Количество типов текста.
- `DATA_PATTERN` (lambda): Шаблон инициализации данных пользователя.
- `photo_array` (list): Массив для хранения фотографий.
- `tb` (ToolBox): Объект класса `ToolBox` для выполнения различных операций.
- `bot` (telebot.TeleBot): Объект бота Telegram.
- `base` (DataBase): Объект класса `DataBase` для взаимодействия с базой данных.
- `db` (dict): Словарь, содержащий данные о пользователях.

## Запуск бота

```python
if __name__ == "__main__":
    Thread(target=bot.infinity_polling).start()
    asyncio.run(end_check_tariff_time())
```

**Описание**:
Данный блок кода запускает бота и асинхронную задачу для проверки времени окончания тарифа.

**Как работает**:
1.  Запускает бота в отдельном потоке с помощью `bot.infinity_polling`.
2.  Запускает асинхронную функцию `end_check_tariff_time` для проверки времени окончания тарифа у пользователей.