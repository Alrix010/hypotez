# Модуль `main.py` для запуска Telegram-бота цифрового магазина

## Обзор

Модуль `main.py` является точкой входа для запуска Telegram-бота цифрового магазина. Он отвечает за настройку и запуск веб-приложения `aiohttp`, регистрацию обработчиков, мидлварей и роутеров, а также за установку команд по умолчанию для бота и обработку событий запуска и остановки приложения.

## Подробнее

Модуль использует библиотеки `aiogram`, `aiohttp` и `loguru` для создания и управления Telegram-ботом и веб-приложением. Он настраивает вебхук для получения обновлений от Telegram, регистрирует обработчики для различных команд и событий, а также устанавливает мидлвари для работы с базой данных. Модуль также содержит функции для обработки событий запуска и остановки приложения, такие как отправка уведомлений администраторам и удаление вебхука.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
    ...
```

**Назначение**: Устанавливает команды по умолчанию для Telegram-бота.

**Как работает функция**:
- Создает список команд, которые будут отображаться в интерфейсе бота.
- Использует метод `bot.set_my_commands` для установки команд для всех пользователей (`BotCommandScopeDefault`).

**Примеры**:
```python
await set_default_commands()
```

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
    ...
```

**Назначение**: Выполняет действия при запуске приложения `aiohttp`.

**Параметры**:
- `app`: Экземпляр приложения `aiohttp`.

**Как работает функция**:
1.  Устанавливает команды по умолчанию для бота, вызывая функцию `set_default_commands()`.
2.  Устанавливает вебхук для бота, используя URL, полученный из настроек (`settings.get_webhook_url`).
3.  Отправляет уведомления администраторам о запуске бота. Если отправка сообщения не удалась, логирует ошибку.
4.  Логирует информацию об успешном запуске бота.

**Примеры**:
```python
app.on_startup.append(on_startup)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
    ...
```

**Назначение**: Выполняет действия при остановке приложения `aiohttp`.

**Параметры**:
- `app`: Экземпляр приложения `aiohttp`.

**Как работает функция**:
1.  Отправляет уведомления администраторам об остановке бота. Если отправка сообщения не удалась, логирует ошибку.
2.  Удаляет вебхук бота, чтобы бот перестал получать обновления от Telegram.
3.  Закрывает сессию бота.
4.  Логирует информацию об остановке бота.

**Примеры**:
```python
app.on_shutdown.append(on_shutdown)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует мидлвари для диспетчера `aiogram`.

**Как работает функция**:
- Регистрирует два мидлваря: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`.
- Мидлвари используются для управления сессиями базы данных. Один мидлварь не выполняет коммит изменений, а другой выполняет.

**Примеры**:
```python
register_middlewares()
```

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует роутеры для диспетчера `aiogram`.

**Как работает функция**:
- Подключает роутеры `catalog_router`, `user_router` и `admin_router` к диспетчеру `dp`.
- Роутеры содержат обработчики для различных команд и событий, связанных с каталогом, пользователями и административными функциями.

**Примеры**:
```python
register_routers()
```

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
    ...
```

**Назначение**: Создает и настраивает приложение `aiohttp`.

**Как работает функция**:
1.  Создает экземпляр приложения `aiohttp`.
2.  Регистрирует обработчики маршрутов для вебхука Telegram, обработки результатов и ошибок Robokassa, а также для главной страницы.
3.  Настраивает приложение с диспетчером `aiogram` и ботом.
4.  Регистрирует функции `on_startup` и `on_shutdown` для обработки событий запуска и остановки приложения.

**Примеры**:
```python
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
    ...
```

**Назначение**: Главная функция для запуска приложения.

**Как работает функция**:
1.  Регистрирует мидлвари и роутеры, вызывая функции `register_middlewares()` и `register_routers()`.
2.  Создает приложение `aiohttp`, вызывая функцию `create_app()`.
3.  Запускает приложение `aiohttp` с использованием `web.run_app()`, указывая хост и порт из настроек (`settings.SITE_HOST` и `settings.SITE_PORT`).

**Примеры**:
```python
if __name__ == "__main__":
    main()
```