# Модуль `main.py` для Desktop Assistant

## Обзор

Модуль `main.py` является основным файлом для запуска Desktop Assistant. Он содержит FastAPI приложение, которое предоставляет API для взаимодействия с пользователем через чат, а также обслуживает статические файлы, такие как HTML шаблоны и файлы локализации. Модуль использует Google Gemini AI для обработки сообщений пользователя и возврата ответов.

## Подробней

Этот модуль предназначен для создания и запуска веб-сервера, который предоставляет интерфейс для взаимодействия с ассистентом. Он использует FastAPI для обработки HTTP запросов, GoogleGenerativeAi для обработки текстовых запросов и модуль `src.logger` для логирования событий. Основная цель - предоставить простой и удобный способ общения с AI через веб-интерфейс.

## Классы

### `ChatRequest`

**Описание**: Класс, представляющий модель запроса чата.

**Наследует**: `BaseModel` из библиотеки `pydantic`.

**Атрибуты**:
- `message` (str): Сообщение пользователя.

### `class ChatRequest(BaseModel)`

**Описание**:  Определяет структуру данных для входящих запросов чата.

**Атрибуты**:
- `message` (str): Содержит текст сообщения от пользователя.
```python
class ChatRequest(BaseModel):
    """
    Args:
        message (str): Сообщение пользователя.
    """
    message: str
```

## Функции

### `root`

**Назначение**: Обрабатывает корневой запрос `/` и возвращает HTML страницу.

**Параметры**:
- Нет.

**Возвращает**:
- `HTMLResponse`: HTML содержимое файла `index.html`.

**Вызывает исключения**:
- `HTTPException`: Если файл `index.html` не найден или произошла ошибка при чтении файла.

**Как работает функция**:
- Функция пытается прочитать содержимое файла `index.html` из директории `templates_path`.
- Если файл не существует, выбрасывается исключение `FileNotFoundError`, которое перехватывается и логируется.
- В случае успеха возвращается HTML содержимое файла.
- В случае ошибки логируется сообщение об ошибке и выбрасывается исключение `HTTPException` с кодом 500.

```python
@app.get("/", response_class=HTMLResponse)
async def root():
    """
    Args:
        None
    Returns:
        HTMLResponse: HTML содержимое файла `index.html`.
    Raises:
        HTTPException: Если файл `index.html` не найден или произошла ошибка при чтении файла.
    """
    ...
```

### `chat`

**Назначение**: Обрабатывает POST запрос `/api/chat` и возвращает ответ от AI модели.

**Параметры**:
- `request` (ChatRequest): Объект `ChatRequest`, содержащий сообщение пользователя.

**Возвращает**:
- `dict`: Словарь, содержащий ответ от AI модели.

**Вызывает исключения**:
- `HTTPException`: Если произошла ошибка при взаимодействии с AI моделью.

**Как работает функция**:
- Функция получает сообщение пользователя из объекта `request`.
- Если AI модель не инициализирована, она инициализируется с использованием API ключа и имени модели.
- Функция вызывает метод `chat` AI модели с сообщением пользователя.
- В случае успеха возвращается ответ от AI модели в виде словаря.
- В случае ошибки логируется сообщение об ошибке и выбрасывается исключение `HTTPException` с кодом 500.

```python
@app.post("/api/chat")
async def chat(request: ChatRequest):
    """
    Args:
        request (ChatRequest): Объект `ChatRequest`, содержащий сообщение пользователя.

    Returns:
        dict: Словарь, содержащий ответ от AI модели.

    Raises:
        HTTPException: Если произошла ошибка при взаимодействии с AI моделью.
    """
    ...
```

### `get_locale_file`

**Назначение**: Читает и возвращает содержимое файла локализации в формате JSON.

**Параметры**:
- `lang` (str): Языковой код (например, `en`, `ru`).

**Возвращает**:
- `dict`: Словарь, содержащий данные локализации.

**Вызывает исключения**:
- `HTTPException`: Если файл локализации не найден, содержит невалидный JSON или произошла другая ошибка при чтении файла.

**Как работает функция**:
1.  Формирует путь к файлу локализации на основе переданного языкового кода.
2.  Открывает файл, читает его содержимое и преобразует JSON в словарь.
3.  Обрабатывает исключения `FileNotFoundError` (файл не найден), `json.JSONDecodeError` (ошибка декодирования JSON) и другие исключения, логируя их и возвращая HTTP ошибку с соответствующим кодом.

```python
def get_locale_file(lang: str):
    """
    Args:
        lang (str): Языковой код (например, `en`, `ru`).

    Returns:
        dict: Словарь, содержащий данные локализации.

    Raises:
        HTTPException: Если файл локализации не найден, содержит невалидный JSON или произошла другая ошибка при чтении файла.
    """
    ...
```

### `locales`

**Назначение**: Обрабатывает GET запрос `/locales/{lang}.json` и возвращает файл локализации для указанного языка.

**Параметры**:
- `lang` (str): Языковой код.

**Возвращает**:
- `dict`: Содержимое файла локализации в формате JSON.

**Как работает функция**:
- Функция вызывает функцию `get_locale_file` с указанным языковым кодом.
- Возвращает результат, полученный от функции `get_locale_file`.

```python
@app.get("/locales/{lang}.json")
async def locales(lang:str):
    """
    Args:
        lang (str): Языковой код.

    Returns:
        dict: Содержимое файла локализации в формате JSON.
    """
    return get_locale_file(lang)
```

## Параметры модуля

- `base_path` (Path): Путь к базовой директории модуля (`endpoints/hypo69/desktop_assistant`).
- `templates_path` (Path): Путь к директории с HTML шаблонами (`templates`).
- `locales_path` (Path): Путь к директории с файлами локализации (`translations`).
- `app` (FastAPI): Объект FastAPI приложения.
- `model` (GoogleGenerativeAi | None): Объект AI модели (изначально `None`).
- `api_key` (str): API ключ для доступа к Google Gemini.
- `system_instruction` (str): Инструкция для AI модели.

## Запуск локального сервера

В блоке `if __name__ == "__main__":` запускается Uvicorn сервер для локальной разработки.

```python
if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)