# Модуль для работы с изображениями
=======================================

Модуль `src.utils.image` предоставляет асинхронные функции для загрузки, сохранения и обработки изображений.
Он включает в себя такие функции, как сохранение изображений из URL-адресов, сохранение данных изображений в файлы,
получение данных изображений, поиск случайных изображений в каталогах, добавление водяных знаков, изменение размера
и преобразование форматов изображений.

## Обзор

Модуль `src.utils.image` предоставляет набор утилит для работы с изображениями, включая загрузку, сохранение, изменение размера, добавление водяных знаков и преобразование форматов. Он использует библиотеки `aiohttp`, `aiofiles`, `asyncio` и `PIL (Pillow)` для асинхронной обработки изображений. Модуль также включает обработку ошибок и ведение журнала для обеспечения надежности и удобства отладки.

## Подробней

Модуль содержит функции для асинхронной загрузки изображений из URL-адресов и сохранения их в файлы, сохранения данных изображений из байтов, получения данных изображений из файлов, поиска случайных изображений в каталогах, добавления текстовых и графических водяных знаков, изменения размера изображений и преобразования их форматов. Он использует библиотеку `PIL` (Pillow) для манипуляций с изображениями и асинхронные библиотеки `aiohttp` и `aiofiles` для неблокирующих операций ввода-вывода.

## Классы

### `ImageError`

**Описание**: Пользовательское исключение для ошибок, связанных с изображениями.

**Наследует**:
    `Exception`

**Атрибуты**:
    - Нет

**Методы**:
    - Нет

## Функции

### `save_image_from_url_async`

**Назначение**: Асинхронно загружает изображение из URL-адреса и сохраняет его локально.

**Параметры**:
    - `image_url` (str): URL-адрес изображения для загрузки.
    - `filename` (Union[str, Path]): Имя файла для сохранения изображения.

**Возвращает**:
    - `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
    - `ImageError`: Если загрузка или сохранение изображения не удались.

**Как работает функция**:
Функция `save_image_from_url_async` сначала пытается асинхронно загрузить изображение по указанному URL-адресу, используя `aiohttp`. Если загрузка прошла успешно, она вызывает функцию `save_image_async` для сохранения полученных данных изображения в файл. В случае возникновения каких-либо исключений в процессе загрузки или сохранения, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
import asyncio
from pathlib import Path

async def main():
    image_url = "https://www.easygifanimator.net/images/samples/video-to-gif-sample.gif"
    filename = Path("test_image.gif")
    result = await save_image_from_url_async(image_url, filename)
    if result:
        print(f"Image saved to {result}")
    else:
        print("Image saving failed")

if __name__ == "__main__":
    asyncio.run(main())
```

### `save_image`

**Назначение**: Сохраняет данные изображения в файл в указанном формате.

**Параметры**:
    - `image_data` (bytes): Двоичные данные изображения.
    - `file_name` (Union[str, Path]): Имя файла для сохранения изображения.
    - `format` (str): Формат для сохранения изображения, по умолчанию PNG.

**Возвращает**:
    - `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
    - `ImageError`: Если файл не может быть создан, сохранен или если сохраненный файл пуст.

**Как работает функция**:
Функция `save_image` принимает двоичные данные изображения и сохраняет их в файл с указанным именем и форматом. Она создает каталог для файла, если он не существует, использует `BytesIO` для работы с данными в памяти, открывает изображение с помощью `PIL`, сохраняет его в указанном формате и записывает отформатированные данные в файл. Функция также проверяет, был ли создан файл и не является ли он пустым. В случае возникновения каких-либо исключений в процессе сохранения, функция регистрирует ошибку с использованием `logger.exception` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path
import requests

# Пример с загрузкой картинки из URL
image_url = "https://www.easygifanimator.net/images/samples/video-to-gif-sample.gif"
response = requests.get(image_url)
image_data = response.content
file_name = Path("test_image.gif")

result = save_image(image_data, file_name, format="GIF")
if result:
    print(f"Image saved to {result}")
else:
    print("Image saving failed")
```

### `save_image_async`

**Назначение**: Асинхронно сохраняет данные изображения в файл в указанном формате.

**Параметры**:
    - `image_data` (bytes): Двоичные данные изображения.
    - `file_name` (Union[str, Path]): Имя файла для сохранения изображения.
    - `format` (str): Формат для сохранения изображения, по умолчанию PNG.

**Возвращает**:
    - `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
    - `ImageError`: Если файл не может быть создан, сохранен или если сохраненный файл пуст.

**Как работает функция**:
Функция `save_image_async` выполняет те же действия, что и `save_image`, но в асинхронном режиме. Она создает каталог для файла, если он не существует, использует `BytesIO` для работы с данными в памяти, открывает изображение с помощью `PIL`, сохраняет его в указанном формате и записывает отформатированные данные в файл. Функция также проверяет, был ли создан файл и не является ли он пустым. В случае возникновения каких-либо исключений в процессе сохранения, функция регистрирует ошибку с использованием `logger.exception` и возвращает `None`.

**Примеры**:

```python
import asyncio
from pathlib import Path
import aiohttp

async def main():
    # Пример с загрузкой картинки из URL
    image_url = "https://www.easygifanimator.net/images/samples/video-to-gif-sample.gif"
    async with aiohttp.ClientSession() as session:
        async with session.get(image_url) as response:
            image_data = await response.read()
    file_name = Path("test_image.gif")

    result = await save_image_async(image_data, file_name, format="GIF")
    if result:
        print(f"Image saved to {result}")
    else:
        print("Image saving failed")

if __name__ == "__main__":
    asyncio.run(main())
```

### `get_image_bytes`

**Назначение**: Считывает изображение с использованием Pillow и возвращает его байты в формате JPEG.

**Параметры**:
    - `image_path` (Path): Путь к файлу изображения.
    - `raw` (bool): Если `True`, возвращает объект `BytesIO`; иначе возвращает `bytes`. По умолчанию `True`.

**Возвращает**:
    - `Optional[BytesIO | bytes]`: Байты изображения в формате JPEG или `None`, если произошла ошибка.

**Как работает функция**:
Функция `get_image_bytes` принимает путь к файлу изображения, открывает изображение с помощью `PIL`, сохраняет его в формате JPEG в объект `BytesIO` и возвращает этот объект или его содержимое в виде байтов в зависимости от значения параметра `raw`. Если в процессе чтения или сохранения изображения возникает исключение, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

image_path = Path("test_image.jpg")
image_bytes = get_image_bytes(image_path)

if image_bytes:
    print(f"Image bytes: {image_bytes[:100]}...")
else:
    print("Failed to get image bytes")
```

### `get_raw_image_data`

**Назначение**: Извлекает необработанные двоичные данные файла, если он существует.

**Параметры**:
    - `file_name` (Union[str, Path]): Имя или путь к файлу для чтения.

**Возвращает**:
    - `Optional[bytes]`: Двоичные данные файла или `None`, если файл не существует или произошла ошибка.

**Как работает функция**:
Функция `get_raw_image_data` принимает имя файла или путь к нему, проверяет существование файла и, если файл существует, считывает его содержимое в виде двоичных данных и возвращает их. Если файл не существует или в процессе чтения возникает исключение, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

file_name = Path("test_image.jpg")
raw_data = get_raw_image_data(file_name)

if raw_data:
    print(f"Raw data: {raw_data[:100]}...")
else:
    print("Failed to get raw data")
```

### `random_image`

**Назначение**: Рекурсивно ищет случайное изображение в указанном каталоге.

**Параметры**:
    - `root_path` (Union[str, Path]): Каталог для поиска изображений.

**Возвращает**:
    - `Optional[str]`: Путь к случайному изображению или `None`, если изображения не найдены.

**Как работает функция**:
Функция `random_image` принимает путь к каталогу, рекурсивно ищет все файлы изображений с расширениями `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp` в этом каталоге и его подкаталогах, выбирает случайный файл из найденных и возвращает его путь. Если изображения не найдены, функция регистрирует предупреждение с использованием `logger.warning` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

root_path = Path(".")  # Текущий каталог
random_image_path = random_image(root_path)

if random_image_path:
    print(f"Random image path: {random_image_path}")
else:
    print("No images found")
```

### `add_text_watermark`

**Назначение**: Добавляет текстовый водяной знак на изображение.

**Параметры**:
    - `image_path` (Union[str, Path]): Путь к файлу изображения.
    - `watermark_text` (str): Текст для использования в качестве водяного знака.
    - `output_path` (Optional[Union[str, Path]]): Путь для сохранения изображения с водяным знаком. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
    - `Optional[str]`: Путь к изображению с водяным знаком или `None` в случае неудачи.

**Как работает функция**:
Функция `add_text_watermark` принимает путь к изображению, текст водяного знака и путь для сохранения изображения. Она открывает изображение с помощью `PIL`, создает прозрачный слой для водяного знака, рисует текст на этом слое, объединяет изображение и водяной знак и сохраняет результат в указанный файл. Если путь для сохранения не указан, функция перезаписывает исходное изображение. В случае возникновения каких-либо исключений в процессе добавления водяного знака, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

image_path = Path("test_image.jpg")
watermark_text = "Watermark"
output_path = Path("watermarked_image.jpg")

result = add_text_watermark(image_path, watermark_text, output_path)

if result:
    print(f"Watermarked image saved to: {result}")
else:
    print("Failed to add watermark")
```

### `add_image_watermark`

**Назначение**: Добавляет водяной знак к изображению и сохраняет результат по указанному пути.

**Параметры**:
    - `input_image_path` (Path): Путь к исходному изображению.
    - `watermark_image_path` (Path): Путь к изображению водяного знака.
    - `output_image_path` (Optional[Path]): Путь для сохранения изображения с водяным знаком. Если не указан, изображение будет сохранено в каталоге "output".

**Возвращает**:
    - `Optional[Path]`: Путь к сохраненному изображению с водяным знаком или `None`, если операция не удалась.

**Как работает функция**:
Функция `add_image_watermark` принимает пути к исходному изображению и изображению водяного знака, а также путь для сохранения результата. Она открывает оба изображения с помощью `PIL`, изменяет размер водяного знака (8% от ширины исходного изображения), определяет позицию для размещения водяного знака в правом нижнем углу с отступом в 20px, создает прозрачный слой, накладывает исходное изображение и водяной знак на этот слой и сохраняет результат в указанный файл. Если путь для сохранения не указан, функция сохраняет изображение в подкаталоге "output" исходного каталога. В случае возникновения каких-либо исключений в процессе добавления водяного знака, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

input_image_path = Path("test_image.jpg")
watermark_image_path = Path("watermark.png")
output_image_path = Path("watermarked_image.jpg")

result = add_image_watermark(input_image_path, watermark_image_path, output_image_path)

if result:
    print(f"Watermarked image saved to: {result}")
else:
    print("Failed to add watermark")
```

### `resize_image`

**Назначение**: Изменяет размер изображения до указанных размеров.

**Параметры**:
    - `image_path` (Union[str, Path]): Путь к файлу изображения.
    - `size` (Tuple[int, int]): Кортеж, содержащий желаемую ширину и высоту изображения.
    - `output_path` (Optional[Union[str, Path]]): Путь для сохранения изображения измененного размера. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
    - `Optional[str]`: Путь к изображению измененного размера или `None` в случае неудачи.

**Как работает функция**:
Функция `resize_image` принимает путь к изображению, желаемый размер и путь для сохранения изображения. Она открывает изображение с помощью `PIL`, изменяет его размер до указанных размеров и сохраняет результат в указанный файл. Если путь для сохранения не указан, функция перезаписывает исходное изображение. В случае возникновения каких-либо исключений в процессе изменения размера изображения, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

image_path = Path("test_image.jpg")
size = (500, 500)
output_path = Path("resized_image.jpg")

result = resize_image(image_path, size, output_path)

if result:
    print(f"Resized image saved to: {result}")
else:
    print("Failed to resize image")
```

### `convert_image`

**Назначение**: Преобразует изображение в указанный формат.

**Параметры**:
    - `image_path` (Union[str, Path]): Путь к файлу изображения.
    - `format` (str): Формат для преобразования изображения (например, "JPEG", "PNG").
    - `output_path` (Optional[Union[str, Path]]): Путь для сохранения преобразованного изображения. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
    - `Optional[str]`: Путь к преобразованному изображению или `None` в случае неудачи.

**Как работает функция**:
Функция `convert_image` принимает путь к изображению, формат для преобразования и путь для сохранения изображения. Она открывает изображение с помощью `PIL`, преобразует его в указанный формат и сохраняет результат в указанный файл. Если путь для сохранения не указан, функция перезаписывает исходное изображение. В случае возникновения каких-либо исключений в процессе преобразования изображения, функция регистрирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

image_path = Path("test_image.jpg")
format = "PNG"
output_path = Path("converted_image.png")

result = convert_image(image_path, format, output_path)

if result:
    print(f"Converted image saved to: {result}")
else:
    print("Failed to convert image")
```

### `process_images_with_watermark`

**Назначение**: Обрабатывает все изображения в указанной папке, добавляя водяной знак и сохраняя их в каталоге "output".

**Параметры**:
    - `folder_path` (Path): Путь к папке, содержащей изображения.
    - `watermark_path` (Path): Путь к изображению водяного знака.

**Возвращает**:
    - `None`

**Как работает функция**:
Функция `process_images_with_watermark` принимает путь к папке с изображениями и путь к изображению водяного знака. Она проверяет, существует ли указанная папка, создает подкаталог "output" в этой папке, если он не существует, и обрабатывает каждый файл в папке, добавляя водяной знак к файлам изображений с расширениями `.png`, `.jpg`, `.jpeg` и сохраняя их в подкаталоге "output". Если указанная папка не существует, функция регистрирует ошибку с использованием `logger.error`.

**Примеры**:

```python
from pathlib import Path

folder_path = Path("images")
watermark_path = Path("watermark.png")

process_images_with_watermark(folder_path, watermark_path)