# Модуль для создания AI-агента, использующего браузер для поиска информации и анализа веб-страниц
=========================================================================================

Модуль содержит класс `AIBrowserAgent`, который позволяет быстро настроить и запустить ИИ-агента, способного искать информацию в Google и анализировать веб-страницы.

Пример использования
----------------------

```python
>>> from src.ai.openai.chat_openai.browser_agent import AIBrowserAgent
>>> agent = AIBrowserAgent(api_key='YOUR_API_KEY', model_name='gpt-4o-mini')
>>> asyncio.run(agent.ask_async("Какая сейчас погода в Москве?"))
```

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [AIBrowserAgent](#aibrowseragent)
- [Функции](#функции)
    - [main](#main)

## Обзор

Модуль `browser_agent` предоставляет функциональность для создания и использования AI-агента, который может выполнять задачи, требующие взаимодействия с веб-браузером. Он использует библиотеки `langchain_openai` и `browser_use` для интеграции с языковыми моделями OpenAI и управления браузером.

## Подробнее

Этот модуль предназначен для автоматизации задач, требующих поиска информации в интернете и анализа веб-страниц. Он включает класс `AIBrowserAgent`, который позволяет настраивать агента с использованием различных языковых моделей и поисковых систем. Модуль также содержит пример использования агента для поиска аналогов продуктов и ответа на вопросы.

## Классы

### `AIBrowserAgent`

**Описание**: Класс для создания агента, использующего браузер для выполнения задач.

**Атрибуты**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `llm` (ChatOpenAI): Объект языковой модели OpenAI.
- `custom_driver` (Optional[object]): Опциональный инжектированный экземпляр WebDriver (по умолчанию None).

**Методы**:
- `__init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None)`: Инициализирует класс `AIBrowserAgent`.
- `run_task(self, task_prompt: str) -> Optional[str]`: Запускает агента для выполнения заданной задачи.
- `find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]`: Ищет в сети аналоги для продукта по заданному URL или SKU.
- `ask(self, q: str) -> Optional[str]`: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию.
- `ask_async(self, q: str) -> Optional[str]`: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

#### `__init__`

```python
def __init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None) -> None:
    """
    Инициализирует класс BrowserAgent.

    Args:
        api_key: Ключ API OpenAI (необязательный). Если не указан, будет использован ключ из переменных окружения.
        model_name: Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
        search_engine: Поисковая система для использования (по умолчанию "google").
        custom_driver: Опционально инжектированный экземпляр WebDriver (по умолчанию None).
    """
    ...
```

**Назначение**: Инициализирует экземпляр класса `AIBrowserAgent` с заданными параметрами.

**Параметры**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str, optional): Название языковой модели OpenAI для использования. По умолчанию `"gpt-4o-mini"`.
- `search_engine` (str, optional): Поисковая система для использования. По умолчанию `"google"`.
- `custom_driver` (Optional[object], optional): Опционально инжектированный экземпляр WebDriver. По умолчанию `None`.

**Как работает функция**:
- Сохраняет переданные параметры `api_key`, `model_name`, `search_engine` и `custom_driver` в атрибуты экземпляра класса.
- Инициализирует языковую модель OpenAI (`llm`) с использованием `model_name` и `api_key`.

**Примеры**:
```python
agent = AIBrowserAgent(api_key='YOUR_API_KEY', model_name='gpt-4o-mini', search_engine='google')
agent = AIBrowserAgent(api_key='YOUR_API_KEY', model_name='gpt-4o-mini')
agent = AIBrowserAgent(api_key='YOUR_API_KEY')
```

#### `run_task`

```python
async def run_task(self, task_prompt: str) -> Optional[str]:
    """
    Запускает агента для выполнения заданной задачи.

    Args:
        task_prompt: Текст задачи для агента.

    Returns:
        Результат выполнения задачи в виде строки, или None в случае ошибки.
    """
    ...
```

**Назначение**: Запускает агента для выполнения заданной задачи, используя указанный `task_prompt`.

**Параметры**:
- `task_prompt` (str): Текст задачи для агента.

**Возвращает**:
- `Optional[str]`: Результат выполнения задачи в виде строки, или `None` в случае ошибки.

**Как работает функция**:
- Логирует начало выполнения задачи.
- Определяет, какой драйвер браузера использовать (по умолчанию `browser_use` создает свой драйвер, но можно передать и пользовательский).
- Создает экземпляр класса `Agent` из библиотеки `browser_use`, передавая ему `task_prompt`, языковую модель (`llm`) и драйвер браузера.
- Запускает выполнение задачи с помощью метода `run()` агента.
- Логирует завершение выполнения задачи.
- Пытается закрыть драйвер, если это возможно.
- Возвращает результат выполнения задачи.
- В случае возникновения ошибки, логирует ее и возвращает `None`.

**Примеры**:
```python
task = "Найти информацию о последних новостях в мире."
result = asyncio.run(agent.run_task(task))
if result:
    print(result)
else:
    print("Не удалось выполнить задачу.")
```

#### `find_product_alternatives`

```python
async def find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]:
    """
    Ищет в сети аналоги для продукта по заданному URL или SKU.

    Args:
        product_url: URL продукта, для которого нужно найти аналоги (опционально).
        sku: SKU продукта, для которого нужно найти аналоги (опционально).

    Returns:
        Строку с описанием найденных аналогов, или None в случае ошибки.
    """
    ...
```

**Назначение**: Ищет в сети аналоги для продукта на основе заданного URL или SKU.

**Параметры**:
- `product_url` (Optional[str], optional): URL продукта, для которого нужно найти аналоги. По умолчанию `None`.
- `sku` (Optional[str], optional): SKU продукта, для которого нужно найти аналоги. По умолчанию `None`.

**Возвращает**:
- `Optional[str]`: Строка с описанием найденных аналогов, или `None` в случае ошибки.

**Как работает функция**:
- Формирует поисковый запрос на основе `product_url` или `sku`.
- Если ни `product_url`, ни `sku` не указаны, логирует предупреждение и возвращает `None`.
- Кодирует поисковый запрос для использования в URL.
- Формирует URL поисковой системы (Google или DuckDuckGo) с закодированным запросом.
- Создает текст задачи (`task_prompt`) для агента, указывая использовать поисковую систему и перейти по сформированному URL.
- Запускает выполнение задачи с помощью метода `run_task()`.
- Возвращает результат выполнения задачи.

**Примеры**:
```python
alternatives = asyncio.run(agent.find_product_alternatives(product_url="https://www.apple.com/iphone-14/"))
if alternatives:
    print(alternatives)
else:
    print("Не удалось найти аналоги.")

alternatives = asyncio.run(agent.find_product_alternatives(sku='1493001'))
if alternatives:
    print(alternatives)
else:
    print("Не удалось найти аналоги.")
```

#### `ask`

```python
def ask(self, q: str) -> Optional[str]:
    """
    Синхронная обертка для асинхронного метода ask_async. Не рекомендуется к использованию.
    """
    ...
```

**Назначение**: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию из-за блокирующего характера.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
- Формирует текст задачи (`task_prompt`) для агента, указывая ответить на вопрос `q`, используя поиск в интернете при необходимости.
- Вызывает метод `run_task()` с сформированным `task_prompt`.
- Возвращает результат выполнения задачи.

**Примеры**:
```python
answer = agent.ask("Какая сейчас погода в Москве?")
if answer:
    print(answer)
else:
    print("Не удалось получить ответ на вопрос.")
```

#### `ask_async`

```python
async def ask_async(self, q: str) -> Optional[str]:
    """
    Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

    Args:
        question: Вопрос, на который нужно ответить.

    Returns:
        Ответ на вопрос в виде строки, или None в случае ошибки.
    """
    ...
```

**Назначение**: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо (асинхронная версия).

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
- Формирует текст задачи (`task_prompt`) для агента, указывая ответить на вопрос `q`, используя поиск в интернете при необходимости.
- Вызывает метод `run_task()` с сформированным `task_prompt`.
- Возвращает результат выполнения задачи.

**Примеры**:
```python
answer = asyncio.run(agent.ask_async("Какая сейчас погода в Москве?"))
if answer:
    print(answer)
else:
    print("Не удалось получить ответ на вопрос.")
```

## Функции

### `main`

```python
async def main() -> None:
    """
    Пример использования класса BrowserAgent.
    """
    ...
```

**Назначение**: Пример использования класса `AIBrowserAgent` для поиска аналогов продукта и ответа на вопрос.

**Как работает функция**:
- Заменяет `"YOUR_API_KEY"` на фактический способ получения API-ключа.
- Определяет имя используемой модели.
- Создает экземпляр класса `AIBrowserAgent` с указанным API-ключом и именем модели.
- Запускает поиск аналогов продукта с использованием метода `find_product_alternatives()`.
- Выводит найденные аналоги или сообщение об ошибке.
- Задает вопрос и получает на него ответ с помощью метода `ask_async()`.
- Выводит ответ на вопрос или сообщение об ошибке.

**Примеры**:
```python
asyncio.run(main())