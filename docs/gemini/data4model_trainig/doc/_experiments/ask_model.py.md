# Модуль `ask_model`

## Обзор

Модуль предназначен для проверки валидности ответов от модели Gemini, используемой для проекта Kazarinov.

## Подробней

Модуль решает задачу тестирования процесса взаимодействия с моделью Gemini для обработки данных о товарах. Он включает в себя загрузку необходимых инструкций, API-ключей, формирование запросов на разных языках (русский и иврит), отправку этих запросов к модели и сохранение полученных ответов в JSON-файлы. Основная цель - убедиться в корректности работы модели и валидности получаемых результатов.

## Функции

### `model_ask(lang: str, attempts: int = 3) -> dict`

```python
def model_ask(lang: str, attempts: int = 3) -> dict:
    """"""
    global model, q_ru, q_he

    response = model.ask(q_ru if lang == 'ru' else q_he)
    if not response:
        logger.error(f"Нет ответа от модели")
        ...
        return {}

    response_dict:dict = j_loads(response)
    if not response_dict:
        logger.error("Ошибка парсинга ")
        if attempts >1:
            model_ask(lang, attempts -1 )
        return {}

    return response_dict
```

**Назначение**: Функция отправляет запрос к модели Gemini на указанном языке и возвращает результат.

**Параметры**:

*   `lang` (str): Язык, на котором нужно отправить запрос (может быть `'ru'` для русского или `'he'` для иврита).
*   `attempts` (int, optional): Максимальное количество попыток отправки запроса в случае неудачи (по умолчанию `3`).

**Возвращает**:

*   `dict`: Ответ от модели Gemini в виде словаря, если запрос выполнен успешно и ответ удалось распарсить. В случае неудачи возвращается пустой словарь `{}`.

**Как работает функция**:

1.  Выбирает текст запроса в зависимости от указанного языка (`q_ru` для русского или `q_he` для иврита).
2.  Использует метод `model.ask()` для отправки запроса к модели Gemini.
3.  Если ответ от модели не получен (пустая строка или `None`), регистрируется ошибка с использованием `logger.error()` и возвращается пустой словарь.
4.  Пытается распарсить полученный ответ в формат JSON с помощью функции `j_loads()`.
5.  Если распарсить ответ не удалось, регистрируется ошибка и, если количество оставшихся попыток больше 1, функция рекурсивно вызывает саму себя для повторной отправки запроса.
6.  После успешного получения и разбора ответа, функция возвращает полученный словарь.

## Переменные

*   `test_directory` (Path): Путь к тестовой директории, используемой для сохранения результатов и загрузки данных.
*   `products_in_test_dir` (Path): Путь к файлу, содержащему список товаров для тестирования.
*   `products_list` (List[dict]): Список товаров, загруженный из файла `products_in_test_dir`.
*   `system_instruction` (str): Системная инструкция для модели Gemini, загруженная из файла.
*   `command_instruction_ru` (str): Инструкция для модели Gemini на русском языке, загруженная из файла.
*   `command_instruction_he` (str): Инструкция для модели Gemini на иврите, загруженная из файла.
*   `api_key` (str): Ключ API для доступа к модели Gemini.
*   `model` (GoogleGenerativeAi): Экземпляр класса `GoogleGenerativeAi`, используемый для взаимодействия с моделью Gemini.
*   `q_ru` (str): Сформированный запрос для модели Gemini на русском языке.
*   `q_he` (str): Сформированный запрос для модели Gemini на иврите.
* `response_ru_dict` (dict): Содержит результат запроса к Gemini на русском языке, полученный с помощью функции `model_ask`
* `response_he_dict` (dict): Содержит результат запроса к Gemini на иврите, полученный с помощью функции `model_ask`

## Описание

Цель модуля - проверить, как модель Gemini обрабатывает запросы на разных языках, и сохранить результаты для дальнейшего анализа или использования. Код выполняет следующие действия:

1.  **Загрузка конфигурации и данных:** Загружаются необходимые параметры, такие как пути к файлам, API-ключи и инструкции для модели Gemini.
2.  **Инициализация модели Gemini:** Создается экземпляр класса `GoogleGenerativeAi` с заданными параметрами.
3.  **Формирование запросов:** Создаются запросы на русском и иврите, объединяющие системные инструкции и список товаров.
4.  **Отправка запросов к модели:** Используется функция `model_ask` для отправки запросов к модели Gemini на каждом языке.
5.  **Сохранение результатов:** Полученные ответы от модели сохраняются в JSON-файлы для последующего анализа.

## Зависимости

-   `src.llm.gemini.gemini`: Для взаимодействия с моделью Gemini.
-   `src.utils.jjson`: Для загрузки и сохранения данных в формате JSON.
-   `src.logger.logger`: Для логирования информации о процессе выполнения скрипта.

## Замечания

Модуль предназначен для экспериментов, поэтому не включает в себя полноценную обработку ошибок и может потребовать доработки для использования в production-среде.

```python
...
```

Данная запись означает, что в этом месте код может быть не завершен.

Обратите внимание на следующие моменты:

*   В коде используется глобальная переменная `model`, что может привести к проблемам при параллельном выполнении.
*   Код содержит рекурсивный вызов функции `model_ask`, что может привести к переполнению стека вызовов при большом количестве неудачных попыток.
*   Отсутствует обработка исключений при загрузке данных из файлов.
*  Отсутствуют явные комментарии по поводу назначения кода