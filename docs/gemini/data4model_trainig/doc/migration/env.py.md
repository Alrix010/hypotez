# Модуль для управления миграциями базы данных

## Обзор

Модуль `src.endpoints.bots.telegram.digital_market.bot.migration.env` предназначен для управления миграциями базы данных, используемыми в Telegram-боте для цифрового магазина.

## Подробней

Модуль использует библиотеку `alembic` для автоматического создания, применения и отката изменений схемы базы данных.

## Переменные

*   `config` (Config): Объект конфигурации Alembic.
*   `target_metadata` (MetaData): Метаданные целевой базы данных, определенные в `Base.metadata`.

## Функции

### `run_migrations_offline`

```python
def run_migrations_offline() -> None:
```

**Назначение**: Выполняет миграции в "offline" режиме.

**Как работает функция**:

1.  Получает URL базы данных из конфигурации.
2.  Настраивает контекст Alembic с использованием URL и метаданных целевой базы данных.
3.  Выполняет миграции в рамках транзакции.

### `do_run_migrations`

```python
def do_run_migrations(connection: Connection) -> None:
```

**Назначение**: Выполняет миграции, используя предоставленное соединение.

**Параметры**:

*   `connection` (Connection): Объект соединения SQLAlchemy.

**Как работает функция**:

1.  Настраивает контекст Alembic с использованием предоставленного соединения и метаданных целевой базы данных.
2.  Выполняет миграции в рамках транзакции.

### `run_async_migrations`

```python
async def run_async_migrations() -> None:
```

**Назначение**: Выполняет миграции в "online" режиме асинхронно.

**Как работает функция**:

1.  Создает асинхронный движок SQLAlchemy, используя конфигурацию.
2.  Устанавливает соединение с базой данных.
3.  Выполняет миграции, используя предоставленное соединение и функцию `do_run_migrations`.
4.  Удаляет движок.

### `run_migrations_online`

```python
def run_migrations_online() -> None:
```

**Назначение**: Выполняет миграции в "online" режиме.

**Как работает функция**:

1.  Запускает асинхронную функцию `run_async_migrations` с использованием `asyncio.run`.

## Условное выполнение

В зависимости от режима работы (offline или online) выполняются соответствующие функции миграции:

*   Если `context.is_offline_mode()` возвращает `True`, выполняется `run_migrations_offline()`.
*   Иначе выполняется `run_migrations_online()`.