# Модуль `code_assistant`

## Обзор

Модуль предназначен для обучения модели машинного обучения кодовой базе, составления документации к проекту, примеров кода и тестов.

## Подробней

Модуль содержит класс `CodeAssistant`, который автоматизирует процесс анализа кода, создания документации и примеров кода с использованием различных AI-моделей (например, Google Gemini и OpenAI). Он также включает функциональность для чтения файлов кода, отправки кода в модель, обработки полученных результатов и сохранения их в директории `docs/gemini`.

## Классы

### `Config`

**Описание**: Класс конфигурации для модуля `code_assistant`.

**Атрибуты**:

*   `base_path` (Path): Базовый путь к директории модуля.
*   `config` (SimpleNamespace): Объект с конфигурационными параметрами, загруженными из JSON-файла.
*   `roles_list` (list): Список ролей.
*   `languages_list` (list): Список языков.
*   `role` (str): Роль по умолчанию (`'doc_writer_md'`).
*   `lang` (str): Язык по умолчанию (`'ru'`).
*   `process_dirs` (list[Path]): Список директорий для обработки.
*   `exclude_dirs` (list[Path]): Список исключенных директорий.
*   `exclude_files_patterns` (list[Path]): Список шаблонов для исключения файлов.
*   `include_files_patterns` (list[Path]): Список шаблонов для включения файлов.
*   `exclude_files` (list[Path]): Список исключенных файлов.
*   `response_mime_type` (str): Тип MIME ответа (по умолчанию `'text/plain'`).
*   `output_directory_patterns` (list): Шаблоны для директорий вывода.
*   `remove_prefixes` (str): Префиксы, которые нужно удалять из ответа.
*   `system_instruction` (str): Системная инструкция для модели.
*   `gemini` (SimpleNamespace): Объект с настройками модели Gemini.

**Свойства**:

*   `code_instruction` (str): Инструкция для кода (читается из файла).
*   `system_instruction` (str): Системная инструкция для модели (читается из файла).

**Принцип работы**:

Класс `Config` предназначен для хранения и предоставления доступа к настройкам, необходимым для работы модуля `code_assistant`. Он определяет значения по умолчанию, загружает параметры из файла конфигурации и предоставляет удобный интерфейс для доступа к ним.

### `CodeAssistant`

**Описание**: Класс для работы ассистента программиста с моделями ИИ.

**Атрибуты**:

*   `role` (str): Роль для выполнения задачи.
*   `lang` (str): Язык выполнения.
*   `gemini` (GoogleGenerativeAi): Объект GoogleGenerativeAi, используемый для взаимодействия с моделью Gemini.
*   `openai` (OpenAIModel): Объект OpenAIModel, используемый для взаимодействия с моделью OpenAI.

**Методы**:

*   `__init__`: Инициализирует объект `CodeAssistant`.
*   `_initialize_models`: Инициализирует модели на основе заданных параметров.
*   `send_file`: Отправляет файл в модель.
*   `process_files`: Компилирует, отправляет запрос и сохраняет результат.
*   `_create_request`: Создает запрос с учетом роли и языка.
*   `_yield_files_content`: Генерирует пути файлов и их содержимое по указанным шаблонам.
*   `_save_response`: Сохраняет ответ модели в файл с добавлением суффикса.
*   `_remove_outer_quotes`: Удаляет внешние кавычки в начале и в конце строки, если они присутствуют.

### `__init__`

```python
def __init__(
    self,
    role: Optional[str] = 'doc_writer_md',
    lang: Optional[str] = 'en',
    models_list: Optional[list[str, str] | str] = ['gemini'],
    system_instruction: Optional[str | Path] = None,
    **kwards,
) -> None:
    """
    Инициализация ассистента с заданными параметрами.

    Args:
        role (str): Роль для выполнения задачи.
        lang (str): Язык выполнения.
        models_list (list[str]): Список моделей для инициализации.
        system_instruction (str|Path): Общая инструкция для модели. 
        **kwards: Дополнительные аргументы для инициализации моделей.
    """
    ...
```

**Назначение**: Инициализирует объект `CodeAssistant`.

**Параметры**:

*   `role` (Optional[str]): Роль для выполнения задачи (по умолчанию `'doc_writer_md'`).
*   `lang` (Optional[str]): Язык выполнения (по умолчанию `'en'`).
*   `models_list` (Optional[list[str, str] | str]): Список моделей для инициализации (по умолчанию `['gemini']`).
*   `system_instruction` (Optional[str | Path]): Общая инструкция для модели (по умолчанию `None`).
*   `**kwards`: Дополнительные аргументы для инициализации моделей.

**Как работает функция**:

1.  Устанавливает значения атрибутов `role` и `lang` из переданных аргументов или значений по умолчанию из класса `Config`.
2.  Инициализирует модели с помощью метода `_initialize_models`.

### `_initialize_models`

```python
def _initialize_models(self, models_list: list, response_mime_type: Optional[str] = '', **kwards) -> bool:
    """
    Инициализация моделей на основе заданных параметров.

    Args:
        models_list (list[str]): Список моделей для инициализации.
        **kwards: Дополнительные аргументы для инициализации моделей.

    Returns:
        bool: Успешность инициализации моделей.

    Raises:
        Exception: Если произошла ошибка при инициализации моделей.
    """
    ...
```

**Назначение**: Инициализирует модели на основе заданных параметров.

**Параметры**:

*   `models_list` (list): Список моделей для инициализации.
*   `**kwards`: Дополнительные аргументы для инициализации моделей.

**Возвращает**:

*   `bool`: `True`, если инициализация моделей прошла успешно, иначе `False`.

**Как работает функция**:

1.  Проверяет, есть ли в списке моделей `'gemini'`.
2.  Если есть, создает экземпляр класса `GoogleGenerativeAi` с заданными параметрами.
3.  В случае ошибки логирует ошибку и возвращает `False`.

### `send_file`

```python
def send_file(self, file_path: Path) -> Optional[str | None]:
    """
    Отправка файла в модель.

    Args:
        file_path (Path): Абсолютный путь к файлу, который нужно отправить.
        file_name (Optional[str]): Имя файла для отправки. Если не указано и 'src' отсутствует, используется имя файла без изменений.

    Returns:
        Optional[str | None]: URL файла, если успешно отправлен, иначе None.
    """
    ...
```

**Назначение**: Отправляет файл в модель Gemini.

**Параметры**:

*   `file_path` (Path): Абсолютный путь к файлу, который нужно отправить.

**Возвращает**:

*   `Optional[str | None]`: URL файла, если успешно отправлен, иначе `None`.

**Как работает функция**:

1.  Вызывает метод `self.gemini.upload_file(file_path)` для отправки файла в модель Gemini.
2.  Если отправка прошла успешно, возвращает URL файла.
3.  В случае ошибки логирует ошибку и возвращает `None`.

### `process_files`

```python
async def process_files(
    self, process_dirs: Optional[str | Path | list[str | Path]] = None, 
) -> bool:
    """компиляция, отправка запроса и сохранение результата."""
    ...
```

**Назначение**: Компилирует, отправляет запрос и сохраняет результат для указанных файлов.

**Параметры**:

*   `process_dirs` (Optional[str | Path | list[str | Path]]): Список директорий для обработки. Если не указан, используется `Config.process_dirs`.

**Возвращает**:

*   `bool`: `True`, если обработка файлов прошла успешно, иначе `False`.

**Как работает функция**:

1.  Итерируется по списку директорий для обработки.
2.  Для каждой директории:
    *   Проверяет, существует ли директория и является ли она директорией.
    *   Итерируется по файлам в директории с помощью метода `_yield_files_content`.
    *   Для каждого файла:
        *   Создает запрос с помощью метода `_create_request`.
        *   Отправляет запрос в модель Gemini с помощью метода `self.gemini.chat`.
        *   Сохраняет ответ модели в файл с помощью метода `_save_response`.

### `_create_request`

```python
def _create_request(self, file_path: str, content: str) -> str:
    """Создание запроса с учетом роли и языка."""
    ...
```

**Назначение**: Создает запрос для отправки в модель Gemini с учетом роли и языка.

**Параметры**:

*   `file_path` (str): Путь к файлу.
*   `content` (str): Содержимое файла.

**Возвращает**:

*   `str`: Сформированный запрос.

**Как работает функция**:

1.  Формирует словарь `content_request` с информацией о роли, языке, пути к файлу и содержимом файла.
2.  Преобразует словарь в строку.

### `_yield_files_content`

```python
def _yield_files_content(
    self,
    process_directory: str | Path,
) -> Iterator[tuple[Path, str]]:
    """
    Генерирует пути файлов и их содержимое по указанным шаблонам.

    Args:
        process_directory (Path | str): Абсолютный путь к стартовой директории

    Returns:
        bool: Iterator
    """
    ...
```

**Назначение**: Генерирует пути файлов и их содержимое по указанным шаблонам.

**Параметры**:

*   `process_directory` (Path | str): Абсолютный путь к стартовой директории.

**Возвращает**:

*   `Iterator[tuple[Path, str]]`: Итератор, возвращающий кортежи, содержащие путь к файлу и его содержимое.

**Как работает функция**:

1.  Компилирует шаблоны исключаемых файлов.
2.  Итерируется по всем файлам в директории.
3.  Проверяет файл на соответствие шаблонам включения и исключения.
4.  Читает содержимое файла и возвращает путь к файлу и его содержимое.

### `_save_response`

```python
async def _save_response(self, file_path: Path, response: str, model_name: str) -> bool:
    """
    Сохранение ответа модели в файл с добавлением суффикса.

    Метод сохраняет ответ модели в файл, добавляя к текущему расширению файла
    дополнительный суффикс, определяемый ролью.

    Args:
        file_path (Path): Исходный путь к файлу, в который будет записан ответ.
        response (str): Ответ модели, который необходимо сохранить.
        model_name (str): Имя модели, использованной для генерации ответа.

    Raises:
        OSError: Если не удаётся создать директорию или записать в файл.
    """
    ...
```

**Назначение**: Сохраняет ответ модели в файл с добавлением суффикса, соответствующего роли.

**Параметры**:

*   `file_path` (Path): Исходный путь к файлу, в который будет записан ответ.
*   `response` (str): Ответ модели, который необходимо сохранить.
*   `model_name` (str): Имя модели, использованной для генерации ответа.

**Возвращает**:

*   `bool`: `True`, если файл успешно сохранен, иначе `False`.

**Как работает функция**:

1.  Определяет директорию для вывода в зависимости от роли.
2.  Формирует путь к файлу для сохранения ответа.
3.  Добавляет суффикс к имени файла в зависимости от роли.
4.  Сохраняет ответ в файл.

### `_remove_outer_quotes`

```python
def _remove_outer_quotes(self, response: str) -> str:
    """
    Удаляет внешние кавычки в начале и в конце строки, если они присутствуют.

    Args:
        response (str): Ответ модели, который необходимо обработать.

    Returns:
        str: Очищенный контент как строка.

    Example:
        >>> _remove_outer_quotes('```md some content ```')
        'some content'
        >>> _remove_outer_quotes('some content')
        'some content'
        >>> _remove_outer_quotes('```python def hello(): print("Hello") ```')
        '```python def hello(): print("Hello") ```'
    """
    ...
```

**Назначение**: Удаляет внешние кавычки в начале и в конце строки, если они присутствуют.

**Параметры**:

*   `response` (str): Ответ модели, который необходимо обработать.

**Возвращает**:

*   `str`: Очищенный контент как строка.

**Как работает функция**:

1.  Удаляет пробелы в начале и конце строки.
2.  Проверяет, начинается ли строка с `'```python'` или `'```mermaid'`. Если да, возвращает строку без изменений.
3.  Проверяет, начинается ли строка с одного из префиксов, указанных в `Config.remove_prefixes`. Если да, удаляет префикс и суффикс `'```'` (если он есть) и возвращает очищенную строку.
4.  В противном случае возвращает исходную строку без изменений.

## Дополнительные замечания

Предоставленный код включает в себя механизм обработки сигналов прерывания (Ctrl+C), а также функцию для разбора аргументов командной строки. Эти функции позволяют управлять процессом выполнения скрипта и задавать параметры для обработки файлов.
```python
...
```
Данный код указывает на то, что в модуле есть еще не реализованная функциональность.