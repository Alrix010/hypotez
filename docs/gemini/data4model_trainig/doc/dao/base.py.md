# Модуль базового DAO для работы с базой данных

## Обзор

Модуль `src.endpoints.bots.telegram.digital_market.bot.dao.base` предоставляет базовый класс `BaseDAO` для выполнения операций доступа к данным (DAO) с использованием SQLAlchemy.

## Подробней

Модуль содержит класс `BaseDAO`, который предоставляет общие методы для поиска, добавления, обновления и удаления записей в базе данных.

## Классы

### `BaseDAO`

**Описание**: Базовый класс для реализации DAO.

**Атрибуты**:

*   `model` (type[T]): Тип модели SQLAlchemy, с которой работает DAO.

**Методы**:

*   `find_one_or_none_by_id(cls, data_id: int, session: AsyncSession)`: Находит запись по ID или возвращает None.
*   `find_one_or_none(cls, session: AsyncSession, filters: BaseModel)`: Находит одну запись по фильтрам или возвращает None.
*   `find_all(cls, session: AsyncSession, filters: BaseModel | None = None)`: Находит все записи по фильтрам.
*   `add(cls, session: AsyncSession, values: BaseModel)`: Добавляет одну запись в базу данных.
*   `add_many(cls, session: AsyncSession, instances: List[BaseModel])`: Добавляет несколько записей в базу данных.
*   `update(cls, session: AsyncSession, filters: BaseModel, values: BaseModel)`: Обновляет записи в базе данных по фильтрам.
*   `delete(cls, session: AsyncSession, filters: BaseModel)`: Удаляет записи из базы данных по фильтру.
*   `count(cls, session: AsyncSession, filters: BaseModel | None = None)`: Подсчитывает количество записей в базе данных.
*   `paginate(cls, session: AsyncSession, page: int = 1, page_size: int = 10, filters: BaseModel = None)`: Возвращает записи для заданной страницы с учетом пагинации.
*   `find_by_ids(cls, session: AsyncSession, ids: List[int]) -> List[Any]`: Находит несколько записей по списку ID.
*   `upsert(cls, session: AsyncSession, unique_fields: List[str], values: BaseModel)`: Создает или обновляет существующую запись.
*   `bulk_update(cls, session: AsyncSession, records: List[BaseModel]) -> int`: Массовое обновление записей.

## Методы класса `BaseDAO`

### `find_one_or_none_by_id`

```python
@classmethod
async def find_one_or_none_by_id(cls, data_id: int, session: AsyncSession):
```

**Назначение**: Находит запись по ID или возвращает `None`.

**Параметры**:

*   `data_id` (int): ID записи для поиска.
*   `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:

*   `T | None`: Найденная запись или `None`, если запись не найдена.

**Как работает функция**:

1.  Логирует информацию о поиске записи.
2.  Выполняет запрос к базе данных, используя `select` и `filter_by`.
3.  Возвращает найденную запись или `None`.

### `find_one_or_none`

```python
@classmethod
async def find_one_or_none(cls, session: AsyncSession, filters: BaseModel):
```

**Назначение**: Находит одну запись по фильтрам или возвращает `None`.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `filters` (BaseModel): Объект, содержащий фильтры для поиска.

**Возвращает**:

*   `T | None`: Найденная запись или `None`, если запись не найдена.

**Как работает функция**:

1.  Преобразует фильтры в словарь, используя `filters.model_dump`.
2.  Логирует информацию о поиске записи.
3.  Выполняет запрос к базе данных, используя `select` и `filter_by`.
4.  Возвращает найденную запись или `None`.

### `find_all`

```python
@classmethod
async def find_all(cls, session: AsyncSession, filters: BaseModel | None = None):
```

**Назначение**: Находит все записи по фильтрам.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `filters` (BaseModel | None, optional): Объект, содержащий фильтры для поиска. Defaults to `None`.

**Возвращает**:

*   `List[T]`: Список найденных записей.

**Как работает функция**:

1.  Преобразует фильтры в словарь, используя `filters.model_dump`.
2.  Логирует информацию о поиске записей.
3.  Выполняет запрос к базе данных, используя `select` и `filter_by`.
4.  Возвращает список найденных записей.

### `add`

```python
@classmethod
async def add(cls, session: AsyncSession, values: BaseModel):
```

**Назначение**: Добавляет одну запись в базу данных.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `values` (BaseModel): Объект, содержащий значения для добавления.

**Возвращает**:

*   `T`: Добавленная запись.

**Как работает функция**:

1.  Преобразует значения в словарь, используя `values.model_dump`.
2.  Логирует информацию о добавлении записи.
3.  Создает новый экземпляр модели с использованием значений из словаря.
4.  Добавляет новую запись в сессию.
5.  Выполняет коммит сессии и возвращает новый экземпляр модели.

### `add_many`

```python
@classmethod
async def add_many(cls, session: AsyncSession, instances: List[BaseModel]):
```

**Назначение**: Добавляет несколько записей в базу данных.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `instances` (List[BaseModel]): Список объектов, содержащих значения для добавления.

**Возвращает**:

*   `List[T]`: Список добавленных записей.

**Как работает функция**:

1.  Преобразует значения в список словарей, используя `item.model_dump`.
2.  Логирует информацию о добавлении записей.
3.  Создает новые экземпляры модели с использованием значений из списка.
4.  Добавляет все записи в сессию.
5.  Выполняет коммит сессии и возвращает список добавленных экземпляров.

### `update`

```python
@classmethod
async def update(cls, session: AsyncSession, filters: BaseModel, values: BaseModel):
```

**Назначение**: Обновляет записи в базе данных по фильтрам.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `filters` (BaseModel): Объект, содержащий фильтры для обновления.
*   `values` (BaseModel): Объект, содержащий значения для обновления.

**Возвращает**:

*   `int`: Количество обновленных записей.

**Как работает функция**:

1.  Преобразует фильтры и значения в словари, используя `filters.model_dump` и `values.model_dump`.
2.  Логирует информацию об обновлении записей.
3.  Формирует запрос на обновление с использованием `sqlalchemy_update` и `where`.
4.  Выполняет запрос и возвращает количество обновленных записей.

### `delete`

```python
@classmethod
async def delete(cls, session: AsyncSession, filters: BaseModel):
```

**Назначение**: Удаляет записи из базы данных по фильтру.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `filters` (BaseModel): Объект, содержащий фильтры для удаления.

**Возвращает**:

*   `int`: Количество удаленных записей.

**Вызывает исключения**:

*   `ValueError`: Если не указаны фильтры для удаления.

**Как работает функция**:

1.  Преобразует фильтры в словарь, используя `filters.model_dump`.
2.  Логирует информацию об удалении записей.
3.  Проверяет наличие фильтров. Если фильтры не указаны, вызывает исключение `ValueError`.
4.  Формирует запрос на удаление с использованием `sqlalchemy_delete` и `filter_by`.
5.  Выполняет запрос и возвращает количество удаленных записей.

### `count`

```python
@classmethod
async def count(cls, session: AsyncSession, filters: BaseModel | None = None):
```

**Назначение**: Подсчитывает количество записей в базе данных.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `filters` (BaseModel | None, optional): Объект, содержащий фильтры для подсчета. Defaults to `None`.

**Возвращает**:

*   `int`: Количество записей.

**Как работает функция**:

1.  Преобразует фильтры в словарь, используя `filters.model_dump`.
2.  Логирует информацию о подсчете записей.
3.  Выполняет запрос к базе данных, используя `select` и `func.count`.
4.  Возвращает количество записей.

### `paginate`

```python
@classmethod
async def paginate(cls, session: AsyncSession, page: int = 1, page_size: int = 10, filters: BaseModel = None):
```

**Назначение**: Возвращает записи для заданной страницы с учетом пагинации.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `page` (int, optional): Номер страницы (по умолчанию 1).
*   `page_size` (int, optional): Количество записей на странице (по умолчанию 10).
*   `filters` (BaseModel, optional): Объект, содержащий фильтры для поиска. Defaults to `None`.

**Возвращает**:

*   `List[T]`: Список записей для заданной страницы.

**Как работает функция**:

1.  Преобразует фильтры в словарь, используя `filters.model_dump`.
2.  Логирует информацию о пагинации записей.
3.  Выполняет запрос к базе данных, используя `select`, `filter_by`, `offset` и `limit`.
4.  Возвращает список записей для заданной страницы.

### `find_by_ids`

```python
@classmethod
async def find_by_ids(cls, session: AsyncSession, ids: List[int]) -> List[Any]:
```

**Назначение**: Находит несколько записей по списку ID.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `ids` (List[int]): Список ID для поиска.

**Возвращает**:

*   `List[Any]`: Список найденных записей.

**Как работает функция**:

1.  Логирует информацию о поиске записей по списку ID.
2.  Выполняет запрос к базе данных, используя `select` и `filter(cls.model.id.in_(ids))`.
3.  Возвращает список найденных записей.

### `upsert`

```python
@classmethod
async def upsert(cls, session: AsyncSession, unique_fields: List[str], values: BaseModel):
```

**Назначение**: Создает запись или обновляет существующую.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `unique_fields` (List[str]): Список уникальных полей для поиска существующей записи.
*   `values` (BaseModel): Объект, содержащий значения для создания или обновления записи.

**Возвращает**:

*   `T`: Созданная или обновленная запись.

**Как работает функция**:

1.  Преобразует `values` в словарь `values_dict`, исключая неустановленные значения.
2.  Создает словарь `filter_dict` на основе `unique_fields` и `values_dict`.
3.  Логирует информацию о операции upsert.
4.  Пытается найти существующую запись, используя `cls.find_one_or_none` с фильтрами, созданными из `unique_fields`.
5.  Если запись существует:

    *   Обновляет существующую запись, устанавливая значения атрибутов из `values_dict`.
    *   Вызывает `session.flush()`.
    *   Возвращает обновленную существующую запись.
6.  Если запись не существует:

    *   Создает новую запись, используя `cls.model(**values_dict)`.
    *   Добавляет новую запись в сессию.
    *   Вызывает `session.flush()`.
    *   Возвращает новую созданную запись.
7.  В случае ошибки выполняет откат транзакции с помощью `session.rollback()`, логирует ошибку и повторно вызывает исключение.

### `bulk_update`

```python
@classmethod
async def bulk_update(cls, session: AsyncSession, records: List[BaseModel]) -> int:
```

**Назначение**: Массовое обновление записей.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных.
*   `records` (List[BaseModel]): Список объектов, содержащих значения для обновления.

**Возвращает**:

*   `int`: Количество обновленных записей.

**Как работает функция**:

1.  Логирует информацию о массовом обновлении записей.
2.  Итерируется по списку записей:

    *   Преобразует запись в словарь `record_dict`.
    *   Проверяет наличие ID в словаре.
    *   Формирует запрос на обновление, используя `sqlalchemy_update`, фильтруя по ID и устанавливая значения из `update_data`.
    *   Выполняет запрос.
    *   Увеличивает счетчик обновленных записей.
3.  Вызывает `session.flush()`.
4.  Возвращает общее количество обновленных записей.
5.  В случае ошибки выполняет откат транзакции с помощью `session.rollback()`, логирует ошибку и повторно вызывает исключение.