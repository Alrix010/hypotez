# Модуль для обработки изображений

## Обзор

Модуль `src.endpoints.freegpt-webui-ru/g4f/image.py` предназначен для обработки изображений, включая преобразование форматов, изменение размеров и кодирование в Base64.

## Подробней

Модуль предоставляет функции для работы с изображениями, используя библиотеку PIL (Pillow) и другие утилиты.

## Переменные

*   `ALLOWED_EXTENSIONS` (set): Набор разрешенных расширений файлов изображений (png, jpg, jpeg, gif, webp, svg).
*   `EXTENSIONS_MAP` (dict[str, str]): Словарь, содержащий соответствия между MIME-типами и расширениями файлов изображений.
*   `images_dir` (str): Директория для сохранения сгенерированных изображений (значение: `"./generated_images"`).

## Классы

### `ImageDataResponse`

**Описание**: Класс для представления ответа с данными об изображении.

**Атрибуты**:

*   `images` (Union[str, list]): URL-адрес или список URL-адресов изображений.
*   `alt` (str): Альтернативный текст для изображений.

**Методы**:

*   `get_list(self) -> list[str]`: Возвращает список URL-адресов изображений.

### `ImageRequest`

**Описание**: Класс для представления запроса изображения.

**Атрибуты**:

*   `options` (dict): Словарь с опциями запроса.

**Методы**:

*   `get(self, key: str)`: Возвращает значение опции по ключу.

## Функции

### `to_image`

```python
def to_image(image: ImageType, is_svg: bool = False) -> Image:
```

**Назначение**: Преобразует входное изображение в объект PIL Image.

**Параметры**:

*   `image` (ImageType): Входное изображение (путь к файлу, байты или объект PIL Image).
*   `is_svg` (bool, optional): Указывает, является ли изображение SVG. Defaults to `False`.

**Возвращает**:

*   `Image`: Преобразованный объект PIL Image.

**Вызывает исключения**:

*   `MissingRequirementsError`: Если не установлены необходимые библиотеки (`pillow`, `cairosvg`).
*   `ValueError`: Если формат изображения не поддерживается.

**Как работает функция**:

1.  Проверяет наличие необходимых библиотек.
2.  Преобразует изображение из различных форматов (путь к файлу, байты, data URI) в объект PIL Image.
3.  Для SVG-изображений использует библиотеку `cairosvg` для преобразования в PNG.

### `is_allowed_extension`

```python
def is_allowed_extension(filename: str) -> bool:
```

**Назначение**: Проверяет, имеет ли указанное имя файла разрешенное расширение.

**Параметры**:

*   `filename` (str): Имя файла для проверки.

**Возвращает**:

*   `bool`: `True`, если расширение разрешено, `False` в противном случае.

**Как работает функция**:

1.  Проверяет наличие точки в имени файла.
2.  Извлекает расширение файла.
3.  Проверяет, входит ли расширение в список разрешенных расширений `ALLOWED_EXTENSIONS`.

### `is_data_uri_an_image`

```python
def is_data_uri_an_image(data_uri: str) -> bool:
```

**Назначение**: Проверяет, представляет ли указанный data URI изображение.

**Параметры**:

*   `data_uri` (str): Data URI для проверки.

**Вызывает исключения**:

*   `ValueError`: Если data URI недействителен или формат изображения не разрешен.

**Как работает функция**:

1.  Проверяет, начинается ли data URI с `data:image`.
2.  Извлекает формат изображения из data URI.
3.  Проверяет, входит ли формат изображения в список разрешенных форматов `ALLOWED_EXTENSIONS`.

### `is_accepted_format`

```python
def is_accepted_format(binary_data: bytes) -> str:
```

**Назначение**: Проверяет, представляет ли указанные двоичные данные изображение с поддерживаемым форматом.

**Параметры**:

*   `binary_data` (bytes): Двоичные данные для проверки.

**Возвращает**:

*   `str`: MIME-тип изображения, если формат поддерживается.

**Вызывает исключения**:

*   `ValueError`: Если формат изображения не поддерживается.

**Как работает функция**:

1.  Проверяет сигнатуры для различных форматов изображений (JPEG, PNG, GIF, WebP).
2.  Возвращает MIME-тип, соответствующий обнаруженной сигнатуре.

### `extract_data_uri`

```python
def extract_data_uri(data_uri: str) -> bytes:
```

**Назначение**: Извлекает двоичные данные из указанного data URI.

**Параметры**:

*   `data_uri` (str): Data URI.

**Возвращает**:

*   `bytes`: Извлеченные двоичные данные.

**Как работает функция**:

1.  Разделяет data URI по запятой и извлекает часть с данными, закодированными в Base64.
2.  Декодирует данные из Base64.

### `get_orientation`

```python
def get_orientation(image: Image) -> int:
```

**Назначение**: Получает ориентацию указанного изображения.

**Параметры**:

*   `image` (Image): Объект PIL Image.

**Возвращает**:

*   `int`: Значение ориентации изображения.

**Как работает функция**:

1.  Получает EXIF-данные из изображения.
2.  Извлекает значение тега ориентации (274).

### `process_image`

```python
def process_image(image: Image, new_width: int, new_height: int) -> Image:
```

**Назначение**: Обрабатывает указанное изображение, корректируя его ориентацию и изменяя размер.

**Параметры**:

*   `image` (Image): Изображение для обработки.
*   `new_width` (int): Новая ширина изображения.
*   `new_height` (int): Новая высота изображения.

**Возвращает**:

*   `Image`: Обработанное изображение.

**Как работает функция**:

1.  Исправляет ориентацию изображения на основе EXIF-данных.
2.  Изменяет размер изображения до указанных ширины и высоты.
3.  Удаляет прозрачность (если есть).
4.  Преобразует изображение в формат RGB (если необходимо).

### `to_bytes`

```python
def to_bytes(image: ImageType) -> bytes:
```

**Назначение**: Преобразует указанное изображение в байты.

**Параметры**:

*   `image` (ImageType): Изображение для преобразования.

**Возвращает**:

*   `bytes`: Изображение в виде байтов.

**Как работает функция**:

1.  Преобразует изображение из различных форматов (байты, data URI, объект PIL Image, путь к файлу) в байты.

### `to_data_uri`

```python
def to_data_uri(image: ImageType) -> str:
```

**Назначение**: Преобразует указанное изображение в data URI.

**Параметры**:

*   `image` (ImageType): Изображение для преобразования.

**Возвращает**:

*   `str`: Data URI изображения.

**Как работает функция**:

1.  Преобразует изображение в байты с помощью `to_bytes`.
2.  Кодирует байты в Base64.
3.  Формирует data URI, добавляя MIME-тип изображения.