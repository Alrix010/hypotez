# Модуль для работы с сервисом Mega

## Обзор

Модуль `src.endpoints.bots.google_drive.mega.mega` предоставляет класс `Mega` для взаимодействия с сервисом Mega.

## Подробней

Модуль содержит функции для входа в аккаунт Mega, загрузки и скачивания файлов, а также для выполнения криптографических операций.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с сервисом Mega.

**Атрибуты**:

*   `seqno` (int): Случайное число для идентификации запросов.
*   `sid` (str): ID сессии.
*   `master_key` (list): Мастер-ключ для шифрования и дешифрования.
*   `rsa_priv_key` (list): Приватный ключ RSA.
*   `root_id` (str): ID корневой папки.
*   `inbox_id` (str): ID папки входящих.
*   `trashbin_id` (str): ID корзины.

**Методы**:

*   `__init__(self)`: Инициализирует объект `Mega`.
*   `from_credentials(cls, email, password)`: Создает экземпляр класса `Mega` с использованием email и пароля.
*   `from_ephemeral(cls)`: Создаёт экземпляр класса `Mega` с использованием эфемерной сессии.
*   `api_req(self, data)`: Отправляет API-запрос к Mega.
*   `login_user(self, email, password)`: Выполняет вход в аккаунт Mega с использованием email и пароля.
*   `login_ephemeral(self)`: Выполняет вход в аккаунт Mega с использованием эфемерной сессии.
*   `_login_common(self, res, password)`: Общая логика для входа в аккаунт.
*   `get_files(self)`: Получает список файлов из Mega.
*   `download_from_url(self, url)`: Загружает файл по URL-адресу.
*   `download_file(self, file_id, file_key, public=False, store_path=None)`: Загружает файл по его ID и ключу.
*   `get_public_url(self, file_id, file_key)`: Получает публичный URL-адрес файла.
*   `uploadfile(self, filename, dst=None)`: Загружает файл на Mega.

## Методы класса `Mega`

### `__init__`

```python
def __init__(self):
```

**Назначение**: Инициализирует объект `Mega`.

**Как работает функция**:

1.  Инициализирует атрибут `seqno` случайным числом.
2.  Устанавливает атрибут `sid` в `None`.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email, password):
```

**Назначение**: Создает экземпляр класса `Mega` с использованием email и пароля.

**Параметры**:

*   `email` (str): Email пользователя.
*   `password` (str): Пароль пользователя.

**Возвращает**:

*   Экземпляр класса `Mega`.

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_user` для входа в аккаунт.
3.  Возвращает созданный экземпляр.

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls):
```

**Назначение**: Создаёт экземпляр класса `Mega` с использованием эфемерной сессии.

**Возвращает**:

*   Экземпляр класса `Mega`.

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_ephemeral` для входа в аккаунт с использованием эфемерной сессии.
3.  Возвращает созданный экземпляр.

### `api_req`

```python
def api_req(self, data):
```

**Назначение**: Отправляет API-запрос к Mega.

**Параметры**:

*   `data` (dict): Данные запроса.

**Возвращает**:

*   Ответ от API в формате JSON.

**Вызывает исключения**:

*   `MegaRequestException`: Если API возвращает код ошибки.

**Как работает функция**:

1.  Формирует параметры запроса, включая `id` и `sid` (если есть).
2.  Преобразует данные в JSON-строку.
3.  Отправляет POST-запрос к API Mega.
4.  Преобразует ответ в формат JSON.
5.  Если API возвращает код ошибки, вызывает исключение `MegaRequestException`.

### `login_user`

```python
def login_user(self, email, password):
```

**Назначение**: Выполняет вход в аккаунт Mega с использованием email и пароля.

**Параметры**:

*   `email` (str): Email пользователя.
*   `password` (str): Пароль пользователя.

**Как работает функция**:

1.  Подготавливает ключ на основе пароля.
2.  Вычисляет хеш email.
3.  Отправляет API-запрос для входа в аккаунт.
4.  Вызывает метод `_login_common` для завершения процесса входа.

### `login_ephemeral`

```python
def login_ephemeral(self):
```

**Назначение**: Выполняет вход в аккаунт Mega с использованием эфемерной сессии.

**Как работает функция**:

1.  Генерирует случайные ключи.
2.  Отправляет API-запрос для получения пользовательского ID.
3.  Отправляет API-запрос для входа в аккаунт.
4.  Вызывает метод `_login_common` для завершения процесса входа.

### `_login_common`

```python
def _login_common(self, res, password):
```

**Назначение**: Общая логика для входа в аккаунт.

**Параметры**:

*   `res` (dict): Ответ от API.
*   `password` (list): Ключ, полученный из пароля.

**Вызывает исключения**:

*   `MegaIncorrectPasswordExcetion`: Если email или пароль указаны неверно.

**Как работает функция**:

1.  Проверяет код ответа API.
2.  Дешифрует мастер-ключ.
3.  Получает ID сессии (если есть).
4.  Расшифровывает приватный ключ RSA (если есть).

### `get_files`

```python
def get_files(self):
```

**Назначение**: Получает список файлов из Mega.

**Возвращает**:

*   Список файлов.

**Как работает функция**:

1.  Отправляет API-запрос для получения списка файлов.
2.  Итерируется по списку файлов и дешифрует атрибуты файлов и папок.
3.  Сохраняет ID корневой папки, папки входящих и корзины.

### `download_from_url`

```python
def download_from_url(self, url):
```

**Назначение**: Загружает файл по URL-адресу.

**Параметры**:

*   `url` (str): URL-адрес файла.

**Возвращает**:

*   Имя файла.

**Как работает функция**:

1.  Извлекает ID файла и ключ из URL-адреса.
2.  Вызывает метод `download_file` для загрузки файла.

### `download_file`

```python
def download_file(self, file_id, file_key, public=False, store_path=None):
```

**Назначение**: Загружает файл по его ID и ключу.

**Параметры**:

*   `file_id` (str): ID файла.
*   `file_key` (list): Ключ файла.
*   `public` (bool, optional): Указывает, является ли файл общедоступным. По умолчанию `False`.
*   `store_path` (str, optional): Путь для сохранения файла. По умолчанию `None`.

**Возвращает**:

*   Имя файла.

**Вызывает исключения**:

*   `ValueError`: Если MAC не совпадает.

**Как работает функция**:

1.  Отправляет API-запрос для получения информации о файле.
2.  Дешифрует ключ файла.
3.  Получает URL-адрес файла.
4.  Дешифрует атрибуты файла.
5.  Загружает файл по частям и дешифрует каждую часть.
6.  Проверяет целостность файла.

### `get_public_url`

```python
def get_public_url(self, file_id, file_key):
```

**Назначение**: Получает публичный URL-адрес файла.

**Параметры**:

*   `file_id` (str): ID файла.
*   `file_key` (list): Ключ файла.

**Возвращает**:

*   Публичный URL-адрес файла.

**Как работает функция**:

1.  Отправляет API-запрос для получения публичного ID файла.
2.  Формирует URL-адрес на основе ID файла и ключа.

### `uploadfile`

```python
def uploadfile(self, filename, dst=None):
```

**Назначение**: Загружает файл на Mega.

**Параметры**:

*   `filename` (str): Путь к файлу для загрузки.
*   `dst` (str, optional): ID целевой папки. По умолчанию `None` (корневая папка).

**Возвращает**:

*   Данные ответа API.

**Как работает функция**:

1.  Определяет целевую папку (корневая, если не указана).
2.  Получает URL-адрес для загрузки.
3.  Шифрует файл по частям.
4.  Отправляет зашифрованные части на сервер.
5.  Формирует запрос на завершение загрузки и отправляет его на сервер.