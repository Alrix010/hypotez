# Модуль для кодирования и декодирования путей файлов

## Обзор

Этот модуль предоставляет класс `PathEncoderDecoder` для кодирования и декодирования путей к файлам с использованием хэширования и сохранения соответствий в базе данных SQLite. Это может быть полезно для хранения путей в сокращенном виде и для защиты от несанкционированного доступа к файлам.

## Подробнее

Модуль использует хэш-функцию MD5 для создания коротких идентификаторов (ID) на основе полных путей к файлам. Соответствия между короткими ID и полными путями хранятся в SQLite базе данных. Это позволяет восстанавливать полные пути файлов по их коротким ID. Модуль также предоставляет функцию для очистки таблицы соответствий в базе данных.

## Классы

### `PathEncoderDecoder`

```python
class PathEncoderDecoder:
    """
    Класс для кодирования и декодирования путей с использованием хэширования 
    и хранения данных в SQLite базе данных.
    """
    ...
```

**Описание**:
Класс `PathEncoderDecoder` предназначен для кодирования полных путей к файлам в короткие уникальные идентификаторы и для декодирования этих идентификаторов обратно в полные пути. Он использует хэширование и SQLite базу данных для хранения соответствий.

**Атрибуты**:
- `db_path` (str): Путь к SQLite базе данных для хранения таблицы соответствий.

**Методы**:
- `__init__(self, db_path: str = 'path_mapping.db')`: Инициализирует класс и создает базу данных, если она не существует.
- `_initialize_database(self)`: Создает таблицу `path_mapping` в базе данных, если она не существует.
- `_save_to_database(self, short_id: str, file_path: str)`: Сохраняет соответствие между коротким ID и полным путем в базу данных.
- `_fetch_from_database(self, short_id: str) -> Optional[str]`: Извлекает полный путь из базы данных по короткому ID.
- `encode(self, file_path: str) -> str`: Кодирует полный путь в короткий ID.
- `decode(self, short_id: str) -> Optional[str]`: Декодирует короткий ID обратно в полный путь.
- `clear_mapping(self)`: Очищает таблицу соответствий в базе данных.

## Методы класса

### `__init__`

```python
def __init__(self, db_path: str = 'path_mapping.db'):
    """
    Инициализация класса.

    Args:
        db_path (str): Путь к SQLite базе данных для хранения таблицы соответствий.
    """
    ...
```

**Назначение**:
Инициализирует экземпляр класса `PathEncoderDecoder`.

**Параметры**:
- `db_path` (str, optional): Путь к SQLite базе данных для хранения таблицы соответствий. По умолчанию `'path_mapping.db'`.

**Как работает функция**:
1.  Присваивает значение параметра `db_path` атрибуту `self.db_path`.
2.  Вызывает метод `self._initialize_database()` для создания таблицы в базе данных, если она еще не существует.

### `_initialize_database`

```python
def _initialize_database(self):
    """
    Инициализация базы данных, создание таблицы, если она отсутствует.
    """
    ...
```

**Назначение**:
Создает таблицу `path_mapping` в базе данных, если она еще не существует.

**Как работает функция**:
1.  Подключается к базе данных, указанной в `self.db_path`.
2.  Создает таблицу `path_mapping` с двумя столбцами: `id` (TEXT PRIMARY KEY) и `file_path` (TEXT NOT NULL).
3.  Сохраняет изменения в базе данных.

### `_save_to_database`

```python
def _save_to_database(self, short_id: str, file_path: str):
    """
    Сохраняет хэш и путь в базу данных.

    Args:
        short_id (str): Уникальный идентификатор пути.
        file_path (str): Полный путь к файлу.
    """
    ...
```

**Назначение**:
Сохраняет соответствие между коротким ID и полным путем к файлу в базе данных.

**Параметры**:
- `short_id` (str): Уникальный идентификатор пути.
- `file_path` (str): Полный путь к файлу.

**Как работает функция**:
1.  Подключается к базе данных, указанной в `self.db_path`.
2.  Выполняет SQL-запрос `INSERT OR IGNORE` для добавления записи в таблицу `path_mapping`.
3.  Сохраняет изменения в базе данных.

### `_fetch_from_database`

```python
def _fetch_from_database(self, short_id: str) -> Optional[str]:
    """
    Извлекает путь из базы данных по короткому идентификатору.

    Args:
        short_id (str): Уникальный идентификатор пути.

    Returns:
        Optional[str]: Полный путь файла или `None`, если идентификатор не найден.
    """
    ...
```

**Назначение**:
Извлекает полный путь к файлу из базы данных по заданному короткому ID.

**Параметры**:
- `short_id` (str): Уникальный идентификатор пути.

**Возвращает**:
- `Optional[str]`: Полный путь к файлу или `None`, если идентификатор не найден в базе данных.

**Как работает функция**:
1.  Подключается к базе данных, указанной в `self.db_path`.
2.  Выполняет SQL-запрос `SELECT` для извлечения `file_path` из таблицы `path_mapping` по заданному `id`.
3.  Возвращает `file_path`, если запись найдена, иначе возвращает `None`.

### `encode`

```python
def encode(self, file_path: str) -> str:
    """
    Кодирует путь в короткий идентификатор.

    Args:
        file_path (str): Полный путь файла.

    Returns:
        str: Короткий идентификатор.
    """
    ...
```

**Назначение**:
Кодирует полный путь к файлу в короткий уникальный идентификатор.

**Параметры**:
- `file_path` (str): Полный путь к файлу.

**Возвращает**:
- `str`: Короткий идентификатор.

**Как работает функция**:
1.  Вычисляет MD5-хэш от переданного пути, используя кодировку UTF-8.
2.  Извлекает первые 8 символов из хэша.
3.  Формирует короткий ID, добавляя префикс `id-` к извлеченным 8 символам хэша.
4.  Сохраняет соответствие между коротким ID и полным путем в базу данных, используя метод `self._save_to_database()`.
5.  Возвращает короткий ID.

### `decode`

```python
def decode(self, short_id: str) -> Optional[str]:
    """
    Декодирует короткий идентификатор обратно в путь.

    Args:
        short_id (str): Короткий идентификатор.

    Returns:
        Optional[str]: Полный путь файла или `None`, если идентификатор не найден.
    """
    ...
```

**Назначение**:
Декодирует короткий ID обратно в полный путь к файлу.

**Параметры**:
- `short_id` (str): Короткий идентификатор.

**Возвращает**:
- `Optional[str]`: Полный путь к файлу или `None`, если идентификатор не найден в базе данных.

**Как работает функция**:
1.  Вызывает метод `self._fetch_from_database()` для извлечения полного пути из базы данных по заданному `short_id`.
2.  Возвращает извлеченный путь или `None`, если ID не найден.

### `clear_mapping`

```python
def clear_mapping(self):
    """
    Очищает таблицу соответствий.
    """
    ...
```

**Назначение**:
Очищает таблицу `path_mapping` в базе данных, удаляя все записи.

**Как работает функция**:
1.  Подключается к базе данных, указанной в `self.db_path`.
2.  Выполняет SQL-запрос `DELETE FROM path_mapping` для удаления всех записей из таблицы.
3.  Сохраняет изменения в базе данных.

## Пример использования

```python
if __name__ == '__main__':
    encoder_decoder = PathEncoderDecoder()

    # Кодирование пути
    original_path = 'src/same_folder/same_sub_folder/same-file.ext'
    encoded = encoder_decoder.encode(original_path)
    print(f'Кодированный путь: {encoded}')

    # Декодирование пути
    decoded = encoder_decoder.decode(encoded)
    print(f'Декодированный путь: {decoded}')

    # Очистка таблицы соответствий
    # encoder_decoder.clear_mapping()
```

В этом примере создается экземпляр класса `PathEncoderDecoder`, кодируется путь к файлу, затем декодируется обратно. В конце приводится закомментированный пример очистки таблицы соответствий.