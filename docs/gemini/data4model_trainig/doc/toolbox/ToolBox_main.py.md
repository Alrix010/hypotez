# Модуль основного кода Telegram-бота Toolbox

## Обзор

Модуль `src.endpoints.bots.telegram.ToolBoxbot-main/ToolBox/ToolBox_main.py` содержит основной код Telegram-бота Toolbox, который предоставляет различные инструменты на основе нейронных сетей.

## Подробней

Модуль реализует следующие функции:

*   Обработка команд и сообщений пользователей.
*   Управление подписками и тарифами.
*   Генерация текста и изображений.
*   Логирование и аналитика.
*   Интеграция с базой данных для хранения информации о пользователях и их подписках.

## Переменные

*   `N` (int): Количество типов текста (значение: 8).
*   `DATA_PATTERN` (lambda): Лямбда-функция для инициализации данных пользователя.
*   `photo_array` (list): Список для хранения фотографий.
*   `tb` (ToolBox): Экземпляр класса `ToolBox` для управления ботом.
*   `base` (DataBase): Экземпляр класса `DataBase` для работы с базой данных.
*   `db` (dict): Словарь, содержащий данные пользователей.

## Функции

### `process_pre_checkout_query`

```python
@bot.pre_checkout_query_handler(func=lambda query: True)
def process_pre_checkout_query(pre_checkout_query):
```

**Назначение**: Обрабатывает запрос перед подтверждением оплаты.

**Как работает функция**:

1.  Подтверждает запрос, используя `bot.answer_pre_checkout_query`.

### `successful_payment`

```python
@bot.message_handler(content_types=['successful_payment'])
def successful_payment(message):
```

**Назначение**: Обрабатывает успешное завершение оплаты.

**Как работает функция**:

1.  Извлекает ID пользователя из сообщения.
2.  Определяет, какой тариф был оплачен (basic или pro).
3.  Обновляет информацию о подписке пользователя в базе данных.
4.  Отправляет пользователю сообщение об успешной активации подписки.
5.  Перезапускает бота, используя `tb.restart`.

### `StartProcessing`

```python
@bot.message_handler(commands=['start'])
def StartProcessing(message):
```

**Назначение**: Обрабатывает команду `/start`.

**Как работает функция**:

1.  Извлекает ID пользователя из сообщения.
2.  Инициализирует данные пользователя в базе данных, если их нет, или обновляет существующие данные.
3.  Вызывает функцию `tb.start_request` для обработки запроса пользователя.

### `personal_account`

```python
@bot.message_handler(commands=['profile'])
def personal_account(message):
```

**Назначение**: Отображает информацию о профиле пользователя.

**Как работает функция**:

1.  Извлекает ID пользователя из сообщения.
2.  Определяет тип подписки пользователя (basic, pro или отсутствие подписки).
3.  Отправляет пользователю сообщение с информацией о его подписке.

### `show_stat`

```python
@bot.message_handler(commands=['stat'])
def show_stat(message):
```

**Назначение**: Отображает статистику бота (доступно только для администраторов).

**Как работает функция**:

1.  Извлекает ID пользователя из сообщения.
2.  Проверяет, является ли пользователь администратором.
3.  Если пользователь является администратором, отправляет сообщение со статистикой (общее количество пользователей и количество пользователей с промокодом).

### `generate_promo_code`

```python
def generate_promo_code(length):
```

**Назначение**: Генерирует случайный промокод.

**Параметры**:

*   `length` (int): Длина промокода.

**Возвращает**:

*   `str`: Сгенерированный промокод.

**Как работает функция**:

1.  Генерирует случайную строку из букв и цифр указанной длины.

### `CallsProcessing`

```python
@bot.callback_query_handler(func=lambda call: True)
def CallsProcessing(call):
```

**Назначение**: Обрабатывает обратные вызовы от инлайн-клавиатур.

**Как работает функция**:

1.  Извлекает ID пользователя из обратного вызова.
2.  Определяет тип действия, которое нужно выполнить, на основе данных обратного вызова.
3.  Вызывает соответствующие функции для обработки действия (отображение текстовых типов, выбор размера изображения, активация тарифа и т.д.).

### `TokensCancelletionPattern`

```python
def TokensCancelletionPattern(user_id: str, func, message, i: int = None) -> None:
```

**Назначение**: Обрабатывает текстовые команды.

**Как работает функция**:

1.  Извлекает данные пользователя из базы данных.
2.  Проверяет наличие доступных токенов или бесплатных запросов.
3.  Вызывает функцию для обработки текстовой команды и уменьшает количество доступных токенов или запросов.
4.  Обрабатывает различные сценарии (завершение тарифа, отсутствие токенов).

### `TasksProcessing`

```python
@bot.message_handler(func=lambda message: True, content_types=['text', 'photo'])
def TasksProcessing(message):
```

**Назначение**: Обрабатывает входящие текстовые сообщения и фотографии.

**Как работает функция**:

1.  Извлекает ID пользователя из сообщения.
2.  Обрабатывает загрузку изображений (если они есть) и сохраняет их в сессионные сообщения пользователя.
3.  Обрабатывает текстовые сообщения в зависимости от состояния пользователя (активирован ли бесплатный режим или нет).

### `end_check_tariff_time`

```python
async def end_check_tariff_time():
```

**Назначение**: Проверяет срок действия тарифа пользователя и обновляет его статус.

**Как работает функция**:

1.  Итерируется по всем пользователям в базе данных.
2.  Проверяет, истек ли срок действия подписки пользователя.
3.  Если срок действия истек, обновляет статус подписки пользователя в базе данных.

## Использование

Модуль предоставляет основной функционал для Telegram-бота Toolbox, включая обработку команд, управление подписками, генерацию контента и интеграцию с базой данных.