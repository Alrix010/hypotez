## Модуль `fast_api`

### Обзор

Модуль предназначен для создания FastAPI сервера с XML-RPC интерфейсом для удалённого управления.

### Подробней

Модуль предоставляет класс `FastApiServer`, который позволяет создавать, запускать и останавливать FastAPI серверы, а также добавлять новые маршруты и получать информацию о статусе серверов. Он также включает в себя класс `CommandHandler` для обработки команд, получаемых через XML-RPC.

## Классы

### `FastApiServer`

**Описание**: Класс для управления FastAPI сервером с реализацией Singleton.

**Атрибуты**:

*   `_instance`: Приватный атрибут для реализации Singleton.
*   `app` (FastAPI): Объект FastAPI, представляющий приложение.
*   `host` (str): Хост для запуска сервера (по умолчанию берется из конфигурации).
*   `port` (int): Порт для запуска сервера (по умолчанию 8000).
*   `router` (APIRouter): Объект APIRouter для добавления маршрутов.
*   `server_tasks` (dict): Словарь для хранения задач сервера.
*   `servers` (dict): Словарь для хранения серверов.

**Методы**:

*   `__new__`: Реализует Singleton, создавая только один экземпляр класса.
*   `__init__`: Инициализирует объект `FastApiServer`.
*   `add_route`: Добавляет маршрут к FastAPI приложению.
*   `_start_server`: Запускает uvicorn сервер асинхронно.
*   `start`: Запускает FastAPI сервер на указанном порту.
*   `stop`: Останавливает FastAPI сервер на указанном порту.
*   `stop_all`: Останавливает все запущенные сервера.
*   `get_servers_status`: Возвращает статус всех серверов.
*   `get_routes`: Возвращает список всех роутов.
*   `get_app`: Возвращает FastAPI приложение.
*   `add_new_route`: Добавляет новый маршрут к уже работающему приложению.

### `__new__`

```python
def __new__(cls, *args, **kwargs):
    if cls._instance is None:
        cls._instance = super().__new__(cls)
    return cls._instance
```

**Назначение**: Реализует Singleton, гарантируя, что будет создан только один экземпляр класса.

**Как работает функция**:

1.  Проверяет, существует ли уже экземпляр класса (`cls._instance`).
2.  Если экземпляр не существует, создает новый экземпляр с помощью `super().__new__(cls)`.
3.  Возвращает существующий экземпляр или только что созданный.

### `__init__`

```python
def __init__(self, host: str = "127.0.0.1", title: str = "FastAPI RPC Server", **kwargs):
    if hasattr(self, '_initialized'):
        return
    self._initialized = True
    self.add_route("/hello", test_function)
    self.add_route("/post", test_post, methods=["POST"])
    #self.add_route("/telegram_webhook", telegram_webhook, methods=["POST"])

    self.app = FastAPI()
    self.host = host or config.host
    self.server_tasks = {}
    self.servers = {}
    self.app.include_router(self.router)
```

**Назначение**: Инициализирует объект `FastApiServer`.

**Параметры**:

*   `host` (str): Хост для запуска сервера (по умолчанию `"127.0.0.1"`).
*   `title` (str): Заголовок сервера (по умолчанию `"FastAPI RPC Server"`).
*   `**kwargs`: Дополнительные параметры.

**Как работает функция**:

1.  Проверяет, был ли уже инициализирован объект. Если да, выходит из функции.
2.  Добавляет тестовые маршруты `/hello` и `/post`.
3.  Создает объект `FastAPI`.
4.  Устанавливает хост для сервера из аргумента или конфигурации.
5.  Инициализирует словари `server_tasks` и `servers`.
6.  Включает роутер `self.router` в приложение `self.app`.

### `add_route`

```python
def add_route(self, path: str, func: Callable, methods: List[str] = ["GET"], **kwargs):
    """Добавляет маршрут к FastAPI приложению."""
    ...
```

**Назначение**: Добавляет маршрут к FastAPI приложению.

**Параметры**:

*   `path` (str): Путь маршрута (например, `"/hello"`).
*   `func` (Callable): Функция, обрабатывающая маршрут.
*   `methods` (List[str]): Список HTTP методов, поддерживаемых маршрутом (по умолчанию `["GET"]`).
*   `**kwargs`: Дополнительные параметры для маршрута.

**Как работает функция**:

1.  Использует метод `self.router.add_api_route` для добавления маршрута к FastAPI приложению.
2.  Логирует информацию об успешной регистрации маршрута или возникшей ошибке.

### `_start_server`

```python
async def _start_server(self, port: int):
    """Запускает uvicorn сервер асинхронно."""
    ...
```

**Назначение**: Запускает uvicorn сервер асинхронно.

**Параметры**:

*   `port` (int): Порт для запуска сервера.

**Как работает функция**:

1.  Создает объект `uvicorn.Config` с параметрами хоста, порта и уровнем логирования.
2.  Создает объект `uvicorn.Server` с конфигурацией.
3.  Запускает сервер асинхронно с помощью `await server.serve()`.
4.  После завершения работы сервера удаляет его из словаря `self.servers`.

### `start`

```python
def start(self, port: int, as_thread:bool = True):
    """Запускает FastAPI сервер на указанном порту."""
    ...
```

**Назначение**: Запускает FastAPI сервер на указанном порту.

**Параметры**:

*   `port` (int): Порт для запуска сервера.
*   `as_thread` (bool): Флаг запуска сервера в отдельном потоке, default True

**Как работает функция**:

1.  Проверяет, запущен ли уже сервер на указанном порту.
2.  Если сервер не запущен, создает поток и запускает в нем асинхронную функцию `self._start_server`.

### `stop`

```python
def stop(self, port: int):
    """Останавливает FastAPI сервер на указанном порту."""
    ...
```

**Назначение**: Останавливает FastAPI сервер на указанном порту.

**Параметры**:

*   `port` (int): Порт сервера, который необходимо остановить.

**Как работает функция**:

1.  Проверяет, запущен ли сервер на указанном порту.
2.  Если сервер запущен, останавливает его и удаляет из словаря `self.servers`.

### `stop_all`

```python
def stop_all(self):
    """Останавливает все запущенные сервера."""
    ...
```

**Назначение**: Останавливает все запущенные сервера.

**Как работает функция**:

1.  Итерируется по списку запущенных серверов и вызывает метод `stop` для каждого из них.

### `get_servers_status`

```python
def get_servers_status(self):
    """Возвращает статус всех серверов."""
    ...
```

**Назначение**: Возвращает статус всех серверов.

**Возвращает**:

*   `dict`: Словарь, где ключи - порты, а значения - статус серверов (`"Running"` или `"Stopped"`).

**Как работает функция**:

1.  Формирует словарь, содержащий статус каждого запущенного сервера.

### `get_routes`

```python
def get_routes(self):
    """Возвращает список всех роутов."""
    ...
```

**Назначение**: Возвращает список всех роутов.

**Возвращает**:

*   `list`: Список роутов, где каждый роут представлен словарем с ключами `path` и `methods`.

**Как работает функция**:

1.  Проходит по списку роутов приложения `self.app.routes`.
2.  Если у роута есть атрибут `path`, добавляет информацию о пути и методах в список `routes`.

### `add_new_route`

```python
def add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"], **kwargs):
    """Добавляет новый маршрут к уже работающему приложению."""
    ...
```

**Назначение**: Добавляет новый маршрут к уже работающему приложению.

**Параметры**:

*   `path` (str): Путь маршрута (например, `"/new_route"`).
*   `module_name` (str): Имя модуля, содержащего функцию для обработки маршрута.
*   `func_name` (str): Имя функции, обрабатывающей маршрут.
*   `methods` (List[str]): Список HTTP методов, поддерживаемых маршрутом (по умолчанию `["GET"]`).
*   `**kwargs`: Дополнительные параметры для маршрута.

**Как работает функция**:

1.  Динамически импортирует модуль с именем `module_name`.
2.  Извлекает функцию с именем `func_name` из импортированного модуля.
3.  Вызывает метод `self.add_route` для добавления маршрута с указанными параметрами.

### `CommandHandler`

**Описание**: Класс для обработки команд для FastAPI сервера через XML-RPC.

**Атрибуты**:

*   `rpc_port` (int): Порт для RPC-сервера (по умолчанию 9000).
*   `rpc_server` (SimpleXMLRPCServer): Объект SimpleXMLRPCServer для обработки RPC-запросов.

**Методы**:

*   `__init__`: Инициализирует объект `CommandHandler`.
*   `start_server`: Запускает FastAPI сервер.
*   `stop_server`: Останавливает FastAPI сервер.
*   `stop_all_servers`: Останавливает все запущенные FastAPI сервера.
*   `status_servers`: Возвращает статус всех серверов.
*   `get_routes`: Возвращает список всех роутов.
*   `add_new_route`: Добавляет новый роут к серверу.
*   `shutdown`: Останавливает все серверы и завершает работу RPC-сервера.

### `__init__`

```python
def __init__(self, rpc_port=9000):
    self.rpc_port = rpc_port
    self.rpc_server = SimpleXMLRPCServer(("localhost", self.rpc_port), allow_none=True)
    self.rpc_server.register_instance(self)
    threading.Thread(target=self.rpc_server.serve_forever, daemon=True).start()
    print(f"RPC server started on port: {self.rpc_port}")
```

**Назначение**: Инициализирует объект `CommandHandler`.

**Параметры**:

*   `rpc_port` (int): Порт для RPC-сервера (по умолчанию 9000).

**Как работает функция**:

1.  Устанавливает порт для RPC-сервера.
2.  Создает объект `SimpleXMLRPCServer` для обработки RPC-запросов.
3.  Регистрирует экземпляр `CommandHandler` в RPC-сервере.
4.  Запускает RPC-сервер в отдельном потоке.

### Остальные методы `CommandHandler` (start_server, stop_server, stop_all_servers, status_servers, get_routes, add_new_route, shutdown)

Эти методы просто вызывают соответствующие функции (уже описанные выше), передавая им необходимые параметры. Они служат для предоставления интерфейса управления сервером через RPC.

## Вспомогательные функции

### `telegram_webhook`, `test_function`, `test_post`

Эти функции представляют собой примеры обработчиков для маршрутов FastAPI.

### `parse_port_range`

```python
def parse_port_range(range_str):
    """Разбирает строку с диапазоном портов."""
    ...
```

**Назначение**: Разбирает строку с диапазоном портов.

**Параметры**:

*   `range_str` (str): Строка, представляющая диапазон портов (например, `"8000-8005"` или `"8000"`).

**Возвращает**:

*   `List[int]`: Список портов в диапазоне, если строка валидна, иначе пустой список.

**Как работает функция**:

1.  Проверяет, соответствует ли строка шаблону диапазона портов (например, `"8000-8005"` или `"8000"`).
2.  Если строка содержит дефис, разделяет ее на начало и конец диапазона и генерирует список портов в этом диапазоне.
3.  Если строка не содержит дефис, пытается преобразовать ее в целое число и возвращает список, содержащий только это число.

### `display_menu`

```python
def display_menu():
    """Выводит меню с доступными командами."""
    ...
```

**Назначение**: Выводит меню с доступными командами.

**Как работает функция**:

1.  Выводит на экран список доступных команд для управления сервером через RPC.

## Логика работы

1.  Инициализация RPC-сервера.
2.  Отображение меню доступных команд.
3.  Чтение команды, введенной пользователем.
4.  Выполнение соответствующей команды.
5.  Повтор шагов 2-4 до тех пор, пока пользователь не введет команду выхода.

## Использование

Для управления сервером необходимо запустить скрипт `fast_api.py` и использовать команды, указанные в меню.

## Зависимости

*   `uvicorn`: Для запуска FastAPI сервера.
*   `fastapi`: Для создания API.
*   `xmlrpc.server`: Для создания XML-RPC сервера.
*   `threading`: Для запуска сервера в отдельном потоке.
*   `importlib`: Для динамического импорта модулей.

## Замечания

Модуль предоставляет базовую функциональность для управления сервером и может потребовать доработки для использования в production-среде. Необходимо учитывать безопасность RPC-интерфейса и обеспечить надежную аутентификацию и авторизацию.
```python
...
```
Данный код указывает на то, что в модуле есть еще не реализованная функциональность.
При возникновении каких-либо проблем и/или предложений свяжитесь с разработчиком.