# Модуль запуска Telegram-бота с использованием вебхуков

## Обзор

Модуль `src.endpoints.bots.telegram.digital_market.bot.main` предназначен для запуска Telegram-бота, использующего библиотеку `aiogram` и работающего через вебхуки. Бот предназначен для цифрового интернет-магазина.

## Подробней

Модуль содержит функции для настройки и запуска Telegram-бота, регистрации обработчиков, настройки вебхуков и управления миграциями базы данных.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
```

**Назначение**: Устанавливает команды по умолчанию для бота.

**Как работает функция**:

1.  Определяет список команд для бота (в данном случае только `/start`).
2.  Устанавливает команды для бота, используя метод `bot.set_my_commands` и область видимости по умолчанию.

### `on_startup`

```python
async def on_startup(app):
```

**Назначение**: Выполняется при запуске приложения.

**Параметры**:

*   `app`: Веб-приложение `aiohttp`.

**Как работает функция**:

1.  Устанавливает команды по умолчанию для бота, вызывая `set_default_commands`.
2.  Устанавливает вебхук для бота, используя `settings.get_webhook_url`.
3.  Отправляет сообщение администраторам о запуске бота.
4.  Логирует информацию об успешном запуске бота.

### `on_shutdown`

```python
async def on_shutdown(app):
```

**Назначение**: Выполняется при остановке приложения.

**Параметры**:

*   `app`: Веб-приложение `aiohttp`.

**Как работает функция**:

1.  Отправляет сообщение администраторам об остановке бота.
2.  Удаляет вебхук бота, используя `bot.delete_webhook`.
3.  Закрывает сессию бота.
4.  Логирует информацию об остановке бота.

### `register_middlewares`

```python
def register_middlewares():
```

**Назначение**: Регистрирует мидлвари для диспетчера.

**Как работает функция**:

1.  Регистрирует `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` для управления подключениями к базе данных.

### `register_routers`

```python
def register_routers():
```

**Назначение**: Регистрирует маршруты для диспетчера.

**Как работает функция**:

1.  Включает маршрутизаторы `catalog_router`, `user_router` и `admin_router` в диспетчер.

### `create_app`

```python
def create_app():
```

**Назначение**: Создает и настраивает приложение `aiohttp`.

**Возвращает**:

*   `web.Application`: Созданное и настроенное веб-приложение.

**Как работает функция**:

1.  Создает экземпляр класса `aiohttp.web.Application`.
2.  Регистрирует обработчики маршрутов для вебхука Telegram, обработки результатов Robokassa и главной страницы.
3.  Настраивает приложение с диспетчером и ботом, используя `setup_application`.
4.  Регистрирует функции запуска и остановки.

### `main`

```python
def main():
```

**Назначение**: Главная функция для запуска приложения.

**Как работает функция**:

1.  Регистрирует мидлвари и маршрутизаторы.
2.  Создает приложение `aiohttp`, используя `create_app`.
3.  Запускает веб-приложение, используя `web.run_app`.