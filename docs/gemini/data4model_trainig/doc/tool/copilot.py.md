# Модуль для анализа pull-реквестов

## Обзор

Модуль `src.endpoints.gpt4free/etc/testing/test_providers.py` предназначен для автоматического анализа изменений кода в pull-реквестах GitHub и создания комментариев с предложениями по улучшению.

## Подробней

Модуль использует API GitHub, а также языковые модели для анализа изменений и генерации комментариев.

## Переменные

*   `GITHUB_TOKEN` (str): Токен GitHub API.
*   `GITHUB_REPOSITORY` (str): Имя репозитория GitHub (например, `"owner/repo"`).
*   `G4F_PROVIDER` (str): Провайдер для g4f (например, `"openai"`).
*   `G4F_MODEL` (str): Модель для g4f (например, `"gpt-3.5-turbo"`).

## Функции

### `get_pr_details`

```python
def get_pr_details(github: Github) -> PullRequest:
```

**Назначение**: Получает детали pull-реквеста из GitHub.

**Параметры**:

*   `github` (Github): Объект для взаимодействия с GitHub API.

**Возвращает**:

*   `PullRequest`: Объект, представляющий pull-реквест.

**Как работает функция**:

1.  Читает номер pull-реквеста из файла `./pr_number`.
2.  Использует библиотеку `github` для получения информации о pull-реквесте.

### `get_diff`

```python
def get_diff(diff_url: str) -> str:
```

**Назначение**: Получает diff pull-реквеста по заданному URL-адресу.

**Параметры**:

*   `diff_url` (str): URL-адрес diff pull-реквеста.

**Возвращает**:

*   `str`: Diff pull-реквеста.

**Как работает функция**:

1.  Выполняет GET-запрос к указанному URL.
2.  Возвращает текст ответа, представляющий собой diff.

### `read_json`

```python
def read_json(text: str) -> dict:
```

**Назначение**: Разбирает блок кода JSON из строки.

**Параметры**:

*   `text` (str): Строка, содержащая блок кода JSON.

**Возвращает**:

*   `dict`: Словарь, полученный из JSON.

**Вызывает исключения**:

*   `RuntimeError`: Если JSON недействителен.

**Как работает функция**:

1.  Ищет блок кода JSON в строке.
2.  Извлекает текст JSON из блока.
3.  Преобразует текст JSON в словарь.

### `read_text`

```python
def read_text(text: str) -> str:
```

**Назначение**: Извлекает текст из блока кода Markdown.

**Параметры**:

*   `text` (str): Строка, содержащая блок кода Markdown.

**Возвращает**:

*   `str`: Извлеченный текст.

**Вызывает исключения**:

*   `RuntimeError`: Если Markdown недействителен.

**Как работает функция**:

1.  Ищет блок кода Markdown в строке.
2.  Извлекает текст из блока.

### `get_ai_response`

```python
def get_ai_response(prompt: str, as_json: bool = True) -> Union[dict, str]:
```

**Назначение**: Получает ответ от g4f API на основе промпта.

**Параметры**:

*   `prompt` (str): Промпт для отправки в g4f.
*   `as_json` (bool, optional): Следует ли анализировать ответ как JSON. Defaults to `True`.

**Возвращает**:

*   `Union[dict, str]`: Ответ от g4f, либо как словарь (если `as_json=True`), либо как строка.

**Как работает функция**:

1.  Отправляет запрос к g4f API с указанным промптом.
2.  Разбирает ответ как JSON или извлекает текст, используя функции `read_json` или `read_text`.

### `analyze_code`

```python
def analyze_code(pull: PullRequest, diff: str)-> list[dict]:
```

**Назначение**: Анализирует изменения кода в pull-реквесте.

**Параметры**:

*   `pull` (PullRequest): Объект pull-реквеста.
*   `diff` (str): Diff pull-реквеста.

**Возвращает**:

*   `list[dict]`: Список комментариев, сгенерированных анализом.

**Как работает функция**:

1.  Итерируется по строкам diff.
2.  Определяет измененные строки кода.
3.  Формирует промпт для анализа измененных строк.
4.  Получает ответ от g4f API.
5.  Извлекает комментарии из ответа.
6.  Возвращает список комментариев.

### `create_analyze_prompt`

```python
def create_analyze_prompt(changed_lines: list[str], pull: PullRequest, file_path: str):
```

**Назначение**: Создает промпт для модели g4f.

**Параметры**:

*   `changed_lines` (list[str]): Список измененных строк кода.
*   `pull` (PullRequest): Объект pull-реквеста.
*   `file_path` (str): Путь к файлу, который анализируется.

**Возвращает**:

*   `str`: Сгенерированный промпт.

**Как работает функция**:

1.  Формирует промпт, включающий инструкции для анализа кода, название файла, заголовок и описание pull-реквеста, а также измененные строки кода.

### `create_review_prompt`

```python
def create_review_prompt(pull: PullRequest, diff: str):
```

**Назначение**: Создает промпт для создания комментария к ревью.

**Параметры**:

*   `pull` (PullRequest): Объект pull-реквеста.
*   `diff` (str): Diff pull-реквеста.

**Возвращает**:

*   `str`: Сгенерированный промпт для ревью.

**Как работает функция**:

1.  Формирует промпт, включающий инструкции для создания комментария, имя автора pull-реквеста, заголовок и описание pull-реквеста, а также diff.

### `main`

```python
def main():
```

**Назначение**: Основная функция для запуска анализа pull-реквеста.

**Как работает функция**:

1.  Инициализирует соединение с GitHub API.
2.  Получает детали pull-реквеста, используя функцию `get_pr_details`.
3.  Получает diff pull-реквеста, используя функцию `get_diff`.
4.  Создает промпт для ревью pull-реквеста, используя функцию `create_review_prompt`.
5.  Получает ответ от AI, используя функцию `get_ai_response`.
6.  Создает комментарии к pull-реквесту, используя полученный ответ.