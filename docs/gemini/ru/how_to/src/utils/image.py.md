## Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Этот модуль предоставляет асинхронные функции для загрузки, сохранения и манипулирования изображениями. Он включает в себя функциональность, такую как сохранение изображений из URL-адресов, сохранение данных изображения в файлы, получение данных изображения, поиск случайных изображений в каталогах, добавление водяных знаков, изменение размера и преобразование форматов изображений. 

Шаги выполнения
-------------------------
1. **Импорт необходимых модулей**: 
    - `aiohttp`: для асинхронной загрузки изображений по URL.
    - `aiofiles`: для асинхронного сохранения изображений в файлы.
    - `asyncio`: для работы с асинхронными функциями.
    - `random`: для выбора случайных изображений.
    - `pathlib`: для работы с путями к файлам.
    - `PIL`: для обработки изображений (изменение размера, добавление водяных знаков).
    - `src.logger.logger`: для записи логов.
2. **Определение класса `ImageError`**: 
    - Создается кастомный класс исключения `ImageError`, который используется для обработки ошибок, связанных с изображениями.
3. **Асинхронная загрузка и сохранение изображения из URL**:
    - Функция `save_image_from_url_async` асинхронно загружает изображение по URL-адресу и сохраняет его локально.
    - Она использует `aiohttp.ClientSession` для выполнения запросов, `response.raise_for_status()` для проверки статуса ответа, `response.read()` для получения данных изображения.
    - В случае ошибки загрузки, записывает ее в лог.
4. **Сохранение данных изображения в файл**: 
    - Функция `save_image` сохраняет данные изображения в файл в указанном формате.
    - Она использует `BytesIO` для временного хранения данных изображения, `Image.open` для открытия изображения, `img.save` для сохранения изображения, `file.write` для записи данных в файл.
    - Проверяет, был ли файл создан, и не равен ли его размер 0 байт.
5. **Асинхронное сохранение данных изображения в файл**:
    - Функция `save_image_async` асинхронно сохраняет данные изображения в файл в указанном формате.
    - Она использует `asyncio.to_thread` для вызова синхронных функций в асинхронной среде, `aiofiles.open` для асинхронного открытия файла, `file.write` для асинхронной записи данных в файл.
    - Проверяет, был ли файл создан, и не равен ли его размер 0 байт.
6. **Получение данных изображения в JPEG формате**: 
    - Функция `get_image_bytes` считывает изображение с помощью `Pillow` и возвращает его данные в JPEG формате.
    - Она использует `Image.open` для открытия изображения, `img.save` для сохранения изображения в `BytesIO`,  `img_byte_arr.getvalue` для получения данных изображения в байтах.
7. **Получение сырых данных файла**: 
    - Функция `get_raw_image_data` считывает сырые данные файла, если он существует.
    - Она использует `Path.exists` для проверки существования файла, `Path.read_bytes` для чтения данных файла.
8. **Поиск случайного изображения в директории**: 
    - Функция `random_image` рекурсивно ищет случайное изображение в указанном каталоге.
    - Она использует `Path.rglob` для рекурсивного поиска файлов, `file_path.suffix.lower` для проверки расширения файла, `random.choice` для выбора случайного файла.
9. **Добавление текстового водяного знака**:
    - Функция `add_text_watermark` добавляет текстовый водяной знак к изображению.
    - Она использует `Image.open` для открытия изображения, `ImageDraw.Draw` для рисования текста на прозрачном слое, `ImageFont.truetype` для создания шрифта, `Image.alpha_composite` для объединения изображения и водяного знака.
10. **Добавление водяного знака с изображением**:
    - Функция `add_image_watermark` добавляет изображение в качестве водяного знака к другому изображению.
    - Она использует `Image.open` для открытия изображений, `Image.resize` для изменения размера водяного знака, `Image.paste` для размещения водяного знака на изображении, `transparent.save` для сохранения результата.
11. **Изменение размера изображения**:
    - Функция `resize_image` изменяет размер изображения до заданных размеров.
    - Она использует `Image.resize` для изменения размера изображения, `img.save` для сохранения результата.
12. **Преобразование формата изображения**:
    - Функция `convert_image` преобразует изображение в заданный формат.
    - Она использует `Image.open` для открытия изображения, `img.save` для сохранения изображения в новом формате.
13. **Обработка изображений с водяным знаком**:
    - Функция `process_images_with_watermark` обрабатывает все изображения в указанной папке путем добавления водяного знака и сохранения их в папку "output".
    - Она использует `Path.iterdir` для итерации по файлам в папке, `add_image_watermark` для добавления водяного знака к каждому изображению.

Пример использования
-------------------------

```python
from src.utils.image import save_image_from_url_async, process_images_with_watermark
from pathlib import Path

async def main():
    image_url = "https://example.com/image.jpg"
    filename = "downloaded_image.jpg"
    await save_image_from_url_async(image_url, filename)

    folder_path = Path("./images")
    watermark_path = Path("./watermark.png")
    process_images_with_watermark(folder_path, watermark_path)

if __name__ == "__main__":
    asyncio.run(main())
```

В этом примере кода:
- `save_image_from_url_async` асинхронно загружает изображение с URL-адреса `image_url` и сохраняет его как `filename`.
- `process_images_with_watermark` обрабатывает все изображения в папке `folder_path`, добавляя водяной знак из `watermark_path` и сохраняя их в папку "output" внутри `folder_path`.