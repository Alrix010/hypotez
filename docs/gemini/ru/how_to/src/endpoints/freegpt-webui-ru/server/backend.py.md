## Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Этот блок кода реализует backend-API для обработки запросов к модели ChatGPT, 
предоставляя возможность пользователям вводить текст и получать ответы от модели. 
API использует библиотеку g4f для взаимодействия с ChatGPT, 
а также предоставляет функции для создания системных сообщений, 
добавления контекста из поисковой выдачи (при необходимости) 
и обработки специальных инструкций, 
например, jailbreak-инструкций для модели. 
В коде реализована обработка ошибок и потоковое возвращение ответов.

Шаги выполнения
-------------------------
1. **Инициализация**:
    - Класс `Backend_Api` инициализируется с помощью ссылки на Flask-приложение (`app`) и конфигурационным объектом (`config`), содержащим настройки для использования прокси.
    - Инициализируется словарь `routes`, который сопоставляет URL-адреса с функциями API.
    - Если в конфигурации включено использование автоматических прокси, запускается отдельный поток для обновления списка работающих прокси.

2. **Обработка запросов**:
    - Функция `_conversation()` обрабатывает запросы к API по URL `/backend-api/v2/conversation`.
    - Извлекает параметры из запроса, такие как:
        - `stream` (флаг потоковой передачи)
        - `jailbreak` (тип jailbreak-инструкции)
        - `model` (имя модели ChatGPT)
        - `messages` (история диалога)
    - Вызывает функцию `build_messages()` для создания списка сообщений, необходимых для отправки в API ChatGPT.
    - Создает объект `ChatCompletion` и использует его для отправки запроса к модели ChatGPT.
    - Возвращает ответ в формате потока событий (Server-Sent Events), используя функцию `generate_stream()`, чтобы обеспечить непрерывный показ ответа пользователю.

3. **Создание списка сообщений**:
    - Функция `build_messages()` создает список сообщений для отправки в API ChatGPT, используя параметры из запроса.
    - В список сообщений включаются:
        - **Системное сообщение**: Содержит информацию о модели, инструкции для модели и текущую дату.
        - **История диалога**: Содержит предыдущие сообщения пользователя и ответы модели.
        - **Результаты поиска**: Если разрешен доступ к интернету, добавляются результаты поиска по запросу.
        - **Jailbreak-инструкции**: Если выбраны jailbreak-инструкции, они добавляются в список.
        - **Текущий запрос**: Текст запроса пользователя.
    - Список сообщений ограничивается 13 последними элементами для предотвращения ошибок из-за ограничения количества токенов API.

4. **Извлечение результатов поиска**:
    - Функция `fetch_search_results()` отправляет запрос к API поиска DuckDuckGo для получения результатов по заданному запросу.
    - Возвращает список сообщений с результатами поиска в формате, понятном для модели ChatGPT.

5. **Генерация потока ответов**:
    - Функция `generate_stream()` обрабатывает ответ от модели ChatGPT и преобразует его в формат потока событий.
    - Если выбраны jailbreak-инструкции, функция проверяет ответ на наличие специальных маркеров, обозначающих успешное выполнение jailbreak-инструкций.
    - Возвращает поток ответов, который может обрабатываться фронтэндом для отображения ответа пользователю.

6. **Обработка ошибок**:
    - В случае возникновения ошибки в процессе обработки запроса, функция `_conversation()` выводит сообщение об ошибке в консоль и возвращает пользователю сообщение об ошибке.

7. **Дополнительные функции**:
    - Функции `response_jailbroken_success()`, `response_jailbroken_failed()`, `set_response_language()` и `isJailbreak()` обеспечивают дополнительные проверки и настройки для обработки различных сценариев взаимодействия с моделью ChatGPT.

Пример использования
-------------------------

```python
from flask import Flask
from server.backend import Backend_Api

app = Flask(__name__)

# Конфигурация backend API
config = {
    'use_auto_proxy': True
}

# Создание объекта backend API
backend_api = Backend_Api(app, config)

# Добавление маршрутов API
for url, route_config in backend_api.routes.items():
    app.add_url_rule(url, view_func=route_config['function'], methods=route_config['methods'])

# Запуск приложения
if __name__ == '__main__':
    app.run(debug=True)
```

В этом примере кода backend API инициализируется и добавляется к Flask-приложению. 
Затем приложение запускается в режиме отладки. 
Пользователи могут отправлять запросы к API по URL `/backend-api/v2/conversation`, используя HTTP-метод POST. 
Запросы обрабатываются функцией `_conversation()` и возвращают ответ в формате потока событий.