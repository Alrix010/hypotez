### Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Этот код определяет класс `CreateImagesProvider`, который расширяет возможности другого провайдера, позволяя создавать изображения на основе текстовых запросов, встроенных в сообщения. Он использует теги `<img data-prompt="текст запроса">` для указания запросов на создание изображений.  Класс поддерживает как синхронное, так и асинхронное создание изображений.

Шаги выполнения
-------------------------
1.  **Инициализация `CreateImagesProvider`**: При создании экземпляра `CreateImagesProvider` необходимо передать:
    *   `provider`:  Провайдер, который будет использоваться для обработки обычных текстовых сообщений.
    *   `create_images`: Функция для синхронного создания изображений на основе текстового запроса.
    *   `create_async`: Функция для асинхронного создания изображений на основе текстового запроса.
    *   `system_message`:  Системное сообщение, которое объясняет возможности генерации изображений.  По умолчанию используется предопределенное сообщение.
    *   `include_placeholder`:  Флаг, указывающий, нужно ли включать placeholder изображения в вывод.

2.  **Метод `create_completion`**: Этот метод обрабатывает сообщения, ища в них теги `<img data-prompt="текст запроса">`.  Если такой тег найден,  извлекается текст запроса и вызывается функция `create_images` для создания изображения. Результат вставляется в исходное сообщение. Метод работает как генератор, выдавая чанки обработанного текста и изображений.
    *   Сообщение добавляется в начало списка сообщений.
    *   Идет итерация по чанкам, полученным от основного провайдера (`self.provider`).
    *   Если чанк является экземпляром `ImageResponse`, он сразу выдается.
    *   Если в чанке обнаружен тег `<img data-prompt="текст запроса">`:
        *   Извлекается текст запроса (prompt) из тега.
        *   Вызывается функция `self.create_images(prompt)` для создания изображения.
        *   Результат генерации изображения выдается в поток.

3.  **Метод `create_async`**: Этот метод выполняет аналогичные действия, что и `create_completion`, но в асинхронном режиме. Он использует функцию `create_images_async` для асинхронного создания изображений и возвращает строку с обработанным ответом, включающим сгенерированные изображения.
    *   В начало списка сообщений добавляется системное сообщение.
    *   Вызывается асинхронный метод `create_async` базового провайдера.
    *   В полученном ответе ищутся все теги `<img data-prompt="текст запроса">`.
    *   Для каждого найденного тега вызывается функция `self.create_images_async(prompt)` для асинхронного создания изображения.
    *   Все асинхронные задачи собираются и выполняются параллельно с использованием `asyncio.gather`.
    *   В исходный ответ подставляются сгенерированные изображения вместо соответствующих placeholder-ов.

Пример использования
-------------------------

```python
    import asyncio

    from .mock_provider import MockProvider  # Предполагается, что есть мок-провайдер для тестов
    from ..providers.response import ImageResponse
    
    async def mock_create_images_async(prompt: str) -> str:
        """
        Мок функция для асинхронного создания изображений.
        """
        return f"Async Image: {prompt}"
    
    def mock_create_images(prompt: str):
        """
        Мок функция для синхронного создания изображений.
        """
        yield ImageResponse(data=f"Image: {prompt}", provider="MockProvider")
    
    # Создаем экземпляр мок-провайдера
    mock_provider = MockProvider()
    
    # Создаем экземпляр CreateImagesProvider с мок-функциями создания изображений
    image_provider = CreateImagesProvider(
        provider=mock_provider,
        create_images=mock_create_images,
        create_async=mock_create_images_async
    )
    
    async def main():
        # Пример сообщения с запросом на создание изображения
        messages = [{"role": "user", "content": "Создай изображение: <img data-prompt='закат на море'>.  Еще немного текста."}]
    
        # Асинхронно создаем ответ
        response = await image_provider.create_async(model="test_model", messages=messages)
        print(response)
    
    if __name__ == "__main__":
        asyncio.run(main())