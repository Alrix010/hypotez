### **Как использовать этот блок кода**

=========================================================================================

Описание
-------------------------
Этот код представляет собой реализацию асинхронного взаимодействия с API Google Gemini для генерации контента. Он поддерживает как потоковую, так и не потоковую генерацию текста, а также обработку изображений и инструментов (tools) для расширения функциональности модели.

Шаги выполнения
-------------------------
1. **Подготовка запроса**:
   - Проверяется наличие `api_key`. Если ключ отсутствует, выбрасывается исключение `MissingAuthError`.
   - Определяется, использовать ли заголовок авторизации (`use_auth_header`) или параметры запроса для передачи `api_key`.
   - Формируется URL для запроса в зависимости от выбранного режима (`stream` или не `stream`).

2. **Формирование данных запроса**:
   - Преобразуются сообщения из списка `messages` в формат, ожидаемый API Gemini.
   - Добавляются данные об изображениях из списка `media`, если они предоставлены. Изображения кодируются в base64.
   - Формируется структура данных `data`, включающая сообщения, конфигурацию генерации (температура, максимальное количество токенов и т.д.) и инструменты (tools), если они предоставлены.
   - Если присутствует системное сообщение, оно добавляется в структуру данных.

3. **Отправка запроса и обработка ответа**:
   - Отправляется асинхронный POST-запрос к API Gemini с использованием `ClientSession`.
   - Обрабатывается ответ в зависимости от режима (`stream` или не `stream`):
     - **Stream**: Ответ обрабатывается по частям (chunks). Каждая часть преобразуется в JSON, извлекается текст и возвращается как часть генератора. Также извлекаются и возвращаются причина завершения (`finishReason`) и информация об использовании токенов (`Usage`).
     - **Non-stream**: Полученный JSON-ответ анализируется, извлекается текст или причина завершения и возвращается.

Пример использования
-------------------------

```python
from src.endpoints.gpt4free.g4f.Provider.needs_auth import GeminiPro
from src.logger.logger import logger
import asyncio

async def main():
    try:
        # Укажите ваш API-ключ Google Gemini
        api_key = "YOUR_API_KEY"
        
        # Определите список сообщений для отправки
        messages = [
            {"role": "user", "content": "Напиши короткое стихотворение о весне."},
        ]

        # Вызовите асинхронный генератор для получения ответа
        async for response_chunk in GeminiPro.create_async_generator(
            model="gemini-1.5-pro",
            messages=messages,
            stream=True,
            api_key=api_key
        ):
            # Обработайте каждую часть ответа
            logger.info(response_chunk)
            
    except Exception as e:
        logger.error(f"Произошла ошибка: {e}")

if __name__ == "__main__":
    asyncio.run(main())