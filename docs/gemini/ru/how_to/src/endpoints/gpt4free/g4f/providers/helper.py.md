## Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Блок кода содержит набор вспомогательных функций для работы с  `Messages`  (списка словарей, представляющих сообщения в чате),  `Cookies`  (словаря с куки-файлами),  `AsyncIterator`  (асинхронного итератора) и  `Iterator`  (итератора).

Шаги выполнения
-------------------------
1. **Функция `to_string(value)`**: Преобразует различные типы данных в строку. Принимает значение любого типа (`value`) и возвращает строковое представление (`str`).
   - Если `value` - строка, возвращает ее неизменной.
   - Если `value` - словарь:
     - Проверяет, есть ли ключ `"name"`  или `"bucket_id"`. Если есть, извлекает соответствующую информацию и возвращает строку.
     - Если ключ `"type"`  равен `"text"`, возвращает значение по ключу `"text"`.
     - В остальных случаях возвращает пустую строку.
   - Если `value` - список, рекурсивно применяет функцию `to_string`  к каждому элементу списка и объединяет полученные строки.
   - В остальных случаях преобразует значение в строку с помощью `str(value)`.
2. **Функция `format_prompt(messages, add_special_tokens, do_continue, include_system)`**: Форматирует список сообщений в строку, опционально добавляя специальные токены.
   - Принимает список словарей `messages`, где каждый словарь содержит `role` (роль отправителя) и `content` (содержимое сообщения).
   - Опционально принимает `add_special_tokens` (флаг добавления специальных токенов), `do_continue` (флаг продолжения вывода) и `include_system` (флаг включения системных сообщений).
   - Если `add_special_tokens`  равен `False` и в списке только одно сообщение, возвращает строковое представление содержания первого сообщения.
   - Преобразует список `messages`  в список пар `(role, content)`, где `content`  преобразован в строку с помощью функции `to_string`.
   - Объединяет пары `(role, content)`  в строку, добавляя в начало каждой строки `role.capitalize() + ": "`  и `content`.
   - Если `do_continue`  равен `True`, возвращает полученную строку.
   - В остальных случаях добавляет в конец строки `"Assistant:"`  и возвращает результат.
3. **Функция `get_system_prompt(messages)`**: Возвращает строку, составленную из содержимого системных сообщений.
   - Принимает список сообщений `messages`.
   - Извлекает из `messages`  сообщения с `role`  равным `"system"`  и объединяет их содержимое в строку, разделяя элементы символом перевода строки (`"\n"`).
4. **Функция `get_last_user_message(messages)`**: Возвращает строку, составленную из содержимого последних сообщений от пользователя.
   - Принимает список сообщений `messages`.
   - Итерирует по списку `messages`  в обратном порядке.
   - Если текущее сообщение имеет `role`  равный `"user"`, добавляет его содержимое в список `user_messages`.
   - Если текущее сообщение имеет `role`  не равный `"user"`, возвращает строку, составленную из элементов списка `user_messages`, объединенных символом перевода строки (`"\n"`).
   - Возвращает строку, составленную из элементов списка `user_messages`, объединенных символом перевода строки (`"\n"`).
5. **Функция `format_image_prompt(messages, prompt)`**: Форматирует строку подсказки для изображения.
   - Принимает список сообщений `messages`  и опционально строку подсказки `prompt`.
   - Если `prompt`  равен `None`, использует функцию `get_last_user_message`  для извлечения последнего сообщения от пользователя и возвращает его.
   - В остальных случаях возвращает `prompt`.
6. **Функция `format_prompt_max_length(messages, max_lenght)`**:  Форматирует подсказку для модели, ограничивая ее максимальную длину.
   - Принимает список сообщений `messages`  и максимальную длину подсказки `max_lenght`.
   - Форматирует подсказку с помощью `format_prompt(messages)`.
   - Если длина подсказки превышает `max_lenght`:
     - Если в `messages`  более 6 элементов, сокращает список до первых 3 и последних 3 элементов.
     - Если длина подсказки все еще превышает `max_lenght`, сокращает список до системных сообщений и последнего сообщения от пользователя.
     - Если длина подсказки все еще превышает `max_lenght`, использует только содержимое последнего сообщения от пользователя.
   - Записывает в лог информацию о сокращении подсказки.
   - Возвращает отформатированную подсказку.
7. **Функция `get_random_string(length)`**: Генерация случайной строки.
    - Принимает целое число `length`, которое задает желаемую длину строки.
    - Возвращает строку, состоящую из `length`  случайных символов - строчных латинских букв и цифр.
8. **Функция `get_random_hex(length)`**:  Генерирует случайную шестнадцатеричную строку заданной длины.
    - Принимает целое число `length` (по умолчанию 32).
    - Возвращает строку, состоящую из `length`  случайных символов (hex-кодов от a до f и цифр).
9. **Функция `filter_none(**kwargs**)**: Фильтрует словарь, удаляя пары ключ-значение, где значение равно `None`.
    - Принимает словарь `kwargs`.
    - Возвращает новый словарь, содержащий только пары ключ-значение, где значение не равно `None`.
10. **Асинхронная функция `async_concat_chunks(chunks)`**: Объединяет асинхронные куски данных в одну строку.
    - Принимает асинхронный итератор `chunks`.
    - Вызывает функцию `concat_chunks`  для объединения асинхронных кусков в одну строку.
11. **Функция `concat_chunks(chunks)`**: Объединяет куски данных в одну строку.
    - Принимает итератор `chunks`.
    - Объединяет все элементы `chunks`  в одну строку, игнорируя значения, равные `None`  или являющиеся исключениями.
12. **Функция `format_cookies(cookies)`**:  Форматирует куки-файлы в строку.
    - Принимает словарь `cookies`, где ключи - имена куки, а значения - их значения.
    - Возвращает строку, где все куки-файлы разделены точкой с запятой и пробелом (`"; "`), а имя и значение куки-файла разделены знаком равенства (`"="`).


Пример использования
-------------------------

```python
from src.endpoints.gpt4free.g4f.providers.helper import format_prompt, to_string, format_cookies

messages = [
    {"role": "user", "content": "Привет!"},
    {"role": "assistant", "content": "Привет! Как дела?"},
]

# Форматирование подсказки с использованием специальных токенов
prompt = format_prompt(messages, add_special_tokens=True)
print(f"Prompt: {prompt}")

# Преобразование словаря в строку
data = {"name": "Alice", "age": 30}
string_data = to_string(data)
print(f"String data: {string_data}")

# Форматирование куки-файлов
cookies = {"session_id": "1234567890", "user_id": "9876543210"}
formatted_cookies = format_cookies(cookies)
print(f"Formatted cookies: {formatted_cookies}")
```