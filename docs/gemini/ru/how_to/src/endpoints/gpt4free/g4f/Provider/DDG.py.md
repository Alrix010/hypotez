### Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Этот код реализует асинхронный Provider для взаимодействия с DuckDuckGo AI Chat. Он включает в себя методы для получения токенов, выполнения запросов к API, обработки ответов и управления куками и историей сообщений в рамках диалога.

Шаги выполнения
-------------------------
1. **Определение класса `DDG`**: Класс `DDG` наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin` и представляет собой провайдер для DuckDuckGo AI Chat. В классе определены основные атрибуты, такие как URL, API endpoint, поддерживаемые модели и флаги поддержки различных функций (стриминг, системные сообщения, история сообщений).
2. **Инициализация**:
   - Установка статических параметров, таких как `label`, `url`, `api_endpoint`, `status_url`, `working`, `supports_stream`, `supports_system_message`, `supports_message_history`, `default_model`, `models`, `model_aliases`, `last_request_time`, `max_retries`, `base_delay`, `_chat_xfe`.
3. **`sha256_base64(text: str) -> str`**:
   - Вычисляет SHA256 хеш от входного текста в кодировке UTF-8.
   - Кодирует полученный хеш в Base64.
   - Возвращает закодированную строку.
4. **`parse_dom_fingerprint(js_text: str) -> str`**:
   - Извлекает и обрабатывает HTML-фрагмент из JavaScript кода для получения "отпечатка" DOM.
   - Если `BeautifulSoup` недоступен, возвращает значение по умолчанию "1000".
   - Выделяет HTML-фрагмент и значение смещения из JavaScript.
   - Парсит HTML с использованием `BeautifulSoup` и вычисляет длину содержимого тега `body`.
   - Вычисляет и возвращает "отпечаток" как сумму значения смещения и длины HTML.
   - В случае ошибки возвращает "1000".
5. **`parse_server_hashes(js_text: str) -> list`**:
   - Извлекает список хешей сервера из JavaScript кода.
   - Если не удается извлечь хеши, возвращает список по умолчанию `["1", "2"]`.
6. **`build_x_vqd_hash_1(cls, vqd_hash_1: str, headers: dict) -> str`**:
   - Строит заголовок `x-vqd-hash-1` на основе предоставленного хеша и заголовков запроса.
   - Декодирует `vqd_hash_1` из Base64.
   - Извлекает хеши сервера и "отпечаток" DOM.
   - Вычисляет хеши User-Agent и DOM.
   - Формирует JSON структуру с хешами сервера, клиента и сигналами.
   - Кодирует JSON в Base64 и возвращает результат.
   - В случае ошибки возвращает пустую строку.
7. **`validate_model(cls, model: str) -> str`**:
   - Проверяет и возвращает корректное имя модели.
   - Если модель не указана, возвращает модель по умолчанию.
   - Если модель есть в `model_aliases`, заменяет её на алиас.
   - Проверяет, есть ли модель в списке поддерживаемых. Если нет, выбрасывает исключение `ModelNotSupportedError`.
8. **`sleep(cls, multiplier=1.0)`**:
   - Реализует ограничение скорости между запросами.
   - Вычисляет задержку на основе времени предыдущего запроса и множителя.
   - Засыпает на вычисленное время, если задержка больше нуля.
9. **`get_default_cookies(cls, session: ClientSession) -> dict`**:
   - Получает куки, необходимые для запросов к API.
   - Отправляет начальный запрос к `cls.url` для получения куки.
   - Устанавливает куки `dcs` и `dcm`.
   - Обновляет `session.cookie_jar` с полученными куки.
10. **`fetch_fe_version(cls, session: ClientSession) -> str`**:
   - Получает `fe-version` с начальной страницы.
   - Если `cls._chat_xfe` уже установлено, возвращает его.
   - Отправляет запрос к URL и извлекает значения `xfe1` и `xfe2` из содержимого.
   - Формирует `cls._chat_xfe` как `{xfe1}-{xfe2}` и возвращает его.
   - В случае ошибки возвращает пустую строку.
11. **`fetch_vqd_and_hash(cls, session: ClientSession, retry_count: int = 0) -> tuple[str, str]`**:
    - Получает токены `VQD` и `hash` для сессии чата с повторными попытками.
    - Определяет заголовки запроса, включая `User-Agent`, `origin`, `referer` и `x-vqd-accept`.
    - Если куки отсутствуют, вызывает `cls.get_default_cookies(session)`.
    - Отправляет GET-запрос к `cls.status_url` с установленными заголовками.
    - Извлекает значения `x-vqd-4` и `x-vqd-hash-1` из заголовков ответа.
    - Если `vqd` получен, возвращает `vqd` и `vqd_hash_1`.
    - В случае неудачи повторяет попытки (`retry_count` увеличивается до `cls.max_retries`).
12. **`create_async_generator(...) -> AsyncResult`**:
    - Создает асинхронный генератор для взаимодействия с DuckDuckGo AI Chat.
    - Проверяет и устанавливает модель с помощью `cls.validate_model(model)`.
    - Инициализирует сессию с `ClientSession` и обрабатывает повторные попытки.
    - Если `cls._chat_xfe` не установлено, получает его с помощью `cls.fetch_fe_version(session)`.
    - Инициализирует или обновляет `conversation`. Если `conversation` отсутствует, создает новый объект `Conversation`, получает `VQD` и `vqd_hash_1` с помощью `cls.fetch_vqd_and_hash(session)`, и обновляет историю сообщений. Если `conversation` существует, обновляет историю сообщений новым сообщением пользователя.
    - Подготавливает заголовки запроса, включая `x-fe-version`, `x-vqd-4` и `x-vqd-hash-1`.
    - Подготавливает данные запроса, включая модель и историю сообщений.
    - Отправляет POST-запрос к `cls.api_endpoint` с заголовками и данными.
    - Обрабатывает ответы, включая ошибки 429 (ограничение скорости).
    - Обрабатывает потоковый ответ, извлекая и возвращая сообщения.
    - Обновляет `conversation` информацией об ответе и возвращает `conversation`, если `return_conversation` имеет значение `True`.

Пример использования
-------------------------

```python
from hypotez.src.endpoints.gpt4free.g4f.Provider.DDG import DDG
import asyncio

async def main():
    # Пример использования create_async_generator
    model = "gpt-4o-mini"
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    
    async for response in DDG.create_async_generator(model=model, messages=messages):
        print(response)

if __name__ == "__main__":
    asyncio.run(main())