### **Как использовать этот блок кода**
=========================================================================================

Описание
-------------------------
Этот блок кода предназначен для загрузки, форматирования, чтения и сохранения информации о моделях, используемых в проекте. Он включает функции для получения списка моделей с внешнего ресурса, извлечения имени модели из имени файла, форматирования данных о моделях, чтения и сохранения этих данных в файл, а также для управления каталогом моделей.

Шаги выполнения
-------------------------
1. **`load_models()`**:
   - Функция отправляет HTTP-запрос GET к URL "https://gpt4all.io/models/models3.json" для получения списка моделей.
   - `raise_for_status(response)` проверяет, успешен ли HTTP-запрос (код 200). Если запрос не успешен (например, код 404 или 500), вызывается исключение.
   - Функция вызывает `format_models(response.json())` для форматирования полученных данных JSON.
   - Возвращает отформатированный словарь моделей.

2. **`get_model_name(filename: str) -> str`**:
   - Функция принимает имя файла модели в качестве аргумента.
   - Извлекает имя модели из имени файла, удаляя суффиксы, такие как "-v1_5", "-v1", "-q4_0", "_v01", "-v0", "-f16", "-gguf2", "-newbpe".
   - Возвращает очищенное имя модели.

3. **`format_models(models: list) -> dict`**:
   - Функция принимает список моделей (словарей) в качестве аргумента.
   - Преобразует список моделей в словарь, где ключом является имя модели (полученное с помощью `get_model_name`), а значением - словарь с информацией о модели, такой как путь к файлу, требуемый объем оперативной памяти, шаблон промпта и системный промпт.
   - Возвращает отформатированный словарь моделей.

4. **`read_models(file_path: str)`**:
   - Функция принимает путь к файлу в качестве аргумента.
   - Открывает файл в режиме чтения байтов ("rb").
   - Загружает данные JSON из файла и возвращает их.

5. **`save_models(file_path: str, data)`**:
   - Функция принимает путь к файлу и данные для сохранения в качестве аргументов.
   - Открывает файл в режиме записи ("w").
   - Записывает данные в файл в формате JSON с отступами для удобочитаемости.

6. **`get_model_dir() -> str`**:
   - Функция определяет путь к каталогу моделей.
   - Определяет локальный каталог (где находится текущий файл).
   - Определяет корневой каталог проекта (родительский каталог локального каталога).
   - Объединяет корневой каталог проекта с "models" для получения пути к каталогу моделей.
   - Если каталог моделей не существует, он создается.
   - Возвращает путь к каталогу моделей.

7. **`get_models() -> dict[str, dict]`**:
   - Функция определяет каталог моделей с помощью `get_model_dir()`.
   - Формирует путь к файлу "models.json" в каталоге моделей.
   - Проверяет, существует ли файл "models.json".
   - Если файл существует, функция вызывает `read_models(file_path)` для чтения данных из файла и возвращает их.
   - Если файл не существует, функция вызывает `load_models()` для загрузки моделей, `save_models(file_path, models)` для сохранения моделей в файл и возвращает загруженные модели.

Пример использования
-------------------------

```python
import os
import json
import requests

from ..requests.raise_for_status import raise_for_status

def load_models():
    """
    Функция отправляет HTTP-запрос GET к URL "https://gpt4all.io/models/models3.json" для получения списка моделей.

    Функция вызывает `raise_for_status(response)` для проверки, успешен ли HTTP-запрос (код 200).
    Если запрос не успешен (например, код 404 или 500), вызывается исключение.

    Функция вызывает `format_models(response.json())` для форматирования полученных данных JSON.
    Функция возвращает отформатированный словарь моделей.
    """
    response = requests.get("https://gpt4all.io/models/models3.json")
    raise_for_status(response)
    return format_models(response.json())

def get_model_name(filename: str) -> str:
    """
    Функция принимает имя файла модели в качестве аргумента.
    Функция извлекает имя модели из имени файла, удаляя суффиксы, такие как "-v1_5", "-v1", "-q4_0", "_v01", "-v0", "-f16", "-gguf2", "-newbpe".
    Функция возвращает очищенное имя модели.
    """
    name = filename.split(".", 1)[0]
    for replace in ["-v1_5", "-v1", "-q4_0", "_v01", "-v0", "-f16", "-gguf2", "-newbpe"]:
        name = name.replace(replace, "")
    return name

def format_models(models: list) -> dict:
    """
    Функция принимает список моделей (словарей) в качестве аргумента.
    Функция преобразует список моделей в словарь, где ключом является имя модели (полученное с помощью `get_model_name`),
    а значением - словарь с информацией о модели, такой как путь к файлу, требуемый объем оперативной памяти,
    шаблон промпта и системный промпт.
    Функция возвращает отформатированный словарь моделей.
    """
    return {get_model_name(model["filename"]): {
        "path": model["filename"],
        "ram": model["ramrequired"],
        "prompt": model["promptTemplate"] if "promptTemplate" in model else None,
        "system": model["systemPrompt"] if "systemPrompt" in model else None,
    } for model in models}

def read_models(file_path: str):
    """
    Функция принимает путь к файлу в качестве аргумента.
    Функция открывает файл в режиме чтения байтов ("rb").
    Функция загружает данные JSON из файла и возвращает их.
    """
    with open(file_path, "rb") as f:
         return json.load(f)

def save_models(file_path: str, data):
    """
    Функция принимает путь к файлу и данные для сохранения в качестве аргументов.
    Функция открывает файл в режиме записи ("w").
    Функция записывает данные в файл в формате JSON с отступами для удобочитаемости.
    """
    with open(file_path, 'w') as f:
        json.dump(data, f, indent=4)

def get_model_dir() -> str:
    """
    Функция определяет путь к каталогу моделей.
    Функция определяет локальный каталог (где находится текущий файл).
    Функция определяет корневой каталог проекта (родительский каталог локального каталога).
    Функция объединяет корневой каталог проекта с "models" для получения пути к каталогу моделей.
    Если каталог моделей не существует, он создается.
    Функция возвращает путь к каталогу моделей.
    """
    local_dir = os.path.dirname(os.path.abspath(__file__))
    project_dir = os.path.dirname(os.path.dirname(local_dir))
    model_dir = os.path.join(project_dir, "models")
    if not os.path.exists(model_dir):
        os.mkdir(model_dir)
    return model_dir

def get_models() -> dict[str, dict]:
    """
    Функция определяет каталог моделей с помощью `get_model_dir()`.
    Функция формирует путь к файлу "models.json" в каталоге моделей.
    Функция проверяет, существует ли файл "models.json".
    Если файл существует, функция вызывает `read_models(file_path)` для чтения данных из файла и возвращает их.
    Если файл не существует, функция вызывает `load_models()` для загрузки моделей,
    `save_models(file_path, models)` для сохранения моделей в файл и возвращает загруженные модели.
    """
    model_dir = get_model_dir()
    file_path = os.path.join(model_dir, "models.json")
    if os.path.isfile(file_path):
        return read_models(file_path)
    else:
        models = load_models()
        save_models(file_path, models)
        return models

# Пример использования:
models = get_models()
if models:
    print(f"Доступные модели: {list(models.keys())}")
else:
    print("Не удалось загрузить список моделей.")