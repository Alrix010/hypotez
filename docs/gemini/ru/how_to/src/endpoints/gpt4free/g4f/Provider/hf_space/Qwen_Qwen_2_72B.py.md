## \file hypotez/src/endpoints/gpt4free/g4f/Provider/hf_space/Qwen_Qwen_2_72B.py
# -*- coding: utf-8 -*-
#! .pyenv/bin/python3

"""
Модуль для асинхронного взаимодействия с провайдером Qwen Qwen-2.72B.
====================================================================

Этот модуль обеспечивает функциональность для генерации текста с использованием модели
Qwen Qwen-2-72B через асинхронные запросы. Он включает в себя создание уникальных
сессий, отправку запросов на генерацию и обработку потоковых данных.

Зависимости:
    - aiohttp
    - json
    - uuid
    - re

 .. module:: src.endpoints.gpt4free.g4f.Provider.hf_space.Qwen_Qwen_2_72B
"""
                
Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Данный блок кода предназначен для асинхронного взаимодействия с моделью Qwen Qwen-2.72B. Он выполняет следующие действия:
1. Генерирует уникальный идентификатор сессии.
2. Формирует заголовки и полезную нагрузку для отправки запросов к API.
3. Отправляет запрос на присоединение к очереди генерации.
4. Отправляет запрос на получение потоковых данных генерации.
5. Обрабатывает полученные данные, извлекая итоговый текст.

Шаги выполнения
-------------------------
1. **Генерация уникального идентификатора сессии**:
   - Функция `generate_session_hash` генерирует уникальный UUID и преобразует его в строку,
     затем удаляет дефисы и оставляет только первые 12 символов.

2. **Формирование заголовков и полезной нагрузки**:
   - Определяются заголовки `headers_join` для запроса на присоединение, включающие `accept`,
     `content-type`, `origin`, `referer` и `user-agent`.
   - Извлекается системный промпт из сообщений.
   - Формируется полезная нагрузка `payload_join` с данными для запроса, включающая промпт,
     системный промпт, индекс функции и идентификатор сессии.

3. **Отправка запроса на присоединение к очереди**:
   - Используется `aiohttp.ClientSession` для отправки POST-запроса к `cls.api_endpoint`
     с заголовками `headers_join` и полезной нагрузкой `payload_join`.
   - Идентификатор события `event_id` извлекается из JSON-ответа.

4. **Отправка запроса на получение потоковых данных**:
   - Формируется URL `url_data` для запроса потоковых данных.
   - Определяются заголовки `headers_data` для запроса потоковых данных.
   - Определяются параметры `params_data` для запроса, включающие идентификатор сессии.
   - Отправляется GET-запрос к `url_data` с заголовками `headers_data` и параметрами `params_data`.

5. **Обработка потоковых данных**:
   - Асинхронно читаются строки из ответа.
   - Если строка начинается с `data: `, то извлекаются JSON-данные.
   - Если `msg` равно `process_generating`, извлекается фрагмент текста из `output_data` и передается через `yield`.
   - Если `msg` равно `process_completed`, извлекается полный ответ из `output_data`, очищается от предыдущих фрагментов и передается через `yield`.
   - В случае ошибки парсинга JSON, логируется сообщение об ошибке.

Пример использования
-------------------------

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.hf_space.Qwen_Qwen_2_72B import Qwen_Qwen_2_72B

async def main():
    messages = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "What is the capital of France?"}
    ]
    
    async for message in Qwen_Qwen_2_72B.create_async_generator(model="qwen-2-72b", messages=messages):
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())