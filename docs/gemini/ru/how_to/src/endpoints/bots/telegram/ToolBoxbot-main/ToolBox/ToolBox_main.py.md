## Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Блок кода представляет собой основную логику бота Telegram, который предлагает услуги по генерации текстов и изображений. Бот работает с использованием библиотеки `telebot` и  связан с базой данных, где хранятся данные пользователей, их тарифы, использование токенов и другая информация.

Шаги выполнения
-------------------------
1. **Инициализация:**
    - Импортируются необходимые библиотеки и модули.
    - Загружаются переменные окружения.
    - Создаются объекты для работы с ботом Telegram, базой данных и API для генерации.
    - Инициализируется база данных, создается таблица для хранения данных пользователей.
2. **Обработка платежей:**
    - Обрабатываются запросы на предварительную оплату (pre-checkout).
    - При успешной оплате обновляются данные пользователя в базе данных, в том числе активируется тариф, добавляются токены, обновляется дата окончания подписки.
3. **Обработка команды `start`:**
    - При отправке команды `/start` боту, создается новый пользователь в базе данных или обновляется информация существующего.
4. **Просмотр информации о тарифе (команда `profile`):**
    - При отправке команды `/profile` боту, пользователю отправляется сообщение с описанием его текущего тарифа, включая количество доступных текстовых и графических генераций.
5. **Статистика пользователей (команда `stat`):**
    - Доступна только для определенных пользователей. Отправляется сообщение с количеством всех пользователей и пользователей, которые активировали промокод.
6. **Генерация промокода:**
    - Функция `generate_promo_code` создает случайный промокод заданной длины.
7. **Обработка кнопок (callback queries):**
    - Обрабатываются различные типы кнопок:
        - **Главные задачи:** 
            - **"text"**: Выбор типа текста, который нужно сгенерировать.
            - **"images"**: Генерация изображения (доступна только для пользователей с тарифом "PRO").
            - **"free"**: Активация бесплатного режима.
            - **"tariff"**:  Просмотр тарифов.
        - **Размер изображения:** 
            - **"576x1024"**:  Выбор размера изображения.
            - **"1024x1024"**:  Выбор размера изображения.
            - **"1024x576"**:  Выбор размера изображения.
        - **Изменения изображения:**
            - **"upscale"**: Масштабирование изображения.
            - **"regenerate"**: Перегенерация изображения.
        - **Тарифы:**
            - **"basic"**: Подключение к тарифу "BASIC".
            - **"pro"**: Подключение к тарифу "PRO".
            - **"promo"**: Ввод промокода.
            - **"ref"**: Просмотр реферального кода.
        - **Типы текстов:** 
            - **"comm-text"**:  Генерация текста для коммерческого предложения.
            - **"smm-text"**:  Генерация текста для социальных сетей.
            - **"brainst-text"**:  Генерация текста для мозгового штурма.
            - **"advertising-text"**:  Генерация текста для рекламы.
            - **"headlines-text"**:  Генерация заголовков.
            - **"seo-text"**:  Генерация текста для SEO.
            - **"news"**:  Генерация текстов в стиле новостей.
            - **"editing"**:  Редактирование текста.
        - **Выход:**
            - **"exit"**: Возврат к основному меню.
            - **"text_exit"**: Выход из выбора типа текста.
            - **"tariff_exit"**: Выход из выбора тарифа.
        - **Выбор типа текста:**
            - **"one_{ind}"**: Выбор одного типа текста.
            - **"some_{ind}"**: Выбор нескольких типов текста.
    - При нажатии на кнопку, в базе данных обновляется состояние пользователя, в том числе его выбор.
8. **Обработка сообщений:**
    - Обрабатываются сообщения, отправленные пользователем в чат бота.
    - **Обработка изображений:** 
        - Если пользователь ввел запрос на генерацию изображения, то сохраняются размер изображения, подсказка для генерации и сид.
    - **Обработка команды "В меню":**
        - Если пользователь находится в бесплатном режиме и отправляет команду "В меню", то завершается сессия, удаляются все предыдущие сообщения и происходит возврат к основному меню.
    - **Обработка бесплатного режима:**
        - Если пользователь находится в бесплатном режиме, то бот обрабатывает отправленные сообщения и изображения, вызывается функция `TokensCancelletionPattern` для отслеживания количества бесплатных запросов.
    - **Обработка текстовых запросов:**
        - Если пользователь ввел текст, то бот проверяет, какие типы текста выбрал пользователь.
        - Вызывается функция `TokensCancelletionPattern` для отслеживания количества токенов.
        - Обновляется информация о пользователе в базе данных.
9. **Проверка окончания тарифа:**
    - Асинхронная функция `end_check_tariff_time` регулярно проверяет, не закончился ли у пользователя тариф.
    - Если время окончания тарифа меньше или равно нулю, то пользователь переводится на бесплатный режим.
10. **Запуск бота:**
    - Запускается бот с использованием `bot.infinity_polling`.
    - Запускается асинхронная функция `end_check_tariff_time`.

Пример использования
-------------------------

```python
from telebot import types

# Создание объекта бота Telegram
bot = tb.bot

# Отправка приветственного сообщения пользователю
bot.send_message(chat_id=user_id, text="Привет! Добро пожаловать в бот.")

# Создание клавиатуры с кнопками "text", "images", "free", "tariff"
markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
markup.add("text", "images", "free", "tariff")

# Отправка клавиатуры пользователю
bot.send_message(chat_id=user_id, text="Выберите действие", reply_markup=markup)
```