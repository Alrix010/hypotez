## Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Этот код представляет модуль `extraction.py` в TinyTroupe, который предоставляет инструменты для извлечения и анализа данных из симуляций с участием TinyPerson (виртуальных агентов) и TinyWorld (виртуальных миров). Модуль предлагает следующие возможности:

- **Извлечение данных**:  Извлечение ключевых данных из истории взаимодействий агентов и миров.
- **Упрощение данных**: Сжатие извлеченных данных для более удобного анализа.
- **Экспорт артефактов**: Сохранение извлеченных данных в различных форматах (JSON, TXT, DOCX).
- **Нормализация**: Объединение текстовых элементов (например, пассажей или концепций) в более обобщенные категории.

Шаги выполнения
-------------------------
1. **Создание экземпляра класса `ResultsExtractor`**: 
   -  Инициализируется пустой словарь для хранения извлеченных данных (для агентов и миров).
   - Загружает шаблон для запроса извлечения данных от модели OpenAI.
2. **Извлечение данных из агента (`extract_results_from_agent`):**
   - Принимает `TinyPerson` объект, цель извлечения (например, "главные моменты из истории взаимодействий") и дополнительные параметры (ситуация, поля для извлечения).
   - Формирует запрос к модели OpenAI на основе истории взаимодействий агента, цели извлечения и ситуации.
   - Отправляет запрос и получает ответ от модели OpenAI.
   - Извлекает данные из ответа модели OpenAI.
   - Сохраняет полученные данные в `self.agent_extraction`.
3. **Извлечение данных из мира (`extract_results_from_world`):**
   -  Аналогично `extract_results_from_agent`, но принимает `TinyWorld` объект.
   - Формирует запрос на основе истории взаимодействий всех агентов в мире.
   - Сохраняет результат в `self.world_extraction`.
4. **Сохранение результатов в формате JSON (`save_as_json`):**
   - Сохраняет  `self.agent_extraction` и `self.world_extraction` в файл JSON.
5. **Упрощение данных (`ResultsReducer`):**
   -  Инициализируется с пустым словарем `self.results` и словарем `self.rules` для хранения правил сокращения.
   -  Добавляет правила сокращения с помощью `add_reduction_rule`, где ключом является тип события (например, "действие" или "стимул"), а значением - функция, которая обрабатывает это событие.
   -  Использует `reduce_agent` для упрощения данных,  проходя по истории взаимодействий агента и применяя соответствующие правила сокращения. 
   -  Преобразует сокращенные данные в `pandas.DataFrame` с помощью `reduce_agent_to_dataframe`.
6. **Экспорт артефактов (`ArtifactExporter`):**
   -  Инициализируется с базовой папкой для экспорта.
   -  Экспортирует данные в файл с помощью `export`, принимая имя артефакта, данные, тип контента, формат контента (необязательно) и целевой формат (json, txt, docx).
   -  Определяет имя файла и путь на основе `artifact_name`, `content_type` и `target_format`.
   -  Создает папки для сохранения, если они не существуют.
   -  Экспортирует данные в соответствующий формат.
7. **Нормализация (`Normalizer`):**
   -  Инициализируется со списком элементов для нормализации, количеством выходных элементов и флагом `verbose`.
   -  Формирует запрос к модели OpenAI для нормализации элементов.
   -  Получает ответ и сохраняет результат в `self.normalized_elements` (словарь, где ключами являются нормализованные элементы, а значениями - списки исходных элементов).
   -  Использует `normalize` для нормализации одного элемента или списка элементов.
   -  Использует кэш для повышения производительности.

Пример использования
-------------------------

```python
from tinytroupe.extraction import ResultsExtractor, ResultsReducer, ArtifactExporter, Normalizer

# Создание экземпляра экстрактора данных
extractor = ResultsExtractor()

# Извлечение данных из агента
agent = TinyPerson(name="Alice", world=TinyWorld(name="MyWorld"))
extraction_results = extractor.extract_results_from_agent(
    agent, extraction_objective="The main points of Alice's interactions history."
)

# Сохранение результатов в JSON
extractor.save_as_json("results.json")

# Создание экземпляра сократителя результатов
reducer = ResultsReducer()

# Добавление правила сокращения
reducer.add_reduction_rule("ask_question", lambda focus_agent, source_agent, target_agent, kind, event, content, timestamp: {
    "event": event,
    "content": content,
    "timestamp": timestamp,
    "source_agent": source_agent.name,
    "target_agent": target_agent.name
})

# Сокращение данных агента
reduced_data = reducer.reduce_agent(agent)

# Создание экземпляра экспортера артефактов
exporter = ArtifactExporter("output")

# Экспорт сокращенных данных в формате JSON
exporter.export(artifact_name="reduced_data", artifact_data=reduced_data, content_type="interaction", target_format="json")

# Создание экземпляра нормализатора
normalizer = Normalizer(elements=["apple", "banana", "orange", "grapefruit"], n=3)

# Нормализация элементов
normalized_elements = normalizer.normalize(["apple", "banana", "grapefruit"])

# Вывод нормализованных элементов
print(normalized_elements) 
```