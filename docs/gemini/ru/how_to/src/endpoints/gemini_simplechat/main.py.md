### Как использовать этот блок кода
=========================================================================================

Описание
-------------------------
Данный код представляет собой веб-приложение, реализованное с использованием FastAPI, которое предоставляет простой чат-интерфейс на основе модели Google Gemini. Он включает в себя конфигурацию CORS, определение модели запроса чата, маршруты для отображения HTML-страницы и обработки запросов чата.

Шаги выполнения
-------------------------
1. **Импорт необходимых модулей**:
   - Импортируются необходимые библиотеки, такие как `sys`, `os`, `Path`, `FastAPI`, `HTTPException`, `HTMLResponse`, `BaseModel`, `uvicorn`, `CORSMiddleware`.
   - Импортируются модули проекта: `header`, `gs`, `GoogleGenerativeAi`, `j_loads_ns`, `logger`.

2. **Инициализация FastAPI приложения**:
   - Создается экземпляр FastAPI: `app = FastAPI()`.

3. **Настройка CORS**:
   - Добавляется middleware для CORS, чтобы разрешить запросы с любых доменов (в данном случае). Это необходимо для взаимодействия с фронтендом, работающим на другом домене.

4. **Определение модели запроса чата**:
   - Создается класс `ChatRequest`, наследуемый от `BaseModel`, который определяет структуру запроса чата (содержащего только сообщение).

5. **Инициализация модели Google Gemini**:
   - Считывается системная инструкция из файла `instructions/system_instruction.md`.
   - Инициализируется модель `GoogleGenerativeAi` с использованием API-ключа, имени модели и системной инструкции из `gs.credentials.gemini`.

6. **Определение маршрута для корневого URL ("/")**:
   - Определяется асинхронная функция `root`, которая возвращает HTML-контент из файла, указанного в `gs.fast_api.index_path`.
   - В случае ошибки чтения файла возвращается HTTP-исключение с кодом 500.

7. **Определение маршрута для чата ("/api/chat")**:
   - Определяется асинхронная функция `chat`, которая принимает запрос типа `ChatRequest`.
   - Функция вызывает метод `chat` модели Google Gemini для получения ответа на сообщение.
   - Возвращает JSON-ответ, содержащий полученный ответ.
   - В случае ошибки логирует ошибку и возвращает HTTP-исключение с кодом 500.

8. **Запуск сервера Uvicorn (если скрипт запущен напрямую)**:
   - Если скрипт запущен как основная программа, запускается сервер Uvicorn с использованием хоста и порта, указанных в `gs.fast_api`.

Пример использования
-------------------------

```python
import asyncio
from fastapi.testclient import TestClient
from src.endpoints.gemini_simplechat.main import app, ChatRequest

client = TestClient(app)

def test_chat_endpoint():
    # Создаем тестовый запрос
    test_message = "Hello, Gemini!"
    request_data = ChatRequest(message=test_message)

    # Отправляем POST-запрос к эндпоинту /api/chat
    response = client.post("/api/chat", json=request_data.dict())

    # Проверяем, что запрос выполнен успешно (код 200)
    assert response.status_code == 200

    # Извлекаем ответ из JSON
    response_data = response.json()

    # Проверяем, что в ответе есть ключ "response"
    assert "response" in response_data

    # Выводим полученный ответ (опционально)
    print(f"Gemini response: {response_data['response']}")

test_chat_endpoint()