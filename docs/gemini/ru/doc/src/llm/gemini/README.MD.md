# Модуль интеграции Google Generative AI

```rst
 .. module:: src.ai.gemini
 ```
[English](https://github.com/hypo69/hypo/tree/master/src/ai/gemini/readme.md)

## Обзор

Класс `GoogleGenerativeAi` разработан для облегчения взаимодействия с моделями Google Generative AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает в себя надежную обработку ошибок, журналирование и параметры конфигурации для обеспечения бесперебойной работы.

## Основные функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAi` с необходимыми конфигурациями.

**Параметры**:
- `api_key` (str): Ключ API для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Название используемой модели AI. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации для модели AI. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системные инструкции для модели AI. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Как работает функция**:
- Функция устанавливает ключ API, имя модели, конфигурацию генерации и системные инструкции.
- Определяет пути для логирования диалогов и хранения истории.
- Инициализирует модель Google Generative AI.

**Примеры**:
```python
ai = GoogleGenerativeAi(api_key="your_api_key", system_instruction="Instruction")
```

### `config()`

**Назначение**: Получает конфигурацию из файла настроек.

**Как работает функция**:
- Читает и анализирует файл конфигурации, расположенный по адресу `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.

**Примеры**:
```python
config = GoogleGenerativeAi.config()
```

### `_start_chat(self)`

**Назначение**: Начинает сеанс чата с моделью AI.

**Как работает функция**:
- Инициализирует сеанс чата с пустой историей.

**Примеры**:
```python
self._start_chat()
```

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог как в текстовый, так и в JSON-файл.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

**Как работает функция**:
- Добавляет каждое сообщение в диалоге в текстовый файл.
- Добавляет каждое сообщение в формате JSON в JSON-файл.

**Примеры**:
```python
self._save_dialogue(dialogue)
```

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос в модель AI и получает ответ.

**Параметры**:
- `q` (str): Текстовый запрос для отправки.
- `attempts` (int, optional): Количество попыток в случае сетевых ошибок или недоступности службы. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Ответ модели AI или `None` в случае ошибки.

**Как работает функция**:
- Обрабатывает несколько попыток в случае сетевых ошибок или недоступности службы.
- Регистрирует ошибки и повторяет попытки с экспоненциальной задержкой.
- Сохраняет диалог в файлы истории.

**Примеры**:
```python
response = ai.ask("Как дела?")
```

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение в чат модели AI и получает ответ.

**Параметры**:
- `q` (str): Сообщение чата для отправки.

**Возвращает**:
- `str`: Ответ модели AI.

**Как работает функция**:
- Использует сеанс чата, инициализированный `_start_chat`.
- Регистрирует ошибки и возвращает текст ответа.

**Примеры**:
```python
response = ai.chat("Привет!")
```

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Сгенерированное описание или `None`, если операция не удалась.

**Как работает функция**:
- Кодирует изображение в base64 и отправляет его в модель AI.
- Возвращает сгенерированное описание или регистрирует ошибку, если операция не удалась.

**Примеры**:
```python
description = ai.describe_image(Path("image.jpg"))
```

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в модель AI.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу, объект Path или объект IOBase.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в противном случае.

**Как работает функция**:
- Обрабатывает загрузку файла и регистрирует успех или неудачу.
- Предоставляет логику повторных попыток в случае ошибок.

**Примеры**:
```python
success = ai.upload_file("data.txt")
```

## Обработка ошибок

Класс включает в себя комплексную обработку ошибок для различных сценариев:
- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность службы**: Регистрация ошибок и повторные попытки.
- **Ограничения квоты**: Регистрация и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Регистрация и прекращение дальнейших попыток.
- **Недопустимый ввод**: Регистрация и повторные попытки с таймаутом.
- **Ошибки API**: Регистрация и прекращение дальнейших попыток.

## Журналирование и история

Все взаимодействия с моделями AI регистрируются, а диалоги сохраняются как в текстовом, так и в JSON-форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть просмотрены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAi(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

В этом примере инициализируется класс `GoogleGenerativeAi`, отправляется запрос в модель AI и выводится ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAi`.