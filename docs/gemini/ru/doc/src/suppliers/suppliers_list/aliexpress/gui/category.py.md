# Модуль: `category.py`

## Обзор

Модуль предоставляет графический интерфейс для подготовки рекламных кампаний AliExpress, позволяя открывать JSON-файлы конфигурации, отображать информацию о кампаниях и категориях, а также асинхронно подготавливать все категории или конкретную категорию.

## Подробнее

Модуль `category.py` предоставляет класс `CategoryEditor`, который является виджетом PyQt6 для редактирования категорий кампаний AliExpress. Он позволяет пользователю загружать JSON-файлы конфигурации кампаний, отображает основные сведения о кампании (название, заголовок, категории) и предоставляет кнопки для подготовки всех категорий или выбранной категории. Класс использует `AliCampaignEditor` для фактической подготовки категорий и `j_loads_ns` для загрузки JSON-файлов.

## Классы

### `CategoryEditor(QtWidgets.QWidget)`

**Описание**: Виджет для редактирования категорий кампаний.

**Наследует**: `QtWidgets.QWidget`

**Атрибуты**:

-   `campaign_name` (str): Имя кампании.
-   `data` (SimpleNamespace): Данные, загруженные из JSON-файла.
-   `language` (str): Язык кампании (по умолчанию "EN").
-   `currency` (str): Валюта кампании (по умолчанию "USD").
-   `file_path` (str): Путь к файлу конфигурации кампании.
-   `editor` (AliCampaignEditor): Экземпляр класса `AliCampaignEditor` для подготовки кампании.
-   `main_app` (MainApp): Экземпляр главного приложения.

**Методы**:

-   `__init__(self, parent=None, main_app=None)`: Инициализирует виджет, настраивает пользовательский интерфейс и устанавливает соединения сигналов и слотов.
-   `setup_ui(self)`: Настраивает пользовательский интерфейс, определяет компоненты и их расположение.
-   `setup_connections(self)`: Устанавливает соединения между сигналами и слотами.
-   `open_file(self)`: Открывает диалоговое окно для выбора JSON-файла и загружает его.
-   `load_file(self, campaign_file)`: Загружает JSON-файл кампании и отображает данные.
-   `create_widgets(self, data)`: Создает виджеты на основе данных, загруженных из JSON-файла.
-   `prepare_all_categories_async(self)`: Асинхронно подготавливает все категории кампании.
-   `prepare_category_async(self)`: Асинхронно подготавливает указанную категорию кампании.

#### `__init__(self, parent=None, main_app=None)`

```python
def __init__(self, parent=None, main_app=None):
    """
    Инициализирует виджет CategoryEditor.

    Args:
        parent (QtWidgets.QWidget, optional): Родительский виджет. По умолчанию None.
        main_app (MainApp, optional): Экземпляр главного приложения. По умолчанию None.
    """
    ...
```

-   **Назначение**: Инициализирует экземпляр класса `CategoryEditor`.
-   **Параметры**:
    -   `parent` (QtWidgets.QWidget, optional): Родительский виджет для данного виджета. По умолчанию `None`.
    -   `main_app` (MainApp, optional): Ссылка на главный экземпляр приложения. По умолчанию `None`.
-   **Как работает функция**:
    -   Вызывает конструктор родительского класса `QtWidgets.QWidget`.
    -   Сохраняет ссылку на экземпляр главного приложения.
    -   Вызывает методы `setup_ui()` и `setup_connections()` для настройки пользовательского интерфейса и соединений.

#### `setup_ui(self)`

```python
def setup_ui(self):
    """
    Настраивает пользовательский интерфейс.
    """
    ...
```

-   **Назначение**: Настраивает элементы пользовательского интерфейса (кнопки, метки и т. д.) и их размещение в окне.
-   **Как работает функция**:
    -   Устанавливает заголовок окна как "Category Editor".
    -   Устанавливает размер окна 1800x800 пикселей.
    -   Создаёт кнопку "Open JSON File" и подключает её к методу `self.open_file`.
    -   Создаёт метку `self.file_name_label` с текстом "No file selected".
    -   Создаёт кнопку "Prepare All Categories" и подключает её к асинхронному методу `self.prepare_all_categories_async`.
    -   Создаёт кнопку "Prepare Category" и подключает её к асинхронному методу `self.prepare_specific_button`.
    -   Создаёт вертикальный макет (`QVBoxLayout`) и добавляет в него созданные виджеты.
    -   Устанавливает созданный макет для виджета `CategoryEditor`.

#### `setup_connections(self)`

```python
def setup_connections(self):
    """
    Устанавливает соединения сигналов и слотов.
    """
    ...
```

-   **Назначение**: Настраивает соединения между сигналами и слотами (в данном случае, ничего не делает, но может быть расширена для добавления дополнительных соединений).
-   **Как работает функция**:
    -   В текущей реализации функция пуста (`pass`).

#### `open_file(self)`

```python
def open_file(self):
    """
    Открывает диалоговое окно для выбора JSON-файла.
    """
    ...
```

-   **Назначение**: Открывает диалоговое окно, позволяющее пользователю выбрать JSON-файл конфигурации кампании.
-   **Как работает функция**:
    -   Вызывает `QtWidgets.QFileDialog.getOpenFileName()` для отображения диалогового окна выбора файла.
    -   Устанавливает фильтр для отображения только JSON-файлов.
    -   Если файл выбран, вызывает метод `load_file()` для загрузки содержимого выбранного файла.
    -   Если файл не выбран (пользователь закрыл диалоговое окно), функция завершается.

#### `load_file(self, campaign_file)`

```python
def load_file(self, campaign_file):
    """
    Загружает JSON-файл кампании.

    Args:
        campaign_file (str): Путь к файлу кампании.
    """
    ...
```

-   **Назначение**: Загружает JSON-файл кампании, обрабатывает данные и настраивает редактор кампании.
-   **Параметры**:
    -   `campaign_file` (str): Путь к файлу кампании, который нужно загрузить.
-   **Как работает функция**:
    -   Пытается загрузить JSON-файл, используя `j_loads_ns()` из `src.utils.jjson`.
    -   Если загрузка прошла успешно:
        -   Сохраняет путь к файлу в `self.campaign_file`.
        -   Устанавливает текст метки `self.file_name_label` с именем файла.
        -   Извлекает имя кампании из загруженных данных и сохраняет его в `self.campaign_name`.
        -   Извлекает язык из имени файла (без расширения) и сохраняет его в `self.language`.
        -   Создает экземпляр класса `AliCampaignEditor`, передавая путь к файлу кампании.
        -   Вызывает метод `create_widgets()` для создания виджетов на основе загруженных данных.
    -   Если во время загрузки или обработки файла возникает исключение, отображает диалоговое окно с сообщением об ошибке.

#### `create_widgets(self, data)`

```python
def create_widgets(self, data):
    """
    Создает виджеты на основе данных из JSON-файла.

    Args:
        data (SimpleNamespace): Данные кампании.
    """
    ...
```

-   **Назначение**: Создает и отображает виджеты (метки) на основе данных, загруженных из JSON-файла, таких как заголовок и категории кампании.
-   **Параметры**:
    -   `data` (SimpleNamespace): Данные кампании, из которых извлекается информация для отображения.
-   **Как работает функция**:
    -   Получает текущий макет (`layout`) виджета `CategoryEditor`.
    -   Удаляет все предыдущие виджеты из макета, за исключением кнопок "Open JSON File", "Prepare All Categories" и "Prepare Specific Category", а также метки имени файла.
    -   Создает метку для отображения заголовка кампании (извлекается из `data.title`).
    -   Создает метку для отображения имени кампании (извлекается из `data.campaign_name`).
    -   Для каждой категории в `data.categories` создается метка с именем категории.
    -   Все созданные метки добавляются в макет.

#### `prepare_all_categories_async(self)`

```python
@asyncSlot()
async def prepare_all_categories_async(self):
    """
    Асинхронно подготавливает все категории.
    """
    ...
```

-   **Назначение**: Асинхронно подготавливает все категории кампании, используя `AliCampaignEditor`.
-   **Как работает функция**:
    -   Проверяет, инициализирован ли `self.editor` (экземпляр `AliCampaignEditor`).
    -   Если `self.editor` существует, вызывает асинхронный метод `self.editor.prepare_all_categories()` для подготовки всех категорий.
    -   В случае успешной подготовки отображает информационное сообщение.
    -   Если во время подготовки возникает исключение, отображает сообщение об ошибке.

#### `prepare_category_async(self)`

```python
@asyncSlot()
async def prepare_category_async(self):
    """
    Асинхронно подготавливает конкретную категорию.
    """
    ...
```

-   **Назначение**: Асинхронно подготавливает конкретную категорию кампании, используя `AliCampaignEditor`.
-   **Как работает функция**:
    -   Проверяет, инициализирован ли `self.editor` (экземпляр `AliCampaignEditor`).
    -   Если `self.editor` существует, вызывает асинхронный метод `self.editor.prepare_category(self.data.campaign_name)` для подготовки указанной категории.
    -   В случае успешной подготовки отображает информационное сообщение.
    -   Если во время подготовки возникает исключение, отображает сообщение об ошибке.