# Модуль: Генератор партнерских товаров AliExpress

## Обзор

Модуль предназначен для извлечения информации о товарах с AliExpress, получения партнерских ссылок и сохранения связанных данных, таких как изображения и видео. Он автоматизирует процесс сбора данных о товарах для последующего использования в рекламных кампаниях.

## Подробнее

Модуль `affiliated_products_generator.py` содержит класс `AliAffiliatedProducts`, который расширяет возможности класса `AliApi` и специализируется на обработке партнерских товаров с AliExpress. Основная задача модуля - получение партнерских ссылок на товары, загрузка изображений и видео, а также сохранение всей необходимой информации о товаре в структурированном виде. Модуль использует асинхронные операции для повышения производительности при загрузке данных из сети.

## Классы

### `AliAffiliatedProducts(AliApi)`

**Описание**: Класс для сбора полных данных о товарах из URL или идентификаторов продуктов.

**Наследует**: `AliApi`

**Атрибуты**:
- `language` (str): Язык для кампании (по умолчанию `None`).
- `currency` (str): Валюта для кампании (по умолчанию `None`).

**Принцип работы**:
Класс `AliAffiliatedProducts` инициализируется с указанием языка и валюты, которые используются при формировании запросов к API AliExpress. Он использует методы родительского класса `AliApi` для получения партнерских ссылок и выполняет дополнительную обработку полученных данных, такую как сохранение изображений и видео.

**Методы**:
- `__init__(language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs)`: Инициализирует класс `AliAffiliatedProducts`.
- `process_affiliate_products(self, prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]`: Обрабатывает список идентификаторов или URL продуктов, возвращая список товаров с партнерскими ссылками и сохраненными изображениями.

## Методы класса

### `__init__(language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs)`

```python
def __init__(self, language: str | dict = 'EN', currency: str = 'USD', *args, **kwargs):
    """
    Инициализирует класс AliAffiliatedProducts.
    Args:
        language (str | dict): Язык для кампании (по умолчанию 'EN').
        currency (str): Валюта для кампании (по умолчанию 'USD').
    """
```

**Назначение**: Инициализация экземпляра класса `AliAffiliatedProducts`.

**Параметры**:
- `language` (str | dict): Язык, используемый в кампании. По умолчанию `'EN'`.
- `currency` (str): Валюта, используемая в кампании. По умолчанию `'USD'`.
- `*args`: Произвольные позиционные аргументы, передаваемые в конструктор родительского класса.
- `**kwargs`: Произвольные именованные аргументы, передаваемые в конструктор родительского класса.

**Как работает функция**:
- Проверяет, что указаны язык и валюта. В противном случае регистрирует критическую ошибку и завершает работу.
- Вызывает конструктор родительского класса `AliApi`, передавая туда язык и валюту.
- Сохраняет значения языка и валюты в атрибутах экземпляра класса.

**Примеры**:

```python
affiliated_products = AliAffiliatedProducts(language='RU', currency='RUB')
```

### `process_affiliate_products(self, prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]`

```python
async def process_affiliate_products(self, prod_ids: list[str], category_root: Path | str) -> list[SimpleNamespace]:
    """
    Обрабатывает список идентификаторов или URL продуктов, возвращая список товаров с партнерскими ссылками и сохраненными изображениями.

    Args:
        prod_ids (list[str]): Список URL или идентификаторов продуктов.
        category_root (Path | str): Корневой путь к категории для сохранения изображений и видео.

    Returns:
        list[SimpleNamespace]: Список обработанных продуктов с партнерскими ссылками и сохраненными изображениями.

    Raises:
        Exception: Если имя категории не найдено в кампании.
    """
```

**Назначение**: Обработка списка идентификаторов или URL продуктов для получения партнерских ссылок, сохранения изображений и видео.

**Параметры**:
- `prod_ids` (list[str]): Список URL или идентификаторов продуктов для обработки.
- `category_root` (Path | str): Корневой путь к категории, где будут сохранены изображения и видео.

**Возвращает**:
- `list[SimpleNamespace]`: Список обработанных продуктов с партнерскими ссылками и сохраненными изображениями.

**Как работает функция**:
1. **Подготовка**:
   - Инициализирует пустые списки `_promotion_links` и `_prod_urls` для хранения партнерских ссылок и URL продуктов соответственно.
   - Нормализует URL продуктов, приводя их к виду `https://aliexpress.com/item/<product_id>.html` с помощью функции `ensure_https`.
2. **Получение партнерских ссылок**:
   - Перебирает нормализованные URL продуктов и получает партнерские ссылки с помощью метода `get_affiliate_links` родительского класса `AliApi`.
   - Если партнерская ссылка найдена, добавляет её в список `_promotion_links`, а URL продукта - в список `_prod_urls`.
3. **Обработка продуктов без партнерских ссылок**:
   - Если не найдено ни одной партнерской ссылки, регистрирует предупреждение и возвращает `None`.
4. **Извлечение деталей продукта**:
   - Извлекает детали продукта для каждого URL из списка `_prod_urls` с помощью метода `retrieve_product_details`.
5. **Сохранение данных о продукте**:
   - Перебирает список полученных продуктов и соответствующих партнерских ссылок.
   - Для каждого продукта:
     - Устанавливает язык и партнерскую ссылку.
     - Формирует путь для сохранения изображения продукта.
     - Асинхронно сохраняет изображение продукта, используя функцию `save_image_from_url`.
     - Сохраняет локальный путь к изображению в атрибуте `local_image_path` продукта.
     - Если у продукта есть видео:
       - Извлекает суффикс (расширение) из URL видео.
       - Формирует путь для сохранения видео.
       - Асинхронно сохраняет видео, используя функцию `save_video_from_url`.
       - Сохраняет локальный путь к видео в атрибуте `local_video_path` продукта.
     - Сериализует данные продукта в формат JSON и сохраняет в файл.
     - Добавляет продукт в список `affiliated_products_list`.
6. **Сохранение заголовков продуктов**:
   - Формирует список заголовков продуктов.
   - Формирует путь для сохранения списка заголовков продуктов.
   - Асинхронно сохраняет список заголовков продуктов в текстовый файл.
7. **Возврат результата**:
   - Возвращает список обработанных продуктов `affiliated_products_list`.

**Внутренние функции**:
В данной функции нет внутренних функций.

**Примеры**:

```python
prod_ids = ["https://aliexpress.com/item/1234567890.html", "https://aliexpress.com/item/0987654321.html"]
category_root = "/path/to/category"
affiliated_products = await self.process_affiliate_products(prod_ids, category_root)
for product in affiliated_products:
    print(product.product_title)
```
```