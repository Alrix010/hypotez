# Модуль для управления категориями Aliexpress

## Обзор

Модуль предназначен для управления категориями товаров на сайте Aliexpress, включая сбор ссылок на товары, обновление информации о категориях в файле сценария и взаимодействие с базой данных категорий.

## Подробнее

Модуль предоставляет функциональность для автоматизации работы с категориями товаров на Aliexpress. Он включает в себя функции для сбора URL товаров из категорий, обновления информации о категориях в файле сценария на основе данных с сайта, а также класс для взаимодействия с базой данных категорий.
Этот код позволяет автоматизировать процесс мониторинга и обновления категорий товаров на Aliexpress, что полезно для задач, связанных с анализом ассортимента, отслеживанием изменений и синхронизацией данных с другими системами.

## Функции

### `get_list_products_in_category`

```python
def get_list_products_in_category(s) -> list[str, str]:
    """
    Считывает URL товаров со страницы категории.

    Args:
        s (Supplier): Экземпляр поставщика.

    Returns:
        list[str, str]: Список собранных URL. Может быть пустым, если в исследуемой категории нет товаров.
    """
```

**Назначение**: Функция считывает URL товаров со страницы категории Aliexpress. Если категория содержит несколько страниц с товарами, функция перелистывает все страницы и собирает URL со всех страниц.

**Параметры**:
- `s` (Supplier): Экземпляр класса `Supplier`, содержащий необходимые атрибуты и методы для работы с поставщиком.

**Возвращает**:
- `list[str, str]`: Список собранных URL товаров. Если в категории нет товаров, возвращается пустой список.

**Как работает функция**:
Функция вызывает функцию `get_prod_urls_from_pagination(s)` для сбора URL товаров с учетом пагинации на странице категории.
Функция предполагает, что веб-драйвер уже открыл страницу категории.

**Примеры**:
```python
# Пример вызова функции
# supplier = Supplier(...)  # Необходимо создать экземпляр класса Supplier
# product_urls = get_list_products_in_category(supplier)
# if product_urls:
#     print(f"Найдено {len(product_urls)} URL товаров в категории.")
# else:
#     print("В категории нет товаров.")
```

### `get_prod_urls_from_pagination`

```python
def get_prod_urls_from_pagination(s) -> list[str]:
    """
    Функция собирает ссылки на товары со страницы категории с перелистыванием страниц.

    Args:
        s (Supplier): Экземпляр поставщика.

    Returns:
        list[str]: Список ссылок, собранных со страницы категории.
    """
```

**Назначение**: Функция собирает ссылки на товары со страницы категории, перелистывая страницы, если их несколько.

**Параметры**:
- `s` (Supplier): Экземпляр класса `Supplier`, содержащий необходимые атрибуты и методы для работы с поставщиком.

**Возвращает**:
- `list[str]`: Список ссылок на товары, собранных со страницы категории.

**Как работает функция**:
1.  Извлекает драйвер (`_d`) и локаторы (`_l`) из объекта поставщика `s`.
2.  Выполняет локатор `_l` для получения списка ссылок на товары с текущей страницы категории.
3.  Если список ссылок пуст, функция возвращает пустой список, предполагая, что в категории нет товаров.
4.  Запускается цикл `while True`, который перелистывает страницы категории до тех пор, пока это возможно.
5.  Внутри цикла проверяется наличие кнопки перелистывания на следующую страницу с помощью локатора `s.locators['category']['pagination']['->']`.
6.  Если кнопка перелистывания отсутствует, цикл завершается.
7.  Если кнопка перелистывания присутствует, функция добавляет ссылки на товары со следующей страницы в общий список `list_products_in_category`.
8.  После завершения цикла функция возвращает список всех собранных ссылок на товары.

**Примеры**:
```python
# Пример вызова функции
# supplier = Supplier(...)  # Необходимо создать экземпляр класса Supplier
# product_urls = get_prod_urls_from_pagination(supplier)
# if product_urls:
#     print(f"Найдено {len(product_urls)} URL товаров в категории.")
# else:
#     print("В категории нет товаров.")
```

### `update_categories_in_scenario_file`

```python
def update_categories_in_scenario_file(s, scenario_filename: str) -> bool:
    """
    Проверка изменений категорий на сайте.

    Args:
        s (Supplier): Экземпляр поставщика.
        scenario_filename (str): Имя файла сценария.

    Returns:
        bool: True в случае успешного завершения.
    """
```

**Назначение**: Функция сравнивает список категорий, полученных с сайта Aliexpress, со списком категорий, хранящимся в файле сценария, и обновляет файл сценария в соответствии с изменениями.

**Параметры**:
- `s` (Supplier): Экземпляр класса `Supplier`, содержащий необходимые атрибуты и методы для работы с поставщиком.
- `scenario_filename` (str): Имя файла сценария, который необходимо обновить.

**Возвращает**:
- `bool`: `True` в случае успешного завершения, иначе `None`.

**Как работает функция**:

1.  Загружает JSON из файла сценария.
2.  Получает список категорий с сайта, используя функцию `get_list_categories_from_site()`.
3.  Определяет внутреннюю функцию `_update_all_ids_in_file()`, которая извлекает идентификаторы категорий из файла сценария и сохраняет их в списке `all_ids_in_file`. Если идентификатор категории не определен в файле, функция пытается извлечь его из URL категории и добавляет в список.
4.  Получает JSON-данные категорий магазина с сайта Aliexpress по URL, указанному в файле сценария.
5.  Извлекает список групп категорий из полученных JSON-данных.
6.  Формирует списки `all_ids_on_site` и `all_categories_on_site`, содержащие идентификаторы и информацию о категориях, полученных с сайта.
7.  Определяет списки `removed_categories` и `added_categories`, содержащие категории, которые были удалены или добавлены на сайте по сравнению с файлом сценария.
8.  Обновляет файл сценария:
    *   Для добавленных категорий добавляет информацию о них в файл сценария.
    *   Для удаленных категорий устанавливает флаг `active` в `False`.
9.  Отправляет уведомления о добавленных и удаленных категориях.
10. Сохраняет изменения в файле сценария.
11. Возвращает `True`.

**Внутренние функции**:

*   `_update_all_ids_in_file()`:
    ```python
        def _update_all_ids_in_file():
            """
            Обновляет список всех идентификаторов категорий из файла сценария.
            """
    ```

    **Назначение**: Извлекает и обновляет список идентификаторов категорий из файла сценария.

    **Как работает функция**:
    1.  Перебирает все категории в файле сценария.
    2.  Если у категории определен идентификатор (`category ID on site`), добавляет его в список `all_ids_in_file`.
    3.  Если идентификатор не определен, пытается извлечь его из URL категории и добавляет в список.

**Примеры**:
```python
# Пример вызова функции
# supplier = Supplier(...)  # Необходимо создать экземпляр класса Supplier
# scenario_filename = "aliexpress_scenario.json"
# update_result = update_categories_in_scenario_file(supplier, scenario_filename)
# if update_result:
#     print("Файл сценария успешно обновлен.")
# else:
#     print("Ошибка при обновлении файла сценария.")
```

### `get_list_categories_from_site`

```python
def get_list_categories_from_site(s,scenario_file,brand=''):
    """
        ...
    """
```

**Назначение**:  Функция получает список категорий с сайта

**Параметры**:
- `s` (Supplier): Экземпляр класса `Supplier`, содержащий необходимые атрибуты и методы для работы с поставщиком.
- `scenario_file` (str): Имя файла сценария, который необходимо обновить.
- `brand` (str): Строка, содержащая имя бренда. По умолчанию ''

**Возвращает**:
-  Нет возвращаемого значения

**Как работает функция**:
1.  Функция получает URL категорий магазина из файла `scenario_json`.
2.  После чего драйвер открывает полученную ссылку.
3.  Дальнейшая логика работы функции не определена (`...`)

**Примеры**:
```python
# Пример вызова функции
# supplier = Supplier(...)  # Необходимо создать экземпляр класса Supplier
# scenario_filename = "aliexpress_scenario.json"
# get_list_categories_from_site(supplier, scenario_filename)
# Функция выполняет действия, но не возвращает значения
```

## Классы

### `DBAdaptor`

```python
class DBAdaptor:
    """
    Адаптер для взаимодействия с базой данных категорий Aliexpress.
    """
```

**Описание**: Класс `DBAdaptor` предоставляет методы для выполнения операций с базой данных категорий Aliexpress, таких как выборка, вставка, обновление и удаление записей.

**Методы**:

#### `select`

```python
    def select(cat_id:int = None, parent_id:int = None, project_cat_id:int = None ):
        """
            ...
        """
```

**Назначение**: Метод выполняет операцию выборки записей из таблицы категорий.

**Параметры**:
- `cat_id` (int, optional): Идентификатор категории. По умолчанию `None`.
- `parent_id` (int, optional): Идентификатор родительской категории. По умолчанию `None`.
- `project_cat_id` (int, optional): Идентификатор категории в проекте. По умолчанию `None`.

**Возвращает**:
-  Нет возвращаемого значения

**Как работает функция**:
1.  Пример операции SELECT
2.  Выбрать все записи из таблицы AliexpressCategory, где parent_category_id равен \'parent_id_value\'
3.  Полученные значения выводятся функцией `print`

**Примеры**:
```python
# Пример вызова функции
# db_adaptor = DBAdaptor()
# db_adaptor.select(parent_id=123)
# Будут выбраны и выведены все категории с parent_id=123
```

#### `insert`

```python
    def insert():
        """
            ...
        """
```

**Назначение**: Метод выполняет операцию вставки новой записи в таблицу категорий.

**Параметры**:
-  Нет параметров

**Возвращает**:
-  Нет возвращаемого значения

**Как работает функция**:
1.  Пример операции INSERT
2.  Вставить новую запись в таблицу AliexpressCategory
3.  Значения для вставки определены в словаре `fields`
4.  Функция выполняет вставку используя `manager.insert_record`

**Примеры**:
```python
# Пример вызова функции
# db_adaptor = DBAdaptor()
# db_adaptor.insert()
# Будет вставлена новая категория со значениями по умолчанию
```

#### `update`

```python
    def update():
        """
            ...
        """
```

**Назначение**: Метод выполняет операцию обновления записи в таблице категорий.

**Параметры**:
-  Нет параметров

**Возвращает**:
-  Нет возвращаемого значения

**Как работает функция**:
1.  Пример операции UPDATE
2.  Обновить запись в таблице AliexpressCategory, где hypotez_category_id равен \'hypotez_id_value\'
3.  Функция выполняет обновление с помощью `manager.update_record`

**Примеры**:
```python
# Пример вызова функции
# db_adaptor = DBAdaptor()
# db_adaptor.update()
# Будет обновлена категория с hypotez_id_value
```

#### `delete`

```python
    def delete():
        """
            ...
        """
```

**Назначение**: Метод выполняет операцию удаления записи из таблицы категорий.

**Параметры**:
-  Нет параметров

**Возвращает**:
-  Нет возвращаемого значения

**Как работает функция**:
1.  Пример операции DELETE
2.  Удалить запись из таблицы AliexpressCategory, где hypotez_category_id равен \'hypotez_id_value\'
3.  Функция выполняет удаление с помощью `manager.delete_record`

**Примеры**:
```python
# Пример вызова функции
# db_adaptor = DBAdaptor()
# db_adaptor.delete()
# Будет удалена категория с hypotez_id_value