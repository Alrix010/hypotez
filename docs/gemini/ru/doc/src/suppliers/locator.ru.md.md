# Документация модуля `locator.ru`

## Обзор

Этот модуль предоставляет информацию о том, как определять и использовать локаторы для веб-элементов при автоматизации веб-скрапинга в проекте `hypotez`. Локаторы используются для поиска элементов на HTML-странице и взаимодействия с ними с помощью WebDriver. Модуль описывает структуру JSON-словарей, используемых для определения локаторов, и объясняет значение каждого ключа в этих словарях.

## Подробней

Этот файл предназначен для разработчиков, занимающихся настройкой и использованием локаторов веб-элементов. Он объясняет, как определять локаторы в формате JSON и как использовать их для извлечения данных или выполнения действий на веб-странице. Файл содержит примеры локаторов, описание их структуры и объяснение каждого поля, чтобы разработчики могли легко создавать и поддерживать локаторы для различных поставщиков и версий веб-сайтов (например, для десктопной и мобильной версий).

## Структура локаторов

Локаторы определяются в виде JSON-словарей. Имя словаря соответствует имени поля класса `ProductFields`.

### Пример локатора:

```json
"close_banner": {
    "attribute": null,
    "by": "XPATH",
    "selector": "//button[@id = 'closeXButton']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "click()",
    "locator_description": "Закрываю pop-up окно. Если оно не появилось — не страшно (`mandatory`: `false`)."
  }
```

### Ключи локатора:

- `attribute`: Атрибут веб-элемента, который нужно получить (например, `innerText`, `src`, `id`, `href`). Если `null/false`, возвращается весь `WebElement`.
- `by`: Стратегия поиска элемента (`ID`, `NAME`, `CLASS_NAME`, `TAG_NAME`, `LINK_TEXT`, `PARTIAL_LINK_TEXT`, `CSS_SELECTOR`, `XPATH`).
- `selector`: Селектор для поиска элемента (например, XPath-выражение).
- `if_list`: Определяет, что делать со списком найденных элементов (`first`, `all`, `last`, `even`, `odd`, конкретные номера).
- `use_mouse`: `true` или `false`, определяет, использовать ли мышь для взаимодействия с элементом.
- `event`: Действие, которое WebDriver выполняет с веб-элементом (`click()`, `screenshot()`, `scroll()`, `send_message()`). Выполняется **до** получения значения из `attribute`.
- `mandatory`: `true` или `false`, определяет, является ли локатор обязательным. Если `true` и элемент не найден, выбрасывается ошибка.
- `locator_description`: Описание локатора.

## Использование локаторов

Локаторы используются для получения данных о товарах с веб-страниц поставщиков.

```python
f = ProductFields(
    name = d.execute_locator('name'),
    price = d.execute_locator('price'),
    ...
)
```

Также можно создавать локаторы для дополнительных действий на странице, например, для закрытия баннеров.

## Сложные локаторы

В ключи локатора можно передавать списки, кортежи или словари.

### Пример локатора со списками:

```json
"sample_locator": {
    "attribute": [
      null,
      "href"
    ],
    "by": [
      "XPATH",
      "XPATH"
    ],
    "selector": [
      "//a[contains(@href, '#tab-description')]",
      "//div[@id = 'tab-description']//p"
    ],
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": [
      "click()",
      null
    ],
    "if_list": "first",
    "use_mouse": [
      false,
      false
    ],
    "mandatory": [
      "true",
      "true"
    ],
    "locator_description": [
      "Нажимаю на вкладку для открытия поля description.",
      "Читаю данные из div."
    ]
  }
```

В этом примере сначала будет найден элемент `//a[contains(@href, \'#tab-description\')]`.
Драйвер выполнит команду `click()`, затем получит значение атрибута `href` элемента `//a[contains(@href, \'#tab-description\')]`.

### Пример локатора со словарём:

```json
"sample_locator": {
  "attribute": {"href": "name"},
  ...
}
```

## События

Ключ `event` позволяет выполнить действие с веб-элементом до получения значения атрибута.

Примеры событий:

- `click()`: Клик на элемент.
- `screenshot()`: Возвращает веб-элемент как снимок экрана.
- `send_message()`: Отправляет сообщение веб-элементу через `%EXTERNAL_MESSAGE%`.

Пример использования `send_message()`:

```json
{
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "click();backspace(10);%EXTERNAL_MESSAGE%"
}
```

Эта последовательность выполняет следующие действия:

1. `click()`: Нажимает на веб-элемент (переводит фокус в поле ввода).
2. `backspace(10)`: Сдвигает каретку на 10 символов влево (очищает текст в поле ввода).
3. `%EXTERNAL_MESSAGE%`: Отправляет сообщение в поле ввода.

## Адаптация под разные версии сайта

Разметка страницы может меняться в зависимости от версии сайта (например, десктопная/мобильная версии). В таком случае рекомендуется хранить несколько файлов локаторов для каждой версии.

По умолчанию локаторы читаются из файла `product.json`. Чтобы изменить это, можно проверить URL в файле граббера страницы поставщика:

```python
    async def grab_page(self) -> ProductFields:
        ...
         = driver
        if 'ksp.co.il/mob' in d.current_url:  # <- бывет, что подключается к мобильной версии сайта
            self.locator = j_loads_ns(gs.path.src / 'suppliers' / 'ksp' / 'locators' / 'product_mobile_site.json')
        ...
```

## Расположение файлов локаторов

```text
src/
├── suppliers/
│   ├── suppliers_list/
│   │   ├── supplier_a/
│   │   │   ├── __init__.py
│   │   │   ├── handler.py  # <--- Модуль для supplier_a
│   │   │   └── locators/
│   │   │       └── category.json
│   │   ├── supplier_b/
│   │   │   ├── __init__.py
│   │   │   ├── handler.py  # <--- Модуль для supplier_b
│   │   │   └── locators/
│   │   │       └── category.json
│   │   └── ...
│   └── ...
└── ...