# Модуль `minibot`

## Обзор

Данный модуль представляет собой простой бот для Telegram, предназначенный для обслуживания запросов для сайта emil-design.com. Он обрабатывает текстовые сообщения, ссылки, голосовые сообщения, документы и некоторые команды. Бот взаимодействует с LLM-моделью Google Gemini для получения ответов на вопросы.

## Подробней

Модуль `minibot` работает с Telegram-ботом, который принимает сообщения от пользователей и обрабатывает их с помощью LLM-модели Google Gemini, сценариев и других функций.

* **Обработка текстовых сообщений:** Бот анализирует текст сообщения и определяет, является ли оно URL-адресом, командой или обычным текстом.
* **Обработка URL:** Если сообщение является URL-адресом, бот проверяет, является ли это URL с one-tab.com. Если да, то он извлекает информацию о товаре из URL и запускает соответствующий сценарий.
* **Обработка команд:** Бот распознает команды `/start`, `/help`, `/sendpdf`, `/info`, `/time`, `/photo` и предоставляет соответствующие ответы или действия.
* **Обработка голосовых сообщений:** Бот обрабатывает голосовые сообщения, транскрибируя их в текст (функция транскрибирования пока не реализована).
* **Обработка документов:** Бот обрабатывает документы, сохраняя их на локальном диске.
* **Взаимодействие с LLM:** Для ответов на текстовые сообщения бот использует Google Generative AI (Gemini).
* **Использование сценариев:** Бот использует сценарии для автоматизации определенных задач. 
* **Логирование:** Бот использует модуль `logger` из `src.logger` для записи информации о событиях, ошибках и предупреждениях.

## Классы

### `BotHandler`

**Описание**: Класс, отвечающий за обработку событий Telegram-бота.

**Атрибуты**:

- `base_dir (Path)`: Путь к базовому каталогу, в котором хранятся сценарии, активы и т.д.

**Методы**:

- `handle_message(bot, message)`: Обрабатывает текст сообщения.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Анализирует текст сообщения и вызывает соответствующий обработчик: `_send_user_flowchart`, `_handle_url`, `_handle_next_command` или отправляет сообщение с ответом от модели Google Gemini.
- `_send_user_flowchart(bot, chat_id)`: Отправляет пользователю схему user_flowchart.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `chat_id (int)`: ID чата пользователя.
    - **Действие**: Отправляет фотографию user_flowchart.png.
- `_handle_url(bot, message)`: Обрабатывает URL-адрес, отправленный пользователем.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Извлекает список URL с one-tab.com и запускает сценарий.
- `_handle_next_command(bot, message)`: Обрабатывает команду \'--next\' и её аналоги.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Отправляет случайный вопрос и ответ модели Google Gemini.
- `help_command(bot, message)`: Обрабатывает команду /help.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Отправляет сообщение с доступными командами.
- `send_pdf(bot, message, pdf_file)`: Обрабатывает команду /sendpdf для отправки PDF-файла.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
        - `pdf_file (str)`: Путь к PDF-файлу.
    - **Действие**: Отправляет PDF-файл.
- `handle_voice(bot, message)`: Обрабатывает голосовые сообщения.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Скачивает голосовое сообщение, транскрибирует его в текст и отправляет ответ.
- `_transcribe_voice(file_path)`: Транскрибирует голосовое сообщение (заглушка).
    - **Параметры**:
        - `file_path (str)`: Путь к файлу голосового сообщения.
    - **Действие**: Пока не реализована.
- `handle_document(bot, message)`: Обрабатывает полученные документы.
    - **Параметры**:
        - `bot (telebot.TeleBot)`: Экземпляр Telegram-бота.
        - `message (telebot.types.Message)`: Сообщение от пользователя.
    - **Действие**: Скачивает документ, сохраняет его на локальном диске и отправляет сообщение с подтверждением.


### `Config`

**Описание**: Класс для хранения конфигурации Telegram-бота.

**Атрибуты**:

- `BOT_TOKEN (str)`: Токен Telegram-бота.
- `CHANNEL_ID (str)`: ID канала, в который будут отправляться сообщения.
- `PHOTO_DIR (Path)`: Каталог с фотографиями.
- `COMMAND_INFO (str)`: Информация о доступных командах.
- `UNKNOWN_COMMAND_MESSAGE (str)`: Сообщение об неизвестной команде.
- `START_MESSAGE (str)`: Сообщение, которое отправляется при старте бота.
- `HELP_MESSAGE (str)`: Сообщение с описанием доступных команд.

## Функции

### `command_start(message)`

**Назначение**: Обрабатывает команду `/start`.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Отправляет сообщение с приветствием.

### `command_help(message)`

**Назначение**: Обрабатывает команду `/help`.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Вызывает `handler.help_command` для отправки сообщения с доступными командами.

### `command_info(message)`

**Назначение**: Обрабатывает команду `/info`.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Отправляет сообщение с информацией о боте.

### `command_time(message)`

**Назначение**: Обрабатывает команду `/time`.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Отправляет сообщение с текущим временем.

### `command_photo(message)`

**Назначение**: Обрабатывает команду `/photo`.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Отправляет случайную фотографию из каталога `config.PHOTO_DIR`.

### `handle_voice_message(message)`

**Назначение**: Обрабатывает голосовые сообщения.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Вызывает `handler.handle_voice` для обработки голосового сообщения.

### `handle_document_message(message)`

**Назначение**: Обрабатывает сообщения с документами.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Вызывает `handler.handle_document` для обработки документа.

### `handle_text_message(message)`

**Назначение**: Обрабатывает текстовые сообщения, не являющиеся командами.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Вызывает `handler.handle_message` для обработки текста сообщения.

### `handle_unknown_command(message)`

**Назначение**: Обрабатывает неизвестные команды.

**Параметры**:

- `message (telebot.types.Message)`: Сообщение от пользователя.

**Действие**: Отправляет сообщение об неизвестной команде.

## Параметры

- `ENDPOINT (str)`: Имя эндпоинта для бота.
- `USE_ENV (bool)`: Флаг, определяющий, использовать ли переменные окружения для конфигурации.

## Примеры

**Пример 1**: Запуск бота.

```python
# --- bot.py ---
config = Config()
handler = BotHandler()
bot = telebot.TeleBot(config.BOT_TOKEN)
...
bot.polling(none_stop=True)
# --- bot.py end ---
```

**Пример 2**: Отправка команды `/help`.

```python
# Пользователь отправляет команду `/help`.
# Бот обрабатывает команду и отправляет сообщение с доступными командами.
```

**Пример 3**: Отправка URL с one-tab.com.

```python
# Пользователь отправляет URL с one-tab.com.
# Бот извлекает список URL с one-tab.com и запускает сценарий.
```

**Пример 4**: Отправка голосового сообщения.

```python
# Пользователь отправляет голосовое сообщение.
# Бот скачивает голосовое сообщение, транскрибирует его в текст и отправляет ответ.
```

**Пример 5**: Отправка документа.

```python
# Пользователь отправляет документ.
# Бот скачивает документ, сохраняет его на локальном диске и отправляет сообщение с подтверждением.