# Модуль для работы с API you.com

## Обзор

Модуль предназначен для взаимодействия с API you.com с целью получения ответов на запросы, используя предоставленные сообщения и параметры. Он включает в себя преобразование формата сообщений, формирование запроса и обработку потоковых данных от API.

## Подробней

Этот модуль используется для отправки запросов к API you.com и получения ответов в режиме реального времени. Он преобразует структуру сообщений, отправляемых пользователем, в формат, ожидаемый API, и обрабатывает потоковые данные, возвращаемые сервером. Модуль также включает обработку ошибок и повторные попытки в случае сбоев.

## Классы

В данном модуле классы отсутствуют

## Функции

### `transform`

```python
def transform(messages: list) -> list:
    """
    Преобразует список сообщений в формат, ожидаемый API you.com.

    Args:
        messages (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами 'role' и 'content'.

    Returns:
        list: Список преобразованных сообщений, где каждое сообщение представляет собой словарь с ключами 'question' и 'answer'.

    Как работает функция:
    - Инициализирует пустой список `result` для хранения преобразованных сообщений.
    - Использует цикл `while` для итерации по списку `messages`.
    - Если роль сообщения 'user', извлекает вопрос и пытается найти следующий ответ от 'assistant'.
    - Если роль сообщения 'assistant', добавляет сообщение с ответом и пустым вопросом.
    - Если роль сообщения 'system', добавляет сообщение с вопросом и пустым ответом.

    Примеры:
        >>> messages = [{'role': 'user', 'content': 'Привет'}, {'role': 'assistant', 'content': 'Здравствуйте'}]
        >>> transform(messages)
        [{'question': 'Привет', 'answer': 'Здравствуйте'}]

        >>> messages = [{'role': 'user', 'content': 'Как дела?'}]
        >>> transform(messages)
        [{'question': 'Как дела?', 'answer': ''}]

        >>> messages = [{'role': 'assistant', 'content': 'Все хорошо'}]
        >>> transform(messages)
        [{'question': '', 'answer': 'Все хорошо'}]
    """
    result = []
    i = 0

    while i < len(messages):
        if messages[i]['role'] == 'user':
            question = messages[i]['content']
            i += 1

            if i < len(messages) and messages[i]['role'] == 'assistant':
                answer = messages[i]['content']
                i += 1
            else:
                answer = ''

            result.append({'question': question, 'answer': answer})

        elif messages[i]['role'] == 'assistant':
            result.append({'question': '', 'answer': messages[i]['content']})
            i += 1

        elif messages[i]['role'] == 'system':
            result.append({'question': messages[i]['content'], 'answer': ''})
            i += 1
            
    return result

### `output`

```python
def output(chunk):
    """
    Обрабатывает полученный чанк данных от API you.com, извлекая и выводя токен чата.

    Args:
        chunk (bytes): Чанк данных, полученный от API.

    Как работает функция:
    - Проверяет, содержит ли чанк строку `b'"youChatToken"'`.
    - Если содержит, декодирует чанк, разделяет его по строке `'data: '`, загружает JSON из второй части и выводит значение ключа `'youChatToken'`.

    Примеры:
    Предположим, `chunk` содержит: `b'data: {"youChatToken": "example_token"}'`

    >>> output(b'data: {"youChatToken": "example_token"}')
    example_token
    """
    if b'"youChatToken"' in chunk:
        chunk_json = json.loads(chunk.decode().split('data: ')[1])

        print(chunk_json['youChatToken'], flush=True, end = '')
```

## Переменные модуля

- `config`: Загружает конфигурацию из аргументов командной строки в формате JSON.
- `messages`: Извлекает список сообщений из конфигурации.
- `prompt`: Инициализируется пустой строкой и обновляется последним сообщением пользователя.
- `headers`: Словарь, содержащий заголовки HTTP-запроса.
- `params`: Строка, содержащая параметры запроса, закодированные в формате URL.

## Принцип работы модуля

1. **Загрузка конфигурации**: Модуль начинает с загрузки конфигурации из аргументов командной строки, используя `json.loads(sys.argv[1])`. Эта конфигурация содержит список сообщений для отправки в API you.com.
2. **Преобразование сообщений**: Функция `transform(messages)` преобразует список сообщений в формат, ожидаемый API you.com. Она обрабатывает сообщения с ролями 'user', 'assistant' и 'system', формируя список словарей с ключами 'question' и 'answer'.
3. **Формирование заголовков и параметров запроса**:
   - Определяются необходимые HTTP-заголовки, такие как `Content-Type`, `Accept`, `User-Agent` и другие.
   - Если последнее сообщение имеет роль 'user', его содержимое извлекается в переменную `prompt`, а сообщение удаляется из списка `messages`.
   - Параметры запроса формируются с использованием `urllib.parse.urlencode`, включая вопрос (`q`), домен (`domain`) и преобразованный список сообщений (`chat`).
4. **Отправка запроса и обработка ответа**:
   - В цикле `while True` модуль пытается отправить GET-запрос к API you.com с использованием библиотеки `curl_cffi`.
   - Функция `output(chunk)` вызывается для каждого полученного чанка данных. Она извлекает и выводит токен чата (`youChatToken`) из чанка, если он присутствует.
   - В случае успеха запроса, программа завершается с кодом 0.
5. **Обработка ошибок и повторные попытки**:
   - Если во время запроса возникает исключение, оно перехватывается, и в консоль выводится сообщение об ошибке с последующей повторной попыткой.

## Примеры

**Пример использования модуля:**

Предположим, что `sys.argv[1]` содержит JSON:

```json
{
    "messages": [
        {"role": "user", "content": "Привет"},
        {"role": "assistant", "content": "Здравствуйте"}
    ]
}
```

Тогда модуль выполнит следующие действия:

1. Загрузит конфигурацию.
2. Преобразует сообщения в формат `[{'question': 'Привет', 'answer': 'Здравствуйте'}]`.
3. Сформирует параметры запроса.
4. Отправит GET-запрос к API you.com.
5. Выведет полученный токен чата.