# Модуль для взаимодействия с Bing Chat
## Обзор

Модуль предоставляет функциональность для взаимодействия с Bing Chat, включая создание диалогов и генерацию ответов на основе предоставленных подсказок. Он использует асинхронные запросы для обеспечения эффективной работы и поддерживает потоковую передачу данных.
Модуль содержит настройки по умолчанию для запросов к Bing.

## Подробнее

Модуль `Bing.py` предназначен для интеграции с сервисом Bing Chat и позволяет генерировать ответы на запросы пользователей, используя возможности искусственного интеллекта. Он включает в себя функции для создания новых диалогов, форматирования сообщений и выполнения потоковой генерации ответов.

## Классы

### `optionsSets`

**Описание**: Класс, предназначенный для хранения наборов опций, используемых при взаимодействии с Bing Chat.

**Атрибуты**:
- `optionSet` (dict): Словарь, определяющий структуру набора опций. Содержит типы данных для ключей `tone` (str) и `optionsSets` (list).
- `jailbreak` (dict): Словарь, содержащий набор опций `optionsSets` для "обхода ограничений".

**Принцип работы**:
Класс `optionsSets` предназначен для организации и хранения различных наборов опций, которые могут быть использованы при запросах к Bing Chat. Он содержит два атрибута: `optionSet`, который определяет общую структуру набора опций, и `jailbreak`, который содержит специфический набор опций, предназначенный для изменения поведения Bing Chat.

### `Defaults`

**Описание**: Класс, содержащий значения по умолчанию для различных параметров, используемых в модуле.

**Атрибуты**:
- `delimiter` (str): Разделитель сообщений.
- `ip_address` (str): IP-адрес.
- `allowedMessageTypes` (list): Список допустимых типов сообщений.
- `sliceIds` (list): Список идентификаторов.
- `location` (dict): Информация о местоположении.

**Принцип работы**:
Класс `Defaults` используется для хранения значений по умолчанию, которые применяются при создании и отправке запросов к Bing Chat. Он содержит статические атрибуты, такие как разделитель сообщений, IP-адрес, списки допустимых типов сообщений и идентификаторов, а также информацию о местоположении. Эти значения используются для настройки запросов и обеспечения корректной работы модуля.

## Функции

### `_format`

```python
def _format(msg: dict) -> str:
    """
    Форматирует сообщение в JSON-формате с добавлением разделителя.

    Args:
        msg (dict): Словарь, представляющий сообщение.

    Returns:
        str: JSON-представление сообщения с добавленным разделителем.
    """
    ...
```

**Назначение**: Преобразует словарь `msg` в JSON-строку и добавляет разделитель `Defaults.delimiter` в конце.

**Параметры**:
- `msg` (dict): Словарь, который необходимо отформатировать в JSON.

**Возвращает**:
- `str`: JSON-представление словаря `msg` с добавленным разделителем.

**Как работает функция**:
Функция `_format` принимает словарь `msg`, преобразует его в JSON-строку с использованием `json.dumps`, убедившись, что символы Unicode не экранируются (`ensure_ascii=False`). Затем к полученной строке добавляется разделитель `Defaults.delimiter`.

**Примеры**:

```python
message = {'text': 'Hello'}
formatted_message = _format(message)
print(formatted_message)  # Пример вывода: {"text": "Hello"}\x1e
```

### `create_conversation`

```python
async def create_conversation():
    """
    Создает разговор с Bing Chat и возвращает идентификаторы.

    Returns:
        tuple: Кортеж, содержащий conversationId, clientId и conversationSignature.

    Raises:
        Exception: Если не удается создать разговор после нескольких попыток.
    """
    ...
```

**Назначение**: Функция создает новый разговор с Bing Chat, запрашивая необходимые идентификаторы.

**Возвращает**:
- `tuple`: Кортеж, содержащий `conversationId` (идентификатор разговора), `clientId` (идентификатор клиента) и `conversationSignature` (подпись разговора).

**Вызывает исключения**:
- `Exception`: Вызывается, если не удается создать разговор после 5 попыток.

**Как работает функция**:
Функция `create_conversation` выполняет несколько попыток (до 5) для создания нового разговора с Bing Chat. Для этого отправляется GET-запрос к `https://www.bing.com/turing/conversation/create` с определенными заголовками, включая поддельный IP-адрес. Если после нескольких попыток не удается получить `conversationId`, `clientId` и `conversationSignature`, вызывается исключение.

**Примеры**:

```python
conversation_data = asyncio.run(create_conversation())
print(conversation_data)  # Пример вывода: ('67d6431a-4a0a-424d-ba56-a19c6e5c91e1', '1234567890', 'signature')
```

### `stream_generate`

```python
async def stream_generate(prompt: str, mode: optionsSets.optionSet = optionsSets.jailbreak, context: bool or str = False):
    """
    Генерирует ответ от Bing Chat в потоковом режиме.

    Args:
        prompt (str): Текст запроса.
        mode (optionsSets.optionSet): Набор опций. По умолчанию optionsSets.jailbreak.
        context (bool | str): Контекст для запроса. По умолчанию False.

    Yields:
        str: Части ответа от Bing Chat.

    Raises:
        Exception: Если возникает ошибка при получении ответа от Bing Chat.
    """
    ...
```

**Назначение**: Генерирует ответ от Bing Chat в потоковом режиме на основе предоставленного запроса и контекста.

**Параметры**:
- `prompt` (str): Текст запроса, который отправляется в Bing Chat.
- `mode` (optionsSets.optionSet): Набор опций, определяющих режим работы Bing Chat (например, `optionsSets.jailbreak`). По умолчанию используется `optionsSets.jailbreak`.
- `context` (bool | str): Контекст для запроса, который может быть использован Bing Chat для формирования ответа. По умолчанию `False`.

**Yields**:
- `str`: Части ответа от Bing Chat, генерируемые в потоковом режиме.

**Вызывает исключения**:
- `Exception`: Вызывается, если возникает ошибка при получении ответа от Bing Chat.

**Как работает функция**:
1.  **Создание соединения**:
    *   Устанавливает соединение с сервером Bing Chat по WebSocket.
    *   Использует `aiohttp.ClientSession` для управления асинхронными HTTP-запросами и WebSocket-соединениями.
    *   Применяет SSL-контекст для безопасного соединения.
2.  **Аутентификация и настройка**:
    *   Получает `conversationId`, `clientId` и `conversationSignature` с помощью функции `create_conversation`.
    *   Отправляет начальное сообщение для установления протокола соединения.
3.  **Формирование запроса**:
    *   Создает структуру запроса (`struct`), включающую текст запроса (`prompt`), идентификаторы разговора и клиента, а также параметры режима (`mode`).
    *   Если предоставлен контекст (`context`), добавляет его в структуру запроса.
4.  **Отправка запроса и получение ответа**:
    *   Отправляет запрос на сервер Bing Chat через WebSocket.
    *   Получает сообщения от сервера в цикле до тех пор, пока не будет получен финальный ответ.
    *   Обрабатывает полученные сообщения, извлекая текст ответа и формируя потоковый вывод.
5.  **Обработка ошибок**:
    *   Проверяет наличие ошибок в полученных сообщениях и вызывает исключение в случае их обнаружения.
6.  **Завершение соединения**:
    *   Закрывает WebSocket-соединение и HTTP-сессию после получения финального ответа.

**Примеры**:

```python
async def main():
    prompt = "Напиши стихотворение о весне."
    async for response_chunk in stream_generate(prompt):
        print(response_chunk, end="")

asyncio.run(main())
```

### `run`

```python
def run(generator):
    """
    Запускает асинхронный генератор и возвращает его значения.

    Args:
        generator: Асинхронный генератор.

    Yields:
        Any: Значения, генерируемые асинхронным генератором.
    """
    ...
```

**Назначение**: Запускает асинхронный генератор и возвращает его значения.

**Параметры**:
- `generator`: Асинхронный генератор, который необходимо запустить.

**Yields**:
- `Any`: Значения, генерируемые асинхронным генератором.

**Как работает функция**:
Функция `run` принимает асинхронный генератор, создает цикл событий и итерируется по генератору, возвращая каждое полученное значение. Цикл завершается, когда генератор выбрасывает исключение `StopAsyncIteration`.

**Примеры**:

```python
async def my_generator():
    yield "Hello"
    yield "World"

for value in run(my_generator()):
    print(value)
```

### `convert`

```python
def convert(messages):
    """
    Преобразует список сообщений в строку контекста.

    Args:
        messages (list): Список сообщений, где каждое сообщение содержит 'role' и 'content'.

    Returns:
        str: Строка контекста, сформированная из сообщений.
    """
    ...
```

**Назначение**: Преобразует список сообщений в строку контекста для Bing Chat.

**Параметры**:
- `messages` (list): Список сообщений, где каждое сообщение является словарем с ключами `'role'` (роль) и `'content'` (содержимое).

**Возвращает**:
- `str`: Строка контекста, сформированная из сообщений, разделенных символами новой строки.

**Как работает функция**:
Функция `convert` принимает список сообщений и преобразует его в строку контекста, пригодную для использования в запросах к Bing Chat. Она итерируется по списку сообщений и формирует строку, добавляя роль и содержимое каждого сообщения, разделенные символами новой строки.

**Примеры**:

```python
messages = [
    {'role': 'user', 'content': 'Hello'},
    {'role': 'bot', 'content': 'Hi there'}
]
context = convert(messages)
print(context)
# Вывод:
# [user](#message)
# Hello
#
# [bot](#message)
# Hi there
#
```

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос к Bing Chat и возвращает ответ в виде генератора.

    Args:
        model (str): Модель для генерации ответа.
        messages (list): Список сообщений для контекста.
        stream (bool): Флаг потоковой передачи данных.
        **kwargs: Дополнительные параметры.

    Yields:
        str: Части ответа от Bing Chat.
    """
    ...
```

**Назначение**: Функция создает запрос к Bing Chat и возвращает ответ в виде генератора.

**Параметры**:
- `model` (str): Модель, используемая для генерации ответа.
- `messages` (list): Список сообщений, представляющих контекст разговора.
- `stream` (bool): Флаг, указывающий, следует ли возвращать ответ в потоковом режиме.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Yields**:
- `str`: Части ответа, полученные от Bing Chat.

**Как работает функция**:
1.  **Извлечение запроса и контекста**:
    *   Определяет, является ли это первый запрос (если в списке сообщений меньше двух элементов) или продолжение разговора.
    *   Извлекает текст запроса из последнего сообщения в списке.
    *   Формирует контекст разговора, преобразуя предыдущие сообщения в строку с использованием функции `convert`.
2.  **Генерация ответа**:
    *   Вызывает функцию `stream_generate` для получения ответа от Bing Chat в потоковом режиме.
    *   Итерируется по генератору `stream_generate` и возвращает каждую часть ответа.

**Примеры**:

```python
messages = [
    {'role': 'user', 'content': 'Напиши стихотворение о лете.'}
]
for token in _create_completion('gpt-4', messages, True):
    print(token, end='')
```

## Переменные

### `params`

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    '(%s)' % ', '.join(
        [f"{name}: {get_type_hints(_create_completion)[name].__name__}" for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])
```

**Назначение**: Строка, содержащая информацию о поддержке параметров функцией `_create_completion`.

**Описание**:
Переменная `params` формируется как строка, указывающая, какие параметры поддерживаются функцией `_create_completion`. Она включает имя файла модуля (без расширения `.py`) и список параметров с их типами.
В данном случае `params` содержит информацию о том, какие параметры поддерживает функция `_create_completion`, включая их имена и типы данных, извлеченные с помощью `get_type_hints`.