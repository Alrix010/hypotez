# Модуль для работы с Backend API

## Обзор

Этот модуль предоставляет API для взаимодействия с моделями G4F (например, ChatGPT) и DuckDuckGo, включая поддержку jailbreak, прокси и потоковой передачи данных.

## Подробней

Модуль содержит класс `Backend_Api`, который обрабатывает запросы к API, строит сообщения для моделей, получает результаты поиска в интернете и генерирует потоковые ответы. Также определены функции для обработки jailbreak инструкций и настройки языка ответа.

## Классы

### `Backend_Api`

**Описание**: Класс для управления API backend'а.

**Атрибуты**:

- `app`: Flask-приложение.
- `use_auto_proxy` (bool): Флаг, указывающий на необходимость использования автоматического прокси.
- `routes` (dict): Словарь, содержащий маршруты API и соответствующие функции.

**Методы**:

- `__init__(self, app, config: dict) -> None`: Инициализирует экземпляр класса `Backend_Api`.
- `_conversation(self)`: Обрабатывает запросы на ведение беседы.

### `Backend_Api.__init__`

```python
def __init__(self, app, config: dict) -> None:
    """
    Инициализирует экземпляр класса Backend_Api.

    Args:
        app: Flask-приложение.
        config (dict): Словарь конфигурации.

    Returns:
        None

    Пример:
        backend_api = Backend_Api(app, config)
    """
    ...
```

**Назначение**: Инициализирует класс `Backend_Api`, настраивает маршруты и запускает обновление прокси (если это необходимо).

**Параметры**:

- `app`: Flask-приложение.
- `config` (dict): Словарь конфигурации, содержащий настройки, такие как `use_auto_proxy`.

**Как работает функция**:

- Сохраняет ссылку на Flask-приложение `app`.
- Извлекает значение `use_auto_proxy` из переданного словаря `config`.
- Определяет маршруты API в словаре `self.routes`, связывая URL-адреса с соответствующими функциями обработки запросов (`self._conversation`).
- Если `self.use_auto_proxy` имеет значение `True`, создает и запускает поток для периодического обновления списка рабочих прокси-серверов.

### `Backend_Api._conversation`

```python
def _conversation(self):
    """
    Обрабатывает запросы на ведение беседы.

    Args:
        None

    Returns:
        Flask.response_class: Потоковый ответ или словарь с ошибкой и кодом состояния.

    Raises:
        Exception: Если возникает ошибка при обработке запроса.

    Пример:
        response = self._conversation()
    """
    ...
```

**Назначение**: Обрабатывает запрос на создание диалога с использованием G4F, включая обработку параметров, сборку сообщений и генерацию потокового ответа.

**Параметры**:
- None

**Возвращает**:
- `Flask.response_class`: Потоковый ответ или словарь с информацией об ошибке и кодом состояния HTTP.

**Вызывает исключения**:
- `Exception as ex`: Если во время обработки запроса возникает ошибка.

**Как работает функция**:
- Извлекает параметры запроса из объекта `request.json`, такие как `stream` (потоковая передача), `jailbreak` и `model` (модель G4F).
- Вызывает функцию `build_messages` для создания списка сообщений для отправки в G4F.
- Вызывает `ChatCompletion.create` для получения ответа от G4F.
- Возвращает потоковый ответ, используя функцию `generate_stream`, или информацию об ошибке в случае возникновения исключения.

## Функции

### `build_messages`

```python
def build_messages(jailbreak):
    """
    Создает список сообщений для отправки в G4F.

    Args:
        jailbreak: Инструкции для "взлома" модели.

    Returns:
        list: Список сообщений для G4F.

    Пример:
        messages = build_messages(jailbreak='test_jailbreak')
    """
    ...
```

**Назначение**: Строит список сообщений для отправки в модель G4F, включая системное сообщение, историю разговоров, результаты поиска в интернете (если разрешено) и инструкции jailbreak (если разрешено).

**Параметры**:

- `jailbreak`: Инструкции для "взлома" модели.

**Возвращает**:
- `list`: Список сообщений, подготовленный для отправки в G4F.

**Как работает функция**:

- Извлекает данные из объекта `request.json`, такие как историю разговоров, параметры и флаг доступа к интернету.
- Формирует системное сообщение, включающее текущую дату и настройки языка ответа.
- Добавляет в список сообщений историю разговоров.
- Если доступ в интернет разрешен, получает результаты поиска и добавляет их в список сообщений.
- Если указаны инструкции jailbreak, добавляет их в список сообщений.
- Добавляет в список сообщений запрошенную подсказку.
- Обрезает список сообщений до последних 13, чтобы избежать ошибок, связанных с ограничением количества токенов API.

### `fetch_search_results`

```python
def fetch_search_results(query):
    """
    Выполняет поиск в интернете и возвращает результаты.

    Args:
        query (str): Поисковый запрос.

    Returns:
        list: Список результатов поиска.

    Пример:
        results = fetch_search_results(query='latest news')
    """
    ...
```

**Назначение**: Выполняет поиск в интернете, используя DuckDuckGo API, и возвращает результаты в формате, подходящем для добавления в список сообщений для G4F.

**Параметры**:

- `query` (str): Поисковый запрос.

**Возвращает**:
- `list`: Список результатов поиска, каждый из которых содержит роль `system` и содержимое в виде сниппетов и URL-адресов.

**Как работает функция**:

- Выполняет GET-запрос к DuckDuckGo API с поисковым запросом и ограничением на количество результатов (5).
- Преобразует результаты поиска в формат, пригодный для включения в список сообщений, формируя сниппеты и URL-адреса.
- Возвращает список, содержащий один элемент: словарь с ролью `system` и содержимым, включающим все сниппеты и URL-адреса.

### `generate_stream`

```python
def generate_stream(response, jailbreak):
    """
    Генерирует потоковый ответ.

    Args:
        response: Ответ от G4F.
        jailbreak: Инструкции для "взлома" модели.

    Yields:
        str: Часть ответа.

    Пример:
        for message in generate_stream(response, jailbreak='test_jailbreak'):
            print(message)
    """
    ...
```

**Назначение**: Генерирует поток сообщений из ответа модели G4F, обрабатывая инструкции jailbreak, если они включены.

**Параметры**:

- `response`: Ответ от G4F.
- `jailbreak`: Инструкции для "взлома" модели.

**Возвращает**:
- `Generator[str, None, None]`: Генератор, выдающий части ответа в виде строк.

**Как работает функция**:

- Если jailbreak включен, проверяет, успешно ли применены инструкции jailbreak, и возвращает только те сообщения, которые соответствуют jailbreak.
- Если jailbreak не включен, возвращает исходный ответ без изменений.

#### Внутренние функции:
- `response_jailbroken_success(response: str) -> bool`: Проверяет, успешно ли применены инструкции jailbreak.
- `response_jailbroken_failed(response)`: Проверяет, не провалилось ли применение инструкций jailbreak.

### `response_jailbroken_success`

```python
def response_jailbroken_success(response: str) -> bool:
    """
    Проверяет, успешно ли применены инструкции jailbreak.

    Args:
        response (str): Ответ от G4F.

    Returns:
        bool: True, если инструкции jailbreak применены успешно, иначе False.

    Пример:
        is_success = response_jailbroken_success(response='ACT: test')
    """
    ...
```

**Назначение**: Определяет, содержит ли ответ от модели признаки успешного применения инструкций jailbreak.

**Параметры**:

- `response` (str): Строка ответа от модели.

**Возвращает**:
- `bool`: `True`, если в ответе обнаружены признаки успешного применения jailbreak, и `False` в противном случае.

**Как работает функция**:

- Использует регулярное выражение `r'ACT:'` для поиска в строке ответа.
- Возвращает `True`, если соответствие найдено, что указывает на успешное применение инструкций jailbreak. В противном случае возвращает `False`.

### `response_jailbroken_failed`

```python
def response_jailbroken_failed(response):
    """
    Проверяет, не провалилось ли применение инструкций jailbreak.

    Args:
        response: Ответ от G4F.

    Returns:
        bool: True, если применение инструкций jailbreak провалилось, иначе False.

    Пример:
       is_failed = response_jailbroken_failed(response='test')
    """
    ...
```

**Назначение**: Определяет, не содержит ли ответ от модели признаки неудачи при применении инструкций jailbreak.

**Параметры**:

- `response`: Ответ от G4F.

**Возвращает**:
- `bool`: `True`, если ответ не начинается с "GPT:" или "ACT:", что указывает на неудачу, и `False` в противном случае.

**Как работает функция**:

- Проверяет, начинается ли ответ со строк "GPT:" или "ACT:".
- Возвращает `True`, если длина ответа больше 4 символов и при этом ответ не начинается ни с "GPT:", ни с "ACT:".

### `set_response_language`

```python
def set_response_language(prompt):
    """
    Определяет язык запроса и устанавливает его для ответа.

    Args:
        prompt: Запрос пользователя.

    Returns:
        str: Строка с указанием языка ответа.

    Пример:
        language_setting = set_response_language(prompt='Привет')
    """
    ...
```

**Назначение**: Определяет язык запроса и возвращает строку, указывающую модели G4F, на каком языке следует отвечать.

**Параметры**:

- `prompt`: Запрос пользователя, содержащий текст для определения языка.

**Возвращает**:
- `str`: Строка, содержащая инструкцию для модели G4F отвечать на определенном языке.

**Как работает функция**:

- Использует `googletrans.Translator` для определения языка запроса.
- Формирует строку с инструкцией для модели G4F отвечать на определенном языке.

### `isJailbreak`

```python
def isJailbreak(jailbreak):
    """
    Определяет, включены ли инструкции jailbreak.

    Args:
        jailbreak: Имя jailbreak.

    Returns:
        list | None: Инструкции jailbreak, если они включены, иначе None.

    Пример:
        jailbreak_instructions = isJailbreak(jailbreak='test_jailbreak')
    """
    ...
```

**Назначение**: Проверяет, включены ли инструкции jailbreak, и возвращает их, если они есть.

**Параметры**:

- `jailbreak`: Имя jailbreak.

**Возвращает**:
- `list | None`: Список инструкций jailbreak, если они есть в `special_instructions`, и `None` в противном случае.

**Как работает функция**:

- Проверяет, отличается ли значение `jailbreak` от "Default".
- Если `jailbreak` отличается от "Default", возвращает соответствующие инструкции из словаря `special_instructions`, если они там есть.
- Если `jailbreak` равно "Default" или соответствующий ключ отсутствует в `special_instructions`, возвращает `None`.