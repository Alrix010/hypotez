# Модуль backend.py

## Обзор

Модуль `backend.py` предоставляет API для взаимодействия с G4F (Generative Artificial Intelligence Framework) для создания диалогов, используя различные модели и техники, такие как jailbreak. Он включает в себя функциональность для автоматического управления прокси, обработки сообщений, поиска в интернете и установки языка ответа.

## Подробнее

Этот модуль является частью серверной логики приложения, обрабатывая запросы на создание диалогов. Он использует Flask для определения конечных точек API и предоставляет функциональность для стриминга ответов, использования прокси и применения техник "jailbreak" для изменения поведения модели.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` инкапсулирует API для создания диалогов. Он инициализируется с Flask-приложением и конфигурацией, определяющей использование автоматического прокси.

**Атрибуты**:

- `app`: Flask-приложение.
- `use_auto_proxy` (bool): Указывает, следует ли использовать автоматическое прокси.
- `routes` (dict): Словарь, определяющий маршруты API и связанные с ними функции и методы.

**Методы**:

- `__init__(self, app, config: dict) -> None`: Инициализирует экземпляр `Backend_Api`, настраивает маршруты и запускает поток для обновления прокси, если это необходимо.
- `_conversation(self)`: Обрабатывает запросы на создание диалогов, используя предоставленные параметры, такие как модель, сообщения и jailbreak. Возвращает стриминговый ответ или сообщение об ошибке.

## Методы класса

### `__init__(self, app, config: dict) -> None`

**Назначение**: Инициализирует экземпляр класса `Backend_Api`.

**Параметры**:

- `app`: Flask-приложение.
- `config` (dict): Словарь конфигурации, содержащий настройки, такие как `use_auto_proxy`.

**Как работает функция**:
- Функция сохраняет Flask-приложение и настройки конфигурации в атрибутах экземпляра класса.
- Определяет маршруты API в словаре `self.routes`, связывая URL с соответствующими функциями и методами.
- Если включено использование автоматического прокси (`self.use_auto_proxy` равно `True`), функция запускает поток для периодического обновления рабочих прокси.

### `_conversation(self)`

**Назначение**: Обрабатывает запросы на создание диалогов.

**Как работает функция**:
- Извлекает параметры запроса, такие как `stream` (потоковая передача), `jailbreak` и `model` (модель).
- Вызывает функцию `build_messages` для создания сообщений на основе параметров запроса.
- Вызывает `ChatCompletion.create` для генерации ответа с использованием выбранной модели и сообщений.
- Возвращает стриминговый ответ, генерируемый функцией `generate_stream`, или сообщение об ошибке в случае исключения.

**Параметры**:

- Отсутствуют, использует `request` из Flask для получения данных из запроса.

**Возвращает**:

- Flask `response_class` со стриминговым ответом (`text/event-stream`) в случае успеха.
- Словарь с информацией об ошибке и кодом состояния HTTP 400 в случае неудачи.

**Вызывает исключения**:

- `Exception` - если во время обработки запроса или генерации ответа возникает ошибка. Информация об ошибке возвращается клиенту.

**Пример**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# response = Backend_Api(app, config)._conversation()
```

## Функции

### `build_messages(jailbreak)`

**Назначение**: Создает список сообщений для диалога на основе параметров запроса.

**Параметры**:

- `jailbreak`: Строка, определяющая используемый "jailbreak" (технику обхода ограничений модели).

**Возвращает**:

- Список сообщений, готовый для использования в `ChatCompletion.create`.

**Как работает функция**:
- Извлекает данные из объекта `request.json`, включая историю разговора (`_conversation`), флаг доступа к интернету (`internet_access`) и текст запроса (`prompt`).
- Создает системное сообщение, включающее текущую дату и язык ответа.
- Добавляет существующую историю разговора.
- Если разрешен доступ к интернету, добавляет результаты поиска из функции `fetch_search_results`.
- Если включен "jailbreak", добавляет соответствующие инструкции.
- Добавляет текст запроса.
- Ограничивает размер разговора, чтобы избежать ошибок, связанных с количеством токенов API.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# messages = build_messages(jailbreak="Default")
```

### `fetch_search_results(query)`

**Назначение**: Выполняет поиск в интернете и возвращает результаты в формате, пригодном для добавления в разговор.

**Параметры**:

- `query` (str): Текст поискового запроса.

**Возвращает**:

- Список, содержащий словарь с результатами поиска в формате, подходящем для добавления в разговор.

**Как работает функция**:
- Выполняет GET-запрос к API DuckDuckGo для поиска в интернете.
- Форматирует результаты поиска, добавляя URL и краткое описание каждого результата.
- Возвращает список с результатами поиска в формате, подходящем для добавления в разговор.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# results = fetch_search_results(query="Что такое Python?")
```

### `generate_stream(response, jailbreak)`

**Назначение**: Генерирует стриминговый ответ на основе предоставленного ответа и jailbreak.

**Параметры**:

- `response`: Ответ от API модели.
- `jailbreak`: Строка, определяющая используемый "jailbreak".

**Возвращает**:

- Генератор, выдающий части ответа.

**Как работает функция**:
- Если "jailbreak" включен, функция проверяет, был ли ответ успешно "взломан".
- Если "jailbreak" не включен, функция просто выдает части ответа.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# stream = generate_stream(response, jailbreak="Default")
# for message in stream:
#     print(message)
```

### `response_jailbroken_success(response: str) -> bool`

**Назначение**: Проверяет, был ли ответ успешно "взломан".

**Параметры**:

- `response` (str): Ответ от API модели.

**Возвращает**:

- `True`, если ответ содержит маркер успешного "взлома" (например, "ACT:").
- `False` в противном случае.

**Как работает функция**:
- Использует регулярное выражение для поиска маркера успешного "взлома" в ответе.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# success = response_jailbroken_success(response="ACT: Hello, world!")
```

### `response_jailbroken_failed(response)`

**Назначение**: Проверяет, не произошла ли ошибка при "взломе" ответа.

**Параметры**:

- `response`: Ответ от API модели.

**Возвращает**:

- `False`, если длина ответа меньше 4 символов, или если ответ начинается с "GPT:" или "ACT:".
- `True` в противном случае.

**Как работает функция**:
- Проверяет длину ответа и наличие маркеров начала ответа.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# failed = response_jailbroken_failed(response="Hello")
```

### `set_response_language(prompt)`

**Назначение**: Определяет язык ответа на основе текста запроса.

**Параметры**:

- `prompt`: Текст запроса.

**Возвращает**:

- Строку, указывающую, на каком языке должен быть ответ.

**Как работает функция**:
- Использует `googletrans.Translator` для определения языка запроса.
- Формирует строку, указывающую язык ответа.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# language = set_response_language(prompt={"content": "Привет, мир!"})
```

### `isJailbreak(jailbreak)`

**Назначение**: Проверяет, включен ли "jailbreak", и возвращает соответствующие инструкции.

**Параметры**:

- `jailbreak`: Строка, определяющая используемый "jailbreak".

**Возвращает**:

- Инструкции "jailbreak" из `special_instructions`, если "jailbreak" включен.
- `None`, если "jailbreak" не включен (значение "Default").

**Как работает функция**:
- Проверяет, равно ли значение `jailbreak` "Default".
- Если нет, возвращает инструкции из словаря `special_instructions`.

**Примеры**:

```python
# Пример вызова функции (не выполняется в коде, демонстрирует вызов)
# instructions = isJailbreak(jailbreak="Special")
```