# Модуль backend.py
## Обзор

Данный модуль реализует бэкэнд API для взаимодействия с языковой моделью. Он предоставляет конечную точку `/backend-api/v2/conversation` для обработки запросов на общение с моделью, включая поддержку потоковой передачи ответов и обработку jailbreak-инструкций. 

## Подробности

Модуль `backend.py` реализует API для взаимодействия с языковой моделью, предоставляя возможности для общения с ней через HTTP-запросы. 

### Класс `Backend_Api`

```python
class Backend_Api:
    """
    Класс для реализации бэкэнд API для взаимодействия с языковой моделью. 

    Attributes:
        app (Flask app): Экземпляр Flask приложения.
        use_auto_proxy (bool): Флаг, указывающий на использование автоматического прокси.
        routes (dict): Словарь с маршрутами API, где ключ - путь, а значение - словарь с функцией обработки и HTTP-методами.

    Methods:
        _conversation(): Обрабатывает запросы на общение с языковой моделью.
    """
    def __init__(self, app, config: dict) -> None:
        """
        Инициализирует класс `Backend_Api`.

        Args:
            app (Flask app): Экземпляр Flask приложения.
            config (dict): Словарь с конфигурацией приложения.
        """
        ...

    def _conversation(self):
        """
        Обрабатывает запросы на общение с языковой моделью, генерирует ответ и возвращает его в виде потока событий.

        Returns:
            flask.Response: Объект ответа Flask с данными в формате потока событий.
        """
        ...

```

#### Метод `_conversation`
**Назначение**: Обрабатывает запросы на общение с языковой моделью, генерирует ответ и возвращает его в виде потока событий.

**Параметры**: Отсутствуют

**Возвращает**: `flask.Response`: Объект ответа Flask с данными в формате потока событий.

**Вызывает исключения**:
- `Exception`: Возникает при ошибке во время обработки запроса.

**Как работает функция**:
- Извлекает данные из тела HTTP-запроса, включая настройки jailbreak, модель, поток (`streaming`) и сообщения (`messages`).
- Формирует системное сообщение, включая текущую дату и язык ответа.
- Собирает список сообщений для отправки в модель, включая системное сообщение, историю общения, результаты веб-поиска (если включено) и jailbreak-инструкции (если включено).
- Вызывает функцию `ChatCompletion.create` для генерации ответа с использованием указанной модели и сообщений.
- Возвращает ответ в формате потока событий (`text/event-stream`) с использованием `app.response_class`.

**Примеры**:
```python
# Пример запроса:
{
    "stream": true,
    "jailbreak": "Default",
    "model": "gpt-3.5-turbo",
    "meta": {
        "content": {
            "conversation": [],
            "internet_access": true,
            "parts": [
                {
                    "content": "Привет! Как дела?",
                    "role": "user"
                }
            ]
        }
    }
}
```

### Функция `build_messages`
**Назначение**: Формирует список сообщений для отправки в языковую модель, включая системное сообщение, историю общения, результаты веб-поиска и jailbreak-инструкции. 

**Параметры**:
- `jailbreak` (str): Тип jailbreak-инструкций, которые должны быть включены в список сообщений.

**Возвращает**: `list`: Список сообщений, готовый для отправки в языковую модель.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Извлекает информацию о текущем разговоре, доступе к интернету и содержимом запроса из тела HTTP-запроса.
- Генерирует системное сообщение с указанием текущей даты и языка ответа.
- Инициализирует список сообщений системным сообщением.
- Добавляет историю общения из тела запроса.
- Добавляет результаты веб-поиска, если доступ к интернету включен.
- Добавляет jailbreak-инструкции, если они включены.
- Добавляет текст запроса в конец списка.
- Ограничивает размер списка сообщений, чтобы избежать ошибки превышения количества токенов API.

**Примеры**:
```python
# Пример списка сообщений, возвращаемого функцией build_messages:
[
    {
        'role': 'system',
        'content': 'You are ChatGPT also known as ChatGPT, a large language model trained by OpenAI. Strictly follow the users instructions. Current date: 2023-11-15. You will respond in the language: ru.'
    },
    {
        'role': 'user',
        'content': 'Привет! Как дела?'
    },
    {
        'role': 'system',
        'content': '[1] "Это текст подсказки" URL:https://example.com.'
    },
    {
        'role': 'user',
        'content': 'Как дела?'
    }
]

```

### Функция `fetch_search_results`
**Назначение**: Получает результаты веб-поиска по заданному запросу и формирует сообщение с краткими описаниями.

**Параметры**:
- `query` (str): Текст запроса для веб-поиска.

**Возвращает**: `list`: Список сообщений с краткими описаниями результатов веб-поиска.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Использет API `ddg-api.herokuapp.com` для получения результатов поиска по заданному запросу.
- Извлекает ссылки и краткие описания результатов.
- Формирует сообщение с краткими описаниями результатов веб-поиска в формате, подходящем для отправки в языковую модель.

**Примеры**:
```python
# Пример списка сообщений, возвращаемого функцией fetch_search_results:
[
    {
        'role': 'system',
        'content': '[1] "Это текст подсказки" URL:https://example.com.'
    }
]

```

### Функция `generate_stream`
**Назначение**: Генерирует поток событий ответа от языковой модели с обработкой jailbreak-инструкций.

**Параметры**:
- `response` (list): Список сообщений, возвращаемых функцией `ChatCompletion.create`.
- `jailbreak` (str): Тип jailbreak-инструкций, которые должны быть применены к ответу.

**Возвращает**: `generator`: Генератор, который последовательно выдает части ответа от языковой модели.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Проверяет, включены ли jailbreak-инструкции.
- Если jailbreak включен:
    - Итерирует по сообщениям в `response`.
    - Проверяет, достигнут ли конец jailbreak-инструкции.
    - Если конец не достигнут, генерирует сообщение.
    - Если конец достигнут, генерирует весь jailbreak-ответ.
- Если jailbreak не включен, генерирует сообщения из `response` без изменений.

**Примеры**:
```python
# Пример ответа от модели с jailbreak-инструкциями:
[
    'GPT: ',
    'ACT: ',
    'Результат 1',
    'Результат 2'
]
```

### Функция `response_jailbroken_success`
**Назначение**: Проверяет, достигнут ли конец jailbreak-инструкции в ответе от языковой модели.

**Параметры**:
- `response` (str): Текст ответа от языковой модели.

**Возвращает**: `bool`: `True`, если конец jailbreak-инструкции достигнут, `False` в противном случае.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Ищет в тексте ответа `ACT:`.
- Возвращает `True`, если `ACT:` найден, и `False` в противном случае.

### Функция `response_jailbroken_failed`
**Назначение**: Проверяет, является ли ответ от языковой модели неудачным, т.е. не начинается с `GPT:` или `ACT:`.

**Параметры**:
- `response` (str): Текст ответа от языковой модели.

**Возвращает**: `bool`: `True`, если ответ неудачный, `False` в противном случае.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Проверяет, начинается ли ответ с `GPT:` или `ACT:`.
- Возвращает `True`, если ответ не начинается с `GPT:` или `ACT:`, и `False` в противном случае.

### Функция `set_response_language`
**Назначение**: Определяет язык запроса и генерирует сообщение с указанием языка ответа.

**Параметры**:
- `prompt` (dict): Словарь с информацией о запросе, включая текст (`content`).

**Возвращает**: `str`: Сообщение с указанием языка ответа.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Использует библиотеку `googletrans` для определения языка запроса.
- Возвращает сообщение с указанием языка ответа в формате `You will respond in the language: {detected_language}.`.

### Функция `isJailbreak`
**Назначение**: Проверяет, включены ли jailbreak-инструкции и возвращает их, если они включены.

**Параметры**:
- `jailbreak` (str): Тип jailbreak-инструкций.

**Возвращает**: `list` или `None`: Список jailbreak-инструкций, если они включены, иначе `None`.

**Вызывает исключения**: Отсутствуют.

**Как работает функция**:
- Проверяет, отличается ли `jailbreak` от "Default".
- Если да, то извлекает jailbreak-инструкции из словаря `special_instructions`.
- Если нет, то возвращает `None`.

## Параметры класса `Backend_Api`

- `app` (Flask app): Экземпляр Flask приложения, на котором будет работать API.
- `use_auto_proxy` (bool): Флаг, указывающий на использование автоматического прокси для запросов к модели.
- `routes` (dict): Словарь с маршрутами API, где ключ - путь, а значение - словарь с функцией обработки и HTTP-методами.

## Примеры

```python
# Пример создания экземпляра класса Backend_Api
from flask import Flask
app = Flask(__name__)

# Загрузка конфигурации
config = {
    "use_auto_proxy": True
}

# Создание экземпляра класса Backend_Api
backend = Backend_Api(app, config)

# Добавление маршрута API
app.add_url_rule("/backend-api/v2/conversation", methods=["POST"], view_func=backend._conversation)

# Запуск приложения Flask
app.run(debug=True)
```