# Модуль для автопроксирования запросов к API

## Обзор

Модуль `auto_proxy.py`  обеспечивает автоматическое получение, тестирование и использование прокси-серверов для оптимизации запросов к API, таких как ChatGPT и Google Gemini.

## Подробно

Модуль `auto_proxy.py`  предназначен для использования в сценариях, где требуется стабильное подключение к API, которое может быть подвержено блокировкам или ограничениям со стороны провайдеров. Он работает следующим образом:

1. **Получение прокси-серверов:**  Функция `fetch_proxies()` получает список прокси-серверов с ресурса `proxyscrape.com`.
2. **Тестирование прокси-серверов:**  Функция `test_proxy()` проверяет работоспособность прокси-сервера, отправляя тестовый запрос к API с заданным таймаутом.
3. **Создание списка рабочих прокси-серверов:** Функция `get_working_proxies()` запускает многопоточную проверку всех полученных прокси-серверов. Рабочие прокси-серверы добавляются в глобальный список `working_proxies`.
4. **Обновление списка рабочих прокси-серверов:**  Функция `update_working_proxies()`  периодически обновляет список `working_proxies`, чтобы гарантировать его актуальность.
5. **Выбор случайного прокси-сервера:**  Функция `get_random_proxy()` выбирает случайный рабочий прокси-сервер из списка `working_proxies`.

## Классы

В данном файле не используются классы.

## Функции

### `fetch_proxies`

**Назначение**: Извлечение списка прокси-серверов с сайта `proxyscrape.com`.

**Параметры**:  
- Нет

**Возвращает**:  
- `list`: Список прокси-серверов в формате "IP:Port".

**Вызывает исключения**:  
- `Exception`: Если возникает ошибка при загрузке прокси-серверов.

**Пример**:

```python
>>> fetch_proxies()
['123.45.67.89:8080', '98.76.54.32:3128', ...]
```

### `test_proxy`

**Назначение**: Проверка работоспособности прокси-сервера с использованием тестового запроса к API.

**Параметры**:  
- `proxy` (str): Прокси-сервер в формате "IP:Port".
- `prompt` (str): Тестовый запрос для проверки прокси-сервера.
- `timeout` (int): Максимальное время ожидания ответа прокси-сервера в секундах.

**Возвращает**:  
- Нет

**Вызывает исключения**:  
- `Exception`: Если возникает ошибка при проверке прокси-сервера.

**Пример**:

```python
>>> test_proxy('123.45.67.89:8080', 'What is the capital of France?', 5)
proxy: 123.45.67.89:8080 [100ms] ✅ 
```

### `add_working_proxy`

**Назначение**: Добавление рабочего прокси-сервера в глобальный список `working_proxies`.

**Параметры**:  
- `proxy` (str): Прокси-сервер в формате "IP:Port".

**Возвращает**:  
- Нет

**Вызывает исключения**:  
- Нет

**Пример**:

```python
>>> add_working_proxy('123.45.67.89:8080')
```

### `remove_proxy`

**Назначение**: Удаление прокси-сервера из глобального списка `working_proxies`.

**Параметры**:  
- `proxy` (str): Прокси-сервер в формате "IP:Port".

**Возвращает**:  
- Нет

**Вызывает исключения**:  
- Нет

**Пример**:

```python
>>> remove_proxy('123.45.67.89:8080')
```

### `get_working_proxies`

**Назначение**: Получение и проверка прокси-серверов, добавление рабочих прокси-серверов в глобальный список `working_proxies`.

**Параметры**:  
- `prompt` (str): Тестовый запрос для проверки прокси-серверов.
- `timeout` (int, optional): Максимальное время ожидания ответа прокси-сервера в секундах. По умолчанию 5 секунд.

**Возвращает**:  
- Нет

**Вызывает исключения**:  
- Нет

**Пример**:

```python
>>> get_working_proxies('What is the capital of France?')
proxy: 123.45.67.89:8080 [100ms] ✅ 
proxy: 98.76.54.32:3128 [200ms] ✅ 
...
```

### `update_working_proxies`

**Назначение**: Периодическое обновление глобального списка `working_proxies` с рабочими прокси-серверами.

**Параметры**:  
- Нет

**Возвращает**:  
- Нет

**Вызывает исключения**:  
- Нет

**Пример**:

```python
>>> update_working_proxies()
proxies updated
proxies updated
...
```

### `get_random_proxy`

**Назначение**: Получение случайного рабочего прокси-сервера из глобального списка `working_proxies`.

**Параметры**:  
- Нет

**Возвращает**:  
- `str`: Случайный рабочий прокси-сервер в формате "IP:Port".

**Вызывает исключения**:  
- Нет

**Пример**:

```python
>>> get_random_proxy()
'123.45.67.89:8080'
```

## Параметры

### `working_proxies`

Глобальный список, содержащий рабочие прокси-серверы в формате "IP:Port".

## Примеры

### Пример использования модуля

```python
# Получение прокси-серверов
proxy_list = fetch_proxies()

# Тестирование прокси-серверов
for proxy in proxy_list:
    test_proxy(proxy, 'What is the capital of France?', 5)

# Выбор случайного прокси-сервера
random_proxy = get_random_proxy()

# Использование прокси-сервера для запроса к API
response = requests.get('https://api.example.com', proxies={'http': random_proxy})
```

### Пример запуска обновления прокси-серверов

```python
# Запуск обновления прокси-серверов в отдельном потоке
update_thread = threading.Thread(target=update_working_proxies)
update_thread.start()
```