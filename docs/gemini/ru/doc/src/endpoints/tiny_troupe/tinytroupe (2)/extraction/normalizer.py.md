# Модуль normalizer.py

## Обзор

Модуль предоставляет класс `Normalizer`, предназначенный для нормализации текстовых элементов, таких как пассажи, концепции и другие текстовые элементы. Он использует API OpenAI для приведения различных входных элементов к небольшому набору стандартизированных значений.

## Подробнее

Модуль `normalizer.py` содержит класс `Normalizer`, который позволяет нормализовывать текстовые элементы. Он включает в себя функциональность для отправки запросов к API OpenAI, обработки ответов и кэширования результатов для повышения производительности.

## Классы

### `Normalizer`

**Описание**: Механизм для нормализации текстовых элементов.

**Атрибуты**:
- `elements` (List[str]): Список элементов для нормализации.
- `n` (int): Количество нормализованных элементов для вывода.
- `verbose` (bool): Флаг, определяющий необходимость вывода отладочных сообщений. По умолчанию `False`.
- `normalized_elements` (dict): JSON-структура, где каждый выходной элемент является ключом к списку входных элементов, которые были объединены в него.
- `normalizing_map` (dict): Словарь, который отображает каждый входной элемент на его нормализованный вывод. Используется в качестве кэша.

**Методы**:
- `__init__(self, elements: List[str], n: int, verbose: bool = False)`: Инициализирует экземпляр класса `Normalizer`.
- `normalize(self, element_or_elements: Union[str, List[str]]) -> Union[str, List[str]]`: Нормализует указанный элемент или элементы.

### `__init__`

```python
def __init__(self, elements:List[str], n:int, verbose:bool=False):
    """
    Инициализирует экземпляр класса `Normalizer`.

    Args:
        elements (List[str]): Список элементов для нормализации.
        n (int): Количество нормализованных элементов для вывода.
        verbose (bool, optional): Флаг, определяющий необходимость вывода отладочных сообщений. По умолчанию `False`.
    """
```

**Назначение**: Инициализация экземпляра класса `Normalizer`.

**Параметры**:
- `elements` (List[str]): Список элементов, которые необходимо нормализовать. Дубликаты удаляются.
- `n` (int): Количество нормализованных элементов, которые должны быть выведены.
- `verbose` (bool, optional): Флаг, указывающий, следует ли выводить отладочные сообщения. По умолчанию `False`.

**Как работает функция**:
- Удаляет дубликаты из списка входных элементов `elements`, используя `list(set(elements))`.
- Сохраняет уникальные элементы в атрибуте `self.elements`.
- Инициализирует атрибуты `self.n` и `self.verbose` переданными значениями.
- Инициализирует `self.normalized_elements` в `None`. Этот атрибут предназначен для хранения структуры JSON, где каждый выходной элемент является ключом к списку входных элементов, которые были объединены в этот выходной элемент.
- Инициализирует `self.normalizing_map` как пустой словарь. Этот атрибут используется как кэш для хранения соответствий между входными и нормализованными элементами.
- Настраивает параметры `rendering_configs` для использования в шаблонах сообщений.
- Формирует начальные сообщения для языковой модели (LLM), используя шаблоны `normalizer.system.mustache` и `normalizer.user.mustache`.
- Отправляет сообщение в OpenAI API и получает результат.
- Извлекает JSON из ответа OpenAI API и сохраняет его в `self.normalized_elements`.

**Примеры**:

```python
normalizer = Normalizer(elements=['элемент1', 'элемент2', 'элемент1'], n=2, verbose=True)
print(normalizer.elements)
# Вывод: ['элемент2', 'элемент1']
print(normalizer.n)
# Вывод: 2
print(normalizer.verbose)
# Вывод: True
```

### `normalize`

```python
def normalize(self, element_or_elements:Union[str, List[str]]) -> Union[str, List[str]]:
    """
    Нормализует указанный элемент или элементы.

    Args:
        element_or_elements (Union[str, List[str]]): Элемент или элементы для нормализации.

    Returns:
        str: Нормализованный элемент, если на входе была строка.
        list: Нормализованные элементы, если на входе был список, с сохранением порядка элементов на входе.
    """
```

**Назначение**: Нормализация одного или нескольких входных элементов.

**Параметры**:
- `element_or_elements` (Union[str, List[str]]): Элемент (строка) или список элементов (строк) для нормализации.

**Возвращает**:
- `Union[str, List[str]]`: Если на вход была строка, возвращает нормализованную строку. Если на вход был список, возвращает список нормализованных строк в том же порядке.

**Как работает функция**:
1. **Определение типа входных данных:**
   - Проверяет, является ли входной параметр `element_or_elements` строкой или списком.
   - Если это строка, создает список `denormalized_elements` с единственным элементом - этой строкой.
   - Если это список, присваивает `element_or_elements` переменной `denormalized_elements`.
   - Если это не строка и не список, вызывает исключение `ValueError`.

2. **Кэширование результатов:**
   - Инициализирует пустой список `normalized_elements` для хранения нормализованных элементов.
   - Создает список `elements_to_normalize`, содержащий элементы, которых нет в кэше `self.normalizing_map`.

3. **Обращение к LLM для нормализации (при необходимости):**
   - Если `elements_to_normalize` не пуст (т.е. есть элементы, которых нет в кэше):
     - Формирует `rendering_configs` с категориями из `self.normalized_elements` и элементами для нормализации из `elements_to_normalize`.
     - Формирует сообщения для LLM, используя шаблоны `normalizer.applier.system.mustache` и `normalizer.applier.user.mustache`.
     - Отправляет запрос в OpenAI API и получает ответ.
     - Извлекает JSON из ответа LLM и сохраняет его в `normalized_elements_from_llm`.
     - Проверяет, что `normalized_elements_from_llm` является списком и имеет ту же длину, что и `elements_to_normalize`.
     - Обновляет кэш `self.normalizing_map`, сопоставляя каждый элемент из `elements_to_normalize` с его нормализованной формой из `normalized_elements_from_llm`.

4. **Формирование результата:**
   - Для каждого элемента в `denormalized_elements`:
     - Извлекает нормализованный элемент из `self.normalizing_map` и добавляет его в `normalized_elements`.

5. **Возврат результата:**
   - Возвращает `normalized_elements`.

**Примеры**:

```python
normalizer = Normalizer(elements=['Элемент1', 'Элемент2'], n=2)

normalized_string = normalizer.normalize('Элемент1')
print(normalized_string)
# Вывод: <результат из OpenAI>

normalized_list = normalizer.normalize(['Элемент1', 'Элемент2'])
print(normalized_list)
# Вывод: [<результат из OpenAI>, <результат из OpenAI>]