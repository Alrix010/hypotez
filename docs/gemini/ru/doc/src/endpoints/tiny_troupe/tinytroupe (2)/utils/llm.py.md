# Модуль llm

## Обзор

Модуль `llm` предоставляет набор функций и декораторов для работы с моделями больших языков (LLM), такими как Google Gemini и OpenAI.

## Подробнее

Модуль содержит:
* **Функции для подготовки входных данных для LLM**: `compose_initial_LLM_messages_with_templates`, `llm`.
* **Функции для обработки выходных данных LLM**: `extract_json`, `extract_code_block`.
* **Утилиты для управления LLM**: `repeat_on_error`.
* **Инструменты для конструирования подсказок**: `add_rai_template_variables_if_enabled`.
* **Функция для усечения текста**: `truncate_actions_or_stimuli`.

## Функции

### `compose_initial_LLM_messages_with_templates`

**Назначение**: Формирует начальные сообщения для вызова LLM-модели.

**Параметры**:
- `system_template_name` (str): Имя файла шаблона системного сообщения.
- `user_template_name` (str): Имя файла шаблона сообщения пользователя (необязательно).
- `base_module_folder` (str): Базовая папка модуля (необязательно).
- `rendering_configs` (dict): Конфигурация рендеринга (необязательно).

**Возвращает**:
- list: Список сообщений для LLM.

**Как работает функция**:
1. Функция определяет путь к шаблонам сообщений, основываясь на заданных именах файлов и базовой папке модуля.
2. Используя `chevron` для рендеринга шаблонов, формирует системное сообщение из `system_template_name`.
3. Если указан `user_template_name`, также формирует сообщение пользователя из этого шаблона.
4. Возвращает список сообщений для LLM.

**Примеры**:

```python
messages = compose_initial_LLM_messages_with_templates(
    system_template_name="system_prompt.md",
    user_template_name="user_prompt.md",
    base_module_folder="utils",
    rendering_configs={"my_variable": "some value"}
)
print(messages)
```

### `llm`

**Назначение**: Декоратор, который превращает декорированную функцию в LLM-based функцию.

**Параметры**:
- `**model_overrides` (dict): Дополнительные параметры для LLM (необязательно).

**Возвращает**:
- `wrapper`: Декорированная функция.

**Как работает функция**:
1. Применяет декоратор к заданной функции.
2. Получает тип возвращаемого значения из аннотации функции.
3. Извлекает системную подсказку из документации функции.
4. Если функция возвращает строку, использует ее как пользовательскую подсказку. В противном случае, формирует пользовательскую подсказку на основе аргументов функции.
5. Создает объект `LLMRequest` с системной подсказкой, пользовательской подсказкой, типом возвращаемого значения и дополнительными параметрами LLM.
6. Вызывает метод `call()` объекта `LLMRequest` и возвращает результат.

**Примеры**:

```python
@llm(model="gpt-4-0613", temperature=0.5, max_tokens=100)
def joke():
    return "Tell me a joke."

print(joke())
```

### `extract_json`

**Назначение**: Извлекает объект JSON из строки, игнорируя текст перед первой открывающей фигурной скобкой и любые теги Markdown (````json` и `````).

**Параметры**:
- `text` (str): Строка, из которой нужно извлечь JSON.

**Возвращает**:
- dict: Извлеченный JSON-объект.

**Как работает функция**:
1. Используя регулярные выражения, функция удаляет текст перед первой открывающей фигурной или квадратной скобкой.
2. Далее, она удаляет текст после последней закрывающей фигурной или квадратной скобки.
3. Затем она заменяет невалидные escape-последовательности.
4. Используя `json.loads` с `strict=False`, парсит полученный текст в JSON-объект.
5. Возвращает полученный JSON-объект или пустой словарь в случае ошибки.

**Примеры**:

```python
text = "```json\n{\"key1\": \"value1\", \"key2\": 2}\n```"
parsed = extract_json(text)
print(parsed)
```

### `extract_code_block`

**Назначение**: Извлекает блок кода из строки, игнорируя текст перед первыми тремя обратными кавычками и текст после последних трех обратных кавычек.

**Параметры**:
- `text` (str): Строка, из которой нужно извлечь блок кода.

**Возвращает**:
- str: Извлеченный блок кода.

**Как работает функция**:
1. Используя регулярные выражения, функция удаляет текст перед первыми тремя обратными кавычками.
2. Далее, она удаляет текст после последних трех обратных кавычек.
3. Возвращает полученный блок кода или пустую строку в случае ошибки.

**Примеры**:

```python
text = "```python\nprint(\"Hello, world!\")\n```"
code_block = extract_code_block(text)
print(code_block)
```

### `repeat_on_error`

**Назначение**: Декоратор, который повторяет вызов заданной функции, если возникает исключение из указанного списка, до заданного количества повторений.

**Параметры**:
- `retries` (int): Количество попыток повторения.
- `exceptions` (list): Список классов исключений, которые нужно перехватывать.

**Возвращает**:
- `wrapper`: Декорированная функция.

**Как работает функция**:
1. Применяет декоратор к заданной функции.
2. В цикле, повторяется вызов функции до заданного количества `retries`.
3. Если происходит исключение из `exceptions`, функция выводит сообщение в лог, увеличивает счетчик попыток и продолжает цикл.
4. Если количество `retries` исчерпано, исключение поднимается.
5. Если исключение не произошло, функция возвращает результат вызова декорированной функции.

**Примеры**:

```python
@repeat_on_error(retries=3, exceptions=[ValueError, TypeError])
def my_func(param):
    if param == 0:
        raise ValueError("Parameter cannot be 0.")
    return param

try:
    result = my_func(0)
except Exception as e:
    print(f"Error: {e}")
```

### `add_rai_template_variables_if_enabled`

**Назначение**: Добавляет переменные RAI-шаблона в заданный словарь, если включены RAI-отказы.

**Параметры**:
- `template_variables` (dict): Словарь переменных шаблона.

**Возвращает**:
- dict: Обновленный словарь переменных шаблона.

**Как работает функция**:
1. Загружает конфигурацию из файла `config.ini`.
2. Проверяет, включены ли RAI-отказы от вредоносного контента и нарушения авторских прав.
3. Если включены, функция загружает RAI-отказы из соответствующих файлов в папке `prompts` и добавляет их в словарь `template_variables`.
4. Возвращает обновленный словарь `template_variables`.

**Примеры**:

```python
template_variables = {"my_variable": "some value"}
updated_template_variables = add_rai_template_variables_if_enabled(template_variables)
print(updated_template_variables)
```

### `truncate_actions_or_stimuli`

**Назначение**: Усекает содержимое действий или стимулов до заданной максимальной длины.

**Параметры**:
- `list_of_actions_or_stimuli` (Collection[dict]): Список действий или стимулов.
- `max_content_length` (int): Максимальная длина содержимого.

**Возвращает**:
- Collection[str]: Усеченный список действий или стимулов.

**Как работает функция**:
1. Создает глубокую копию исходного списка, чтобы избежать побочных эффектов.
2. Проходит по элементам списка и проверяет наличие ключа `content`.
3. Если `content` присутствует, функция проверяет наличие ключей `action`, `stimulus` или `stimuli` в `content`.
4. Для каждого из этих ключей, функция усекает соответствующее содержимое до заданной `max_content_length`.
5. Возвращает скопированный усеченный список.

**Примеры**:

```python
actions = [
    {"role": "user", "content": {"action": {"content": "Very long text"}}},
    {"role": "assistant", "content": {"stimulus": {"content": "Another very long text"}}},
]
truncated_actions = truncate_actions_or_stimuli(actions, 10)
print(truncated_actions)