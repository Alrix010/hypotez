# Модуль для управления симуляциями TinyTroupe

## Обзор

Этот модуль предоставляет функции для управления симуляциями TinyTroupe, включая:

- **Инициализация:** Запуск новой симуляции с заданным именем и сохранением состояния в файл.
- **Проверка состояния:** Проверка статуса текущей симуляции (запущена/остановлена).
- **Создание контрольных точек:** Сохранение текущего состояния симуляции в файл.
- **Остановка:** Завершение текущей симуляции.
- **Обнуление:** Сброс состояния симуляции и удаление файла сохранения.

## Классы

### `class Simulation`

**Описание**: Класс `Simulation` представляет собой симуляцию TinyTroupe. Он хранит информацию о состоянии симуляции, включая ее статус, трассировку выполнения, кэшированную трассировку, время последней контрольной точки, список агентов и список используемых инструментов.

**Атрибуты**:

- `status` (str): Текущий статус симуляции (например, `Simulation.STATUS_STARTED`, `Simulation.STATUS_STOPPED`).
- `execution_trace` (list): Список действий, выполненных в рамках текущей симуляции.
- `cached_trace` (list): Список действий, сохраненных в файл контрольной точки.
- `last_checkpoint_time` (float): Время последней контрольной точки в секундах.
- `agents` (list): Список агентов, участвующих в симуляции.
- `tools` (list): Список инструментов, используемых в симуляции.

**Методы**:

- `__init__(name: str, cache_file_name: str = None, default_agents: list = None, default_tools: list = None)`: Инициализирует симуляцию с заданным именем, именем файла сохранения, списком агентов и списком инструментов.
- `start()`: Запускает симуляцию.
- `stop()`: Останавливает симуляцию.
- `checkpoint()`: Сохраняет текущее состояние симуляции в файл контрольной точки.
- `reset()`: Сбрасывает состояние симуляции и удаляет файл сохранения.

## Функции

### `begin(cache_file_name: str, default_agents: list = None, default_tools: list = None) -> None`

**Назначение**: Инициализирует новую симуляцию TinyTroupe с заданным именем файла для сохранения состояния.

**Параметры**:

- `cache_file_name` (str): Имя файла для сохранения состояния симуляции.
- `default_agents` (list, optional): Список агентов, которые будут добавлены в симуляцию по умолчанию. По умолчанию `None`.
- `default_tools` (list, optional): Список инструментов, которые будут добавлены в симуляцию по умолчанию. По умолчанию `None`.

**Возвращает**:

- `None`

**Примеры**:

```python
>>> control.begin("my_simulation.cache.json")
>>> control.begin("my_simulation.cache.json", default_agents=[agent_1, agent_2])
```

**Как работает функция**:

- Функция создает новый объект `Simulation` с заданным именем файла для сохранения состояния.
- Она добавляет в симуляцию агентов и инструменты из `default_agents` и `default_tools`, если они были указаны.
- Затем она устанавливает статус симуляции как `Simulation.STATUS_STARTED`.

### `end() -> None`

**Назначение**: Завершает текущую симуляцию TinyTroupe.

**Параметры**:

- Нет.

**Возвращает**:

- `None`

**Примеры**:

```python
>>> control.end()
```

**Как работает функция**:

- Функция устанавливает статус текущей симуляции как `Simulation.STATUS_STOPPED`.

### `checkpoint() -> None`

**Назначение**: Сохраняет текущее состояние симуляции TinyTroupe в файл контрольной точки.

**Параметры**:

- Нет.

**Возвращает**:

- `None`

**Примеры**:

```python
>>> control.checkpoint()
```

**Как работает функция**:

- Функция сериализует текущее состояние симуляции в JSON-формат.
- Она сохраняет сериализованные данные в файл контрольной точки.
- Затем она обновляет время последней контрольной точки.

### `reset() -> None`

**Назначение**: Сбрасывает состояние текущей симуляции TinyTroupe и удаляет файл сохранения.

**Параметры**:

- Нет.

**Возвращает**:

- `None`

**Примеры**:

```python
>>> control.reset()
```

**Как работает функция**:

- Функция удаляет файл сохранения текущей симуляции, если он существует.
- Затем она устанавливает статус симуляции как `Simulation.STATUS_STOPPED` и удаляет все данные о симуляции.

### `cache_hits() -> int`

**Назначение**: Возвращает количество попаданий в кэш для текущей симуляции.

**Параметры**:

- Нет.

**Возвращает**:

- `int`: Количество попаданий в кэш.

**Примеры**:

```python
>>> control.cache_hits()
```

**Как работает функция**:

- Функция возвращает количество попаданий в кэш для текущей симуляции, которое хранится в свойстве `cache_hits` объекта `Simulation`.

### `cache_misses() -> int`

**Назначение**: Возвращает количество промахов в кэш для текущей симуляции.

**Параметры**:

- Нет.

**Возвращает**:

- `int`: Количество промахов в кэш.

**Примеры**:

```python
>>> control.cache_misses()
```

**Как работает функция**:

- Функция возвращает количество промахов в кэш для текущей симуляции, которое хранится в свойстве `cache_misses` объекта `Simulation`.

## Тесты

Модуль содержит набор тестов для проверки корректности работы функций управления симуляцией TinyTroupe.

### `test_begin_checkpoint_end_with_agent_only(setup)`

Этот тест проверяет функциональность инициализации, создания контрольных точек и завершения симуляции с использованием только агентов.

### `test_begin_checkpoint_end_with_world(setup)`

Этот тест проверяет функциональность инициализации, создания контрольных точек и завершения симуляции с использованием мира (`TinyWorld`).

### `test_begin_checkpoint_end_with_factory(setup)`

Этот тест проверяет функциональность инициализации, создания контрольных точек и завершения симуляции с использованием фабрики агентов (`TinyPersonFactory`).

## Параметры класса

- `_current_simulations` (dict): Словарь, хранящий информацию о текущих симуляциях, где ключом является имя симуляции, а значением — объект `Simulation`.


## Примеры

```python
# Инициализация новой симуляции
control.begin("my_simulation.cache.json")

# Добавление агентов и инструментов в симуляцию
agent_1 = create_oscar_the_architect()
agent_2 = create_lisa_the_data_scientist()
control._current_simulations["default"].agents.extend([agent_1, agent_2])
tool_1 = TinyWordProcessor()
control._current_simulations["default"].tools.append(tool_1)

# Запуск симуляции
control._current_simulations["default"].start()

# Выполнение действий в симуляции
agent_1.listen_and_act("Hello world!")
agent_2.listen_and_act("How are you?")

# Создание контрольной точки
control.checkpoint()

# Завершение симуляции
control.end()

# Сброс состояния симуляции
control.reset()
```

## Дополнительно

- Модуль `control` использует глобальную переменную `_current_simulations` для хранения информации о текущих симуляциях.
- Функции `begin`, `end`, `checkpoint` и `reset` воздействуют на эту глобальную переменную, чтобы управлять состоянием симуляций.
- Модуль `control` также предоставляет функции `cache_hits` и `cache_misses` для получения информации о количестве попаданий и промахов в кэш.
- Модуль `control` может быть использован для создания сложных симуляций TinyTroupe с различными агентами, инструментами и мирами.