# Телеграм бот через сервер FastAPI через RPC

## Обзор

Модуль `src/endpoints/bots/telegram/bot_aiogram.py` предоставляет реализацию Telegram бота, который работает через сервер FastAPI, используя RPC (Remote Procedure Call) для обработки входящих запросов. 

## Подробнее

Бот использует библиотеку `aiogram` для взаимодействия с Telegram API. Сервер FastAPI служит для обработки входящих вебхуков от Telegram и передачи их на сервер RPC. 

- Сервер RPC (в данном случае, вероятно, реализован на основе библиотеки `xmlrpc` или подобной) принимает запросы от FastAPI, обрабатывает их с помощью бота и возвращает результат обратно на FastAPI.
- FastAPI, в свою очередь, отправляет ответ Telegram API, таким образом, реализуя обработку запросов бота.

## Классы

### `TelegramBot`

**Описание**: Класс `TelegramBot` представляет собой синглтон, который реализует интерфейс бота. Он отвечает за:

- Инициализацию бота Telegram, обработчика и вебхука
- Обработку запросов бота через FastAPI
- Запуск и остановку бота

**Атрибуты**:

- `token` (str): Токен Telegram бота.
- `port` (int): Порт для FastAPI сервера.
- `route` (str): Путь к webhook'у для FastAPI.
- `config` (SimpleNamespace): Конфигурация бота.
- `bot` (Bot): Объект бота `aiogram`.
- `dp` (Dispatcher): Диспетчер для обработки событий Telegram.
- `bot_handler` (BotHandler): Обработчик запросов бота.
- `app` (Optional[web.Application]): Веб-приложение FastAPI.
- `rpc_client` (Optional[ServerProxy]): Клиент RPC для связи с сервером RPC.

**Методы**:

- `run()`: Запускает бота и инициализирует RPC и вебхук.
- `_register_default_handlers()`: Регистрирует стандартные обработчики команд (например, `/start`, `/help`) для бота.
- `_handle_message(message: types.Message)`: Обрабатывает текстовые сообщения.
- `initialize_bot_webhook(route: str)`: Инициализирует вебхук бота.
- `_register_route_via_rpc(rpc_client: ServerProxy)`: Регистрирует маршрут вебхука Telegram через RPC.
- `stop()`: Останавливает бота и удаляет webhook.

**Принцип работы**:

1. Инициализация:
    - В конструкторе `TelegramBot` создается объект бота `aiogram` с токеном, инициализируются обработчики и конфигурация.
2. Запуск бота:
    - Метод `run()` запускает бота и сервер FastAPI.
    - Устанавливает webhook через RPC.
    - Запускает веб-приложение FastAPI, которое обрабатывает входящие запросы от Telegram.
3. Обработка запросов:
    - FastAPI получает webhook от Telegram и отправляет запрос на RPC сервер.
    - RPC сервер обрабатывает запрос, используя обработчик бота (`bot_handler`).
    - Обработчик бота выполняет необходимые действия, например, отправляет ответное сообщение.
    - RPC сервер возвращает ответ на FastAPI.
    - FastAPI отправляет ответ Telegram API, завершая обработку запроса.
4. Остановка бота:
    - Метод `stop()` останавливает бота и удаляет webhook.

**Примеры**:

```python
from src.endpoints.bots.telegram.bot_aiogram import TelegramBot
from dotenv import load_dotenv

load_dotenv()
bot = TelegramBot(os.getenv('TELEGRAM_TOKEN'))
bot.run()
```

## Внутренние функции

### `_register_default_handlers()`

**Назначение**: Регистрирует стандартные обработчики команд для Telegram бота.

**Параметры**: 

- Не использует параметры.

**Возвращает**: 

- Не возвращает значение.

**Как работает функция**:

- Регистрирует обработчики для команд `/start`, `/help`, `/sendpdf` с помощью `bot_handler`.
- Регистрирует обработчики для текстовых сообщений, сообщений с голосом, документами и логи.

**Примеры**:

- Не применимо, поскольку это частная функция.

### `_handle_message(message: types.Message)`

**Назначение**: Обрабатывает текстовые сообщения, полученные от Telegram бота.

**Параметры**:

- `message` (types.Message): Объект сообщения Telegram.

**Возвращает**:

- Не возвращает значение.

**Как работает функция**:

- Вызывает метод `handle_message` из `bot_handler` для обработки текстовых сообщений.

**Примеры**:

- Не применимо, поскольку это частная функция.

### `initialize_bot_webhook(route: str)`

**Назначение**: Инициализирует webhook бота.

**Параметры**:

- `route` (str): Путь к webhook'у.

**Возвращает**:

- `str | False`: Возвращает URL webhook'а или `False` в случае ошибки.

**Как работает функция**:

- Определяет URL webhook'а, используя адрес сервера FastAPI и путь к webhook'у.
- Если сервер FastAPI работает на `localhost`, то использует ngrok для создания туннеля.
- Пытается установить webhook на Telegram API.
- Логирует результат операции.

**Примеры**:

- Не применимо, поскольку это частная функция.

### `_register_route_via_rpc(rpc_client: ServerProxy)`

**Назначение**: Регистрирует маршрут вебхука Telegram через RPC.

**Параметры**:

- `rpc_client` (ServerProxy): Клиент RPC для связи с сервером RPC.

**Возвращает**:

- Не возвращает значение.

**Как работает функция**:

- Добавляет маршрут вебхука на сервер RPC с помощью метода `add_new_route`.
- Метод `add_new_route` принимает путь к webhook'у (`route`), функцию для обработки (`self.bot_handler.handle_message`) и список HTTP-методов (`POST`).

**Примеры**:

- Не применимо, поскольку это частная функция.

### `stop()`

**Назначение**: Останавливает бота и удаляет webhook.

**Параметры**:

- Не использует параметры.

**Возвращает**:

- Не возвращает значение.

**Как работает функция**:

- Останавливает веб-приложение FastAPI, если оно запущено.
- Удаляет webhook с Telegram API.

**Примеры**:

- Не применимо, поскольку это частная функция.