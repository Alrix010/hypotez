# Модуль `ToolBox_main`

## Обзор

Этот модуль является основным файлом для бота Telegram, который предоставляет пользователям функции текстовой генерации, создания изображений и другие инструменты. 

## Подробней

Модуль `ToolBox_main` содержит код для работы с ботом Telegram, используя библиотеку `telebot`. 

- **Основная задача бота** - обработка сообщений пользователей и предоставление им доступа к функциям текстовой и  изображениям. 
- **Система тарифов** - позволяет пользователям выбирать различные тарифные планы для доступа к разным функциям и ресурсам. 
- **База данных** - `UsersData.db` хранит информацию о каждом пользователе, включая его тариф, баланс токенов, список текстовых типов и др.
- **Функции и методы** - в коде определены функции для обработки команд, кнопок, текстовых сообщений, изображений, а также методы для работы с базой данных.
- **Обработка ошибок** - предусмотрены механизмы для обработки ошибок, например, при нехватке токенов.
- **Обработка изображений** - бот может генерировать изображения с помощью API Stable Diffusion.
- **Система реферальных программ** - позволяет пользователям получать бонусы за приглашение новых пользователей. 
- **Асинхронность** - используется для периодической проверки окончания срока действия тарифов.

## Классы

### `DATA_PATTERN`

**Описание**: 
-  Это не настоящий класс, а функция, которая создает структуру данных пользователя.
-  Данные пользователя сохраняются в базе данных `UsersData.db`

**Аттрибуты**:
- `text` (list): список с флагами, которые показывают, какие типы текстовой генерации доступны пользователю.
- `sessions_messages` (list): список сообщений пользователя в текущей сессии.
- `some` (bool): флаг, который показывает, нужна ли дополнительная информация от пользователя для генерации.
- `images` (str): размер изображения (ширина х высота).
- `free` (bool): флаг, который показывает, активен ли бесплатный режим.
- `basic` (bool): флаг, который показывает, активен ли тариф `Basic`.
- `pro` (bool): флаг, который показывает, активен ли тариф `Pro`.
- `incoming_tokens` (int): количество оставшихся токенов для входных запросов.
- `outgoing_tokens` (int): количество оставшихся токенов для выходных запросов.
- `free_requests` (int): количество бесплатных запросов в день.
- `datetime_sub` (datetime): дата окончания текущей подписки.
- `promocode` (bool): флаг, который показывает, был ли активирован промокод.
- `ref` (str): реферальный код пользователя.

## Функции

### `TokensCancelletionPattern`

**Назначение**:
- Обрабатывает исчерпание токенов у пользователя, выдавая соответствующее сообщение. 

**Параметры**:
- `user_id` (str): идентификатор пользователя.
- `func`: функция для генерации текста или изображения.
- `message`: сообщение пользователя.
- `i` (int, optional): номер типа текста. По умолчанию `None`.

**Возвращает**:
- `None`.

**Как работает функция**:
- Проверяет наличие токенов у пользователя. 
- Если токенов нет, выводит сообщение о необходимости пополнения баланса.
- Если токенов достаточно, выводит результат генерации.
- Обновляет баланс токенов в базе данных.

**Примеры**:

```python
# Вызов функции для обработки запроса на генерацию текста:
TokensCancelletionPattern(user_id='12345', func=tb.TextCommands, message=message, i=0)

# Вызов функции для обработки запроса на генерацию изображения:
TokensCancelletionPattern(user_id='12345', func=tb.ImageCommand, message=message)
```

### `generate_promo_code`

**Назначение**:
-  Генерирует промокод.

**Параметры**:
- `length` (int): длина промокода.

**Возвращает**:
- `str`: промокод.

**Как работает функция**:
- Генерирует случайный набор букв и цифр заданной длины.

**Примеры**:

```python
# Создание промокода длиной 10 символов:
promo_code = generate_promo_code(10)
```

## Методы класса

### `StartProcessing`

**Назначение**:
- Обрабатывает команду `/start`.

**Параметры**:
- `message`: сообщение пользователя.

**Возвращает**:
- `None`.

**Как работает функция**:
- Проверяет наличие данных о пользователе в базе данных. 
- Если данные отсутствуют, создает новую запись пользователя. 
- Если данные уже существуют, обновляет их. 
- Запускает обработку начального запроса.

**Примеры**:

```python
# Вызов функции при получении команды /start:
StartProcessing(message)
```

### `personal_account`

**Назначение**:
-  Отображает информацию о тарифе пользователя.

**Параметры**:
- `message`: сообщение пользователя.

**Возвращает**:
- `None`.

**Как работает функция**:
- Проверяет тариф пользователя в базе данных. 
- Выводит соответствующее сообщение о подключенном тарифе.

**Примеры**:

```python
# Вызов функции при получении команды /profile:
personal_account(message)
```

### `show_stat`

**Назначение**:
-  Выводит статистику по пользователям.

**Параметры**:
- `message`: сообщение пользователя.

**Возвращает**:
- `None`.

**Как работает функция**:
- Выводит количество всех пользователей и количество пользователей с активированными промокодами. 

**Примеры**:

```python
# Вызов функции при получении команды /stat:
show_stat(message)
```

### `CallsProcessing`

**Назначение**:
-  Обрабатывает запросы на нажатие кнопок.

**Параметры**:
- `call`: объект `CallbackQuery`.

**Возвращает**:
- `None`.

**Как работает функция**:
- Обрабатывает нажатие кнопок меню.
- Запускает соответствующие функции в зависимости от нажатой кнопки.
- Обновляет данные о пользователе в базе данных.

**Примеры**:
- Нажатие кнопки **"text"**: `tb.Text_types(call.message)`
- Нажатие кнопки **"images"**: `tb.ImageSize(call.message)`
- Нажатие кнопки **"free"**: `tb.FreeArea(call.message)`
- Нажатие кнопки **"tariff"**: `tb.TariffArea(call.message)`
- Нажатие кнопки **"basic"**: `tb.Basic_tariff(call.message)`
- Нажатие кнопки **"pro"**: `tb.Pro_tariff(call.message)`
- Нажатие кнопки **"promo"**: `tb.Promo_tariff(call.message)`
- Нажатие кнопки **"ref"**: `tb.Ref_tariff(call.message)`

### `TasksProcessing`

**Назначение**:
-  Обрабатывает текстовые сообщения и изображения, отправленные пользователем.

**Параметры**:
- `message`: сообщение пользователя.

**Возвращает**:
- `None`.

**Как работает функция**:
- Обрабатывает текстовые сообщения и изображения, отправленные пользователем. 
- Запускает соответствующие функции генерации текста или изображений. 
- Обновляет данные о пользователе в базе данных.

**Примеры**:
- Обработка запроса на генерацию изображения:
    - `db[user_id][\'images\'] != "" and len(db[user_id][\'images\'].split(\'|\')) == 1`:  проверяет, установлен ли размер изображения. 
    - `size = [int(el) for el in db[user_id][\'images\'].split(\'x\')]`:  извлекает размер изображения. 
    - `prompt = message.text`:  извлекает текст запроса. 
    - `seed = tb.ImageCommand(message, prompt, size)`:  запускает функцию генерации изображения.
    - `db[user_id][\'images\']+="|"+prompt+"|"+str(int(seed))`:  добавляет информацию о запросе в базу данных.
- Обработка текстового запроса:
    - `for i in range(len(db[user_id][\'text\'])):`:  проходит по списку типов текстовой генерации. 
    - `if db[user_id][\'text\'][i] and not db[user_id][\'some\']:`:  проверяет, выбран ли тип генерации и не требуется ли дополнительной информации.
    - `thr=Thread(target=TokensCancelletionPattern, args=(user_id, tb.TextCommands, message, i))`:  запускает функцию генерации текста.
    - `db[user_id][\'text\'][i] = 0`:  сбрасывает флаг типа генерации.
    - `if db[user_id][\'text\'][i] and db[user_id][\'some\']:`:  проверяет, выбран ли тип генерации и требуется ли дополнительная информация.
    - `thr=Thread(target=TokensCancelletionPattern, args=(user_id, tb.SomeTextsCommand, message, i))`:  запускает функцию генерации текста с дополнительной информацией.
    - `db[user_id][\'text\'][i] = 0`:  сбрасывает флаг типа генерации. 
    - `db[user_id][\'some\'] = False`:  сбрасывает флаг дополнительной информации.

### `end_check_tariff_time`

**Назначение**:
-  Периодически проверяет срок действия тарифов.

**Параметры**:
-  `None`.

**Возвращает**:
- `None`.

**Как работает функция**:
-  Использует асинхронную функцию `asyncio.sleep` для задержки выполнения. 
-  Проходит по всем пользователям в базе данных. 
-  Проверяет срок действия тарифа для каждого пользователя.
-  Если срок действия истек, обновляет данные пользователя в базе данных.

**Примеры**:
-  `deltaf = data[\'datetime_sub\'] - datetime.now().replace(microsecond=0)`:  рассчитывает время до окончания тарифа. 
-  `if int(deltaf.total_seconds()) <= 0 and (data[\'basic\'] or data[\'pro\'] or data[\'free_requests\']<10):`:  проверяет, истек ли срок действия тарифа. 
-  `db[user_id] = DATA_PATTERN(text=data[\'text\'], images=data[\'images\'], free=data[\'free\'], promocode=data[\'promocode\'], ref=data[\'ref\'])`:  обновляет данные пользователя в базе данных.

## Параметры класса

### `db`

-  Словарь, хранящий данные пользователей в базе данных `UsersData.db`.
-  Ключи словаря - идентификаторы пользователей. 
-  Значения - словари с информацией о пользователях, полученные из функции `DATA_PATTERN`.

## Примеры

**Создание промокода:**

```python
promo_code = generate_promo_code(10)
print(f"Сгенерированный промокод: {promo_code}")
```

**Обработка команды `/start`:**

```python
message = types.Message(text='/start', chat=types.Chat(id=12345))
StartProcessing(message)
```

**Обработка запроса на генерацию текста:**

```python
message = types.Message(text='Сгенерируй текст', chat=types.Chat(id=12345))
TasksProcessing(message)
```

**Обработка запроса на генерацию изображения:**

```python
message = types.Message(text='Сгенерируй изображение', chat=types.Chat(id=12345))
db['12345']['images'] = '576x1024' 
TasksProcessing(message)
```