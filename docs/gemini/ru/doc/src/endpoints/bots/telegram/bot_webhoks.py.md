# Модуль `telegram_webhooks`

## Обзор

Этот модуль реализует Telegram бот, который работает с сервером FastAPI через RPC. 

Он использует библиотеку `telegram` для взаимодействия с Telegram API, `fastapi` для создания REST API, `xmlrpc.client` для RPC-взаимодействия, а также библиотеки `asyncio` и `threading` для асинхронной работы.

## Подробнее

Модуль `telegram_webhooks` является частью системы, которая обрабатывает запросы от Telegram бота. 

- **Классы**: 
    - `TelegramBot`: Основной класс бота, который инициализирует конфигурацию, регистрацию обработчиков и запуск бота.
    - `BotHandler`: Класс, который отвечает за обработку сообщений от Telegram API.
- **Функции**:
    - `_register_default_handlers`: Функция для регистрации стандартных обработчиков.
    - `_handle_message`: Функция для обработки текстовых сообщений.
    - `initialize_bot_webhook`: Функция для инициализации вебхука Telegram бота.
    - `_register_route_via_rpc`: Функция для регистрации маршрута вебхука через RPC.
    - `stop`: Функция для остановки бота и удаления вебхука.

## Классы

### `TelegramBot`

**Описание**: Интерфейсный класс Telegram бота, реализован как Singleton.

**Наследует**: 
    - `object`

**Атрибуты**:
    - `token (str)`: Токен Telegram бота.
    - `port (int)`: Порт, который используется для запуска бота.
    - `route (str)`: Маршрут для FastAPI.
    - `config (SimpleNamespace)`: Конфигурация бота, загруженная из JSON-файла.
    - `application (Application)`: Объект бота из библиотеки `telegram.ext`.
    - `handler (BotHandler)`: Обработчик событий бота.

**Методы**:
    - `__init__(self, token: str, route: str = 'telegram_webhook')`: Инициализатор класса.
    - `run(self)`: Запускает бота, инициализирует RPC и вебхук.
    - `_register_default_handlers(self)`: Регистрирует стандартные обработчики.
    - `_handle_message(self, update: Update, context: CallbackContext) -> None`: Обрабатывает текстовые сообщения.
    - `initialize_bot_webhook(self, route: str)`: Инициализирует вебхук Telegram бота.
    - `_register_route_via_rpc(self, rpc_client: ServerProxy)`: Регистрирует маршрут вебхука через RPC.
    - `stop(self)`: Останавливает бота и удаляет вебхук.

## Функции

### `_register_default_handlers`

**Назначение**: Регистрация стандартных обработчиков для бота. 

**Параметры**:
    - `self`: Экземпляр класса `TelegramBot`.

**Возвращает**:
    - `None`: Не возвращает значения.

**Вызывает исключения**:
    - `Exception`: Если возникают ошибки во время регистрации обработчиков.

**Как работает функция**:
    - Добавляет обработчики для команд `/start`, `/help`, `/sendpdf` и для текстовых сообщений.
    - Использует метод `add_handler` объекта `application`.

### `_handle_message`

**Назначение**: Обработка текстовых сообщений от Telegram бота.

**Параметры**:
    - `self`: Экземпляр класса `TelegramBot`.
    - `update (Update)`: Объект обновления из библиотеки `telegram.ext`.
    - `context (CallbackContext)`: Контекст вызова обработчика.

**Возвращает**:
    - `None`: Не возвращает значения.

**Вызывает исключения**:
    - `Exception`: Если возникают ошибки во время обработки сообщения.

**Как работает функция**:
    - Вызывает функцию `handle_message` класса `BotHandler` для обработки сообщения.
    - Использует асинхронную функцию `asyncio.ensure_future` для запуска обработчика в отдельной задаче.

### `initialize_bot_webhook`

**Назначение**: Инициализация вебхука Telegram бота.

**Параметры**:
    - `self`: Экземпляр класса `TelegramBot`.
    - `route (str)`: Маршрут для вебхука.

**Возвращает**:
    - `str`: URL вебхука, если инициализация прошла успешно.
    - `False`: Если возникли ошибки.

**Вызывает исключения**:
    - `Exception`: Если возникают ошибки во время инициализации вебхука.

**Как работает функция**:
    - Определяет URL вебхука на основе имени хоста и маршрута.
    - Если хост — localhost или 127.0.0.1, то используется ngrok для создания туннеля и получения публичного URL.
    - Использует функцию `set_webhook` объекта `application.bot` для установки вебхука.
    - Возвращает URL вебхука, если установка прошла успешно, иначе — `False`.

### `_register_route_via_rpc`

**Назначение**: Регистрация маршрута вебхука Telegram бота через RPC.

**Параметры**:
    - `self`: Экземпляр класса `TelegramBot`.
    - `rpc_client (ServerProxy)`: Клиент RPC.

**Возвращает**:
    - `None`: Не возвращает значения.

**Вызывает исключения**:
    - `Exception`: Если возникают ошибки во время регистрации маршрута.

**Как работает функция**:
    - Использует функцию `add_new_route` клиента RPC для регистрации маршрута.
    - Передает в функцию маршрут, имя обработчика (`self.bot_handler.handle_message`) и список HTTP-методов (`POST`).

### `stop`

**Назначение**: Остановка Telegram бота и удаление вебхука.

**Параметры**:
    - `self`: Экземпляр класса `TelegramBot`.

**Возвращает**:
    - `None`: Не возвращает значения.

**Вызывает исключения**:
    - `Exception`: Если возникают ошибки во время остановки бота или удаления вебхука.

**Как работает функция**:
    - Останавливает бота с помощью метода `stop` объекта `application`.
    - Удаляет вебхук с помощью метода `delete_webhook` объекта `application.bot`.