# Модуль Throttling Middleware

## Обзор

Модуль `throttling.py` предоставляет класс `ThrottlingMiddleware`, который реализует механизм ограничения частоты вызовов (throttling) для Telegram-бота. Этот класс используется для предотвращения спама и обеспечения стабильной работы бота при большом количестве запросов.

## Подробнее

Throttling Middleware работает, используя кеш `TTLCache` для отслеживания последних запросов от пользователей. Каждый пользователь имеет лимит времени, в течение которого он может отправлять запросы. Если пользователь превышает этот лимит, его запросы игнорируются. 

Данный механизм позволяет избежать перегрузки бота и обеспечивает стабильную работу при большом количестве запросов.


## Классы

### `ThrottlingMiddleware`

**Описание**: Класс `ThrottlingMiddleware` реализует механизм throttling для Telegram-бота.

**Наследует**: `BaseMiddleware`

**Атрибуты**:
- `limit` (`TTLCache`): Кеш для хранения информации о последних запросах пользователей.

**Методы**:

- `__init__(self, time_limit: int = 2) -> None`
  - **Назначение**: Инициализирует экземпляр класса `ThrottlingMiddleware`.
  - **Параметры**:
    - `time_limit` (`int`): Максимальное количество секунд, которое пользователь может ожидать ответа после отправки запроса. По умолчанию 2 секунды.
  - **Возвращает**: `None`

- `__call__(self, handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]], event: Message, data: Dict[str, Any]) -> Any`
  - **Назначение**: Выполняет проверку throttling и вызывает обработчик запроса, если он не превышает лимит.
  - **Параметры**:
    - `handler` (`Callable[[Message, Dict[str, Any]], Awaitable[Any]]`): Обработчик запроса, который будет вызываться, если throttling не превышен.
    - `event` (`Message`): Telegram-сообщение, которое инициировало запрос.
    - `data` (`Dict[str, Any]`): Данные, связанные с запросом.
  - **Возвращает**: `Any`: Возвращает результат выполнения обработчика запроса.

**Как работает**:

1. Класс использует `TTLCache` для отслеживания последних запросов от пользователей. Каждый пользователь имеет лимит времени, в течение которого он может отправлять запросы.
2. При получении нового запроса, класс проверяет, был ли пользователь ограничен. 
3. Если пользователь был ограничен, запрос игнорируется.
4. Если пользователь не был ограничен, его ID записывается в кэш, и обработчик запроса вызывается.
5. Время жизни записи в кэше `time_limit`, которое передается в конструктор класса.

**Примеры**:

```python
from src.endpoints.bots.telegram.movie_bot-main.middlewares.throttling import ThrottlingMiddleware

# Создание экземпляра класса ThrottlingMiddleware
throttling = ThrottlingMiddleware(time_limit=3)

# Проверка throttling перед вызовом обработчика запроса
async def handle_message(event: Message, data: Dict[str, Any]):
    # ... Логика обработки сообщения ...
    return # ... Результат обработки ...

# Вызов обработчика запроса через ThrottlingMiddleware
result = await throttling(handle_message, event, data)
```