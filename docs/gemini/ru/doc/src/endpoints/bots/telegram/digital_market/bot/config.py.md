# Модуль конфигурации для Telegram-бота цифрового рынка
## Обзор

Модуль `config.py` предназначен для хранения и управления конфигурационными параметрами Telegram-бота цифрового рынка. Он использует библиотеку `pydantic-settings` для загрузки параметров из переменных среды, что позволяет гибко настраивать бота для различных окружений (разработка, тестирование, продакшн) без изменения кода. В модуле определен класс `Settings`, который содержит все необходимые параметры для работы бота, такие как токен бота, идентификаторы администраторов, токен провайдера платежей, URL сайта и другие.

## Подробней

Этот модуль является ключевым компонентом проекта `hypotez`, так как он обеспечивает централизованное хранение и управление конфигурацией Telegram-бота. Использование `pydantic-settings` упрощает процесс загрузки параметров из переменных среды и обеспечивает их валидацию. Это позволяет избежать ошибок, связанных с неправильной конфигурацией бота.

## Классы

### `Settings`

**Описание**: Класс `Settings` наследуется от `BaseSettings` и представляет собой модель конфигурации, которая автоматически загружает параметры из переменных среды, указанных в файле `.env`.

**Наследует**:
- `BaseSettings` из библиотеки `pydantic_settings`.

**Атрибуты**:
- `BOT_TOKEN` (str): Токен Telegram-бота.
- `ADMIN_IDS` (List[int]): Список идентификаторов администраторов бота.
- `PROVIDER_TOKEN` (str): Токен провайдера платежей.
- `FORMAT_LOG` (str): Формат логов (по умолчанию: "{time:YYYY-MM-DD at HH:mm:ss} | {level} | {message}").
- `LOG_ROTATION` (str): Размер ротации логов (по умолчанию: "10 MB").
- `DB_URL` (str): URL базы данных (по умолчанию: 'sqlite+aiosqlite:///data/db.sqlite3').
- `SITE_URL` (str): URL сайта.
- `SITE_HOST` (str): Хост сайта.
- `SITE_PORT` (int): Порт сайта.
- `MRH_LOGIN` (str): Логин MRH (Merchant Reference Handle).
- `MRH_PASS_1` (str): Пароль MRH (часть 1).
- `MRH_PASS_2` (str): Пароль MRH (часть 2).
- `IN_TEST` (int): Флаг, указывающий на тестовый режим.

**Параметры**:
- Все параметры загружаются из переменных среды или имеют значения по умолчанию.

**Принцип работы**:
Класс `Settings` использует `pydantic_settings` для автоматической загрузки параметров из переменных среды. Он также определяет два динамических свойства: `get_webhook_url` и `get_provider_hook_url`, которые формируют URL для вебхуков на основе токена бота и URL сайта. Конфигурация происходит автоматически при создании экземпляра класса.

## Методы класса

### `get_webhook_url`

```python
    @property
    def get_webhook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
```

**Назначение**: Формирует URL для вебхука Telegram-бота на основе токена бота и URL сайта.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `str`: URL для вебхука.

**Примеры**:
```python
settings = Settings(BOT_TOKEN='test_bot', SITE_URL='https://example.com')
webhook_url = settings.get_webhook_url
print(webhook_url)  # Вывод: https://example.com/test_bot
```

### `get_provider_hook_url`

```python
    @property
    def get_provider_hook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
```

**Назначение**: Формирует URL для вебхука провайдера платежей на основе URL сайта и фиксированного пути `/robokassa`.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `str`: URL для вебхука провайдера платежей.

**Примеры**:
```python
settings = Settings(SITE_URL='https://example.com')
provider_hook_url = settings.get_provider_hook_url
print(provider_hook_url)  # Вывод: https://example.com/robokassa
```

## Переменные модуля

- `settings` (`Settings`): Экземпляр класса `Settings`, содержащий конфигурационные параметры бота.
- `bot` (`Bot`): Экземпляр класса `Bot` из библиотеки `aiogram`, инициализированный с токеном бота и режимом парсинга HTML.
- `dp` (`Dispatcher`): Экземпляр класса `Dispatcher` из библиотеки `aiogram`, используемый для регистрации обработчиков событий.
- `admins` (`List[int]`): Список идентификаторов администраторов бота, полученный из настроек.
- `log_file_path` (`str`): Путь к файлу логов.
- `logger` : Инстанс логгера из модуля `loguru`, настроенный для записи логов в файл с определенным форматом и ротацией.
- `database_url` (`str`): URL базы данных.

## Инициализация бота и диспетчера

```python
bot = Bot(token=settings.BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())
admins = settings.ADMIN_IDS
```

Создается экземпляр бота с использованием токена из настроек и устанавливается режим парсинга HTML.  
Создается диспетчер для обработки входящих сообщений и колбэков.  
Список администраторов берется из настроек.

## Настройка логирования

```python
log_file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "log.txt")
logger.add(log_file_path, format=settings.FORMAT_LOG, level="INFO", rotation=settings.LOG_ROTATION)
```

Определяется путь к файлу логов и настраивается модуль `logger` для записи логов в файл с определенным форматом, уровнем и ротацией.

## URL базы данных

```python
database_url = settings.DB_URL
```

URL базы данных берется из настроек.