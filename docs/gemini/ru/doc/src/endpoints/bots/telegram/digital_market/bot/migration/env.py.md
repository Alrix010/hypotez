# Документация для `env.py`

## Обзор

Файл `env.py` предназначен для настройки и запуска миграций базы данных в проекте `hypotez`. Он использует `alembic` для управления изменениями схемы базы данных, обеспечивая возможность автоматического обновления и отката структуры базы данных.

## Подробней

Этот файл содержит функции для запуска миграций как в онлайн, так и в оффлайн режимах, а также асинхронные функции для работы с базой данных. Он настраивает параметры подключения к базе данных, определяет целевую метадату и запускает процесс миграции. Миграции позволяют изменять структуру базы данных контролируемым образом, что важно для поддержания актуальности схемы базы данных при развитии проекта.

## Функции

### `run_migrations_offline`

**Назначение**: Запускает миграции в "offline" режиме.

**Как работает функция**:
- Функция настраивает контекст `alembic` только с URL базы данных, без создания Engine.
- Это позволяет запускать миграции без необходимости доступного DBAPI.
- `context.execute()` передает заданную строку в вывод скрипта.

```python
def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    ...
```
### `do_run_migrations`

**Назначение**: Запускает миграции, используя предоставленное подключение к базе данных.

**Параметры**:
- `connection` (Connection): Объект подключения к базе данных SQLAlchemy.

**Как работает функция**:
- Настраивает контекст `alembic` с использованием предоставленного подключения и целевой метадаты.
- Запускает миграции в рамках транзакции.

```python
def do_run_migrations(connection: Connection) -> None:
    """ """
    ...
```

### `run_async_migrations`

**Назначение**: Асинхронно запускает миграции базы данных.

**Как работает функция**:
- Создает асинхронный Engine с использованием параметров из конфигурации.
- Устанавливает соединение с базой данных и запускает миграции с использованием `do_run_migrations`.
- После завершения миграций закрывает соединение с базой данных.

```python
async def run_async_migrations() -> None:
    """ """
    ...
```

### `run_migrations_online`

**Назначение**: Запускает миграции в "online" режиме.

**Как работает функция**:
- Использует `asyncio.run` для запуска асинхронных миграций.

```python
def run_migrations_online() -> None:
    """ """
    ...
```

## Логика запуска миграций

В зависимости от того, находится ли `alembic` в режиме offline или online, вызывается соответствующая функция для запуска миграций:

```python
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```