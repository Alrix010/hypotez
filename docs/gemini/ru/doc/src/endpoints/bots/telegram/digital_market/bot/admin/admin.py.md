# Модуль для администрирования бота
=================================================

Модуль содержит обработчики событий для админ-панели бота, 
предоставляя функциональность управления товарами, получение статистики 
и удаление товаров.

## Оглавление

- [Введение](#введение)
- [Классы](#классы)
    - [AddProduct](#addproduct)
- [Функции](#функции)
    - [start_admin](#start_admin)
    - [admin_statistic](#admin_statistic)
    - [admin_process_cancel](#admin_process_cancel)
    - [admin_process_start_dell](#admin_process_start_dell)
    - [admin_process_products](#admin_process_products)
    - [admin_process_add_product](#admin_process_add_product)
    - [admin_process_name](#admin_process_name)
    - [admin_process_description](#admin_process_description)
    - [admin_process_category](#admin_process_category)
    - [admin_process_price](#admin_process_price)
    - [admin_process_without_file](#admin_process_without_file)
    - [admin_process_hidden_content](#admin_process_hidden_content)
    - [admin_process_confirm_add](#admin_process_confirm_add)

## Введение
  
Данный модуль содержит код, отвечающий за управление админ-панелью 
телеграм-бота. Он предоставляет следующие возможности:
 
 - **Управление товарами:**
   - Добавление новых товаров с указанием имени, описания, цены, 
   файла (опционально) и категории.
   - Удаление товаров из базы данных.
 - **Получение статистики:** 
   - Вывод информации о количестве пользователей, 
   новых пользователей за день, неделю и месяц.
   - Вывод статистики по заказам.
   - Вывод списка всех товаров в базе данных.
 - **Обработка команд:** 
   - Отмена сценария добавления товара.
   - Переход к различным режимам админ-панели. 
   - Подтверждение добавления товара. 
   
## Классы

### `AddProduct`

**Описание**: Класс, представляющий состояния 
в FSM (Finite State Machine - конечный автомат) 
для сценария добавления товара.

**Атрибуты**:
 - **name**: Состояние ввода имени товара.
 - **description**: Состояние ввода описания товара.
 - **price**: Состояние ввода цены товара.
 - **file_id**: Состояние выбора файла (опционально).
 - **category_id**: Состояние выбора категории товара.
 - **hidden_content**: Состояние ввода контента, 
 который отобразится после покупки товара.
 - **confirm_add**: Состояние подтверждения добавления товара.

## Функции

### `start_admin`

**Назначение**: Функция, обрабатывающая запрос на вход 
в админ-панель.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.

**Возвращает**: 
 - `None`.

**Как работает функция**:
 
 - Отвечает на запрос пользователя, 
 подтверждая доступ в админ-панель.
 - Изменяет текст сообщения с приветствием 
 и кнопками выбора действия. 
 - Обрабатывает возможные ошибки при изменении 
 текста сообщения, делая попытку удалить 
 старое сообщение и отправить новое.

### `admin_statistic`

**Назначение**: Функция, обрабатывающая запрос 
на получение статистики.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **session_without_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Отвечает на запрос пользователя, 
 подтверждая сбор статистики.
 - Извлекает статистику пользователей из базы данных 
 с помощью `UserDAO.get_statistics`.
 - Извлекает статистику по заказам из базы данных 
 с помощью `PurchaseDao.get_payment_stats`.
 - Формирует текстовое сообщение с полученной статистикой.
 - Изменяет текст сообщения, отображая статистику 
 на месте запроса.

### `admin_process_cancel`

**Назначение**: Функция, обрабатывающая команду 
отмены добавления товара.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Очищает состояние конечного автомата 
 с помощью `state.clear()`.
 - Отвечает на запрос пользователя, 
 подтверждая отмену.
 - Удаляет предыдущее сообщение.
 - Отправляет новое сообщение с информацией 
 об отмене и кнопкой возврата в админ-панель.

### `admin_process_start_dell`

**Назначение**: Функция, обрабатывающая запрос 
на удаление товара.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **session_without_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Отвечает на запрос пользователя, 
 подтверждая запуск режима удаления товара.
 - Извлекает все товары из базы данных 
 с помощью `ProductDao.find_all`.
 - Отправляет сообщение с информацией 
 о количестве товаров в базе данных.
 - Отправляет сообщение с информацией 
 о каждом товаре, 
 включая название, описание, цену, 
 скрытый контент и наличие файла.
 - Привязывает кнопку удаления товара к каждому 
 сообщению с помощью `dell_product_kb(product_data.id)`.

### `admin_process_products`

**Назначение**: Функция, обрабатывающая запрос 
на управление товарами.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **session_without_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Отвечает на запрос пользователя, 
 подтверждая запуск режима управления товарами.
 - Извлекает количество товаров из базы данных 
 с помощью `ProductDao.count`.
 - Изменяет текст сообщения, 
 отображая информацию о количестве товаров 
 и кнопки для управления.

### `admin_process_add_product`

**Назначение**: Функция, обрабатывающая 
запрос на добавление товара.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Отвечает на запрос пользователя, 
 подтверждая запуск сценария добавления товара.
 - Удаляет предыдущее сообщение.
 - Отправляет сообщение с запросом 
 на ввод имени товара.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.name`.

### `admin_process_name`

**Назначение**: Функция, обрабатывающая 
ввод имени товара.

**Параметры**:
 - **message (Message)**: Объект Message, 
 содержащий информацию о сообщении.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Сохраняет введенное имя товара 
 в state.
 - Удаляет предыдущее сообщение.
 - Отправляет сообщение с запросом 
 на ввод описания товара.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.description`.

### `admin_process_description`

**Назначение**: Функция, обрабатывающая 
ввод описания товара.

**Параметры**:
 - **message (Message)**: Объект Message, 
 содержащий информацию о сообщении.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.
 - **session_without_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Сохраняет введенное описание товара 
 в state.
 - Удаляет предыдущее сообщение.
 - Извлекает список категорий из базы данных 
 с помощью `CategoryDao.find_all`.
 - Отправляет сообщение с запросом 
 на выбор категории товара.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.category_id`.

### `admin_process_category`

**Назначение**: Функция, обрабатывающая 
выбор категории товара.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Извлекает ID выбранной категории 
 из данных запроса.
 - Сохраняет ID категории в state.
 - Отвечает на запрос пользователя, 
 подтверждая выбор категории.
 - Изменяет текст сообщения, 
 отображая запрос на ввод цены.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.price`.

### `admin_process_price`

**Назначение**: Функция, обрабатывающая 
ввод цены товара.

**Параметры**:
 - **message (Message)**: Объект Message, 
 содержащий информацию о сообщении.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Пытается преобразовать введенное 
 значение в число с помощью `int(message.text)`.
 - В случае успешного преобразования 
 сохраняет цену в state.
 - Удаляет предыдущее сообщение.
 - Отправляет сообщение с запросом 
 на отправку файла (документа) 
 или выбор "БЕЗ ФАЙЛА".
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.file_id`.
 - В случае ошибки преобразования 
 отправляет сообщение об ошибке.

### `admin_process_without_file`

**Назначение**: Функция, обрабатывающая 
выбор "БЕЗ ФАЙЛА".

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Сохраняет `None` в state в качестве ID файла.
 - Отвечает на запрос пользователя, 
 подтверждая, что файл не выбран.
 - Изменяет текст сообщения, 
 отображая запрос на ввод скрытого контента.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.hidden_content`.

### `admin_process_hidden_content`

**Назначение**: Функция, обрабатывающая 
ввод скрытого контента.

**Параметры**:
 - **message (Message)**: Объект Message, 
 содержащий информацию о сообщении.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.
 - **session_without_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Сохраняет введенный скрытый контент 
 в state.
 - Извлекает данные о товаре из state.
 - Извлекает информацию о категории 
 из базы данных с помощью 
 `CategoryDao.find_one_or_none_by_id`.
 - Формирует текстовое сообщение 
 с информацией о товаре для проверки.
 - Отправляет сообщение с информацией 
 о товаре и кнопкой подтверждения.
 - Сохраняет ID последнего сообщения 
 в state.
 - Устанавливает текущее состояние 
 конечного автомата в `AddProduct.confirm_add`.

### `admin_process_confirm_add`

**Назначение**: Функция, обрабатывающая 
подтверждение добавления товара.

**Параметры**:
 - **call (CallbackQuery)**: Объект CallbackQuery, 
 содержащий информацию о запросе.
 - **state (FSMContext)**: Объект FSMContext, 
 содержащий информацию о состоянии 
 конечного автомата.
 - **session_with_commit (AsyncSession)**: 
 Объект AsyncSession, 
 представляющий соединение с базой данных.

**Возвращает**: 
 - `None`.

**Как работает функция**:

 - Отвечает на запрос пользователя, 
 подтверждая сохранение товара.
 - Извлекает данные о товаре из state.
 - Удаляет предыдущее сообщение.
 - Сохраняет товар в базе данных 
 с помощью `ProductDao.add`.
 - Отправляет сообщение с подтверждением 
 добавления товара.