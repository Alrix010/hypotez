# Модуль для администрирования Telegram-бота цифрового магазина

## Обзор

Данный модуль содержит функциональность для администрирования Telegram-бота цифрового магазина. Он включает в себя обработку команд администратора, управление статистикой, добавление и удаление товаров, а также управление категориями. Модуль использует библиотеку `aiogram` для взаимодействия с Telegram API и `SQLAlchemy` для работы с базой данных.

## Подробней

Модуль предназначен для автоматизации задач администрирования бота, предоставляя администраторам удобный интерфейс для управления контентом и мониторинга активности пользователей. Он позволяет собирать статистику, добавлять новые товары с описаниями, ценами и файлами, а также удалять существующие товары из базы данных.

## Классы

### `AddProduct`

**Описание**: Класс, представляющий FSM (машина состояний) для процесса добавления товара.

**Наследует**: `StatesGroup` из `aiogram.fsm.state`.

**Атрибуты**:
- `name` (State): Состояние для ввода имени товара.
- `description` (State): Состояние для ввода описания товара.
- `price` (State): Состояние для ввода цены товара.
- `file_id` (State): Состояние для выбора или загрузки файла товара.
- `category_id` (State): Состояние для выбора категории товара.
- `hidden_content` (State): Состояние для ввода скрытого контента товара.
- `confirm_add` (State): Состояние для подтверждения добавления товара.

## Функции

### `start_admin`

**Назначение**: Обработчик callback-запроса для запуска панели администратора.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.

**Как работает функция**:
- Проверяет, имеет ли пользователь доступ к панели администратора (его ID должен быть в списке `settings.ADMIN_IDS`).
- Отправляет сообщение с клавиатурой администратора, предоставляющей различные опции управления.
- Обрабатывает исключения, если не удается отредактировать или отправить сообщение.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "admin_panel" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_statistic`

**Назначение**: Обработчик callback-запроса для получения статистики.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

**Как работает функция**:
- Собирает статистику пользователей и общую статистику по заказам, используя методы `UserDAO.get_statistics` и `PurchaseDao.get_payment_stats`.
- Формирует текстовое сообщение со статистикой и отправляет его пользователю.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "statistic" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_process_cancel`

**Назначение**: Обработчик callback-запроса для отмены процесса добавления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Очищает состояние пользователя, отменяя текущий сценарий добавления товара.
- Отправляет сообщение об отмене добавления товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "cancel" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_process_start_dell`

**Назначение**: Обработчик callback-запроса для запуска процесса удаления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

**Как работает функция**:
- Получает список всех товаров из базы данных.
- Отправляет сообщение со списком товаров и кнопками для удаления каждого товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "delete_product" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_process_start_dell` (удаление товара)

**Назначение**: Обработчик callback-запроса для фактического удаления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных с коммитом изменений.

**Как работает функция**:
- Извлекает ID товара из данных callback-запроса.
- Удаляет товар из базы данных с использованием `ProductDao.delete`.
- Отправляет уведомление об успешном удалении товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Нажата кнопка с callback_data, начинающейся с "dell_" пользователем с ID в списке ADMIN_IDS
```

### `admin_process_products`

**Назначение**: Обработчик callback-запроса для управления товарами.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

**Как работает функция**:
- Получает общее количество товаров из базы данных.
- Отправляет сообщение с клавиатурой для управления товарами (добавление, удаление, редактирование).

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "process_products" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_process_add_product`

**Назначение**: Обработчик callback-запроса для запуска процесса добавления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Устанавливает начальное состояние `AddProduct.name` для процесса добавления товара.
- Запрашивает у пользователя имя товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "add_product" нажата пользователем с ID в списке ADMIN_IDS
```

### `admin_process_name`

**Назначение**: Обработчик текстового сообщения для ввода имени товара.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Обновляет состояние `name` в FSMContext, сохраняя введенное имя товара.
- Запрашивает у пользователя короткое описание товара.

**Примеры**:
```python
# Пример вызова (неявный, через текстовое сообщение)
# Пользователь с ID в списке ADMIN_IDS отправил текстовое сообщение, находясь в состоянии AddProduct.name
```

### `admin_process_description`

**Назначение**: Обработчик текстового сообщения для ввода описания товара.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

**Как работает функция**:
- Обновляет состояние `description` в FSMContext, сохраняя введенное описание товара.
- Получает список категорий товаров из базы данных.
- Предлагает пользователю выбрать категорию товара.

**Примеры**:
```python
# Пример вызова (неявный, через текстовое сообщение)
# Пользователь с ID в списке ADMIN_IDS отправил текстовое сообщение, находясь в состоянии AddProduct.description
```

### `admin_process_category`

**Назначение**: Обработчик callback-запроса для выбора категории товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Извлекает ID категории из данных callback-запроса.
- Обновляет состояние `category_id` в FSMContext, сохраняя выбранную категорию.
- Запрашивает у пользователя цену товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Нажата кнопка с callback_data, начинающейся с "add_category_" пользователем с ID в списке ADMIN_IDS, находясь в состоянии AddProduct.category_id
```

### `admin_process_price`

**Назначение**: Обработчик текстового сообщения для ввода цены товара.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Пытается преобразовать введенный текст в число (цену товара).
- Обновляет состояние `price` в FSMContext, сохраняя цену товара.
- Предлагает пользователю отправить файл товара или выбрать опцию "без файла".
- Обрабатывает исключение `ValueError`, если введенный текст не является числом.

**Примеры**:
```python
# Пример вызова (неявный, через текстовое сообщение)
# Пользователь с ID в списке ADMIN_IDS отправил текстовое сообщение, находясь в состоянии AddProduct.price
```

### `admin_process_without_file` (без файла)

**Назначение**: Обработчик callback-запроса для выбора опции "без файла".

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Обновляет состояние `file_id` в FSMContext, устанавливая его в `None`.
- Предлагает пользователю ввести скрытый контент товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "without_file" нажата пользователем с ID в списке ADMIN_IDS, находясь в состоянии AddProduct.file_id
```

### `admin_process_without_file` (с файлом)

**Назначение**: Обработчик сообщения с документом для загрузки файла товара.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.

**Как работает функция**:
- Обновляет состояние `file_id` в FSMContext, сохраняя file_id загруженного документа.
- Предлагает пользователю ввести скрытый контент товара.

**Примеры**:
```python
# Пример вызова (неявный, через сообщение с документом)
# Пользователь с ID в списке ADMIN_IDS отправил сообщение с документом, находясь в состоянии AddProduct.file_id
```

### `admin_process_hidden_content`

**Назначение**: Обработчик текстового сообщения для ввода скрытого контента товара.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных без коммита.

**Как работает функция**:
- Обновляет состояние `hidden_content` в FSMContext, сохраняя введенный скрытый контент.
- Получает данные о товаре и категории из FSMContext и базы данных.
- Формирует текст с информацией о товаре для подтверждения.
- Отправляет сообщение с информацией о товаре и клавиатурой для подтверждения добавления.

**Примеры**:
```python
# Пример вызова (неявный, через текстовое сообщение)
# Пользователь с ID в списке ADMIN_IDS отправил текстовое сообщение, находясь в состоянии AddProduct.hidden_content
```

### `admin_process_confirm_add`

**Назначение**: Обработчик callback-запроса для подтверждения добавления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса от пользователя.
- `state` (FSMContext): Контекст машины состояний для управления состоянием пользователя.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных с коммитом изменений.

**Как работает функция**:
- Получает данные о товаре из FSMContext.
- Удаляет сообщение с подтверждением товара.
- Добавляет товар в базу данных с использованием `ProductDao.add`.
- Отправляет уведомление об успешном добавлении товара.

**Примеры**:
```python
# Пример вызова (неявный, через callback-запрос)
# Кнопка "confirm_add" нажата пользователем с ID в списке ADMIN_IDS, находясь в состоянии AddProduct.confirm_add