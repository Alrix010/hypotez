# –ú–æ–¥—É–ª—å main.py 

## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å `main.py` - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram –±–æ—Ç–∞. 

- –í –Ω–µ–º —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞.
- –ó–∞–¥–∞—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –º–∏–¥–ª–≤–∞—Ä–∏ –∏ –º–∞—Ä—à—Ä—É—Ç—ã.
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `aiohttp`. 

## –ü–æ–¥—Ä–æ–±–Ω–µ–µ

–ú–æ–¥—É–ª—å `main.py`  –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Telegram –±–æ—Ç–∞:

- **`aiogram`:** —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–∞–º–∏.
- **`aiohttp`:**  –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å HTTP –∑–∞–ø—Ä–æ—Å–∞–º–∏.
- **`loguru`:**  –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –ª–æ–≥–æ–≤.

## –ö–ª–∞—Å—Å—ã

### `DatabaseMiddlewareWithoutCommit`

**–û–ø–∏—Å–∞–Ω–∏–µ**:  –ú–∏–¥–ª–≤–∞—Ä—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è).

**–ê—Ç—Ä–∏–±—É—Ç—ã**:

- `db` (`Database`):  –û–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

### `DatabaseMiddlewareWithCommit`

**–û–ø–∏—Å–∞–Ω–∏–µ**:  –ú–∏–¥–ª–≤–∞—Ä—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ–≤–µ—Ä—à–µ–Ω–∏–µ–º –∫–æ–º–º–∏—Ç–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è).

**–ê—Ç—Ä–∏–±—É—Ç—ã**:

- `db` (`Database`):  –û–±—ä–µ–∫—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## –§—É–Ω–∫—Ü–∏–∏

### `set_default_commands()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–æ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
 - `commands` (List[BotCommand]): –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
 - `None`

**–ü—Ä–∏–º–µ—Ä**:
```python
commands = [BotCommand(command='start', description='–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞')]
await bot.set_my_commands(commands, BotCommandScopeDefault())
```

### `on_startup(app)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `aiohttp`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `app` (web.Application): –û–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `aiohttp`.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `None`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–æ—Ç–∞ (`set_default_commands()`).
-  –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –¥–ª—è –±–æ—Ç–∞.
-  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∞–¥–º–∏–Ω–∞–º –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.
-  –í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥ –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
async def on_startup(app):
    await set_default_commands()
    await bot.set_webhook(settings.get_webhook_url)
    for admin_id in admins:
        try:
            await bot.send_message(admin_id, '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω ü•≥.')
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")
```

### `on_shutdown(app)`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `aiohttp`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `app` (web.Application): –û–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `aiohttp`.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `None`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∞–¥–º–∏–Ω–∞–º –æ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞.
-  –£–¥–∞–ª—è–µ—Ç webhook –¥–ª—è –±–æ—Ç–∞.
-  –ó–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –±–æ—Ç–∞.
-  –í—ã–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥ –æ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞.

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
async def on_shutdown(app):
    for admin_id in admins:
        try:
            await bot.send_message(admin_id, '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ—á–µ–º—É? üòî')
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    await bot.delete_webhook(drop_pending_updates=True)
    await bot.session.close()
    logger.error("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
```

### `register_middlewares()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä–∏ –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –±–æ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `None`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `None`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä—É `DatabaseMiddlewareWithoutCommit` –¥–ª—è –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä—É `DatabaseMiddlewareWithCommit` –¥–ª—è –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
def register_middlewares():
    dp.update.middleware.register(DatabaseMiddlewareWithoutCommit())
    dp.update.middleware.register(DatabaseMiddlewareWithCommit())
```

### `register_routers()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã (—Ä–æ—É—Ç–µ—Ä—ã) –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –±–æ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `None`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `None`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –í–∫–ª—é—á–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç `catalog_router`.
-  –í–∫–ª—é—á–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç `user_router`.
-  –í–∫–ª—é—á–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç `admin_router`.

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
def register_routers():
    dp.include_router(catalog_router)
    dp.include_router(user_router)
    dp.include_router(admin_router)
```

### `create_app()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `aiohttp`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `None`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `web.Application`: –û–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `aiohttp`.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `aiohttp`.
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (—Ä–æ—É—Ç–µ—Ä—ã).
-  –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ `dp` –∏ –±–æ—Ç–∞ `bot`.
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ (`on_startup`) –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (`on_shutdown`).

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
def create_app():
    app = web.Application()
    app.router.add_post(f"/{settings.BOT_TOKEN}", handle_webhook)
    app.router.add_post("/robokassa/result/", robokassa_result)
    app.router.add_get("/robokassa/fail/", robokassa_fail)
    app.router.add_get("/", home_page)
    setup_application(app, dp, bot=bot)
    app.on_startup.append(on_startup)
    app.on_shutdown.append(on_shutdown)
    return app
```

### `main()`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:  –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**: 
- `None`

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**: 
- `None`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä–∏ (`register_middlewares()`).
-  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã (`register_routers()`).
-  –°–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ `aiohttp` (`create_app()`).
-  –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

**–ü—Ä–∏–º–µ—Ä—ã**:
```python
def main():
    register_middlewares()
    register_routers()
    app = create_app()
    web.run_app(app, host=settings.SITE_HOST, port=settings.SITE_PORT)