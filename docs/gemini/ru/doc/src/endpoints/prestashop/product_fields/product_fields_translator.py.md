# Модуль `product_fields_translator`

## Обзор

Модуль `product_fields_translator` предназначен для перевода полей товара на языки, используемые в клиентской базе данных. Он содержит функции для преобразования и адаптации структуры данных о товарах, полученных из PrestaShop, к формату, необходимому для корректного отображения на стороне клиента.

## Подробней

Этот модуль играет важную роль в процессе интеграции данных о товарах из PrestaShop в клиентскую систему. Он обеспечивает соответствие языковых идентификаторов и структуры данных, что позволяет избежать проблем с отображением мультиязычного контента. Модуль содержит функции для обработки словарей полей товара, сопоставления языков и обновления идентификаторов языков в соответствии со схемой клиентской базы данных.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
```

**Назначение**: Обновляет идентификатор языка в словаре `presta_fields_dict` на соответствующий идентификатор из схемы клиентских языков при совпадении языка страницы.

**Параметры**:

-   `presta_fields_dict` (dict): Словарь полей товара, который необходимо обновить.
-   `client_langs_schema` (list | dict): Схема языков клиента, используемая для сопоставления идентификаторов языков.
-   `page_lang` (str): Язык страницы, который используется для поиска соответствия в схеме клиентских языков.

**Возвращает**:

-   `dict`: Обновленный словарь `presta_fields_dict` с новыми идентификаторами языков.

**Как работает функция**:

1.  **Инициализация**: Функция начинает с поиска соответствующего идентификатора языка в схеме клиентских языков.
2.  **Поиск соответствия**: Перебирает языки в `client_langs_schema` и сравнивает `locale`, `iso_code` и `language_code` с `page_lang`.
3.  **Обновление идентификатора**: Если соответствие найдено, функция переходит к обновлению атрибута `id` в словаре `presta_fields_dict`.
4.  **Итерация по полям**: Функция итерирует по значениям словаря `presta_fields_dict` и, если находит поле с ключом `'language'`, обновляет идентификаторы языков в атрибуте `attrs`.
5.  **Завершение**: После обновления всех необходимых идентификаторов функция возвращает обновленный словарь `presta_fields_dict`.

**Примеры**:

Пример входных данных:

```python
presta_fields_dict = {
    'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Product Name'}]},
    'description': {'language': [{'attrs': {'id': '1'}, 'value': 'Product Description'}]}
}
client_langs_schema = [
    {'id': 10, 'locale': 'en-US', 'iso_code': 'en', 'language_code': 'en-us'},
    {'id': 20, 'locale': 'fr-FR', 'iso_code': 'fr', 'language_code': 'fr-fr'}
]
page_lang = 'en-US'
```

Вызов функции:

```python
updated_dict = rearrange_language_keys(presta_fields_dict, client_langs_schema, page_lang)
```

Результат:

```python
{
    'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Product Name'}]},
    'description': {'language': [{'attrs': {'id': '10'}, 'value': 'Product Description'}]}
}
```

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,\n
	    полученные с сайта поставщика в виде словаря \n
	    ```\n
	    {\n
	\t    \'language\':[\n
	\t\t\t\t\t    {\'attrs\':{\'id\':\'1\'}, \'value\':value},\n
	\t\t\t\t\t    ]\n
	    }\n
	    ```\n
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была \n
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.\n
	    Точные соответствия я получаю в схеме языков клиента \n
	    locator_description\n
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера\n
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON\n
	  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. \n
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
```

**Назначение**: Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента. Функция принимает словарь полей товара и схему языков клиента, и переводит значения полей в соответствии с этой схемой.

**Параметры**:

-   `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика.
-   `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
-   `page_lang` (str, optional): Язык страницы поставщика в коде (en-US, ru-RU, he_HE). Если не указан, функция пытается определить его автоматически.

**Возвращает**:

-   `dict`: Переведенный словарь полей товара.

**Как работает функция**:

1.  **Переупорядочивание ключей таблицы**: Вызывает функцию `rearrange_language_keys` для обновления идентификаторов языков в словаре `presta_fields_dict`.
2.  **Извлечение существующих переводов**: Вызывает функцию `get_translations_from_presta_translations_table` для получения существующих переводов товара из таблицы переводов.
3.  **Обработка отсутствующих переводов**: Если в таблице переводов нет перевода для данного товара, функция добавляет текущий перевод как новый.
4.  **Перевод полей**: Если переводы найдены, функция итерирует по языкам клиента и переведенным записям, чтобы обновить значения полей в `presta_fields_dict` на основе `iso_code` и `id` языка.
5.  **Обработка исключений**: В случае возникновения ошибки в процессе перевода, функция логирует ошибку.

**Примеры**:

Предположим, у нас есть следующие входные данные:

```python
presta_fields_dict = {
    'reference': '12345',
    'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Product Name'}]},
    'description': {'language': [{'attrs': {'id': '1'}, 'value': 'Product Description'}]}
}
client_langs_schema = [
    {'id': 10, 'locale': 'en-US', 'iso_code': 'en', 'language_code': 'en-us'},
    {'id': 20, 'locale': 'fr-FR', 'iso_code': 'fr', 'language_code': 'fr-fr'}
]
```

Вызов функции:

```python
translated_dict = translate_presta_fields_dict(presta_fields_dict, client_langs_schema)
```

Результат (пример):

```python
{
    'reference': '12345',
    'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Translated Product Name'}]},
    'description': {'language': [{'attrs': {'id': '10'}, 'value': 'Translated Product Description'}]}
}
```