# Модуль `product_fields`

## Обзор

Модуль `product_fields` предназначен для работы с полями товаров в PrestaShop. Он предоставляет класс `ProductFields`, который позволяет удобно управлять атрибутами товара, как основными, так и мультиязычными. Модуль содержит описание каждого поля товара для таблиц PrestaShop.

## Подробнее

Модуль предназначен для упрощения работы с полями товаров при взаимодействии с API PrestaShop. Он предоставляет удобный интерфейс для установки и получения значений различных полей товара, включая мультиязычные поля.

## Классы

### `ProductFields`

**Описание**: Класс `ProductFields` предназначен для представления и управления полями товара в формате, требуемом API PrestaShop.

**Атрибуты**:

- `presta_fields` (SimpleNamespace): Объект, хранящий все поля товара. Инициализируется в методе `_payload`.
- `id_lang` (int): ID языка, используемый по умолчанию для мультиязычных полей. По умолчанию равен 1.

**Методы**:

- `__post_init__()`: Вызывается после инициализации экземпляра класса. Используется для загрузки данных о полях товара.
- `_payload()`: Загружает значения полей по умолчанию.
- `_set_multilang_value()`: Устанавливает мультиязычное значение для поля.
- Свойства для доступа к полям таблицы `ps_product` и `ps_product_lang`.
- Методы для управления связями товара с другими сущностями (категории, изображения, комбинации и т.д.).
- `to_dict()`: Преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.
- `_format_multilang_value()`: Форматирует мультиязычные значения в формат, требуемый API PrestaShop.

**Принцип работы**:

Класс `ProductFields` использует `dataclass` для хранения полей товара. В методе `__post_init__` вызывается метод `_payload`, который загружает значения полей по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`. Для работы с мультиязычными полями используется метод `_set_multilang_value`, который позволяет устанавливать значения для разных языков. Свойства (properties) используются для доступа к полям товара и их установки. Метод `to_dict` преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

## Методы класса

### `__post_init__`

```python
def __post_init__(self):
    """"""
    self._payload()
```

**Назначение**: Инициализирует объект класса после его создания, вызывая метод `_payload` для загрузки данных о полях товара.

### `_payload`

```python
def _payload(self) -> bool:
    """
    Загрузка дефолтных значений полей.
    Returns:
        bool: True, если загрузка прошла успешно, иначе False.
    """
    ...
```

**Назначение**: Загружает значения полей товара по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Как работает функция**:
1. Функция определяет базовый путь к файлам со списками полей и значениями по умолчанию.
2. Извлекает список полей товара из файла `fields_list.txt`.
3. Инициализирует атрибут `presta_fields` как `SimpleNamespace` с полями, полученными из файла `fields_list.txt`.
4. Загружает значения по умолчанию из файла `product_fields_default_values.json`.
5. Устанавливает значения по умолчанию для полей в атрибуте `presta_fields`.
6. В случае возникновения исключений, логирует ошибки и возвращает `False`.

**Примеры**:
```python
product_fields = ProductFields()
success = product_fields._payload()
print(success)  # Выведет True, если загрузка прошла успешно
```

### `_set_multilang_value`

```python
def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = 1) -> bool:
    """
    Устанавливает мультиязычное значение для заданного поля.

    Args:
        field_name (str): Имя поля (например, 'name', 'description').
        value (str): Значение для установки.
        id_lang (Optional[Union[int, str]]): ID языка. Если не указан, используется self.id_lan.

    Описание:
        Функция устанавливает мультиязычное значение для указанного поля объекта.  
        Поле может хранить значения для разных языков.  Значения хранятся в виде списка словарей,
        где каждый словарь представляет собой значение для определенного языка и имеет структуру:

        {'attrs': {'id': 'language_id'}, 'value': 'language_value'}
         {'id': 'language_id'}, 'value': 'language_value'}

        - 'attrs': Словарь, содержащий атрибуты значения.  В данном случае, обязательным атрибутом является 'id',
                   который представляет собой идентификатор языка.
        - 'value': Значение поля для указанного языка.

        Если поле с указанным именем не существует, оно создается. Если поле существует, но не имеет
        ожидаемой структуры (словарь с ключом 'language', содержащим список), поле перезаписывается.
        Если поле существует и имеет правильную структуру, функция пытается обновить значение для
        указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык
        не существует, добавляется новая запись в список.

    Returns:
        bool: True, если значение успешно установлено, False в случае ошибки.
    """
    ...
```

**Назначение**: Устанавливает мультиязычное значение для указанного поля.

**Параметры**:
- `field_name` (str): Имя поля, для которого устанавливается значение.
- `value` (str): Значение, которое необходимо установить.
- `id_lang` (Optional[int | str]): ID языка. Если не указан, используется `self.id_lang`. По умолчанию равен 1.

**Возвращает**:
- `bool`: `True`, если значение успешно установлено, `False` в случае ошибки.

**Внутренние функции**:

#### `escape_and_strip`

```python
def escape_and_strip(text: str) -> str:
    """
    Очищает и экранирует строку, заменяя символы "\'" и \'"\' на "\\\'" и \'\\"\',
    удаляя пробелы в начале и конце.
    """
    ...
```

**Назначение**: Очищает и экранирует строку, заменяя специальные символы и удаляя пробелы.

**Параметры**:
- `text` (str): Текст для очистки и экранирования.

**Возвращает**:
- `str`: Очищенная и экранированная строка.

**Как работает функция `_set_multilang_value`**:
1. Функция получает ID языка. Если `id_lang` не указан, используется значение по умолчанию `self.id_lang`.
2. Функция `escape_and_strip` очищает и экранирует переданное значение.
3. Формируется словарь `lang_data`, содержащий ID языка и значение.
4. Функция пытается получить текущее значение поля `field_name` из `self.presta_fields`.
5. Если поле не существует, оно создается как словарь с ключом `'language'` и значением `lang_data`.
6. Если поле существует, проверяется, является ли оно словарем с ключом `'language'`, содержащим список. Если нет, поле перезаписывается.
7. Если поле существует и имеет правильную структуру, функция пытается обновить значение для указанного языка.
8. Если язык уже существует в списке, его значение обновляется. Если язык не существует, добавляется новая запись в список.
9. В случае возникновения исключений, логирует ошибки и возвращает `False`.

**Примеры**:
```python
product_fields = ProductFields()
success = product_fields._set_multilang_value('name', 'Новый товар', id_lang=2)
print(success)  # Выведет True, если значение установлено успешно
```

### Свойства для доступа к полям таблицы `ps_product`

Каждое свойство в этом разделе предназначено для получения или установки значения соответствующего поля в таблице `ps_product`. Каждое свойство имеет геттер и сеттер. Геттер возвращает текущее значение поля, а сеттер устанавливает новое значение. При установке значения используется нормализация данных, если это необходимо. При возникновении ошибок во время установки значения, они логируются.

Пример:

```python
    @property
    def id_product(self) -> Optional[int]:
        """ property `ps_product.id_product: int(10) unsigned` """
        return self.presta_fields.id_product

    @id_product.setter
    def id_product(self, value: int = None):
        """ setter `ID` товара. Для нового товара id назначается из `PrestaShop`. """
        try:
            self.presta_fields.id_product = value
        except Exception as ex:
            logger.error(f"Ошибка при установке id_product:",ex)
```

**Назначение**: Получение и установка ID товара.

**Как работает**:

- Геттер возвращает значение `self.presta_fields.id_product`.
- Сеттер пытается установить значение `self.presta_fields.id_product` и логирует ошибки, если они возникают.

### Свойства для доступа к полям таблицы `ps_product_lang`

Каждое свойство в этом разделе предназначено для получения или установки значения соответствующего поля в таблице `ps_product_lang`. Каждое свойство имеет геттер и сеттер. Геттер возвращает текущее значение поля, а сеттер устанавливает новое значение, используя метод `_set_multilang_value` для поддержки мультиязычности.

Пример:

```python
    @property
    def name(self) -> Optional[str]:
         """ property `ps_product_lang.name: varchar(128)` """
         return self.presta_fields.name

    @name.setter
    def name(self, value: str):
        """ setter Название товара. Мультиязычное поле."""
        self._set_multilang_value('name', value)
```

**Назначение**: Получение и установка названия товара (мультиязычное поле).

**Как работает**:

- Геттер возвращает значение `self.presta_fields.name`.
- Сеттер вызывает метод `self._set_multilang_value('name', value)` для установки значения с поддержкой мультиязычности.

### Методы для управления связями товара с другими сущностями

Эти методы позволяют управлять связями товара с другими сущностями, такими как категории, изображения, комбинации и т.д.

Пример:

```python
    @property
    def additional_categories(self) -> Optional[List[dict]]:
        """"""
        return self.presta_fields.associations.get('categories') if hasattr(self.presta_fields, 'associations') else []

    def additional_category_append(self, category_id: int | str):
        """Добавляет связь с категорией, если ее еще нет."""
        
        self._ensure_associations()

        if 'categories' not in self.presta_fields.associations:
            self.presta_fields.associations['categories']:list[dict] = []
        
        category_id_str = str(category_id)
        
        # проверяем есть ли уже такая категория
        #if not any(d['id'] == category_id_str for d in self.presta_fields.associations['categories']]):
        self.presta_fields.associations['categories'].append({'id': category_id_str})

    def additional_categories_clear(self):
        """Очищает все связи с категориями."""
        self._ensure_associations()
        if 'categories' in self.presta_fields.associations:
            del self.presta_fields.associations['categories']
```

**Назначение**: Получение, добавление и очистка связей с категориями.

**Как работает**:

- Геттер возвращает список категорий, связанных с товаром.
- `additional_category_append` добавляет связь с категорией, если ее еще нет.
- `additional_categories_clear` очищает все связи с категориями.

### `to_dict`

```python
def to_dict(self) -> Dict[str, Any]:
    """
    Преобразует объект ProductFields в словарь для PrestaShop API,
    исключая ключи, значения которых равны None или пустой строке,
    и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

    Returns:
        Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
    """
    ...
```

**Назначение**: Преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `Dict[str, Any]`: Словарь с полями, готовый для PrestaShop API.

**Внутренние функции**:

#### `str_val`

```python
def str_val(value: Any) -> Optional[str]:
    """Helper function to convert values to strings, handling None."""
    return str(value) if value is not None else None
```

**Назначение**: Преобразует значения в строки, обрабатывая `None`.

**Параметры**:
- `value` (Any): Значение для преобразования.

**Возвращает**:
- `Optional[str]`: Строковое представление значения или `None`, если значение равно `None`.

**Как работает функция `to_dict`**:
1. Функция создает пустой словарь `product_dict`.
2. Для каждого поля в `ps_product` и `ps_product_lang` проверяется, установлено ли значение.
3. Если значение установлено, оно преобразуется в строку с помощью функции `str_val` и добавляется в словарь `product_dict`.
4. Для мультиязычных полей вызывается метод `_format_multilang_value` для форматирования значений.
5. В словарь добавляются ассоциации (категории, изображения и т.д.).
6. Возвращается словарь `product_dict`.

**Примеры**:
```python
product_fields = ProductFields()
product_dict = product_fields.to_dict()
print(product_dict)  # Выведет словарь с полями, готовый для PrestaShop API
```

### `_format_multilang_value`

```python
def _format_multilang_value(self, data: Any) -> List[Dict[str, str]]:
    """
    Форматирует мультиязычные значения в список словарей для PrestaShop API. Все значения представляются как строки.

    Args:
        data (Any): Значение поля. Если это словарь, ожидается структура {'language': [{'attrs': {'id': lang_id}, 'value': value}]}

    Returns:
        List[Dict[str, str]]: Список словарей, где каждый словарь содержит 'id' и 'value' (все как строки) для каждого языка.
    """
    ...
```

**Назначение**: Форматирует мультиязычные значения в формат, требуемый API PrestaShop.

**Параметры**:
- `data` (Any): Значение поля. Ожидается структура `{'language': [{'attrs': {'id': lang_id}, 'value': value}]}`.

**Возвращает**:
- `List[Dict[str, str]]`: Список словарей, где каждый словарь содержит `'id'` и `'value'` (все как строки) для каждого языка.

**Как работает функция**:
Функция принимает значение поля и преобразует его в список словарей, где каждый словарь содержит ID языка и значение для этого языка.

**Примеры**:
```python
product_fields = ProductFields()
formatted_value = product_fields._format_multilang_value({'language': [{'attrs': {'id': 1}, 'value': 'Test'}]})
print(formatted_value)  # Выведет список словарей с ID языка и значением
```