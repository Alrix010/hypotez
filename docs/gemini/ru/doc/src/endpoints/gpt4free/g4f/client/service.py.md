# Модуль `service.py`

## Обзор

Модуль `service.py` является частью проекта `hypotez` и предназначен для управления провайдерами и моделями, используемыми для взаимодействия с различными сервисами генерации текста, такими как GPT-4. Он предоставляет функции для выбора, проверки и настройки провайдеров и моделей на основе заданных критериев.

## Подробнее

Этот модуль содержит функции, которые позволяют выбирать модель и провайдера для работы с сервисами генерации текста. Он также обрабатывает ошибки, связанные с отсутствием провайдера, модели или неподдерживаемыми функциями. Модуль использует другие модули проекта, такие как `debug`, `version`, `errors`, `models`, `Provider`, и `providers`.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """Преобразует строку с именем провайдера в объект провайдера.

    Args:
        provider (str): Строка с именем провайдера.

    Returns:
        ProviderType: Объект провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
    """
```

**Назначение**: Преобразует строку с именем провайдера в соответствующий объект провайдера. Если указано несколько провайдеров через пробел, создает составной провайдер `IterListProvider`.

**Параметры**:
- `provider` (str): Строка, содержащая имя провайдера или имена нескольких провайдеров, разделенных пробелами.

**Возвращает**:
- `ProviderType`: Объект провайдера или `IterListProvider`, если указано несколько провайдеров.

**Вызывает исключения**:
- `ProviderNotFoundError`: Если указанный провайдер не найден.

**Как работает функция**:
- Функция принимает строку `provider` с именем провайдера.
- Если в строке есть пробелы, она разделяет строку на список имен провайдеров и пытается преобразовать каждое имя в объект провайдера, используя `ProviderUtils.convert`.
- Если ни один из провайдеров не найден, вызывается исключение `ProviderNotFoundError`.
- Если провайдеров несколько, создается объект `IterListProvider` из списка найденных провайдеров.
- Если в строке нет пробелов, функция пытается найти провайдера в `ProviderUtils.convert` напрямую.
- Если провайдер не найден, вызывается исключение `ProviderNotFoundError`.
- В конце функция возвращает найденный объект провайдера.

**Примеры**:
```python
# Пример 1: Преобразование имени провайдера в объект провайдера
provider = convert_to_provider("Gpt4Free")
# Пример 2: Преобразование нескольких имен провайдеров в объект IterListProvider
provider = convert_to_provider("Gpt4Free AiAsk You")
```

### `get_model_and_provider`

```python
def get_model_and_provider(model: Union[Model, str],
                           provider: Union[ProviderType, str, None],
                           stream: bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """Извлекает модель и провайдера на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования (объект или строка).
        provider (Union[ProviderType, str, None]): Провайдер для использования (объект, строка или None).
        stream (bool): Указывает, должна ли операция выполняться как поток.
        ignore_working (bool, optional): Если True, игнорирует статус работоспособности провайдера. По умолчанию False.
        ignore_stream (bool, optional): Если True, игнорирует потоковую возможность провайдера. По умолчанию False.
        logging (bool, optional): Если True, включает логирование. По умолчанию True.
        has_images (bool, optional): Если True, указывает, что запрос содержит изображения. По умолчанию False.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если провайдер не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается провайдером.
    """
```

**Назначение**: Извлекает и проверяет модель и провайдера на основе входных параметров.

**Параметры**:
- `model` (Union[Model, str]): Модель для использования. Может быть объектом `Model` или строковым идентификатором.
- `provider` (Union[ProviderType, str, None]): Провайдер для использования. Может быть объектом `ProviderType`, строковым идентификатором или `None`.
- `stream` (bool): Флаг, указывающий, должна ли поддерживаться потоковая передача данных.
- `ignore_working` (bool, optional): Флаг, указывающий, следует ли игнорировать работоспособность провайдера. По умолчанию `False`.
- `ignore_stream` (bool, optional): Флаг, указывающий, следует ли игнорировать поддержку потоковой передачи данных провайдером. По умолчанию `False`.
- `logging` (bool, optional): Флаг, указывающий, следует ли вести логирование. По умолчанию `True`.
- `has_images` (bool, optional): Флаг, указывающий, содержит ли запрос изображения. По умолчанию `False`.

**Возвращает**:
- `tuple[str, ProviderType]`: Кортеж, содержащий имя модели (str) и объект провайдера (ProviderType).

**Вызывает исключения**:
- `ProviderNotFoundError`: Если провайдер не найден.
- `ModelNotFoundError`: Если модель не найдена.
- `ProviderNotWorkingError`: Если провайдер не работает и `ignore_working` равен `False`.
- `StreamNotSupportedError`: Если потоковая передача не поддерживается провайдером и `stream` равен `True`.

**Как работает функция**:
1.  Выполняет проверку версии, если это необходимо.
2.  Преобразует строковое представление провайдера в объект провайдера, используя `convert_to_provider`.
3.  Если `model` является строкой, пытается преобразовать её в объект `Model`.
4.  Если `provider` не указан:
    *   Если `model` также не указана, выбирает модель и провайдера по умолчанию в зависимости от флага `has_images`.
    *   Если `model` является строкой, пытается найти провайдера по имени модели.
    *   Если `model` является объектом `Model`, выбирает лучшего провайдера для этой модели.
5.  Если провайдер не найден, вызывает исключение `ProviderNotFoundError`.
6.  Проверяет работоспособность провайдера, если `ignore_working` равен `False`.
7.  Проверяет поддержку потоковой передачи данных провайдером, если `ignore_stream` равен `False` и `stream` равен `True`.
8.  Логирует использование провайдера и модели, если `logging` равен `True`.
9.  Возвращает имя модели и объект провайдера.

**Примеры**:
```python
# Пример 1: Получение модели и провайдера по умолчанию
model, provider = get_model_and_provider(None, None, False)

# Пример 2: Получение модели и провайдера по имени
model, provider = get_model_and_provider("gpt-4", "Gpt4Free", True)

# Пример 3: Получение модели и провайдера с игнорированием работоспособности провайдера
model, provider = get_model_and_provider("gpt-4", "Gpt4Free", True, ignore_working=True)
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """Извлекает последнего использованного провайдера.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о провайдере в виде словаря. По умолчанию False.

    Returns:
        Union[ProviderType, dict[str, str], None]: Последний использованный провайдер (объект или словарь).
    """
```

**Назначение**: Возвращает последнего использованного провайдера.

**Параметры**:
- `as_dict` (bool, optional): Если `True`, возвращает информацию о провайдере в виде словаря. По умолчанию `False`.

**Возвращает**:
- `Union[ProviderType, dict[str, str], None]`: Последний использованный провайдер. Если `as_dict` равен `True`, возвращает словарь с информацией о провайдере. Если провайдер не найден, возвращает `None`.

**Как работает функция**:
1.  Получает последнего использованного провайдера из `debug.last_provider`.
2.  Если последний провайдер является экземпляром `BaseRetryProvider`, получает последнего провайдера из него.
3.  Если `as_dict` равен `True`:
    *   Если провайдер найден, возвращает словарь с информацией о провайдере (имя, URL, модель, метка).
    *   Если провайдер не найден, возвращает пустой словарь.
4.  Если `as_dict` равен `False`, возвращает объект провайдера.

**Примеры**:
```python
# Пример 1: Получение последнего использованного провайдера в виде объекта
last_provider = get_last_provider()

# Пример 2: Получение последнего использованного провайдера в виде словаря
last_provider_dict = get_last_provider(as_dict=True)