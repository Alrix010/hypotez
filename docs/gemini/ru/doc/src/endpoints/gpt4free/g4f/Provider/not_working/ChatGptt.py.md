# Модуль `ChatGptt`

## Обзор

Модуль `ChatGptt` представляет собой асинхронный провайдер для взаимодействия с моделью GPT через API сервиса `chatgptt.me`. Он поддерживает потоковую передачу данных, системные сообщения и историю сообщений.
Модуль предназначен для интеграции с другими частями проекта `hypotez`, обеспечивая возможность использования GPT-подобных моделей в асинхронном режиме.

## Подробней

Модуль `ChatGptt` использует асинхронные запросы для обмена данными с API `chatgptt.me`. Он извлекает необходимые токены аутентификации из HTML-кода главной страницы и отправляет запросы с использованием этих токенов.
Модуль предоставляет методы для создания асинхронных генераторов, которые позволяют получать ответы от модели GPT частями, что полезно для обработки больших объемов данных.
Для логирования ошибок используется модуль `src.logger`.

## Классы

### `ChatGptt`

**Описание**: Класс `ChatGptt` является асинхронным провайдером, реализующим взаимодействие с API `chatgptt.me` для работы с моделью GPT.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL сервиса `chatgptt.me`.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_stream` (bool): Поддерживает ли потоковую передачу данных (`True`).
- `supports_system_message` (bool): Поддерживает ли системные сообщения (`True`).
- `supports_message_history` (bool): Поддерживает ли историю сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `gpt-4o`, `gpt-4o-mini`).

**Принцип работы**:

1.  При инициализации класса устанавливаются основные параметры, такие как URL, API endpoint и поддерживаемые функции.
2.  Метод `create_async_generator` используется для создания асинхронного генератора, который отправляет запросы к API и возвращает результаты.
3.  Внутри метода происходит извлечение токенов аутентификации из HTML-кода главной страницы и формирование полезной нагрузки (payload) для запроса.
4.  Запросы отправляются с использованием библиотеки `aiohttp`, и ответы обрабатываются для извлечения данных.
5.  В случае возникновения ошибок, таких как отсутствие токенов аутентификации, генерируются исключения.

## Методы класса

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API `chatgptt.me`.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API.

    Raises:
        RuntimeError: Если не удается извлечь токены аутентификации из HTML.

    Как работает функция:
    1. Получает модель, используя `cls.get_model(model)`.
    2. Формирует заголовки запроса, включая `authority`, `accept`, `origin`, `referer` и `user-agent`.
    3. Создает асинхронную сессию с использованием `aiohttp.ClientSession`.
    4. Получает HTML-контент главной страницы `cls.url`.
    5. Извлекает `nonce` и `post_id` из HTML, используя регулярные выражения.
    6. Подготавливает полезную нагрузку (payload) с данными для запроса, включая `_wpnonce`, `post_id`, `url`, `action`, `message`, `bot_id`, `chatbot_identity`, `wpaicg_chat_client_id` и `wpaicg_chat_history`.
    7. Отправляет POST-запрос к `cls.api_endpoint` с заголовками, полезной нагрузкой и прокси (если указан).
    8. Обрабатывает ответ, извлекая данные из JSON-формата и передавая их через генератор.

    Внутренние функции:
        Внутри данной функции нет внутренних функций.
    """
```

**Параметры**:

- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict, AsyncGenerator

async def main():
    model = "gpt-4"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, GPT!"}]
    proxy = None

    generator: AsyncGenerator[str, None] = await ChatGptt.create_async_generator(model=model, messages=messages, proxy=proxy)

    async for message in generator:
        print(message)

if __name__ == "__main__":
    asyncio.run(main())