# Модуль MetaAI

## Обзор

Модуль `MetaAI.py` предоставляет асинхронный интерфейс для взаимодействия с Meta AI (ранее Facebook AI). Он позволяет генерировать текст, получать изображения и искать источники, используя API Meta AI. Модуль включает в себя обработку куки, токенов доступа и ошибок, а также форматирование запросов и ответов для обеспечения совместимости с API Meta AI.

## Подробней

Этот модуль используется для интеграции с сервисами Meta AI, предоставляя возможность программного доступа к функциям, таким как генерация текста и изображений. Он обрабатывает детали аутентификации и запросов к API, позволяя разработчикам сосредоточиться на логике приложения, а не на технических деталях взаимодействия с Meta AI.

## Классы

### `Sources`

**Описание**: Класс представляет собой список источников (ссылок) в формате, пригодном для отображения или дальнейшей обработки.

**Атрибуты**:

- `list` (List[Dict[str, str]]): Список словарей, где каждый словарь содержит информацию о ссылке, включая заголовок (`title`) и URL (`link`).

**Методы**:

- `__init__(self, link_list: List[Dict[str, str]]) -> None`:
  - **Назначение**: Инициализирует объект `Sources` списком ссылок.
  - **Параметры**:
    - `link_list` (List[Dict[str, str]]): Список словарей, представляющих ссылки.
  - **Пример**:
    ```python
    sources = Sources([{'title': 'Example', 'link': 'https://example.com'}])
    ```
- `__str__(self) -> str`:
  - **Назначение**: Возвращает строковое представление списка ссылок в формате Markdown.
  - **Возвращает**:
    - `str`: Строковое представление списка ссылок.
  - **Пример**:
    ```python
    sources = Sources([{'title': 'Example', 'link': 'https://example.com'}])
    print(str(sources))
    ```

### `AbraGeoBlockedError`

**Описание**: Класс исключения, который выбрасывается, когда Meta AI недоступен в определенной географической локации.

### `MetaAI`

**Описание**: Класс, реализующий асинхронный провайдер для взаимодействия с Meta AI.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию ответов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:

- `label` (str): Метка провайдера ("Meta AI").
- `url` (str): URL Meta AI ("https://www.meta.ai").
- `working` (bool): Указывает, работает ли провайдер (True).
- `default_model` (str): Модель, используемая по умолчанию ('meta-ai').
- `session` (ClientSession): Асинхронная клиентская сессия для выполнения HTTP-запросов.
- `cookies` (Cookies): Куки, используемые для аутентификации.
- `access_token` (str): Токен доступа для API Meta AI.

**Методы**:

- `__init__(self, proxy: str = None, connector: BaseConnector = None)`:
  - **Назначение**: Инициализирует объект `MetaAI`.
  - **Параметры**:
    - `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
    - `connector` (BaseConnector, optional): Объект коннектора aiohttp. По умолчанию `None`.

- `create_async_generator(cls, model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`:
  - **Назначение**: Создает асинхронный генератор для обработки запросов к Meta AI.
  - **Параметры**:
    - `model` (str): Название модели.
    - `messages` (Messages): Список сообщений для отправки.
    - `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
    - `**kwargs`: Дополнительные аргументы.
  - **Возвращает**:
    - `AsyncResult`: Асинхронный генератор, выдающий части ответа.
  - **Как работает функция**:
    - Функция является методом класса и создает экземпляр класса `MetaAI`.
    - Вызывает метод `prompt` для получения ответа от Meta AI, форматируя сообщения с помощью `format_prompt`.
    - Возвращает асинхронный генератор, который выдает части ответа.

- `update_access_token(self, birthday: str = "1999-01-01")`:
  - **Назначение**: Обновляет токен доступа.
  - **Параметры**:
    - `birthday` (str, optional): Дата рождения. По умолчанию "1999-01-01".
  - **Как работает функция**:
    - Функция отправляет POST-запрос к API Meta AI для обновления токена доступа.
    - Формирует полезную нагрузку (payload) с данными, необходимыми для обновления токена, включая дату рождения.
    - Добавляет заголовки, специфичные для запроса к Meta AI, такие как `x-fb-friendly-name` и `x-fb-lsd`.
    - Использует асинхронную сессию для отправки запроса и обрабатывает ответ, извлекая новый токен доступа из JSON-ответа.
    - Обновляет атрибут `access_token` экземпляра класса `MetaAI` новым токеном.
    - В случае ошибки при выполнении запроса, вызывает исключение `ResponseError`.

- `prompt(self, message: str, cookies: Cookies = None) -> AsyncResult`:
  - **Назначение**: Отправляет запрос к Meta AI и возвращает асинхронный генератор с ответом.
  - **Параметры**:
    - `message` (str): Текст сообщения для отправки.
    - `cookies` (Cookies, optional): Куки для аутентификации. По умолчанию `None`.
  - **Возвращает**:
    - `AsyncResult`: Асинхронный генератор, выдающий части ответа.
  - **Как работает функция**:
    - Функция отправляет сообщение в Meta AI и обрабатывает потоковый ответ.
    - Сначала проверяет и обновляет куки и токен доступа, если они отсутствуют или предоставлены новые куки.
    - Формирует URL и полезную нагрузку (payload) в зависимости от наличия токена доступа.
    - Отправляет POST-запрос к API Meta AI с необходимыми заголовками и данными.
    - Обрабатывает потоковый ответ, ища в каждой строке JSON-данные.
    - Извлекает и выдает фрагменты текста (`snippet`) и изображения (если они есть) из ответа.
    - В случае обнаружения ошибок в ответе, вызывает исключения `ResponseError` или `RuntimeError`.
    - После завершения потоковой передачи, пытается получить дополнительные источники (`sources`) и также выдает их.

- `update_cookies(self, cookies: Cookies = None)`:
  - **Назначение**: Обновляет куки для аутентификации.
  - **Параметры**:
    - `cookies` (Cookies, optional): Куки для обновления. По умолчанию `None`.
  - **Как работает функция**:
    - Функция отправляет GET-запрос на главную страницу Meta AI для обновления куки.
    - Проверяет наличие ошибки `AbraGeoBlockedError` в тексте ответа, которая указывает на географическую блокировку.
    - Извлекает значения куки (`_js_datr`, `abra_csrf`, `datr`, `LSD`, `DTSGInitialData`) из текста ответа.
    - Обновляет атрибуты `lsd`, `dtsg` и `cookies` экземпляра класса `MetaAI`.

- `fetch_sources(self, fetch_id: str) -> Sources`:
  - **Назначение**: Получает источники для заданного идентификатора.
  - **Параметры**:
    - `fetch_id` (str): Идентификатор для получения источников.
  - **Возвращает**:
    - `Sources`: Объект `Sources` с информацией об источниках.
  - **Как работает функция**:
    - Функция отправляет запрос к API Meta AI для получения источников, связанных с определенным сообщением.
    - Формирует URL и полезную нагрузку (payload) в зависимости от наличия токена доступа.
    - Отправляет POST-запрос к API Meta AI с необходимыми заголовками и данными.
    - Обрабатывает JSON-ответ, извлекая информацию об источниках (`searchResults`).
    - Возвращает объект `Sources` с полученными ссылками.
    - В случае ошибки при выполнении запроса, вызывает исключения `ResponseError` или `RuntimeError`.

- `extract_value(text: str, key: str = None, start_str = None, end_str = '",') -> str`:
  - **Назначение**: Извлекает значение из текста по заданным ключам.
  - **Параметры**:
    - `text` (str): Текст для извлечения значения.
    - `key` (str, optional): Ключ для поиска значения. По умолчанию `None`.
    - `start_str` (str, optional): Начальная строка для поиска значения. По умолчанию `None`.
    - `end_str` (str, optional): Конечная строка для поиска значения. По умолчанию '",'.
  - **Возвращает**:
    - `str`: Извлеченное значение.
  - **Как работает функция**:
    - Функция извлекает значение из текста на основе заданных начальной и конечной строк.
    - Если `start_str` не указан, он формируется на основе ключа (`key`).
    - Ищет `start_str` в тексте, а затем ищет `end_str` после `start_str`.
    - Возвращает подстроку между `start_str` и `end_str`, если они найдены.

## Функции

### `generate_offline_threading_id() -> str`

- **Назначение**: Генерирует идентификатор для оффлайн тредов.
- **Возвращает**:
  - `str`: Сгенерированный идентификатор треда.
- **Как работает функция**:
  - Генерирует случайное 64-битное целое число.
  - Получает текущее время в миллисекундах.
  - Объединяет временную метку и случайное значение для создания идентификатора треда.
- **Примеры**:
  ```python
  thread_id = generate_offline_threading_id()
  print(thread_id)
  ```