# Модуль Phind
## Обзор

Модуль `Phind` предоставляет асинхронный генератор для взаимодействия с сервисом Phind, предназначенным для поиска и анализа информации. Он поддерживает потоковую передачу данных, сохранение истории сообщений и использует асинхронные запросы для получения ответов. Модуль интегрирован в проект `hypotez` для обеспечения доступа к продвинутым возможностям обработки информации.

## Подробнее

Модуль `Phind` является асинхронным провайдером, использующим `StreamSession` для выполнения запросов к API Phind. Он предназначен для получения ответов на вопросы, используя историю запросов и ответов для более точного анализа. Модуль включает в себя функции для генерации challenge, необходимого для аутентификации запросов.

## Классы

### `Phind`

**Описание**: Класс `Phind` предоставляет функциональность для взаимодействия с сервисом Phind. Он наследует класс `AsyncGeneratorProvider` и реализует методы для асинхронной генерации ответов на основе предоставленных сообщений.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL сервиса Phind (`https://www.phind.com`).
- `working` (bool): Указывает, находится ли сервис в рабочем состоянии (по умолчанию `False`).
- `lockdown` (bool): Указывает, находится ли сервис в режиме блокировки (по умолчанию `True`).
- `supports_stream` (bool): Указывает, поддерживает ли сервис потоковую передачу данных (по умолчанию `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли сервис историю сообщений (по умолчанию `True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от сервиса Phind.

## Методы класса

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    creative_mode: bool = False,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от сервиса Phind.

    Args:
        model (str): Модель, используемая для генерации ответа.
        messages (Messages): Список сообщений для передачи в сервис Phind.
        proxy (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
        timeout (int, optional): Максимальное время ожидания ответа в секундах. По умолчанию `120`.
        creative_mode (bool, optional): Указывает, включен ли креативный режим. По умолчанию `False`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от сервиса Phind.

    Raises:
        RuntimeError: Если сервис Phind возвращает ошибку.
    """
```

**Назначение**: Метод `create_async_generator` создает и возвращает асинхронный генератор, который отправляет запросы к сервису Phind и получает ответы.

**Параметры**:
- `cls`: Ссылка на класс `Phind`.
- `model` (str): Модель, используемая для генерации ответа (например, "gpt-4" или "Phind-34B").
- `messages (Messages)`: Список сообщений, представляющих собой историю общения с моделью. Каждое сообщение содержит роль (`user`, `assistant`, `system`) и содержимое.
- `proxy (str, optional)`: Прокси-сервер для использования при подключении к сервису. По умолчанию `None`.
- `timeout (int, optional)`: Максимальное время ожидания ответа от сервиса в секундах. По умолчанию `120`.
- `creative_mode (bool, optional)`: Флаг, указывающий, следует ли использовать креативный режим. По умолчанию `False`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Как работает функция**:
1. **Определение заголовков**: Функция определяет заголовки HTTP-запроса, включая `Accept`, `Origin`, `Referer`, `Sec-Fetch-Dest`, `Sec-Fetch-Mode` и `Sec-Fetch-Site`. Эти заголовки необходимы для успешного выполнения запроса к API Phind.
2. **Создание StreamSession**: Создается асинхронная сессия `StreamSession` с использованием указанных заголовков, прокси и времени ожидания. `StreamSession` используется для поддержки потоковой передачи данных.
3. **Получение challengeSeeds**: Функция выполняет GET-запрос к `https://www.phind.com/search?home=true` и извлекает значения `challengeSeeds` из JSON, встроенного в HTML-код страницы.
4. **Формирование данных запроса**: Подготавливаются данные для POST-запроса к API Phind. Эти данные включают вопрос (`prompt`), историю вопросов и ответов, настройки (`options`) и контекст (системные сообщения).
5. **Генерация challenge**: Вызывается функция `generate_challenge` для генерации challenge, необходимого для аутентификации запроса.
6. **Выполнение POST-запроса**: Выполняется POST-запрос к `https://https.api.phind.com/infer/` с использованием сформированных данных и заголовков.
7. **Обработка потока ответов**: Функция итерируется по строкам ответа, полученного от сервиса Phind. Каждая строка проверяется на наличие специальных маркеров, таких как `<PHIND_DONE/>`, `<PHIND_BACKEND_ERROR>`, `<PHIND_WEBRESULTS>`, `<PHIND_FOLLOWUP>`, `<PHIND_METADATA>`, `<PHIND_INDICATOR>`, `<PHIND_SPAN_BEGIN>` и `<PHIND_SPAN_END>`. В зависимости от маркера, строка либо игнорируется, либо возвращается как часть ответа.
8. **Генерация результатов**: Функция использует `yield` для генерации частей ответа по мере их поступления от сервиса Phind.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает части ответа от сервиса Phind.

**Вызывает исключения**:
- `RuntimeError`: Если в ответе от сервиса Phind содержится маркер `<PHIND_BACKEND_ERROR>`, что указывает на ошибку на стороне сервера.

**Примеры**:

Пример вызова функции:

```python
model = "gpt-4"
messages = [
    {"role": "user", "content": "What is the capital of France?"},
    {"role": "assistant", "content": "The capital of France is Paris."}
]
proxy = "http://your-proxy:8080"
timeout = 120
creative_mode = False

async def main():
    async for chunk in Phind.create_async_generator(model=model, messages=messages, proxy=proxy, timeout=timeout, creative_mode=creative_mode):
        print(chunk)

# Запуск асинхронной функции
# asyncio.run(main())  # Необходимо запустить в асинхронном контексте
```

## Функции

### `deterministic_stringify`

```python
def deterministic_stringify(obj):
    """Преобразует объект в строку в детерминированном порядке.

    Args:
        obj (Any): Объект для преобразования в строку.

    Returns:
        str: Строковое представление объекта в детерминированном порядке.
    """
```

**Назначение**: Функция `deterministic_stringify` преобразует объект (словарь, список, число, строку или булево значение) в строку в детерминированном порядке. Это необходимо для обеспечения консистентности при генерации challenge.

**Параметры**:
- `obj`: Объект, который необходимо преобразовать в строку.

**Как работает функция**:
1. **Обработка значений**: Внутренняя функция `handle_value` рекурсивно обрабатывает значения объекта.
    - Если значение является списком, оно сортируется, и его элементы преобразуются в строки с помощью `handle_value`.
    - Если значение является словарем, вызывается `deterministic_stringify` для его преобразования.
    - Если значение является булевым, оно преобразуется в строку "true" или "false".
    - Если значение является числом (int или float), оно форматируется с 8 знаками после запятой и обрезается до минимально необходимого количества знаков.
    - Если значение является строкой, оно заключается в двойные кавычки.
    - Если значение является `None`, возвращается строка "null".
2. **Сортировка элементов**: Функция сортирует элементы словаря по ключам.
3. **Преобразование в строку**: Функция преобразует каждый элемент (ключ-значение) в строку вида "ключ:значение" и объединяет их в одну строку, разделенную запятыми.

**Возвращает**:
- `str`: Строковое представление объекта в детерминированном порядке.

**Примеры**:

```python
obj = {"b": 2, "a": 1}
result = deterministic_stringify(obj)
print(result)  # Вывод: a:1.00000000,b:2.00000000

obj = [3, 1, 2]
result = deterministic_stringify(obj)
print(result)  # Вывод: [1.00000000,2.00000000,3.00000000]
```

### `prng_general`

```python
def prng_general(seed, multiplier, addend, modulus):
    """Генерирует псевдослучайное число с использованием общих параметров.

    Args:
        seed (int): Начальное значение для генерации.
        multiplier (int): Множитель.
        addend (int): Добавляемое значение.
        modulus (int): Модуль.

    Returns:
        float: Псевдослучайное число в диапазоне [0, 1).
    """
```

**Назначение**: Функция `prng_general` генерирует псевдослучайное число с использованием заданных параметров: начального значения (seed), множителя (multiplier), добавляемого значения (addend) и модуля (modulus).

**Параметры**:
- `seed (int)`: Начальное значение для генерации псевдослучайного числа.
- `multiplier (int)`: Множитель, используемый в формуле генерации.
- `addend (int)`: Добавляемое значение, используемое в формуле генерации.
- `modulus (int)`: Модуль, используемый для ограничения диапазона генерируемых чисел.

**Как работает функция**:
1. **Вычисление значения**: Функция вычисляет новое значение `a` по формуле `a = seed * multiplier + addend`.
2. **Обработка отрицательных значений**: Если `a` отрицательное, оно преобразуется в положительное значение с использованием операции `%`.
3. **Нормализация**: Функция возвращает нормализованное значение в диапазоне [0, 1), разделив `a` на `modulus`.

**Возвращает**:
- `float`: Псевдослучайное число в диапазоне [0, 1).

**Примеры**:

```python
seed = 12345
multiplier = 1103515245
addend = 12345
modulus = 2**32

result = prng_general(seed, multiplier, addend, modulus)
print(result)
```

### `generate_challenge_seed`

```python
def generate_challenge_seed(l):
    """Генерирует seed для challenge на основе входных данных.

    Args:
        l (Any): Входные данные для генерации seed.

    Returns:
        int: Seed для challenge.
    """
```

**Назначение**: Функция `generate_challenge_seed` генерирует seed для challenge на основе входных данных. Она преобразует входные данные в строку в детерминированном порядке и вычисляет хеш этой строки.

**Параметры**:
- `l (Any)`: Входные данные для генерации seed.

**Как работает функция**:
1. **Преобразование в строку**: Функция преобразует входные данные `l` в строку с помощью функции `deterministic_stringify`.
2. **URL-кодирование**: Полученная строка кодируется с использованием `urllib.parse.quote` для безопасной передачи в URL.
3. **Вычисление хеша**: Вычисляется хеш закодированной строки с помощью функции `simple_hash`.

**Возвращает**:
- `int`: Seed для challenge.

**Примеры**:

```python
data = {"question": "What is the capital of France?"}
seed = generate_challenge_seed(data)
print(seed)
```

### `simple_hash`

```python
def simple_hash(s):
    """Вычисляет простой хеш строки.

    Args:
        s (str): Строка для вычисления хеша.

    Returns:
        int: Хеш строки.
    """
```

**Назначение**: Функция `simple_hash` вычисляет простой хеш строки. Она итерируется по символам строки и вычисляет хеш на основе их ASCII-кодов.

**Параметры**:
- `s (str)`: Строка, для которой вычисляется хеш.

**Как работает функция**:
1. **Инициализация хеша**: Хеш `d` инициализируется значением 0.
2. **Итерация по символам**: Функция итерируется по символам строки `s`.
3. **Вычисление хеша**: Для каждого символа вычисляется новый хеш по формуле `d = ((d << 5) - d + ord(char[0])) & 0xFFFFFFFF`.
4. **Обработка переполнения**: Если хеш превышает максимальное значение 32-битного целого числа со знаком (0x7FFFFFFF), из него вычитается 2**32 (0x100000000).

**Возвращает**:
- `int`: Хеш строки.

**Примеры**:

```python
string = "hello"
hash_value = simple_hash(string)
print(hash_value)
```

### `generate_challenge`

```python
def generate_challenge(obj, **kwargs):
    """Генерирует challenge на основе объекта и параметров.

    Args:
        obj (Any): Объект для генерации challenge.
        **kwargs: Параметры для prng_general.

    Returns:
        float: Сгенерированный challenge.
    """
```

**Назначение**: Функция `generate_challenge` генерирует challenge на основе входного объекта и дополнительных параметров. Challenge используется для аутентификации запросов к API Phind.

**Параметры**:
- `obj (Any)`: Объект, используемый для генерации challenge.
- `**kwargs`: Дополнительные параметры, передаваемые в функцию `prng_general`.

**Как работает функция**:
1. **Генерация seed**: Функция генерирует seed для challenge с помощью функции `generate_challenge_seed`.
2. **Генерация псевдослучайного числа**: Функция генерирует псевдослучайное число с использованием функции `prng_general` и seed, полученного на предыдущем шаге.

**Возвращает**:
- `float`: Сгенерированный challenge.

**Примеры**:

```python
obj = {"question": "What is the capital of France?"}
kwargs = {"multiplier": 1103515245, "addend": 12345, "modulus": 2**32}
challenge = generate_challenge(obj, **kwargs)
print(challenge)