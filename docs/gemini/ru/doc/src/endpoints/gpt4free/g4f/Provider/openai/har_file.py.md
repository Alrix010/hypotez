# Модуль для работы с HAR-файлами OpenAI

## Обзор

Данный модуль предоставляет инструменты для работы с HAR-файлами, которые используются для хранения информации о сетевых запросах и ответах. В частности, он предназначен для извлечения токенов аутентификации, куки и других параметров из HAR-файлов, используемых в сервисах OpenAI.

## Подробнее

Модуль использует библиотеку `json` для парсинга HAR-файлов, а также библиотеки `base64`, `uuid` и `re` для обработки данных, извлеченных из HAR-файлов. 

## Функции

### `get_har_files`

**Назначение**: Функция находит все HAR-файлы в каталоге `get_cookies_dir()`, сортирует их по дате модификации и возвращает список найденных файлов.

**Параметры**:  Отсутствуют.

**Возвращает**:
- `list`: Список полных путей к HAR-файлам.

**Вызывает исключения**:
- `NoValidHarFileError`: Если каталог `get_cookies_dir()` не доступен для чтения или в нем нет HAR-файлов.

**Пример**:
```python
>>> get_har_files()
['/path/to/cookies/1688893200.har', '/path/to/cookies/1688893300.har']
```

### `readHAR`

**Назначение**: Функция читает HAR-файлы, извлекает из них токен доступа, токен подтверждения, токен Turnstile, куки и информацию о запросе Arkose.

**Параметры**:
- `request_config (RequestConfig)`: Объект класса `RequestConfig`, в который будут записаны извлеченные данные.

**Возвращает**:
- `None`: Функция не возвращает значения, но модифицирует объект `request_config`.

**Вызывает исключения**:
- `NoValidHarFileError`: Если в HAR-файлах не найден токен подтверждения.

**Как работает функция**:
1. Функция получает список HAR-файлов с помощью функции `get_har_files()`.
2. Она перебирает каждый HAR-файл и парсит его с помощью библиотеки `json`.
3. Для каждого элемента HAR-файла, функция проверяет URL-адрес запроса.
4. Если URL-адрес соответствует URL-адресу запроса Arkose (`arkose_url`), функция извлекает информацию о запросе Arkose и сохраняет ее в атрибут `arkose_request` объекта `request_config`.
5. Если URL-адрес соответствует начальному URL-адресу ChatGPT (`start_url`), функция пытается извлечь токен доступа и токен подтверждения из содержимого ответа.
6. Если в заголовках ответа найден токен подтверждения, токен Turnstile или токен доступа, функция сохраняет их в соответствующие атрибуты объекта `request_config`.
7. Функция также извлекает куки из запроса и сохраняет их в атрибут `cookies` объекта `request_config`.

**Примеры**:
```python
>>> request_config = RequestConfig()
>>> readHAR(request_config)
>>> request_config.access_token
'your_access_token'
>>> request_config.proof_token
['your_proof_token_part1', 'your_proof_token_part2']
>>> request_config.turnstile_token
'your_turnstile_token'
>>> request_config.cookies
{'your_cookie_name1': 'your_cookie_value1', 'your_cookie_name2': 'your_cookie_value2'}
```

### `get_headers`

**Назначение**: Функция извлекает заголовки запроса из HAR-файла.

**Параметры**:
- `entry (dict)`: Элемент HAR-файла, содержащий информацию о запросе.

**Возвращает**:
- `dict`: Словарь, содержащий заголовки запроса.

**Как работает функция**:
1. Функция перебирает все заголовки запроса и добавляет их в словарь, если их имя не содержится в исключающих списках.
2. Ключи словаря - имена заголовков в нижнем регистре.

**Примеры**:
```python
>>> entry = {'request': {'headers': [{'name': 'User-Agent', 'value': 'Mozilla/5.0'}]}}
>>> get_headers(entry)
{'user-agent': 'Mozilla/5.0'}
```

### `parseHAREntry`

**Назначение**: Функция парсит элемент HAR-файла, содержащий информацию о запросе Arkose, и возвращает объект класса `arkReq`.

**Параметры**:
- `entry (dict)`: Элемент HAR-файла, содержащий информацию о запросе Arkose.

**Возвращает**:
- `arkReq`: Объект класса `arkReq`, содержащий информацию о запросе Arkose.

**Как работает функция**:
1. Функция создает объект класса `arkReq` с использованием данных из элемента HAR-файла.
2. Она извлекает данные из тела запроса, заголовков, куки и user-agent.
3. Функция использует `decrypt()` для дешифрования `bda` с использованием `userAgent` и `bw`.
4. Она сохраняет все извлеченные данные в атрибуты объекта `arkReq`.

**Примеры**:
```python
>>> entry = {'request': {'headers': [{'name': 'User-Agent', 'value': 'Mozilla/5.0'}]}}
>>> parseHAREntry(entry)
<arkReq object at 0x10101010>
```

### `genArkReq`

**Назначение**: Функция генерирует новый запрос Arkose, основанный на существующем запросе.

**Параметры**:
- `chatArk (arkReq)`: Объект класса `arkReq`, содержащий информацию о существующем запросе Arkose.

**Возвращает**:
- `arkReq`: Объект класса `arkReq`, содержащий информацию о новом запросе Arkose.

**Как работает функция**:
1. Функция создает копию объекта `chatArk`.
2. Она генерирует новые значения для `bda`, `rnd` и `x-ark-esync-value` с помощью функций `getBDA()`, `getN()` и `getBw()`.
3. Она сохраняет новые значения в атрибуты объекта `arkReq`.

**Примеры**:
```python
>>> chatArk = arkReq(arkURL='https://tcr9i.chat.openai.com/fc/gt2/public_key/35536E1E-65B4-4D96-9D97-6ADB7EFF8147', arkBx='', arkHeader={'User-Agent': 'Mozilla/5.0'}, arkBody={'bda': 'your_bda'}, arkCookies={}, userAgent='Mozilla/5.0')
>>> genArkReq(chatArk)
<arkReq object at 0x10101010>
```

### `sendRequest`

**Назначение**:  Функция отправляет запрос Arkose на сервер OpenAI и получает токен Arkose.

**Параметры**:
- `tmpArk (arkReq)`: Объект класса `arkReq`, содержащий информацию о запросе Arkose.
- `proxy (str, optional)`: URL-адрес прокси-сервера. По умолчанию `None`.

**Возвращает**:
- `str`: Токен Arkose, если он успешно сгенерирован.

**Вызывает исключения**:
- `RuntimeError`: Если не получен валидный токен Arkose.

**Как работает функция**:
1. Функция создает объект `StreamSession` с заданными заголовками, куками и прокси.
2. Она отправляет POST-запрос на URL-адрес Arkose (`tmpArk.arkURL`) с данными из `tmpArk.arkBody`.
3. Она извлекает токен Arkose из ответа.
4. Она проверяет, является ли токен Arkose валидным.
5. Если токен Arkose валидный, она возвращает его.

**Примеры**:
```python
>>> tmpArk = arkReq(arkURL='https://tcr9i.chat.openai.com/fc/gt2/public_key/35536E1E-65B4-4D96-9D97-6ADB7EFF8147', arkBx='', arkHeader={'User-Agent': 'Mozilla/5.0'}, arkBody={'bda': 'your_bda'}, arkCookies={}, userAgent='Mozilla/5.0')
>>> sendRequest(tmpArk)
'sup=1|rid=your_arkose_token'
```

### `getBDA`

**Назначение**: Функция генерирует новое значение `bda` для запроса Arkose.

**Параметры**:
- `arkReq (arkReq)`: Объект класса `arkReq`, содержащий информацию о запросе Arkose.

**Возвращает**:
- `tuple`: Кортеж, содержащий новое значение `bda` и `bw`.

**Как работает функция**:
1. Функция получает значение `bx` из объекта `arkReq`.
2. Она генерирует новое значение `n` с помощью функции `getN()`.
3. Она заменяет старое значение `n` в `bx` на новое значение.
4. Она генерирует новое значение `bw` с помощью функции `getBw()`.
5. Она шифрует `bx` с помощью `encrypt()`.
6. Она возвращает зашифрованный `bx` (`bda`) и `bw`.

**Примеры**:
```python
>>> arkReq = arkReq(arkURL='https://tcr9i.chat.openai.com/fc/gt2/public_key/35536E1E-65B4-4D96-9D97-6ADB7EFF8147', arkBx='', arkHeader={'User-Agent': 'Mozilla/5.0'}, arkBody={'bda': 'your_bda'}, arkCookies={}, userAgent='Mozilla/5.0')
>>> getBDA(arkReq)
('your_new_bda', 'your_new_bw')
```

### `getBt`

**Назначение**: Функция получает текущее время в секундах.

**Параметры**:  Отсутствуют.

**Возвращает**:
- `int`: Текущее время в секундах.

**Примеры**:
```python
>>> getBt()
1688893400
```

### `getBw`

**Назначение**: Функция вычисляет значение `bw` для запроса Arkose.

**Параметры**:
- `bt (int)`: Время в секундах.

**Возвращает**:
- `str`: Значение `bw`.

**Как работает функция**:
1. Функция получает время в секундах `bt`.
2. Она делит `bt` на 21600 (6 часов в секундах) и отнимает остаток.
3. Она возвращает результат в виде строки.

**Примеры**:
```python
>>> getBw(1688893400)
'1688891200'
```

### `getN`

**Назначение**: Функция генерирует новое значение `n` для запроса Arkose.

**Параметры**:  Отсутствуют.

**Возвращает**:
- `str`: Значение `n`.

**Как работает функция**:
1. Функция получает текущее время в секундах.
2. Она преобразует время в строку и кодирует ее в Base64.
3. Она возвращает результат в виде строки.

**Примеры**:
```python
>>> getN()
'MTY4ODg5MzQwMA=='
```

### `get_request_config`

**Назначение**: Функция получает конфигурацию запроса, включая токен доступа, токен подтверждения, токен Turnstile, куки и информацию о запросе Arkose.

**Параметры**:
- `request_config (RequestConfig)`: Объект класса `RequestConfig`, в который будут записаны извлеченные данные.
- `proxy (str)`: URL-адрес прокси-сервера.

**Возвращает**:
- `RequestConfig`: Объект класса `RequestConfig`, содержащий конфигурацию запроса.

**Как работает функция**:
1. Функция проверяет, был ли уже извлечен токен подтверждения.
2. Если токен подтверждения не был извлечен, функция вызывает `readHAR()` для извлечения токена.
3. Если был извлечен запрос Arkose, функция отправляет запрос на сервер OpenAI и получает токен Arkose.
4. Она сохраняет полученные данные в объект `request_config`.

**Примеры**:
```python
>>> request_config = RequestConfig()
>>> get_request_config(request_config, 'http://proxy.example.com')
<RequestConfig object at 0x10101010>