# Модуль для обработки ответов от провайдеров g4f

## Обзор

Модуль `response.py` предназначен для обработки и форматирования ответов, получаемых от различных провайдеров в проекте `g4f`. Он включает в себя функции для работы с URL, текстом, изображениями, аудио и другими типами данных. Модуль содержит классы для представления различных типов ответов, таких как JSON, текст, изображения, видео и т. д.

## Подробнее

Модуль предоставляет набор инструментов для стандартизации и упрощения работы с данными, возвращаемыми различными провайдерами. Это позволяет унифицировать процесс обработки ответов и облегчить интеграцию новых провайдеров в систему.

## Функции

### `quote_url`

```python
def quote_url(url: str) -> str:
    """Функция кодирует части URL, сохраняя структуру домена.

    Args:
        url (str): URL для кодирования.

    Returns:
        str: Правильно закодированный URL.
    """
```

**Назначение**: Кодирует специальные символы в URL, чтобы URL мог быть правильно передан в HTTP-запросе. Функция обрабатывает URL, разделяя его на протокол, домен и путь, и кодирует только путь, чтобы не повредить структуру URL.

**Как работает функция**:
1.  Проверяет, содержит ли URL закодированные символы (`%`). Если да, то сначала декодирует URL, чтобы избежать двойного кодирования.
2.  Разделяет URL на части, используя `//` в качестве разделителя, чтобы отделить протокол от остальной части URL.
3.  Если в URL нет `//`, то рассматривает его как относительный URL и кодирует его целиком.
4.  Если в URL есть `//`, то разделяет оставшуюся часть на домен и путь, используя `/` в качестве разделителя.
5.  Кодирует только часть пути URL, оставляя протокол и домен без изменений.

**Примеры**:

```python
quote_url("https://example.com/path?query=value#fragment")
# Результат: "https://example.com/path%3Fquery%3Dvalue%23fragment"

quote_url("/relative/path?query=value")
# Результат: "%2Frelative%2Fpath%3Fquery%3Dvalue"
```

### `quote_title`

```python
def quote_title(title: str) -> str:
    """Функция нормализует пробелы в заголовке.

    Args:
        title (str): Заголовок для нормализации.

    Returns:
        str: Заголовок с нормализованными пробелами.
    """
```

**Назначение**: Удаляет лишние пробелы из заголовка и заменяет множественные пробелы на одинарные.

**Как работает функция**:
1.  Разделяет строку заголовка на список слов, используя пробелы в качестве разделителя.
2.  Объединяет список слов обратно в строку, используя одинарный пробел между словами.

**Примеры**:

```python
quote_title("  Пример   заголовка  ")
# Результат: "Пример заголовка"

quote_title("")
# Результат: ""
```

### `format_link`

```python
def format_link(url: str, title: Optional[str] = None) -> str:
    """Функция форматирует URL и заголовок как ссылку в формате Markdown.

    Args:
        url (str): URL для ссылки.
        title (Optional[str], optional): Заголовок для отображения. Если `None`, извлекается из URL.

    Returns:
        str: Отформатированная ссылка в формате Markdown.
    """
```

**Назначение**: Создает Markdown-ссылку из URL и заголовка. Если заголовок не указан, пытается извлечь его из URL.

**Как работает функция**:

1.  Если заголовок не передан, пытается извлечь его из URL, разделяя URL на части и удаляя префикс `www.`.
2.  Кодирует URL с помощью функции `quote_url`.
3.  Форматирует заголовок с помощью функции `quote_title`.
4.  Возвращает строку в формате Markdown-ссылки `[title](url)`.

**Примеры**:

```python
format_link("https://example.com", "Example")
# Результат: "[Example](https://example.com)"

format_link("https://example.com/path?query=value")
# Результат: "[example.com/path](https://example.com/path%3Fquery%3Dvalue)"
```

### `format_image`

```python
def format_image(image: str, alt: str, preview: Optional[str] = None) -> str:
    """Функция форматирует изображение как строку Markdown.

    Args:
        image (str): Изображение для форматирования.
        alt (str): Альтернативный текст для изображения.
        preview (Optional[str], optional): URL для предварительного просмотра. По умолчанию используется оригинальное изображение.

    Returns:
        str: Отформатированная строка Markdown.
    """
```

**Назначение**: Форматирует URL изображения и альтернативный текст в формат Markdown для вставки изображения.

**Как работает функция**:

1.  Если предоставлен URL для предпросмотра, заменяет в нем плейсхолдер `{image}` на URL оригинального изображения.
2.  Кодирует URL предпросмотра и URL изображения с помощью функции `quote_url`.
3.  Форматирует альтернативный текст с помощью функции `quote_title`.
4.  Возвращает строку в формате Markdown для вставки изображения `[![alt text](preview_url)](image_url)`.

**Примеры**:

```python
format_image("https://example.com/image.jpg", "Example Image")
# Результат: "[![Example Image](https://example.com/image.jpg)](https://example.com/image.jpg)"

format_image("https://example.com/image.jpg", "Example Image", "https://example.com/preview/{image}")
# Результат: "[![Example Image](https://example.com/preview/https%3A//example.com/image.jpg)](https://example.com/image.jpg)"
```

### `format_images_markdown`

```python
def format_images_markdown(images: Union[str, List[str]], alt: str,
                           preview: Union[str, List[str]] = None) -> str:
    """Функция форматирует заданные изображения как строку Markdown.

    Args:
        images (Union[str, List[str]]): Изображение или список изображений для форматирования.
        alt (str): Альтернативный текст для изображений.
        preview (Union[str, List[str]], optional): URL предпросмотра или список URL предпросмотра.
            Если не предоставлен, используются оригинальные изображения.

    Returns:
        str: Отформатированная строка Markdown.
    """
```

**Назначение**: Форматирует одно или несколько изображений в Markdown-формат. Поддерживает как одиночные изображения, так и списки изображений, а также предпросмотр изображений.

**Как работает функция**:

1.  Если передан список изображений, содержащий только одно изображение, извлекает это изображение из списка.
2.  Если `images` является строкой, форматирует её как одиночное изображение с помощью функции `format_image`.
3.  Если `images` является списком, форматирует каждое изображение в списке с помощью функции `format_image` и объединяет результаты в одну строку, разделенную символом новой строки `\n`.
4.  Добавляет флаги начала и конца `<!-- generated images start -->` и `<!-- generated images end -->` вокруг отформатированных изображений.

**Примеры**:

```python
format_images_markdown("https://example.com/image.jpg", "Example Image")
# Результат:
# "\n<!-- generated images start -->\n[![Example Image](https://example.com/image.jpg)](https://example.com/image.jpg)\n<!-- generated images end -->\n"

format_images_markdown(["https://example.com/image1.jpg", "https://example.com/image2.jpg"], "Example Image", ["https://example.com/preview1", "https://example.com/preview2"])
# Результат:
# "\n<!-- generated images start -->\n[![#1 Example Image](https://example.com/preview1)](https://example.com/image1.jpg)\n[![#2 Example Image](https://example.com/preview2)](https://example.com/image2.jpg)\n<!-- generated images end -->\n"
```

## Классы

### `ResponseType`

```python
class ResponseType:
    """Абстрактный базовый класс для всех типов ответов."""

    @abstractmethod
    def __str__(self) -> str:
        """Преобразует ответ в строковое представление."""
        raise NotImplementedError
```

**Описание**: Абстрактный базовый класс для всех типов ответов.

**Методы**:

*   `__str__`: Абстрактный метод, который должен быть реализован в подклассах для преобразования ответа в строковое представление.

### `JsonMixin`

```python
class JsonMixin:
    """Миксин для классов, которые могут быть представлены в формате JSON."""

    def __init__(self, **kwargs) -> None:
        """Инициализирует атрибуты объекта на основе переданных именованных аргументов."""

    def get_dict(self) -> Dict:
        """Возвращает словарь, содержащий все не приватные атрибуты объекта."""

    def reset(self) -> None:
        """Сбрасывает все атрибуты объекта."""
```

**Описание**: Предоставляет функциональность для работы с JSON-представлением объектов.

**Методы**:

*   `__init__`: Инициализирует атрибуты объекта на основе переданных именованных аргументов.
*   `get_dict`: Возвращает словарь, содержащий все не приватные атрибуты объекта.
*   `reset`: Сбрасывает все атрибуты объекта.

### `RawResponse`

```python
class RawResponse(ResponseType, JsonMixin):
    """Представляет необработанный ответ."""
    pass
```

**Описание**: Класс для представления необработанных ответов.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.
*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.

### `HiddenResponse`

```python
class HiddenResponse(ResponseType):
    """Представляет скрытый ответ, который не должен отображаться."""

    def __str__(self) -> str:
        """Возвращает пустую строку."""
        return ""
```

**Описание**: Класс для представления скрытых ответов, которые не должны отображаться.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Методы**:

*   `__str__`: Возвращает пустую строку, чтобы скрыть ответ.

### `FinishReason`

```python
class FinishReason(JsonMixin, HiddenResponse):
    """Представляет причину завершения ответа."""

    def __init__(self, reason: str) -> None:
        """Инициализирует объект с указанием причины завершения."""
        self.reason = reason
```

**Описание**: Класс для представления причины завершения генерации текста.

**Наследует**:

*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.
*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `reason` (str): Причина завершения.

### `ToolCalls`

```python
class ToolCalls(HiddenResponse):
    """Представляет вызовы инструментов."""

    def __init__(self, list: List) -> None:
        """Инициализирует объект списком вызовов инструментов."""
        self.list = list

    def get_list(self) -> List:
        """Возвращает список вызовов инструментов."""
        return self.list
```

**Описание**: Класс для представления вызовов инструментов.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `list` (List): Список вызовов инструментов.

**Методы**:

*   `get_list`: Возвращает список вызовов инструментов.

### `Usage`

```python
class Usage(JsonMixin, HiddenResponse):
    """Представляет информацию об использовании ресурсов."""
    pass
```

**Описание**: Класс для представления информации об использовании ресурсов (например, количество токенов).

**Наследует**:

*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.
*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

### `AuthResult`

```python
class AuthResult(JsonMixin, HiddenResponse):
    """Представляет результат аутентификации."""
    pass
```

**Описание**: Класс для представления результата аутентификации.

**Наследует**:

*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.
*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

### `TitleGeneration`

```python
class TitleGeneration(HiddenResponse):
    """Представляет сгенерированный заголовок."""

    def __init__(self, title: str) -> None:
        """Инициализирует объект с указанием заголовка."""
        self.title = title
```

**Описание**: Класс для представления сгенерированного заголовка.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `title` (str): Сгенерированный заголовок.

### `DebugResponse`

```python
class DebugResponse(HiddenResponse):
    """Представляет отладочное сообщение."""

    def __init__(self, log: str) -> None:
        """Инициализирует объект с указанием отладочного сообщения."""
        self.log = log
```

**Описание**: Класс для представления отладочного сообщения.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `log` (str): Отладочное сообщение.

### `Reasoning`

```python
class Reasoning(ResponseType):
    """Представляет процесс рассуждения."""

    def __init__(
            self,
            token: Optional[str] = None,
            label: Optional[str] = None,
            status: Optional[str] = None,
            is_thinking: Optional[str] = None
        ) -> None:
        """Инициализирует объект с указанием токена, статуса и состояния размышления."""
        self.token = token
        self.label = label
        self.status = status
        self.is_thinking = is_thinking

    def __str__(self) -> str:
        """Возвращает строковое представление на основе доступных атрибутов."""

    def __eq__(self, other: Reasoning):
        """Сравнивает два объекта Reasoning на равенство."""
        return (self.token == other.token and
                self.status == other.status and
                self.is_thinking == other.is_thinking)

    def get_dict(self) -> Dict:
        """Возвращает словарь, содержащий представление процесса рассуждения."""
```

**Описание**: Класс для представления процесса рассуждения.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Атрибуты**:

*   `token` (Optional[str]): Токен.
*   `label` (Optional[str]): Метка.
*   `status` (Optional[str]): Статус.
*   `is_thinking` (Optional[str]): Состояние размышления.

**Методы**:

*   `__str__`: Возвращает строковое представление на основе доступных атрибутов.
*   `__eq__`: Сравнивает два объекта `Reasoning` на равенство.
*   `get_dict`: Возвращает словарь, содержащий представление процесса рассуждения.

### `Sources`

```python
class Sources(ResponseType):
    """Представляет источники информации."""

    def __init__(self, sources: List[Dict[str, str]]) -> None:
        """Инициализирует объект списком словарей, содержащих информацию об источниках."""
        self.list = []
        for source in sources:
            self.add_source(source)

    def add_source(self, source: Union[Dict[str, str], str]) -> None:
        """Добавляет источник в список, очищая URL при необходимости."""

    def __str__(self) -> str:
        """Возвращает отформатированные источники в виде строки."""
```

**Описание**: Класс для представления источников информации.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Атрибуты**:

*   `list` (List): Список источников.

**Методы**:

*   `__init__`: Инициализирует объект списком словарей, содержащих информацию об источниках.
*   `add_source`: Добавляет источник в список, очищая URL при необходимости.
*   `__str__`: Возвращает отформатированные источники в виде строки.

### `YouTube`

```python
class YouTube(HiddenResponse):
    """Представляет список идентификаторов видео YouTube."""

    def __init__(self, ids: List[str]) -> None:
        """Инициализирует объект списком идентификаторов видео YouTube."""
        self.ids = ids

    def to_string(self) -> str:
        """Возвращает строку с HTML-кодом для встраивания видео YouTube."""
```

**Описание**: Класс для представления списка идентификаторов видео YouTube.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `ids` (List[str]): Список идентификаторов видео YouTube.

**Методы**:

*   `__init__`: Инициализирует объект списком идентификаторов видео YouTube.
*   `to_string`: Возвращает строку с HTML-кодом для встраивания видео YouTube.

### `AudioResponse`

```python
class AudioResponse(ResponseType):
    """Представляет аудиоданные."""

    def __init__(self, data: Union[bytes, str]) -> None:
        """Инициализирует объект аудиоданными в виде байтов."""
        self.data = data

    def to_uri(self) -> str:
        """Возвращает аудиоданные в виде URI, закодированного в base64."""

    def __str__(self) -> str:
        """Возвращает аудио в виде HTML-элемента."""
```

**Описание**: Класс для представления аудиоданных.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Атрибуты**:

*   `data` (Union[bytes, str]): Аудиоданные в виде байтов.

**Методы**:

*   `__init__`: Инициализирует объект аудиоданными в виде байтов.
*   `to_uri`: Возвращает аудиоданные в виде URI, закодированного в base64.
*   `__str__`: Возвращает аудио в виде HTML-элемента.

### `BaseConversation`

```python
class BaseConversation(ResponseType):
    """Базовый класс для представления истории разговора."""

    def __str__(self) -> str:
        """Возвращает пустую строку по умолчанию."""
        return ""
```

**Описание**: Базовый класс для представления истории разговора.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Методы**:

*   `__str__`: Возвращает пустую строку по умолчанию.

### `JsonConversation`

```python
class JsonConversation(BaseConversation, JsonMixin):
    """Представляет историю разговора в формате JSON."""
    pass
```

**Описание**: Класс для представления истории разговора в формате JSON.

**Наследует**:

*   `BaseConversation`: Базовый класс для представления истории разговора.
*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.

### `SynthesizeData`

```python
class SynthesizeData(HiddenResponse, JsonMixin):
    """Представляет данные для синтеза."""

    def __init__(self, provider: str, data: Dict) -> None:
        """Инициализирует объект с указанием провайдера и данных."""
        self.provider = provider
        self.data = data
```

**Описание**: Класс для представления данных для синтеза (например, для синтеза речи).

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.
*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.

**Атрибуты**:

*   `provider` (str): Провайдер.
*   `data` (Dict): Данные.

### `SuggestedFollowups`

```python
class SuggestedFollowups(HiddenResponse):
    """Представляет предложенные варианты продолжения разговора."""
    def __init__(self, suggestions: list[str]):
        self.suggestions = suggestions
```

**Описание**: Класс для представления предложенных вариантов продолжения разговора.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `suggestions` (list[str]): Список предложенных вариантов продолжения разговора.

### `RequestLogin`

```python
class RequestLogin(HiddenResponse):
    """Представляет запрос на вход в систему."""

    def __init__(self, label: str, login_url: str) -> None:
        """Инициализирует объект с указанием метки и URL для входа."""
        self.label = label
        self.login_url = login_url

    def to_string(self) -> str:
        """Возвращает отформатированную ссылку для входа в систему в виде строки."""
```

**Описание**: Класс для представления запроса на вход в систему.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `label` (str): Метка.
*   `login_url` (str): URL для входа.

**Методы**:

*   `to_string`: Возвращает отформатированную ссылку для входа в систему в виде строки.

### `MediaResponse`

```python
class MediaResponse(ResponseType):
    """Базовый класс для представления медиа-ответов (изображения, видео и т.д.)."""

    def __init__(
        self,
        urls: Union[str, List[str]],
        alt: str,
        options: Dict = {},
        **kwargs
    ) -> None:
        """Инициализирует объект с указанием URL, альтернативного текста и опций."""
        self.urls = kwargs.get("images", urls)
        self.alt = alt
        self.options = options

    def get(self, key: str) -> any:
        """Возвращает значение опции по ключу."""

    def get_list(self) -> List[str]:
        """Возвращает список URL."""
```

**Описание**: Базовый класс для представления медиа-ответов (изображения, видео и т.д.).

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.

**Атрибуты**:

*   `urls` (Union[str, List[str]]): URL или список URL.
*   `alt` (str): Альтернативный текст.
*   `options` (Dict): Опции.

**Методы**:

*   `__init__`: Инициализирует объект с указанием URL, альтернативного текста и опций.
*   `get`: Возвращает значение опции по ключу.
*   `get_list`: Возвращает список URL.

### `ImageResponse`

```python
class ImageResponse(MediaResponse):
    """Представляет ответ с изображением."""

    def __str__(self) -> str:
        """Возвращает изображение в формате Markdown."""
        return format_images_markdown(self.urls, self.alt, self.get("preview"))
```

**Описание**: Класс для представления ответа с изображением.

**Наследует**:

*   `MediaResponse`: Базовый класс для представления медиа-ответов.

**Методы**:

*   `__str__`: Возвращает изображение в формате Markdown.

### `VideoResponse`

```python
class VideoResponse(MediaResponse):
    """Представляет ответ с видео."""

    def __str__(self) -> str:
        """Возвращает видео в виде HTML-элементов."""
        return "\\n".join([f\'<video controls src="{video}"></video>\' for video in self.get_list()])
```

**Описание**: Класс для представления ответа с видео.

**Наследует**:

*   `MediaResponse`: Базовый класс для представления медиа-ответов.

**Методы**:

*   `__str__`: Возвращает видео в виде HTML-элементов.

### `ImagePreview`

```python
class ImagePreview(ImageResponse):
    """Представляет предварительный просмотр изображения."""

    def __str__(self) -> str:
        """Возвращает пустую строку для предварительного просмотра."""
        return ""

    def to_string(self) -> str:
        """Возвращает изображение в формате Markdown."""
        return super().__str__()
```

**Описание**: Класс для представления предварительного просмотра изображения.

**Наследует**:

*   `ImageResponse`: Класс для представления ответа с изображением.

**Методы**:

*   `__str__`: Возвращает пустую строку для предварительного просмотра.
*   `to_string`: Возвращает изображение в формате Markdown.

### `PreviewResponse`

```python
class PreviewResponse(HiddenResponse):
    """Представляет ответ с предварительным просмотром."""

    def __init__(self, data: str) -> None:
        """Инициализирует объект с указанием данных."""
        self.data = data

    def to_string(self) -> str:
        """Возвращает данные в виде строки."""
        return self.data
```

**Описание**: Класс для представления ответа с предварительным просмотром.

**Наследует**:

*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.

**Атрибуты**:

*   `data` (str): Данные.

**Методы**:

*   `__init__`: Инициализирует объект с указанием данных.
*   `to_string`: Возвращает данные в виде строки.

### `Parameters`

```python
class Parameters(ResponseType, JsonMixin):
    """Представляет параметры."""

    def __str__(self) -> str:
        """Возвращает пустую строку."""
        return ""
```

**Описание**: Класс для представления параметров.

**Наследует**:

*   `ResponseType`: Обеспечивает базовый интерфейс для всех типов ответов.
*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.

**Методы**:

*   `__str__`: Возвращает пустую строку.

### `ProviderInfo`

```python
class ProviderInfo(JsonMixin, HiddenResponse):
    """Представляет информацию о провайдере."""
    pass
```

**Описание**: Класс для представления информации о провайдере.

**Наследует**:

*   `JsonMixin`: Предоставляет методы для работы с JSON-представлением объекта.
*   `HiddenResponse`: Скрытый ответ, не отображается напрямую.