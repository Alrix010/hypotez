## \file hypotez/src/endpoints/gpt4free/g4f/Provider/needs_auth/Reka.py
# -*- coding: utf-8 -*-
#! .pyenv/bin/python3

"""
Модуль для взаимодействия с провайдером Reka AI.
==================================================

Модуль содержит класс `Reka`, который используется для взаимодействия с Reka AI,
платформой для создания и взаимодействия с ИИ-ассистентами.
Он включает методы для создания завершений, загрузки изображений и получения токена доступа.

"""

## Обзор

Этот модуль предоставляет класс `Reka`, который реализует взаимодействие с API Reka AI.
Он поддерживает создание текстовых завершений (completions) и загрузку изображений для использования в беседах с ИИ.
Класс требует аутентификации и использует cookies для управления сессией.

## Подробней

Класс `Reka` наследуется от `AbstractProvider` и реализует методы, необходимые для взаимодействия с API Reka AI.
Он поддерживает стриминг ответов, загрузку изображений и получение токена доступа.

## Классы

### `Reka`

**Описание**:
Класс для взаимодействия с API Reka AI.

**Наследует**:
`AbstractProvider` - базовый класс для провайдеров, реализующих логику взаимодействия с различными API.

**Атрибуты**:
- `domain` (str): Доменное имя Reka AI.
- `url` (str): URL Reka AI.
- `working` (bool): Индикатор работоспособности провайдера.
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
- `supports_stream` (bool): Флаг, указывающий на поддержку стриминга ответов.
- `default_vision_model` (str): Модель для работы с изображениями по умолчанию.
- `cookies` (dict): Словарь с cookies для аутентификации.
- `proxy` (str): Прокси-сервер для выполнения запросов.

**Методы**:
- `create_completion()`: Создает запрос на завершение текста.
- `upload_image()`: Загружает изображение на сервер Reka AI.
- `get_access_token()`: Получает токен доступа для аутентификации.

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    api_key: str = None,
    image: ImageType = None,
    **kwargs
) -> CreateResult:
    """
    Создает запрос на завершение текста к Reka AI.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для контекста беседы.
        stream (bool): Флаг, указывающий на необходимость стриминга ответов.
        proxy (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        image (ImageType, optional): Изображение для отправки с запросом. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат запроса.

    Raises:
        ValueError: Если не найдены cookies или отсутствует `appSession` в cookies.
    """
    ...
```

**Назначение**:
Функция `create_completion` отправляет запрос к API Reka AI для создания завершения текста на основе предоставленных сообщений и параметров.

**Как работает функция**:

1.  Функция устанавливает прокси-сервер, если он указан.
2.  Если `api_key` не предоставлен, функция пытается получить его из cookies.
    *   Если cookies отсутствуют или не содержат `appSession`, вызывается исключение `ValueError`.
    *   Если cookies получены, функция вызывает `get_access_token` для получения `api_key`.
3.  Функция формирует историю разговоров, преобразуя входные сообщения в формат, требуемый API Reka AI.
4.  Если предоставлено изображение, оно загружается на сервер с помощью `upload_image`, и URL изображения добавляется в последнее сообщение.
5.  Функция создает заголовки запроса, включая токен авторизации.
6.  Формируется JSON-тело запроса с историей разговоров, параметрами стриминга, использования поисковой системы и интерпретатора кода, названием модели и случайным зерном.
7.  Функция отправляет POST-запрос к API Reka AI и итерируется по ответам, извлекая текст завершения и возвращая его как генератор.

### `upload_image`

```python
def upload_image(cls, access_token, image: ImageType) -> str:
    """
    Загружает изображение на сервер Reka AI.

    Args:
        cls: Класс Reka.
        access_token (str): Токен доступа для аутентификации.
        image (ImageType): Изображение для загрузки.

    Returns:
        str: URL загруженного изображения.
    """
    ...
```

**Назначение**:
Функция `upload_image` загружает изображение на сервер Reka AI и возвращает URL загруженного изображения.

**Как работает функция**:

1.  Генерируется случайный токен `boundary_token`.
2.  Формируются заголовки запроса, включая токен авторизации и `content-type` с использованием `boundary_token`.
3.  Изображение преобразуется в байты с помощью функции `to_bytes`.
4.  Формируется тело запроса в формате `multipart/form-data`, включающее данные изображения.
5.  Отправляется POST-запрос к API Reka AI для загрузки изображения.
6.  Извлекается и возвращается URL загруженного изображения из JSON-ответа.

### `get_access_token`

```python
def get_access_token(cls):
    """
    Получает токен доступа для аутентификации.

    Args:
        cls: Класс Reka.

    Returns:
        str: Токен доступа.

    Raises:
        ValueError: Если не удается получить токен доступа.
    """
    ...
```

**Назначение**:
Функция `get_access_token` получает токен доступа для аутентификации в API Reka AI.

**Как работает функция**:

1.  Формируются заголовки запроса, включая `referer` и `user-agent`.
2.  Отправляется GET-запрос к API Reka AI для получения токена доступа.
3.  Извлекается токен доступа из JSON-ответа.
4.  В случае ошибки при получении токена вызывается исключение `ValueError` с информацией об ошибке.