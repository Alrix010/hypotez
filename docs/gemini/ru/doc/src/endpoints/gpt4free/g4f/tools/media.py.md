# Модуль для обработки медиа-файлов

## Обзор

Модуль `media.py` предназначен для обработки и рендеринга медиа-файлов, таких как изображения и аудио, в контексте проекта `hypotez`. Он предоставляет функции для преобразования медиа-файлов в различные форматы, такие как base64, URL, а также для объединения медиа-файлов с сообщениями. Модуль также включает функции для чтения файлов из бакетов и определения типов медиа-данных.

## Подробней

Этот модуль играет важную роль в обработке сообщений, содержащих медиа-контент. Он обеспечивает преобразование медиа-файлов в удобные для использования форматы и интеграцию этих файлов в структуру сообщений. Модуль использует функции из других модулей, таких как `files` и `image`, для выполнения своих задач.

## Функции

### `render_media`

```python
def render_media(bucket_id: str, name: str, url: str, as_path: bool = False, as_base64: bool = False) -> Union[str, Path]:
    """
    Рендерит медиа-файл в зависимости от указанных параметров.

    Args:
        bucket_id (str): ID бакета, где хранится файл.
        name (str): Имя файла.
        url (str): URL файла.
        as_path (bool, optional): Если `True`, возвращает путь к файлу. По умолчанию `False`.
        as_base64 (bool, optional): Если `True`, возвращает файл в формате base64. По умолчанию `False`.

    Returns:
        Union[str, Path]: URL файла, путь к файлу или данные в формате base64.

    Как работает функция:
    - Проверяет, нужно ли вернуть файл как путь (`as_path`) или как base64 (`as_base64`), или если URL начинается с "/".
    - Если `as_path` равен `True`, функция возвращает путь к файлу.
    - Если `as_base64` равен `True`, функция читает файл, кодирует его в base64 и возвращает строку base64.
    - Если ни одно из условий не выполнено, функция возвращает URL файла в формате data URI.
    - Если URL не начинается с "/", функция просто возвращает URL.

    Примеры:
        >>> render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png', as_path=True)
        PosixPath('test_bucket/media/image.png')
        >>> render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png', as_base64=True)[:20]
        'iVBORw0KGgoAAAANSUh'
        >>> render_media(bucket_id='test_bucket', name='image.png', url='/media/image.png')[:30]
        'data:image/png;base64,iVBOR'
    """
    ...
```

### `render_part`

```python
def render_part(part: dict) -> dict:
    """
    Рендерит часть сообщения, определяя тип контента (текст, аудио, изображение).

    Args:
        part (dict): Словарь с информацией о части сообщения.

    Returns:
        dict: Словарь с информацией о типе и содержании части сообщения.

    Как работает функция:
    - Проверяет наличие ключа "type" в словаре `part`. Если он есть, функция возвращает `part` без изменений.
    - Если "type" отсутствует, функция проверяет наличие ключа "name".
    - Если "name" отсутствует, функция пытается прочитать содержимое бакета и возвращает текстовую часть сообщения.
    - Если файл является аудио, функция возвращает словарь с типом "input_audio" и данными в формате base64.
    - В противном случае функция возвращает словарь с типом "image_url" и URL изображения.

    Примеры:
        >>> render_part({'bucket_id': 'test_bucket'})
        {'type': 'text', 'text': ''}
    """
    ...
```

### `merge_media`

```python
def merge_media(media: list, messages: list) -> Iterator:
    """
    Объединяет медиа-файлы с сообщениями пользователей.

    Args:
        media (list): Список медиа-файлов.
        messages (list): Список сообщений.

    Yields:
        Iterator: Медиа-файлы.

    Как работает функция:
    - Проходит по списку сообщений.
    - Если роль сообщения - "user", функция проверяет содержимое сообщения.
    - Если содержимое является списком, функция проходит по частям содержимого.
    - Если в части отсутствует ключ "type" и есть ключ "name", функция рендерит медиа-файл как путь и добавляет его в буфер.
    - Если тип части - "image_url", функция добавляет URL изображения в буфер.
    - После обработки всех сообщений пользователей функция возвращает медиа-файлы из буфера и списка `media`.

    Примеры:
        >>> list(merge_media(media=[], messages=[{'role': 'user', 'content': []}]))
        []
    """
    ...
```

### `render_messages`

```python
def render_messages(messages: Messages, media: list = None) -> Iterator:
    """
    Рендерит сообщения, обрабатывая медиа-файлы и преобразуя их в нужный формат.

    Args:
        messages (Messages): Список сообщений.
        media (list, optional): Список медиа-файлов. По умолчанию `None`.

    Yields:
        Iterator: Обработанные сообщения.

    Как работает функция:
    - Проходит по списку сообщений.
    - Если содержимое сообщения является списком, функция рендерит каждую часть сообщения с помощью `render_part`.
    - Если есть медиа-файлы и это последнее сообщение, функция добавляет медиа-файлы в содержимое сообщения, преобразуя их в формат `input_audio` или `image_url` в зависимости от типа файла.
    - Если содержимое сообщения является строкой и есть медиа-файлы, функция добавляет текстовое содержимое в конец списка содержимого.

    Примеры:
        >>> list(render_messages(messages=[{'role': 'user', 'content': []}]))
        [{'role': 'user', 'content': []}]
    """
    ...