# Модуль `AIChatFree`

## Обзор

Модуль `AIChatFree` представляет собой асинхронный провайдер для взаимодействия с сервисом AIChatFree. Он позволяет генерировать текст на основе предоставленных сообщений, поддерживая потоковую передачу данных и историю сообщений.

## Подробней

Этот модуль предназначен для использования в асинхронных приложениях, требующих взаимодействия с AI Chat Free для генерации текста. Он включает в себя функции для создания асинхронного генератора, формирования подписи запроса и обработки ответов от сервера.

## Классы

### `AIChatFree`

**Описание**: Класс `AIChatFree` является асинхронным провайдером и реализует методы для взаимодействия с API AIChatFree.

**Наследует**:
- `AsyncGeneratorProvider`: Предоставляет базовую функциональность для асинхронных провайдеров, генерирующих данные.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL-адрес сервиса AIChatFree (`https://aichatfree.info`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных (по умолчанию `True`).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (по умолчанию `True`).
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-pro`).

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от AIChatFree.

## Методы класса

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        connector: BaseConnector = None,
        **kwargs,
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от AIChatFree.

        Args:
            model (str): Модель для генерации текста.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            connector (BaseConnector, optional): Асинхронный коннектор. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий чанки текста.

        Raises:
            RateLimitError: Если достигнут лимит запросов.
            Exception: Если произошла ошибка при выполнении запроса.
        """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API AIChatFree.

**Параметры**:
- `model` (str): Модель, используемая для генерации текста.
- `messages` (Messages): Список сообщений, отправляемых в API. Каждое сообщение содержит `role` (роль отправителя: "user" или "assistant") и `content` (текст сообщения).
- `proxy` (str, optional): URL прокси-сервера для выполнения запроса. По умолчанию `None`.
- `connector` (BaseConnector, optional): Объект коннектора aiohttp для управления соединениями. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает чанки текста, полученные от API AIChatFree.

**Как работает функция**:
1. Формирует заголовки запроса, включая `User-Agent`, `Accept`, `Content-Type` и `Referer`.
2. Создает асинхронную сессию `aiohttp.ClientSession` с использованием предоставленного коннектора и заголовков.
3. Вычисляет текущий timestamp в миллисекундах.
4. Преобразует список сообщений в формат, ожидаемый API AIChatFree. Роль "assistant" преобразуется в "model", а роль "user" остается без изменений.
5. Формирует словарь `data` с сообщениями, временем и подписью, сгенерированной функцией `generate_signature`.
6. Отправляет POST-запрос к API AIChatFree по адресу `f"{cls.url}/api/generate"` с использованием `aiohttp.ClientSession`.
7. Обрабатывает возможные ошибки:
   - Если получен статус 500 и в тексте ответа содержится "Quota exceeded", вызывает исключение `RateLimitError`.
   - Вызывает `raise_for_status` для проверки статуса ответа и генерации исключения в случае ошибки.
8. Итерируется по содержимому ответа, декодируя каждый чанк и возвращая его через `yield`.

### Внутренние функции: Отсутствуют

**Примеры**:
```python
# Пример использования create_async_generator
messages = [
    {"role": "user", "content": "Привет!"},
    {"role": "assistant", "content": "Здравствуйте!"}
]
async for chunk in AIChatFree.create_async_generator(model="gemini-1.5-pro", messages=messages):
    print(chunk)
```

## Функции

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """Генерирует подпись для запроса к API.

    Args:
        time (int): Timestamp запроса.
        text (str): Текст сообщения.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: SHA256-хеш строки, используемый в качестве подписи.
    """
```

**Назначение**: Генерация подписи для запроса к API AIChatFree.

**Параметры**:
- `time` (int): Timestamp запроса в миллисекундах.
- `text` (str): Текст сообщения, для которого генерируется подпись.
- `secret` (str, optional): Секретный ключ, используемый при генерации подписи. По умолчанию пустая строка (`""`).

**Возвращает**:
- `str`: SHA256-хеш строки `f"{time}:{text}:{secret}"`, представленный в виде шестнадцатеричной строки.

**Как работает функция**:
1. Формирует строку сообщения, объединяя timestamp, текст сообщения и секретный ключ через двоеточие.
2. Кодирует строку сообщения в байты, используя кодировку UTF-8.
3. Вычисляет SHA256-хеш байтовой строки.
4. Преобразует хеш в шестнадцатеричную строку и возвращает ее.

### Внутренние функции: Отсутствуют

**Примеры**:
```python
# Пример использования generate_signature
timestamp = 1678886400000
text = "Привет, как дела?"
signature = generate_signature(time=timestamp, text=text)
print(signature)
```