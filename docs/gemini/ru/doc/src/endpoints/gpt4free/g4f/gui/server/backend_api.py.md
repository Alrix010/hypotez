# Модуль backend_api.py

## Обзор

Модуль `backend_api.py` предоставляет API для работы с различными моделями, провайдерами и функциями, такими как обработка диалогов, управление файлами и синтез речи. Он использует Flask для создания веб-сервера и предоставляет набор маршрутов для выполнения различных операций.

## Подробней

Этот модуль является частью системы `hypotez` и отвечает за обработку запросов к backend-серверу. Он включает в себя функциональность для работы с моделями, провайдерами, файлами и диалогами. Модуль использует Flask для создания API и предоставляет различные маршруты для выполнения операций, таких как получение списка моделей, обработка диалогов, управление файлами и синтез речи.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` обрабатывает различные endpoint-ы в Flask-приложении для backend-операций.

**Наследует**:
- `Api`: Наследует функциональность от базового класса `Api`.

**Атрибуты**:
- `app` (Flask): Экземпляр Flask-приложения.
- `routes` (dict): Словарь, отображающий API endpoint-ы на соответствующие обработчики.
- `chat_cache` (dict): Кеш для хранения данных чатов.

**Методы**:
- `__init__(self, app: Flask) -> None`: Инициализирует API backend-а с заданным Flask-приложением.
- `handle_synthesize(self, provider: str)`: Обрабатывает запрос на синтез речи с использованием указанного провайдера.
- `get_provider_models(self, provider: str)`: Получает список моделей для указанного провайдера.
- `_format_json(self, response_type: str, content=None, **kwargs) -> str`: Форматирует и возвращает JSON-ответ.

### `__init__`

```python
def __init__(self, app: Flask) -> None:
    """
    Инициализирует API backend-а с заданным Flask-приложением.

    Args:
        app (Flask): Flask-приложение, к которому нужно привязать маршруты.
    """
```

**Как работает функция**:

- Функция принимает экземпляр Flask-приложения в качестве аргумента.
- Устанавливает Flask-приложение как атрибут `self.app`.
- Инициализирует `chat_cache` как пустой словарь.
- Определяет маршруты для различных операций, таких как главная страница, QR-код, модели, провайдеры, диалоги и т. д.
- Регистрирует маршруты Flask-приложения для обработки соответствующих запросов.

**Примеры**:
```python
app = Flask(__name__)
backend_api = Backend_Api(app)
```

### `handle_synthesize`

```python
def handle_synthesize(self, provider: str):
    """
    Обрабатывает запрос на синтез речи с использованием указанного провайдера.

    Args:
        provider (str): Название провайдера для синтеза речи.

    Returns:
        flask.Response: Ответ Flask с синтезированными данными или сообщением об ошибке.
    """
```

**Как работает функция**:
- Принимает имя провайдера в качестве аргумента.
- Преобразует имя провайдера в обработчик провайдера с помощью `convert_to_provider`.
- Проверяет, поддерживает ли провайдер функцию синтеза речи.
- Вызывает функцию синтеза речи провайдера с параметрами запроса.
- Обрабатывает асинхронные и синхронные ответы.
- Возвращает Flask-ответ с синтезированными данными и соответствующим content-type.

**Примеры**:
```python
# Пример вызова функции с именем провайдера
response = backend_api.handle_synthesize("google")
```

### `get_provider_models`

```python
def get_provider_models(self, provider: str):
    """
    Получает список моделей для указанного провайдера.

    Args:
        provider (str): Название провайдера.

    Returns:
        list: Список моделей или сообщение об ошибке.
    """
```

**Как работает функция**:
- Функция принимает имя провайдера в качестве аргумента.
- Извлекает `api_key` и `api_base` из заголовков запроса.
- Вызывает метод `get_provider_models` родительского класса `Api` для получения моделей.
- Возвращает список моделей или сообщение об ошибке, если провайдер не найден.

**Примеры**:
```python
# Пример вызова функции с именем провайдера
models = backend_api.get_provider_models("openai")
```

### `_format_json`

```python
def _format_json(self, response_type: str, content = None, **kwargs) -> str:
    """
    Форматирует и возвращает JSON-ответ.

    Args:
        response_type (str): Тип ответа.
        content: Содержимое ответа.
        kwargs: Дополнительные аргументы.

    Returns:
        str: JSON-строка.
    """
```

**Как работает функция**:
- Функция принимает тип ответа и содержимое в качестве аргументов.
- Вызывает метод `_format_json` родительского класса `Api` для форматирования ответа.
- Преобразует отформатированный ответ в JSON-строку.
- Добавляет символ новой строки в конец JSON-строки.
- Возвращает JSON-строку.

**Примеры**:
```python
# Пример вызова функции с типом ответа и содержимым
json_response = backend_api._format_json("success", {"message": "ok"})
```

## Функции

### `safe_iter_generator`

```python
def safe_iter_generator(generator: Generator) -> Generator:
    """
    Оборачивает генератор для безопасной итерации, гарантируя, что первый элемент будет возвращен.

    Args:
        generator (Generator): Исходный генератор.

    Returns:
        Generator: Обернутый генератор.
    """
```

**Как работает функция**:
- Функция принимает генератор в качестве аргумента.
- Извлекает первый элемент из генератора с помощью `next(generator)`.
- Определяет внутреннюю функцию `iter_generator`, которая сначала возвращает сохраненный первый элемент, а затем перебирает оставшиеся элементы исходного генератора.
- Возвращает новую функцию-генератор `iter_generator`.

**Примеры**:
```python
def my_generator():
    yield 1
    yield 2
    yield 3

safe_generator = safe_iter_generator(my_generator())
for item in safe_generator:
    print(item)
```

### `handle_conversation` (Внутренняя функция в `Backend_Api.__init__`)

```python
def handle_conversation():
    """
    Обрабатывает запросы на диалог и отправляет потоковые ответы обратно.

    Returns:
        Response: Объект ответа Flask для потоковой передачи.
    """
```

**Как работает функция**:
- Извлекает данные JSON из запроса (либо из `request.form`, либо из `request.json`).
- Обрабатывает загруженные медиафайлы, если они есть в запросе.
- Если приложение находится в режиме демонстрации и не указан провайдер, выбирает случайного провайдера из списка демонстрационных моделей.
- Подготавливает аргументы для создания диалога с помощью `self._prepare_conversation_kwargs`.
- Создает поток ответа с помощью `self._create_response_stream`.
- Возвращает Flask-ответ с потоком и MIME-типом `text/event-stream`.

### `add_usage` (Внутренняя функция в `Backend_Api.__init__`)

```python
def add_usage():
    """
    Добавляет информацию об использовании в кеш-файл.
    """
```

**Как работает функция**:
- Определяет директорию для хранения кеш-файлов.
- Определяет имя файла на основе текущей даты.
- Создает директорию, если она не существует.
- Открывает файл в режиме добавления или создания.
- Записывает данные JSON из запроса в файл.
- Возвращает пустой словарь.

### `add_log` (Внутренняя функция в `Backend_Api.__init__`)

```python
def add_log():
    """
    Добавляет информацию о логах в кеш-файл.
    """
```

**Как работает функция**:
- Определяет директорию для хранения кеш-файлов логов.
- Определяет имя файла на основе текущей даты.
- Создает директорию, если она не существует.
- Извлекает origin из заголовков запроса.
- Открывает файл в режиме добавления или создания.
- Записывает данные JSON из запроса в файл.
- Возвращает пустой словарь.

### `add_memory` (Внутренняя функция в `Backend_Api.__init__`)

```python
def add_memory(user_id: str):
    """
    Добавляет элементы в память клиента.

    Args:
        user_id (str): Идентификатор пользователя.
    """
```

**Как работает функция**:
- Извлекает `api_key` из заголовков запроса.
- Извлекает данные JSON из запроса.
- Инициализирует клиент `MemoryClient` с использованием `api_key`.
- Добавляет элементы в память клиента, преобразуя их в формат, необходимый для `MemoryClient`.
- Возвращает количество добавленных элементов.

### `read_memory` (Внутренняя функция в `Backend_Api.__init__`)

```python
def read_memory(user_id: str):
    """
    Читает память клиента.

    Args:
        user_id (str): Идентификатор пользователя.
    """
```

**Как работает функция**:
- Извлекает `api_key` из заголовков запроса.
- Инициализирует клиент `MemoryClient` с использованием `api_key`.
- Если в запросе есть параметр `search`, выполняет поиск по памяти клиента.
- Если нет параметра `search`, получает все элементы памяти клиента с пагинацией и фильтрацией.
- Возвращает результаты поиска или список элементов памяти.

### `create` (Внутренняя функция в `Backend_Api.__init__`)

```python
def create():
    """
    Создает ответ на основе запроса, используя различные инструменты и кэширование.
    """
```

**Как работает функция**:
- Определяет список инструментов (`tool_calls`), которые будут использоваться для обработки запроса.
- Добавляет инструмент веб-поиска, если указан параметр `web_search`.
- Определяет, нужно ли фильтровать Markdown в ответе.
- Определяет, нужно ли использовать кэш.
- Подготавливает параметры для вызова `ChatCompletion.create`.
- Если используется кэш, проверяет наличие кэшированного ответа. Если ответ есть в кэше, возвращает его. Если ответа нет в кэше, вызывает `ChatCompletion.create`, сохраняет ответ в кэш и возвращает его.
- Если кэш не используется, вызывает `ChatCompletion.create` и возвращает ответ.
- Фильтрует Markdown, если указан параметр `filter_markdown`.

**Внутренняя функция**: `cast_str`
```python
def cast_str():
    """
    Преобразует элементы ответа в строки.
    """
```
- Итерируется по элементам `response`.
- Проверяет, является ли элемент экземпляром `Exception`. Если элемент не является исключением, преобразует его в строку и передает дальше.
- Используется для преобразования чанков в строки

### `manage_files` (Внутренняя функция в `Backend_Api.__init__`)

```python
def manage_files(bucket_id: str):
    """
    Управляет файлами в bucket-е.

    Args:
        bucket_id (str): Идентификатор bucket-а.
    """
```

**Как работает функция**:
- Извлекает `bucket_id` из параметров запроса и проводит безопасную обработку имени файла.
- Определяет директорию bucket-а.
- Если метод запроса `DELETE`, пытается удалить директорию bucket-а.
- Если метод запроса `GET`, возвращает содержимое bucket-а в виде потока.
- Использует параметры запроса для определения, нужно ли удалять файлы, использовать Spacy для уточнения чанков и использовать `event-stream`.

### `upload_files` (Внутренняя функция в `Backend_Api.__init__`)

```python
def upload_files(bucket_id: str):
    """
    Загружает файлы в bucket.

    Args:
        bucket_id (str): Идентификатор bucket-а.
    """
```

**Как работает функция**:
- Извлекает `bucket_id` из параметров запроса и проводит безопасную обработку имени файла.
- Определяет директорию bucket-а и директорию для медиафайлов.
- Создает директории, если они не существуют.
- Итерируется по файлам, загруженным в запросе.
- Проводит безопасную обработку имени файла.
- Если файл является медиафайлом, сохраняет его в директорию медиафайлов.
- Если файл является обычным файлом, сохраняет его в директорию bucket-а.
- Записывает список файлов в файл `files.txt`.

### `get_media` (Внутренняя функция в `Backend_Api.__init__`)

```python
def get_media(bucket_id, filename, dirname: str = None):
    """
    Получает медиафайл из bucket-а.

    Args:
        bucket_id: Идентификатор bucket-а.
        filename: Имя файла.
        dirname (str, optional): Поддиректория. Defaults to None.
    """
```

**Как работает функция**:
- Определяет директорию медиафайлов.
- Пытается вернуть файл из директории.
- Если файл не найден, пытается получить `source_url` из параметров запроса и перенаправить на него.

### `find_media` (Внутренняя функция в `Backend_Api.__init__`)

```python
def find_media(search: str):
    """
    Ищет медиафайлы по тегам.

    Args:
        search (str): Строка поиска.
    """
```

**Как работает функция**:
- Извлекает строку поиска из параметров запроса и проводит безопасную обработку имени файла.
- Ищет файлы в директории изображений, соответствующие тегам поиска.
- Возвращает перенаправление на найденный файл.

### `upload_cookies` (Внутренняя функция в `Backend_Api.__init__`)

```python
def upload_cookies():
    """
    Загружает cookie-файлы.
    """
```

**Как работает функция**:
- Получает файл из запроса.
- Проверяет, является ли файл файлом cookie (`.json` или `.har`).
- Сохраняет файл в директорию cookie.

### `get_chat` (Внутренняя функция в `Backend_Api.__init__`)

```python
def get_chat(share_id: str) -> str:
    """
    Получает данные чата по share_id.

    Args:
        share_id (str): Идентификатор чата.

    Returns:
        str: Данные чата в формате JSON.
    """
```

**Как работает функция**:
- Извлекает `share_id` из параметров запроса и проводит безопасную обработку имени файла.
- Проверяет, не изменился ли чат с момента последнего запроса.
- Если чат не изменился, возвращает код 304 Not Modified.
- Если чат изменился, загружает данные чата из файла и возвращает их.

### `upload_chat` (Внутренняя функция в `Backend_Api.__init__`)

```python
def upload_chat(share_id: str) -> dict:
    """
    Загружает данные чата по share_id.

    Args:
        share_id (str): Идентификатор чата.

    Returns:
        dict: Словарь с share_id.
    """
```

**Как работает функция**:
- Извлекает `share_id` из параметров запроса и проводит безопасную обработку имени файла.
- Извлекает данные чата из запроса.
- Проверяет, не устарели ли данные чата.
- Если данные чата не устарели, сохраняет их в файл.
- Обновляет кеш чата.