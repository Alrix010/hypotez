# Модуль Cloudflare AI

## Обзор

Модуль `Cloudflare` обеспечивает взаимодействие с API `Cloudflare AI` для работы с различными моделями, доступными на платформе. 

## Подробнее

Данный модуль реализует класс `Cloudflare`, который наследует от `AsyncGeneratorProvider`, `ProviderModelMixin`, `AuthFileMixin`. 

`Cloudflare` предоставляет методы для:

- Получения списка доступных моделей через `get_models()`.
- Создание асинхронного генератора для получения ответов от модели.
- Обработки ответов в потоковом режиме (streaming).
- Сохранения данных аутентификации в файле.

## Классы

### `class Cloudflare`

**Описание**: Класс для взаимодействия с API `Cloudflare AI`. 

**Наследует**:

- `AsyncGeneratorProvider`: Предоставляет асинхронный генератор для получения ответов от модели.
- `ProviderModelMixin`: Добавляет функциональность работы с моделями (получение списка моделей).
- `AuthFileMixin`: Добавляет функциональность для сохранения и загрузки данных аутентификации.

**Атрибуты**:

- `label`: Метка провайдера.
- `url`: Базовый URL сервиса.
- `working`: Флаг, указывающий, работает ли сервис.
- `use_nodriver`: Флаг, указывающий, использовать ли `nodriver` для получения cookie.
- `api_endpoint`: URL API для отправки запросов.
- `models_url`: URL API для получения списка моделей.
- `supports_stream`: Флаг, указывающий, поддерживает ли сервис streaming.
- `supports_system_message`: Флаг, указывающий, поддерживает ли сервис системные сообщения.
- `supports_message_history`: Флаг, указывающий, поддерживает ли сервис историю сообщений.
- `default_model`: Имя модели по умолчанию.
- `model_aliases`: Словарь для сопоставления имен моделей с их полными именами в `Cloudflare AI`.
- `_args`: Словарь для хранения параметров HTTP-запросов (cookies, заголовки).

**Методы**:

- `get_models()`: Возвращает список доступных моделей.
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от модели.

#### Методы класса

##### `get_models()`

**Назначение**: Извлекает список доступных моделей из API Cloudflare AI. 

**Параметры**: 

- Нет параметров.

**Возвращает**:

- `str`: Список доступных моделей.

**Как работает функция**:

1. Проверяет, существует ли список моделей.
2. Если список моделей отсутствует, то он извлекается из API.
3. Использует `Session` или `StreamSession` для отправки запроса на `models_url`.
4. Парсит JSON-ответ и извлекает список моделей.
5. Возвращает список моделей.

##### `create_async_generator()`

**Назначение**: Создает асинхронный генератор для получения ответов от модели Cloudflare AI.

**Параметры**: 

- `model` (str): Имя модели.
- `messages` (Messages): Список сообщений.
- `proxy` (str): Прокси-сервер для запросов.
- `max_tokens`: Максимальное количество токенов в ответе.
- `cookies`: Cookies для аутентификации.
- `timeout`: Время ожидания ответа.
- `**kwargs`: Дополнительные аргументы для запроса.

**Возвращает**:

- `AsyncResult`:  Асинхронный результат.

**Как работает функция**:

1. Получает данные аутентификации из файла (если он существует).
2. Создает `StreamSession` для отправки запроса на `api_endpoint`.
3. Формирует данные запроса, используя список сообщений, модель и другие параметры.
4. Отправляет POST-запрос на `api_endpoint`.
5. Проверяет код ответа (200 - успех) и обрабатывает ошибки.
6. В случае успешного ответа:
    - Итерирует по строкам ответа (streaming).
    - Парсит JSON-ответы и выводит их.
    - Выводит данные об использовании модели (token_usage, time).
    - Выводит причину завершения ответа.
7. Сохраняет данные аутентификации в файл (если он существует).

**Примеры**:

```python
from hypotez.src.endpoints.gpt4free.g4f.Provider.Cloudflare import Cloudflare

# Получение списка моделей
models = Cloudflare.get_models()
print(models)

# Создание асинхронного генератора
async def main():
    messages = [
        {"role": "user", "content": "Привет, мир!"},
    ]
    async for response in Cloudflare.create_async_generator(model="@cf/meta/llama-3.3-70b-instruct-fp8-fast", messages=messages):
        print(response)

asyncio.run(main())
```