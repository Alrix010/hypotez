# Модуль `Airforce`

## Обзор

Модуль `Airforce` предоставляет асинхронный интерфейс для взаимодействия с API Airforce, предназначенным для генерации текста и изображений. Он включает в себя функции для получения списка доступных моделей, фильтрации контента, генерации изображений и текста, а также создания асинхронного генератора для потоковой передачи данных. Модуль поддерживает как текстовые, так и графические модели, предоставляет возможность использования прокси и включает механизмы обработки ошибок и фильтрации нежелательного контента.

## Подробней

Модуль `Airforce` является частью проекта `hypotez` и предназначен для обеспечения доступа к функциональности API Airforce. Он предоставляет методы для работы с различными моделями, включая модели генерации текста и изображения. Модуль включает в себя механизмы для обработки ошибок, фильтрации контента и поддержки потоковой передачи данных, что делает его удобным инструментом для интеграции с другими частями проекта.

## Классы

### `Airforce`

**Описание**: Класс `Airforce` предоставляет асинхронный интерфейс для взаимодействия с API Airforce. Он включает в себя методы для генерации текста и изображений, а также для получения списка доступных моделей.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): Базовый URL API Airforce.
- `api_endpoint_completions` (str): URL для генерации текста.
- `api_endpoint_imagine2` (str): URL для генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (List[str]): Список доступных текстовых моделей.
- `image_models` (List[str]): Список доступных моделей для генерации изображений.
- `hidden_models` (Set[str]): Список скрытых моделей.
- `additional_models_imagine` (List[str]): Список дополнительных моделей для генерации изображений.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Принцип работы**:

Класс `Airforce` предоставляет методы для взаимодействия с API Airforce, позволяя генерировать текст и изображения на основе различных моделей. Он использует асинхронные запросы для обеспечения неблокирующей работы и поддерживает потоковую передачу данных для эффективной обработки больших объемов информации. Класс также включает в себя механизмы для обработки ошибок и фильтрации нежелательного контента, обеспечивая надежную и безопасную работу с API.

## Методы класса

### `get_models`

```python
    @classmethod
    def get_models(cls) -> List[str]:
        """Получает доступные модели с обработкой ошибок

        Returns:
            List[str]: Список доступных моделей.
        """
```

**Назначение**: Получает список доступных моделей для генерации текста и изображений.

**Как работает функция**:
1. Проверяет, загружены ли уже модели изображений (`cls.image_models`). Если нет, пытается получить их с помощью GET-запроса к `f"{cls.url}/imagine2/models"`.
2. Обрабатывает ответ, проверяет на ошибки и расширяет список моделей изображений (`cls.image_models`) дополнительными моделями из `cls.additional_models_imagine`.
3. Аналогично проверяет, загружены ли текстовые модели (`cls.models`). Если нет, пытается получить их с помощью GET-запроса к `f"{cls.url}/models"`.
4. Обрабатывает ответ, извлекает идентификаторы моделей из JSON-данных и расширяет список моделей (`cls.models`) моделями изображений.
5. Исключает скрытые модели из списка (`cls.hidden_models`).
6. Если при получении моделей возникают ошибки, логирует их и использует псевдонимы моделей (`cls.model_aliases`).
7. Возвращает список доступных моделей.

**Примеры**:
```python
models = Airforce.get_models()
print(models)
# ['llama-3.1-70b-chat', 'flux', 'midjourney', 'dall-e-3']
```

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """Получает фактическое имя модели из псевдонима

        Args:
            model (str): Псевдоним модели.

        Returns:
            str: Фактическое имя модели.
        """
```

**Назначение**: Получает фактическое имя модели на основе предоставленного псевдонима.

**Параметры**:
- `model` (str): Псевдоним модели.

**Возвращает**:
- `str`: Фактическое имя модели. Если псевдоним не найден, возвращает сам псевдоним или модель по умолчанию (`cls.default_model`).

**Как работает функция**:
1. Пытается получить фактическое имя модели из словаря псевдонимов `cls.model_aliases` по ключу `model`.
2. Если псевдоним найден, возвращает соответствующее значение.
3. Если псевдоним не найден, возвращает предоставленное имя модели или модель по умолчанию (`cls.default_model`), если `model` равен `None`.

**Примеры**:
```python
model = Airforce.get_model("openchat-3.5")
print(model)
# 'openchat-3.5-0106'

model = Airforce.get_model("nonexistent-model")
print(model)
# 'nonexistent-model'
```

### `_filter_content`

```python
    @classmethod
    def _filter_content(cls, part_response: str) -> str:
        """
        Фильтрует нежелательный контент из частичного ответа.
        """
```

**Назначение**: Фильтрует нежелательный контент из частичного ответа.

**Параметры**:
- `part_response` (str): Частичный ответ, который необходимо отфильтровать.

**Возвращает**:
- `str`: Отфильтрованный частичный ответ.

**Как работает функция**:
1. Использует регулярные выражения для удаления сообщений о превышении лимита символов и ограничении скорости.

**Примеры**:
```python
filtered_content = Airforce._filter_content("One message exceeds the \\d+chars per message limit\\..+https:\\/\\/discord\\.com\\/invite\\/\\S+")
print(filtered_content)
# ''

filtered_content = Airforce._filter_content("Rate limit \\(\\d+\\/minute\\) exceeded\\. Join our discord for more: .+https:\\/\\/discord\\.com\\/invite\\/\\S+")
print(filtered_content)
# ''
```

### `_filter_response`

```python
    @classmethod
    def _filter_response(cls, response: str) -> str:
        """
        Фильтрует полный ответ для удаления системных ошибок и другого нежелательного текста.
        """
```

**Назначение**: Фильтрует полный ответ для удаления системных ошибок и другого нежелательного текста.

**Параметры**:
- `response` (str): Полный ответ, который необходимо отфильтровать.

**Возвращает**:
- `str`: Отфильтрованный полный ответ.

**Как работает функция**:
1. Проверяет, содержит ли ответ сообщение об ошибке "Model not found or too long input. Or any other error (xD)". Если да, вызывает исключение `ValueError`.
2. Использует регулярные выражения для удаления системных ошибок, токенов и других нежелательных элементов.
3. Вызывает метод `_filter_content` для фильтрации частичного ответа.

**Примеры**:
```python
filtered_response = Airforce._filter_response("[ERROR] '\\w{8}-\\w{4}-\\w{4}-\\w{4}-\\w{12}'")
print(filtered_response)
# ''

filtered_response = Airforce._filter_response("<|im_end|>")
print(filtered_response)
# ''
```

### `generate_image`

```python
    @classmethod
    async def generate_image(
        cls,
        model: str,
        prompt: str,
        size: str,
        seed: int,
        proxy: str = None
    ) -> AsyncResult:
        """
        Генерирует изображение.
        """
```

**Назначение**: Генерирует изображение на основе предоставленных параметров.

**Параметры**:
- `model` (str): Модель для генерации изображения.
- `prompt` (str): Текст запроса для генерации изображения.
- `size` (str): Размер изображения.
- `seed` (int): Зерно для генерации изображения.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий объекты `ImageResponse`.

**Как работает функция**:
1. Формирует заголовки запроса.
2. Формирует параметры запроса.
3. Отправляет асинхронный GET-запрос к API Airforce для генерации изображения.
4. Если запрос успешен, возвращает URL изображения в виде объекта `ImageResponse`.
5. Если запрос не успешен, вызывает исключение `RuntimeError`.

**Примеры**:
```python
async for result in Airforce.generate_image(model="flux", prompt="A cat", size="1:1", seed=123):
    print(result)
# ImageResponse(images='https://example.com/image.png', alt='A cat')
```

### `generate_text`

```python
    @classmethod
    async def generate_text(
        cls,
        model: str,
        messages: Messages,
        max_tokens: int,
        temperature: float,
        top_p: float,
        stream: bool,
        proxy: str = None
    ) -> AsyncResult:
        """
        Генерирует текст, буферизует ответ, фильтрует его и возвращает окончательный результат.
        """
```

**Назначение**: Генерирует текст на основе предоставленных параметров.

**Параметры**:
- `model` (str): Модель для генерации текста.
- `messages` (Messages): Список сообщений для генерации текста.
- `max_tokens` (int): Максимальное количество токенов в ответе.
- `temperature` (float): Температура для генерации текста.
- `top_p` (float): Top-p для генерации текста.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст.

**Внутренние функции**:
- `split_message(message: str, max_length: int = 1000) -> List[str]`:
  - **Назначение**: Разделяет сообщение на части длиной не более `max_length`.
  - **Параметры**:
    - `message` (str): Сообщение для разделения.
    - `max_length` (int, optional): Максимальная длина части сообщения. По умолчанию `1000`.
  - **Возвращает**:
    - `List[str]`: Список частей сообщения.
  - **Как работает функция**:
    1. Инициализирует пустой список `chunks` для хранения частей сообщения.
    2. В цикле `while` проверяет, превышает ли длина сообщения `max_length`.
    3. Если длина сообщения больше `max_length`, ищет последнюю позицию пробела в пределах `max_length`.
    4. Если пробел не найден, устанавливает `split_point` равным `max_length`.
    5. Добавляет часть сообщения до `split_point` в список `chunks`.
    6. Обрезает сообщение до `split_point` и удаляет пробелы в начале и конце.
    7. Если длина сообщения не превышает `max_length`, добавляет его в список `chunks`.
    8. Возвращает список `chunks`.

**Как работает функция**:
1. Формирует заголовки запроса.
2. Разделяет сообщения на части, если они превышают максимальную длину.
3. Формирует данные запроса.
4. Отправляет асинхронный POST-запрос к API Airforce для генерации текста.
5. Если используется потоковая передача данных, обрабатывает ответ по частям и фильтрует его.
6. Если потоковая передача данных не используется, обрабатывает полный ответ и фильтрует его.

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello"}]
async for result in Airforce.generate_text(model="llama-3.1-70b-chat", messages=messages, max_tokens=100, temperature=0.7, top_p=0.9, stream=True):
    print(result)
# Hello
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        max_tokens: int = 512,
        temperature: float = 1,
        top_p: float = 1,
        stream: bool = True,
        size: str = "1:1",
        seed: int = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор.
        """
```

**Назначение**: Создает асинхронный генератор для генерации текста или изображений.

**Параметры**:
- `model` (str): Модель для генерации.
- `messages` (Messages): Список сообщений для генерации текста.
- `prompt` (str, optional): Текст запроса для генерации изображения. По умолчанию `None`.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `512`.
- `temperature` (float, optional): Температура для генерации текста. По умолчанию `1`.
- `top_p` (float, optional): Top-p для генерации текста. По умолчанию `1`.
- `stream` (bool, optional): Указывает, использовать ли потоковую передачу данных. По умолчанию `True`.
- `size` (str, optional): Размер изображения. По умолчанию `"1:1"`.
- `seed` (int, optional): Зерно для генерации изображения. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст или объекты `ImageResponse`.

**Как работает функция**:
1. Получает фактическое имя модели с помощью метода `get_model`.
2. Если модель является моделью изображения, генерирует изображение с помощью метода `generate_image`.
3. Если модель является моделью текста, генерирует текст с помощью метода `generate_text`.

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello"}]
async for result in Airforce.create_async_generator(model="llama-3.1-70b-chat", messages=messages):
    print(result)
# Hello

async for result in Airforce.create_async_generator(model="flux", messages=messages, prompt="A cat"):
    print(result)
# ImageResponse(images='https://example.com/image.png', alt='A cat')