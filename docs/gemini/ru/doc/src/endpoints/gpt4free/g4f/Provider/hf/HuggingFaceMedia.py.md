# Модуль HuggingFaceMedia

## Обзор

Модуль `HuggingFaceMedia` предназначен для работы с моделями Hugging Face, позволяющими генерировать изображения и видео из текста. Он предоставляет асинхронный интерфейс для взаимодействия с API Hugging Face, поддерживает выбор различных провайдеров для генерации медиа-контента и обеспечивает гибкую настройку параметров генерации, таких как соотношение сторон, разрешение и другие.

## Подробнее

Модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, требующими функциональности генерации изображений и видео на основе текстовых запросов.
В модуле реализована поддержка различных задач, таких как `text-to-image` и `text-to-video`, и он позволяет выбирать конкретные модели и провайдеров для выполнения этих задач.

## Классы

### `HuggingFaceMedia`

**Описание**: Класс `HuggingFaceMedia` предоставляет функциональность для генерации изображений и видео с использованием моделей Hugging Face. Он наследует от `AsyncGeneratorProvider` и `ProviderModelMixin`, что обеспечивает поддержку асинхронной генерации и управление моделями.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера, `"HuggingFace (Image/Video Generation)"`.
- `parent` (str): Родительский провайдер, `"HuggingFace"`.
- `url` (str): URL Hugging Face, `"https://huggingface.co"`.
- `working` (bool): Флаг, указывающий, работает ли провайдер, `True`.
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация, `True`.
- `tasks` (list[str]): Список поддерживаемых задач, `["text-to-image", "text-to-video"]`.
- `provider_mapping` (dict[str, dict]): Словарь, отображающий модели на провайдеров.
- `task_mapping` (dict[str, str]): Словарь, отображающий модели на задачи.
- `models` (list[str]): Список доступных моделей.
- `image_models` (list[str]): Список моделей для генерации изображений.
- `video_models` (list[str]): Список моделей для генерации видео.

**Принцип работы**:

Класс `HuggingFaceMedia` предназначен для асинхронной генерации изображений и видео на основе моделей, размещенных на платформе Hugging Face. Он использует API Hugging Face для взаимодействия с моделями и поддерживает различные провайдеры для выполнения задач генерации.
Класс предоставляет методы для получения списка доступных моделей, создания асинхронного генератора для генерации медиа-контента и управления параметрами генерации.

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `get_mapping()`: Получает отображение моделей на провайдеров.
- `create_async_generator()`: Создает асинхронный генератор для генерации медиа-контента.

## Методы класса

### `get_models`

```python
@classmethod
def get_models(cls, **kwargs) -> list[str]:
    """Возвращает список доступных моделей для генерации изображений и видео на Hugging Face.

    Args:
        **kwargs: Дополнительные аргументы (не используются).

    Returns:
        list[str]: Список доступных моделей.

    Raises:
        Exception: Если не удается получить список моделей с Hugging Face.
    """
    ...
```

**Как работает функция**:

Функция `get_models` получает список доступных моделей для генерации изображений и видео с платформы Hugging Face. Она отправляет HTTP-запрос к API Hugging Face, чтобы получить список моделей и информацию о провайдерах, поддерживающих эти модели.
Затем она формирует список моделей и сохраняет его в атрибуте `cls.models`. Функция также создает списки `cls.image_models` и `cls.video_models`, содержащие модели для генерации изображений и видео соответственно.

### `get_mapping`

```python
@classmethod
async def get_mapping(cls, model: str, api_key: str = None):
    """Получает отображение провайдеров для указанной модели.

    Args:
        model (str): Название модели.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.

    Returns:
        dict: Словарь, отображающий провайдеров для указанной модели.
    """
    ...
```

**Как работает функция**:

Функция `get_mapping` получает отображение провайдеров для указанной модели Hugging Face. Если отображение уже существует в `cls.provider_mapping`, оно возвращается из кэша. В противном случае функция отправляет HTTP-запрос к API Hugging Face, чтобы получить информацию о провайдерах, поддерживающих указанную модель.
Затем она формирует словарь, отображающий провайдеров для модели, и сохраняет его в `cls.provider_mapping`.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    api_key: str = None,
    extra_data: dict = {},
    prompt: str = None,
    proxy: str = None,
    timeout: int = 0,
    # Video & Image Generation
    n: int = 1,
    aspect_ratio: str = None,
    # Only for Image Generation
    height: int = None,
    width: int = None,
    # Video Generation
    resolution: str = "480p",
    **kwargs
):
    """Создает асинхронный генератор для генерации медиа-контента (изображений или видео).

    Args:
        model (str): Название модели для генерации.
        messages (Messages): Список сообщений для формирования запроса.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        extra_data (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
        prompt (str, optional): Текст запроса. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `0`.
        n (int, optional): Количество генерируемых медиа-файлов. По умолчанию `1`.
        aspect_ratio (str, optional): Соотношение сторон изображения/видео. По умолчанию `None`.
        height (int, optional): Высота изображения (только для изображений). По умолчанию `None`.
        width (int, optional): Ширина изображения (только для изображений). По умолчанию `None`.
        resolution (str, optional): Разрешение видео (только для видео). По умолчанию `"480p"`.
        **kwargs: Дополнительные аргументы.

    Yields:
        ProviderInfo: Информация о провайдере.
        ImageResponse: Ответ с изображением.
        VideoResponse: Ответ с видео.
        Reasoning: Промежуточный статус генерации.

    Raises:
        ModelNotSupportedError: Если указанная модель не поддерживается.
        Exception: Если возникает ошибка при выполнении запроса к API.
    """
    ...
```

**Как работает функция**:

Функция `create_async_generator` создает асинхронный генератор для генерации медиа-контента (изображений или видео) на основе предоставленных параметров. Она выполняет следующие шаги:

1.  **Выбор провайдера**: Определяет провайдера для генерации медиа-контента на основе указанной модели и доступных провайдеров. Если провайдер указан явно в названии модели (например, `model:provider`), он используется. В противном случае выбирается первый доступный провайдер для модели.

2.  **Формирование запроса**: Формирует HTTP-запрос к API Hugging Face для генерации медиа-контента. Запрос включает в себя параметры, такие как текст запроса, дополнительные данные, соотношение сторон, разрешение и другие.

3.  **Выполнение запроса**: Отправляет HTTP-запрос к API Hugging Face и получает ответ. Если запрос выполнен успешно, функция обрабатывает ответ и возвращает объект `ImageResponse` или `VideoResponse`, содержащий сгенерированный медиа-контент.

4.  **Асинхронная генерация**: Функция использует асинхронный генератор для генерации нескольких медиа-файлов параллельно. Она создает несколько задач asyncio для генерации медиа-контента и ожидает их завершения.

**Внутренние функции**:

- `generate(extra_data: dict, aspect_ratio: str = None)`: Асинхронная функция, выполняющая генерацию медиа-контента для одного провайдера. Она отправляет HTTP-запрос к API Hugging Face и обрабатывает ответ, возвращая объект `ImageResponse` или `VideoResponse`.

## Примеры

```python
# Пример вызова create_async_generator для генерации изображения
async for item in HuggingFaceMedia.create_async_generator(
    model="stabilityai/stable-diffusion-2",
    messages=[{"role": "user", "content": "A beautiful landscape"}],
    n=1,
    aspect_ratio="16:9",
    height=512,
    width=768
):
    print(item)

# Пример вызова create_async_generator для генерации видео
async for item in HuggingFaceMedia.create_async_generator(
    model="damo-vilab/text-to-video-ms-1.7b",
    messages=[{"role": "user", "content": "A cat playing with a ball"}],
    n=1,
    aspect_ratio="16:9",
    resolution="720p"
):
    print(item)