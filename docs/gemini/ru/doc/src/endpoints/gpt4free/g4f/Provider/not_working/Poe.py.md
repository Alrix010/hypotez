# Модуль для работы с Poe.com
===========================

Модуль предоставляет класс `Poe` для взаимодействия с моделями Poe.com.
Поддерживает стриминг ответов.

## Обзор

Модуль `Poe` предназначен для обеспечения взаимодействия с различными моделями, предоставляемыми через платформу Poe.com. Он включает в себя поддержку стриминга ответов, что позволяет получать результаты по частям, улучшая отзывчивость интерфейса. Модуль требует аутентификации и использует `selenium` для автоматизации действий в браузере.

## Подробней

Данный модуль является частью проекта `hypotez` и предназначен для интеграции с платформой Poe.com, предоставляющей доступ к различным моделям искусственного интеллекта, таким как GPT-3.5 Turbo, GPT-4 и другие. Он использует веб-драйвер для автоматизации взаимодействия с веб-интерфейсом Poe.com, что позволяет отправлять запросы и получать ответы программно.

## Классы

### `Poe`

**Описание**: Класс для взаимодействия с платформами Poe.

**Наследует**:
- `AbstractProvider`: Абстрактный базовый класс для провайдеров.

**Атрибуты**:
- `url` (str): URL платформы Poe.com.
- `working` (bool): Указывает, работает ли платформа (по умолчанию `False`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с платформой (по умолчанию `True`).
- `supports_stream` (bool): Указывает, поддерживает ли платформа потоковую передачу данных (по умолчанию `True`).
- `models` (dict): Список поддерживаемых моделей.

**Методы**:
- `create_completion()`: Создает запрос к платформе и возвращает результат.

## Методы класса

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    webdriver: WebDriver = None,
    user_data_dir: str = None,
    headless: bool = True,
    **kwargs
) -> CreateResult:
    """
    Создает запрос к платформе Poe и возвращает результат.

    Args:
        cls (Poe): Класс Poe.
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        webdriver (WebDriver, optional): Инстанс веб-драйвера Selenium. По умолчанию `None`.
        user_data_dir (str, optional): Путь к каталогу пользовательских данных браузера. По умолчанию `None`.
        headless (bool, optional): Флаг, указывающий, запускать ли браузер в headless-режиме. По умолчанию `True`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат выполнения запроса.

    Raises:
        ValueError: Если указанная модель не поддерживается.
        RuntimeError: Если не удалось найти текстовое поле для ввода запроса.
    """
    ...
```

**Как работает функция**:

1.  **Проверка модели**: Функция проверяет, указана ли модель и поддерживается ли она. Если модель не указана, используется модель `gpt-3.5-turbo` по умолчанию. Если указанная модель не поддерживается, выбрасывается исключение `ValueError`.
2.  **Форматирование запроса**: Функция форматирует список сообщений в строку запроса, используя функцию `format_prompt`.
3.  **Создание сессии веб-драйвера**: Функция создает сессию веб-драйвера, используя класс `WebDriverSession`. Этот класс управляет запуском и остановкой веб-драйвера, а также обеспечивает использование прокси-сервера и пользовательского каталога данных, если они указаны.
4.  **Автоматизация взаимодействия с веб-интерфейсом**:
    *   Функция внедряет JavaScript-код в веб-страницу для перехвата сообщений, отправляемых и получаемых через WebSocket. Этот код сохраняет последнее полученное сообщение и флаг завершения сообщения в глобальных переменных `window._message`, `window._last_message` и `window._message_finished` соответственно.
    *   Функция открывает страницу Poe.com для указанной модели.
    *   Функция ожидает появления текстового поля для ввода запроса, используя `WebDriverWait` и `EC.visibility_of_element_located`. Если текстовое поле не найдено в течение заданного времени, функция пытается перезапустить браузер и повторить попытку. Если перезапуск не удался, выбрасывается исключение `RuntimeError`.
    *   Функция отправляет запрос в текстовое поле, используя функцию `element_send_text`.
    *   Функция нажимает кнопку отправки сообщения.
5.  **Получение ответа**:
    *   Функция выполняет JavaScript-код для получения новых фрагментов ответа из глобальной переменной `window._message`. Этот код возвращает фрагмент ответа, если он изменился с момента последнего вызова, `null`, если сообщение завершено, и пустую строку в противном случае.
    *   Функция использует цикл `while True` для получения фрагментов ответа до тех пор, пока не будет получен `null`. Каждый полученный фрагмент ответа передается через `yield`, что позволяет использовать функцию как генератор.

**Примеры**:

```python
# Пример использования функции create_completion с потоковой передачей данных
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
proxy = "http://your_proxy:8080"
webdriver = None
user_data_dir = "/path/to/user/data/dir"
headless = True

result = Poe.create_completion(model, messages, stream, proxy, webdriver, user_data_dir, headless)

for chunk in result:
    print(chunk, end="")

# Пример использования функции create_completion без потоковой передачи данных
model = "gpt-4"
messages = [{"role": "user", "content": "What is the capital of France?"}]
stream = False
proxy = None
webdriver = None
user_data_dir = None
headless = True

result = Poe.create_completion(model, messages, stream, proxy, webdriver, user_data_dir, headless)

print(result)