# Документация для модуля Poe

## Обзор

Модуль `Poe` предназначен для взаимодействия с сервисом Poe для генерации текста с использованием различных моделей, таких как Llama-2, CodeLlama, GPT и Google-PaLM. Модуль поддерживает потоковую передачу ответов и требует аутентификации.

## Подробней

Модуль использует `selenium` для автоматизации взаимодействия с веб-интерфейсом Poe. Он создает сессию веб-драйвера, вводит запрос пользователя в текстовое поле и ожидает ответа модели. Полученные ответы передаются пользователю в режиме потока.

## Классы

### `Poe(AbstractProvider)`

**Описание**: Класс `Poe` является провайдером для работы с моделями на платформе Poe.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес сервиса Poe ("https://poe.com").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (в данном случае `False`).
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации для использования провайдера (в данном случае `True`).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи ответов (в данном случае `True`).
- `models` (keys): Список поддерживаемых моделей, полученный из словаря `models`.

**Методы**:
- `create_completion()`: Метод для создания запроса к модели и получения ответа.

## Методы класса

### `create_completion(model: str, messages: Messages, stream: bool, proxy: str = None, webdriver: WebDriver = None, user_data_dir: str = None, headless: bool = True, **kwargs) -> CreateResult`

**Назначение**: Отправляет запрос к выбранной модели на платформе Poe и возвращает результат генерации.

**Параметры**:
- `model` (str): Идентификатор модели для использования (например, "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений для передачи в модель.
- `stream` (bool): Флаг, указывающий на необходимость потоковой передачи ответа.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `webdriver` (WebDriver, optional): Инстанс веб-драйвера для управления браузером. По умолчанию `None`.
- `user_data_dir` (str, optional): Путь к каталогу пользовательских данных браузера. По умолчанию `None`.
- `headless` (bool, optional): Флаг, указывающий на необходимость запуска браузера в "headless" режиме. По умолчанию `True`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Результат создания запроса, который может быть итератором для потоковой передачи или полным ответом.

**Вызывает исключения**:
- `ValueError`: Если указанная модель не поддерживается.
- `RuntimeError`: Если не найдено текстовое поле для ввода запроса (возможно, требуется вход в систему).

**Как работает функция**:
1. **Выбор модели**: Если модель не указана, используется "gpt-3.5-turbo". Если указанная модель не поддерживается, вызывается исключение `ValueError`.
2. **Форматирование запроса**: Форматирует список сообщений в строку запроса.
3. **Создание сессии WebDriver**: Создает или восстанавливает сессию веб-драйвера с использованием `WebDriverSession`.
4. **Внедрение скрипта**: Внедряет JavaScript-скрипт в браузер для перехвата сообщений, отправляемых с платформы Poe. Этот скрипт сохраняет сообщения в глобальные переменные `window._message` и `window._message_finished`.
5. **Отправка запроса**:
   - Открывает страницу с выбранной моделью на Poe.
   - Ожидает появления текстового поля для ввода запроса. Если поле не найдено, пытается повторно открыть браузер для входа в систему или вызывает исключение `RuntimeError`.
   - Вводит запрос в текстовое поле и нажимает кнопку отправки.
6. **Получение ответа**:
   - В цикле выполняет JavaScript-скрипт для получения новых фрагментов ответа из глобальной переменной `window._message`.
   - Если получен фрагмент ответа, возвращает его через `yield`.
   - Если ответ завершен (`window._message_finished` равно `True`), завершает цикл.
   - Если нет новых фрагментов ответа, ожидает 0.1 секунды.

**Внутренние функции**:
- Отсутствуют.

**Примеры**:

```python
# Пример использования (требуется настроенный веб-драйвер и аутентификация)
# from selenium import webdriver
# from src.endpoints.gpt4free.g4f.Provider.helper import Messages

# messages: Messages = [{"role": "user", "content": "Напиши Hello World на Python"}]

# # Инициализация драйвера (пример для Chrome)
# options = webdriver.ChromeOptions()
# options.add_argument('--disable-gpu')
# options.add_argument('--no-sandbox')
# driver = webdriver.Chrome(options=options)

# for chunk in Poe.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True, webdriver=driver):
#     print(chunk, end="")