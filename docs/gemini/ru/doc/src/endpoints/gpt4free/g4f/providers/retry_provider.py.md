# Модуль RetryProvider

## Обзор

Модуль `retry_provider.py` предоставляет механизм повторных попыток (retries) для получения результатов от разных провайдеров, используемых для генерации текста. 

## Подробнее

Модуль `retry_provider.py` реализует механизм повторных попыток для получения результатов от разных провайдеров. Этот подход позволяет повысить надежность и устойчивость к ошибкам при использовании различных API для генерации текста. 

В модуле определены два класса: `IterListProvider` и `RetryProvider`. 

## Классы

### `IterListProvider`

**Описание**: Класс `IterListProvider` - базовый класс, который обеспечивает итерацию по списку провайдеров. 

**Наследует**: `BaseRetryProvider`

**Атрибуты**:

- `providers` (List[Type[BaseProvider]]): Список провайдеров, используемых для генерации текста.
- `shuffle` (bool): Флаг, определяющий, нужно ли перемешивать порядок провайдеров.
- `working` (bool): Флаг, указывающий на доступность провайдеров для использования.
- `last_provider` (Type[BaseProvider]): Последний использованный провайдер.

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = False, ignore_stream: bool = False, ignored: list[str] = [], **kwargs) -> CreateResult`
  -  **Назначение**: Создает завершение (completion) с помощью доступных провайдеров, с возможностью потоковой передачи (streaming) результата.
  - **Параметры**:
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, используемых для генерации текста.
    - `stream` (bool, optional): Флаг, указывающий, нужно ли передавать результат потоком. По умолчанию `False`.
    - `ignore_stream` (bool, optional): Флаг, указывающий, нужно ли игнорировать потоковую передачу результата. По умолчанию `False`.
    - `ignored` (list[str], optional): Список имен провайдеров, которые нужно игнорировать. По умолчанию `[]`.
  - **Возвращает**: `CreateResult`: Генератор токенов или результатов завершения.
  - **Вызывает исключения**: `Exception`: Любые исключения, возникшие во время процесса завершения.
  - **Как работает функция**:
    -  Функция `create_completion` проходит по всем доступным провайдерам, игнорируя те, которые находятся в списке `ignored`.
    -  Для каждого провайдера выполняет создание завершения с помощью функции `get_create_function`.
    -  Если результат - строка или `MediaResponse`, то `started` устанавливается в `True`.
    -  Если `started` установлено в `True`, то функция возвращает результат.
    -  В случае возникновения исключения, функция добавляет его в словарь `exceptions` и продолжает итерацию по остальным провайдерам.
    -  Если ни один провайдер не смог вернуть результат, то функция поднимает исключение `RetryNoProviderError`. 
- `create_async_generator(model: str, messages: Messages, stream: bool = True, ignore_stream: bool = False, ignored: list[str] = [], **kwargs) -> AsyncResult`
  -  **Назначение**: Создает асинхронный генератор для завершения (completion) с помощью доступных провайдеров, с возможностью потоковой передачи (streaming) результата.
  - **Параметры**:
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, используемых для генерации текста.
    - `stream` (bool, optional): Флаг, указывающий, нужно ли передавать результат потоком. По умолчанию `True`.
    - `ignore_stream` (bool, optional): Флаг, указывающий, нужно ли игнорировать потоковую передачу результата. По умолчанию `False`.
    - `ignored` (list[str], optional): Список имен провайдеров, которые нужно игнорировать. По умолчанию `[]`.
  - **Возвращает**: `AsyncResult`: Генератор токенов или результатов завершения.
  - **Вызывает исключения**: `Exception`: Любые исключения, возникшие во время процесса завершения.
  - **Как работает функция**:
    -  Функция `create_async_generator` проходит по всем доступным провайдерам, игнорируя те, которые находятся в списке `ignored`.
    -  Для каждого провайдера выполняет создание асинхронного генератора с помощью функции `get_async_create_function`.
    -  Если результат - строка или `MediaResponse`, то `started` устанавливается в `True`.
    -  Если `started` установлено в `True`, то функция возвращает результат.
    -  В случае возникновения исключения, функция добавляет его в словарь `exceptions` и продолжает итерацию по остальным провайдерам.
    -  Если ни один провайдер не смог вернуть результат, то функция поднимает исключение `RetryNoProviderError`. 
- `get_create_function(self) -> callable`
  -  **Назначение**: Возвращает функцию `create_completion`.
  - **Параметры**:  нет
  - **Возвращает**:  `callable`: Функция `create_completion`.
  - **Вызывает исключения**:  нет
  - **Как работает функция**:
    -  Возвращает функцию `create_completion`.
- `get_async_create_function(self) -> callable`
  -  **Назначение**: Возвращает функцию `create_async_generator`.
  - **Параметры**:  нет
  - **Возвращает**:  `callable`: Функция `create_async_generator`.
  - **Вызывает исключения**:  нет
  - **Как работает функция**:
    -  Возвращает функцию `create_async_generator`.
- `get_providers(self, stream: bool, ignored: list[str]) -> list[ProviderType]`
  -  **Назначение**: Возвращает список провайдеров, подходящих для текущих условий.
  - **Параметры**:
    - `stream` (bool): Флаг, указывающий, нужно ли передавать результат потоком. 
    - `ignored` (list[str]): Список имен провайдеров, которые нужно игнорировать. 
  - **Возвращает**:  `list[ProviderType]`: Список провайдеров, подходящих для текущих условий.
  - **Вызывает исключения**:  нет
  - **Как работает функция**:
    -  Функция `get_providers` фильтрует список провайдеров, оставляя только те, которые поддерживают потоковую передачу (если `stream` установлен в `True`) и не находятся в списке `ignored`.
    -  Если `shuffle` установлено в `True`, то функция перемешивает порядок провайдеров.
    -  Возвращает отфильтрованный список провайдеров.

### `RetryProvider`

**Описание**: Класс `RetryProvider` наследует от `IterListProvider` и реализует механизм повторных попыток (retries) для каждого провайдера.

**Наследует**: `IterListProvider`

**Атрибуты**:

- `single_provider_retry` (bool): Флаг, указывающий, нужно ли повторять попытки для одного и того же провайдера.
- `max_retries` (int): Максимальное количество повторных попыток для одного провайдера.

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = False, **kwargs) -> CreateResult`
  -  **Назначение**: Создает завершение (completion) с помощью доступных провайдеров, с возможностью потоковой передачи (streaming) результата, с механизмом повторных попыток. 
  - **Параметры**:
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, используемых для генерации текста.
    - `stream` (bool, optional): Флаг, указывающий, нужно ли передавать результат потоком. По умолчанию `False`.
  - **Возвращает**: `CreateResult`: Генератор токенов или результатов завершения.
  - **Вызывает исключения**: `Exception`: Любые исключения, возникшие во время процесса завершения.
  - **Как работает функция**:
    -  Если `single_provider_retry` установлено в `True`, то функция выполняет `max_retries` попыток для первого провайдера в списке.
    -  Если `single_provider_retry` установлено в `False`, то функция перебирает всех провайдеров, как в `IterListProvider`.
    -  В случае возникновения ошибки, функция записывает информацию об ошибке и продолжает попытки, если `single_provider_retry` установлено в `True`, или переходит к следующему провайдеру.
    -  Если ни один провайдер не смог вернуть результат, то функция поднимает исключение `RetryNoProviderError`.
- `create_async_generator(model: str, messages: Messages, stream: bool = True, **kwargs) -> AsyncResult`
  -  **Назначение**: Создает асинхронный генератор для завершения (completion) с помощью доступных провайдеров, с возможностью потоковой передачи (streaming) результата, с механизмом повторных попыток. 
  - **Параметры**:
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, используемых для генерации текста.
    - `stream` (bool, optional): Флаг, указывающий, нужно ли передавать результат потоком. По умолчанию `True`.
  - **Возвращает**: `AsyncResult`: Генератор токенов или результатов завершения.
  - **Вызывает исключения**: `Exception`: Любые исключения, возникшие во время процесса завершения.
  - **Как работает функция**:
    -  Если `single_provider_retry` установлено в `True`, то функция выполняет `max_retries` попыток для первого провайдера в списке.
    -  Если `single_provider_retry` установлено в `False`, то функция перебирает всех провайдеров, как в `IterListProvider`.
    -  В случае возникновения ошибки, функция записывает информацию об ошибке и продолжает попытки, если `single_provider_retry` установлено в `True`, или переходит к следующему провайдеру.
    -  Если ни один провайдер не смог вернуть результат, то функция поднимает исключение `RetryNoProviderError`. 

## Функции

### `raise_exceptions(exceptions: dict) -> None`

**Назначение**: Поднимает объединенное исключение, если во время повторных попыток возникли какие-либо ошибки.

**Параметры**:

- `exceptions` (dict): Словарь, содержащий информацию о возникших исключениях.

**Возвращает**:  нет

**Вызывает исключения**:

- `RetryProviderError`: Если у любого провайдера возникло исключение.
- `RetryNoProviderError`: Если ни один провайдер не был найден.

**Как работает функция**:

-  Функция `raise_exceptions` проверяет словарь `exceptions`. Если словарь не пустой, то функция поднимает исключение `RetryProviderError`, содержащее информацию о возникших исключениях.
-  Если словарь `exceptions` пустой, то функция поднимает исключение `RetryNoProviderError`, указывающее на отсутствие доступных провайдеров.