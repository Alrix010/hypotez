# Модуль интеграции g4f с pydantic_ai

## Обзор

Модуль предоставляет интеграцию между библиотекой `g4f` (для работы с различными AI-провайдерами) и `pydantic_ai` (для удобного определения и использования AI-моделей). Он включает в себя класс `AIModel`, который расширяет возможности `OpenAIModel` из `pydantic_ai`, позволяя использовать модели, предоставляемые через API `g4f`. Также, модуль содержит функции для "патчинга" `pydantic_ai`, чтобы использовать `AIModel` и другие функции для работы с моделями `g4f`.

## Подробней

Этот модуль позволяет легко интегрировать различные AI-модели, доступные через библиотеку `g4f`, в проекты, использующие `pydantic_ai`. Он предоставляет возможность указывать провайдера модели и использовать асинхронный клиент для взаимодействия с API. Модуль также содержит функции для переопределения стандартного поведения `pydantic_ai` для использования моделей `g4f`.

## Классы

### `AIModel`

**Описание**: Класс `AIModel` представляет собой модель, которая использует API `g4f`.

**Наследует**:

- `OpenAIModel`: Класс, представляющий модель OpenAI из библиотеки `pydantic_ai`.

**Атрибуты**:

- `client` (AsyncClient): Асинхронный клиент для взаимодействия с API `g4f`.
- `system_prompt_role` (OpenAISystemPromptRole | None): Роль, используемая для системного промпта.
- `_model_name` (str): Название модели.
- `_provider` (str): Провайдер модели.
- `_system` (Optional[str]): Имя провайдера модели, по умолчанию 'openai'.

**Принцип работы**:

Класс `AIModel` инициализируется с названием модели и провайдером (необязательно). Он использует асинхронный клиент для взаимодействия с API `g4f` и предоставляет метод `name()` для получения полного имени модели, включая провайдера.

**Методы**:

- `__init__`: Инициализирует экземпляр класса `AIModel`.
- `name`: Возвращает имя модели.

## Методы класса

### `__init__`

```python
def __init__(
    self,
    model_name: str,
    provider: str | None = None,
    *,
    system_prompt_role: OpenAISystemPromptRole | None = None,
    system: str | None = 'openai',
    **kwargs
) -> None:
    """
    Инициализирует AI модель.

    Args:
        model_name (str): Имя AI модели для использования. Список доступных имен моделей можно найти
            [здесь](https://github.com/openai/openai-python/blob/v1.54.3/src/openai/types/chat_model.py#L7)
            (К сожалению, несмотря на просьбу, OpenAI не предоставляет `.inv` файлы для своего API).
        provider (str | None): Провайдер модели.
        system_prompt_role (OpenAISystemPromptRole | None): Роль, используемая для системного промпта. Если не указана, по умолчанию используется `'system'`.
            В будущем это может быть определено на основе имени модели.
        system (str | None): Используемый провайдер модели, по умолчанию `'openai'`. Это необходимо для целей наблюдения, вы должны
            настроить `base_url` и `api_key` для использования другого провайдера.
        **kwargs: Дополнительные аргументы, передаваемые в `AsyncClient`.

    Raises:
        Exception: Если возникает ошибка при инициализации модели.

    Example:
        >>> model = AIModel(model_name='gpt-3.5-turbo', provider='openai')
    """
```

**Назначение**: Инициализирует экземпляр класса `AIModel` с заданными параметрами.

**Параметры**:

- `model_name` (str): Имя AI модели для использования.
- `provider` (str | None): Провайдер модели (например, "openai").
- `system_prompt_role` (OpenAISystemPromptRole | None): Роль для системного промпта.
- `system` (str | None): Используемый провайдер модели, по умолчанию 'openai'.
- `**kwargs`: Дополнительные аргументы, передаваемые в `AsyncClient`.

**Как работает функция**:

1.  Сохраняет имя модели и провайдера в атрибутах экземпляра класса.
2.  Инициализирует асинхронный клиент (`AsyncClient`) с указанным провайдером и дополнительными аргументами.
3.  Устанавливает роль для системного промпта.

### `name`

```python
def name(self) -> str:
    """
    Возвращает имя модели.

    Returns:
        str: Имя модели в формате "g4f:{провайдер}:{имя_модели}" или "g4f:{имя_модели}", если провайдер не указан.

    Example:
        >>> model = AIModel(model_name='gpt-3.5-turbo', provider='openai')
        >>> model.name()
        'g4f:openai:gpt-3.5-turbo'
    """
```

**Назначение**: Возвращает имя модели в формате, включающем провайдера (если он указан).

**Возвращает**:

- `str`: Имя модели.

**Как работает функция**:

1.  Проверяет, указан ли провайдер модели.
2.  Если провайдер указан, возвращает имя в формате "g4f:{провайдер}:{имя\_модели}".
3.  Если провайдер не указан, возвращает имя в формате "g4f:{имя\_модели}".

## Функции

### `new_infer_model`

```python
def new_infer_model(model: Model | KnownModelName, api_key: str = None) -> Model:
    """
    Создает экземпляр AIModel на основе имени модели.

    Args:
        model (Model | KnownModelName): Имя модели или экземпляр класса Model.
        api_key (str, optional): API ключ. По умолчанию `None`.

    Returns:
        Model: Экземпляр класса AIModel или Model.

    Example:
        >>> model = new_infer_model(model='g4f:gpt-3.5-turbo')
    """
```

**Назначение**: Создает экземпляр `AIModel` на основе имени модели.

**Параметры**:

- `model` (Model | KnownModelName): Имя модели или экземпляр класса `Model`.
- `api_key` (str, optional): API ключ. По умолчанию `None`.

**Возвращает**:

- `Model`: Экземпляр класса `AIModel` или `Model`.

**Как работает функция**:

1.  Проверяет, является ли `model` экземпляром класса `Model`. Если да, возвращает его.
2.  Проверяет, начинается ли имя модели с "g4f:". Если нет, вызывает функцию `infer_model` из `pydantic_ai`.
3.  Если имя модели начинается с "g4f:", извлекает имя модели и провайдера (если он указан) из имени.
4.  Создает и возвращает экземпляр класса `AIModel` с указанными параметрами.

### `patch_infer_model`

```python
def patch_infer_model(api_key: str | None = None) -> None:
    """
    Заменяет функцию infer_model в модуле pydantic_ai.models на new_infer_model.

    Args:
        api_key (str | None): API ключ. По умолчанию `None`.

    Returns:
        None

    Example:
        >>> patch_infer_model(api_key='test_api_key')
    """
```

**Назначение**: Заменяет функцию `infer_model` в модуле `pydantic_ai.models` на `new_infer_model`.

**Параметры**:

- `api_key` (str | None): API ключ. По умолчанию `None`.

**Возвращает**:

- `None`

**Как работает функция**:

1.  Импортирует модуль `pydantic_ai.models`.
2.  Использует `functools.partial` для создания новой версии функции `new_infer_model` с фиксированным значением `api_key`.
3.  Заменяет функцию `pydantic_ai.models.infer_model` на новую версию.
4.  Заменяет класс `pydantic_ai.models.AIModel` на класс `AIModel` из текущего модуля.

## Параметры класса

- `client` (AsyncClient): Асинхронный клиент для взаимодействия с API `g4f`.
- `system_prompt_role` (OpenAISystemPromptRole | None): Роль, используемая для системного промпта.
- `_model_name` (str): Название модели.
- `_provider` (str): Провайдер модели.
- `api_key` (str, optional): API ключ. По умолчанию `None`.