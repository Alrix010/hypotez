# Документация для модуля `AIUncensored`

## Обзор

Модуль `AIUncensored` предоставляет асинхронный интерфейс для взаимодействия с AI-моделями через API `aiuncensored.info`. Он поддерживает потоковую передачу данных, системные сообщения и историю сообщений. Модуль включает в себя функции для расчета подписи запросов и выбора случайного URL сервера.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, обеспечивая доступ к AI-моделям для генерации текста и других задач обработки естественного языка.

## Классы

### `AIUncensored`

**Описание**: Класс `AIUncensored` является асинхронным провайдером, реализующим взаимодействие с AI-моделями через API `aiuncensored.info`. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL API `aiuncensored.info`.
- `api_key` (str): Ключ API для доступа к сервису.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (list[str]): Список поддерживаемых моделей.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей.

**Принцип работы**:
Класс использует асинхронные запросы для взаимодействия с API. Он формирует запросы, подписывает их и отправляет на сервер. Полученные ответы обрабатываются в зависимости от режима (потоковый или нет) и возвращаются пользователю.

**Методы**:

- `calculate_signature(timestamp: str, json_dict: dict) -> str`: Вычисляет подпись запроса на основе timestamp и тела запроса.
- `get_server_url() -> str`: Возвращает случайный URL сервера из списка доступных.
- `create_async_generator(model: str, messages: Messages, stream: bool = False, proxy: str = None, api_key: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от AI-модели.

## Методы класса

### `calculate_signature`

```python
    @staticmethod
    def calculate_signature(timestamp: str, json_dict: dict) -> str:
        """Вычисляет подпись запроса на основе timestamp и тела запроса.

        Args:
            timestamp (str): Timestamp запроса.
            json_dict (dict): Словарь с данными запроса в формате JSON.

        Returns:
            str: Подпись запроса в виде шестнадцатеричной строки.
        """
        ...
```

**Назначение**:
Функция `calculate_signature` вычисляет HMAC-SHA256 подпись для обеспечения целостности и подлинности запроса к API.

**Параметры**:
- `timestamp` (str): Временная метка запроса в виде строки.
- `json_dict` (dict): Словарь, содержащий JSON-представление тела запроса.

**Возвращает**:
- `str`: Подпись запроса в виде шестнадцатеричной строки.

**Как работает функция**:
Функция принимает timestamp и словарь с данными запроса, формирует из них сообщение, добавляет секретный ключ, вычисляет HMAC-SHA256 подпись и возвращает её в виде шестнадцатеричной строки.

**Примеры**:
```python
timestamp = "1678886400"
json_dict = {"messages": [{"role": "user", "content": "Hello"}], "model": "hermes3-70b", "stream": False}
signature = AIUncensored.calculate_signature(timestamp, json_dict)
print(signature)
```

### `get_server_url`

```python
    @staticmethod
    def get_server_url() -> str:
        """Возвращает случайный URL сервера из списка доступных.

        Returns:
            str: Случайный URL сервера.
        """
        ...
```

**Назначение**:
Функция `get_server_url` выбирает случайный URL сервера из списка доступных серверов для распределения нагрузки и обеспечения отказоустойчивости.

**Возвращает**:
- `str`: Случайный URL сервера.

**Как работает функция**:
Функция использует модуль `random` для выбора случайного URL из списка серверов и возвращает его.

**Примеры**:
```python
server_url = AIUncensored.get_server_url()
print(server_url)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = False,
        proxy: str = None,
        api_key: str = None,
        **kwargs
    ) -> AsyncResult:      
        """Создает асинхронный генератор для получения ответов от AI-модели.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки.
            stream (bool, optional): Флаг, указывающий на использование потоковой передачи данных. По умолчанию `False`.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            api_key (str, optional): Ключ API. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов от AI-модели.
        """
        ...
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор для получения ответов от AI-модели. Она формирует запрос к API, подписывает его и отправляет на сервер. Полученные ответы обрабатываются в зависимости от режима (потоковый или нет) и возвращаются пользователю через асинхронный генератор.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool, optional): Флаг, указывающий на использование потоковой передачи данных. По умолчанию `False`.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `api_key` (str, optional): Ключ API. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения ответов от AI-модели.

**Как работает функция**:
1. Функция получает название модели, список сообщений и другие параметры.
2. Формирует JSON-словарь с данными запроса, включая сообщения, модель и флаг потоковой передачи.
3. Вычисляет подпись запроса с использованием `calculate_signature`.
4. Формирует заголовки запроса, включая API-ключ, timestamp и подпись.
5. Отправляет POST-запрос на URL сервера с использованием `aiohttp.ClientSession`.
6. Если включен режим потоковой передачи, обрабатывает ответы построчно, декодирует их и извлекает данные.
7. Если режим потоковой передачи выключен, получает JSON-ответ и извлекает контент.
8. Возвращает асинхронный генератор, который выдает ответы от AI-модели.

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello"}]
async for response in AIUncensored.create_async_generator(model="hermes3-70b", messages=messages, stream=True):
    print(response)