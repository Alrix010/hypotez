# src/endpoints/gpt4free/g4f/tools/web_search.py

## Обзор

Модуль `web_search.py` предназначен для выполнения веб-поиска и извлечения информации из результатов поиска. Он использует библиотеку `duckduckgo_search` для выполнения поисковых запросов и `BeautifulSoup` для извлечения текста из веб-страниц. Модуль предоставляет функции для поиска, извлечения текста и форматирования результатов поиска.

## Подробнее

Этот модуль является важной частью проекта `hypotez`, так как он позволяет интегрировать результаты веб-поиска в ответы AI-моделей. Он выполняет поиск информации в интернете, обрабатывает HTML-контент и предоставляет структурированные результаты для дальнейшей обработки.

## Классы

### `SearchResults`

**Описание**: Класс представляет результаты веб-поиска, содержащие список записей о результатах поиска и количество использованных слов.

**Атрибуты**:
- `results` (list): Список объектов `SearchResultEntry`, представляющих результаты поиска.
- `used_words` (int): Количество слов, использованных в результатах поиска.

**Методы**:
- `from_dict(cls, data: dict)`: Создает экземпляр класса `SearchResults` из словаря.
- `__iter__(self)`: Возвращает итератор по результатам поиска.
- `__str__(self)`: Возвращает строковое представление результатов поиска.
- `__len__(self) -> int`: Возвращает количество результатов поиска.
- `get_sources(self) -> Sources`: Возвращает объект `Sources`, содержащий URL-адреса и заголовки результатов поиска.
- `get_dict(self)`: Возвращает словарь, представляющий объект `SearchResults`.

### `SearchResultEntry`

**Описание**: Класс представляет отдельную запись результата веб-поиска, содержащую заголовок, URL, сниппет и текст.

**Атрибуты**:
- `title` (str): Заголовок результата поиска.
- `url` (str): URL-адрес результата поиска.
- `snippet` (str): Сниппет (краткое описание) результата поиска.
- `text` (str, optional): Извлеченный текст из результата поиска.

**Методы**:
- `set_text(self, text: str)`: Устанавливает текст для записи результата поиска.
- `get_dict(self)`:  Возвращает словарь, представляющий объект `SearchResultEntry`.

## Функции

### `scrape_text`

```python
def scrape_text(html: str, max_words: int = None, add_source=True, count_images: int = 2) -> Iterator[str]:
    """Извлекает текст из HTML-кода, ограничивая количество слов и добавляя источник.

    Args:
        html (str): HTML-код для извлечения текста.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool): Флаг, указывающий, следует ли добавлять источник в извлеченный текст. По умолчанию `True`.
        count_images (int): Максимальное количество изображений для извлечения.

    Yields:
        str: Извлеченный текст.
    """
```

**Назначение**: Извлечение текста из предоставленного HTML-кода с возможностью ограничения количества извлекаемых слов и добавления информации об источнике.

**Параметры**:
- `html` (str): HTML-код, из которого необходимо извлечь текст.
- `max_words` (int, optional): Максимальное количество слов, которое нужно извлечь из HTML-кода. Если `None`, ограничение отсутствует. По умолчанию `None`.
- `add_source` (bool): Флаг, определяющий, нужно ли добавлять информацию об источнике в конце извлеченного текста. По умолчанию `True`.
- `count_images (int)`: Максимальное количество изображений, которое нужно извлечь из HTML-кода. По умолчанию `2`.

**Возвращает**:
- `Iterator[str]`: Итератор, возвращающий извлеченный текст.

**Как работает функция**:
1.  Инициализирует `BeautifulSoup` для парсинга HTML.
2.  Выбирает основной контент из HTML, используя различные селекторы CSS.
3.  Удаляет нежелательные элементы, такие как уведомления о раскрытии информации.
4.  Извлекает текст из параграфов, заголовков и таблиц, ограничивая количество слов при необходимости.
5.  Добавляет информацию об источнике, если `add_source` имеет значение `True`.
6.  Для каждого параграфа или элемента текста возвращает его в виде элемента итератора.

**Примеры**:

```python
html_content = "<html><body><h1>Заголовок</h1><p>Текст параграфа.</p></body></html>"
for text in scrape_text(html_content, max_words=5):
    print(text)
# => Заголовок
# =>
# => Текст параграфа.
```

### `fetch_and_scrape`

```python
async def fetch_and_scrape(session: ClientSession, url: str, max_words: int = None, add_source: bool = False) -> str:
    """Асинхронно извлекает HTML-код по URL-адресу и извлекает из него текст.

    Args:
        session (ClientSession): Асинхронная HTTP-сессия.
        url (str): URL-адрес для извлечения HTML-кода.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool, optional): Флаг, указывающий, следует ли добавлять источник в извлеченный текст. По умолчанию `False`.

    Returns:
        str: Извлеченный текст или `None` в случае ошибки.
    """
```

**Назначение**: Асинхронное получение HTML-кода по заданному URL-адресу и извлечение текста из этого HTML-кода.

**Параметры**:
- `session` (ClientSession): Асинхронная HTTP-сессия для выполнения запроса.
- `url` (str): URL-адрес веб-страницы, с которой необходимо извлечь HTML-код.
- `max_words` (int, optional): Максимальное количество слов, которое нужно извлечь из HTML-кода. Если `None`, ограничение отсутствует. По умолчанию `None`.
- `add_source` (bool, optional): Флаг, определяющий, нужно ли добавлять информацию об источнике в конце извлеченного текста. По умолчанию `False`.

**Возвращает**:
- `str`: Извлеченный текст из HTML-кода. Возвращает `None` в случае возникновения ошибки при выполнении запроса или извлечении текста.

**Как работает функция**:
1.  Формирует путь к файлу кэша на основе URL-адреса.
2.  Если файл кэша существует, возвращает его содержимое.
3.  Выполняет GET-запрос к заданному URL-адресу.
4.  Извлекает HTML-код из ответа.
5.  Извлекает текст из HTML-кода с использованием функции `scrape_text`.
6.  Сохраняет извлеченный текст в файл кэша.

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def main():
    async with ClientSession() as session:
        text = await fetch_and_scrape(session, "https://www.example.com", max_words=100)
        print(text)

asyncio.run(main())
```

### `search`

```python
async def search(query: str, max_results: int = 5, max_words: int = 2500, backend: str = "auto", add_text: bool = True, timeout: int = 5, region: str = "wt-wt") -> SearchResults:
    """Выполняет поиск с использованием DuckDuckGo и извлекает текст из результатов.

    Args:
        query (str): Поисковый запрос.
        max_results (int, optional): Максимальное количество результатов для возврата. По умолчанию 5.
        max_words (int, optional): Максимальное количество слов для извлечения из каждого результата. По умолчанию 2500.
        backend (str, optional): Бэкенд для поиска. По умолчанию "auto".
        add_text (bool, optional): Флаг, указывающий, следует ли добавлять текст из результатов. По умолчанию True.
        timeout (int, optional): Время ожидания для HTTP-запросов. По умолчанию 5.
        region (str, optional): Регион для поиска. По умолчанию "wt-wt".

    Returns:
        SearchResults: Объект `SearchResults`, содержащий результаты поиска.
    Raises:
        MissingRequirementsError: Если не установлены необходимые зависимости.
    """
```

**Назначение**: Выполнение поискового запроса с использованием DuckDuckGo и извлечение текста из результатов поиска.

**Параметры**:
- `query` (str): Поисковый запрос, который необходимо выполнить.
- `max_results` (int, optional): Максимальное количество результатов поиска, которые необходимо вернуть. По умолчанию `5`.
- `max_words` (int, optional): Максимальное количество слов, которое необходимо извлечь из каждого результата поиска. По умолчанию `2500`.
- `backend` (str, optional): Бэкенд, используемый для выполнения поиска. По умолчанию `"auto"`.
- `add_text` (bool, optional): Флаг, определяющий, нужно ли извлекать текст из результатов поиска. По умолчанию `True`.
- `timeout` (int, optional): Время ожидания для HTTP-запросов в секундах. По умолчанию `5`.
- `region` (str, optional): Регион поиска. По умолчанию `"wt-wt"`.

**Возвращает**:
- `SearchResults`: Объект `SearchResults`, содержащий результаты поиска.

**Вызывает исключения**:
- `MissingRequirementsError`: Если не установлены необходимые зависимости (`duckduckgo-search` и `beautifulsoup4`).

**Как работает функция**:
1. Проверяет наличие необходимых зависимостей. Если зависимости не установлены, вызывает исключение `MissingRequirementsError`.
2. Выполняет поисковый запрос с использованием библиотеки `duckduckgo_search`.
3. Фильтрует результаты поиска, исключая результаты с доменом `.google.`.
4. Создает список объектов `SearchResultEntry` на основе результатов поиска.
5. Если `add_text` имеет значение `True`, выполняет асинхронные запросы для извлечения текста из каждого результата поиска с использованием функции `fetch_and_scrape`.
6. Форматирует результаты поиска, ограничивая количество слов в каждом результате.

**Примеры**:

```python
import asyncio

async def main():
    results = await search("python programming", max_results=3, max_words=500)
    print(results)

asyncio.run(main())
```

### `do_search`

```python
async def do_search(prompt: str, query: str = None, instructions: str = DEFAULT_INSTRUCTIONS, **kwargs) -> tuple[str, Sources]:
    """Выполняет поиск и форматирует результаты для использования в подсказке.

    Args:
        prompt (str): Исходный запрос пользователя.
        query (str, optional): Поисковый запрос. Если `None`, используется первая строка запроса. По умолчанию `None`.
        instructions (str, optional): Инструкции для форматирования результатов. По умолчанию `DEFAULT_INSTRUCTIONS`.
        **kwargs: Дополнительные аргументы для функции `search`.

    Returns:
        tuple[str, Sources]: Кортеж, содержащий отформатированный запрос и источники результатов поиска.
    """
```

**Назначение**: Выполнение поиска на основе запроса пользователя и форматирование результатов поиска для использования в подсказке (prompt).

**Параметры**:
- `prompt` (str): Исходный запрос пользователя.
- `query` (str, optional): Поисковый запрос. Если не указан, используется первая строка запроса пользователя. По умолчанию `None`.
- `instructions` (str, optional): Инструкции по форматированию результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
- `**kwargs`: Дополнительные аргументы, передаваемые в функцию `search`.

**Возвращает**:
- `tuple[str, Sources]`: Кортеж, содержащий отформатированный запрос и источники результатов поиска.

**Как работает функция**:
1. Проверяет, были ли уже добавлены результаты поиска в запрос. Если да, возвращает исходный запрос без изменений.
2. Если поисковый запрос не указан, использует первую строку запроса пользователя в качестве поискового запроса.
3. Выполняет поиск с использованием функции `search`.
4. Форматирует результаты поиска в соответствии с инструкциями и добавляет их в запрос пользователя.
5. Логирует поисковый запрос и количество результатов.

**Примеры**:

```python
import asyncio

async def main():
    prompt = "What is the capital of France?"
    formatted_prompt, sources = await do_search(prompt)
    print(formatted_prompt)

asyncio.run(main())
```

### `get_search_message`

```python
def get_search_message(prompt: str, raise_search_exceptions=False, **kwargs) -> str:
    """Выполняет поиск и возвращает отформатированное сообщение.

    Args:
        prompt (str): Запрос пользователя.
        raise_search_exceptions (bool, optional): Флаг, указывающий, следует ли вызывать исключения, связанные с поиском. По умолчанию False.
        **kwargs: Дополнительные аргументы для функции `do_search`.

    Returns:
        str: Отформатированное сообщение, включающее результаты поиска.
    """
```

**Назначение**: Выполнение поиска и получение отформатированного сообщения, содержащего результаты поиска.

**Параметры**:
- `prompt` (str): Запрос пользователя, на основе которого выполняется поиск.
- `raise_search_exceptions` (bool, optional): Флаг, указывающий, следует ли вызывать исключения, возникающие в процессе поиска. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы, передаваемые в функцию `do_search`.

**Возвращает**:
- `str`: Отформатированное сообщение, включающее результаты поиска.

**Как работает функция**:
1.  Вызывает асинхронную функцию `do_search` для выполнения поиска и получения отформатированного сообщения.
2.  Обрабатывает возможные исключения, возникающие в процессе поиска (`DuckDuckGoSearchException`, `MissingRequirementsError`).
3.  Если `raise_search_exceptions` имеет значение `True`, вызывает исключение.
4.  Если `raise_search_exceptions` имеет значение `False`, логирует ошибку и возвращает исходный запрос пользователя.

**Примеры**:

```python
prompt = "What is the capital of Germany?"
message = get_search_message(prompt)
print(message)
```

### `spacy_get_keywords`

```python
def spacy_get_keywords(text: str):
    """Извлекает ключевые слова из текста с использованием spaCy.

    Args:
        text (str): Текст для извлечения ключевых слов.

    Returns:
        list: Список ключевых слов.
    """
```

**Назначение**: Извлечение ключевых слов из текста с использованием библиотеки `spaCy`.

**Параметры**:
- `text` (str): Текст, из которого необходимо извлечь ключевые слова.

**Возвращает**:
- `list`: Список ключевых слов, извлеченных из текста.

**Как работает функция**:
1. Проверяет, установлена ли библиотека `spaCy`. Если библиотека не установлена, возвращает исходный текст.
2. Загружает языковую модель `spaCy`.
3. Обрабатывает текст с использованием языковой модели.
4. Извлекает ключевые слова на основе частей речи (существительные, прилагательные) и именованных сущностей.
5. Удаляет дубликаты из списка ключевых слов.

**Примеры**:

```python
text = "The quick brown fox jumps over the lazy dog."
keywords = spacy_get_keywords(text)
print(keywords)