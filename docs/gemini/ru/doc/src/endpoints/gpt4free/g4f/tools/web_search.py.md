# Модуль для веб-поиска

## Обзор

Модуль `web_search.py` предоставляет функциональность для выполнения веб-поиска с использованием DuckDuckGo Search API, извлечения и обработки текста с веб-страниц. Он включает в себя классы и функции для форматирования результатов поиска, кэширования данных и интеграции результатов поиска в запросы пользователей. Модуль предназначен для использования в проектах, требующих автоматического извлечения информации из интернета и интеграции ее в ответы AI-моделей.

## Подробнее

Этот модуль позволяет выполнять поиск в интернете, извлекать текст из веб-страниц, кэшировать результаты и интегрировать их в запросы пользователей. Он использует библиотеки `aiohttp`, `beautifulsoup4` и `duckduckgo-search` для выполнения этих задач.
При первом запуске попытается установить `duckduckgo-search` и `beautifulsoup4`. Эти библиотеки необходимы для функционирования поиска.

## Классы

### `SearchResults`

**Описание**: Класс представляет результаты веб-поиска, содержащие список записей о результатах поиска и количество использованных слов.

**Атрибуты**:
- `results` (list): Список объектов `SearchResultEntry`, представляющих результаты поиска.
- `used_words` (int): Количество слов, использованных в результатах поиска.

**Методы**:
- `from_dict(data: dict)`: Создает экземпляр класса из словаря.
- `__iter__()`: Возвращает итератор по результатам поиска.
- `__str__()`: Возвращает строковое представление результатов поиска.
- `__len__()` -> int: Возвращает количество результатов поиска.
- `get_sources()` -> Sources: Возвращает объект `Sources`, содержащий URL и заголовки результатов поиска.
- `get_dict()`: Возвращает словарь, представляющий объект `SearchResults`.

### `SearchResultEntry`

**Описание**: Класс представляет отдельную запись результата веб-поиска, содержащую заголовок, URL, сниппет и текст.

**Атрибуты**:
- `title` (str): Заголовок результата поиска.
- `url` (str): URL результата поиска.
- `snippet` (str): Сниппет результата поиска.
- `text` (str, optional): Полный текст, извлеченный из результата поиска.

**Методы**:
- `set_text(text: str)`: Устанавливает текст для результата поиска.
- `get_dict()`: Возвращает словарь, представляющий объект `SearchResultEntry`.

## Функции

### `scrape_text`

```python
def scrape_text(html: str, max_words: int = None, add_source=True, count_images: int = 2) -> Iterator[str]:
    """Извлекает текст из HTML-кода веб-страницы.

    Args:
        html (str): HTML-код веб-страницы.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool): Добавлять ли источник в конец извлеченного текста. По умолчанию `True`.
        count_images (int):  Количество изображений для извлечения. По умолчанию `2`.

    Returns:
        Iterator[str]: Итератор по извлеченным текстовым фрагментам.
    """
    ...
```

**Назначение**: Извлекает текст из HTML-кода веб-страницы, удаляя лишние элементы и форматируя результат.

**Параметры**:
- `html` (str): HTML-код веб-страницы.
- `max_words` (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
- `add_source` (bool): Добавлять ли источник в конец извлеченного текста. По умолчанию `True`.
- `count_images` (int):  Количество изображений для извлечения. По умолчанию `2`.

**Возвращает**:
- `Iterator[str]`: Итератор по извлеченным текстовым фрагментам.

**Как работает функция**:
1. Использует `BeautifulSoup` для парсинга HTML-кода.
2. Выбирает основной контент страницы, удаляя нерелевантные элементы.
3. Извлекает текст из заголовков, параграфов, таблиц и списков.
4. Ограничивает количество извлеченных слов, если указано `max_words`.
5. Добавляет источник в конец извлеченного текста, если `add_source` равно `True`.

### `fetch_and_scrape`

```python
async def fetch_and_scrape(session: ClientSession, url: str, max_words: int = None, add_source: bool = False) -> str:
    """Асинхронно загружает HTML-код веб-страницы и извлекает текст.

    Args:
        session (ClientSession): Асинхронная HTTP-сессия.
        url (str): URL веб-страницы.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
        add_source (bool, optional): Добавлять ли источник в конец извлеченного текста. По умолчанию `False`.

    Returns:
        str: Извлеченный текст или `None` в случае ошибки.
    """
    ...
```

**Назначение**: Асинхронно загружает HTML-код веб-страницы и извлекает текст, используя функцию `scrape_text`. Кэширует результаты для повторного использования.

**Параметры**:
- `session` (ClientSession): Асинхронная HTTP-сессия.
- `url` (str): URL веб-страницы.
- `max_words` (int, optional): Максимальное количество слов для извлечения. По умолчанию `None`.
- `add_source` (bool, optional): Добавлять ли источник в конец извлеченного текста. По умолчанию `False`.

**Возвращает**:
- `str`: Извлеченный текст или `None` в случае ошибки.

**Как работает функция**:
1. Формирует путь к кэш-файлу на основе URL.
2. Если кэш-файл существует, возвращает его содержимое.
3. Если кэш-файл не существует, загружает HTML-код страницы с использованием `aiohttp`.
4. Извлекает текст с помощью функции `scrape_text`.
5. Сохраняет извлеченный текст в кэш-файл.
6. Возвращает извлеченный текст.

### `search`

```python
async def search(query: str, max_results: int = 5, max_words: int = 2500, backend: str = "auto", add_text: bool = True, timeout: int = 5, region: str = "wt-wt") -> SearchResults:
    """Выполняет поиск в DuckDuckGo и извлекает текст из результатов.

    Args:
        query (str): Поисковый запрос.
        max_results (int, optional): Максимальное количество результатов для поиска. По умолчанию 5.
        max_words (int, optional): Максимальное количество слов для извлечения из каждого результата. По умолчанию 2500.
        backend (str, optional): Бэкенд для поиска. По умолчанию "auto".
        add_text (bool, optional): Извлекать ли полный текст из результатов поиска. По умолчанию True.
        timeout (int, optional): Время ожидания для HTTP-запросов. По умолчанию 5.
        region (str, optional): Регион поиска. По умолчанию "wt-wt".

    Returns:
        SearchResults: Объект `SearchResults`, содержащий результаты поиска.
    """
    ...
```

**Назначение**: Выполняет поиск в DuckDuckGo и извлекает текст из результатов, используя функции `ddgs.text` и `fetch_and_scrape`.

**Параметры**:
- `query` (str): Поисковый запрос.
- `max_results` (int, optional): Максимальное количество результатов для поиска. По умолчанию 5.
- `max_words` (int, optional): Максимальное количество слов для извлечения из каждого результата. По умолчанию 2500.
- `backend` (str, optional): Бэкенд для поиска. По умолчанию "auto".
- `add_text` (bool, optional): Извлекать ли полный текст из результатов поиска. По умолчанию `True`.
- `timeout` (int, optional): Время ожидания для HTTP-запросов. По умолчанию 5.
- `region` (str, optional): Регион поиска. По умолчанию "wt-wt".

**Возвращает**:
- `SearchResults`: Объект `SearchResults`, содержащий результаты поиска.

**Как работает функция**:
1. Инициализирует `DuckDuckGoSearchAPI` и выполняет поиск с заданными параметрами.
2. Для каждого результата поиска создает объект `SearchResultEntry`.
3. Если `add_text` равно `True`, асинхронно загружает и извлекает текст из каждого результата с использованием `fetch_and_scrape`.
4. Формирует объект `SearchResults`, содержащий результаты поиска и общее количество использованных слов.
5. Возвращает объект `SearchResults`.

### `do_search`

```python
async def do_search(prompt: str, query: str = None, instructions: str = DEFAULT_INSTRUCTIONS, **kwargs) -> tuple[str, Sources]:
    """Выполняет поиск и форматирует результаты для использования в запросе.

    Args:
        prompt (str): Исходный запрос пользователя.
        query (str, optional): Поисковый запрос. Если не указан, используется первая строка запроса. По умолчанию `None`.
        instructions (str, optional): Инструкции для форматирования результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
        **kwargs: Дополнительные параметры для функции `search`.

    Returns:
        tuple[str, Sources]: Кортеж, содержащий отформатированный запрос и объект `Sources` с источниками результатов поиска.
    """
    ...
```

**Назначение**: Выполняет поиск и форматирует результаты для использования в запросе, кэшируя результаты поиска.

**Параметры**:
- `prompt` (str): Исходный запрос пользователя.
- `query` (str, optional): Поисковый запрос. Если не указан, используется первая строка запроса. По умолчанию `None`.
- `instructions` (str, optional): Инструкции для форматирования результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
- `**kwargs`: Дополнительные параметры для функции `search`.

**Возвращает**:
- `tuple[str, Sources]`: Кортеж, содержащий отформатированный запрос и объект `Sources` с источниками результатов поиска.

**Как работает функция**:
1. Формирует поисковый запрос, если он не указан, используя первую строку запроса пользователя.
2. Кэширует результаты поиска, используя MD5-хеш параметров поиска.
3. Если кэш-файл существует, загружает результаты поиска из кэша.
4. Если кэш-файл не существует, выполняет поиск с использованием функции `search`.
5. Форматирует результаты поиска и объединяет их с запросом пользователя и инструкциями.
6. Возвращает отформатированный запрос и объект `Sources` с источниками результатов поиска.

### `get_search_message`

```python
def get_search_message(prompt: str, raise_search_exceptions=False, **kwargs) -> str:
    """Выполняет поиск и возвращает отформатированное сообщение.

    Args:
        prompt (str): Исходный запрос пользователя.
        raise_search_exceptions (bool, optional): Вызывать ли исключения, возникающие при поиске. По умолчанию `False`.
        **kwargs: Дополнительные параметры для функции `do_search`.

    Returns:
        str: Отформатированное сообщение, содержащее результаты поиска.
    """
    ...
```

**Назначение**: Выполняет поиск и возвращает отформатированное сообщение, обрабатывая исключения, возникающие при поиске.

**Параметры**:
- `prompt` (str): Исходный запрос пользователя.
- `raise_search_exceptions` (bool, optional): Вызывать ли исключения, возникающие при поиске. По умолчанию `False`.
- `**kwargs`: Дополнительные параметры для функции `do_search`.

**Возвращает**:
- `str`: Отформатированное сообщение, содержащее результаты поиска.

**Как работает функция**:
1. Вызывает функцию `do_search` и получает отформатированное сообщение.
2. Обрабатывает исключения `DuckDuckGoSearchException` и `MissingRequirementsError`, возникающие при поиске.
3. Если `raise_search_exceptions` равно `True`, вызывает исключение.
4. В противном случае логирует ошибку и возвращает исходный запрос пользователя.
5. Возвращает отформатированное сообщение.

### `spacy_get_keywords`

```python
def spacy_get_keywords(text: str):
    """Извлекает ключевые слова из текста с использованием spaCy.

    Args:
        text (str): Текст для извлечения ключевых слов.

    Returns:
        list: Список ключевых слов.
    """
    ...
```

**Назначение**: Извлекает ключевые слова из текста с использованием библиотеки `spaCy`.

**Параметры**:
- `text` (str): Текст для извлечения ключевых слов.

**Возвращает**:
- `list`: Список ключевых слов.

**Как работает функция**:
1. Загружает языковую модель `spaCy`.
2. Обрабатывает текст с использованием `spaCy`.
3. Извлекает ключевые слова на основе частей речи и именованных сущностей.
4. Удаляет дубликаты и возвращает список ключевых слов.

## Переменные

### `DEFAULT_INSTRUCTIONS`

```python
DEFAULT_INSTRUCTIONS = """
Using the provided web search results, to write a comprehensive reply to the user request.
Make sure to add the sources of cites using [[Number]](Url) notation after the reference. Example: [[0]](http://google.com)
"""
```

**Описание**: Строка, содержащая инструкции по умолчанию для форматирования результатов поиска.