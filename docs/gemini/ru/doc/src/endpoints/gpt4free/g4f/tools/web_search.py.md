# Модуль поиска в Интернете

## Обзор

Этот модуль предоставляет функции для поиска информации в Интернете и добавления полученных результатов в контекст диалога. Он использует библиотеку DuckDuckGo Search для выполнения поисковых запросов и BeautifulSoup для извлечения текста из веб-страниц.

## Подробнее

Модуль `web_search.py` предоставляет функции для поиска информации в Интернете и добавления полученных результатов в контекст диалога. 

Он использует следующие подходы:

- **Использование DuckDuckGo Search:** Библиотека `duckduckgo_search` используется для выполнения поисковых запросов на DuckDuckGo.
- **Извлечение текста с помощью BeautifulSoup:** BeautifulSoup используется для извлечения текста из полученных веб-страниц.
- **Очистка текста:** Функция `scrape_text` очищает текст, удаляя ненужные теги и элементы.
- **Создание контекста диалога:** Функция `do_search` объединяет результаты поиска и исходный текст диалога, чтобы создать новый контекст для дальнейшего анализа.

## Классы

### `SearchResults`

**Описание**: Класс `SearchResults` представляет собой контейнер для хранения результатов поиска. Он предоставляет методы для итерации по результатам, получения текста результатов, сбора информации об источниках и преобразования результатов в словарь.

**Атрибуты**:

- `results` (list): Список объектов `SearchResultEntry`, представляющих результаты поиска.
- `used_words` (int): Количество слов, использованных для вывода результатов поиска.

**Методы**:

- `__iter__()`: Метод, реализующий итерацию по результатам поиска.
- `__str__()`: Метод, реализующий вывод результатов поиска в удобочитаемом формате.
- `__len__()`: Метод, возвращающий количество результатов поиска.
- `get_sources()`: Метод, возвращающий список источников результатов поиска.
- `get_dict()`: Метод, возвращающий словарь, представляющий результаты поиска.

### `SearchResultEntry`

**Описание**: Класс `SearchResultEntry` представляет собой единичный результат поиска. Он содержит информацию о заголовке, URL-адресе, сниппете и тексте результата.

**Атрибуты**:

- `title` (str): Заголовок результата поиска.
- `url` (str): URL-адрес результата поиска.
- `snippet` (str): Краткое описание результата поиска.
- `text` (str): Полный текст результата поиска.

**Методы**:

- `set_text(text: str)`: Метод, устанавливающий текст результата поиска.

## Функции

### `scrape_text(html: str, max_words: int = None, add_source=True, count_images: int = 2) -> Iterator[str]`

**Назначение**: Эта функция извлекает текст из HTML-кода веб-страницы. Она удаляет ненужные теги, ограничивает количество извлеченных слов, добавляет ссылки на источник и обрабатывает изображения.

**Параметры**:

- `html` (str): HTML-код веб-страницы.
- `max_words` (int, optional): Максимальное количество слов, которые будут извлечены. По умолчанию None.
- `add_source` (bool, optional): Если True, добавляет ссылку на источник в конце извлеченного текста. По умолчанию True.
- `count_images` (int, optional): Максимальное количество изображений, которые будут включены в текст. По умолчанию 2.

**Возвращает**:

- `Iterator[str]`: Генератор, который выдает строчки текста, извлеченного из HTML-кода.

**Пример**:

```python
from hypotez.src.endpoints.gpt4free.g4f.tools.web_search import scrape_text

html = """
<!DOCTYPE html>
<html>
<head>
  <title>Пример веб-страницы</title>
</head>
<body>
  <h1>Заголовок</h1>
  <p>Текст параграфа.</p>
</body>
</html>
"""

for line in scrape_text(html):
    print(line)
```

### `fetch_and_scrape(session: ClientSession, url: str, max_words: int = None, add_source: bool = False) -> str`

**Назначение**: Эта функция загружает веб-страницу по указанному URL-адресу и извлекает из нее текст с помощью функции `scrape_text`. Она также кэширует результат для ускорения последующих запросов.

**Параметры**:

- `session` (ClientSession): Сессия aiohttp для отправки запросов.
- `url` (str): URL-адрес веб-страницы.
- `max_words` (int, optional): Максимальное количество слов, которые будут извлечены. По умолчанию None.
- `add_source` (bool, optional): Если True, добавляет ссылку на источник в конце извлеченного текста. По умолчанию False.

**Возвращает**:

- `str`: Извлеченный текст или None, если возникла ошибка.

### `search(query: str, max_results: int = 5, max_words: int = 2500, backend: str = "auto", add_text: bool = True, timeout: int = 5, region: str = "wt-wt") -> SearchResults`

**Назначение**: Эта функция выполняет поиск в Интернете по заданному запросу и возвращает объект `SearchResults` с результатами.

**Параметры**:

- `query` (str): Поисковый запрос.
- `max_results` (int, optional): Максимальное количество результатов поиска, которые будут получены. По умолчанию 5.
- `max_words` (int, optional): Максимальное количество слов, которые будут извлечены из результатов поиска. По умолчанию 2500.
- `backend` (str, optional): Тип поискового движка. По умолчанию "auto".
- `add_text` (bool, optional): Если True, извлекает и добавляет текст из результатов поиска. По умолчанию True.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию 5.
- `region` (str, optional): Регион поиска. По умолчанию "wt-wt".

**Возвращает**:

- `SearchResults`: Объект, представляющий результаты поиска.

### `do_search(prompt: str, query: str = None, instructions: str = DEFAULT_INSTRUCTIONS, **kwargs) -> tuple[str, Sources]`

**Назначение**: Эта функция выполняет поиск в Интернете по заданному запросу, извлекает текст из результатов поиска и добавляет его к исходному тексту диалога.

**Параметры**:

- `prompt` (str): Текст запроса.
- `query` (str, optional): Поисковый запрос. По умолчанию None.
- `instructions` (str, optional): Инструкции для модели. По умолчанию DEFAULT_INSTRUCTIONS.
- `**kwargs`: Дополнительные аргументы для функции `search`.

**Возвращает**:

- `tuple[str, Sources]`: Кортеж, содержащий текст с добавленными результатами поиска и объект `Sources` с информацией об источниках.

### `get_search_message(prompt: str, raise_search_exceptions=False, **kwargs) -> str`

**Назначение**: Эта функция выполняет поиск в Интернете и возвращает обновленный текст запроса с добавленными результатами поиска.

**Параметры**:

- `prompt` (str): Текст запроса.
- `raise_search_exceptions` (bool, optional): Если True, выбрасывает исключение в случае ошибки поиска. По умолчанию False.
- `**kwargs`: Дополнительные аргументы для функции `do_search`.

**Возвращает**:

- `str`: Текст запроса с добавленными результатами поиска.

### `spacy_get_keywords(text: str)`

**Назначение**: Эта функция извлекает ключевые слова из текста с помощью библиотеки spaCy.

**Параметры**:

- `text` (str): Текст, из которого нужно извлечь ключевые слова.

**Возвращает**:

- `list`: Список ключевых слов.

## Примеры

```python
from hypotez.src.endpoints.gpt4free.g4f.tools.web_search import do_search, get_search_message

# Выполнить поиск и добавить результаты к тексту запроса
prompt = "Расскажи мне про историю искусственного интеллекта"
new_prompt, sources = do_search(prompt)
print(new_prompt)
print(sources)

# Получить обновленный текст запроса с результатами поиска
new_prompt = get_search_message(prompt)
print(new_prompt)
```