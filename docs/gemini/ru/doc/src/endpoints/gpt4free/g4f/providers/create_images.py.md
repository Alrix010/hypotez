# Модуль для создания изображений на основе текстовых подсказок

## Обзор

Модуль `create_images.py` предназначен для расширения возможностей провайдеров, позволяя им создавать изображения на основе текстовых подсказок, встроенных в сообщения. Он содержит класс `CreateImagesProvider`, который обрабатывает запросы на создание изображений, используя предоставленные функции создания изображений.

## Подробней

Этот модуль позволяет интегрировать функциональность генерации изображений в существующие системы обработки текста. Он анализирует входящие сообщения на наличие специальных тегов `<img data-prompt="...">`, содержащих текстовые подсказки для генерации изображений. Затем он использует предоставленные функции (`create_images` для синхронного и `create_async` для асинхронного создания изображений) для генерации изображений на основе этих подсказок.

## Классы

### `CreateImagesProvider`

**Описание**: Класс провайдера для создания изображений на основе текстовых подсказок.

**Наследует**: `BaseProvider`

**Атрибуты**:

-   `provider` (ProviderType): Базовый провайдер для обработки задач, не связанных с изображениями.
-   `create_images` (callable): Функция для синхронного создания изображений.
-   `create_images_async` (callable): Функция для асинхронного создания изображений.
-   `system_message` (str): Сообщение, объясняющее возможность создания изображений.
-   `include_placeholder` (bool): Флаг, определяющий, следует ли включать заполнитель изображения в вывод.
-   `__name__` (str): Имя провайдера.
-   `url` (str): URL провайдера.
-   `working` (bool): Указывает, работает ли провайдер.
-   `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.

**Принцип работы**:

1.  Класс инициализируется с базовым провайдером, функциями для создания изображений (синхронной и асинхронной), системным сообщением и флагом для включения заполнителя изображения.
2.  Метод `create_completion` обрабатывает сообщения, ища в них теги `<img data-prompt="...">`. При обнаружении такого тега, он извлекает текстовую подсказку и использует функцию `create_images` для создания изображения.
3.  Метод `create_async` выполняет аналогичную задачу, но в асинхронном режиме, используя функцию `create_images_async`.

**Методы**:

-   `__init__`: Инициализирует экземпляр класса `CreateImagesProvider`.
-   `create_completion`: Создает результат завершения, обрабатывая подсказки для создания изображений в сообщениях.
-   `create_async`: Асинхронно создает ответ, обрабатывая подсказки для создания изображений в сообщениях.

## Методы класса

### `__init__`

```python
def __init__(
    self,
    provider: ProviderType,
    create_images: callable,
    create_async: callable,
    system_message: str = system_message,
    include_placeholder: bool = True
) -> None:
    """
    Инициализирует CreateImagesProvider.

    Args:
        provider (ProviderType): Базовый провайдер.
        create_images (callable): Функция для синхронного создания изображений.
        create_async (callable): Функция для асинхронного создания изображений.
        system_message (str, optional): Системное сообщение, добавляемое к сообщениям. По умолчанию используется предопределенное сообщение.
        include_placeholder (bool, optional): Определяет, следует ли включать заполнители изображений в вывод. По умолчанию True.
    """
    ...
```

**Назначение**: Инициализация экземпляра класса `CreateImagesProvider` с заданными параметрами.

**Параметры**:

-   `provider` (ProviderType): Базовый провайдер, который будет использоваться для обработки задач, не связанных с созданием изображений.
-   `create_images` (callable): Функция, вызываемая для синхронного создания изображений на основе текстовой подсказки.
-   `create_async` (callable): Функция, вызываемая для асинхронного создания изображений на основе текстовой подсказки.
-   `system_message` (str, optional): Системное сообщение, которое будет добавлено в начало списка сообщений для установки контекста. По умолчанию используется значение переменной `system_message`, определенной в модуле.
-   `include_placeholder` (bool, optional): Флаг, указывающий, следует ли включать заполнитель (placeholder) изображения в выходные данные. Если `True`, заполнитель будет включен. По умолчанию `True`.

**Как работает функция**:

1.  Функция принимает базовый провайдер (`provider`), функции для синхронного и асинхронного создания изображений (`create_images` и `create_async`), системное сообщение (`system_message`) и флаг для включения заполнителя изображения (`include_placeholder`).
2.  Затем она присваивает эти значения соответствующим атрибутам экземпляра класса `CreateImagesProvider`.
3.  Также устанавливает атрибуты `__name__`, `url`, `working` и `supports_stream` из базового провайдера.

**Примеры**:

```python
# Пример инициализации CreateImagesProvider с базовым провайдером и функциями создания изображений
provider = SomeProvider()
create_images_func = lambda prompt: f"Image created synchronously from {prompt}"
create_async_func = lambda prompt: asyncio.Future()
create_async_func.set_result(f"Image created asynchronously from {prompt}")

image_provider = CreateImagesProvider(
    provider=provider,
    create_images=create_images_func,
    create_async=create_async_func
)
```

### `create_completion`

```python
def create_completion(
    self,
    model: str,
    messages: Messages,
    stream: bool = False,
    **kwargs
) -> CreateResult:
    """
    Создает результат завершения, обрабатывая любые подсказки для создания изображений, найденные в сообщениях.

    Args:
        model (str): Модель для использования при создании.
        messages (Messages): Сообщения для обработки, которые могут содержать подсказки для изображений.
        stream (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию False.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Yields:
        CreateResult: Выдает фрагменты обработанных сообщений, включая данные изображения, если применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения подсказок создания изображений. Когда такая подсказка найдена,
        он вызывает синхронную функцию создания изображений и включает полученное изображение в вывод.
    """
    ...
```

**Назначение**: Создание результата завершения, обрабатывая подсказки для создания изображений в сообщениях.

**Параметры**:

-   `model` (str): Модель, используемая для генерации завершения.
-   `messages` (Messages): Список сообщений, которые необходимо обработать. Эти сообщения могут содержать текстовые подсказки для создания изображений.
-   `stream` (bool, optional): Флаг, указывающий, следует ли возвращать результат в виде потока (stream). По умолчанию `False`.
-   `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы базовому провайдеру.

**Как работает функция**:

1.  Функция вставляет системное сообщение в начало списка сообщений, чтобы установить контекст для модели.
2.  Затем она итерируется по фрагментам, возвращаемым базовым провайдером при вызове `self.provider.create_completion`.
3.  Если фрагмент является экземпляром `ImageResponse`, он немедленно передается дальше.
4.  Если фрагмент является строкой и содержит символы `<` или если в буфере уже есть данные, фрагмент добавляется в буфер.
5.  Если в буфере обнаружен закрывающий тег `>`, функция пытается найти в буфере тег `<img data-prompt="(.*?)">`.
6.  Если тег найден, извлекается текстовая подсказка, и функция вызывает `self.create_images` для создания изображения.
7.  Результат создания изображения передается дальше.
8.  Если тег не найден, содержимое буфера передается дальше.

**Примеры**:

```python
# Пример вызова create_completion с моделью, списком сообщений и потоковой передачей
model = "DALL-E"
messages = [{"role": "user", "content": "Создай изображение: <img data-prompt='кот на луне'> "}]
stream = False

# Предположим, что provider.create_completion возвращает ImageResponse или строку
# В данном случае, create_completion будет выдавать элементы в зависимости от содержимого сообщений
for chunk in image_provider.create_completion(model, messages, stream):
    print(chunk)
```

### `create_async`

```python
async def create_async(
    self,
    model: str,
    messages: Messages,
    **kwargs
) -> str:
    """
    Асинхронно создает ответ, обрабатывая любые подсказки для создания изображений, найденные в сообщениях.

    Args:
        model (str): Модель для использования при создании.
        messages (Messages): Сообщения для обработки, которые могут содержать подсказки для изображений.
        **kwargs: Дополнительные аргументы ключевого слова для провайдера.

    Returns:
        str: Обработанная строка ответа, включая асинхронно сгенерированные данные изображения, если применимо.

    Note:
        Этот метод обрабатывает сообщения для обнаружения подсказок создания изображений. Когда такая подсказка найдена,
        он вызывает асинхронную функцию создания изображений и включает полученное изображение в вывод.
    """
    ...
```

**Назначение**: Асинхронное создание ответа, обрабатывая подсказки для создания изображений в сообщениях.

**Параметры**:

-   `model` (str): Модель, используемая для генерации ответа.
-   `messages` (Messages): Список сообщений, которые необходимо обработать. Эти сообщения могут содержать текстовые подсказки для создания изображений.
-   `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы базовому провайдеру.

**Как работает функция**:

1.  Функция вставляет системное сообщение в начало списка сообщений, чтобы установить контекст для модели.
2.  Затем она вызывает асинхронный метод `create_async` базового провайдера для получения ответа.
3.  После получения ответа функция ищет в нем теги `<img data-prompt="(.*?)">`.
4.  Для каждого найденного тега извлекается текстовая подсказка, и функция вызывает `self.create_images_async` для создания изображения.
5.  Результаты создания изображений собираются и асинхронно ожидаются с помощью `asyncio.gather`.
6.  Затем функция заменяет каждый тег `<img data-prompt="(.*?)">` в ответе на соответствующее изображение.

**Примеры**:

```python
# Пример вызова create_async с моделью и списком сообщений
model = "DALL-E"
messages = [{"role": "user", "content": "Создай изображение: <img data-prompt='кот на луне'> "}]

# Асинхронный вызов create_async
async def main():
    response = await image_provider.create_async(model, messages)
    print(response)

asyncio.run(main())
```