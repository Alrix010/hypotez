# Модуль Prodia 

## Обзор

Модуль `Prodia` предоставляет функциональность для генерации изображений с использованием API сервиса Prodia. 

## Классы

### `class Prodia`

**Описание**: Класс `Prodia` реализует асинхронный генератор изображений, используя API Prodia. 

**Наследует**: 
- `AsyncGeneratorProvider`: Базовый класс для асинхронных генераторов, предоставляющий общий функционал.
- `ProviderModelMixin`: Миксин, добавляющий функциональность для работы с моделями.

**Атрибуты**:

- `url (str)`: Базовый URL сервиса Prodia.
- `api_endpoint (str)`: URL конечной точки API для генерации изображений.
- `working (bool)`: Флаг, указывающий на работоспособность сервиса (по умолчанию `False`).
- `default_model (str)`: Имя модели по умолчанию для генерации изображений.
- `default_image_model (str)`: Имя модели по умолчанию для генерации изображений (совпадает с `default_model`).
- `image_models (list[str])`: Список доступных моделей для генерации изображений.
- `models (list[str])`: Список всех доступных моделей (совпадает с `image_models`).

**Методы**:

#### `get_model(model: str) -> str`

**Назначение**: Возвращает имя модели для генерации изображений.

**Параметры**:

- `model (str)`: Имя модели, которую необходимо получить.

**Возвращает**:

- `str`: Имя модели, которая будет использоваться для генерации.

**Как работает функция**:

- Проверяет, существует ли `model` в списке `models` или в списке `model_aliases` (алиасы моделей).
- Если `model` найден, возвращает его имя.
- В противном случае возвращает `default_model`.

#### `create_async_generator(model: str, messages: Messages, proxy: str = None, negative_prompt: str = "", steps: str = 20, cfg: str = 7, seed: Optional[int] = None, sampler: str = "DPM++ 2M Karras", aspect_ratio: str = "square", **kwargs) -> AsyncResult`

**Назначение**: Создает асинхронный генератор изображений.

**Параметры**:

- `model (str)`: Имя модели для генерации.
- `messages (Messages)`: Список сообщений, которые будут использоваться для генерации изображения.
- `proxy (str, optional)`: Прокси-сервер для запросов (по умолчанию `None`).
- `negative_prompt (str, optional)`: Отрицательный запрос (по умолчанию пустая строка).
- `steps (str, optional)`: Количество шагов генерации (по умолчанию `20`).
- `cfg (str, optional)`: Параметр CFG (по умолчанию `7`).
- `seed (Optional[int], optional)`: Семечко для генератора случайных чисел (по умолчанию случайное целое число).
- `sampler (str, optional)`: Метод семплирования (по умолчанию `DPM++ 2M Karras`).
- `aspect_ratio (str, optional)`: Соотношение сторон изображения (по умолчанию `square`).

**Возвращает**:

- `AsyncResult`: Асинхронный результат, который содержит генератор изображений.

**Как работает функция**:

- Выбирает имя модели, используя `get_model`.
- Если `seed` не задан, генерирует случайное число.
- Собирает заголовки HTTP-запроса.
- Запрашивает API Prodia, используя `messages` и другие параметры.
- Получает ID задания и URL изображения.
- Инициализирует генератор изображений и возвращает его.

#### `_poll_job(session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str`

**Назначение**: Ожидает завершения задания генерации изображения.

**Параметры**:

- `session (ClientSession)`: Сессия HTTP-клиента.
- `job_id (str)`: ID задания.
- `proxy (str)`: Прокси-сервер для запросов.
- `max_attempts (int, optional)`: Максимальное количество попыток (по умолчанию `30`).
- `delay (int, optional)`: Задержка между попытками (по умолчанию `2`).

**Возвращает**:

- `str`: URL изображения.

**Как работает функция**:

- В цикле до `max_attempts` раз:
    - Делает запрос к API Prodia, чтобы проверить статус задания.
    - Если статус `succeeded`, возвращает URL изображения.
    - Если статус `failed`, поднимает исключение.
- Если `max_attempts` достигнуто, поднимает исключение о тайм-ауте.

## Примеры

```python
# Создание инстанса класса Prodia
prodia = Prodia()

# Генерация изображения с использованием модели 'absolutereality_v181.safetensors [3d9d4d2b]'
image_generator = prodia.create_async_generator(
    model='absolutereality_v181.safetensors [3d9d4d2b]', 
    messages=['Сгенерируй красивую картину с цветком'],
    steps='20', 
    cfg='7',
    seed=None,
    sampler='DPM++ 2M Karras',
    aspect_ratio='square'
)

# Итерация по генератору изображений
async for image in image_generator:
    # Обработка изображения
    # ...
```