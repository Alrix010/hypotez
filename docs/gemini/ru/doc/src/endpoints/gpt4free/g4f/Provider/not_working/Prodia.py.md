# Модуль `Prodia`

## Обзор

Модуль `Prodia` предоставляет асинхронный интерфейс для генерации изображений с использованием API сервиса Prodia. Он позволяет выбирать модель, задавать параметры генерации, такие как промпт, негативный промпт, количество шагов, cfg, seed, sampler и aspect ratio. Модуль поддерживает различные модели изображений и предоставляет возможность получения сгенерированных изображений в виде URL.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется функциональность генерации изображений на основе текстовых запросов. Он использует асинхронные запросы для взаимодействия с API Prodia, что позволяет эффективно обрабатывать множество запросов параллельно.

## Классы

### `Prodia`

**Описание**: Класс `Prodia` является асинхронным генератором изображений на основе API Prodia.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса Prodia.
- `api_endpoint` (str): URL API для генерации изображений.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `default_image_model` (str): Модель изображения по умолчанию.
- `image_models` (List[str]): Список поддерживаемых моделей изображений.
- `models` (List[str]): Список всех доступных моделей, включая модели изображений.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе входной строки.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для генерации изображений.
- `_poll_job(session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str`: Опрашивает API Prodia для получения URL сгенерированного изображения.

## Методы класса

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """
        Функция возвращает имя модели на основе входной строки.

        Args:
            model (str): Имя модели для поиска.

        Returns:
            str: Имя модели, если она найдена в списке поддерживаемых моделей или алиасов.
                 В противном случае возвращает модель по умолчанию.
        """
```

- **Назначение**: Функция определяет, существует ли запрошенная модель в списке доступных. Если модель не найдена, то возвращается модель по умолчанию.

- **Параметры**:
    - `model` (str): Строка с названием модели.

- **Возвращает**:
    - `str`: Строка с названием модели, которая будет использоваться.

- **Как работает функция**:
    - Функция проверяет, есть ли запрошенная модель в списке доступных моделей (`cls.models`).
    - Если модель не найдена, функция проверяет, есть ли запрошенная модель в словаре алиасов моделей (`cls.model_aliases`).
    - Если модель не найдена ни в списке моделей, ни в списке алиасов, функция возвращает модель по умолчанию (`cls.default_model`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        negative_prompt: str = "",
        steps: str = 20, # 1-25
        cfg: str = 7, # 0-20
        seed: Optional[int] = None,
        sampler: str = "DPM++ 2M Karras", # "Euler", "Euler a", "Heun", "DPM++ 2M Karras", "DPM++ SDE Karras", "DDIM"
        aspect_ratio: str = "square", # "square", "portrait", "landscape"
        **kwargs
    ) -> AsyncResult:
        """
        Функция создает асинхронный генератор для генерации изображений с использованием API Prodia.

        Args:
            model (str): Имя модели для генерации изображения.
            messages (Messages): Список сообщений, содержащих промпт для генерации изображения.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            negative_prompt (str, optional): Негативный промпт для генерации изображения. По умолчанию "".
            steps (str, optional): Количество шагов для генерации изображения. По умолчанию "20".
            cfg (str, optional): CFG scale для генерации изображения. По умолчанию "7".
            seed (Optional[int], optional): Зерно для генерации изображения. По умолчанию `None`.
            sampler (str, optional): Сэмплер для генерации изображения. По умолчанию "DPM++ 2M Karras".
            aspect_ratio (str, optional): Соотношение сторон для генерации изображения. По умолчанию "square".
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий объект `ImageResponse` с URL сгенерированного изображения.

        Raises:
            Exception: Если возникает ошибка при запросе к API Prodia.
        """
```

- **Назначение**: Функция создает асинхронный генератор для генерации изображений с использованием API Prodia. Она принимает различные параметры, такие как модель, промпт, негативный промпт, количество шагов, cfg, seed, sampler и aspect ratio.

- **Параметры**:
    - `model` (str): Имя модели для генерации изображения.
    - `messages` (Messages): Список сообщений, содержащих промпт для генерации изображения.
    - `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
    - `negative_prompt` (str, optional): Негативный промпт для генерации изображения. По умолчанию "".
    - `steps` (str, optional): Количество шагов для генерации изображения. По умолчанию "20".
    - `cfg` (str, optional): CFG scale для генерации изображения. По умолчанию "7".
    - `seed` (Optional[int], optional): Зерно для генерации изображения. По умолчанию `None`.
    - `sampler` (str, optional): Сэмплер для генерации изображения. По умолчанию "DPM++ 2M Karras".
    - `aspect_ratio` (str, optional): Соотношение сторон для генерации изображения. По умолчанию "square".
    - `**kwargs`: Дополнительные параметры.

- **Возвращает**:
    - `AsyncResult`: Асинхронный генератор, возвращающий объект `ImageResponse` с URL сгенерированного изображения.

- **Как работает функция**:
    1. Функция вызывает `cls.get_model(model)` для получения имени модели.
    2. Функция генерирует случайное зерно, если `seed` не указан.
    3. Функция создает заголовки для HTTP-запроса.
    4. Функция создает асинхронную сессию с использованием `aiohttp.ClientSession`.
    5. Функция извлекает промпт из последнего сообщения в списке `messages`.
    6. Функция создает параметры запроса, включая промпт, модель, негативный промпт, количество шагов, cfg, seed, sampler и aspect ratio.
    7. Функция отправляет GET-запрос к API Prodia (`cls.api_endpoint`) с параметрами запроса и прокси-сервером (если указан).
    8. Функция обрабатывает ответ от API, извлекает `job_id` из JSON-данных.
    9. Функция вызывает `cls._poll_job(session, job_id, proxy)` для опроса API до тех пор, пока изображение не будет сгенерировано.
    10. Функция возвращает объект `ImageResponse` с URL сгенерированного изображения и альтернативным текстом (промптом).

### `_poll_job`

```python
    @classmethod
    async def _poll_job(cls, session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str:
        """
        Функция опрашивает API Prodia для получения URL сгенерированного изображения.

        Args:
            session (ClientSession): Асинхронная сессия для выполнения HTTP-запросов.
            job_id (str): Идентификатор задания для отслеживания статуса генерации изображения.
            proxy (str): URL прокси-сервера для использования.
            max_attempts (int, optional): Максимальное количество попыток опроса API. По умолчанию 30.
            delay (int, optional): Задержка в секундах между попытками опроса API. По умолчанию 2.

        Returns:
            str: URL сгенерированного изображения.

        Raises:
            Exception: Если генерация изображения не удалась или истекло время ожидания.
        """
```

- **Назначение**: Функция опрашивает API Prodia для получения URL сгенерированного изображения.

- **Параметры**:
    - `session` (ClientSession): Асинхронная сессия для выполнения HTTP-запросов.
    - `job_id` (str): Идентификатор задания для отслеживания статуса генерации изображения.
    - `proxy` (str): URL прокси-сервера для использования.
    - `max_attempts` (int, optional): Максимальное количество попыток опроса API. По умолчанию 30.
    - `delay` (int, optional): Задержка в секундах между попытками опроса API. По умолчанию 2.

- **Возвращает**:
    - `str`: URL сгенерированного изображения.

- **Как работает функция**:
    1. Функция выполняет цикл опроса API до тех пор, пока не будет достигнуто максимальное количество попыток (`max_attempts`).
    2. В каждой итерации цикла функция отправляет GET-запрос к API Prodia (`f"https://api.prodia.com/job/{job_id}"`) с идентификатором задания и прокси-сервером (если указан).
    3. Функция обрабатывает ответ от API, извлекает статус задания из JSON-данных (`job_status`).
    4. Если статус задания равен "succeeded", функция возвращает URL сгенерированного изображения (`f"https://images.prodia.xyz/{job_id}.png"`).
    5. Если статус задания равен "failed", функция вызывает исключение `Exception("Image generation failed")`.
    6. Если после максимального количества попыток статус задания не равен "succeeded", функция вызывает исключение `Exception("Timeout waiting for image generation")`.
    7. Функция использует `asyncio.sleep(delay)` для задержки между попытками опроса API.

## Примеры

Пример использования класса `Prodia`:

```python
#Этот код не может быть выполнен, так как является лишь частью всего проекта
from src.endpoints.gpt4free.g4f.Provider.not_working import Prodia
import asyncio

async def main():
    model = "absolutereality_v181.safetensors [3d9d4d2b]"
    messages = [{"role": "user", "content": "A beautiful landscape"}]
    proxy = None
    negative_prompt = "ugly, distorted"
    steps = "25"
    cfg = "10"
    seed = 1234
    sampler = "DPM++ 2M Karras"
    aspect_ratio = "landscape"

    async for image_response in Prodia.create_async_generator(
        model=model,
        messages=messages,
        proxy=proxy,
        negative_prompt=negative_prompt,
        steps=steps,
        cfg=cfg,
        seed=seed,
        sampler=sampler,
        aspect_ratio=aspect_ratio
    ):
        print(f"Image URL: {image_response.url}")
        print(f"Alt text: {image_response.alt}")

if __name__ == "__main__":
    asyncio.run(main())
```