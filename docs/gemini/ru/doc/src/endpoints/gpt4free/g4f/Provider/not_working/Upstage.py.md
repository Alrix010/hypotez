# Модуль Upstage

## Обзор

Модуль `Upstage` предоставляет асинхронный интерфейс для взаимодействия с моделями Upstage AI. Он позволяет генерировать текст на основе предоставленных сообщений, используя различные модели, предлагаемые Upstage.

## Подробнее

Модуль содержит класс `Upstage`, который наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов к API Upstage. Модуль поддерживает стриминг ответов и предоставляет методы для выбора модели и форматирования запросов.

## Классы

### `Upstage`

**Описание**: Класс для взаимодействия с API Upstage AI для генерации текста.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию контента.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL для playground Upstage.
- `api_endpoint` (str): URL API Upstage для запросов completions.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию ('solar-pro').
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Псевдонимы моделей для удобства использования.

**Принцип работы**:
Класс `Upstage` предназначен для асинхронного взаимодействия с API Upstage. Он позволяет отправлять запросы на генерацию текста на основе предоставленных сообщений и получать ответы в режиме реального времени. Поддерживает выбор различных моделей Upstage, таких как 'solar-pro' и 'upstage/solar-1-mini-chat', а также предоставляет возможность использования прокси-серверов для выполнения запросов.

## Методы класса

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """ Функция выполняет проверку и возвращает имя модели для использования в API Upstage.

    Args:
        model (str): Имя модели, которую необходимо получить.

    Returns:
        str: Имя модели, если она найдена в списке поддерживаемых моделей или псевдонимов, иначе возвращает модель по умолчанию.
    """
```

**Назначение**: Функция определяет, является ли запрошенная модель допустимой, и возвращает соответствующее имя модели.

**Параметры**:
- `model` (str): Имя модели для проверки.

**Возвращает**:
- `str`: Имя модели, если она есть в списке `models` или `model_aliases`, иначе возвращает `default_model`.

**Как работает функция**:
Функция `get_model` принимает имя модели в качестве аргумента и проверяет, присутствует ли оно в списке поддерживаемых моделей (`cls.models`) или в словаре псевдонимов моделей (`cls.model_aliases`). Если модель найдена в списке поддерживаемых моделей, функция возвращает ее немедленно. Если модель найдена в словаре псевдонимов, функция возвращает соответствующее значение из словаря. В противном случае, если модель не найдена ни в списке поддерживаемых моделей, ни в словаре псевдонимов, функция возвращает значение модели по умолчанию (`cls.default_model`).

**Примеры**:
```python
Upstage.get_model('solar-pro')  # Возвращает 'solar-pro'
Upstage.get_model('solar-mini') # Возвращает 'upstage/solar-1-mini-chat'
Upstage.get_model('unknown')    # Возвращает 'solar-pro' (default_model)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """ Функция создает асинхронный генератор для взаимодействия с API Upstage и получения ответов в реальном времени.

    Args:
        model (str): Имя модели, которую необходимо использовать.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, который возвращает ответы от API Upstage.
    """
```

**Назначение**: Функция создает асинхронный генератор для отправки запроса в API Upstage и получения потоковых ответов.

**Параметры**:
- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа от API Upstage.

**Как работает функция**:

1.  **Подготовка**:
    *   Функция `get_model` вызывается для определения имени модели, которая будет использоваться в запросе.
    *   Формируются заголовки (`headers`) для HTTP-запроса, включая информацию о User-Agent, типе контента и прочие метаданные.
2.  **Создание асинхронной сессии**:
    *   Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов. Это позволяет избежать блокировки выполнения программы во время ожидания ответа от сервера.
3.  **Формирование данных запроса**:
    *   Создается словарь `data`, который содержит параметры запроса, такие как:
        *   `stream`: Указывает, что ответ должен быть возвращен в режиме потока.
        *   `messages`: Список сообщений, отформатированных с помощью функции `format_prompt`, где каждое сообщение содержит роль (`role`) и содержимое (`content`).
        *   `model`: Имя модели, которая будет использоваться для генерации ответа.
4.  **Выполнение POST-запроса**:
    *   Выполняется POST-запрос к API Upstage (`cls.api_endpoint`) с использованием асинхронной сессии. В запросе передаются заголовки (`headers`), данные (`data`) и, при необходимости, прокси-сервер (`proxy`).
5.  **Обработка потокового ответа**:
    *   Функция итерируется по каждой строке (`line`) в потоке ответа (`response.content`).
    *   Каждая строка декодируется из формата UTF-8 и очищается от лишних пробелов.
    *   Проверяется, начинается ли строка с префикса `"data: "` и не равна ли она `"data: [DONE]"`. Если это так, строка считается частью данных ответа.
6.  **Извлечение контента из JSON**:
    *   Из строки извлекается JSON-контент (путем удаления префикса `"data: "`) и преобразуется в Python-словарь с помощью `json.loads`.
    *   Из словаря извлекается содержимое (`content`) из ключа `choices[0]['delta']['content']`. Если содержимое присутствует, оно добавляется к переменной `response_text` и возвращается с помощью `yield`.
7.  **Обработка ошибок JSON**:
    *   Если при разборе JSON возникает ошибка (`json.JSONDecodeError`), она игнорируется, и функция переходит к следующей строке.
8.  **Завершение обработки**:
    *   Если строка равна `"data: [DONE]"`, это означает конец потока данных, и цикл завершается.

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for message in Upstage.create_async_generator(model='solar-pro', messages=messages):
    print(message)
```