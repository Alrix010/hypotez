# Модуль обработки статусов ответа

## Обзор

Модуль предназначен для обработки HTTP-ответов и генерации исключений на основе статуса ответа. Он включает в себя функции для проверки наличия ошибок Cloudflare и OpenAI, а также для обработки различных кодов состояния HTTP.

## Подробней

Этот модуль используется для стандартизации обработки ошибок, возвращаемых различными API, в частности, Cloudflare и OpenAI. Он проверяет статус ответа и, в случае ошибки, генерирует соответствующее исключение, такое как `ResponseStatusError`, `RateLimitError`, `MissingAuthError` или `CloudflareError`. Это позволяет унифицировать обработку ошибок в приложении и упростить отладку.

## Функции

### `is_cloudflare`

**Назначение**: Определяет, является ли текст ответа страницей Cloudflare, анализируя содержимое текста.

**Параметры**:
- `text` (str): Текст ответа для анализа.

**Возвращает**:
- `bool`: `True`, если текст содержит признаки Cloudflare, иначе `False`.

**Как работает функция**:
Функция проверяет, содержит ли переданный текст известные признаки, указывающие на то, что это страница Cloudflare. К таким признакам относятся определенные строки в HTML-коде, которые Cloudflare добавляет на страницы с запросом проверки или при возникновении ошибок.

**Примеры**:
```python
>>> is_cloudflare("Generated by cloudfront")
True
>>> is_cloudflare("<title>Attention Required! | Cloudflare</title>")
True
>>> is_cloudflare("some other text")
False
```

### `is_openai`

**Назначение**: Определяет, является ли текст ответа страницей OpenAI с сообщением об ошибке.

**Параметры**:
- `text` (str): Текст ответа для анализа.

**Возвращает**:
- `bool`: `True`, если текст содержит признаки ошибки OpenAI, иначе `False`.

**Как работает функция**:
Функция проверяет, содержит ли переданный текст признаки, указывающие на то, что это страница с сообщением об ошибке от OpenAI.

**Примеры**:
```python
>>> is_openai("<p>Unable to load site</p>")
True
>>> is_openai("some other text")
False
```

### `raise_for_status_async`

**Назначение**: Асинхронно проверяет статус HTTP-ответа и вызывает исключение в случае ошибки.

**Параметры**:
- `response` (Union[StreamResponse, ClientResponse]): Объект асинхронного ответа.
- `message` (str, optional): Сообщение об ошибке. Если не указано, пытается извлечь его из ответа. По умолчанию `None`.

**Возвращает**:
- `None`: Если ответ `ok` (код состояния HTTP 200-299).

**Вызывает исключения**:
- `MissingAuthError`: Если статус ответа 401 (не авторизован).
- `CloudflareError`: Если статус ответа 403 и обнаружена защита Cloudflare.
- `ResponseStatusError`: Если статус ответа 403 и обнаружена защита OpenAI, или если произошла другая ошибка.
- `RateLimitError`: Если статус ответа 429 или 504 (превышение лимита запросов).

**Как работает функция**:

1.  Проверяет, является ли ответ успешным (`response.ok`). Если да, функция завершается.
2.  Если `message` не предоставлено, функция пытается извлечь сообщение об ошибке из тела ответа. Если `content-type` начинается с `application/json`, функция пытается разобрать JSON и извлечь сообщение из поля `error`. Если `content-type` начинается с `text/html` или тело ответа начинается с `<!DOCTYPE`, функция устанавливает флаг `is_html`.
3.  Если `message` по-прежнему пустое или установлен флаг `is_html`, функция устанавливает сообщение об ошибке в зависимости от `response.status`.
4.  В зависимости от кода состояния HTTP и содержимого `message`, функция вызывает соответствующее исключение:
    *   `401`: `MissingAuthError`
    *   `403` и `is_cloudflare(message)`: `CloudflareError`
    *   `403` и `is_openai(message)`: `ResponseStatusError`
    *   `502`: `ResponseStatusError`
    *   `504`: `RateLimitError`
    *   В остальных случаях: `ResponseStatusError`

**Примеры**:
```python
#response = StreamResponse(status=200)  # Создание успешного ответа для примера
#await raise_for_status_async(response)  # Ничего не произойдет

#response = StreamResponse(status=401) #  Создание ответа с ошибкой авторизации
#try:
#    await raise_for_status_async(response)
#except MissingAuthError as ex:
#    print(f"Произошла ошибка: {ex}")
```

### `raise_for_status`

**Назначение**: Проверяет статус HTTP-ответа и вызывает исключение в случае ошибки. Функция поддерживает как асинхронные, так и синхронные ответы.

**Параметры**:
- `response` (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа.
- `message` (str, optional): Сообщение об ошибке. Если не указано, пытается извлечь его из ответа. По умолчанию `None`.

**Возвращает**:
- `None`: Если ответ `ok` (код состояния HTTP 200-299).

**Вызывает исключения**:
- `MissingAuthError`: Если статус ответа 401 (не авторизован).
- `CloudflareError`: Если статус ответа 403 и обнаружена защита Cloudflare.
- `ResponseStatusError`: Если статус ответа 403 и обнаружена защита OpenAI, или если произошла другая ошибка.
- `RateLimitError`: Если статус ответа 429 или 504 (превышение лимита запросов).

**Как работает функция**:

1.  Проверяет, имеет ли объект ответа атрибут `status`. Если да, вызывает асинхронную функцию `raise_for_status_async` и завершается.
2.  Если ответ `ok` (`response.ok`), функция завершается.
3.  Если `message` не предоставлено, функция пытается извлечь сообщение об ошибке из тела ответа. Если `content-type` начинается с `text/html` или тело ответа начинается с `<!DOCTYPE>`, функция устанавливает флаг `is_html`.
4.  Если `message` по-прежнему пустое или установлен флаг `is_html`, функция устанавливает сообщение об ошибке в зависимости от `response.status_code`.
5.  В зависимости от кода состояния HTTP и содержимого `message`, функция вызывает соответствующее исключение:
    *   `401`: `MissingAuthError`
    *   `403` и `is_cloudflare(response.text)`: `CloudflareError`
    *   `403` и `is_openai(response.text)`: `ResponseStatusError`
    *   `502`: `ResponseStatusError`
    *   `504`: `RateLimitError`
    *   В остальных случаях: `ResponseStatusError`

**Примеры**:
```python
#import requests
#response = requests.Response()
#response.status_code = 200  #  Создание успешного ответа для примера
#response.headers = {"content-type": "text/html"}
#response.text = "<html><body>OK</body></html>"

#raise_for_status(response)  #  Ничего не произойдет

#response = requests.Response()
#response.status_code = 401  #  Создание ответа с ошибкой авторизации
#response.headers = {"content-type": "text/html"}
#response.text = "<html><body>Unauthorized</body></html>"
#try:
#    raise_for_status(response)
#except MissingAuthError as ex:
#    print(f"Произошла ошибка: {ex}")
```