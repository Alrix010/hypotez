# Модуль для обработки статусов ответов

## Обзор

Модуль предназначен для обработки HTTP-статусов ответов от различных источников, таких как `aiohttp`, `requests` и `StreamResponse`. Он проверяет статус ответа и, в случае ошибки, вызывает соответствующие исключения, такие как `ResponseStatusError`, `RateLimitError`, `MissingAuthError` и `CloudflareError`. Также, модуль содержит функции для определения, был ли ответ сгенерирован Cloudflare или OpenAI.

## Подробней

Модуль `raise_for_status` предоставляет две основные функции: `raise_for_status_async` и `raise_for_status`. Первая предназначена для асинхронных ответов (например, полученных с помощью `aiohttp`), а вторая — для синхронных ответов (например, полученных с помощью библиотеки `requests`). Обе функции проверяют статус ответа и вызывают исключения в случае неудачи. Модуль также включает функции `is_cloudflare` и `is_openai`, которые помогают определить, сгенерирован ли ответ Cloudflare или OpenAI, что позволяет обрабатывать специфические ошибки, связанные с этими сервисами.

## Функции

### `is_cloudflare`

**Назначение**:
Функция проверяет, содержит ли текст ответа признаки того, что он был сгенерирован Cloudflare.

**Параметры**:
- `text` (str): Текст ответа, который необходимо проверить.

**Возвращает**:
- `bool`: `True`, если текст содержит признаки Cloudflare, и `False` в противном случае.

**Как работает функция**:
Функция ищет в переданном тексте известные строки, которые указывают на то, что ответ был сгенерирован Cloudflare.

**Примеры**:

```python
is_cloudflare('Generated by cloudfront')  # Возвращает True
is_cloudflare('<title>Attention Required! | Cloudflare</title>')  # Возвращает True
is_cloudflare('Some other text')  # Возвращает False
```

### `is_openai`

**Назначение**:
Функция проверяет, содержит ли текст ответа признаки того, что он был сгенерирован OpenAI.

**Параметры**:
- `text` (str): Текст ответа, который необходимо проверить.

**Возвращает**:
- `bool`: `True`, если текст содержит признаки OpenAI, и `False` в противном случае.

**Как работает функция**:
Функция ищет в переданном тексте известные строки, которые указывают на то, что ответ был сгенерирован OpenAI.

**Примеры**:

```python
is_openai('<p>Unable to load site</p>')  # Возвращает True
is_openai('Some other text')  # Возвращает False
```

### `raise_for_status_async`

**Назначение**:
Асинхронная функция, которая проверяет статус HTTP-ответа и вызывает исключение, если статус указывает на ошибку.

**Параметры**:
- `response` (Union[StreamResponse, ClientResponse]): Объект ответа, который необходимо проверить.
- `message` (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

**Возвращает**:
- `None`: Если статус ответа `ok` (200-299).

**Вызывает исключения**:
- `MissingAuthError`: Если статус ответа 401 (не авторизован).
- `CloudflareError`: Если статус ответа 403 и ответ сгенерирован Cloudflare.
- `ResponseStatusError`: Если статус ответа 403 и ответ сгенерирован OpenAI, или если произошла другая ошибка.
- `RateLimitError`: Если статус ответа 504 (Gateway Timeout).

**Внутренние функции**:

*   `inner_function` отсутствует

**Как работает функция**:
1.  Проверяет, является ли статус ответа успешным (`response.ok`). Если да, функция завершается.
2.  Если `message` не предоставлено, функция пытается извлечь сообщение об ошибке из тела ответа.
3.  Если тип контента - JSON, извлекает сообщение из JSON-структуры (`response.json().get("error", message)`).
4.  Если тип контента не JSON, извлекает сообщение из текста ответа (`response.text().strip()`).
5.  Определяет, является ли контент HTML.
6.  Если сообщение не предоставлено или контент является HTML, устанавливает стандартные сообщения об ошибках для определенных кодов статуса (например, "Unknown error (Cloudflare)" для статуса 520).
7.  Вызывает соответствующие исключения на основе статуса ответа.

**Примеры**:

```python
# Пример использования с aiohttp.ClientResponse
import aiohttp
import asyncio

async def main():
    async with aiohttp.ClientSession() as session:
        async with session.get('https://example.com/nonexistent') as response:
            try:
                await raise_for_status_async(response)
            except ResponseStatusError as ex:
                print(f"Произошла ошибка: {ex}")

asyncio.run(main())
```

### `raise_for_status`

**Назначение**:
Синхронная функция, которая проверяет статус HTTP-ответа и вызывает исключение, если статус указывает на ошибку.

**Параметры**:
- `response` (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа, который необходимо проверить.
- `message` (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

**Возвращает**:
- `None`: Если статус ответа `ok` (200-299).

**Вызывает исключения**:
- `MissingAuthError`: Если статус ответа 401 (не авторизован).
- `CloudflareError`: Если статус ответа 403 и ответ сгенерирован Cloudflare.
- `ResponseStatusError`: Если статус ответа 403 и ответ сгенерирован OpenAI, или если произошла другая ошибка.
- `RateLimitError`: Если статус ответа 429 или 504 (Rate Limit или Gateway Timeout).

**Внутренние функции**:

*   `inner_function` отсутствует

**Как работает функция**:
1.  Проверяет, есть ли атрибут `status` у объекта `response`. Если есть, вызывает асинхронную функцию `raise_for_status_async`.
2.  Если `message` не предоставлено, функция пытается извлечь сообщение об ошибке из тела ответа.
3.  Определяет, является ли контент HTML.
4.  Если сообщение не предоставлено или контент является HTML, устанавливает стандартные сообщения об ошибках для определенных кодов статуса (например, "Unknown error (Cloudflare)" для статуса 520).
5.  Вызывает соответствующие исключения на основе статуса ответа.

**Примеры**:

```python
# Пример использования с requests.Response
import requests

response = requests.get('https://example.com/nonexistent')
try:
    raise_for_status(response)
except ResponseStatusError as ex:
    print(f"Произошла ошибка: {ex}")
```