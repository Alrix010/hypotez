# Модуль `base_provider.py`

## Обзор

Модуль `base_provider.py` содержит абстрактные классы и вспомогательные функции, которые служат основой для реализации различных провайдеров, используемых для взаимодействия с моделями генерации текста, такими как GPT-4. Он определяет базовые классы для синхронных, асинхронных и асинхронных генераторных провайдеров, а также утилиты для управления параметрами, обработкой ошибок и аутентификацией.

## Подробней

Этот модуль предоставляет абстрактные классы, которые определяют интерфейсы для создания и использования различных провайдеров. Он также содержит вспомогательные функции для обработки ошибок, управления параметрами и аутентификации. Этот модуль обеспечивает гибкость и расширяемость для интеграции различных моделей и поставщиков услуг в проект `hypotez`.

## Классы

### `AbstractProvider`

**Описание**:
Абстрактный базовый класс для всех провайдеров. Определяет основные методы, которые должны быть реализованы подклассами.

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool, **kwargs) -> CreateResult`:
    - **Назначение**: Абстрактный метод для создания завершения с заданными параметрами.
    - **Параметры**:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool): Использовать ли потоковую передачу.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат процесса создания.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если метод не реализован в подклассе.

- `create_async(model: str, messages: Messages, *, timeout: int = None, loop: AbstractEventLoop = None, executor: ThreadPoolExecutor = None, **kwargs) -> str`:
    - **Назначение**: Асинхронно создает результат на основе заданной модели и сообщений.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `timeout` (int, optional): Время ожидания выполнения задачи. По умолчанию `None`.
        - `loop` (AbstractEventLoop, optional): Событийный цикл для использования. По умолчанию `None`.
        - `executor` (ThreadPoolExecutor, optional): Исполнитель для запуска асинхронных задач. По умолчанию `None`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `str`: Созданный результат в виде строки.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию создания.
    - **Возвращает**:
        - `callable`: Функция создания.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию создания.
    - **Возвращает**:
        - `callable`: Асинхронная функция создания.

- `get_parameters(as_json: bool = False) -> dict[str, Parameter]`:
    - **Назначение**: Возвращает параметры, поддерживаемые провайдером.
    - **Параметры**:
        - `as_json` (bool, optional): Преобразовать ли параметры в формат JSON. По умолчанию `False`.
    - **Возвращает**:
        - `dict[str, Parameter]`: Словарь поддерживаемых параметров.

        **Внутренние функции**:

        - `get_type_as_var(annotation: type, key: str, default)`:
            - **Назначение**: Определяет тип переменной. Возвращает пример значения в зависимости от типа.
            - **Параметры**:
                - `annotation` (type): Тип данных параметра.
                - `key` (str): Имя параметра.
                - `default` : Значение параметра по умолчанию.
            - **Возвращает**:
                - Пример значения в зависимости от типа.

- `params` (property):
    - **Назначение**: Возвращает параметры, поддерживаемые провайдером, в виде строки.
    - **Возвращает**:
        - `str`: Строка, содержащая список поддерживаемых параметров.

        **Внутренние функции**:

        - `get_type_name(annotation: type) -> str`:
            - **Назначение**: Получает имя типа аннотации.
            - **Параметры**:
                - `annotation` (type): Аннотация типа.
            - **Возвращает**:
                - `str`: Имя типа.

### `AsyncProvider(AbstractProvider)`

**Описание**:
Предоставляет асинхронную функциональность для создания завершений.
**Наследует**:
`AbstractProvider`

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = False, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат завершения синхронно.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `False`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания завершения.

- `create_async(model: str, messages: Messages, **kwargs) -> str`:
    - **Назначение**: Абстрактный метод для создания асинхронных результатов.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если этот метод не переопределен в производных классах.
    - **Возвращает**:
        - `str`: Созданный результат в виде строки.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию создания.
    - **Возвращает**:
        - `callable`: Функция создания.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию создания.
    - **Возвращает**:
        - `callable`: Асинхронная функция создания.

### `AsyncGeneratorProvider(AbstractProvider)`

**Описание**:
Предоставляет функциональность асинхронного генератора для потоковой передачи результатов.
**Наследует**:
`AbstractProvider`

**Атрибуты**:
- `supports_stream` (bool): Указывает, поддерживается ли потоковая передача (значение True).

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = True, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат потоковой передачи завершения синхронно.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания потоковой передачи завершения.

- `create_async_generator(model: str, messages: Messages, stream: bool = True, **kwargs) -> AsyncResult`:
    - **Назначение**: Абстрактный метод для создания асинхронного генератора.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если этот метод не переопределен в производных классах.
    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, выдающий результаты.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию создания.
    - **Возвращает**:
        - `callable`: Функция создания.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию создания.
    - **Возвращает**:
        - `callable`: Асинхронная функция создания.

### `ProviderModelMixin`

**Описание**:
Миксин, предоставляющий атрибуты и методы для управления моделями, поддерживаемыми провайдером.

**Атрибуты**:

- `default_model` (str): Модель, используемая по умолчанию.
- `models` (list[str]): Список поддерживаемых моделей.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей.
- `image_models` (list): Список моделей для работы с изображениями.
- `vision_models` (list): Список моделей для обработки изображений.
- `last_model` (str): Последняя использованная модель.

**Методы**:

- `get_models(**kwargs) -> list[str]`:
    - **Назначение**: Возвращает список поддерживаемых моделей.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `list[str]`: Список поддерживаемых моделей.

- `get_model(model: str, **kwargs) -> str`:
    - **Назначение**: Возвращает модель, используя псевдоним, если он существует, или вызывает исключение, если модель не поддерживается.
    - **Параметры**:
        - `model` (str): Модель для получения.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `str`: Полученная модель.
    - **Вызывает исключения**:
        - `ModelNotSupportedError`: Если модель не поддерживается.

### `RaiseErrorMixin`

**Описание**:
Миксин, предоставляющий метод для обработки ошибок, возвращаемых провайдерами.

**Методы**:

- `raise_error(data: dict, status: int = None)`:
    - **Назначение**: Вызывает исключение на основе данных об ошибке.
    - **Параметры**:
        - `data` (dict): Данные об ошибке.
        - `status` (int, optional): Код состояния HTTP. По умолчанию `None`.
    - **Вызывает исключения**:
        - `ResponseError`: Если в данных есть сообщение об ошибке.
        - `MissingAuthError`: Если требуется аутентификация.
        - `PaymentRequiredError`: Если требуется оплата.

### `AuthFileMixin`

**Описание**:
Миксин, предоставляющий метод для получения пути к файлу кэша аутентификации.

**Методы**:

- `get_cache_file() -> Path`:
    - **Назначение**: Возвращает путь к файлу кэша.
    - **Возвращает**:
        - `Path`: Путь к файлу кэша.

### `AsyncAuthedProvider(AsyncGeneratorProvider, AuthFileMixin)`

**Описание**:
Предоставляет функциональность асинхронного провайдера с аутентификацией и кэшированием.
**Наследует**:
`AsyncGeneratorProvider`, `AuthFileMixin`

**Методы**:

- `on_auth_async(**kwargs) -> AuthResult`:
    - **Назначение**: Асинхронно выполняет аутентификацию.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `AuthResult`: Результат аутентификации.
    -  **Вызывает исключения**:
        - `MissingAuthError`: Если отсутствует ключ API.

- `on_auth(**kwargs) -> AuthResult`:
    - **Назначение**: Выполняет аутентификацию синхронно.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `AuthResult`: Результат аутентификации.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию создания.
    - **Возвращает**:
        - `callable`: Функция создания.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию создания.
    - **Возвращает**:
        - `callable`: Асинхронная функция создания.

- `write_cache_file(cache_file: Path, auth_result: AuthResult = None)`:
    - **Назначение**: Записывает результат аутентификации в файл кэша.
    - **Параметры**:
        - `cache_file` (Path): Путь к файлу кэша.
        - `auth_result` (AuthResult, optional): Результат аутентификации. По умолчанию `None`.

- `create_completion(model: str, messages: Messages, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат завершения с использованием аутентификации и кэширования.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания завершения.

- `create_async_generator(model: str, messages: Messages, **kwargs) -> AsyncResult`:
    - **Назначение**: Создает асинхронный генератор с использованием аутентификации и кэширования.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, выдающий результаты.

## Переменные

- `SAFE_PARAMETERS` (list[str]): Список безопасных параметров, которые можно передавать провайдерам.
- `BASIC_PARAMETERS` (dict): Словарь основных параметров, используемых провайдерами.
- `PARAMETER_EXAMPLES` (dict): Словарь примеров значений параметров.