# Модуль backend.py

## Обзор

Модуль `backend.py` предоставляет API для обработки запросов, связанных с взаимодействием с моделью чат-бота. Он содержит класс `Backend_Api`, который обрабатывает входящие запросы, формирует сообщения для модели, получает ответы и возвращает их клиенту. Модуль также включает функции для работы с прокси, обработки результатов поиска и определения языка ответа.

## Подробнее

Этот модуль является частью серверной части системы и отвечает за обработку запросов к API, связанных с генерацией ответов чат-бота. Он использует различные функции для подготовки сообщений, получения результатов поиска в интернете и обработки инструкций для обхода ограничений модели (jailbreak). Класс `Backend_Api` инициализирует приложение Flask и настраивает маршруты для обработки запросов.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` управляет API для взаимодействия с моделью чат-бота.

**Атрибуты**:

- `app`: Экземпляр приложения Flask.
- `use_auto_proxy` (bool): Флаг, указывающий на необходимость использования автоматического прокси.
- `routes` (dict): Словарь, содержащий маршруты API и соответствующие функции для их обработки.

**Методы**:

- `__init__(self, app, config: dict) -> None`: Инициализирует класс `Backend_Api`.
- `_conversation(self)`: Обрабатывает запрос на генерацию ответа от модели чат-бота.

### `__init__(self, app, config: dict) -> None`

**Назначение**: Инициализирует экземпляр класса `Backend_Api`.

**Параметры**:

- `app`: Экземпляр приложения Flask.
- `config` (dict): Словарь с конфигурационными параметрами.

**Как работает функция**:

- Принимает экземпляр приложения Flask и словарь конфигурации.
- Инициализирует атрибуты класса `app`, `use_auto_proxy` и `routes` на основе переданных аргументов.
- Если `use_auto_proxy` установлен в `True`, запускает в отдельном потоке функцию `update_working_proxies` для обновления списка рабочих прокси.

### `_conversation(self)`

**Назначение**: Обрабатывает запрос на генерацию ответа от модели чат-бота.

**Как работает функция**:
1. Извлекает параметры запроса из JSON-данных, включая флаг потоковой передачи (`stream`), инструкцию обхода ограничений (`jailbreak`), название модели (`model`) и сообщения (`messages`).
2. Формирует сообщения для модели, используя функцию `build_messages`.
3. Вызывает метод `ChatCompletion.create` для получения ответа от модели.
4. Если происходит ошибка, возвращает JSON-ответ с информацией об ошибке и кодом состояния 400.

**Примеры**:

Пример вызова функции (в контексте Flask route):

```python
from flask import Flask, request
app = Flask(__name__)

config = {'use_auto_proxy': False}
api = Backend_Api(app, config)

@app.route('/backend-api/v2/conversation', methods=['POST'])
def conversation():
    return api._conversation()
```

## Функции

### `build_messages(jailbreak)`

**Назначение**: Формирует список сообщений для отправки в модель чат-бота.

**Параметры**:

- `jailbreak`: Инструкция для обхода ограничений модели.

**Возвращает**:

- `conversation` (list): Список сообщений, включающий системное сообщение, историю разговоров, результаты поиска (если разрешено) и инструкции для обхода ограничений.

**Как работает функция**:
1. Извлекает данные из JSON-запроса, включая историю разговоров (`_conversation`), флаг доступа к интернету (`internet_access`) и основное сообщение (`prompt`).
2. Формирует системное сообщение, включающее текущую дату и язык ответа.
3. Инициализирует разговор с системным сообщением.
4. Добавляет существующую историю разговоров.
5. Если доступ к интернету разрешен, добавляет результаты поиска, используя функцию `fetch_search_results`.
6. Если включены инструкции для обхода ограничений, добавляет их.
7. Добавляет основное сообщение.
8. Ограничивает размер разговора, чтобы избежать ошибок, связанных с количеством токенов API.

### `fetch_search_results(query)`

**Назначение**: Выполняет поиск в интернете и возвращает результаты в формате, пригодном для добавления в разговор с моделью.

**Параметры**:

- `query` (str): Поисковый запрос.

**Возвращает**:

- `results` (list): Список сообщений, содержащих результаты поиска.

**Как работает функция**:
1. Выполняет запрос к API DuckDuckGo для поиска в интернете.
2. Формирует строку с результатами поиска, включающую сниппет и ссылку на каждый результат.
3. Возвращает список, содержащий сообщение с результатами поиска.

### `generate_stream(response, jailbreak)`

**Назначение**: Генерирует поток сообщений для ответа от модели чат-бота.

**Параметры**:

- `response`: Ответ от модели.
- `jailbreak`: Инструкция для обхода ограничений модели.

**Как работает функция**:

- Если `jailbreak` включен, функция проверяет, успешно ли применена инструкция обхода ограничений, и возвращает сообщения только после успешной проверки.
- Если `jailbreak` не включен, функция просто возвращает сообщения из ответа модели.

### `response_jailbroken_success(response: str) -> bool`

**Назначение**: Определяет, успешно ли применена инструкция обхода ограничений (jailbreak) на основе ответа модели.

**Параметры**:

- `response` (str): Ответ от модели.

**Возвращает**:

- `bool`: `True`, если инструкция обхода ограничений применена успешно, `False` в противном случае.

**Как работает функция**:

- Ищет в ответе модели строку "ACT:", которая указывает на успешное применение инструкции обхода ограничений.

### `response_jailbroken_failed(response)`

**Назначение**: Определяет, не удалось ли применить инструкцию обхода ограничений (jailbreak) на основе ответа модели.

**Параметры**:

- `response` (str): Ответ от модели.

**Возвращает**:

- `bool`: `True`, если инструкция обхода ограничений не применена, `False` в противном случае.

**Как работает функция**:

- Проверяет, начинается ли ответ модели со строк "GPT:" или "ACT:". Если нет, то считается, что инструкция обхода ограничений не применена.

### `set_response_language(prompt)`

**Назначение**: Определяет язык запроса и формирует инструкцию для модели отвечать на этом языке.

**Параметры**:

- `prompt`: Текст запроса.

**Возвращает**:

- `str`: Инструкция для модели отвечать на определенном языке.

**Как работает функция**:

- Использует `googletrans.Translator` для определения языка запроса.
- Формирует строку с инструкцией для модели отвечать на определенном языке.

### `isJailbreak(jailbreak)`

**Назначение**: Проверяет, включена ли инструкция обхода ограничений (jailbreak) и возвращает соответствующую инструкцию.

**Параметры**:

- `jailbreak`: Имя инструкции обхода ограничений.

**Возвращает**:

- Инструкция обхода ограничений, если она включена, `None` в противном случае.

**Как работает функция**:

- Проверяет, является ли значение `jailbreak` отличным от "Default".
- Если да, то возвращает соответствующую инструкцию из словаря `special_instructions`, если она там есть.
- В противном случае возвращает `None`.