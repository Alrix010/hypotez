# Модуль взаимодействия с You.com через API для G4F

## Обзор

Модуль предназначен для обмена сообщениями с сервисом You.com через его API. Он преобразует входящие сообщения в формат, ожидаемый API You.com, и обрабатывает ответы, извлекая полезные данные. Модуль использует библиотеку `curl_cffi` для выполнения HTTP-запросов.

## Подробнее

Этот модуль является частью проекта `hypotez` и обеспечивает интеграцию с сервисом You.com для обработки и генерации текста. Он получает конфигурацию и сообщения через аргументы командной строки, преобразует их в нужный формат и отправляет запросы к API You.com.

## Функции

### `transform`

```python
def transform(messages: list) -> list:
    """ Функция преобразует список сообщений в формат, ожидаемый API You.com.

    Args:
        messages (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами 'role' и 'content'.

    Returns:
        list: Список преобразованных сообщений в формате, подходящем для API You.com. Каждое сообщение представлено в виде словаря с ключами 'question' и 'answer'.

    **Как работает функция**:
    - Функция итерируется по списку сообщений, обрабатывая их по ролям ('user', 'assistant', 'system').
    - Если роль 'user', функция объединяет вопрос с последующим ответом от 'assistant' (если есть).
    - Если роль 'assistant' или 'system', функция создает сообщение с соответствующим содержимым.

    **Примеры**:
    - Пример 1:
        >>> messages = [{'role': 'user', 'content': 'Привет'}, {'role': 'assistant', 'content': 'Здравствуйте'}]
        >>> transform(messages)
        [{'question': 'Привет', 'answer': 'Здравствуйте'}]

    - Пример 2:
        >>> messages = [{'role': 'user', 'content': 'Вопрос'}, {'role': 'system', 'content': 'Системное сообщение'}]
        >>> transform(messages)
        [{'question': 'Вопрос', 'answer': ''}, {'question': 'Системное сообщение', 'answer': ''}]
    """
```

### `output`

```python
def output(chunk):
    """ Функция извлекает и печатает токен youChatToken из полученного чанка данных.

    Args:
        chunk: Часть данных, полученная в процессе потоковой передачи ответа от API You.com.

    Returns:
        None

    **Как работает функция**:
    - Функция проверяет наличие маркера `"youChatToken"` в полученном блоке данных.
    - Если маркер найден, функция преобразует блок данных в формат JSON, извлекает значение `"youChatToken"` и выводит его в консоль.

    """
```

## Переменные

- `config (dict)`: Словарь с конфигурацией, загруженный из аргументов командной строки.
- `messages (list)`: Список сообщений, полученных из конфигурации.
- `prompt (str)`: Последнее сообщение пользователя, если оно есть.
- `headers (dict)`: Заголовки HTTP-запроса, необходимые для взаимодействия с API You.com.
- `params (str)`: Параметры запроса, закодированные в формате URL.

## Логика работы модуля

1.  **Загрузка конфигурации**:
    *   Модуль загружает конфигурацию из аргументов командной строки, используя `json.loads(sys.argv[1])`.

2.  **Подготовка сообщений**:
    *   Извлекает список сообщений и последнее сообщение пользователя (если есть) из конфигурации.
    *   Преобразует список сообщений в формат, ожидаемый API You.com, с помощью функции `transform`.

3.  **Формирование параметров запроса**:
    *   Кодирует параметры запроса, включая преобразованные сообщения, в формат URL с помощью `urllib.parse.urlencode`.

4.  **Выполнение запроса к API You.com**:
    *   Выполняет потоковый GET-запрос к API You.com, используя библиотеку `requests` из `curl_cffi`.
    *   Функция `output` используется в качестве `content_callback` для обработки каждого чанка данных, полученного в процессе потоковой передачи.

5.  **Обработка ответа**:
    *   В функции `output`, если в чанке данных обнаружен маркер `"youChatToken"`, извлекается и печатается соответствующий токен.

6.  **Обработка ошибок и повторные попытки**:
    *   В случае возникновения ошибки при выполнении запроса, модуль выводит сообщение об ошибке и повторяет попытку.