# Модуль для взаимодействия с Phind API
=====================================================

Модуль содержит код для взаимодействия с API сервиса Phind. 
Он отправляет запросы с текстовыми запросами (prompts) и получает ответы от Phind API.

## Обзор
 
- Модуль использует библиотеку `curl_cffi` для отправки HTTP-запросов.
- Он обрабатывает ответы Phind API, включая разбор метаданных и вывод текста ответа.
- Модуль предоставляет функцию `output` для обработки фрагментов ответа от Phind API.

## Как работает модуль:

- **Инициализация**:
    - Считывает конфигурацию из аргумента командной строки.
    - Формирует JSON-запрос с информацией о текстовом запросе, модели, уровне сложности, дате, языке и других параметрах.
    - Устанавливает заголовки HTTP-запроса.

- **Отправка запроса**:
    - Использует `requests.post` для отправки запроса на Phind API.
    - Передает в качестве параметров:
        - URL Phind API
        - Заголовки HTTP-запроса
        - JSON-запрос
        - Функцию обратного вызова `output` для обработки ответа.
        - Таймаут для ожидания ответа.

- **Обработка ответа**:
    - Функция `output` получает фрагменты ответа Phind API.
    - Она проверяет, содержит ли фрагмент метаданные (`PHIND_METADATA`). 
    - Если нет - декодирует фрагмент в строку, очищает от лишних символов и выводит в консоль.

- **Обработка ошибок**:
    - Если при отправке запроса или обработке ответа возникает ошибка, модуль выводит сообщение об ошибке и повторяет попытку.

## Функции

### `output`
```python
def output(chunk):
    """ 
    Обрабатывает фрагмент ответа Phind API. 

    Args:
        chunk (bytes): Фрагмент ответа Phind API.

    Returns:
        None
    """
    try:
        if b'PHIND_METADATA' in chunk:
            return
        
        if chunk == b'data:  \\r\\ndata: \\r\\ndata: \\r\\n\\r\\n':
            chunk = b'data:  \\n\\r\\n\\r\\n'

        chunk = chunk.decode()

        chunk = chunk.replace('data: \\r\\n\\r\\ndata: ', 'data: \\n')
        chunk = chunk.replace('\\r\\ndata: \\r\\ndata: \\r\\n\\r\\n', '\\n\\r\\n\\r\\n')
        chunk = chunk.replace('data: ', '').replace('\\r\\n\\r\\n', '')

        print(chunk, flush=True, end = '')
        
    except json.decoder.JSONDecodeError:
        pass
```

**Назначение**: Обрабатывает фрагменты ответа Phind API.

**Параметры**:

- `chunk` (bytes): Фрагмент ответа Phind API.

**Возвращает**:

- `None`

**Как работает функция**:

- Проверяет, содержит ли фрагмент метаданные (`PHIND_METADATA`). Если да - ничего не делает.
- Декодирует фрагмент в строку.
- Очищает от лишних символов и выводит в консоль.
- Обрабатывает исключение `json.decoder.JSONDecodeError` в случае ошибки декодирования.

**Примеры**:

```python
# Пример вызова функции `output`
chunk = b'data:  \\r\\ndata: \\r\\ndata: \\r\\n\\r\\n'
output(chunk)

# Вывод:
# data:
```

```python
# Пример вызова функции `output` с метаданными
chunk = b'PHIND_METADATA'
output(chunk)

# Вывод:
# (ничего не выводится)
```

## Основные переменные
 
- `config`: Словарь конфигурации, считанный из аргумента командной строки.
- `prompt`: Текстовый запрос, полученный из конфигурации.
- `skill`: Уровень сложности, определенный на основе модели из конфигурации.
- `json_data`: JSON-запрос для отправки на Phind API.
- `headers`: Заголовки HTTP-запроса.

## Принцип работы
 
- Модуль получает конфигурацию, текстовый запрос, определяет уровень сложности и формирует JSON-запрос. 
- Затем отправляет запрос на Phind API, используя `requests.post`.
- Функция `output` обрабатывает фрагменты ответа Phind API, очищая от лишних символов и выводя в консоль.
- Модуль обрабатывает ошибки при отправке запроса и обработке ответа, повторяя попытку.

## Примеры
 
```python
# Пример запуска модуля с конфигурацией
python phind.py '{"messages": [{"role": "user", "content": "What is the capital of France?"}], "model": "gpt-4"}'

# Вывод:
# data:
# Paris
```

```python
# Пример запуска модуля с конфигурацией, содержащей метаданные
python phind.py '{"messages": [{"role": "user", "content": "What is the meaning of life?"}], "model": "gpt-4"}'

# Вывод:
# data:
# The meaning of life is a question that has been pondered by philosophers and theologians for centuries. There is no one definitive answer, and the meaning of life is likely to be different for each individual.
```