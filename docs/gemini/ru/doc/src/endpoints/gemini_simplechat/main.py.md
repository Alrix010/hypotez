# Модуль `gemini_simplechat.main`

## Обзор

Модуль представляет собой простой чат, использующий модель Google Gemini для обработки и генерации ответов. Он предоставляет API для взаимодействия с чатом через HTTP-запросы.

## Подробнее

Модуль включает в себя следующие компоненты:

- FastAPI приложение для обработки HTTP-запросов.
- Модель Google Gemini для генерации ответов.
- Pydantic модель для валидации входящих запросов.
- Настройки CORS для обеспечения безопасности при взаимодействии с другими доменами.

Модуль использует `src.logger` для логирования ошибок и отладочной информации.

## Классы

### `ChatRequest`

**Описание**: Pydantic модель, представляющая структуру запроса чата.

**Атрибуты**:
- `message` (str): Сообщение пользователя.

### `ChatRequest.message`

**Описание**: Текст сообщения, отправленного пользователем в чат.

## Функции

### `root`

**Назначение**: Обрабатывает GET-запросы к корневому пути ("/"). Возвращает HTML-страницу.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `HTMLResponse`: HTML-контент главной страницы.

**Вызывает исключения**:
- `HTTPException`: Если не удается прочитать шаблон HTML.

**Как работает функция**:
1. Функция пытается прочитать содержимое HTML-файла, указанного в `gs.fast_api.index_path`.
2. Если чтение успешно, функция возвращает HTML-контент в `HTMLResponse`.
3. Если возникает исключение при чтении файла, функция логирует ошибку и вызывает `HTTPException` с кодом состояния 500 и детальным описанием ошибки.

**Примеры**:

```python
# Пример успешного вызова
response = await root()
print(response.status_code) #  200
```

```python
# Пример неудачного вызова (ошибка чтения файла шаблона)
try:
    await root()
except HTTPException as ex:
    print(ex.status_code) #  500
    print(ex.detail) #  "Error reading templates: File not found"
```

### `chat`

**Назначение**: Обрабатывает POST-запросы к пути ("/api/chat"). Принимает сообщение от пользователя и возвращает ответ от модели Gemini.

**Параметры**:
- `request` (ChatRequest): Объект, содержащий сообщение пользователя.

**Возвращает**:
- `dict`: Словарь, содержащий ответ от модели Gemini.

**Вызывает исключения**:
- `HTTPException`: Если происходит ошибка во время взаимодействия с моделью Gemini.

**Как работает функция**:
1. Функция принимает объект `ChatRequest`, содержащий сообщение пользователя.
2. Функция вызывает метод `chat` модели Gemini, передавая сообщение пользователя.
3. Если вызов успешен, функция возвращает ответ от модели Gemini в виде словаря `{"response": response}`.
4. Если возникает исключение во время вызова модели Gemini, функция логирует ошибку и вызывает `HTTPException` с кодом состояния 500 и детальным описанием ошибки.

**Примеры**:

```python
# Пример успешного вызова
request = ChatRequest(message="Привет, как дела?")
response = await chat(request)
print(response) #  {"response": "Привет! У меня все хорошо, спасибо."}
```

```python
# Пример неудачного вызова (ошибка взаимодействия с моделью Gemini)
try:
    request = ChatRequest(message="Привет, как дела?")
    await chat(request)
except HTTPException as ex:
    print(ex.status_code) #  500
    print(ex.detail) #  "Ошибка при взаимодействии с моделью Gemini"
```

## Переменные модуля

- `app` (FastAPI): Инстанс FastAPI приложения.
- `system_instruction` (str): Инструкция для модели Gemini, загруженная из файла `instructions/system_instruction.md`.
- `model` (GoogleGenerativeAi): Инстанс модели Google Gemini, инициализированный с API-ключом и именем модели из настроек, а также с системной инструкцией.