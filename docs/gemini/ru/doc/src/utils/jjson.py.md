# Модуль `jjson`

## Обзор

Этот модуль предоставляет функции для работы с JSON-данными, такие как:

- Загрузка JSON-данных из файлов, строк или объектов.
- Сохранение JSON-данных в файлы.
- Преобразование между различными форматами данных (словари, списки, SimpleNamespace).
- Обработка ошибок при чтении и записи JSON-данных.
- Обеспечение возможности сохранения порядка элементов в JSON-данных.

## Подробней

Модуль `jjson`  предназначен для упрощения работы с JSON-данными в проекте `hypotez`. 

Он предоставляет функции `j_loads` и `j_loads_ns` для загрузки JSON-данных из различных источников, таких как файлы, строки или объекты. 
Функция `j_dumps`  используется для сохранения JSON-данных в файлы. 

Модуль  также предоставляет  функции для обработки ошибок при чтении и записи JSON-данных. 

## Классы

### `Config`

**Описание**: Класс конфигурации, который хранит значения констант для работы с модулем.
**Наследует**:  
**Атрибуты**:
- `MODE_WRITE` (str): Режим записи в файл: "w".
- `MODE_APPEND_START` (str): Режим добавления данных в начало файла: "a+".
- `MODE_APPEND_END` (str): Режим добавления данных в конец файла: "+a".

**Методы**:
-  
## Функции

### `_convert_to_dict`

**Назначение**: Преобразование объектов SimpleNamespace и списков в словари.

**Параметры**:
- `value` (Any): Данные для преобразования.

**Возвращает**:
- `Any`: Преобразованные данные.

**Как работает функция**:
- Проверяет тип данных `value`.
- Если `value` - объект SimpleNamespace, функция извлекает атрибуты объекта и рекурсивно преобразует их в словари, используя функцию `_convert_to_dict`.
- Если `value` - словарь, функция рекурсивно преобразует значения в словаре, используя функцию `_convert_to_dict`.
- Если `value` - список, функция рекурсивно преобразует элементы списка, используя функцию `_convert_to_dict`.
- В остальных случаях функция возвращает исходные данные.

**Примеры**:
-  ```python
>>> _convert_to_dict(SimpleNamespace(a=1, b=2))
{'a': 1, 'b': 2}
>>> _convert_to_dict({'a': 1, 'b': [2, 3]})
{'a': 1, 'b': [2, 3]}
>>> _convert_to_dict([1, 2, {'c': 3}])
[1, 2, {'c': 3}]
```

### `_read_existing_data`

**Назначение**: Чтение существующих JSON-данных из файла.

**Параметры**:
- `path` (Path): Путь к файлу.
- `exc_info` (bool, optional): Если `True`, выводит служебную информацию об исключении при ошибке. По умолчанию `True`.

**Возвращает**:
- `dict`: Данные из файла в формате словаря.

**Как работает функция**:
- Считывает содержимое файла, используя метод `path.read_text()`.
- Декодирует содержимое файла с использованием `json.loads()`.
- Возвращает результат декодирования.
- Если возникает ошибка при декодировании или чтении файла, функция записывает сообщение об ошибке в лог и возвращает пустой словарь.

**Примеры**:
-  ```python
>>> _read_existing_data(Path("data.json"))
{'key1': 'value1', 'key2': 'value2'}
>>> _read_existing_data(Path("invalid.json")) # файл invalid.json содержит некорректные JSON-данные
{}
```

### `_merge_data`

**Назначение**: Объединение новых данных с существующими данными.

**Параметры**:
- `data` (Dict): Новые данные.
- `existing_data` (Dict): Существующие данные.
- `mode` (str): Режим объединения: `Config.MODE_APPEND_START` для добавления данных в начало, `Config.MODE_APPEND_END` для добавления данных в конец.

**Возвращает**:
- `Dict`: Объединенные данные.

**Как работает функция**:
- Проверяет тип данных `data` и `existing_data`.
- Если оба типа - списки, функция объединяет их в соответствии с режимом `mode`.
- Если оба типа - словари, функция обновляет существующий словарь новыми данными.
- В остальных случаях функция возвращает `data`.

**Примеры**:
-  ```python
>>> _merge_data({'a': 1, 'b': 2}, {'c': 3, 'd': 4}, Config.MODE_APPEND_START)
{'c': 3, 'd': 4, 'a': 1, 'b': 2}
>>> _merge_data({'a': 1, 'b': 2}, {'c': 3, 'd': 4}, Config.MODE_APPEND_END)
{'a': 1, 'b': 2, 'c': 3, 'd': 4}
```

### `j_dumps`

**Назначение**: Сохранение JSON-данных в файл.

**Параметры**:
- `data` (Dict | SimpleNamespace | List[Dict] | List[SimpleNamespace]): JSON-совместимые данные или объекты SimpleNamespace для сохранения.
- `file_path` (Optional[Path], optional): Путь к выходному файлу. Если `None`, возвращает JSON как словарь. По умолчанию `None`.
- `ensure_ascii` (bool, optional): Если `True`, экранирует не-ASCII символы в выводе. По умолчанию `False`.
- `mode` (str, optional): Режим открытия файла (`'w'`, `'a+'`, `'+a'`). По умолчанию `'w'`.
- `exc_info` (bool, optional): Если `True`, выводит служебную информацию об исключении при ошибке. По умолчанию `True`.

**Возвращает**:
- `Optional[Dict]`: JSON-данные как словарь, если все прошло успешно, или `None`, если возникла ошибка.

**Вызывает исключения**:
- `ValueError`: Если режим открытия файла не поддерживается.

**Как работает функция**:
- Преобразует входные данные в словарь, используя функцию `_convert_to_dict`.
- Если задан путь к файлу, функция проверяет существование файла и режим открытия.
- Читает существующие данные из файла, если режим открытия - `Config.MODE_APPEND_START` или `Config.MODE_APPEND_END`.
- Объединяет существующие данные с новыми, используя функцию `_merge_data`.
- Записывает объединенные данные в файл, используя `json.dump`.
- Возвращает `data` или `None` в случае ошибки.

**Примеры**:
-  ```python
>>> j_dumps({'a': 1, 'b': 2}, file_path="data.json")
{'a': 1, 'b': 2}
>>> j_dumps([{'a': 1, 'b': 2}, {'c': 3, 'd': 4}], file_path="data.json", mode="a+") # Добавление данных в начало файла
[{'a': 1, 'b': 2}, {'c': 3, 'd': 4}, {'a': 1, 'b': 2}, {'c': 3, 'd': 4}]
```

### `_decode_strings`

**Назначение**: Рекурсивное декодирование строк в структуре данных.

**Параметры**:
- `data` (Any): Данные для декодирования.

**Возвращает**:
- `Any`: Декодированные данные.

**Как работает функция**:
- Проверяет тип данных `data`.
- Если `data` - строка, функция пытается декодировать ее с использованием `codecs.decode()`.
- Если `data` - список, функция рекурсивно декодирует элементы списка, используя функцию `_decode_strings`.
- Если `data` - словарь, функция рекурсивно декодирует ключи и значения словаря, используя функцию `_decode_strings`.
- В остальных случаях функция возвращает исходные данные.

**Примеры**:
-  ```python
>>> _decode_strings("test\\u0020string")
'test string'
>>> _decode_strings(['test\\u0020string', {'a': '\\u0020b'}])
['test string', {'a': ' b'}]
```

### `_string_to_dict`

**Назначение**: Удаление разметки Markdown и преобразование строки в словарь.

**Параметры**:
- `json_string` (str): Строка с JSON-данными.

**Возвращает**:
- `dict`: Словарь, полученный из JSON-строки.

**Как работает функция**:
- Проверяет, начинается ли строка с "```" или "```json" и заканчивается ли она "```" или "```\n". 
- Если да, удаляет разметку Markdown, используя `strip()` и `replace()`.
- Преобразует JSON-строку в словарь, используя `json.loads()`.
- Возвращает результат преобразования.
- Если возникает ошибка при преобразовании, функция записывает сообщение об ошибке в лог и возвращает пустой словарь.

**Примеры**:
-  ```python
>>> _string_to_dict("```json\n{'a': 1, 'b': 2}\n```")
{'a': 1, 'b': 2}
>>> _string_to_dict("```\n{'a': 1, 'b': 2}\n```")
{'a': 1, 'b': 2}
```

### `j_loads`

**Назначение**: Загрузка JSON-данных из файла, каталога, строки или объекта.

**Параметры**:
- `jjson` (dict | SimpleNamespace | str | Path | list): Путь к файлу/каталогу, JSON-строка или JSON-объект.
- `ordered` (bool, optional): Использовать `OrderedDict` для сохранения порядка элементов. По умолчанию `True`.

**Возвращает**:
- `dict | list`: Обработанные данные (словарь или список словарей).

**Вызывает исключения**:
- `FileNotFoundError`: Если заданный файл не найден.
- `json.JSONDecodeError`: Если JSON-данные не могут быть обработаны.

**Как работает функция**:
- Проверяет тип данных `jjson`.
- Если `jjson` - объект SimpleNamespace, функция преобразует его в словарь.
- Если `jjson` - путь к каталогу, функция рекурсивно считывает все файлы с расширением `.json` из каталога и возвращает список обработанных данных.
- Если `jjson` - путь к файлу, функция считывает содержимое файла и декодирует его с использованием `json.loads()`.
- Если `jjson` - строка, функция преобразует строку в словарь с использованием `_string_to_dict()`.
- Если `jjson` - список, функция декодирует строки в списке, используя `_decode_strings()`.
- Если `jjson` - словарь, функция декодирует строки в словаре, используя `_decode_strings()`.
- Возвращает результат обработки данных.
- Если возникает ошибка при чтении файла или декодировании данных, функция записывает сообщение об ошибке в лог и возвращает пустой словарь или список.

**Примеры**:
-  ```python
>>> j_loads(Path("data.json"))
{'key1': 'value1', 'key2': 'value2'}
>>> j_loads("```json\n{'a': 1, 'b': 2}\n```")
{'a': 1, 'b': 2}
>>> j_loads("{'a': 1, 'b': 2}")
{'a': 1, 'b': 2}
>>> j_loads([{'a': 1, 'b': 2}, {'c': 3, 'd': 4}])
[{'a': 1, 'b': 2}, {'c': 3, 'd': 4}]
>>> j_loads(Path("data_dir")) # data_dir - каталог с файлами json
[{'key1': 'value1', 'key2': 'value2'}, {'key3': 'value3', 'key4': 'value4'}]
```

### `j_loads_ns`

**Назначение**: Загрузка JSON-данных и преобразование в SimpleNamespace.

**Параметры**:
- `jjson` (Path | SimpleNamespace | Dict | str): Путь к файлу, SimpleNamespace, словарь или строка с JSON-данными.
- `ordered` (bool, optional): Использовать `OrderedDict` для сохранения порядка элементов. По умолчанию `True`.

**Возвращает**:
- `SimpleNamespace | List[SimpleNamespace] | Dict`: Обработанные данные (SimpleNamespace, список SimpleNamespace или словарь).

**Как работает функция**:
- Загружает JSON-данные с использованием функции `j_loads`.
- Если данные представлены списком, функция преобразует каждый элемент списка в SimpleNamespace, используя функцию `dict2ns`.
- Если данные представлены словарем, функция преобразует словарь в SimpleNamespace, используя функцию `dict2ns`.
- Возвращает обработанные данные.

**Примеры**:
-  ```python
>>> j_loads_ns(Path("data.json"))
SimpleNamespace(key1='value1', key2='value2')
>>> j_loads_ns("```json\n{'a': 1, 'b': 2}\n```")
SimpleNamespace(a=1, b=2)
>>> j_loads_ns([{'a': 1, 'b': 2}, {'c': 3, 'd': 4}])
[SimpleNamespace(a=1, b=2), SimpleNamespace(c=3, d=4)]
```

## Параметры

- `ensure_ascii` (bool, optional): Если `True`, экранирует не-ASCII символы в выводе. По умолчанию `False`.
- `mode` (str, optional): Режим открытия файла (`'w'`, `'a+'`, `'+a'`). По умолчанию `'w'`.
- `exc_info` (bool, optional): Если `True`, выводит служебную информацию об исключении при ошибке. По умолчанию `True`.
- `ordered` (bool, optional): Использовать `OrderedDict` для сохранения порядка элементов. По умолчанию `True`.

## Примеры

### Загрузка JSON-данных из файла:

```python
from pathlib import Path
from src.utils.jjson import j_loads

# Загрузка JSON-данных из файла "data.json"
data = j_loads(Path("data.json"))

# Вывод данных
print(data)
```

### Сохранение JSON-данных в файл:

```python
from pathlib import Path
from src.utils.jjson import j_dumps

# Данные для сохранения
data = {'key1': 'value1', 'key2': 'value2'}

# Сохранение данных в файл "data.json"
j_dumps(data, file_path="data.json")
```

### Преобразование SimpleNamespace в словарь:

```python
from src.utils.jjson import _convert_to_dict

# Создание объекта SimpleNamespace
ns = SimpleNamespace(a=1, b=2)

# Преобразование объекта SimpleNamespace в словарь
data = _convert_to_dict(ns)

# Вывод данных
print(data)
```

### Обработка ошибок при чтении JSON-данных:

```python
from pathlib import Path
from src.utils.jjson import j_loads

# Попытка загрузки JSON-данных из файла "invalid.json" (файл содержит некорректные JSON-данные)
data = j_loads(Path("invalid.json"))

# Проверка результата
if data:
    # Если данные были успешно загружены
    print(data)
else:
    # Если возникла ошибка при чтении данных
    print("Ошибка при чтении JSON-данных")
```

### Сохранение порядка элементов в JSON-данных:

```python
from pathlib import Path
from src.utils.jjson import j_dumps

# Данные для сохранения
data = {'a': 1, 'b': 2, 'c': 3}

# Сохранение данных в файл "data.json" с использованием OrderedDict
j_dumps(data, file_path="data.json", ordered=True)