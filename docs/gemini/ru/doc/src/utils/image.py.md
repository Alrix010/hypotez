# Модуль `src.utils.image`

## Обзор

Модуль `src.utils.image` предоставляет асинхронные функции для загрузки, сохранения и обработки изображений. Он включает в себя функциональность для сохранения изображений из URL-адресов, сохранения данных изображений в файлы, получения данных изображений, поиска случайных изображений в каталогах, добавления водяных знаков, изменения размера и преобразования форматов изображений.

## Подробней

Модуль предоставляет инструменты для работы с изображениями, такие как загрузка и сохранение изображений, наложение водяных знаков, изменение размеров и преобразование форматов. Функции модуля асинхронны, что позволяет эффективно обрабатывать изображения, не блокируя основной поток выполнения.

## Классы

### `ImageError`

**Описание**: Пользовательское исключение для ошибок, связанных с изображениями.

**Наследует**: `Exception`

## Функции

### `save_image_from_url_async`

**Назначение**: Асинхронно загружает изображение из URL и сохраняет его локально.

```python
async def save_image_from_url_async(image_url: str, filename: Union[str, Path]) -> Optional[str]:
    """
    Загружает изображение из URL и сохраняет его локально асинхронно.

    Args:
        image_url (str): URL для загрузки изображения.
        filename (Union[str, Path]): Имя файла для сохранения изображения.

    Returns:
        Optional[str]: Путь к сохраненному файлу или None, если операция не удалась.

    Raises:
        ImageError: Если загрузка или сохранение изображения не удались.
    """
```

**Параметры**:

-   `image_url` (str): URL-адрес изображения, которое необходимо загрузить.
-   `filename` (Union[str, Path]): Имя файла (путь), под которым изображение будет сохранено локально.

**Возвращает**:

-   `Optional[str]`: Путь к сохраненному файлу изображения в случае успеха, `None` в случае неудачи.

**Вызывает исключения**:

-   `ImageError`: Вызывается, если не удается загрузить изображение по указанному URL-адресу или сохранить его в указанный файл.

**Как работает функция**:

1.  Функция принимает URL-адрес изображения и имя файла для сохранения.
2.  Использует `aiohttp` для асинхронной загрузки изображения из URL.
3.  В случае успешной загрузки вызывает функцию `save_image_async` для сохранения полученных данных в файл.
4.  При возникновении исключений в процессе загрузки или сохранения логирует ошибку и возвращает `None`.

**Примеры**:

```python
import asyncio
from pathlib import Path

async def main():
    url = "https://www.easygifanimator.net/images/samples/video-to-gif-sample.gif"
    filename = Path("downloaded_image.gif")
    result = await save_image_from_url_async(url, filename)
    if result:
        print(f"Image saved to {result}")
    else:
        print("Failed to save image.")

asyncio.run(main())
```

### `save_image`

**Назначение**: Сохраняет данные изображения в файл в указанном формате.

```python
def save_image(image_data: bytes, file_name: str | Path, format: str = 'PNG') -> Optional[str]:
    """
    Сохраняет данные изображения в файл в указанном формате.

    Args:
        image_data (bytes): Двоичные данные изображения.
        file_name (Union[str, Path]): Имя файла для сохранения изображения.
        format (str): Формат для сохранения изображения, по умолчанию PNG.

    Returns:
        Optional[str]: Путь к сохраненному файлу или None, если операция не удалась.

    Raises:
        ImageError: Если файл не может быть создан, сохранен, или если сохраненный файл пуст.
    """
```

**Параметры**:

-   `image_data` (bytes): Бинарные данные изображения, которые необходимо сохранить в файл.
-   `file_name` (Union[str, Path]): Имя файла (путь), по которому изображение будет сохранено.
-   `format` (str, optional): Формат изображения, в котором оно будет сохранено. По умолчанию `'PNG'`.

**Возвращает**:

-   `Optional[str]`: Путь к сохраненному файлу изображения в случае успеха, `None` в случае неудачи.

**Вызывает исключения**:

-   `ImageError`: Вызывается, если не удается создать директорию, сохранить файл или если сохраненный файл окажется пустым.

**Как работает функция**:

1.  Функция принимает бинарные данные изображения, имя файла и формат для сохранения.
2.  Создает директорию для файла, если она не существует.
3.  Использует `BytesIO` для работы с данными изображения в памяти.
4.  Открывает изображение с помощью `PIL.Image.open()`.
5.  Сохраняет изображение в указанном формате, используя `img.save()`.
6.  Проверяет, был ли создан файл, и не является ли он пустым.
7.  В случае успеха возвращает путь к сохраненному файлу, в случае неудачи логирует ошибку и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования с бинарными данными изображения
image_data = b"\\x89PNG\\r\\n\\x1A\\n\\x00\\x00\\x00\\rIHDR\\x00..."  # Замените на реальные бинарные данные
file_name = Path("saved_image.png")
result = save_image(image_data, file_name)

if result:
    print(f"Image saved to {result}")
else:
    print("Failed to save image.")
```

### `save_image_async`

**Назначение**: Асинхронно сохраняет данные изображения в файл в указанном формате.

```python
async def save_image_async(image_data: bytes, file_name: str | Path, format: str = 'PNG') -> Optional[str]:
    """
    Сохраняет данные изображения в файл в указанном формате асинхронно.

    Args:
        image_data (bytes): Двоичные данные изображения.
        file_name (Union[str, Path]): Имя файла для сохранения изображения.
        format (str): Формат для сохранения изображения, по умолчанию PNG.

    Returns:
        Optional[str]: Путь к сохраненному файлу или None, если операция не удалась.

    Raises:
        ImageError: Если файл не может быть создан, сохранен, или если сохраненный файл пуст.
    """
```

**Параметры**:

-   `image_data` (bytes): Бинарные данные изображения, которые необходимо сохранить в файл.
-   `file_name` (Union[str, Path]): Имя файла (путь), по которому изображение будет сохранено.
-   `format` (str, optional): Формат изображения, в котором оно будет сохранено. По умолчанию `'PNG'`.

**Возвращает**:

-   `Optional[str]`: Путь к сохраненному файлу изображения в случае успеха, `None` в случае неудачи.

**Вызывает исключения**:

-   `ImageError`: Вызывается, если не удается создать директорию, сохранить файл или если сохраненный файл окажется пустым.

**Как работает функция**:

1.  Функция принимает бинарные данные изображения, имя файла и формат для сохранения.
2.  Асинхронно создает директорию для файла, если она не существует, используя `asyncio.to_thread`.
3.  Использует `aiofiles` для асинхронной записи данных изображения в файл.
4.  Проверяет, был ли создан файл, и не является ли он пустым.
5.  В случае успеха возвращает путь к сохраненному файлу, в случае неудачи логирует ошибку и возвращает `None`.

**Примеры**:

```python
import asyncio
from pathlib import Path

async def main():
    # Пример использования с бинарными данными изображения
    image_data = b"\\x89PNG\\r\\n\\x1A\\n\\x00\\x00\\x00\\rIHDR\\x00..."  # Замените на реальные бинарные данные
    file_name = Path("saved_image_async.png")
    result = await save_image_async(image_data, file_name)

    if result:
        print(f"Image saved to {result}")
    else:
        print("Failed to save image.")

asyncio.run(main())
```

### `get_image_bytes`

**Назначение**: Читает изображение и возвращает его байты в формате JPEG.

```python
def get_image_bytes(image_path: Path, raw: bool = True) -> Optional[BytesIO | bytes]:
    """
    Читает изображение, используя Pillow, и возвращает его байты в формате JPEG.

    Args:
        image_path (Path): Путь к файлу изображения.
        raw (bool): Если True, возвращает объект BytesIO; иначе возвращает bytes. По умолчанию True.

    Returns:
        Optional[Union[BytesIO, bytes]]: Байты изображения в формате JPEG или None, если произошла ошибка.
    """
```

**Параметры**:

-   `image_path` (Path): Путь к файлу изображения, который необходимо прочитать.
-   `raw` (bool, optional): Определяет, какой тип данных возвращать. Если `True`, возвращается объект `BytesIO`. Если `False`, возвращаются байты (`bytes`). По умолчанию `True`.

**Возвращает**:

-   `Optional[Union[BytesIO, bytes]]`: Байты изображения в формате JPEG. Если `raw` равно `True`, возвращается объект `BytesIO`, иначе возвращается `bytes`. В случае ошибки возвращается `None`.

**Как работает функция**:

1.  Функция принимает путь к файлу изображения и флаг, определяющий формат возвращаемых данных.
2.  Открывает изображение с помощью `PIL.Image.open()`.
3.  Сохраняет изображение в формате JPEG в объект `BytesIO`.
4.  В зависимости от значения флага `raw` возвращает либо объект `BytesIO`, либо байты изображения.
5.  В случае ошибки логирует её и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
image_path = Path("example.png")  # Замените на путь к существующему файлу изображения
image_bytes = get_image_bytes(image_path)

if image_bytes:
    if isinstance(image_bytes, BytesIO):
        print("Image bytes (BytesIO):", image_bytes.getvalue()[:20], "...")  # Вывод первых 20 байт
    else:
        print("Image bytes (bytes):", image_bytes[:20], "...")  # Вывод первых 20 байт
else:
    print("Failed to read image.")
```

### `get_raw_image_data`

**Назначение**: Получает бинарные данные файла.

```python
def get_raw_image_data(file_name: Union[str, Path]) -> Optional[bytes]:
    """
    Извлекает необработанные двоичные данные файла, если он существует.

    Args:
        file_name (Union[str, Path]): Имя или путь файла для чтения.

    Returns:
        Optional[bytes]: Двоичные данные файла или None, если файл не существует или произошла ошибка.
    """
```

**Параметры**:

-   `file_name` (Union[str, Path]): Имя файла (путь), из которого необходимо прочитать данные.

**Возвращает**:

-   `Optional[bytes]`: Бинарные данные файла. Возвращает `None`, если файл не существует или произошла ошибка при чтении.

**Как работает функция**:

1.  Функция принимает имя файла (путь).
2.  Проверяет, существует ли файл.
3.  Если файл существует, пытается прочитать его бинарные данные с помощью `file_path.read_bytes()`.
4.  В случае успеха возвращает бинарные данные.
5.  В случае ошибки (например, если файл не существует или нет прав доступа) логирует ошибку и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
file_name = Path("example.txt")  # Замените на путь к существующему файлу
file_data = get_raw_image_data(file_name)

if file_data:
    print("File data:", file_data[:20], "...")  # Вывод первых 20 байт
else:
    print("Failed to read file.")
```

### `random_image`

**Назначение**: Рекурсивно ищет случайное изображение в указанном каталоге.

```python
def random_image(root_path: Union[str, Path]) -> Optional[str]:
    """
    Рекурсивно ищет случайное изображение в указанном каталоге.

    Args:
        root_path (Union[str, Path]): Каталог для поиска изображений.

    Returns:
        Optional[str]: Путь к случайному изображению или None, если изображения не найдены.
    """
```

**Параметры**:

-   `root_path` (Union[str, Path]): Путь к каталогу, в котором будет производиться поиск случайного изображения.

**Возвращает**:

-   `Optional[str]`: Путь к случайному изображению в виде строки. Если в указанном каталоге или его подкаталогах не найдено ни одного изображения, функция возвращает `None`.

**Как работает функция**:

1.  Функция принимает путь к каталогу, в котором нужно найти случайное изображение.
2.  Определяет список допустимых расширений файлов изображений (`.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`).
3.  Рекурсивно обходит все файлы в указанном каталоге и его подкаталогах с помощью `root_path.rglob("*")`.
4.  Фильтрует файлы, оставляя только те, которые являются файлами (не каталогами) и имеют одно из допустимых расширений.
5.  Если найден хотя бы один файл изображения, функция случайно выбирает один из них с помощью `random.choice()` и возвращает его путь в виде строки.
6.  Если не найдено ни одного файла изображения, функция логирует предупреждение и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
root_path = Path("images")  # Замените на путь к каталогу с изображениями
random_image_path = random_image(root_path)

if random_image_path:
    print("Random image path:", random_image_path)
else:
    print("No images found.")
```

### `add_text_watermark`

**Назначение**: Добавляет текстовый водяной знак на изображение.

```python
def add_text_watermark(image_path: str | Path, watermark_text: str, output_path: Optional[str | Path] = None) -> Optional[str]:
    """
    Добавляет текстовый водяной знак на изображение.

    Args:
        image_path (Union[str, Path]): Путь к файлу изображения.
        watermark_text (str): Текст для использования в качестве водяного знака.
        output_path (Optional[Union[str, Path]]): Путь для сохранения изображения с водяным знаком.
            По умолчанию перезаписывает исходное изображение.

    Returns:
        Optional[str]: Путь к изображению с водяным знаком или None в случае сбоя.
    """
```

**Параметры**:

-   `image_path` (Union[str, Path]): Путь к исходному изображению, на которое необходимо добавить водяной знак.
-   `watermark_text` (str): Текст, который будет использоваться в качестве водяного знака.
-   `output_path` (Optional[Union[str, Path]]): Путь для сохранения изображения с водяным знаком. Если не указан, исходное изображение будет перезаписано.

**Возвращает**:

-   `Optional[str]`: Путь к изображению с добавленным водяным знаком. В случае успеха возвращается путь к файлу. Если произошла ошибка, возвращается `None`.

**Как работает функция**:

1.  Функция принимает путь к изображению, текст водяного знака и (необязательно) путь для сохранения результата.
2.  Открывает изображение с помощью `PIL.Image.open()` и конвертирует его в формат RGBA.
3.  Создает прозрачный слой для водяного знака.
4.  Определяет размер шрифта на основе размеров изображения.
5.  Пытается загрузить шрифт "arial.ttf", если не удается — использует шрифт по умолчанию.
6.  Вычисляет координаты для размещения текста водяного знака по центру изображения.
7.  Рисует текст на прозрачном слое.
8.  Объединяет исходное изображение и слой с водяным знаком.
9.  Сохраняет результирующее изображение.
10. В случае успеха возвращает путь к сохраненному файлу, в случае ошибки логирует её и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
image_path = Path("input.png")  # Замените на путь к существующему файлу изображения
watermark_text = "Sample Watermark"
output_path = Path("output_watermarked.png")
result = add_text_watermark(image_path, watermark_text, output_path)

if result:
    print(f"Watermarked image saved to {result}")
else:
    print("Failed to add watermark.")
```

### `add_image_watermark`

**Назначение**: Добавляет водяной знак в виде изображения на другое изображение.

```python
def add_image_watermark(input_image_path: Path, watermark_image_path: Path, output_image_path: Optional[Path] = None) -> Optional[Path]:
    """
    Добавляет водяной знак на изображение и сохраняет результат по указанному пути вывода.

    Args:
        input_image_path (Path): Путь к исходному изображению.
        watermark_image_path (Path): Путь к изображению водяного знака.
        output_image_path (Optional[Path]): Путь для сохранения изображения с водяным знаком.
            Если не указан, изображение будет сохранено в каталоге "output".

    Returns:
        Optional[Path]: Путь к сохраненному изображению с водяным знаком или None, если операция не удалась.
    """
```

**Параметры**:

-   `input_image_path` (Path): Путь к исходному изображению, на которое будет добавлен водяной знак.
-   `watermark_image_path` (Path): Путь к изображению, которое будет использоваться в качестве водяного знака.
-   `output_image_path` (Optional[Path]): Путь, по которому будет сохранено изображение с водяным знаком. Если не указан, изображение будет сохранено в подкаталоге "output" исходного каталога.

**Возвращает**:

-   `Optional[Path]`: Путь к сохраненному изображению с водяным знаком. Если водяной знак не удалось добавить, возвращается `None`.

**Как работает функция**:

1.  Функция принимает пути к исходному изображению и изображению водяного знака, а также необязательный путь для сохранения результата.
2.  Открывает исходное изображение и изображение водяного знака с помощью `PIL.Image.open()`.
3.  Изменяет размер изображения водяного знака, чтобы его ширина составляла 8% от ширины исходного изображения.
4.  Вычисляет позицию для размещения водяного знака в нижнем правом углу исходного изображения с отступом в 20 пикселей.
5.  Создает новое прозрачное изображение того же размера, что и исходное.
6.  Вставляет исходное изображение и изображение водяного знака на прозрачное изображение.
7.  Сохраняет полученное изображение в указанный путь, при необходимости создавая каталог "output".
8.  В случае успеха возвращает путь к сохраненному файлу, в случае ошибки логирует её и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
input_image_path = Path("input.png")  # Замените на путь к существующему файлу изображения
watermark_image_path = Path("watermark.png")  # Замените на путь к существующему файлу водяного знака
output_image_path = Path("output_watermarked.png")
result = add_image_watermark(input_image_path, watermark_image_path, output_image_path)

if result:
    print(f"Watermarked image saved to {result}")
else:
    print("Failed to add watermark.")
```

### `resize_image`

**Назначение**: Изменяет размер изображения до указанных размеров.

```python
def resize_image(image_path: Union[str, Path], size: Tuple[int, int], output_path: Optional[Union[str, Path]] = None) -> Optional[str]:
    """
    Изменяет размер изображения до указанных размеров.

    Args:
        image_path (Union[str, Path]): Путь к файлу изображения.
        size (Tuple[int, int]): Кортеж, содержащий желаемую ширину и высоту изображения.
        output_path (Optional[Union[str, Path]]): Путь для сохранения изображения измененного размера.
            По умолчанию перезаписывает исходное изображение.

    Returns:
        Optional[str]: Путь к изображению измененного размера или None в случае сбоя.
    """
```

**Параметры**:

-   `image_path` (Union[str, Path]): Путь к изображению, размер которого необходимо изменить.
-   `size` (Tuple[int, int]): Кортеж, содержащий новую ширину и высоту изображения (в пикселях).
-   `output_path` (Optional[Union[str, Path]]): Путь для сохранения измененного изображения. Если не указан, исходное изображение будет перезаписано.

**Возвращает**:

-   `Optional[str]`: Путь к изображению измененного размера. В случае успеха возвращается путь к файлу. Если произошла ошибка, возвращается `None`.

**Как работает функция**:

1.  Функция принимает путь к изображению, желаемые размеры и (необязательно) путь для сохранения результата.
2.  Открывает изображение с помощью `PIL.Image.open()`.
3.  Изменяет размер изображения с помощью `img.resize(size)`.
4.  Сохраняет измененное изображение.
5.  В случае успеха возвращает путь к сохраненному файлу, в случае ошибки логирует её и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
image_path = Path("input.png")  # Замените на путь к существующему файлу изображения
size = (500, 300)  # Новые размеры изображения (ширина, высота)
output_path = Path("output_resized.png")
result = resize_image(image_path, size, output_path)

if result:
    print(f"Resized image saved to {result}")
else:
    print("Failed to resize image.")
```

### `convert_image`

**Назначение**: Преобразует изображение в указанный формат.

```python
def convert_image(image_path: Union[str, Path], format: str, output_path: Optional[Union[str, Path]] = None) -> Optional[str]:
    """
    Преобразует изображение в указанный формат.

    Args:
        image_path (Union[str, Path]): Путь к файлу изображения.
        format (str): Формат для преобразования изображения (например, "JPEG", "PNG").
        output_path (Optional[Union[str, Path]]): Путь для сохранения преобразованного изображения.
            По умолчанию перезаписывает исходное изображение.

    Returns:
        Optional[str]: Путь к преобразованному изображению или None в случае сбоя.
    """
```

**Параметры**:

-   `image_path` (Union[str, Path]): Путь к изображению, которое необходимо преобразовать.
-   `format` (str): Формат, в который нужно преобразовать изображение (например, `"JPEG"`, `"PNG"`).
-   `output_path` (Optional[Union[str, Path]]): Путь для сохранения преобразованного изображения. Если не указан, исходное изображение будет перезаписано.

**Возвращает**:

-   `Optional[str]`: Путь к преобразованному изображению. В случае успеха возвращается путь к файлу. Если произошла ошибка, возвращается `None`.

**Как работает функция**:

1.  Функция принимает путь к изображению, желаемый формат и (необязательно) путь для сохранения результата.
2.  Открывает изображение с помощью `PIL.Image.open()`.
3.  Сохраняет изображение в указанном формате с помощью `img.save(output_path, format=format)`.
4.  В случае успеха возвращает путь к сохраненному файлу, в случае ошибки логирует её и возвращает `None`.

**Примеры**:

```python
from pathlib import Path

# Пример использования
image_path = Path("input.png")  # Замените на путь к существующему файлу изображения
format = "JPEG"  # Формат для преобразования
output_path = Path("output_converted.jpg")
result = convert_image(image_path, format, output_path)

if result:
    print(f"Converted image saved to {result}")
else:
    print("Failed to convert image.")
```

### `process_images_with_watermark`

**Назначение**: Обрабатывает все изображения в указанной папке, добавляя водяной знак и сохраняя их в каталоге "output".

```python
def process_images_with_watermark(folder_path: Path, watermark_path: Path) -> None:
    """
    Обрабатывает все изображения в указанной папке, добавляя водяной знак и сохраняя их в каталоге "output".

    Args:
        folder_path (Path): Путь к папке, содержащей изображения.
        watermark_path (Path): Путь к изображению водяного знака.
    """
```

**Параметры**:

-   `folder_path` (Path): Путь к папке, в которой находятся изображения для обработки.
-   `watermark_path` (Path): Путь к изображению, которое будет использоваться в качестве водяного знака.

**Как работает функция**:

1.  Функция принимает путь к папке с изображениями и путь к изображению водяного знака.
2.  Проверяет, существует ли указанная папка. Если нет, логирует ошибку и завершает работу.
3.  Создает подкаталог "output" в указанной папке, если он еще не существует.
4.  Перебирает все файлы в указанной папке.
5.  Для каждого файла проверяет, является ли он изображением (имеет расширение `.png`, `.jpg` или `.jpeg`).
6.  Если файл является изображением, вызывает функцию `add_image_watermark` для добавления водяного знака.
7.  Сохраняет изображение с водяным знаком в подкаталог "output".

**Примеры**:

```python
from pathlib import Path

# Пример использования
folder_path = Path("images")  # Замените на путь к папке с изображениями
watermark_path = Path("watermark.png")  # Замените на путь к файлу водяного знака
process_images_with_watermark(folder_path, watermark_path)