# Модуль для поиска свободного порта

## Обзор

Модуль предназначен для поиска свободного порта на указанном хосте. Он может искать порт в заданном диапазоне или находить первый доступный порт, если диапазон не указан.

## Подробней

Этот модуль предоставляет функцию `get_free_port`, которая позволяет определить свободный порт для использования в сетевых приложениях. Модуль использует сокеты для проверки доступности портов и может работать как с одиночным диапазоном портов, так и со списком диапазонов.

## Функции

### `get_free_port`

**Назначение**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

**Параметры**:

- `host` (str): Адрес хоста для проверки доступности портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, указанный как строка "min-max" или список строк. Например: "3000-3999", ["3000-3999", "8000-8010"], `None`. По умолчанию `None`.

**Возвращает**:

- `int`: Доступный номер порта.

**Вызывает исключения**:

- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Внутренние функции**:

#### `_is_port_in_use`

   **Назначение**: Проверяет, используется ли указанный порт на заданном хосте.

   **Параметры**:

   - `host` (str): Адрес хоста.
   - `port` (int): Номер порта для проверки.

   **Возвращает**:

   - `bool`: `True`, если порт используется, `False` в противном случае.

   **Как работает функция**:

   Функция создает сокет и пытается привязать его к указанному хосту и порту. Если привязка успешна, функция возвращает `False`, что означает, что порт свободен. Если возникает исключение `OSError`, это означает, что порт уже используется, и функция возвращает `True`.

#### `_parse_port_range`

   **Назначение**: Разбирает строку диапазона портов "min-max" в кортеж `(min_port, max_port)`.

   **Параметры**:

   - `port_range_str` (str): Строка диапазона портов.

   **Возвращает**:

   - `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

   **Вызывает исключения**:

   - `ValueError`: Если формат строки диапазона портов недействителен.

   **Как работает функция**:

   Функция разделяет строку `port_range_str` по символу `-`. Если разделение не дает ровно два элемента, или если минимальный порт больше или равен максимальному, функция логирует ошибку и вызывает исключение `ValueError`. В противном случае функция преобразует оба элемента в целые числа и возвращает их в виде кортежа.

**Как работает функция `get_free_port`**:

1.  Функция проверяет, задан ли параметр `port_range`.
2.  Если `port_range` является строкой, функция пытается разобрать её с помощью `_parse_port_range`.
3.  Если `port_range` является списком, функция перебирает элементы списка и пытается разобрать каждый элемент как диапазон портов.
4.  Если `port_range` не задан, функция начинает поиск свободного порта с номера 1024 и увеличивает его, пока не найдет свободный.
5.  В каждом диапазоне функция перебирает порты и проверяет их доступность с помощью `_is_port_in_use`.
6.  Если свободный порт найден, функция возвращает его.
7.  Если свободный порт не найден ни в одном из диапазонов или если произошла ошибка при разборе диапазона, функция логирует ошибку и вызывает исключение `ValueError`.

**Примеры**:

```python
from src.utils.get_free_port import get_free_port

# Поиск свободного порта в диапазоне 3000-3005
port = get_free_port('localhost', '3000-3005')
print(f'Свободный порт: {port}')

# Поиск свободного порта в списке диапазонов
port = get_free_port('localhost', ['3000-3005', '8000-8010'])
print(f'Свободный порт: {port}')

# Поиск первого доступного порта
port = get_free_port('localhost')
print(f'Свободный порт: {port}')
```