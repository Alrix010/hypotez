# Модуль для работы с SMTP
=================================================

Модуль содержит функции для отправки и получения электронных писем с использованием протоколов SMTP и IMAP.
Он включает функции для отправки электронных писем через SMTP и получения электронных писем через IMAP.

## Обзор

Модуль `smtp.py` предоставляет интерфейс для работы с электронной почтой, используя протоколы SMTP (Simple Mail Transfer Protocol) для отправки сообщений и IMAP (Internet Message Access Protocol) для их получения. Он включает функции для отправки электронных писем с использованием SMTP и получения электронных писем через IMAP.

## Подробней

Этот модуль предназначен для упрощения процесса отправки и получения электронной почты. Он абстрагирует детали реализации протоколов SMTP и IMAP, предоставляя простой интерфейс для отправки и получения электронных писем. Модуль использует библиотеку `smtplib` для отправки электронной почты и библиотеку `imaplib` для получения электронной почты.

Важно отметить, что учетные данные для доступа к SMTP и IMAP серверам не должны быть жестко закодированы в файле. Вместо этого рекомендуется использовать переменные окружения.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Sends an email.  Returns True if successful, False otherwise. Logs errors."""
```

**Назначение**: Отправляет электронное письмо.

**Параметры**:
- `subject` (str, optional): Тема письма. По умолчанию ''.
- `body` (str, optional): Тело письма. По умолчанию ''.
- `to` (str, optional): Адрес получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:
- `bool`: `True`, если отправка прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при отправке письма.

**Как работает функция**:
Функция `send` создает SMTP-соединение, выполняет аутентификацию на сервере и отправляет электронное письмо. Она использует библиотеку `smtplib` для установления соединения с SMTP-сервером, шифрует соединение с помощью `starttls()`, выполняет вход в систему с использованием предоставленных учетных данных, создает MIME-сообщение, устанавливает заголовок, отправителя и получателя, отправляет сообщение и завершает соединение. В случае возникновения каких-либо исключений в процессе, функция регистрирует ошибку и возвращает `False`.

**Примеры**:

```python
from src.utils.smtp import send

# Отправка простого письма
send(subject='Привет', body='Это тестовое письмо', to='recipient@example.com')

# Отправка письма без указания темы и тела
send(to='recipient@example.com')
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Retrieves emails. Returns a list of email dictionaries if successful, None otherwise. Logs errors."""
```

**Назначение**: Получает электронные письма из почтового ящика.

**Параметры**:
- `imap_server` (str): Адрес IMAP-сервера.
- `user` (str): Имя пользователя для входа в почтовый ящик.
- `password` (str): Пароль для входа в почтовый ящик.
- `folder` (str, optional): Название папки для получения писем. По умолчанию 'inbox'.

**Возвращает**:
- `Optional[List[Dict[str, str]]]`: Список словарей, где каждый словарь содержит информацию об одном электронном письме (тема, отправитель, тело). Возвращает `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при получении писем.

**Как работает функция**:
Функция `receive` устанавливает IMAP-соединение, выполняет аутентификацию на сервере, выбирает указанную папку и получает все электронные письма. Она использует библиотеку `imaplib` для установления соединения с IMAP-сервером, выполняет вход в систему с использованием предоставленных учетных данных, выбирает указанную папку, выполняет поиск всех писем, извлекает каждое письмо, разбирает его содержимое и возвращает список словарей, содержащих информацию о каждом письме (тема, отправитель, тело). В случае возникновения каких-либо исключений в процессе, функция регистрирует ошибку и возвращает `None`.

**Примеры**:

```python
from src.utils.smtp import receive

# Получение писем из папки "inbox"
emails = receive(imap_server='imap.example.com', user='username', password='password')

if emails:
    for email in emails:
        print(f"Тема: {email['subject']}")
        print(f"Отправитель: {email['from']}")
        print(f"Тело: {email['body']}")
else:
    print("Не удалось получить письма.")
```

## Параметры конфигурации

В модуле используются следующие параметры конфигурации, которые должны быть установлены через переменные окружения:

- `SMTP_SERVER` (str): Адрес SMTP-сервера. По умолчанию 'smtp.example.com'.
- `SMTP_PORT` (int): Порт SMTP-сервера. По умолчанию 587.
- `SMTP_USER` (str): Имя пользователя для входа на SMTP-сервер.
- `SMTP_PASSWORD` (str): Пароль для входа на SMTP-сервер.
- `SMTP_RECEIVER` (str): Адрес электронной почты получателя по умолчанию. По умолчанию 'one.last.bit@gmail.com'.

## Важные замечания

- **Безопасность**: Никогда не храните учетные данные (пароли) в коде. Используйте переменные окружения для их хранения и доступа.
- **Обработка ошибок**: В коде предусмотрена надежная обработка ошибок с использованием логирования. Это помогает выявлять и устранять проблемы.
- **Обработка MIME**: Код правильно использует `MIMEText` для создания сообщений электронной почты, что необходимо для отправки простых текстовых писем.