# Модуль для работы с SMTP
## Обзор

Модуль `smtp.py` предоставляет интерфейс для отправки и получения электронных писем с использованием протоколов SMTP и IMAP. Он включает в себя функции для отправки электронных писем через SMTP-сервер и получения электронных писем через IMAP-сервер.
## Подробнее

Модуль предназначен для упрощения работы с электронной почтой в проекте `hypotez`. Он позволяет отправлять уведомления, отчеты и другие сообщения электронной почты, а также получать входящие сообщения для обработки.
Основной функциональностью модуля является отправка и получение электронных сообщений. Для отправки используется протокол SMTP, для получения - IMAP. Все параметры подключения к серверам SMTP и IMAP, такие как адрес сервера, порт, имя пользователя и пароль, хранятся в переменных окружения. Это позволяет избежать хранения конфиденциальной информации в коде и упрощает настройку модуля для различных окружений.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Отправляет электронное письмо. Возвращает `True` в случае успеха, `False` в противном случае. Логирует ошибки."""
    ...
```

**Назначение**: Отправляет электронное письмо с заданными параметрами.

**Параметры**:

-   `subject` (str, optional): Тема письма. По умолчанию пустая строка.
-   `body` (str, optional): Тело письма. По умолчанию пустая строка.
-   `to` (str, optional): Адрес электронной почты получателя. По умолчанию `'one.last.bit@gmail.com'`.

**Возвращает**:

-   `bool`: `True`, если письмо успешно отправлено, `False` в противном случае.

**Вызывает исключения**:

-   `Exception`: Возникает в случае ошибки при отправке письма.

**Как работает функция**:

1.  Функция создает SMTP-соединение с использованием параметров, указанных в словаре `_connection`.
2.  Выполняет рукопожатие с сервером (`ehlo`).
3.  Запускает шифрование соединения (`starttls`).
4.  Выполняет вход на сервер с использованием имени пользователя и пароля из словаря `_connection`.
5.  Создает объект `MIMEText` с телом письма.
6.  Устанавливает заголовок `Subject` (тема письма).
7.  Устанавливает заголовок `From` (отправитель письма).
8.  Устанавливает заголовок `To` (получатель письма).
9.  Отправляет письмо с использованием метода `sendmail`.
10. Закрывает SMTP-соединение (`quit`).
11. В случае успеха возвращает `True`.
12. В случае возникновения исключения логирует ошибку с использованием `logger.error` и возвращает `False`.

**Примеры**:

```python
from src.utils.smtp import send

# Отправка простого письма
result = send(subject='Привет', body='Это тестовое письмо.', to='test@example.com')
print(f'Результат отправки: {result}')

# Отправка письма без указания получателя (используется значение по умолчанию)
result = send(subject='Привет', body='Это тестовое письмо.')
print(f'Результат отправки: {result}')
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Извлекает электронные письма. Возвращает список словарей, представляющих электронные письма, в случае успеха, `None` в противном случае. Логирует ошибки."""
    ...
```

**Назначение**: Получает электронные письма из указанного почтового ящика на IMAP-сервере.

**Параметры**:

-   `imap_server` (str): Адрес IMAP-сервера.
-   `user` (str): Имя пользователя для входа на IMAP-сервер.
-   `password` (str): Пароль для входа на IMAP-сервер.
-   `folder` (str, optional): Название почтового ящика (папки) для получения писем. По умолчанию `'inbox'`.

**Возвращает**:

-   `Optional[List[Dict[str, str]]]`: Список словарей, где каждый словарь представляет электронное письмо и содержит ключи `'subject'`, `'from'` и `'body'`. Возвращает `None` в случае ошибки.

**Вызывает исключения**:

-   `Exception`: Возникает в случае ошибки при получении писем.

**Как работает функция**:

1.  Функция создает SSL-соединение с IMAP-сервером.
2.  Выполняет вход на сервер с использованием имени пользователя и пароля.
3.  Выбирает указанный почтовый ящик (папку).
4.  Выполняет поиск всех писем в выбранном ящике.
5.  Для каждого найденного письма извлекает его содержимое.
6.  Преобразует полученное содержимое в объект `email.message_from_bytes`.
7.  Извлекает тему, отправителя и тело письма из объекта `email.message`.
8.  Декодирует тело письма, обрабатывая возможные ошибки кодировки.
9.  Сохраняет информацию о письме в виде словаря.
10. Добавляет словарь с информацией о письме в список `emails`.
11. После обработки всех писем закрывает соединение с сервером и выполняет выход.
12. Возвращает список словарей с информацией о письмах.
13. В случае возникновения исключения логирует ошибку с использованием `logger.error` и возвращает `None`.

**Примеры**:

```python
from src.utils.smtp import receive

# Получение писем из почтового ящика
emails = receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='INBOX')
if emails:
    for email in emails:
        print(f'Тема: {email["subject"]}')
        print(f'Отправитель: {email["from"]}')
        print(f'Тело: {email["body"]}')
else:
    print('Не удалось получить письма.')