# Модуль FastAPI с XML-RPC интерфейсом для удаленного управления

## Обзор

Модуль `src.fast_api.fast_api.py` представляет собой сервер FastAPI с реализацией Singleton, предоставляющий интерфейс XML-RPC для удаленного управления. Сервер позволяет добавлять и запускать маршруты, а также управлять их состоянием (запуск, остановка, получение статуса) с помощью командной строки или через XML-RPC.

## Подробнее

В этом модуле реализован класс `FastApiServer`, который создает экземпляр сервера FastAPI с определенными параметрами, такими как хост, порт и набор роутов. Сервер управляется через объект `CommandHandler`, который обрабатывает команды, передаваемые через консоль или через XML-RPC. 

## Классы

### `class FastApiServer`

**Описание**: Класс `FastApiServer` реализует FastAPI сервер с использованием паттерна Singleton. 

**Атрибуты**:
- `_instance`: Статический атрибут, который хранит экземпляр класса (Singleton).
- `app`: Экземпляр приложения FastAPI.
- `host`: Строка, содержащая адрес хоста сервера.
- `port`: Целое число, указывающее порт, на котором будет запущен сервер.
- `router`: Объект APIRouter, используется для добавления роутов к приложению FastAPI. 
- `server_tasks`: Словарь, хранящий задачи запуска сервера на разных портах.
- `servers`: Словарь, содержащий информацию о запущенных серверах на разных портах.


**Методы**:
- `__new__(cls, *args, **kwargs)`: Статический метод, который создает новый экземпляр класса, если он еще не был создан. 
- `__init__(self, host: str = "127.0.0.1", title: str = "FastAPI RPC Server", **kwargs)`: Инициализирует экземпляр класса, добавляет базовые роуты и настраивает сервер. 
- `add_route(self, path: str, func: Callable, methods: List[str] = ["GET"], **kwargs)`: Добавляет маршрут к приложению FastAPI. 
- `_start_server(self, port: int)`: Запускает uvicorn сервер асинхронно на указанном порту.
- `start(self, port: int, as_thread: bool = True)`: Запускает FastAPI сервер на указанном порту.
- `stop(self, port: int)`: Останавливает FastAPI сервер на указанном порту. 
- `stop_all(self)`: Останавливает все запущенные сервера.
- `get_servers_status(self)`: Возвращает статус всех серверов (работает/остановлен).
- `get_routes(self)`: Возвращает список всех зарегистрированных роутов. 
- `get_app(self)`: Возвращает FastAPI приложение.
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"], **kwargs)`: Добавляет новый роут к уже работающему приложению.


### `class CommandHandler`

**Описание**: Класс `CommandHandler` реализует обработчик команд, который управляет сервером FastAPI через XML-RPC. 

**Атрибуты**:
- `rpc_port`: Целое число, указывающее порт, на котором запущен XML-RPC сервер. 
- `rpc_server`:  Экземпляр SimpleXMLRPCServer, создает сервер XML-RPC.


**Методы**:
- `__init__(self, rpc_port=9000)`:  Инициализирует класс `CommandHandler`.
- `start_server(self, port: int, host: str)`:  Запускает FastAPI сервер на указанном порту через `start_server` (внешняя функция).
- `stop_server(self, port: int)`: Останавливает FastAPI сервер на указанном порту через `stop_server` (внешняя функция).
- `stop_all_servers(self)`: Останавливает все запущенные FastAPI сервера через `stop_all_servers` (внешняя функция).
- `status_servers(self)`: Показывает статус всех запущенных FastAPI серверов через `status_servers` (внешняя функция). 
- `get_routes(self)`: Показывает все зарегистрированные роуты через `get_routes` (внешняя функция).
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"])`: Добавляет новый роут к серверу через `add_new_route` (внешняя функция).
- `shutdown(self)`:  Останавливает все запущенные сервера и завершает работу XML-RPC сервера.



## Функции

### `telegram_webhook()`

**Назначение**: Функция обрабатывает запросы от Telegram вебхука. 

**Параметры**: Отсутствуют.

**Возвращает**: Строка `'Hello, World!'`.

**Вызывает исключения**:  Отсутствуют.

**Примеры**: 
```python
>>> telegram_webhook()
'Hello, World!'
```

### `test_function()`

**Назначение**: Тестовая функция, возвращает строку с приветствием. 

**Параметры**: Отсутствуют.

**Возвращает**: Строка `"It is working!!!"`.

**Вызывает исключения**:  Отсутствуют.

**Примеры**: 
```python
>>> test_function()
'It is working!!!'
```

### `test_post(data: Dict[str, str])`

**Назначение**: Функция обрабатывает POST-запросы. 

**Параметры**:
- `data` (Dict[str, str]): Словарь, содержащий данные из POST-запроса.

**Возвращает**: Словарь, содержащий результат обработки запроса.

**Вызывает исключения**:  Отсутствуют.

**Примеры**: 
```python
>>> test_post({'key': 'value'})
{'result': 'post ok', 'data': {'key': 'value'}}
```

### `start_server(port: int, host: str)`

**Назначение**: Запускает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором будет запущен сервер.
- `host` (str): Адрес хоста, на котором будет запущен сервер.

**Возвращает**:  `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке запуска сервера.

**Примеры**: 
```python
>>> start_server(port=8000, host='127.0.0.1')
```

### `stop_server(port: int)`

**Назначение**: Останавливает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором запущен сервер.

**Возвращает**:  `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке остановки сервера.

**Примеры**: 
```python
>>> stop_server(port=8000)
```

### `stop_all_servers()`

**Назначение**: Останавливает все запущенные FastAPI сервера.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке остановки серверов.

**Примеры**: 
```python
>>> stop_all_servers()
```

### `status_servers()`

**Назначение**: Показывает статус всех серверов (работает/остановлен).

**Параметры**: Отсутствуют.

**Возвращает**:  `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке получения статуса серверов.

**Примеры**: 
```python
>>> status_servers()
```

### `get_routes()`

**Назначение**:  Показывает все зарегистрированные роуты.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке получения списка роутов.

**Примеры**: 
```python
>>> get_routes()
```

### `add_new_route(path: str, module_name: str, func_name: str, methods: List[str] = ["GET"])`

**Назначение**:  Добавляет новый роут к серверу. 

**Параметры**:
- `path` (str): Путь к новому роуту.
- `module_name` (str): Имя модуля, в котором находится функция обработчика роута. 
- `func_name` (str): Имя функции обработчика роута. 
- `methods` (List[str], optional): Список разрешенных HTTP-методов для роута. По умолчанию `["GET"]`. 

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке добавления нового роута.

**Примеры**: 
```python
>>> add_new_route(path='/new_route', module_name='src.fast_api.routes', func_name='test_function', methods=['POST'])
```

### `parse_port_range(range_str)`

**Назначение**: Разбирает строку с диапазоном портов. 

**Параметры**:
- `range_str` (str): Строка, содержащая диапазон портов (например, "8000-8005" или "8000").

**Возвращает**: Список целых чисел, представляющих диапазон портов. 

**Вызывает исключения**: 
- `ValueError`: Возникает при неверном формате диапазона портов.

**Примеры**: 
```python
>>> parse_port_range("8000-8005")
[8000, 8001, 8002, 8003, 8004, 8005]

>>> parse_port_range("8000")
[8000]
```

### `display_menu()`

**Назначение**: Выводит меню с доступными командами.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке вывода меню.

**Примеры**: 
```python
>>> display_menu()
Available commands:
  start <port>        - Start server on the specified port
  status              - Show all served ports status
  routes              - Show all registered routes
  stop <port>         - Stop server on the specified port
  stop_all            - Stop all servers
  add_route <path>    - Add a new route to the server
  shutdown            - Stop all servers and exit
  help                - Show this help menu
  exit                - Exit the program
```


### `main()`

**Назначение**:  Основная функция управления сервером. 

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке выполнения команды.

**Примеры**: 
```python
>>> main()
```

## Параметры класса

- `config`: Объект `SimpleNamespace`, содержащий конфигурационные параметры FastAPI сервера, загруженные из файла `fast_api.json`.  
- `host`: Адрес хоста, на котором будет запущен сервер (по умолчанию `127.0.0.1`).
- `ports`: Список портов, на которых будут запущены сервера.
- `title`: Название приложения FastAPI.
- `path`: Путь к роуту.
- `func`: Функция обработчика роута. 
- `methods`: Список разрешенных HTTP-методов для роута (по умолчанию `["GET"]`).
- `port`: Порт, на котором запущен XML-RPC сервер. 
- `range_str`: Строка, содержащая диапазон портов.
- `command_line`: Строка, содержащая введенную пользователем команду.
- `command`:  Команда, введенная пользователем (первое слово в `command_line`). 
- `module_name`: Имя модуля, в котором находится функция обработчика роута. 
- `func_name`: Имя функции обработчика роута. 
- `methods`: Список разрешенных HTTP-методов для роута.

## Примеры

```python
>>> # Запуск сервера на порту 8000
>>> start_server(port=8000, host='127.0.0.1')

>>> # Остановка сервера на порту 8000
>>> stop_server(port=8000)

>>> # Остановка всех серверов
>>> stop_all_servers()

>>> # Вывод статуса серверов
>>> status_servers()

>>> # Вывод списка зарегистрированных роутов
>>> get_routes()

>>> # Добавление нового роута
>>> add_new_route(path='/new_route', module_name='src.fast_api.routes', func_name='test_function', methods=['POST'])

>>> # Запуск XML-RPC сервера и взаимодействие с ним
>>> from xmlrpc.client import ServerProxy
>>> server = ServerProxy("http://localhost:9000")
>>> server.start_server(port=8001, host='127.0.0.1') 
```

## Как работает код

Сервер FastAPI запускается при помощи класса `FastApiServer` с использованием паттерна Singleton, который гарантирует, что будет создан только один экземпляр класса. 
Класс `CommandHandler` создает XML-RPC сервер, который позволяет управлять FastAPI сервером через команды, передаваемые через консоль или по сети. 

В обработчике команд (`CommandHandler`) реализована функция `main()`, которая запрашивает у пользователя команду и выполняет ее. 
Команды `start`, `stop`, `stop_all`, `status`, `routes`, `add_route`  и `shutdown`  выполняют соответствующие действия с помощью соответствующих функций, определенных в модуле.

## Внутренние функции

### `parse_port_range(range_str)`

**Назначение**: Функция разбирает строку с диапазоном портов. 

**Параметры**:
- `range_str` (str): Строка, содержащая диапазон портов (например, "8000-8005" или "8000").

**Возвращает**: Список целых чисел, представляющих диапазон портов. 

**Вызывает исключения**: 
- `ValueError`: Возникает при неверном формате диапазона портов.

**Как работает функция**:
Функция проверяет, является ли входная строка валидным диапазоном портов. Если строка содержит тире "-", функция разделяет ее на два числа, представляющие начальный и конечный порты.  Затем функция создает список целых чисел, представляющий диапазон портов. Если строка не содержит тире, функция пытается преобразовать ее в целое число и вернуть его в списке. В случае ошибки возвращается пустой список. 

**Примеры**:
```python
>>> parse_port_range("8000-8005")
[8000, 8001, 8002, 8003, 8004, 8005]

>>> parse_port_range("8000")
[8000]
```

### `display_menu()`

**Назначение**: Выводит меню с доступными командами.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**: 
- `Exception`: Возникает при ошибке вывода меню.

**Как работает функция**: 
Функция выводит на консоль список доступных команд с кратким описанием каждой команды.  

**Примеры**: 
```python
>>> display_menu()
Available commands:
  start <port>        - Start server on the specified port
  status              - Show all served ports status
  routes              - Show all registered routes
  stop <port>         - Stop server on the specified port
  stop_all            - Stop all servers
  add_route <path>    - Add a new route to the server
  shutdown            - Stop all servers and exit
  help                - Show this help menu
  exit                - Exit the program