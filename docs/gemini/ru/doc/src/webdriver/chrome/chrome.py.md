# Модуль для работы с WebDriver Chrome

## Обзор

Модуль `chrome.py` предоставляет расширение для `webdriver.Chrome` с дополнительной функциональностью. Он позволяет настраивать и запускать браузер Chrome с различными параметрами, такими как профиль пользователя, версия ChromeDriver, User-Agent, прокси и режим окна.

## Подробнее

Модуль предназначен для упрощения и расширения возможностей управления браузером Chrome с использованием Selenium WebDriver. Он предоставляет удобный интерфейс для настройки различных параметров запуска Chrome, таких как профиль пользователя, прокси, User-Agent и режим окна. Это позволяет автоматизировать задачи, требующие взаимодействия с веб-страницами через браузер Chrome, с возможностью гибкой настройки окружения.

## Классы

### `Chrome`

**Описание**: Расширение для класса `webdriver.Chrome` с дополнительной функциональностью.

**Наследует**:
- `WebDriver` (из `selenium.webdriver`)

**Атрибуты**:
- `driver_name` (str): Имя драйвера (в данном случае, 'chrome').

**Параметры**:
- `profile_name` (Optional[str]): Имя пользовательского профиля Chrome. По умолчанию `None`.
- `chromedriver_version` (Optional[str]): Версия ChromeDriver. По умолчанию `None`.
- `user_agent` (Optional[str]): Пользовательский агент в формате строки. По умолчанию `None`.
- `proxy_file_path` (Optional[str]): Путь к файлу с прокси. По умолчанию `None`.
- `options` (Optional[List[str]]): Список опций для Chrome. По умолчанию `None`.
- `window_mode` (Optional[str]): Режим окна браузера (`windowless`, `kiosk`, `full_window` и т.д.). По умолчанию `None`.

**Принцип работы**:
1. **Инициализация**:
   - Загружает настройки Chrome из файла `chrome.json`.
   - Определяет путь к ChromeDriver.
   - Инициализирует сервис ChromeDriver.
   - Настраивает опции Chrome, включая опции из файла настроек, режим окна, User-Agent и прокси.
   - Настраивает директорию профиля пользователя.
2. **Запуск**:
   - Запускает Chrome WebDriver с заданными настройками.
   - Вызывает метод `_payload` для загрузки исполнителей для локаторов и JavaScript сценариев.
3. **Обработка ошибок**:
   - Обрабатывает исключения, которые могут возникнуть при запуске WebDriver, и логирует соответствующие сообщения.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `Chrome`.
- `set_proxy`: Настраивает прокси для Chrome.
- `_payload`: Загружает исполнителей для локаторов и JavaScript сценариев.

## Методы класса

### `__init__`

```python
def __init__(self, profile_name: Optional[str] = None,
                 chromedriver_version: Optional[str] = None,
                 user_agent: Optional[str] = None,
                 proxy_file_path: Optional[str] = None,
                 options: Optional[List[str]] = None,
                 window_mode: Optional[str] = None,
                 *args, **kwargs) -> None:
    """Инициализирует экземпляр класса `Chrome`.

    Args:
        profile_name (Optional[str], optional): Имя пользовательского профиля Chrome. По умолчанию `None`.
        chromedriver_version (Optional[str], optional): Версия ChromeDriver. По умолчанию `None`.
        user_agent (Optional[str], optional): Пользовательский агент в формате строки. По умолчанию `None`.
        proxy_file_path (Optional[str], optional): Путь к файлу с прокси. По умолчанию `None`.
        options (Optional[List[str]], optional): Список опций для Chrome. По умолчанию `None`.
        window_mode (Optional[str], optional): Режим окна браузера (`windowless`, `kiosk`, `full_window` и т.д.). По умолчанию `None`.
        *args: Произвольные позиционные аргументы.
        **kwargs: Произвольные именованные аргументы.
    """
```

**Назначение**: Инициализирует объект класса `Chrome`, настраивает параметры запуска браузера Chrome и запускает WebDriver.

**Параметры**:
- `profile_name` (Optional[str]): Имя пользовательского профиля Chrome. Используется для загрузки пользовательских настроек и данных.
- `chromedriver_version` (Optional[str]): Версия ChromeDriver, используемая для управления браузером Chrome.
- `user_agent` (Optional[str]): User-Agent, который будет использоваться браузером Chrome. Позволяет имитировать различных пользователей и устройства.
- `proxy_file_path` (Optional[str]): Путь к файлу, содержащему список прокси-серверов для использования.
- `options` (Optional[List[str]]): Список дополнительных опций командной строки, которые передаются в Chrome при запуске.
- `window_mode` (Optional[str]): Режим отображения окна браузера (например, `windowless` для запуска в фоновом режиме, `kiosk` для полноэкранного режима и `full_window` для максимизированного окна).
- `*args`: Произвольные позиционные аргументы, передаваемые в конструктор родительского класса.
- `**kwargs`: Произвольные именованные аргументы, передаваемые в конструктор родительского класса.

**Как работает функция**:

1. **Объявление переменных**: Инициализирует локальные переменные `service` и `options_obj` для хранения экземпляров `Service` и `Options` соответственно.
2. **Загрузка конфигурации Chrome**: Загружает конфигурацию из JSON-файла, расположенного по пути `src/webdriver/chrome/chrome.json`. Используется функция `j_loads_ns` для загрузки содержимого файла в объект пространства имен.
3. **Определение пути к ChromeDriver**: Формирует путь к исполняемому файлу ChromeDriver на основе конфигурации.
4. **Инициализация сервиса ChromeDriver**: Создает экземпляр `Service`, используя путь к ChromeDriver. Этот сервис управляет жизненным циклом процесса ChromeDriver.
5. **Настройка опций Chrome**: Создает экземпляр `Options` для настройки параметров запуска Chrome.
6. **Добавление опций из конфигурации**: Если в конфигурации указаны опции Chrome, добавляет их в объект `options_obj`.
7. **Установка режима окна**: Устанавливает режим окна браузера на основе параметра `window_mode`, который может быть передан при инициализации класса или указан в конфигурации.
8. **Добавление дополнительных опций**: Если переданы дополнительные опции через параметр `options`, добавляет их в объект `options_obj`.
9. **Установка User-Agent**: Устанавливает User-Agent браузера на основе параметра `user_agent`, который может быть передан при инициализации класса или сгенерирован случайным образом с использованием библиотеки `fake_useragent`.
10. **Настройка прокси**: Если в конфигурации включена поддержка прокси, вызывает метод `set_proxy` для настройки прокси-сервера.
11. **Настройка директории профиля**: Настраивает директорию профиля пользователя Chrome на основе параметра `profile_name` и конфигурации.
12. **Запуск WebDriver**: Создает экземпляр `WebDriver` с использованием настроенного сервиса и опций.
13. **Загрузка исполнителей**: Вызывает метод `_payload` для загрузки исполнителей для локаторов и JavaScript-сценариев.
14. **Обработка исключений**: Перехватывает исключения, которые могут возникнуть при запуске WebDriver, и логирует соответствующие сообщения.

**Вызывает исключения**:
- `WebDriverException`: Если возникает ошибка при запуске WebDriver (например, несовместимая версия ChromeDriver или отсутствие Chrome).
- `Exception`: Если возникает любая другая ошибка во время работы.

**Примеры**:

```python
# Запуск Chrome с профилем пользователя и в полноэкранном режиме
driver = Chrome(profile_name='my_profile', window_mode='full_window')

# Запуск Chrome с пользовательским User-Agent и дополнительными опциями
driver = Chrome(user_agent='My Custom Agent', options=['--disable-gpu', '--mute-audio'])

# Запуск Chrome с использованием прокси-сервера
driver = Chrome(proxy_file_path='/path/to/proxy_file.txt')
```

### `set_proxy`

```python
def set_proxy(self, options: Options) -> None:
    """Настраивает прокси из словаря, возвращаемого get_proxies_dict.

    Args:
        options (Options): Опции Chrome, в которые добавляются настройки прокси.
    """
```

**Назначение**: Настраивает прокси для Chrome на основе данных, полученных из словаря прокси.

**Параметры**:
- `options` (Options): Объект `Options` из Selenium, в который будут добавлены настройки прокси.

**Как работает функция**:

1. **Получение словаря прокси**: Вызывает функцию `get_proxies_dict()` для получения словаря, содержащего информацию о прокси-серверах.
2. **Создание списка всех прокси**: Объединяет списки прокси из категорий `socks4` и `socks5` в один общий список `all_proxies`.
3. **Перебор прокси для поиска рабочего**:
   - Перемешивает список `all_proxies` случайным образом, чтобы избежать предвзятости при выборе прокси.
   - Перебирает прокси в перемешанном списке и вызывает функцию `check_proxy()` для проверки работоспособности каждого прокси.
   - Если `check_proxy()` возвращает `True` для какого-либо прокси, этот прокси считается рабочим, и цикл прерывается.
4. **Настройка прокси, если он найден**:
   - Если найден рабочий прокси, извлекает протокол (`protocol`), хост (`host`) и порт (`port`) из информации о прокси.
   - В зависимости от протокола, добавляет соответствующую опцию в объект `options` для настройки прокси в Chrome.
   - Логирует информацию о настроенном прокси.
5. **Обработка случаев, когда прокси не найден**:
   - Если не удалось найти рабочий прокси в предоставленном списке, логирует предупреждение о том, что нет доступных прокси.

**Примеры**:

```python
from selenium.webdriver import ChromeOptions

# Пример использования функции set_proxy
options = ChromeOptions()
chrome_instance = Chrome()  # Создаем экземпляр класса Chrome
chrome_instance.set_proxy(options)  # Вызываем функцию set_proxy для настройки прокси
```

### `_payload`

```python
def _payload(self) -> None:
    """Загружает исполнителей для локаторов и JavaScript сценариев."""
```

**Назначение**: Загружает исполнителей (executor) для локаторов элементов и JavaScript-сценариев, чтобы упростить взаимодействие с веб-страницами.

**Как работает функция**:

1. **Создание экземпляра JavaScript**: Создает экземпляр класса `JavaScript`, передавая в него текущий экземпляр `Chrome` (self). Класс `JavaScript` предоставляет методы для выполнения JavaScript-кода в браузере.
2. **Назначение методов JavaScript**: Присваивает методы из экземпляра `JavaScript` текущему экземпляру `Chrome`, чтобы их можно было вызывать напрямую через объект `Chrome`. Это включает методы:
   - `get_page_lang`: для получения языка страницы.
   - `ready_state`: для проверки состояния готовности страницы.
   - `get_referrer`: для получения referrer страницы.
   - `unhide_DOM_element`: для отображения скрытого элемента DOM.
   - `window_focus`: для фокусировки окна браузера.
3. **Создание экземпляра ExecuteLocator**: Создает экземпляр класса `ExecuteLocator`, передавая в него текущий экземпляр `Chrome` (self). Класс `ExecuteLocator` предоставляет методы для поиска и взаимодействия с элементами на веб-странице с использованием локаторов.
4. **Назначение методов ExecuteLocator**: Присваивает методы из экземпляра `ExecuteLocator` текущему экземпляру `Chrome`, чтобы их можно было вызывать напрямую через объект `Chrome`. Это включает методы:
   - `execute_locator`: для выполнения локатора и возврата найденного элемента.
   - `get_webelement_as_screenshot`: для получения скриншота веб-элемента.
   - `get_webelement_by_locator`: для получения веб-элемента по локатору.
   - `get_attribute_by_locator`: для получения атрибута элемента по локатору.
   - `send_message`: для отправки сообщения (нажатия клавиш) в веб-элемент.
5. **Назначение псевдонима для send_message**: Создает псевдоним `send_key_to_webelement` для метода `send_message`, чтобы обеспечить совместимость с существующим кодом или предоставить более понятное имя для определенной операции.

**Примеры**:

```python
# Пример использования функции _payload
driver = Chrome()  # Создаем экземпляр класса Chrome
driver._payload()  # Вызываем функцию _payload для загрузки исполнителей

# Теперь можно использовать методы, назначенные в _payload, напрямую через объект driver
page_language = driver.get_page_lang()
element = driver.execute_locator(locator)
```

## Параметры класса

- `profile_name` (Optional[str]): Более подробное описание имени пользовательского профиля Chrome. Используется для загрузки пользовательских настроек и данных при запуске браузера. Если не указан, используется профиль по умолчанию.
- `chromedriver_version` (Optional[str]): Более подробное описание версии ChromeDriver, используемой для управления браузером Chrome. ChromeDriver должен быть совместим с установленной версией Chrome. Если не указана, используется версия ChromeDriver, указанная в конфигурационном файле.
- `user_agent` (Optional[str]): Более подробное описание User-Agent, который будет использоваться браузером Chrome. User-Agent позволяет имитировать различных пользователей и устройства при запросе веб-страниц. Если не указан, генерируется случайный User-Agent с использованием библиотеки `fake_useragent`.
- `proxy_file_path` (Optional[str]): Более подробное описание пути к файлу, содержащему список прокси-серверов для использования. Каждый прокси-сервер в файле должен быть указан в формате `протокол://хост:порт`. Если не указан, прокси-сервер не используется.
- `options` (Optional[List[str]]): Более подробное описание списка дополнительных опций командной строки, которые передаются в Chrome при запуске. Эти опции позволяют настраивать различные аспекты поведения браузера, такие как отключение расширений, запуск в режиме инкогнито и т.д.
- `window_mode` (Optional[str]): Более подробное описание режима отображения окна браузера. Допустимые значения:
  - `windowless`: Запуск браузера в фоновом режиме без отображения графического интерфейса.
  - `kiosk`: Запуск браузера в полноэкранном режиме.
  - `full_window`: Запуск браузера в максимизированном окне.
  Если не указан, используется режим, указанный в конфигурационном файле.

## Примеры

```python
# Запуск Chrome с профилем пользователя и в полноэкранном режиме
driver = Chrome(profile_name='my_profile', window_mode='full_window')

# Запуск Chrome с пользовательским User-Agent и дополнительными опциями
driver = Chrome(user_agent='My Custom Agent', options=['--disable-gpu', '--mute-audio'])

# Запуск Chrome с использованием прокси-сервера
driver = Chrome(proxy_file_path='/path/to/proxy_file.txt')

# Пример использования методов, назначенных в _payload
driver = Chrome()  # Создаем экземпляр класса Chrome
driver._payload()  # Вызываем функцию _payload для загрузки исполнителей

# Теперь можно использовать методы, назначенные в _payload, напрямую через объект driver
page_language = driver.get_page_lang()
element = driver.execute_locator(locator)
```