# Модуль credentials

## Обзор

Модуль `credentials` является центральным хранилищем глобальных настроек, путей и учетных данных для проекта `hypotez`. Он разработан с использованием паттерна проектирования Singleton для гарантирования того, что в течение всего времени работы приложения существует только один экземпляр настроек, доступный из любой части программы.

Этот модуль обрабатывает:
*   Определение корневой директории проекта.
*   Загрузку основного конфигурационного файла (`config.json`).
*   Управление путями к различным директориям проекта (исходный код, бинарные файлы, логи, временные файлы, данные, секреты и т.д.).
*   Загрузку учетных данных для различных внешних сервисов (Aliexpress, OpenAI, Gemini, Discord, Telegram, Prestashop, Serpapi, SMTP, Facebook, GAPI) из базы данных KeePass.
*   Предоставление служебной информации, такой как имя хоста, информация о git и метка времени.

## Подробней

Модуль `credentials` играет критически важную роль в инициализации проекта `hypotez`. При первом обращении к экземпляру класса `ProgramSettings` (через глобальную переменную `gs`), автоматически выполняется поиск корневой директории проекта, загружается основной конфигурационный файл `config.json`, определяются и устанавливаются пути к ключевым директориям, а также происходит попытка загрузить учетные данные из защищенной базы данных KeePass.

Использование паттерна Singleton (`@singleton` декоратор) гарантирует, что все части приложения используют один и тот же набор настроек и учетных данных, что предотвращает несогласованность данных и упрощает управление конфигурацией.

Загрузка учетных данных из KeePass (`credentials.kdbx`) обеспечивает централизованное и безопасное хранение чувствительной информации. Модуль пытается получить мастер-пароль либо из файла (с соответствующим предупреждением), либо запрашивая его у пользователя через стандартный ввод. В случае неудачи загрузки учетных данных или основного конфигурационного файла, приложение аварийно завершает работу, поскольку без этих данных его функционирование невозможно.

Пути к бинарным директориям добавляются в `sys.path` и переменные окружения (`WEASYPRINT_DLL_DIRECTORIES`), что необходимо для корректной работы некоторых внешних инструментов, используемых проектом (например, `wkhtmltopdf`, `ffmpeg`, `graphviz`, `gtk`).

## Содержание (TOC)

- [Функции](#функции)
    - [`set_project_root`](#set_project_root)
    - [`singleton`](#singleton)
- [Классы](#классы)
    - [`ProgramSettings`](#programsettings)
        - [Методы](#методы)
            - [`__post_init__`](#__post_init__)
            - [`_load_credentials`](#_load_credentials)
            - [`_open_kp`](#_open_kp)
            - [`_load_aliexpress_credentials`](#_load_aliexpress_credentials)
            - [`_load_openai_credentials`](#_load_openai_credentials)
            - [`_load_gemini_credentials`](#_load_gemini_credentials)
            - [`_load_telegram_credentials`](#_load_telegram_credentials)
            - [`_load_discord_credentials`](#_load_discord_credentials)
            - [`_load_prestashop_credentials`](#_load_prestashop_credentials)
            - [`_load_serpapi_credentials`](#_load_serpapi_credentials)
            - [`_load_smtp_credentials`](#_load_smtp_credentials)
            - [`_load_facebook_credentials`](#_load_facebook_credentials)
            - [`_load_gapi_credentials`](#_load_gapi_credentials)
        - [Свойства](#свойства)
            - [`now`](#now)
- [Глобальный экземпляр](#глобальный-экземпляр)
    - [`gs`](#gs)

## Функции

### `set_project_root`

**Назначение**: Ищет корневую директорию проекта, начиная с директории текущего файла и поднимаясь вверх по структуре каталогов. Остановка происходит в первой директории, которая содержит любой из указанных маркеров (файлов или директорий).

**Параметры**:
- `marker_files` (tuple, optional): Кортеж с именами файлов или директорий, которые используются для идентификации корня проекта. По умолчанию (`'__root__'`, `'.git'`).

**Возвращает**:
- `Path`: Путь к найденной корневой директории проекта. Если корневая директория не найдена по маркерам, возвращает директорию, в которой расположен скрипт.

**Как работает функция**:
Функция начинает поиск с родительской директории текущего файла (`Path(__file__).resolve().parent`). Затем она итерируется по этой директории и всем ее родительским директориям. Для каждой директории в этой цепочке выполняется проверка на наличие любого из файлов, указанных в `marker_files`. При первом обнаружении совпадения директория считается корневой, и поиск прекращается. Найденный путь к корневой директории вставляется в начало `sys.path`, чтобы обеспечить возможность импорта модулей относительно корня проекта.

**Примеры**:

```python
# Пример использования
project_root = set_project_root()
# print(f"Корневая директория проекта: {project_root}")

# Пример с другим маркером
# project_root_custom = set_project_root(marker_files=('.project_config',))
# print(f"Корневая директория проекта (по кастомному маркеру): {project_root_custom}")
```

### `singleton`

**Назначение**: Декоратор, реализующий паттерн Singleton для класса. Гарантирует, что для декорированного класса может быть создан только один экземпляр. При последующих вызовах конструктора класса возвращается уже существующий экземпляр.

**Параметры**:
- `cls`: Класс, к которому применяется декоратор.

**Возвращает**:
- `function`: Внутренняя функция `get_instance`, которая управляет созданием и возвратом единственного экземпляра класса.

**Как работает функция**:
Декоратор `singleton` принимает класс `cls` в качестве аргумента. Внутри декоратора создается словарь `instances`, который будет хранить единственные экземпляры декорированных классов. Возвращается внутренняя функция `get_instance`. При вызове `get_instance` она проверяет, существует ли уже экземпляр класса `cls` в словаре `instances`. Если экземпляра нет, он создается (`cls(*args, **kwargs)`) и сохраняется в словаре. Если экземпляр уже есть, он просто возвращается. Таким образом, каждый вызов `get_instance` для одного и того же класса всегда возвращает один и тот же объект.

**Примеры**:

```python
# Пример использования декоратора
@singleton
class MySingletonClass:
    def __init__(self, value):
        self.value = value
        # print(f"Создан экземпляр MySingletonClass с значением: {self.value}")

# Первый вызов создает экземпляр
instance1 = MySingletonClass(10)

# Второй вызов возвращает тот же экземпляр
instance2 = MySingletonClass(20) # Значение 20 будет проигнорировано при создании

# print(instance1 is instance2) # Выведет True
# print(instance1.value)     # Выведет 10
```

## Классы

### `ProgramSettings`

**Описание**: `ProgramSettings` - класс настроек программы. Это синглтон, предназначенный для хранения и управления основными параметрами, путями и учетными данными, необходимыми для работы всего проекта `hypotez`.

**Наследует**: Не наследует явным образом другие классы, кроме стандартных возможностей, предоставляемых `@dataclass`.

**Атрибуты**:
- `host_name` (str): Имя хоста, на котором выполняется программа. Инициализируется по умолчанию с использованием `socket.gethostname()`.
- `base_dir` (Path): Базовая или корневая директория проекта. Инициализируется по умолчанию с использованием функции `set_project_root()`.
- `config` (SimpleNamespace): Объект SimpleNamespace, содержащий настройки, загруженные из `config.json`.
- `credentials` (SimpleNamespace): Объект SimpleNamespace, структурированно хранящий учетные данные для различных сервисов (aliexpress, presta, openai, gemini, rev_com, shutter_stock, discord, telegram, serpapi, smtp, facebook, gapi). Инициализируется с вложенной структурой SimpleNamespace, где все значения по умолчанию `None` или пустые списки/словари.
- `path` (SimpleNamespace): Объект SimpleNamespace, содержащий пути к ключевым директориям проекта (root, src, bin, log, tmp, data, secrets, google_drive, external_storage, tools, dev_null). Инициализируется значениями по умолчанию, которые могут быть переопределены настройками из `config.json`.
- `host` (str): Хост, определенный в конфигурационном файле.
- `git` (str): Имя репозитория git, определенное в конфигурационном файле.
- `git_user` (str): Имя пользователя git, определенное в конфигурационном файле.
- `current_release` (str): Текущая версия релиза, определенная в конфигурационном файле.

**Принцип работы**:
Класс `ProgramSettings` является синглтоном, что означает, что в любой момент времени может существовать только один его экземпляр. Этот экземпляр создается при первом обращении к нему (например, через глобальную переменную `gs`).
В процессе инициализации (`__post_init__` метод, который автоматически вызывается после создания экземпляра датакласса) происходит следующее:
1.  Загружается основной конфигурационный файл `config.json` из директории `src` внутри `base_dir` с использованием `j_loads_ns`. Если файл не может быть загружен, логируется ошибка и приложение завершает работу.
2.  Из загруженной конфигурации извлекаются или устанавливаются значения по умолчанию для формата метки времени (`timestamp_format`), имени проекта (`project_name`), хоста (`host`), имени репозитория git (`git`), пользователя git (`git_user`) и текущего релиза (`current_release`).
3.  Инициализируется объект `self.path` типа `SimpleNamespace` со всеми необходимыми путями к директориям проекта. Некоторые пути могут быть заданы в `config.json` (`log`, `tmp`, `data`, `google_drive`, `external_storage`).
4.  Пути к бинарным директориям (`bin` и его поддиректории для `gtk`, `ffmpeg`, `graphviz`, `wkhtmltopdf`) добавляются в `sys.path` для обеспечения доступности исполняемых файлов.
5.  Устанавливается переменная окружения `WEASYPRINT_DLL_DIRECTORIES`, необходимая для работы библиотеки WeasyPrint.
6.  Подавляются предупреждения типа `UserWarning`, связанные с GTK.
7.  Вызывается внутренний метод `_load_credentials` для загрузки всех необходимых учетных данных из KeePass.

Метод `_load_credentials` последовательно вызывает другие внутренние методы (`_load_aliexpress_credentials`, `_load_openai_credentials` и т.д.), каждый из которых отвечает за извлечение данных для конкретного сервиса из KeePass базы и сохранение их в соответствующую вложенную структуру `self.credentials`.

При возникновении критических ошибок (например, невозможность загрузить `config.json` или открыть базу KeePass), класс инициирует завершение работы приложения.

**Методы**:

### `__post_init__`

**Назначение**: Выполняет инициализацию экземпляра класса `ProgramSettings` после того, как стандартный конструктор `dataclass` присвоил начальные значения полям. Этот метод выполняет загрузку конфигурации, установку путей и инициализацию процесса загрузки учетных данных.

**Как работает**:
1.  Загружает содержимое файла `config.json` из директории `src` относительно базовой директории (`self.base_dir`) в объект `self.config` типа `SimpleNamespace` с использованием функции `j_loads_ns`.
2.  Если загрузка `config.json` не удалась (например, файл не найден или содержит синтаксическую ошибку), логируется ошибка, и приложение завершает работу с помощью `sys.exit()`.
3.  Присваивает значения атрибутам `self.config.timestamp_format`, `self.config.project_name`, `self.host`, `self.git`, `self.git_user`, `self.current_release`, извлекая их из загруженного объекта `self.config` или используя значения по умолчанию.
4.  Инициализирует объект `self.path` типа `SimpleNamespace`, определяя пути к различным директориям проекта относительно `self.base_dir`. Некоторые из этих путей могут быть переопределены значениями из `self.config.path`.
5.  Определяет пути к директориям, содержащим бинарные файлы, необходимые для работы проекта (такие как GTK, FFmpeg, Graphviz, wkhtmltopdf).
6.  Добавляет эти бинарные директории в начало списка системных путей (`sys.path`), если они там еще не присутствуют.
7.  Устанавливает переменную окружения `WEASYPRINT_DLL_DIRECTORIES` для указания расположения DLL-библиотек GTK, что необходимо для работы WeasyPrint.
8.  Применяет фильтр предупреждений для игнорирования `UserWarning`, связанных с GTK.
9.  Вызывает внутренний метод `_load_credentials()` для запуска процесса загрузки всех необходимых учетных данных.

### `_load_credentials`

**Назначение**: Оркестрирует процесс загрузки учетных данных для всех поддерживаемых внешних сервисов из базы данных KeePass.

**Как работает**:
1.  Пытается открыть базу данных KeePass, вызывая внутренний метод `_open_kp()`. Этот метод предпринимает несколько попыток открытия и запрашивает мастер-пароль при необходимости. Если открыть базу не удается, приложение завершает работу.
2.  После успешного открытия базы KeePass (`kp` объект), метод последовательно вызывает приватные методы, отвечающие за загрузку учетных данных для каждого конкретного сервиса (`_load_aliexpress_credentials`, `_load_openai_credentials`, и т.д.).
3.  Результат загрузки для каждого сервиса (успех или неудача) логируется с использованием `print` (который переопределен на `pprint` из `src.utils.printer`). Неудача при загрузке учетных данных для отдельного сервиса не останавливает загрузку для других сервисов, но сообщает об ошибке.

**Вызывает исключения**:
- Косвенно может вызвать исключения, возникающие в методе `_open_kp` (например, `KeePassException`), которые приводят к завершению работы приложения.
- Косвенно может вызывать исключения при работе с базой KeePass внутри методов `_load_..._credentials`, которые обрабатываются внутри этих методов (логируется ошибка, метод возвращает `False`), но не приводят к остановке всего процесса загрузки учетных данных.

### `_open_kp`

**Назначение**: Открывает базу данных KeePass (`credentials.kdbx`).

**Параметры**:
- `retry` (int, optional): Количество попыток открыть базу данных. По умолчанию `3`.

**Возвращает**:
- `PyKeePass | None`: Объект `PyKeePass`, представляющий открытую базу данных KeePass, если открытие прошло успешно. Возвращает `None`, если база не была открыта после всех попыток.

**Вызывает исключения**:
- Может вызвать исключения типа `KeePassException` или другие исключения, связанные с файловой системой или некорректным паролем, во время попытки открыть базу данных. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод выполняет цикл, пытаясь открыть базу данных KeePass, расположенную по пути `self.path.secrets / 'credentials.kdbx'`.
Внутри цикла `try...except` он сначала пытается прочитать пароль из файла `password.txt`, расположенного на один уровень выше директории `secrets` относительно `google_drive`. **Внимание**: чтение пароля из текстового файла является потенциально небезопасным и помечено комментарием `⚠️ ФАЙЛ ПАРОЛЯ В ОТКРЫТОМ ВИДЕ ⚠️`. Если файл с паролем не существует или пуст, используется `getpass.getpass` для интерактивного запроса пароля у пользователя через консоль.
Объект `PyKeePass` создается с путем к файлу базы данных и полученным паролем.
Если открытие базы прошло успешно, объект `PyKeePass` возвращается.
Если возникает исключение (например, некорректный пароль или файл не найден), логируется сообщение об ошибке, уменьшается счетчик попыток (`retry`), и цикл продолжается, если остались попытки.
Если количество попыток исчерпано (`retry < 1`), логируется критическая ошибка, и приложение завершает работу с помощью `sys.exit()`.

**Примеры**:
Этот метод является внутренним и не предназначен для прямого вызова извне класса. Его работа управляется методом `_load_credentials`.

### `_load_aliexpress_credentials`

**Назначение**: Загружает учетные данные для Aliexpress API из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод пытается найти запись в базе KeePass по пути `['suppliers', 'aliexpress', 'api']`. Предполагается, что по этому пути находится только одна запись (`.entries[0]`).
Из найденной записи извлекаются значения пользовательских свойств ('api_key', 'secret', 'tracking_id', 'email') и стандартного поля пароля ('password').
Извлеченные значения сохраняются в соответствующие атрибуты вложенной структуры `self.credentials.aliexpress`.
В случае успешного извлечения всех данных метод возвращает `True`. При возникновении любого исключения (например, группа или запись не найдены), логируется ошибка, и метод возвращает `False`.

### `_load_openai_credentials`

**Назначение**: Загружает учетные данные для OpenAI из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['openai']`. Для каждой найденной записи (предполагается, что каждая запись соответствует отдельному набору учетных данных OpenAI, например, для разных аккаунтов), создается новая вложенная структура `SimpleNamespace` в `self.credentials.openai`, где имя атрибута соответствует названию записи (`entry.title`).
Затем из пользовательских свойств каждой записи извлекаются значения для 'api_key' и 'project_api' и сохраняются в соответствующую вложенную структуру.
Если в процессе обработки какой-либо записи возникает исключение, оно логируется с использованием `logger.error`, но обработка других записей продолжается.
Метод возвращает `True` после попытки обработки всех записей в группе `['openai']`. Если при поиске самой группы `['openai']` происходит исключение, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`.

### `_load_gemini_credentials`

**Назначение**: Загружает учетные данные для Google AI (Gemini) из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['gemini']`. Для каждой найденной записи создается новая вложенная структура `SimpleNamespace` в `self.credentials.gemini` с именем, соответствующим названию записи (`entry.title`).
Из пользовательских свойств каждой записи извлекается значение для 'api_key' и сохраняется в соответствующую вложенную структуру.
При возникновении исключения в процессе обработки любой записи, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. Если обработка всех записей прошла без исключений, возвращается `True`.

### `_load_telegram_credentials`

**Назначение**: Загружает учетные данные для Telegram из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['telegram']`. Для каждой найденной записи устанавливает атрибут в `self.credentials.telegram`, где имя атрибута соответствует названию записи (`entry.title`), а значение атрибута - значение пользовательского свойства 'token' из записи.
При возникновении исключения в процессе обработки, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. Если обработка всех записей прошла без исключений, возвращается `True`.

### `_load_discord_credentials`

**Назначение**: Загружает учетные данные для Discord из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод пытается найти запись в группе KeePass по пути `['discord']`. Предполагается, что по этому пути находится только одна запись (`.entries[0]`).
Из пользовательских свойств найденной записи извлекаются значения для 'application_id', 'public_key' и 'bot_token'.
Извлеченные значения сохраняются в соответствующие атрибуты вложенной структуры `self.credentials.discord`.
В случае успешного извлечения всех данных метод возвращает `True`. При возникновении любого исключения, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`.

### `_load_prestashop_credentials`

**Назначение**: Загружает учетные данные для Prestashop (клиентов) из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['prestashop', 'clients']`. Для каждой найденной записи (предполагается, что каждая запись соответствует отдельному клиенту Prestashop), создается новая вложенная структура `SimpleNamespace` в `self.credentials.presta.client`, где имя атрибута соответствует названию записи (`entry.title`).
Из пользовательских свойств каждой записи извлекаются значения для 'api_key', 'api_domain', 'db_server', 'db_user' и 'db_password'.
Извлеченные значения сохраняются в соответствующие атрибуты новой вложенной структуры для текущего клиента.
При возникновении исключения в процессе обработки любой записи, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. Если обработка всех записей прошла без исключений, возвращается `True`.

### `_load_serpapi_credentials`

**Назначение**: Загружает учетные данные для Serpapi.com из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['serpapi.com']`. Для каждой найденной записи создается новая вложенная структура `SimpleNamespace` в `self.credentials.serpapi`, где имя атрибута соответствует названию записи (`entry.title`).
Из пользовательских свойств каждой записи извлекается значение для 'api_key' и сохраняется в соответствующую вложенную структуру.
При возникновении исключения в процессе обработки любой записи, логируется ошибка с использованием `logger.error`.
Если при поиске самой группы `['serpapi.com']` происходит исключение, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. В противном случае (даже если были ошибки при обработке отдельных записей внутри группы), возвращается `True`.

### `_load_smtp_credentials`

**Назначение**: Загружает учетные данные для SMTP серверов из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['smtp']`. Для каждой найденной записи создается новый объект `SimpleNamespace` с атрибутами 'server', 'port', 'user', 'password', значения которых извлекаются из пользовательских свойств записи.
Этот объект `SimpleNamespace` добавляется в список `self.credentials.smtp`.
При возникновении исключения в процессе обработки, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. Если обработка всех записей прошла без исключений, возвращается `True`.

### `_load_facebook_credentials`

**Назначение**: Загружает учетные данные для Facebook из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод ищет все записи в группе KeePass по пути `['facebook']`. Для каждой найденной записи создается новый объект `SimpleNamespace` с атрибутами 'app_id', 'app_secret', 'access_token', значения которых извлекаются из пользовательских свойств записи.
Этот объект `SimpleNamespace` добавляется в список `self.credentials.facebook`.
При возникновении исключения в процессе обработки, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`. Если обработка всех записей прошла без исключений, возвращается `True`.

### `_load_gapi_credentials`

**Назначение**: Загружает учетные данные для Google API (GAPI) из базы данных KeePass.

**Параметры**:
- `kp` (PyKeePass): Экземпляр открытой базы данных KeePass.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- Может вызвать исключения при поиске записей в KeePass или доступе к их свойствам. Эти исключения перехватываются внутри метода.

**Как работает**:
Метод пытается найти запись в группе KeePass по пути `['google', 'gapi']`. Предполагается, что по этому пути находится только одна запись (`.entries[0]`).
Из пользовательских свойств найденной записи извлекается значение для 'api_key'.
Извлеченное значение сохраняется в словарь `self.credentials.gapi` под ключом `'api_key'`.
В случае успешного извлечения данных метод возвращает `True`. При возникновении любого исключения, логируется ошибка с использованием `print` (переопределен на `pprint`), и метод возвращает `False`.

**Свойства**:

### `now`

**Назначение**: Возвращает текущую метку времени в строковом формате, определенном в конфигурации проекта.

**Возвращает**:
- `str`: Строка, представляющая текущую дату и время в формате `год_месяц_день_часы_минуты_секунды_миллисекунды`.

**Как работает**:
Свойство `now` при доступе к нему получает текущее время с использованием `datetime.now()`. Затем оно форматирует это время в строку, используя формат метки времени, хранящийся в `self.config.timestamp_format` (который по умолчанию равен `'%y_%m_%d_%H_%M_%S_%f'`). Поскольку формат `%f` возвращает микросекунды (6 цифр), метод возвращает только первые 3 цифры миллисекунд, обрезая строку метки времени.

**Примеры**:

```python
# Пример доступа к свойству now через глобальный экземпляр gs
# current_timestamp = gs.now
# print(f"Текущая метка времени: {current_timestamp}")
# Пример вывода: Текущая метка времени: 24_07_26_10_00_00_123
```

## Глобальный экземпляр

### `gs`

Глобальный экземпляр класса `ProgramSettings`. Создается при загрузке модуля `credentials.py`. Благодаря декоратору `@singleton`, все последующие обращения к `ProgramSettings()` или к `gs` будут возвращать один и тот же объект. Этот экземпляр `gs` является точкой доступа ко всем настройкам, путям и учетным данным проекта.

```python
# Пример доступа к настройкам через глобальный экземпляр
# project_base_directory = gs.base_dir
# aliexpress_api_key = gs.credentials.aliexpress.api_key
# current_log_path = gs.path.log
```
```