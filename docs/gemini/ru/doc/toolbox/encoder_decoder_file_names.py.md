# Модуль кодирования и декодирования имен файлов

## Обзор

Этот модуль предоставляет класс `PathEncoderDecoder` для кодирования и декодирования путей к файлам с использованием хэширования и хранения соответствий в SQLite базе данных. Это позволяет создавать короткие идентификаторы для длинных путей, что может быть полезно для хранения и передачи информации о файлах.

## Подробней

Модуль предназначен для решения задачи сокращения длины путей к файлам, сохраняя при этом возможность восстановления исходного пути по короткому идентификатору. Он использует хэширование для создания уникальных идентификаторов и SQLite базу данных для хранения соответствий между идентификаторами и путями. Это позволяет эффективно управлять соответствиями и обеспечивает возможность их сохранения между сессиями работы программы.

## Классы

### `PathEncoderDecoder`

**Описание**: Класс для кодирования и декодирования путей с использованием хэширования и хранения данных в SQLite базе данных.

**Атрибуты**:

-   `db_path` (Path): Путь к SQLite базе данных для хранения таблицы соответствий.

**Методы**:

-   `__init__(self, db_path: str = 'path_mapping.db')`: Инициализация класса.
-   `_initialize_database(self)`: Инициализация базы данных, создание таблицы, если она отсутствует.
-   `_save_to_database(self, short_id: str, file_path: str)`: Сохраняет хэш и путь в базу данных.
-   `_fetch_from_database(self, short_id: str) -> Optional[str]`: Извлекает путь из базы данных по короткому идентификатору.
-   `encode(self, file_path: str) -> str`: Кодирует путь в короткий идентификатор.
-   `decode(self, short_id: str) -> Optional[str]`: Декодирует короткий идентификатор обратно в путь.
-   `clear_mapping(self)`: Очищает таблицу соответствий.

#### `__init__`

**Назначение**: Инициализация класса `PathEncoderDecoder`.

```python
def __init__(self, db_path: str = 'path_mapping.db'):
    """
    Инициализация класса.

    Args:
        db_path (str): Путь к SQLite базе данных для хранения таблицы соответствий.
    """
    ...
```

**Параметры**:

-   `db_path` (str): Путь к SQLite базе данных. По умолчанию `'path_mapping.db'`.

**Как работает функция**:

1.  Принимает путь к базе данных в качестве аргумента.
2.  Сохраняет путь к базе данных в атрибуте `db_path`.
3.  Вызывает метод `_initialize_database` для создания таблицы в базе данных, если она еще не существует.

#### `_initialize_database`

**Назначение**: Инициализация базы данных, создание таблицы `path_mapping`, если она отсутствует.

```python
def _initialize_database(self):
    """
    Инициализация базы данных, создание таблицы, если она отсутствует.
    """
    ...
```

**Параметры**:

-   Нет.

**Как работает функция**:

1.  Устанавливает соединение с SQLite базой данных, используя путь, хранящийся в атрибуте `db_path`.
2.  Создает таблицу `path_mapping` с двумя столбцами: `id` (TEXT PRIMARY KEY) и `file_path` (TEXT NOT NULL), если она еще не существует.
3.  Сохраняет изменения в базе данных.

#### `_save_to_database`

**Назначение**: Сохраняет короткий идентификатор и соответствующий путь к файлу в базе данных.

```python
def _save_to_database(self, short_id: str, file_path: str):
    """
    Сохраняет хэш и путь в базу данных.

    Args:
        short_id (str): Уникальный идентификатор пути.
        file_path (str): Полный путь к файлу.
    """
    ...
```

**Параметры**:

-   `short_id` (str): Короткий идентификатор пути.
-   `file_path` (str): Полный путь к файлу.

**Как работает функция**:

1.  Устанавливает соединение с SQLite базой данных.
2.  Выполняет SQL-запрос `INSERT OR IGNORE` для добавления записи в таблицу `path_mapping` с указанным `short_id` и `file_path`. `INSERT OR IGNORE` позволяет избежать добавления дубликатов, если запись с таким `short_id` уже существует.
3.  Сохраняет изменения в базе данных.

#### `_fetch_from_database`

**Назначение**: Извлекает путь к файлу из базы данных по заданному короткому идентификатору.

```python
def _fetch_from_database(self, short_id: str) -> Optional[str]:
    """
    Извлекает путь из базы данных по короткому идентификатору.

    Args:
        short_id (str): Уникальный идентификатор пути.

    Returns:
        Optional[str]: Полный путь файла или `None`, если идентификатор не найден.
    """
    ...
```

**Параметры**:

-   `short_id` (str): Короткий идентификатор пути.

**Возвращает**:

-   `Optional[str]`: Полный путь к файлу, если идентификатор найден в базе данных, или `None` в противном случае.

**Как работает функция**:

1.  Устанавливает соединение с SQLite базой данных.
2.  Выполняет SQL-запрос `SELECT file_path FROM path_mapping WHERE id = ?` для поиска записи с указанным `short_id`.
3.  Извлекает результат запроса, если он есть.
4.  Возвращает путь к файлу, если запись найдена, или `None`, если запись не найдена.

#### `encode`

**Назначение**: Кодирует путь к файлу в короткий идентификатор.

```python
def encode(self, file_path: str) -> str:
    """
    Кодирует путь в короткий идентификатор.

    Args:
        file_path (str): Полный путь файла.

    Returns:
        str: Короткий идентификатор.
    """
    ...
```

**Параметры**:

-   `file_path` (str): Полный путь к файлу.

**Возвращает**:

-   `str`: Короткий идентификатор.

**Как работает функция**:

1.  Вычисляет MD5 хэш от пути к файлу, используя кодировку UTF-8.
2.  Берет первые 8 символов хэша.
3.  Формирует короткий идентификатор, добавляя префикс `"id-"` к хэшу.
4.  Сохраняет короткий идентификатор и путь к файлу в базе данных, используя метод `_save_to_database`.
5.  Возвращает короткий идентификатор.

#### `decode`

**Назначение**: Декодирует короткий идентификатор обратно в путь к файлу.

```python
def decode(self, short_id: str) -> Optional[str]:
    """
    Декодирует короткий идентификатор обратно в путь.

    Args:
        short_id (str): Короткий идентификатор.

    Returns:
        Optional[str]: Полный путь файла или `None`, если идентификатор не найден.
    """
    ...
```

**Параметры**:

-   `short_id` (str): Короткий идентификатор пути.

**Возвращает**:

-   `Optional[str]`: Полный путь к файлу, если идентификатор найден в базе данных, или `None` в противном случае.

**Как работает функция**:

1.  Вызывает метод `_fetch_from_database` для поиска пути к файлу в базе данных по заданному короткому идентификатору.
2.  Возвращает результат, полученный от `_fetch_from_database`.

#### `clear_mapping`

**Назначение**: Очищает таблицу соответствий в базе данных.

```python
def clear_mapping(self):
    """
    Очищает таблицу соответствий.
    """
    ...
```

**Параметры**:

-   Нет.

**Как работает функция**:

1.  Устанавливает соединение с SQLite базой данных.
2.  Выполняет SQL-запрос `DELETE FROM path_mapping` для удаления всех записей из таблицы `path_mapping`.
3.  Сохраняет изменения в базе данных.

## Пример использования

В блоке `if __name__ == '__main__':` приведен пример использования класса `PathEncoderDecoder`.

```python
if __name__ == '__main__':
    encoder_decoder = PathEncoderDecoder()

    # Кодирование пути
    original_path = 'src/same_folder/same_sub_folder/same-file.ext'
    encoded = encoder_decoder.encode(original_path)
    print(f'Кодированный путь: {encoded}')

    # Декодирование пути
    decoded = encoder_decoder.decode(encoded)
    print(f'Декодированный путь: {decoded}')

    # Очистка таблицы соответствий
    # encoder_decoder.clear_mapping()
```

В этом примере создается экземпляр класса `PathEncoderDecoder`, кодируется путь к файлу, выводится кодированный путь, декодируется кодированный путь и выводится декодированный путь. Также присутствует закомментированная строка для очистки таблицы соответствий.