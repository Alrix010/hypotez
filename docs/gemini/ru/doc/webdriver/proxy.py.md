# Модуль для работы с прокси (proxy.py)

## Обзор

Этот модуль предоставляет функции для работы с прокси-серверами, включая загрузку списка прокси и их парсинг.

## Подробней

Модуль `src/webdriver/proxy.py` предназначен для упрощения работы с прокси-серверами в проекте `hypotez`. Он предоставляет функции для загрузки списка прокси-адресов из удаленного источника и парсинга этого списка для дальнейшего использования. Модуль использует библиотеки `requests` и `re` для загрузки и обработки данных, а также модуль логирования `src.logger.logger`.

## Функции

### `download_proxies_list`

**Назначение**: Загружает файл по указанному URL и сохраняет его в заданный путь.

```python
def download_proxies_list(url: str = url, save_path: Path = proxies_list_path) -> bool:
    """
    Загружает файл по указанному URL и сохраняет его в заданный путь.

    :param url: URL файла для загрузки.
    :param save_path: Путь для сохранения загруженного файла.
    :return: Успешность выполнения операции.
    """
    ...
```

**Параметры**:

-   `url` (str): URL файла для загрузки. По умолчанию используется значение глобальной переменной `url`.
-   `save_path` (Path): Путь для сохранения загруженного файла. По умолчанию используется значение глобальной переменной `proxies_list_path`.

**Возвращает**:

-   `bool`: `True`, если файл успешно загружен и сохранен, `False` - в противном случае.

**Как работает функция**:

1.  Отправляет GET-запрос на загрузку файла, используя `requests.get(url, stream=True)`. Параметр `stream=True` позволяет загружать файл по частям.
2.  Проверяет код ответа HTTP-запроса (`response.status_code`). Метод `response.raise_for_status()` генерирует исключение для кодов ошибок HTTP.
3.  Открывает файл для записи в бинарном режиме (`'wb'`).
4.  Читает содержимое файла по частям (размером 8192 байта) из ответа сервера (`response.iter_content(chunk_size=8192)`) и записывает каждую часть в файл.
5.  Логирует информацию об успешной загрузке и сохранении файла или возникшей ошибке, используя `logger.info` и `logger.error` соответственно.

### `get_proxies_dict`

**Назначение**: Парсит файл с прокси-адресами и распределяет их по категориям (http, socks4, socks5).

```python
def get_proxies_dict(file_path: Path = proxies_list_path) -> Dict[str, List[Dict[str, Any]]]:
    """
    Парсит файл с прокси-адресами и распределяет их по категориям.

    :param file_path: Путь к файлу с прокси.
    :return: Словарь с распределёнными по типам прокси.
    """
    ...
```

**Параметры**:

-   `file_path` (Path): Путь к файлу с прокси-адресами. По умолчанию используется значение глобальной переменной `proxies_list_path`.

**Возвращает**:

-   `Dict[str, List[Dict[str, Any]]]`: Словарь, где ключи - это протоколы (`'http'`, `'socks4'`, `'socks5'`), а значения - списки словарей, представляющих прокси с соответствующим протоколом.

**Как работает функция**:

1.  Вызывает функцию `download_proxies_list` для загрузки списка прокси-адресов.
2.  Инициализирует пустой словарь `proxies` с ключами `'http'`, `'socks4'` и `'socks5'`.
3.  Открывает файл для чтения.
4.  Читает файл построчно и для каждой строки пытается извлечь протокол, хост и порт, используя регулярное выражение `r'^(http|socks4|socks5)://([\d\.]+):(\d+)'`.
5.  Если строка соответствует шаблону, добавляет информацию о прокси в соответствующий список в словаре `proxies`.
6.  Логирует информацию об ошибках, используя `logger.error`.

### `check_proxy`

**Назначение**: Проверяет работоспособность прокси-сервера.

```python
def check_proxy(proxy: dict) -> bool:
    """
    Проверяет работоспособность прокси-сервера.
    
    :param proxy: Словарь с данными прокси (host, port, protocol).
    :return: True, если прокси работает, иначе False.
    """
    ...
```

**Параметры**:

-   `proxy` (dict): Словарь с данными прокси (host, port, protocol).

**Возвращает**:

-   `bool`: `True`, если прокси работает, `False` - в противном случае.

**Как работает функция**:

1.  Пытается отправить GET-запрос к адресу `https://httpbin.org/ip` через указанный прокси-сервер, используя библиотеку `requests`. Устанавливает таймаут ожидания ответа в 5 секунд.
2.  Если запрос успешен (код ответа 200), логирует информацию об успешном подключении к прокси и возвращает `True`.
3.  В случае ошибки (например, `ProxyError` или `RequestException`) логирует информацию об ошибке и возвращает `False`.

## Переменные модуля

-   `url` (str): URL источника списка прокси-адресов.
-   `proxies_list_path` (Path): Путь к файлу для сохранения списка прокси.
- `_connection`: Словарь, содержащий параметры подключения к SMTP и IMAP серверам. Важно! Не храните учетные данные непосредственно в коде. Используйте переменные окружения.

## Пример использования

**Загрузка и парсинг списка прокси:**

```python
from src.webdriver import proxy

if proxy.download_proxies_list():
    parsed_proxies = proxy.parse_proxies()
    print(f"Обработано {sum(len(v) for v in parsed_proxies.values())} прокси.")
```

## Взаимосвязь с другими частями проекта

-   Модуль использует библиотеку `requests` для выполнения HTTP-запросов.
-   Для работы с файловой системой используется модуль `pathlib`.
-   Для логирования используется модуль `src.logger.logger`.
-   Этот модуль может использоваться другими частями проекта `hypotez` для получения списка прокси-серверов и проверки их работоспособности.