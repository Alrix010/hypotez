### Анализ кода `hypotez/src/utils/get_free_port.py.md`

## Обзор

Модуль предоставляет функцию для поиска свободного порта на указанном хосте.

## Подробнее

Этот модуль содержит функцию `get_free_port`, которая позволяет найти доступный порт на указанном хосте, опционально в заданном диапазоне портов. Это полезно для динамического выделения портов для различных сервисов и приложений, чтобы избежать конфликтов портов.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Finds and returns a free port within the specified range, or the first available port if no range is given.

    Args:
        host (str): The host address to check for available ports.
        port_range (Optional[str | List[str]], optional): A port range specified as a string "min-max" or a list of strings.
               E.g.: "3000-3999", ["3000-3999", "8000-8010"], None. Defaults to `None`.

    Returns:
        int: An available port number.

    Raises:
        ValueError: If no free port can be found within the specified range, or if the port range is invalid.
    """
    ...
```

**Назначение**:
Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

**Параметры**:

*   `host` (str): Адрес хоста для проверки доступных портов.
*   `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк. Например: "3000-3999", `["3000-3999", "8000-8010"]`, `None`. По умолчанию `None`.

**Возвращает**:

*   `int`: Доступный номер порта.

**Вызывает исключения**:

*   `ValueError`: Если не удается найти свободный порт в указанном диапазоне, или если формат диапазона портов недействителен.

**Как работает функция**:

1.  Определяет внутреннюю функцию `_is_port_in_use`, которая проверяет, используется ли данный порт на указанном хосте.
2.  Определяет внутреннюю функцию `_parse_port_range`, которая преобразует строку диапазона портов в кортеж из минимального и максимального номеров портов.
3.  Если `port_range` не задан:

    *   Начинает поиск свободного порта с номера 1024.
    *   Проверяет каждый порт, начиная с 1024, пока не найдет свободный.
    *   Если не удается найти свободный порт в диапазоне 1024-65535, выбрасывает исключение `ValueError`.
4.  Если `port_range` задан как строка:

    *   Парсит строку, преобразуя ее в минимальный и максимальный номера портов.
    *   Перебирает порты в указанном диапазоне и возвращает первый свободный порт.
    *   Если ни один порт в диапазоне не свободен, выбрасывает исключение `ValueError`.
5.  Если `port_range` задан как список строк:

    *   Перебирает элементы списка, каждый из которых должен быть строкой, представляющей диапазон портов.
    *   Парсит каждую строку, преобразуя ее в минимальный и максимальный номера портов.
    *   Перебирает порты в каждом указанном диапазоне и возвращает первый свободный порт.
    *   Если ни один порт во всех диапазонах не свободен, выбрасывает исключение `ValueError`.
6. Логирует ошибки и предупреждения, используя модуль `src.logger.logger`.

### `_is_port_in_use`

```python
def _is_port_in_use(host: str, port: int) -> bool:
    """
    Checks if a given port is in use on the specified host.

    Args:
        host (str): The host address.
        port (int): The port number to check.

    Returns:
        bool: True if the port is in use, False otherwise.
    """
    ...
```

**Назначение**:
Проверяет, используется ли указанный порт на заданном хосте.

**Параметры**:

*   `host` (str): Адрес хоста.
*   `port` (int): Номер порта для проверки.

**Возвращает**:

*   `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:

1.  Создает сокет (socket) с указанным семейством адресов (AF\_INET) и типом сокета (SOCK\_STREAM).
2.  Пытается привязать сокет к указанному хосту и порту.
3.  Если привязка прошла успешно, значит порт свободен, и функция возвращает `False`.
4.  Если при привязке возникло исключение `OSError`, значит порт используется, и функция возвращает `True`.

### `_parse_port_range`

```python
def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
    """
    Parses port range string "min-max" into a tuple (min_port, max_port).

    Args:
        port_range_str (str): The port range string.

    Returns:
        Tuple[int, int]: A tuple containing minimum and maximum port numbers.

    Raises:
        ValueError: If the port range string format is invalid.
    """
    ...
```

**Назначение**:
Преобразует строку диапазона портов "min-max" в кортеж (min\_port, max\_port).

**Параметры**:

*   `port_range_str` (str): Строка диапазона портов.

**Возвращает**:

*   `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:

*   `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:

1.  Разделяет входную строку по символу `-`.
2.  Проверяет, что получено ровно два элемента. Если нет, выбрасывает исключение `ValueError`.
3.  Преобразует оба элемента в целые числа.
4.  Проверяет, что минимальный номер порта меньше максимального. Если нет, выбрасывает исключение `ValueError`.
5.  Возвращает кортеж, содержащий минимальный и максимальный номера портов.
6.  Логирует ошибки с использованием модуля `src.logger.logger`.

## Примеры использования

```python
from src.utils.get_free_port import get_free_port

# Найти свободный порт на localhost в диапазоне 3000-3005
port = get_free_port('localhost', '3000-3005')
print(f"Свободный порт: {port}")

# Найти первый доступный порт на localhost
port = get_free_port('localhost')
print(f"Первый доступный порт: {port}")
```

## Зависимости

*   `socket`: Для работы с сокетами и проверки доступности портов.
*   `typing.Optional, typing.Tuple, typing.List`: Для аннотаций типов.
*   `header`: Не используется в представленном коде, но указан в импортах.
*   `src.logger.logger`: Для логирования событий и ошибок.

## Взаимосвязи с другими частями проекта

Модуль `get_free_port.py` предоставляет полезную утилиту для динамического выделения портов и может использоваться в различных частях проекта `hypotez`, где требуется запуск сетевых сервисов или приложений, которые должны прослушивать определенные порты.