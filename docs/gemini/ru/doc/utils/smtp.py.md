# Модуль для работы с SMTP (smtp.py)

## Обзор

Этот модуль предоставляет функциональность для отправки и получения электронных писем с использованием SMTP или IMAP серверов.

## Подробней

Модуль `src.utils.smtp` предназначен для упрощения работы с электронной почтой в проекте `hypotez`. Он содержит функции для отправки электронных писем с использованием протокола SMTP и получения электронных писем с использованием протокола IMAP. Важно отметить, что модуль требует настройки параметров подключения к SMTP и IMAP серверам через переменные окружения для обеспечения безопасности.

## Функции

### `send`

**Назначение**: Отправляет электронное письмо, используя SMTP сервер.

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Sends an email.  Returns True if successful, False otherwise. Logs errors."""
    ...
```

**Параметры**:

-   `subject` (str): Тема письма. По умолчанию ''.
-   `body` (str): Тело письма. По умолчанию ''.
-   `to` (str): Адрес получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:

-   `bool`: `True`, если письмо успешно отправлено, `False` - в противном случае.

**Как работает функция**:

1.  Создает SMTP-соединение с использованием параметров из словаря `_connection`.
2.  Выполняет рукопожатие с сервером (`smtp.ehlo()`) и включает шифрование TLS (`smtp.starttls()`).
3.  Выполняет аутентификацию на сервере, используя имя пользователя и пароль из словаря `_connection`.
4.  Создает объект `MIMEText` с телом письма.
5.  Устанавливает заголовок "Subject" (тема письма).
6.  Устанавливает заголовок "From" (отправитель письма).
7.  Устанавливает заголовок "To" (получатель письма).
8.  Отправляет письмо, используя `smtp.sendmail`.
9.  Закрывает соединение с сервером, используя `smtp.quit()`.
10. Логирует информацию об ошибках, используя `logger.error`.

### `receive`

**Назначение**: Получает электронные письма с IMAP сервера.

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Retrieves emails. Returns a list of email dictionaries if successful, None otherwise. Logs errors."""
    ...
```

**Параметры**:

-   `imap_server` (str): Адрес IMAP сервера.
-   `user` (str): Имя пользователя для входа на IMAP сервер.
-   `password` (str): Пароль для входа на IMAP сервер.
-   `folder` (str): Папка для чтения писем. По умолчанию 'inbox'.

**Возвращает**:

-   `Optional[List[Dict[str, str]]]`: Список словарей, представляющих электронные письма (тема, отправитель, тело), или `None` в случае ошибки.

**Как работает функция**:

1.  Создает IMAP4\_SSL-соединение с указанным сервером.
2.  Выполняет аутентификацию на сервере, используя имя пользователя и пароль.
3.  Выбирает указанную папку (`folder`).
4.  Выполняет поиск всех писем в выбранной папке.
5.  Перебирает идентификаторы найденных писем.
6.  Для каждого письма извлекает сырое содержимое, используя `mail.fetch`.
7.  Преобразует сырое содержимое в объект `email.message_from_bytes`.
8.  Извлекает тему, отправителя и тело письма из объекта сообщения.
9.  Добавляет информацию о письме в список `emails`.
10. Закрывает соединение с сервером.
11. Возвращает список словарей, представляющих электронные письма.
12. Логирует информацию об ошибках, используя `logger.error`.

## Переменные модуля

-   `_connection` (dict): Словарь, содержащий параметры подключения к SMTP и IMAP серверам. Важно! Не храните учетные данные непосредственно в коде. Используйте переменные окружения.
    -   `'server'` (str): Адрес SMTP сервера.
    -   `'port'` (int): Порт SMTP сервера.
    -   `'user'` (str): Имя пользователя для SMTP/IMAP сервера.
    -   `'password'` (str): Пароль для SMTP/IMAP сервера.
    -   `'receiver'` (str): Адрес получателя по умолчанию.

## Пример использования

**Отправка электронного письма:**

```python
from src.utils import smtp

subject = "Test Email"
body = "This is a test email sent from Hypotez project."
to = "recipient@example.com"

success = smtp.send(subject=subject, body=body, to=to)
if success:
    print("Email sent successfully!")
else:
    print("Failed to send email.")
```

**Получение электронных писем:**

```python
from src.utils import smtp

imap_server = "imap.example.com"
user = "your_username"
password = "your_password"
folder = "INBOX"

emails = smtp.receive(imap_server, user, password, folder)
if emails:
    for email in emails:
        print(f"Subject: {email['subject']}")
        print(f"From: {email['from']}")
        print(f"Body: {email['body']}")
else:
    print("Failed to retrieve emails.")
```

## Важные аспекты безопасности и надежности

-   **Словарь `_connection`**: **Не храните учетные данные непосредственно в коде!** Перенесите словарь `_connection` в переменные окружения (например, с использованием `os.environ`). Это критически важно для безопасности. Избегайте хранения паролей непосредственно в исходном коде.
-   **Обработка ошибок**: Код включает надежную обработку ошибок, логируя исключения с подробной информацией (тема, тело и т. д.). Это очень полезно для отладки.
-   **Разбор электронных писем**: Функция `receive` корректно обрабатывает различные форматы электронных писем, предотвращая возможные проблемы.
-   **Обработка MIME**: Код правильно использует `MIMEText` для создания сообщения электронной почты, что важно для отправки основных текстовых писем.

## Взаимосвязь с другими частями проекта

-   Модуль `src.utils.smtp` использует `src.logger.logger` для логирования информации об ошибках и других событиях.
-   Этот модуль может использоваться другими частями проекта `hypotez`, где требуется отправка или получение электронных писем.