### **Системные инструкции для обработки кода проекта `hypotez`**

=========================================================================================

Описание функциональности и правил для генерации, анализа и улучшения кода. Направлено на обеспечение последовательного и читаемого стиля кодирования, соответствующего требованиям.

---

### **Основные принципы**

#### **1. Общие указания**:
- Соблюдай четкий и понятный стиль кодирования.
- Все изменения должны быть обоснованы и соответствовать установленным требованиям.

#### **2. Комментарии**:
- Используй `#` для внутренних комментариев.
- Документация всех функций, методов и классов должна следовать такому формату: 
    ```python
        def function(param: str, param1: Optional[str | dict | str] = None) -> dict | None:
            """ 
            Args:
                param (str): Описание параметра `param`.
                param1 (Optional[str | dict | str], optional): Описание параметра `param1`. По умолчанию `None`.
    
            Returns:
                dict | None: Описание возвращаемого значения. Возвращает словарь или `None`.
    
            Raises:
                SomeError: Описание ситуации, в которой возникает исключение `SomeError`.

            Ехаmple:
                >>> function('param', 'param1')
                {'param': 'param1'}
            """
    ```
- Комментарии и документация должны быть четкими, лаконичными и точными.

#### **3. Форматирование кода**:
- Используй одинарные кавычки. `a:str = 'value'`, `print('Hello World!')`;
- Добавляй пробелы вокруг операторов. Например, `x = 5`;
- Все параметры должны быть аннотированы типами. `def function(param: str, param1: Optional[str | dict | str] = None) -> dict | None:`;
- Не используй `Union`. Вместо этого используй `|`.

#### **4. Логирование**:
- Для логгирования Всегда Используй модуль `logger` из `src.logger.logger`.
- Ошибки должны логироваться с использованием `logger.error`.
Пример:
    ```python
        try:
            ...
        except Exception as ex:
            logger.error('Error while processing data', ех, exc_info=True)
    ```
#### **5 Не используй `Union[]` в коде. Вместо него используй `|`
Например:
```python
x: str | int ...
```




---

### **Основные требования**:

#### **1. Формат ответов в Markdown**:
- Все ответы должны быть выполнены в формате **Markdown**.

#### **2. Формат комментариев**:
- Используй указанный стиль для комментариев и документации в коде.
- Пример:

```python
from typing import Generator, Optional, List
from pathlib import Path


def read_text_file(
    file_path: str | Path,
    as_list: bool = False,
    extensions: Optional[List[str]] = None,
    chunk_size: int = 8192,
) -> Generator[str, None, None] | str | None:
    """
    Считывает содержимое файла (или файлов из каталога) с использованием генератора для экономии памяти.

    Args:
        file_path (str | Path): Путь к файлу или каталогу.
        as_list (bool): Если `True`, возвращает генератор строк.
        extensions (Optional[List[str]]): Список расширений файлов для чтения из каталога.
        chunk_size (int): Размер чанков для чтения файла в байтах.

    Returns:
        Generator[str, None, None] | str | None: Генератор строк, объединенная строка или `None` в случае ошибки.

    Raises:
        Exception: Если возникает ошибка при чтении файла.

    Example:
        >>> from pathlib import Path
        >>> file_path = Path('example.txt')
        >>> content = read_text_file(file_path)
        >>> if content:
        ...    print(f'File content: {content[:100]}...')
        File content: Example text...
    """
    ...
```
- Всегда делай подробные объяснения в комментариях. Избегай расплывчатых терминов, 
- таких как *«получить»* или *«делать»*. Вместо этого используйте точные термины, такие как *«извлечь»*, *«проверить»*, *«выполнить»*.
- Вместо: *«получаем»*, *«возвращаем»*, *«преобразовываем»* используй имя объекта *«функция получае»*, *«переменная возвращает»*, *«код преобразовывает»* 
- Комментарии должны непосредственно предшествовать описываемому блоку кода и объяснять его назначение.

#### **3. Пробелы вокруг операторов присваивания**:
- Всегда добавляйте пробелы вокруг оператора `=`, чтобы повысить читаемость.
- Примеры:
  - **Неправильно**: `x=5`
  - **Правильно**: `x = 5`

#### **4. Использование `j_loads` или `j_loads_ns`**:
- Для чтения JSON или конфигурационных файлов замените стандартное использование `open` и `json.load` на `j_loads` или `j_loads_ns`.
- Пример:

```python
# Неправильно:
with open('config.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# Правильно:
data = j_loads('config.json')
```

#### **5. Сохранение комментариев**:
- Все существующие комментарии, начинающиеся с `#`, должны быть сохранены без изменений в разделе «Улучшенный код».
- Если комментарий кажется устаревшим или неясным, не изменяйте его. Вместо этого отметьте его в разделе «Изменения».

#### **6. Обработка `...` в коде**:
- Оставляйте `...` как указатели в коде без изменений.
- Не документируйте строки с `...`.
```

#### **7. Аннотации**
Для всех переменных должны быть определены аннотации типа. 
Для всех функций все входные и выходные параметры аннотириваны
Для все параметров должны быть аннотации типа.


### **8. webdriver**
В коде используется webdriver. Он импртируется из модуля `webdriver` проекта `hypotez`
```python
from src.webdirver import Driver, Chrome, Firefox, Playwright, ...
driver = Driver(Firefox)

Пoсле чего может использоваться как

close_banner = {
  "attribute": null,
  "by": "XPATH",
  "selector": "//button[@id = 'closeXButton']",
  "if_list": "first",
  "use_mouse": false,
  "mandatory": false,
  "timeout": 0,
  "timeout_for_event": "presence_of_element_located",
  "event": "click()",
  "locator_description": "Закрываю pop-up окно, если оно не появилось - не страшно (`mandatory`:`false`)"
}

result = driver.execute_locator(close_banner)
```

### **Анализ кода `hypotez/src/endpoints/bots/google_drive/upload.py`**

#### **1. Блок-схема**

```mermaid
graph LR
    A[Начало upload(filename, update, context, parent_folder)] --> B{Инициализация GoogleAuth}
    B --> C{Загрузка учетных данных из файла}
    C --> D{Учетные данные отсутствуют?}
    D -- Да --> E[Вывод "not Auth Users"]
    D -- Нет --> F{Срок действия токена истек?}
    F -- Да --> G[Обновление токена]
    G --> H[Сохранение учетных данных]
    F -- Нет --> H[Авторизация]
    H --> I{Создание экземпляра GoogleDrive}
    I --> J{Получение HTTP объекта}
    J --> K{Проверка существования файла}
    K -- Нет --> L[Вывод сообщения об ошибке]
    K -- Да --> M{Проверка Creds.TEAMDRIVE_FOLDER_ID}
    M -- Нет --> N{Проверка parent_folder}
    N -- Да --> O{Получение списка файлов и папок в корне}
    O --> P{Поиск папки с именем parent_folder}
    P -- Найдена --> Q[Получение ID папки]
    P -- Не найдена --> R{Создание папки}
    R --> S[Загрузка папки]
    S --> T[Получение ID папки]
    N -- Нет --> U[Инициализация параметров файла]
    M -- Да --> V[Инициализация параметров файла для TeamDrive]
    Q --> U
    T --> U
    V --> W{Создание файла для загрузки}
    W --> X{Установка содержимого файла}
    X --> Y{Попытка загрузки файла}
    Y -- Успех --> Z{Проверка Creds.TEAMDRIVE_FOLDER_ID}
    Y -- Ошибка --> AA[Вывод сообщения об ошибке загрузки]
    Z -- Нет --> BB{Получение метаданных файла}
    BB --> CC{Вставка разрешения на чтение для всех}
    Z -- Да --> DD[Возврат webContentLink]
    CC --> DD
    AA --> DD
    DD --> EE[Конец]
```

#### **2. Диаграмма**

```mermaid
graph LR
    A[upload] --> B(GoogleAuth)
    B --> C(LoadCredentialsFile)
    C --> D{credentials is None?}
    D -- Yes --> E(print "not Auth Users")
    D -- No --> F{access_token_expired?}
    F -- Yes --> G(Refresh)
    G --> H(SaveCredentialsFile)
    F -- No --> I(Authorize)
    I --> J(GoogleDrive)
    J --> K(Get_Http_Object)
    K --> L{path.exists(filename)?}
    L -- No --> M(print error message)
    L -- Yes --> N{Creds.TEAMDRIVE_FOLDER_ID?}
    N -- No --> O{parent_folder?}
    O -- Yes --> P(drive.ListFile)
    P --> Q{folder found?}
    Q -- Yes --> R(get folderid)
    Q -- No --> S(drive.CreateFile (folder))
    S --> T(folder.Upload)
    T --> U(folder['id'])
    O -- No --> V(file_params)
    N -- Yes --> W(file_params for TeamDrive)
    R --> V
    U --> V
    W --> X(drive.CreateFile (file_to_upload))
    X --> Y(file_to_upload.SetContentFile)
    Y --> Z{try: file_to_upload.Upload}
    Z -- success --> AA{Creds.TEAMDRIVE_FOLDER_ID?}
    Z -- error --> AB(print upload error)
    AA -- No --> AC(file_to_upload.FetchMetadata)
    AC --> AD(file_to_upload.InsertPermission)
    AA -- Yes --> AE(return file_to_upload['webContentLink'])
    AD --> AE
    AB --> AE
    AE --> AF[End]
```

#### **3. Объяснение**

**Импорты:**

-   `argparse`: Используется для разбора аргументов командной строки. В данном коде не используется, возможно, остался от предыдущих версий.
-   `json`: Используется для работы с JSON-данными, но в коде напрямую не используется.
-   `os`: Предоставляет функции для взаимодействия с операционной системой, например, для работы с путями к файлам.
-   `os.path as path`: Модуль для работы с путями к файлам и директориям.
-   `re`: Используется для работы с регулярными выражениями. В данном коде не используется.
-   `creds.Creds`: Класс, содержащий учетные данные (например, `TEAMDRIVE_FOLDER_ID`, `TEAMDRIVE_ID`).
-   `plugins.TEXT`: Плагин для работы с текстом. В данном коде не используется.
-   `pydrive.auth.GoogleAuth`: Класс для аутентификации в Google Drive API.
-   `pydrive.drive.GoogleDrive`: Класс для работы с Google Drive API.

**Переменные:**

-   `FOLDER_MIME_TYPE`: MIME-тип для папок в Google Drive (`application/vnd.google-apps.folder`).
-   `drive`: Переменная для хранения экземпляра класса `GoogleDrive`.
-   `http`: Переменная для хранения HTTP-объекта для выполнения запросов к Google Drive API.
-   `initial_folder`: Не используется.

**Функция `upload`:**

-   **Аргументы:**
    -   `filename` (str): Имя файла для загрузки.
    -   `update`: Объект, содержащий информацию об обновлении от Telegram (предположительно).
    -   `context`: Контекст выполнения (не используется в коде).
    -   `parent_folder` (str, optional): Имя родительской папки, в которую нужно загрузить файл. По умолчанию `None`.
-   **Возвращаемое значение:**
    -   Возвращает `file_to_upload['webContentLink']` - ссылку на загруженный файл.
-   **Назначение:**
    Функция `upload` загружает файл в Google Drive, используя PyDrive API. Она выполняет следующие шаги:
    1.  Аутентифицируется в Google Drive, используя сохраненные учетные данные пользователя.
    2.  Если учетные данные отсутствуют или устарели, запрашивает авторизацию или обновляет токен.
    3.  Создает экземпляр `GoogleDrive`.
    4.  Проверяет, существует ли указанный файл.
    5.  Если указана родительская папка (`parent_folder`), проверяет, существует ли она в Google Drive. Если папка не существует, создает ее.
    6.  Создает файл в Google Drive и загружает его содержимое.
    7.  Если используется Team Drive, устанавливает соответствующие параметры.
    8.  Устанавливает права доступа к файлу (публичный доступ на чтение, если не используется Team Drive).
    9.  Возвращает ссылку на загруженный файл.
-   **Пример:**

```python
upload(filename='test.txt', update=update_object, context=None, parent_folder='MyFolder')
```

**Потенциальные ошибки и области для улучшения:**

1.  **Обработка исключений:**
    -   Обработка исключений в блоке `try...except` очень общая (`except Exception as e`).  Рекомендуется обрабатывать более конкретные типы исключений, чтобы лучше понимать и обрабатывать возможные ошибки.
2.  **Повторяющийся код:**
    -   Блок инициализации переменных `FOLDER_MIME_TYPE`, `drive`, `http`, `initial_folder` повторяется в начале функции.  Этот код можно вынести из функции или инициализировать эти переменные как константы модуля.
3.  **Неиспользуемые импорты:**
    -   Импортируются модули `argparse`, `json` и `re`, которые не используются в коде.  Эти импорты можно удалить.
4.  **Отсутствие логирования:**
    -   В коде отсутствуют логи.  Рекомендуется добавить логирование для отслеживания хода выполнения программы и выявления ошибок.
5.  **Отсутствие аннотаций типов:**
    -   В коде отсутствуют аннотации типов для переменных и возвращаемых значений функций.  Рекомендуется добавить аннотации типов для улучшения читаемости и поддержки кода.
6.  **Не используется переменная context**
    - Переменная `context` передается в функцию `upload`, но нигде не используется.

**Взаимосвязи с другими частями проекта:**

-   `creds.Creds`: Используется для получения учетных данных и ID Team Drive. Этот класс, вероятно, определен в другом файле проекта и содержит статические переменные с учетными данными.
-   `plugins.TEXT`: Этот модуль импортируется, но не используется. Возможно, он используется в других частях проекта для обработки текста.